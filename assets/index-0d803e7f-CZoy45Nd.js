import{a_ as Ct,a$ as jr,b0 as sv,b1 as av,b2 as jo,b3 as ph,b4 as fh,b5 as Yt,b6 as ov,b7 as fa,b8 as gh,b9 as Hr,ba as lv,G as It,bb as dM,bc as cM,bd as uM,be as mh,bf as u1,bg as ln,bh as hM,bi as pM,bj as ks,bk as j,bl as dv,bm as Is,bn as h1,bo as fM,bp as gM,bq as Gn,br as p1,bs as mM,bt as vM,bu as yM,aY as bM,bv as Wi,aU as SM,bw as wM,bx as vh,by as cv,bz as CM,bA as xM,bB as EM,bC as LM,bD as kM,bE as IM,bF as TM}from"./index-B_laiNkZ.js";function DM(i,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in i)){const s=Object.getOwnPropertyDescriptor(n,r);s&&Object.defineProperty(i,r,s.get?s:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}))}var uv={},hf=Yt,PM=Ct,AM=lv,f1=function(i,e){var t=(PM.Object||{})[i]||Object[i],n={};n[i]=e(t),hf(hf.S+hf.F*AM(function(){t(1)}),"Object",n)},MM=ov,RM=p1;f1("keys",function(){return function(i){return RM(MM(i))}});var NM=Ct.Object.keys,VM={default:NM,__esModule:!0};const di=It(VM);var vg=sv,OM=jr("toStringTag"),BM=vg(function(){return arguments}())=="Arguments",_M=function(i,e){try{return i[e]}catch{}},yh=function(i){var e,t,n;return i===void 0?"Undefined":i===null?"Null":typeof(t=_M(e=Object(i),OM))=="string"?t:BM?vg(e):(n=vg(e))=="Object"&&typeof e.callee=="function"?"Arguments":n},FM=yh,UM=jr("iterator"),zM=av,GM=Ct.isIterable=function(i){var e=Object(i);return e[UM]!==void 0||"@@iterator"in e||zM.hasOwnProperty(FM(e))},WM=GM,$M={default:WM,__esModule:!0},jM=yh,HM=jr("iterator"),JM=av,hv=Ct.getIteratorMethod=function(i){if(i!=null)return i[HM]||i["@@iterator"]||JM[jM(i)]},ZM=jo,qM=hv,YM=Ct.getIterator=function(i){var e=qM(i);if(typeof e!="function")throw TypeError(i+" is not iterable!");return ZM(e.call(i))},KM=YM,g1={default:KM,__esModule:!0};const pv=It(g1);var XM=$M,QM=m1(XM),eR=g1,tR=m1(eR);function m1(i){return i&&i.__esModule?i:{default:i}}var oe=function(){function i(e,t){var n=[],r=!0,s=!1,o=void 0;try{for(var l=(0,tR.default)(e),c;!(r=(c=l.next()).done)&&(n.push(c.value),!(t&&n.length===t));r=!0);}catch(u){s=!0,o=u}finally{try{!r&&l.return&&l.return()}finally{if(s)throw o}}return n}return function(e,t){if(Array.isArray(e))return e;if((0,QM.default)(Object(e)))return i(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),iR=h1,bh=function(i,e,t){for(var n in e)t&&i[n]?i[n]=e[n]:iR(i,n,e[n]);return i},Sh=function(i,e,t,n){if(!(i instanceof e)||n!==void 0&&n in i)throw TypeError(t+": incorrect invocation!");return i},v1={exports:{}},cS=jo,y1=function(i,e,t,n){try{return n?e(cS(t)[0],t[1]):e(t)}catch(s){var r=i.return;throw r!==void 0&&cS(r.call(i)),s}},nR=av,rR=jr("iterator"),sR=Array.prototype,b1=function(i){return i!==void 0&&(nR.Array===i||sR[rR]===i)},aR=fa,oR=y1,lR=b1,dR=jo,cR=gh,uR=hv,yg={},bg={},S1=v1.exports=function(i,e,t,n,r){var s=r?function(){return i}:uR(i),o=aR(t,n,e?2:1),l=0,c,u,f,g;if(typeof s!="function")throw TypeError(i+" is not iterable!");if(lR(s)){for(c=cR(i.length);c>l;l++)if(g=e?o(dR(u=i[l])[0],u[1]):o(i[l]),g===yg||g===bg)return g}else for(f=s.call(i);!(u=f.next()).done;)if(g=oR(f,o,u.value,e),g===yg||g===bg)return g};S1.BREAK=yg;S1.RETURN=bg;var Ho=v1.exports,hR=Hr,uS=Ct,pR=ph,fR=vh,hS=jr("species"),w1=function(i){var e=typeof uS[i]=="function"?uS[i]:hR[i];fR&&e&&!e[hS]&&pR.f(e,hS,{configurable:!0,get:function(){return this}})},gR=ks,ga=function(i,e){if(!gR(i)||i._t!==e)throw TypeError("Incompatible receiver, "+e+" required!");return i},mR=ph.f,vR=TM,yR=bh,bR=fa,SR=Sh,wR=Ho,CR=kM,Fc=IM,xR=w1,C1=vh,x1=fh.fastKey,Qa=ga,zl=C1?"_s":"size",Uc=function(i,e){var t=x1(e),n;if(t!=="F")return i._i[t];for(n=i._f;n;n=n.n)if(n.k==e)return n},E1={getConstructor:function(i,e,t,n){var r=i(function(s,o){SR(s,r,e,"_i"),s._t=e,s._i=vR(null),s._f=void 0,s._l=void 0,s[zl]=0,o!=null&&wR(o,t,s[n],s)});return yR(r.prototype,{clear:function(){for(var s=Qa(this,e),o=s._i,l=s._f;l;l=l.n)l.r=!0,l.p&&(l.p=l.p.n=void 0),delete o[l.i];s._f=s._l=void 0,s[zl]=0},delete:function(s){var o=Qa(this,e),l=Uc(o,s);if(l){var c=l.n,u=l.p;delete o._i[l.i],l.r=!0,u&&(u.n=c),c&&(c.p=u),o._f==l&&(o._f=c),o._l==l&&(o._l=u),o[zl]--}return!!l},forEach:function(s){Qa(this,e);for(var o=bR(s,arguments.length>1?arguments[1]:void 0,3),l;l=l?l.n:this._f;)for(o(l.v,l.k,this);l&&l.r;)l=l.p},has:function(s){return!!Uc(Qa(this,e),s)}}),C1&&mR(r.prototype,"size",{get:function(){return Qa(this,e)[zl]}}),r},def:function(i,e,t){var n=Uc(i,e),r,s;return n?n.v=t:(i._l=n={i:s=x1(e,!0),k:e,v:t,p:r=i._l,n:void 0,r:!1},i._f||(i._f=n),r&&(r.n=n),i[zl]++,s!=="F"&&(i._i[s]=n)),i},getEntry:Uc,setStrong:function(i,e,t){CR(i,e,function(n,r){this._t=Qa(n,e),this._k=r,this._l=void 0},function(){for(var n=this,r=n._k,s=n._l;s&&s.r;)s=s.p;return!n._t||!(n._l=s=s?s.n:n._t._f)?(n._t=void 0,Fc(1)):r=="keys"?Fc(0,s.k):r=="values"?Fc(0,s.v):Fc(0,[s.k,s.v])},t?"entries":"values",!t,!0),xR(e)}},ER=ks,pS=CM,LR=jr("species"),kR=function(i){var e;return pS(i)&&(e=i.constructor,typeof e=="function"&&(e===Array||pS(e.prototype))&&(e=void 0),ER(e)&&(e=e[LR],e===null&&(e=void 0))),e===void 0?Array:e},IR=kR,TR=function(i,e){return new(IR(i))(e)},DR=fa,PR=yM,AR=ov,MR=gh,RR=TR,fv=function(i,e){var t=i==1,n=i==2,r=i==3,s=i==4,o=i==6,l=i==5||o,c=e||RR;return function(u,f,g){for(var v=AR(u),y=PR(v),C=DR(f,g,3),w=MR(y.length),S=0,L=t?c(u,w):n?c(u,0):void 0,I,M;w>S;S++)if((l||S in y)&&(I=y[S],M=C(I,S,v),i)){if(t)L[S]=M;else if(M)switch(i){case 3:return!0;case 5:return I;case 6:return S;case 2:L.push(I)}else if(s)return!1}return o?-1:r||s?s:L}},NR=Hr,zc=Yt,VR=fh,OR=lv,BR=h1,_R=bh,FR=Ho,fS=Sh,UR=ks,zR=u1,GR=ph.f,WR=fv(0),$R=vh,wh=function(i,e,t,n,r,s){var o=NR[i],l=o,c=r?"set":"add",u=l&&l.prototype,f={};return!$R||typeof l!="function"||!(s||u.forEach&&!OR(function(){new l().entries().next()}))?(l=n.getConstructor(e,i,r,c),_R(l.prototype,t),VR.NEED=!0):(l=e(function(g,v){fS(g,l,i,"_c"),g._c=new o,v!=null&&FR(v,r,g[c],g)}),WR("add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON".split(","),function(g){var v=g=="add"||g=="set";g in u&&!(s&&g=="clear")&&BR(l.prototype,g,function(y,C){if(fS(this,l,g),!v&&s&&!UR(y))return g=="get"?void 0:!1;var w=this._c[g](y===0?0:y,C);return v?this:w})}),s||GR(l.prototype,"size",{get:function(){return this._c.size}})),zR(l,i),f[i]=l,zc(zc.G+zc.W+zc.F,f),s||n.setStrong(l,i,r),l},pf=E1,gS=ga,ff="Map";wh(ff,function(i){return function(){return i(this,arguments.length>0?arguments[0]:void 0)}},{get:function(i){var e=pf.getEntry(gS(this,ff),i);return e&&e.v},set:function(i,e){return pf.def(gS(this,ff),i===0?0:i,e)}},pf,!0);var gf,mS;function jR(){if(mS)return gf;mS=1;var i=Ho;return gf=function(e,t){var n=[];return i(e,!1,n.push,n,t),n},gf}var mf,vS;function L1(){if(vS)return mf;vS=1;var i=yh,e=jR();return mf=function(t){return function(){if(i(this)!=t)throw TypeError(t+"#toJSON isn't generic");return e(this)}},mf}var vf=Yt;vf(vf.P+vf.R,"Map",{toJSON:L1()("Map")});var yS=Yt,Ch=function(i){yS(yS.S,i,{of:function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return new this(t)}})};Ch("Map");var bS=Yt,SS=mh,HR=fa,wS=Ho,xh=function(i){bS(bS.S,i,{from:function(e){var t=arguments[1],n,r,s,o;return SS(this),n=t!==void 0,n&&SS(t),e==null?new this:(r=[],n?(s=0,o=HR(t,arguments[2],2),wS(e,!1,function(l){r.push(o(l,s++))})):wS(e,!1,r.push,r),new this(r))}})};xh("Map");var JR=Ct.Map,ZR={default:JR,__esModule:!0};const ue=It(ZR);var qR=ph,YR=fM,KR=function(i,e,t){e in i?qR.f(i,e,YR(0,t)):i[e]=t},yf,CS;function k1(){if(CS)return yf;CS=1;var i=jr("iterator"),e=!1;try{var t=[7][i]();t.return=function(){e=!0},Array.from(t,function(){throw 2})}catch{}return yf=function(n,r){if(!r&&!e)return!1;var s=!1;try{var o=[7],l=o[i]();l.next=function(){return{done:s=!0}},o[i]=function(){return l},n(o)}catch{}return s},yf}var XR=fa,bf=Yt,QR=ov,e2=y1,t2=b1,i2=gh,xS=KR,n2=hv;bf(bf.S+bf.F*!k1()(function(i){Array.from(i)}),"Array",{from:function(i){var e=QR(i),t=typeof this=="function"?this:Array,n=arguments.length,r=n>1?arguments[1]:void 0,s=r!==void 0,o=0,l=n2(e),c,u,f,g;if(s&&(r=XR(r,n>2?arguments[2]:void 0,2)),l!=null&&!(t==Array&&t2(l)))for(g=l.call(e),u=new t;!(f=g.next()).done;o++)xS(u,o,s?e2(g,r,[f.value,o],!0):f.value);else for(c=i2(e.length),u=new t(c);c>o;o++)xS(u,o,s?r(e[o],o):e[o]);return u.length=o,u}});var r2=Ct.Array.from,I1={default:r2,__esModule:!0};const Te=It(I1);var ES=E1,s2=ga,LS="Set";wh(LS,function(i){return function(){return i(this,arguments.length>0?arguments[0]:void 0)}},{add:function(i){return ES.def(s2(this,LS),i=i===0?0:i,i)}},ES);var Sf=Yt;Sf(Sf.P+Sf.R,"Set",{toJSON:L1()("Set")});Ch("Set");xh("Set");var a2=Ct.Set,o2={default:a2,__esModule:!0};const je=It(o2);var kS=Ct,IS=kS.JSON||(kS.JSON={stringify:JSON.stringify}),l2=function(i){return IS.stringify.apply(IS,arguments)},d2={default:l2,__esModule:!0};const se=It(d2);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function T1(i,e){let t=i.length,n=0;for(let r=0;r<t;++r)e(i[r],r,i)&&(i[n]=i[r],++n);i.length=n}function c2(i,e){if(i.length===e)return i;let t=new i.constructor(e);return t.set(i),t}function Sg(i,e,t,n){const r=i.length/e,s=i.length*t*n,o=new i.constructor(s),l=i.length*n,c=e,u=e*n;for(let f=0;f<r;++f)for(let g=0;g<e;++g){const v=i[f*e+g],y=f*u+g;for(let C=0;C<t;++C)for(let w=0;w<n;++w)o[C*l+w*c+y]=v}return o}function u2(i,e,t,n=0,r=i.length){for(;n<r;){const s=n+r-1>>1,o=t(e,i[s]);if(o>0)n=s+1;else if(o<0)r=s;else return s}return~n}function h2(i,e,t){let n=e-i;for(;n>0;){let r=Math.floor(n/2),s=i+r;t(s)?n=r:(i=s+1,n-=r+1)}return i}function p2(i,e){const t=[];for(let n=0,r=i.length;n<r;++n)i[n]===e&&t.push(n);return t}function _e(i,e){const t=i.length;if(e.length!==t)return!1;for(let n=0;n<t;++n)if(i[n]!==e[n])return!1;return!0}function wg(i,e,t=(n,r)=>n===r){const n=i.length;if(e.length!==n)return!1;for(let r=0;r<n;++r)if(!t(i[r],e[r]))return!1;return!0}function f2(i,e,t){const n=[];if(t===e){for(let r=0;r<i;++r)n[r]=r;return n}n[t]=e;for(let r=0,s=0;r<i;){if(r===e){++r;continue}s===t&&++s,n[s++]=r++}return n}function TS(i,e,t){for(let n=0,r=t.length;n<r;++n){const s=t[n];s!==-1&&(i[n]=e[s])}return i}function Md(i){const e=[];for(let t=0,n=i.length;t<n;++t){const r=i[t];for(let s=0,o=r.length;s<o;++s){let l=e[s];l===void 0&&(l=e[s]=[]),l.push(r[s])}}return e}function g2(i,e){const t=[];let n=0;for(let o=0,l=e.length;o<l;++o){var r=e[o];const c=r.retainCount,u=r.deleteCount,f=r.insertCount;c!==0&&(t.push(i.slice(n,n+c)),n+=c),n+=u,f!==0&&t.push(new Array(f))}const s=i.length;return n!==s&&t.push(i.slice(n)),new Array(0).concat(...t)}function m2(i,e,t){const n=[];let r=0,s=0,o=i.length,l=e.length;for(;r<o&&s<l;){let c,u=i[r],f=e[s];if(c=t(u,f),c===0){let g=1;for(++r,++s;r<o&&s<l&&(c=t(i[r],e[s]))===0;)++g,++r,++s;n.push({retainCount:g,deleteCount:0,insertCount:0});continue}if(c<0){let g=1;for(;++r<o&&(c=t(i[r],f))<0;)++g;n.push({retainCount:0,deleteCount:g,insertCount:0});continue}if(c>0){let g=1;for(;++s<l&&(c=t(u,e[s]))>0;)++g;n.push({retainCount:0,deleteCount:0,insertCount:g});continue}}return(r<o||s<l)&&n.push({retainCount:0,deleteCount:o-r,insertCount:l-s}),n}function v2(i,e,t,n,r,s){let o=0,l=0;if(i!==0&&e!==0)for(;;){const c=t(o,l);if(c<0){if(n(o),++o===i)break}else if(c>0){if(r(l),++l===e)break}else if(s(o,l),++o,++l,o===i||l===e)break}for(;o<i;)n(o),++o;for(;l<e;)r(l),++l}var y2=LM,b2=function(){return y2.Date.now()},S2=b2,w2=/\s/;function C2(i){for(var e=i.length;e--&&w2.test(i.charAt(e)););return e}var x2=C2,E2=x2,L2=/^\s+/;function k2(i){return i&&i.slice(0,E2(i)+1).replace(L2,"")}var I2=k2,T2=EM,D2=xM,P2="[object Symbol]";function A2(i){return typeof i=="symbol"||D2(i)&&T2(i)==P2}var M2=A2,R2=I2,DS=cv,N2=M2,PS=NaN,V2=/^[-+]0x[0-9a-f]+$/i,O2=/^0b[01]+$/i,B2=/^0o[0-7]+$/i,_2=parseInt;function F2(i){if(typeof i=="number")return i;if(N2(i))return PS;if(DS(i)){var e=typeof i.valueOf=="function"?i.valueOf():i;i=DS(e)?e+"":e}if(typeof i!="string")return i===0?i:+i;i=R2(i);var t=O2.test(i);return t||B2.test(i)?_2(i.slice(2),t?2:8):V2.test(i)?PS:+i}var U2=F2,z2=cv,wf=S2,AS=U2,G2="Expected a function",W2=Math.max,$2=Math.min;function j2(i,e,t){var n,r,s,o,l,c,u=0,f=!1,g=!1,v=!0;if(typeof i!="function")throw new TypeError(G2);e=AS(e)||0,z2(t)&&(f=!!t.leading,g="maxWait"in t,s=g?W2(AS(t.maxWait)||0,e):s,v="trailing"in t?!!t.trailing:v);function y(T){var A=n,V=r;return n=r=void 0,u=T,o=i.apply(V,A),o}function C(T){return u=T,l=setTimeout(L,e),f?y(T):o}function w(T){var A=T-c,V=T-u,O=e-A;return g?$2(O,s-V):O}function S(T){var A=T-c,V=T-u;return c===void 0||A>=e||A<0||g&&V>=s}function L(){var T=wf();if(S(T))return I(T);l=setTimeout(L,w(T))}function I(T){return l=void 0,v&&n?y(T):(n=r=void 0,o)}function M(){l!==void 0&&clearTimeout(l),u=0,n=c=r=l=void 0}function R(){return l===void 0?o:I(wf())}function D(){var T=wf(),A=S(T);if(n=arguments,r=this,c=T,A){if(l===void 0)return C(c);if(g)return clearTimeout(l),l=setTimeout(L,e),y(c)}return l===void 0&&(l=setTimeout(L,e)),o}return D.cancel=M,D.flush=R,D}var D1=j2;const ct=It(D1);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function P1(i){typeof i=="object"?i.dispose():i()}function wo(i){for(let e=i.length;e>0;--e)P1(i[e-1])}function Bn(i,e,t,n){return i.addEventListener(e,t,n),()=>i.removeEventListener(e,t,n)}class K{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){--this.refCount===0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let e=this.disposers;e!==void 0&&(wo(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let t=this.disposers;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let t=this.disposers;if(t!=null){let n=t.indexOf(e);n!==-1&&t.splice(n,1)}return e}registerEventListener(e,t,n,r){this.registerDisposer(Bn(e,t,n,r))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class A1 extends K{constructor(e){super(),this.value=e}}function M1(i){return()=>{if(i!==void 0){let e=i;i=void 0,P1(e)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class at{constructor(){this.handlers=new je,this.count=0;const e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}}class xe extends at{}const R1={count:0,add(i){return()=>{}},remove(i){return!1}};class gt{constructor(e){this.value_=e,this.changed=new xe}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}}class ci extends gt{constructor(e,t,n=e){super(e),this.validator=t,this.defaultValue=n}toJSON(){if(this.value_!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let t=this.validator;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}class N1 extends K{constructor(e,t){super(),this.changed=new xe,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}}function MS(i,...e){return new N1(i,e)}class H2 extends K{constructor(e,t){super(),this.changed=new xe,this.valueGeneration=-1,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){const e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}}function nr(i,...e){return new H2(i,e)}class V1 extends K{constructor(e,t=(n,r)=>n===r){super(),this.changed=new at,this.value=e.value,this.registerDisposer(e.changed.add(()=>{const n=e.value;t(this.value,n)||(this.value=n,this.changed.dispatch())}))}}function wn(i,e,t){const n=new N1(i,e),r=new V1(n,t);return r.registerDisposer(n),r}class O1 extends K{constructor(e){super(),this.changed=new xe;const t=e(this),n=di(t),r=()=>{const s=Array.isArray(t)?[]:{};for(const o of n)s[o]=t[o].value;this.value=s,this.changed.dispatch()};r();for(const s of n){const o=t[s];this.registerDisposer(o.changed.add(()=>r()))}}}class J2{constructor(e){this.changed=new xe,e===void 0?this.values=new je:this.values=new je(e)}add(e){const t=this.values;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){return this.values.delete(e)?(this.changed.dispatch(),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Wi](){return pv(this.values)}clear(){const e=this.values;e.size>0&&(e.clear(),this.changed.dispatch())}}function Fr(i,...e){let t=e.map(c=>c.value);const n=e.length;let r=new K,s=i(r,...t);const o=ct(()=>{let c=!1;for(let u=0;u<n;++u){const f=e[u].value;t[u]!==f&&(t[u]=f,c=!0)}c&&(r.dispose(),r=new K,s=i(r,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),wo(l),r.dispose()},get value(){return o.flush(),s}}}function Co(i,...e){let t=e.map(c=>c.value);const n=e.length;let r=new K,s=i(r,...t);const o=()=>{let c=!1;for(let u=0;u<n;++u){const f=e[u].value;t[u]!==f&&(t[u]=f,c=!0)}c&&(r.dispose(),r=new K,s=i(r,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){wo(l),r.dispose()},get value(){return s}}}function aa(i){return{changed:R1,value:i}}function Or(i,e){return i(e.value),e.changed.add(()=>i(e.value))}class ou{constructor(e,t){this.outer=e,this.getInner=t,this.changed=new xe,this.update=()=>{const n=this.disposer,r=this.outer;n!==void 0&&n();const s=this.inner=this.getInner(r.value);this.disposer=s.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class Cf extends ou{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Gc=new Float32Array(1);function Z2(i){Gc[0]=i,i=Gc[0];for(let e=1;e<21;++e){let t=i.toPrecision(e);if(Gc[0]=parseFloat(t),Gc[0]===i)return t}return i.toString()}var lu=1e-6,Pi=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});function Rd(){var i=new Pi(9);return Pi!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function q2(i,e){if(i===e){var t=e[1],n=e[2],r=e[5];i[1]=e[3],i[2]=e[6],i[3]=t,i[5]=e[7],i[6]=n,i[7]=r}else i[0]=e[0],i[1]=e[3],i[2]=e[6],i[3]=e[1],i[4]=e[4],i[5]=e[7],i[6]=e[2],i[7]=e[5],i[8]=e[8];return i}function Y2(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],o=e[4],l=e[5],c=e[6],u=e[7],f=e[8],g=f*o-l*u,v=-f*s+l*c,y=u*s-o*c,C=t*g+n*v+r*y;return C?(C=1/C,i[0]=g*C,i[1]=(-f*n+r*u)*C,i[2]=(l*n-r*o)*C,i[3]=v*C,i[4]=(f*t-r*c)*C,i[5]=(-l*t+r*s)*C,i[6]=y*C,i[7]=(-u*t+n*c)*C,i[8]=(o*t-n*s)*C,i):null}function gv(i){var e=i[0],t=i[1],n=i[2],r=i[3],s=i[4],o=i[5],l=i[6],c=i[7],u=i[8];return e*(u*s-o*c)+t*(-u*r+o*l)+n*(c*r-s*l)}function B1(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],o=t+t,l=n+n,c=r+r,u=t*o,f=n*o,g=n*l,v=r*o,y=r*l,C=r*c,w=s*o,S=s*l,L=s*c;return i[0]=1-g-C,i[3]=f-L,i[6]=v+S,i[1]=f+L,i[4]=1-u-C,i[7]=y-w,i[2]=v-S,i[5]=y+w,i[8]=1-u-g,i}function Qe(){var i=new Pi(16);return Pi!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i}function K2(i){var e=new Pi(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e}function wu(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function _1(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function mv(i,e){if(i===e){var t=e[1],n=e[2],r=e[3],s=e[6],o=e[7],l=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=n,i[9]=s,i[11]=e[14],i[12]=r,i[13]=o,i[14]=l}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function Cs(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],o=e[4],l=e[5],c=e[6],u=e[7],f=e[8],g=e[9],v=e[10],y=e[11],C=e[12],w=e[13],S=e[14],L=e[15],I=t*l-n*o,M=t*c-r*o,R=t*u-s*o,D=n*c-r*l,T=n*u-s*l,A=r*u-s*c,V=f*w-g*C,O=f*S-v*C,_=f*L-y*C,H=g*S-v*w,U=g*L-y*w,B=v*L-y*S,W=I*B-M*U+R*H+D*_-T*O+A*V;return W?(W=1/W,i[0]=(l*B-c*U+u*H)*W,i[1]=(r*U-n*B-s*H)*W,i[2]=(w*A-S*T+L*D)*W,i[3]=(v*T-g*A-y*D)*W,i[4]=(c*_-o*B-u*O)*W,i[5]=(t*B-r*_+s*O)*W,i[6]=(S*R-C*A-L*M)*W,i[7]=(f*A-v*R+y*M)*W,i[8]=(o*U-l*_+u*V)*W,i[9]=(n*_-t*U-s*V)*W,i[10]=(C*T-w*R+L*I)*W,i[11]=(g*R-f*T-y*I)*W,i[12]=(l*O-o*H-c*V)*W,i[13]=(t*H-n*O+r*V)*W,i[14]=(w*M-C*D-S*I)*W,i[15]=(f*D-g*M+v*I)*W,i):null}function fi(i,e,t){var n=e[0],r=e[1],s=e[2],o=e[3],l=e[4],c=e[5],u=e[6],f=e[7],g=e[8],v=e[9],y=e[10],C=e[11],w=e[12],S=e[13],L=e[14],I=e[15],M=t[0],R=t[1],D=t[2],T=t[3];return i[0]=M*n+R*l+D*g+T*w,i[1]=M*r+R*c+D*v+T*S,i[2]=M*s+R*u+D*y+T*L,i[3]=M*o+R*f+D*C+T*I,M=t[4],R=t[5],D=t[6],T=t[7],i[4]=M*n+R*l+D*g+T*w,i[5]=M*r+R*c+D*v+T*S,i[6]=M*s+R*u+D*y+T*L,i[7]=M*o+R*f+D*C+T*I,M=t[8],R=t[9],D=t[10],T=t[11],i[8]=M*n+R*l+D*g+T*w,i[9]=M*r+R*c+D*v+T*S,i[10]=M*s+R*u+D*y+T*L,i[11]=M*o+R*f+D*C+T*I,M=t[12],R=t[13],D=t[14],T=t[15],i[12]=M*n+R*l+D*g+T*w,i[13]=M*r+R*c+D*v+T*S,i[14]=M*s+R*u+D*y+T*L,i[15]=M*o+R*f+D*C+T*I,i}function X2(i,e,t){var n=t[0],r=t[1],s=t[2],o,l,c,u,f,g,v,y,C,w,S,L;return e===i?(i[12]=e[0]*n+e[4]*r+e[8]*s+e[12],i[13]=e[1]*n+e[5]*r+e[9]*s+e[13],i[14]=e[2]*n+e[6]*r+e[10]*s+e[14],i[15]=e[3]*n+e[7]*r+e[11]*s+e[15]):(o=e[0],l=e[1],c=e[2],u=e[3],f=e[4],g=e[5],v=e[6],y=e[7],C=e[8],w=e[9],S=e[10],L=e[11],i[0]=o,i[1]=l,i[2]=c,i[3]=u,i[4]=f,i[5]=g,i[6]=v,i[7]=y,i[8]=C,i[9]=w,i[10]=S,i[11]=L,i[12]=o*n+f*r+C*s+e[12],i[13]=l*n+g*r+w*s+e[13],i[14]=c*n+v*r+S*s+e[14],i[15]=u*n+y*r+L*s+e[15]),i}function Q2(i,e,t){var n=t[0],r=t[1],s=t[2];return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i[3]=e[3]*n,i[4]=e[4]*r,i[5]=e[5]*r,i[6]=e[6]*r,i[7]=e[7]*r,i[8]=e[8]*s,i[9]=e[9]*s,i[10]=e[10]*s,i[11]=e[11]*s,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function eN(i,e,t,n){var r=e[0],s=e[1],o=e[2],l=e[3],c=r+r,u=s+s,f=o+o,g=r*c,v=r*u,y=r*f,C=s*u,w=s*f,S=o*f,L=l*c,I=l*u,M=l*f,R=n[0],D=n[1],T=n[2];return i[0]=(1-(C+S))*R,i[1]=(v+M)*R,i[2]=(y-I)*R,i[3]=0,i[4]=(v-M)*D,i[5]=(1-(g+S))*D,i[6]=(w+L)*D,i[7]=0,i[8]=(y+I)*T,i[9]=(w-L)*T,i[10]=(1-(g+C))*T,i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}function tN(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],o=t+t,l=n+n,c=r+r,u=t*o,f=n*o,g=n*l,v=r*o,y=r*l,C=r*c,w=s*o,S=s*l,L=s*c;return i[0]=1-g-C,i[1]=f+L,i[2]=v-S,i[3]=0,i[4]=f-L,i[5]=1-u-C,i[6]=y+w,i[7]=0,i[8]=v+S,i[9]=y-w,i[10]=1-u-g,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function iN(i,e,t,n,r){var s=1/Math.tan(e/2),o;return i[0]=s/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=s,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,r!=null&&r!==1/0?(o=1/(n-r),i[10]=(r+n)*o,i[14]=2*r*n*o):(i[10]=-1,i[14]=-2*n),i}function F1(i,e,t,n,r,s,o){var l=1/(e-t),c=1/(n-r),u=1/(s-o);return i[0]=-2*l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*c,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*u,i[11]=0,i[12]=(e+t)*l,i[13]=(r+n)*c,i[14]=(o+s)*u,i[15]=1,i}function Ne(){var i=new Pi(3);return Pi!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function Cg(i){var e=new Pi(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e}function nN(i){var e=i[0],t=i[1],n=i[2];return Math.hypot(e,t,n)}function bt(i,e,t){var n=new Pi(3);return n[0]=i,n[1]=e,n[2]=t,n}function rN(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i}function xg(i,e,t,n){return i[0]=e,i[1]=t,i[2]=n,i}function U1(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i}function z1(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function G1(i,e,t){return i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i}function Eg(i,e,t){return i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i}function RS(i,e){return i[0]=Math.ceil(e[0]),i[1]=Math.ceil(e[1]),i[2]=Math.ceil(e[2]),i}function vv(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i}function Cu(i,e){var t=e[0],n=e[1],r=e[2],s=t*t+n*n+r*r;return s>0&&(s=1/Math.sqrt(s)),i[0]=e[0]*s,i[1]=e[1]*s,i[2]=e[2]*s,i}function yv(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function xf(i,e,t){var n=e[0],r=e[1],s=e[2],o=t[0],l=t[1],c=t[2];return i[0]=r*c-s*l,i[1]=s*o-n*c,i[2]=n*l-r*o,i}function yn(i,e,t){var n=e[0],r=e[1],s=e[2],o=t[3]*n+t[7]*r+t[11]*s+t[15];return o=o||1,i[0]=(t[0]*n+t[4]*r+t[8]*s+t[12])/o,i[1]=(t[1]*n+t[5]*r+t[9]*s+t[13])/o,i[2]=(t[2]*n+t[6]*r+t[10]*s+t[14])/o,i}function fo(i,e,t){var n=t[0],r=t[1],s=t[2],o=t[3],l=e[0],c=e[1],u=e[2],f=r*u-s*c,g=s*l-n*u,v=n*c-r*l,y=r*v-s*g,C=s*f-n*v,w=n*g-r*f,S=o*2;return f*=S,g*=S,v*=S,y*=2,C*=2,w*=2,i[0]=l+f+y,i[1]=c+g+C,i[2]=u+v+w,i}function Lg(i,e){var t=i[0],n=i[1],r=i[2],s=e[0],o=e[1],l=e[2];return Math.abs(t-s)<=lu*Math.max(1,Math.abs(t),Math.abs(s))&&Math.abs(n-o)<=lu*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-l)<=lu*Math.max(1,Math.abs(r),Math.abs(l))}var sN=z1,aN=nN;(function(){var i=Ne();return function(e,t,n,r,s,o){var l,c;for(t||(t=3),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,l=n;l<c;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],s(i,i,o),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2];return e}})();function Eh(){var i=new Pi(4);return Pi!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function Nd(i,e,t,n){var r=new Pi(4);return r[0]=i,r[1]=e,r[2]=t,r[3]=n,r}function oN(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i}function lN(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],o=t*t+n*n+r*r+s*s;return o>0&&(o=1/Math.sqrt(o)),i[0]=t*o,i[1]=n*o,i[2]=r*o,i[3]=s*o,i}(function(){var i=Eh();return function(e,t,n,r,s,o){var l,c;for(t||(t=4),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,l=n;l<c;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],i[3]=e[l+3],s(i,i,o),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2],e[l+3]=i[3];return e}})();function zi(){var i=new Pi(4);return Pi!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function NS(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function kg(i,e,t){t=t*.5;var n=Math.sin(t);return i[0]=n*e[0],i[1]=n*e[1],i[2]=n*e[2],i[3]=Math.cos(t),i}function vs(i,e,t){var n=e[0],r=e[1],s=e[2],o=e[3],l=t[0],c=t[1],u=t[2],f=t[3];return i[0]=n*f+o*l+r*u-s*c,i[1]=r*f+o*c+s*l-n*u,i[2]=s*f+o*u+n*c-r*l,i[3]=o*f-n*l-r*c-s*u,i}function dN(i,e,t){t*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return i[0]=n*c+o*l,i[1]=r*c+s*l,i[2]=s*c-r*l,i[3]=o*c-n*l,i}function cN(i,e,t){t*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return i[0]=n*c-s*l,i[1]=r*c+o*l,i[2]=s*c+n*l,i[3]=o*c-r*l,i}function Ef(i,e,t,n){var r=e[0],s=e[1],o=e[2],l=e[3],c=t[0],u=t[1],f=t[2],g=t[3],v,y,C,w,S;return y=r*c+s*u+o*f+l*g,y<0&&(y=-y,c=-c,u=-u,f=-f,g=-g),1-y>lu?(v=Math.acos(y),C=Math.sin(v),w=Math.sin((1-n)*v)/C,S=Math.sin(n*v)/C):(w=1-n,S=n),i[0]=w*r+S*c,i[1]=w*s+S*u,i[2]=w*o+S*f,i[3]=w*l+S*g,i}function xu(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],o=t*t+n*n+r*r+s*s,l=o?1/o:0;return i[0]=-t*l,i[1]=-n*l,i[2]=-r*l,i[3]=s*l,i}function W1(i,e){var t=e[0]+e[4]+e[8],n;if(t>0)n=Math.sqrt(t+1),i[3]=.5*n,n=.5/n,i[0]=(e[5]-e[7])*n,i[1]=(e[6]-e[2])*n,i[2]=(e[1]-e[3])*n;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[r*3+r]&&(r=2);var s=(r+1)%3,o=(r+2)%3;n=Math.sqrt(e[r*3+r]-e[s*3+s]-e[o*3+o]+1),i[r]=.5*n,n=.5/n,i[3]=(e[s*3+o]-e[o*3+s])*n,i[s]=(e[s*3+r]+e[r*3+s])*n,i[o]=(e[o*3+r]+e[r*3+o])*n}return i}var uN=oN,cd=lN;(function(){var i=Ne(),e=bt(1,0,0),t=bt(0,1,0);return function(n,r,s){var o=yv(r,s);return o<-.999999?(xf(i,e,r),aN(i)<1e-6&&xf(i,t,r),Cu(i,i),kg(n,i,Math.PI),n):o>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(xf(i,r,s),n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=1+o,cd(n,n))}})();(function(){var i=zi(),e=zi();return function(t,n,r,s,o,l){return Ef(i,n,o,l),Ef(e,r,s,l),Ef(t,i,e,2*l*(1-l)),t}})();(function(){var i=Rd();return function(e,t,n,r){return i[0]=n[0],i[3]=n[1],i[6]=n[2],i[1]=r[0],i[4]=r[1],i[7]=r[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],cd(e,W1(e,i))}})();function $1(){var i=new Pi(2);return Pi!=Float32Array&&(i[0]=0,i[1]=0),i}function hN(i,e,t){return i[0]=e,i[1]=t,i}function pN(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}(function(){var i=$1();return function(e,t,n,r,s,o){var l,c;for(t||(t=2),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,l=n;l<c;l+=t)i[0]=e[l],i[1]=e[l+1],s(i,i,o),e[l]=i[0],e[l+1]=i[1];return e}})();/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const j1=Qe(),fN=["x","y","z"],Kn=[bt(1,0,0),bt(0,1,0),bt(0,0,1)];bt(0,0,0);const Ig=Nd(0,0,0,0),H1=bt(1,1,1);bt(1/0,1/0,1/0);zi();function Tg(i){return i[0]*i[1]*i[2]}function Dg(i){return`${i[0]},${i[1]},${i[2]}`}function gN(i,e,t){let n=e[0],r=e[1],s=e[2];return i[0]=t[0]*n+t[4]*r+t[8]*s,i[1]=t[1]*n+t[5]*r+t[9]*s,i[2]=t[2]*n+t[6]*r+t[10]*s,i}function J1(i,e,t){let n=e[0],r=e[1],s=e[2];return i[0]=t[0]*n+t[1]*r+t[2]*s,i[1]=t[4]*n+t[5]*r+t[6]*s,i[2]=t[8]*n+t[9]*r+t[10]*s,i}function mN(i,e,t){const n=t.length;let r=0;for(let o=0;o<n;++o)r+=(i[o]-e[o])**2;let s=0;for(let o=0;o<n;++o){const l=i[o];s-=(l-t[o])*(e[o]-l)}return s/Math.max(r,1e-6)}function Z1(i,e,t,n){const r=i.length;let s=mN(e,t,n);s=Math.max(0,Math.min(1,s));for(let o=0;o<r;++o){const l=e[o];i[o]=l+s*(t[o]-l)}return i}function Lh(i,e){const t=e[0],n=e[1],r=e[2],s=e[4],o=e[5],l=e[6],c=e[8],u=e[9],f=e[10];return i[0]=t,i[1]=n,i[2]=r,i[3]=s,i[4]=o,i[5]=l,i[6]=c,i[7]=u,i[8]=f,i}function Eu(i,e){const t=e[0],n=e[1],r=e[2],s=e[3],o=e[4],l=e[5],c=e[6],u=e[7],f=e[8],g=e[9],v=e[10],y=e[11],C=e[12],w=e[13],S=e[14],L=e[15];i[0]=s+t,i[1]=u+o,i[2]=y+f,i[3]=L+C,i[4]=s-t,i[5]=u-o,i[6]=y-f,i[7]=L-C,i[8]=s+n,i[9]=u+l,i[10]=y+g,i[11]=L+w,i[12]=s-n,i[13]=u-l,i[14]=y-g,i[15]=L-w;const I=s+r,M=u+c,R=y+v,D=L+S,T=s-r,A=u-c,V=y-v,O=L-S,_=Math.sqrt(I**2+M**2+R**2);i[16]=I/_,i[17]=M/_,i[18]=R/_,i[19]=D/_;const H=Math.sqrt(T**2+A**2+V**2);return i[20]=T/H,i[21]=A/H,i[22]=V/H,i[23]=O/H,i}function q1(i,e,t,n,r,s,o){for(let l=0;l<6;++l){const c=o[l*4],u=o[l*4+1],f=o[l*4+2],g=o[l*4+3];if(Math.max(c*i,c*n)+Math.max(u*e,u*r)+Math.max(f*t,f*s)+g<0)return!1}return!0}function vN(i,e,t,n,r,s,o){for(let l=0;l<4;++l){const c=o[l*4],u=o[l*4+1],f=o[l*4+2],g=o[l*4+3];if(Math.max(c*i,c*n)+Math.max(u*e,u*r)+Math.max(f*t,f*s)+g<0)return!1}{const l=o[20],c=o[5*4+1],u=o[5*4+2],f=o[5*4+3],g=Math.max(l*i,l*n)+Math.max(c*e,c*r)+Math.max(u*t,u*s),v=Math.min(l*i,l*n)+Math.min(c*e,c*r)+Math.min(u*t,u*s),y=Math.abs(f)*1e-6;if(v>-f+y||g<-f-y)return!1}return!0}function kh(i,e,t,n=!1){const r=t.length,s=[],o=n?1:e+1,l=n?e+1:1;for(let c=0;c<r;++c){const u=t[c];for(let f=0;f<e;++f)i[f*o+u*l]!==0&&(s[f]=!0)}return p2(s,!0)}function Y1(i,e,t){for(let n=0;n<3;++n){const r=t[n];for(let s=0;s<3;++s)i[n+s*3]=r*e[n+s*3]}return i}function yN(i){if(i[15]===1){const r=2/Math.abs(i[10]),s=2/Math.abs(i[0]),o=2/Math.abs(i[5]);return s*o*r}const e=i[10],t=2*i[14]/(2*e-2),n=(e-1)*t/(e+1);return 4/(i[0]*i[5])/3*(Math.abs(n)**3-Math.abs(t)**3)}function K1(i){if(i[15]===1)return 2/Math.abs(i[10]);const e=i[10],t=2*i[14]/(2*e-2),n=(e-1)*t/(e+1);return Math.abs(n-t)}function bN(i){return i[2]=0,i[6]=0,i[10]=0,i[14]=0,i}const eo=Ne();function SN(i,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){eo[0]=2*(t&1)-1,eo[1]=2*(t>>>1&1)-1,eo[2]=2*(t>>>2&1)-1,yn(eo,eo,i);for(let n=0;n<3;++n){const r=eo[n];e[n]=Math.min(e[n],r),e[n+3]=Math.max(e[n+3],r)}}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function X1(i){return("0"+i.toString(16)).slice(-2)}function wN(i){return Array.prototype.map.call(i,X1).join("")}function CN(i){if(!/^(?:[0-9a-fA-F]{2})*$/.test(i))throw new Error("Invalid hex-encoded string");const e=i.length/2,t=new Uint8Array(e);for(let n=0;n<e;++n)t[n]=parseInt(i.substr(n*2,2),16);return t}function Q1(i){const e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{const n=i.match(e);if(n!==null)return[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3],10),parseFloat(n[4])]}const t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{const n=i.match(t);if(n!==null)return[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),1]}throw new Error(`Invalid serialized color: ${se(i)}.`)}function bv(i){try{if(typeof i!="string")throw new Error(`Expected string, but received ${se(i)}.`);const e=document.createElement("canvas").getContext("2d");e.fillStyle=i;const t=Q1(e.fillStyle);return Nd(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function ma(i){return bv(i).subarray(0,3)}function Lu(i){const e=i[3]===void 0?3:4;let t=0;for(let n=0;n<e;n++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(i[e-1-n]*255)));return t}function ia(i){return bt((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255)}function Ih(i){return Nd((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255,(i>>>24&255)/255)}function Gi(i){if(i[3]===void 0||i[3]===1){let e="#";for(let t=0;t<3;++t)e+=X1(Math.min(255,Math.max(0,Math.round(i[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(i[t]*255)));return e+=`, ${Z2(i[3])})`,e}}function du(i){return i<=.03928?i/12.92:((i+.055)/1.055)**2.4}function eE(i){var e=oe(i,3);const t=e[0],n=e[1],r=e[2];return .2126*du(t)+.7152*du(n)+.0722*du(r)}function ku(i){return eE(i)<=.179}class ud extends gt{constructor(e){super(Cg(e)),this.defaultValue=e}toString(){return Gi(this.value)}toJSON(){if(!Lg(this.value,this.defaultValue))return Gi(this.value)}reset(){this.value=Cg(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}const t=this.value,n=ma(e);Lg(t,n)||(this.value=n)}}class tE extends gt{constructor(){super(void 0)}toJSON(){const e=this.value;if(e!==void 0)return Gi(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}const t=this.value,n=ma(e);(t===void 0||!Lg(t,n))&&(this.value=n)}}const xN=Object.freeze(Object.defineProperty({__proto__:null,TrackableOptionalRGB:tE,TrackableRGB:ud,getRelativeLuminance:eE,packColor:Lu,parseColorSerialization:Q1,parseRGBAColorSpecification:bv,parseRGBColorSpecification:ma,serializeColor:Gi,srgbGammaExpand:du,unpackRGB:ia,unpackRGBA:Ih,useWhiteBackground:ku},Symbol.toStringTag,{value:"Module"}));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var J;(function(i){i[i.UINT8=0]="UINT8",i[i.INT8=1]="INT8",i[i.UINT16=2]="UINT16",i[i.INT16=3]="INT16",i[i.UINT32=4]="UINT32",i[i.INT32=5]="INT32",i[i.UINT64=6]="UINT64",i[i.FLOAT32=7]="FLOAT32"})(J||(J={}));const iE={[J.UINT8]:!1,[J.INT8]:!0,[J.UINT16]:!1,[J.INT16]:!0,[J.UINT32]:!1,[J.INT32]:!0,[J.UINT64]:!1,[J.FLOAT32]:void 0},EN={[J.UINT8]:1,[J.INT8]:1,[J.UINT16]:2,[J.INT16]:2,[J.UINT32]:4,[J.INT32]:4,[J.UINT64]:8,[J.FLOAT32]:4},LN={[J.UINT8]:Uint8Array,[J.INT8]:Int8Array,[J.UINT16]:Uint16Array,[J.INT16]:Int16Array,[J.UINT32]:Uint32Array,[J.INT32]:Int32Array,[J.UINT64]:Uint32Array,[J.FLOAT32]:Float32Array};J.UINT8+"",J.INT8+"",J.UINT16+"",J.INT16+"",J.UINT32+"",J.INT32+"",J.UINT64+"",J.FLOAT32+"";/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var an;(function(i){i[i.LITTLE=0]="LITTLE",i[i.BIG=1]="BIG"})(an||(an={}));function kN(){const i=Uint16Array.of(4386);return new Uint8Array(i.buffer)[0]===17?an.BIG:an.LITTLE}const Vd=kN();var Lf,VS;function IN(){if(VS)return Lf;VS=1;var i=ks,e=Math.floor;return Lf=function(t){return!i(t)&&isFinite(t)&&e(t)===t},Lf}var OS=Yt;OS(OS.S,"Number",{isInteger:IN()});var TN=Ct.Number.isInteger,DN={default:TN,__esModule:!0};const $i=It(DN);var BS=Yt,PN=Hr.isFinite;BS(BS.S,"Number",{isFinite:function(i){return typeof i=="number"&&PN(i)}});var AN=Ct.Number.isFinite,MN={default:AN,__esModule:!0};const kt=It(MN);var _S=Yt;_S(_S.S,"Number",{isNaN:function(i){return i!=i}});var RN=Ct.Number.isNaN,NN={default:RN,__esModule:!0};const tr=It(NN);function Jo(i){let e=typeof i;if(e==="number"||e==="string"){let t=parseFloat(""+i);if(!tr(t))return t}throw new Error(`Expected floating-point number, but received: ${se(i)}.`)}function Tt(i){let e=Jo(i);if(kt(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function Sv(i){let e=Jo(i);if(kt(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function gi(i){let e=Tt(i);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function hd(i,e,t=Jo){ge(e),i[0]=i[1]=i[2]=0;for(const n of di(e))switch(n){case"x":i[0]=t(e[n]);break;case"y":i[1]=t(e[n]);break;case"z":i[2]=t(e[n]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${se(e)}.`)}return i}function go(i,e){let t=i.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let n=0;n<t;++n)if(!kt(parseFloat(e[n])))throw new Error("Non-finite value.");for(let n=0;n<t;++n)i[n]=parseFloat(e[n]);return i}function Xs(i,e){let t=i.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let n=0;n<t;++n){let r=parseInt(e[n],void 0);if(!$i(r))throw new Error("Non-integer value.")}for(let n=0;n<t;++n)i[n]=parseInt(e[n],void 0);return i}function rn(i){if(typeof i=="object"){if(i===null)return"null";if(Array.isArray(i)){let s="[",o=i.length,l=0;if(l<o)for(s+=rn(i[l]);++l<o;)s+=",",s+=rn(i[l]);return s+="]",s}let e="{",t=di(i).sort(),n=0,r=t.length;if(n<r){let s=t[n];for(e+=se(s),e+=":",e+=rn(i[s]);++n<r;)e+=",",s=t[n],e+=se(s),e+=":",e+=rn(i[s])}return e+="}",e}return se(i)}function FS(i){return i.replace(/['"]/g,e=>e==='"'?"'":'"')}function Pg(i){return FS(se(FS(i)))}const US="_";function Kl(i){if(typeof i=="object"){if(i===null)return"null";let e=i.toJSON;if(typeof e=="function")return Kl(e.call(i));if(Array.isArray(i)){let s="[",o=i.length,l=0;if(l<o)for(s+=Kl(i[l]);++l<o;)s+=US,s+=Kl(i[l]);return s+="]",s}let t="{",n=di(i),r=!0;for(let s of n){let o=i[s];if(o===void 0)continue;let l=Kl(o);l&&(r?r=!1:t+=US,t+=Pg(s),t+=":",t+=l)}return t+="}",t}return typeof i=="string"?Pg(i):se(i)}const nE=/('(?:[^'\\]|(?:\\.))*')/,rE=/("(?:[^"\\]|(?:\\.))*")/,sE=new RegExp(`${nE.source}|${rE.source}`),VN=new RegExp(`${rE.source}|${nE.source}`),aE=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,ON=/^((?:[^"'\\]|(?:\\.))*)'/;function oE(i,e,t,n){if(i.length>=2&&i.charAt(0)===e&&i.charAt(i.length-1)===e){let r=i.substr(1,i.length-2),s=t;for(;r.length>0;){let o=r.match(n);if(o===null){s+=r;break}s+=o[1],o[2]===t?(s+="\\",s+=t):s+=e,r=r.substr(o.index+o[0].length)}return s+=t,s}return i}function lE(i){return oE(i,"'",'"',aE)}function dE(i,e,t){const n=/[&_,]/g;let r,s,o;t==='"'?(r="'",s=aE,o=sE):(r='"',s=ON,o=VN);let l="";for(;i.length>0;){let c=i.match(o),u,f;if(c===null)u=i,i="",f="";else{u=i.substr(0,c.index),i=i.substr(c.index+c[0].length);let g=c[1];g!==void 0?f=oE(g,r,t,s):f=c[2]}l+=u.replace(n,e),l+=f}return l}function cE(i){return dE(i,",",'"')}function BN(i){return dE(i,"_","'")}function Iu(i){return JSON.parse(cE(i))}function uE(i){let e="";for(;i.length>0;){let t=i.match(sE),n,r;if(t===null)n=i,i="",r="";else{n=i.substr(0,t.index),i=i.substr(t.index+t[0].length);let s=t[1];s!==void 0?r=lE(s):r=t[2]}e+=n.replace(/\(/g,"[").replace(/\)/g,"]").replace("True","true").replace("False","false").replace(/,\s*([\}\]])/g,"$1"),e+=r}return e}function _N(i){return JSON.parse(uE(i))}function _n(i,e){if(!Array.isArray(i))throw new Error(`Expected array, but received: ${se(i)}.`);if(e!==void 0&&i.length!==e)throw new Error(`Expected array of length ${e}, but received: ${se(i)}.`);return i}function He(i,e){if(!Array.isArray(i))throw new Error(`Expected array, but received: ${se(i)}.`);return i.map(e)}function st(i,e,t){const n=i.length;if(!Array.isArray(e)||e.length!==n)throw new Error(`Expected length ${n} array, but received: ${se(e)}.`);for(let r=0;r<n;++r)i[r]=t(e[r],r);return i}function ge(i){if(typeof i!="object"||i==null||Array.isArray(i))throw new Error(`Expected JSON object, but received: ${se(i)}.`);return i}function hi(i){let e=parseInt(i,10);if(!$i(e))throw new Error(`Expected integer, but received: ${se(i)}.`);return e}function li(i){let e=hi(i);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function hE(i){const e=hi(i);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function wv(i,e){let t=e.get(i);if(t===void 0)throw new Error(`Expected one of ${se(Te(e.keys()))}, but received: ${se(i)}.`);return t}function Ie(i){if(typeof i!="string")throw new Error(`Expected string, but received: ${se(i)}.`);return i}function Cn(i){if(i!==void 0)return Ie(i)}function FN(i){if(i!==void 0)return hi(i)}function UN(i){if(i!==void 0){if(typeof i=="boolean")return i;if(i==="true")return!0;if(i==="false")return!1;throw new Error(`Expected string or boolean but received: ${se(i)}`)}}function zN(i,e){return i===void 0?e:i}function Y(i,e,t){let n=Object.prototype.hasOwnProperty.call(i,e)?i[e]:void 0;try{return t(n)}catch(r){throw new Error(`Error parsing ${se(e)} property: ${r.message}`)}}function we(i,e,t,n){return Y(i,e,r=>r===void 0?n:t(r))}function Th(i,e){ge(i);let t=new ue;for(let n of di(i))try{t.set(n,e(i[n]))}catch(r){throw new Error(`Error parsing value associated with key ${se(n)}: ${r.message}`)}return t}function Cv(i){if(typeof i!="number"||!kt(i)||i<0||i>1)throw new Error(`Expected floating point number in [0,1], but received: ${se(i)}.`);return i}function Zo(i){if(i==="")return{};if(i.startsWith("{"))return Iu(i);{let e={},t=i.split(/[&;]/);for(let n of t){let r=n.match(/^([^=&;]+)=([^&;]*)$/);if(r===null)throw new Error(`Invalid query string part: ${se(n)}.`);e[r[1]]=decodeURIComponent(r[2])}return e}}function pE(i){if(i===void 0)return"";const e=di(i);return e.length===0?"":e.some(t=>typeof i[t]!="string")?se(i):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(i[t])}`).join("&")}function Ti(i,e){if(typeof i=="string"&&i.match(/^[a-zA-Z]/)!==null&&(i=i.toUpperCase(),e.hasOwnProperty(i)))return e[i];throw new Error(`Invalid enum value: ${se(i)}.`)}function fE(i){return st(Ne(),i,Tt)}function GN(i){return st(Ne(),i,gi)}function WN(i){return st(Ne(),i,li)}function Sn(i){if(!Array.isArray(i))throw new Error(`Expected array, received: ${se(i)}.`);for(let e of i)if(typeof e!="string")throw new Error(`Expected string, received: ${se(e)}.`);return i}function gE(i){if(!Array.isArray(i))throw new Error(`Expected array, received: ${se(i)}.`);for(let e of i)if(!$i(e))throw new Error(`Expected integer, received: ${se(e)}.`);return i}function oa(i){if(typeof i!="boolean")throw new Error(`Expected boolean, received: ${se(i)}`);return i}function va(i){for(const e in i)return i}const $N=Object.freeze(Object.defineProperty({__proto__:null,emptyToUndefined:va,expectArray:_n,jsonToUrlSafe:BN,normalizeStringLiteral:lE,parseArray:He,parseFiniteVec:go,parseFixedLengthArray:st,parseIntVec:Xs,parseQueryStringParameters:Zo,parseXYZ:hd,pythonLiteralParse:_N,pythonLiteralToJSON:uE,stableStringify:rn,unparseQueryStringParameters:pE,urlSafeParse:Iu,urlSafeStringify:Kl,urlSafeStringifyString:Pg,urlSafeToJSON:cE,valueOr:zN,verify3dDimensions:WN,verify3dScale:GN,verify3dVec:fE,verifyBoolean:oa,verifyEnumString:Ti,verifyFiniteFloat:Tt,verifyFiniteNonNegativeFloat:Sv,verifyFinitePositiveFloat:gi,verifyFloat:Jo,verifyFloat01:Cv,verifyInt:hi,verifyIntegerArray:gE,verifyMapKey:wv,verifyNonnegativeInt:hE,verifyObject:ge,verifyObjectAsMap:Th,verifyObjectProperty:Y,verifyOptionalBoolean:UN,verifyOptionalInt:FN,verifyOptionalObjectProperty:we,verifyOptionalString:Cn,verifyPositiveInt:li,verifyString:Ie,verifyStringArray:Sn},Symbol.toStringTag,{value:"Module"}));/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const jN=2**-1074,Ag=new Float64Array(1),cs=new Uint32Array(Ag.buffer);function HN(i,e){if(isNaN(i)||isNaN(e))return NaN;if(i===e)return e;if(i===0)return e<0?-5e-324:jN;Ag[0]=i;const t=Vd===an.LITTLE?0:1,n=1-t;return e>i==i>0?cs[t]===4294967295?(cs[t]=0,cs[n]+=1):cs[t]+=1:cs[t]===0?(cs[t]=4294967295,cs[n]-=1):cs[t]-=1,Ag[0]}var kf=Yt,zS=Math.imul;kf(kf.S+kf.F*lv(function(){return zS(4294967295,5)!=-5||zS.length!=2}),"Math",{imul:function(i,e){var t=65535,n=+i,r=+e,s=t&n,o=t&r;return 0|s*o+((t&n>>>16)*o+s*(t&r>>>16)<<16>>>0)}});var JN=Ct.Math.imul,ZN={default:JN,__esModule:!0};const ir=It(ZN);var GS=Yt;GS(GS.S,"Math",{log2:function(i){return Math.log(i)/Math.LN2}});var qN=Ct.Math.log2,YN={default:qN,__esModule:!0};const Yi=It(YN);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const If=new Uint32Array(2),Gl=4294967296;let Mg=[];for(let i=2;i<=36;++i){let e=Math.floor(32/Yi(i)),t=Math.pow(i,e),n=`^[0-${String.fromCharCode(48+Math.min(9,i-1))}`;i>10&&(n+=`a-${String.fromCharCode(97+i-11)}`,n+=`A-${String.fromCharCode(65+i-11)}`);let r=Math.ceil(64/Yi(i));n+=`]{1,${r}}$`;let s=new RegExp(n);Mg[i]={lowDigits:e,lowBase:t,pattern:s}}function WS(i,e){i>>>=0,e>>>=0;const t=i&65535,n=i>>>16,r=e&65535,s=e>>>16;let o=(t*r>>>16)+n*r,l=o>>>16;o=(o&65535)+t*s,l+=o>>>16;let c=l>>>16;return l=(l&65535)+n*s,c+=l>>>16,((c&65535)<<16|l&65535)>>>0}class re{constructor(e=0,t=0){this.low=e,this.high=t}clone(){return new re(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,n=this.high;if(n===0)return t.toString(e);n*=Gl;var r=Mg[e];let s=r.lowBase,o=r.lowDigits,l=n%s;n=Math.floor(n/s),t+=l,n+=Math.floor(t/s),t=t%s;let c=t.toString(e);return n.toString(e)+"0".repeat(o-c.length)+c}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return re.less(e,t)?e:t}static max(e,t){return re.less(e,t)?t:e}static random(){return crypto.getRandomValues(If),new re(If[0],If[1])}tryParseString(e,t=10){var n=Mg[t];const r=n.lowDigits,s=n.lowBase;if(!n.pattern.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;const o=e.length-r,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t);let u,f;if(s===Gl)u=c,f=l;else{const g=ir(c,s)>>>0;u=WS(c,s)+(ir(Math.floor(c/Gl),s)>>>0),f=l+g,f>=Gl&&(++u,f-=Gl)}return f>>>0!==f||u>>>0!==u?!1:(this.low=f,this.high=u,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${se(e)}.`);return this}static parseString(e,t=10){return new re().parseString(e,t)}valid(){let e=this.low,t=this.high;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,n){const r=t.low,s=t.high;return n===0?(e.low=r,e.high=s):n<32?(e.low=r<<n,e.high=s<<n|r>>>32-n):(e.low=0,e.high=r<<n-32),e}static rshift(e,t,n){const r=t.low,s=t.high;return n===0?(e.low=r,e.high=s):n<32?(e.low=r>>>n|s<<32-n,e.high=s>>>n):(e.low=s>>>n-32,e.high=0),e}static or(e,t,n){return e.low=t.low|n.low,e.high=t.high|n.high,e}static xor(e,t,n){return e.low=t.low^n.low,e.high=t.high^n.high,e}static and(e,t,n){return e.low=t.low&n.low,e.high=t.high&n.high,e}static add(e,t,n){let r=t.low+n.low,s=t.high+n.high;const o=r>>>0;return o!==r&&(s+=1),e.low=o,e.high=s>>>0,e}static addUint32(e,t,n){let r=t.low+n,s=t.high;const o=r>>>0;return o!==r&&(s+=1),e.low=o,e.high=s>>>0,e}static decrement(e,t){let n=t.low,r=t.high;return n===0&&(r-=1),e.low=n-1>>>0,e.high=r>>>0,e}static increment(e,t){let n=t.low,r=t.high;return n===4294967295&&(r+=1),e.low=n+1>>>0,e.high=r>>>0,e}static subtract(e,t,n){let r=t.low-n.low,s=t.high-n.high;const o=r>>>0;return o!==r&&(s-=1),e.low=o,e.high=s>>>0,e}static absDifference(e,t,n){return re.less(t,n)?re.subtract(e,n,t):re.subtract(e,t,n)}static multiplyUint32(e,t,n){const r=t.low,s=t.high;return e.low=ir(r,n)>>>0,e.high=ir(s,n)+WS(r,n)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}}re.ZERO=new re(0,0);re.ONE=new re(1,0);const KN=Object.freeze(Object.defineProperty({__proto__:null,Uint64:re},Symbol.toStringTag,{value:"Module"})),Od={[J.UINT8]:[0,255],[J.INT8]:[-128,127],[J.UINT16]:[0,65535],[J.INT16]:[-32768,32767],[J.UINT32]:[0,4294967295],[J.INT32]:[-2147483648,2147483647],[J.UINT64]:[re.ZERO,new re(4294967295,4294967295)],[J.FLOAT32]:[0,1]};function fn(i,e){if(typeof e=="number"){const t=i[0],n=i[1];return(e-t)/(n-t)}else{const t=i[0],n=i[1];let r;re.compare(e,t)<0?r=-re.subtract(nn,t,e).toNumber():r=re.subtract(nn,e,t).toNumber();let s=re.absDifference(nn,n,t).toNumber();return re.compare(t,n)>0&&(s*=-1),r/s}}function Ar(i,e,t){if(typeof i[0]=="number"){const r=i[0],s=i[1];let o=r*(1-t)+s*t;if(e!==J.FLOAT32){const l=Od[e];o=Math.round(o),o=Math.max(l[0],o),o=Math.min(l[1],o)}return o}else{let r=i[0],s=i[1];if(re.compare(r,s)>0){var n=[s,r];r=n[0],s=n[1],t=1-t}const o=re.subtract(nn,s,r).toNumber(),l=new re;return t<=0?(nn.setFromNumber(o*-t),re.subtract(l,r,re.min(nn,r))):t>=1?(nn.setFromNumber(o*(t-1)),re.add(l,s,nn),re.less(l,s)&&(l.low=l.high=4294967295)):(nn.setFromNumber(o*t),re.add(l,r,nn),re.less(l,r)&&(l.low=l.high=4294967295)),l}}function pd(i,e){return typeof e=="number"?Math.min(Math.max(i[0],e),i[1]):re.min(re.max(i[0],e),i[1])}function id(i,e){return[pd(i,e[0]),pd(i,e[1])]}function mE(i){if(xn(i[0],i[1])<=0)return i;throw new Error(`Invalid interval: [${i[0]}, ${i[1]}]`)}function XN(i){return xn(i[0],i[1])<=0?i:[i[1],i[0]]}function xn(i,e){return typeof i=="number"?i-e:re.compare(i,e)}const nn=new re,QN=new re;function eV(i,e){return typeof e=="number"?Math.abs(e-i[0])<Math.abs(e-i[1])?0:1:re.less(re.absDifference(nn,i[0],e),re.absDifference(QN,i[1],e))?0:1}function Bd(i,e){let t;switch(typeof e!="string"?t=""+e:t=e,i){case J.UINT64:return re.parseString(t);case J.FLOAT32:{const n=parseFloat(t);if(!kt(n))throw new Error(`Invalid float32 value: ${se(t)}`);return n}default:{const n=parseInt(t),r=Od[i];if(!$i(n)||n<r[0]||n>r[1])throw new Error(`Invalid ${J[i].toLowerCase()} value: ${se(t)}`);return n}}}function Tu(i,e){return st(new Array(2),i,t=>Bd(e,t))}function Mr(i,e,t){return i===J.UINT64?re.equal(e[0],t[0])&&re.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function $S(i,e,t=Od[e]){if(!Mr(e,i,t))return e===J.UINT64?[i[0].toString(),i[1].toString()]:i}function Du(i,e,t){switch(i){case J.FLOAT32:return HN(e,t*(1/0));case J.UINT64:const n=e;return t===-1?n.low===0&&n.high===0?n:re.decrement(new re,n):n.low===4294967295&&n.high===4294967295?n:re.increment(new re,n);default:{const r=Od[i];return Math.max(r[0],Math.min(r[1],e+t))}}}function tV(i,e){switch(i){case J.FLOAT32:return 0;case J.UINT64:return .5/re.absDifference(nn,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function Pu(i,e){switch(i){case J.FLOAT32:return 1;case J.UINT64:{const t=re.absDifference(nn,e[0],e[1]).toNumber();return t/(t+1)}default:{const t=Math.abs(e[0]-e[1]);return t/(t+1)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Au(i=128){const e=Math.ceil(i/32),t=new Uint32Array(e);crypto.getRandomValues(t);let n="";for(let r=0;r<e;++r)n+=("00000000"+t[r].toString(16)).slice(-8);return n}function iV(i){let e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);const t=65536;for(let n=0,r=e.length;n<r;n+=t)crypto.getRandomValues(e.subarray(n,Math.min(r,n+t)));return i}function jS(){const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]}class cu extends K{constructor(e){super(),this.id=e,this.changed=new xe}addRef(){return super.addRef()}dispose(){super.dispose()}}var Me;(function(i){i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID",i[i.SPHERE=4]="SPHERE"})(Me||(Me={}));const Br=[Me.POINT,Me.LINE,Me.AXIS_ALIGNED_BOUNDING_BOX,Me.ELLIPSOID,Me.SPHERE],xs={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, true);dv.setUint8(${e} + 2, ${i} >>> 16);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(i){return Lu(ma(i))},serializeJson(i){return Gi(ia(i))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, true);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, true);`},deserializeJson(i){return Lu(bv(i))},serializeJson(i){return Gi(Ih(i))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setFloat32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(i){return Jo(i)},serializeJson(i){return i}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(i){return hi(i)},serializeJson(i){return i}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setInt32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(i){return hi(i)},serializeJson(i){return i}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(i){return hi(i)},serializeJson(i){return i}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setInt16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(i){return hi(i)},serializeJson(i){return i}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(i,e){return`dv.setUint8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getUint8(${e});`},deserializeJson(i){return hi(i)},serializeJson(i){return i}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(i,e){return`dv.setInt8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getInt8(${e});`},deserializeJson(i){return hi(i)},serializeJson(i){return i}}},nV=255;function vE(i,e,t){let n=0;const r=t.length,s=new Array(r),o=[];for(let v=0;v<r;++v)s[v]=v;const l=v=>xs[t[v].type].alignment(i);s.sort((v,y)=>l(y)-l(v));let c=0;const u=new Array(r);let f=e;const g=()=>{f+=(4-f%4)%4,n+=f,o[c]=f,f=0,++c};for(let v=0;v<r;++v){const y=s[v],C=t[y],w=xs[C.type],S=w.serializedBytes(i),L=w.alignment(i),I=(L-f%L)%L,M=f+I+S;M+(4-M%4)%4<=nV?f+=I:g(),u[y]={offset:f,group:c},f+=S}return g(),{serializedBytes:n,offsets:u,propertyGroupBytes:o}}class yE{constructor(e,t,n){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=n,n.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}var r=vE(e,t,n);const s=r.serializedBytes,o=r.offsets,l=r.propertyGroupBytes;this.propertyGroupBytes=l;let c="let groupOffset0 = offset;";for(let y=1;y<l.length;++y)c+=`let groupOffset${y} = groupOffset${y-1} + ${l[y-1]}*annotationCount;`;for(let y=0;y<l.length;++y)c+=`groupOffset${y} += ${l[y]}*annotationIndex;`;let u=c,f=c;const g=n.length;for(let y=0;y<g;++y){var v=o[y];const C=v.group,w=v.offset,S=n[y],L=xs[S.type],I=`properties[${y}]`,M=`groupOffset${C} + ${w}`;u+=L.serializeCode(I,M,e),f+=L.deserializeCode(I,M,e)}this.serializedBytes=s,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",u),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",f)}}function xv(i,e){const t=[];for(const n of Br){const r=Ui[n];t[n]=new yE(i,r.serializedBytes(i),e)}return t}function bE(i,e){const t=i.type==="float32"?e.toPrecision(6):e.toString(),n=i.enumValues,r=i.enumLabels;if(n!==void 0){const s=n.indexOf(e);if(s!==-1)return`${r[s]} (${t})`}return t}function rV(i,e){switch(i.type){case"rgb":return Gi(ia(e));case"rgba":return Gi(Ih(e));default:return bE(i,e)}}function sV(i){const e=Ie(i);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${se(i)}`);return e}function aV(i){if(Ie(i),!Object.prototype.hasOwnProperty.call(xs,i))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return i}function oV(i){const e=new je;for(const t of i){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function lV(i){ge(i);const e=Y(i,"id",sV),t=Y(i,"type",aV),n=we(i,"description",Ie);let r=we(i,"default",l=>xs[t].deserializeJson(l),0),s,o;switch(t){case"rgb":case"rgba":break;default:{const l=J[t.toUpperCase()];s=we(i,"enum_values",c=>He(c,u=>Bd(l,u))),s!==void 0&&(o=Y(i,"enum_labels",c=>st(new Array(s.length),c,Ie)))}}return{type:t,identifier:e,description:n,default:r,enumValues:s,enumLabels:o}}function dV(i){const e=i.default;return{id:i.identifier,description:i.description,type:i.type,default:e===0?void 0:xs[i.type].serializeJson(e)}}function cV(i){if(!(i===void 0||i.length===0))return i.map(dV)}function SE(i){if(i===void 0)return[];const e=He(i,lV);return oV(e),e}function Rg(i,e,t,n,r){for(let s=0;s<n;++s)i.setFloat32(e,r[s],t),e+=4;return e}function Wc(i,e,t,n,r,s){return e=Rg(i,e,t,n,r),e=Rg(i,e,t,n,s),e}function Ng(i,e,t,n,r){for(let s=0;s<n;++s)r[s]=i.getFloat32(e,t),e+=4;return e}function $c(i,e,t,n,r,s){return e=Ng(i,e,t,n,r),e=Ng(i,e,t,n,s),e}const Ui={[Me.LINE]:{icon:"ꕹ",description:"Line",toJSON(i){return{pointA:Te(i.pointA),pointB:Te(i.pointB)}},restoreState(i,e,t){i.pointA=Y(e,"pointA",n=>st(new Float32Array(t),n,Tt)),i.pointB=Y(e,"pointB",n=>st(new Float32Array(t),n,Tt))},serializedBytes(i){return 2*4*i},serialize(i,e,t,n,r){Wc(i,e,t,n,r.pointA,r.pointB)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),o=new Float32Array(n);return $c(i,e,t,n,s,o),{type:Me.LINE,pointA:s,pointB:o,id:r,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},[Me.SPHERE]:{icon:"⊖",description:"Sphere",toJSON(i){return{pointA:Te(i.pointA),pointB:Te(i.pointB)}},restoreState(i,e,t){i.pointA=Y(e,"pointA",n=>st(new Float32Array(t),n,Tt)),i.pointB=Y(e,"pointB",n=>st(new Float32Array(t),n,Tt))},serializedBytes(i){return 2*4*i},serialize(i,e,t,n,r){Wc(i,e,t,n,r.pointA,r.pointB)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),o=new Float32Array(n);return $c(i,e,t,n,s,o),{type:Me.SPHERE,pointA:s,pointB:o,id:r,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},[Me.POINT]:{icon:"⚬",description:"Point",toJSON:i=>({point:Te(i.point)}),restoreState:(i,e,t)=>{i.point=Y(e,"point",n=>st(new Float32Array(t),n,Tt))},serializedBytes:i=>i*4,serialize:(i,e,t,n,r)=>{Rg(i,e,t,n,r.point)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n);return Ng(i,e,t,n,s),{type:Me.POINT,point:s,id:r,properties:[]}},visitGeometry(i,e){e(i.point,!1)}},[Me.AXIS_ALIGNED_BOUNDING_BOX]:{icon:"❑",description:"Bounding Box",toJSON:i=>({pointA:Te(i.pointA),pointB:Te(i.pointB)}),restoreState:(i,e,t)=>{i.pointA=Y(e,"pointA",n=>st(new Float32Array(t),n,Tt)),i.pointB=Y(e,"pointB",n=>st(new Float32Array(t),n,Tt))},serializedBytes:i=>2*4*i,serialize(i,e,t,n,r){Wc(i,e,t,n,r.pointA,r.pointB)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),o=new Float32Array(n);return $c(i,e,t,n,s,o),{type:Me.AXIS_ALIGNED_BOUNDING_BOX,pointA:s,pointB:o,id:r,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},[Me.ELLIPSOID]:{icon:"◎",description:"Ellipsoid",toJSON:i=>({center:Te(i.center),radii:Te(i.radii)}),restoreState:(i,e,t)=>{i.center=Y(e,"center",n=>st(new Float32Array(t),n,Tt)),i.radii=Y(e,"radii",n=>st(new Float32Array(t),n,Sv))},serializedBytes:i=>2*4*i,serialize(i,e,t,n,r){Wc(i,e,t,n,r.center,r.radii)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),o=new Float32Array(n);return $c(i,e,t,n,s,o),{type:Me.ELLIPSOID,center:s,radii:o,id:r,properties:[]}},visitGeometry(i,e){e(i.center,!1),e(i.radii,!0)}}};function Vg(i,e){const t=Ui[i.type].toJSON(i,e.rank);t.type=Me[i.type].toLowerCase(),t.id=i.id,t.description=i.description||void 0;const n=i.relatedSegments;if(n!==void 0&&n.some(r=>r.length!==0)&&(t.segments=n.map(r=>r.map(s=>s.toString()))),e.properties.length!==0){const r=e.properties;t.props=i.properties.map((s,o)=>xs[r[o].type].serializeJson(s))}return t}function uV(i,e,t=!1){ge(i);const n=Y(i,"type",c=>Ti(c,Me)),r=Y(i,"id",t?Cn:Ie)||Ev(),s=Y(i,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);const u=_n(c);return u.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(u[0])?[He(u,f=>re.parseString(f))]:He(_n(c,e.relationships.length),f=>He(f,g=>re.parseString(g)))}),o=Y(i,"props",c=>{const u=e.properties;return c===void 0?u.map(f=>f.default):He(_n(c,e.properties.length),(f,g)=>xs[u[g].type].deserializeJson(f))}),l={id:r,description:Y(i,"description",Cn),relatedSegments:s,properties:o,type:n};return Ui[n].restoreState(l,i,e.rank),l}class xo extends K{constructor(e,t=[],n=[]){super(),this.relationships=t,this.properties=n,this.annotationMap=new ue,this.changed=new xe,this.readonly=!1,this.childAdded=new at,this.childUpdated=new at,this.childDeleted=new at,this.childRefreshed=new xe,this.pending=new je,this.references=new ue,this.rank_=e,this.annotationPropertySerializers=xv(e,n)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=Ev();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${se(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();const t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Wi](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new cu(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();const e=[],t=this.pending;for(const n of this)t.has(n.id)||e.push(Vg(n,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();const t=this.annotationMap;t.clear(),this.pending.clear(),e!==void 0&&He(e,n=>{const r=uV(n,this);t.set(r.id,r)});for(const n of this.references.values()){const r=n.id,s=t.get(r);n.value=s||null,n.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class hV extends xo{constructor(e,t,n){super(e.value.sourceRank,n,t),this.watchableTransform=e,this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){const e=this.watchableTransform.value,t=this.curCoordinateTransform;if(e===t)return;this.curCoordinateTransform=e;const n=e.sourceRank,r=t.sourceRank;if(r===n&&(t.inputSpace===e.inputSpace||_e(t.inputSpace.ids.slice(0,n),e.inputSpace.ids.slice(0,n))))return;const s=e.inputSpace.ids,o=t.inputSpace.ids,l=[];for(let u=0;u<n;++u){let f=o.indexOf(s[u]);f>=r&&(f=-1),l.push(f)}const c=u=>{const f=new Float32Array(n);for(let g=0;g<n;++g){const v=l[g];f[g]=v===-1?0:u[g]}return f};for(const u of this.annotationMap.values())switch(u.type){case Me.POINT:u.point=c(u.point);break;case Me.LINE:case Me.SPHERE:case Me.AXIS_ALIGNED_BOUNDING_BOX:u.pointA=c(u.pointA),u.pointB=c(u.pointB);break;case Me.ELLIPSOID:u.center=c(u.center),u.radii=c(u.radii);break}this.rank_!==n&&(this.rank_=n,this.annotationPropertySerializers=xv(this.rank_,this.properties)),this.changed.dispatch()}}const pV="Data Bounds";function Ev(){return Au(160)}function fV(i){return{type:Me.AXIS_ALIGNED_BOUNDING_BOX,id:"data-bounds",description:pV,pointA:new Float32Array(i.lowerBounds),pointB:new Float32Array(i.upperBounds),properties:[]}}function _d(i){const e=new xo(i.lowerBounds.length);return e.readonly=!0,e.add(fV(i)),e}function gV(i,e){let t=0;const n=[];for(const u of Br){const f=e[u].serializedBytes;n[u]=t;const g=i[u].length;t+=f*g}const r=[],s=[],o=new ArrayBuffer(t),l=new DataView(o),c=Vd===an.LITTLE;for(const u of Br){const f=e[u],g=f.rank,v=f.serialize,y=i[u];r[u]=y.map(L=>L.id),s[u]=new ue(y.map((L,I)=>[L.id,I]));const C=Ui[u].serialize,w=n[u],S=f.propertyGroupBytes[0];for(let L=0,I=y.length;L<I;++L){const M=y[L];C(l,w+L*S,c,g,M),v(l,w,L,I,c,M.properties)}}return{data:new Uint8Array(o),typeToIds:r,typeToOffset:n,typeToIdMaps:s}}class mV{constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return gV(this.annotations,this.propertySerializers)}}function Lv(i){if(i==null)return i;const e=i.relatedSegments;if(e!==void 0)for(let t=0,n=e.length;t<n;++t){const r=e[t];r!==void 0&&(e[t]=r.map(s=>new re(s.low,s.high)))}return i}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Dh(i,e,t,n,r,s,o,l,c){for(let u=0;u<o;++u)for(let f=0;f<c;++f){let g=0;for(let v=0;v<l;++v)g+=t[u+n*v]*r[v+s*f];i[u+e*f]=g}return i}function vV(i,e,t){for(let n=0;n<t;++n){const r=e*n;i.fill(0,r,r+t),i[r+n]=1}return i}function Ts(i,e,t=e){return vV(new i(e*t),e,Math.min(e,t))}function HS(i,e,t=!0){const n=e.length,r=t?n+1:n,s=new i(r*(n+1));t&&(s[s.length-1]=1);for(let o=0;o<n;++o)s[(r+1)*o]=e[o];return s}function yV(i,e,t){for(let n=0;n<t;++n)for(let r=0;r<t;++r)if(i[n*e+r]!=(n===r?1:0))return!1;return!0}function kv(i,e,t,n,r,s){for(let o=0;o<s;++o){const l=o*n,c=o*e;for(let u=0;u<r;++u)i[c+u]=t[l+u]}return i}function Iv(i,e,t,n){kv(i,e+1,t,n+1,n,n);for(let r=0;r<n;++r)i[(e+1)*e+r]=t[(n+1)*n+r];i[i.length-1]=1;for(let r=n;r<e;++r)i[(e+1)*r+r]=1;return i}let hn;function bV(i,e,t){let n=1;(hn===void 0||hn.length<t)&&(hn=new Uint32Array(t));for(let r=0;r<t;++r)hn[r]=r;for(let r=0;r<t;++r){const s=e*r;let o=r;{let u=Math.abs(i[s+r]);for(let f=r+1;f<t;++f){const g=Math.abs(i[s+f]);g>u&&(u=g,o=f)}}if(r!==o){n*=-1;for(let u=0;u<t;++u){const f=e*u,g=i[f+r];i[f+r]=i[f+o],i[f+o]=g}{const u=hn[r];hn[r]=hn[o],hn[o]=u}}const l=i[s+r],c=1/l;n*=l;for(let u=0;u<t;++u)i[e*u+r]*=c;i[s+r]=c;for(let u=0;u<t;++u){if(u===r)continue;const f=-i[e*r+u];for(let g=0;g<t;++g){const v=e*g;i[v+u]+=f*i[v+r]}i[e*r+u]=f*c}}for(let r=0;r<t;++r){let s=hn[r];for(;s!==r;){const o=e*r,l=e*s;for(let u=0;u<t;++u){const f=o+u,g=l+u,v=i[f];i[f]=i[g],i[g]=v}const c=hn[r]=hn[s];hn[s]=s,s=c}}return n}function Tv(i,e,t,n,r){return kv(i,e,t,n,r,r),bV(i,e,r)}function SV(i,e,t,n,r,s){for(let o=0;o<s;++o){const l=e*o,c=n*o;for(let u=0;u<r;++u)if(i[l+u]!==t[c+u])return!1}return!0}function Nr(i,e,t,n,r){for(let s=0;s<r;++s){let o=e[t*r+s];for(let l=0;l<r;++l)o+=e[t*l+s]*n[l];i[s]=o}return i}function wE(i,e,t,n,r){for(let s=0;s<r;++s){let o=0;for(let l=0;l<r;++l)o+=e[t*l+s]*n[l];i[s]=o}return i}var JS=Yt;JS(JS.S,"Math",{log10:function(i){return Math.log(i)*Math.LOG10E}});var wV=Ct.Math.log10,CV={default:wV,__esModule:!0};const CE=It(CV),uu=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"m",exponent:-3},{prefix:"µ",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],xV=[{prefix:"c",exponent:-2},{prefix:"u",exponent:-6},...uu],Fd=new ue;Fd.set("",{unit:"",exponent:0});const EV=new ue;for(const i of xV){const e=i.prefix,t=i.exponent;EV.set(t,e);for(const n of["m","s","Hz","rad/s"])Fd.set(`${e}${n}`,{unit:n,exponent:t})}function xE(i){const e=CE(i),t=uu.length,n=h2(0,t,r=>uu[r].exponent<=e);return uu[Math.min(n,t-1)]}function EE(i,e,t={}){var n=t.precision;const r=n===void 0?6:n;var s=t.elide1;const o=s===void 0?!0:s;let l=i,c="";if(e!==""){const f=xE(i);c=f.prefix,l=Dv(i,-f.exponent)}if(o&&l===1)return{scale:"",unit:e,prefix:c};let u;if(r!=0){l<1||l>=1e3?u=l.toPrecision(r):u=l.toFixed(r);const f=u.indexOf("e");let g,v;f!==-1?(g=u.substring(0,f),v=u.substring(f)):(g=u,v="");const y=g.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);y!==null&&(g=g.substring(0,g.length-y[1].length),g.endsWith(".")&&(g=g.substring(0,g.length-1)),u=g+v)}else u=l.toString();return{scale:u,unit:e,prefix:c}}function la(i,e,t){var n=EE(i,e,t);const r=n.scale,s=n.unit,o=n.prefix;return`${r}${o}${s}`}function fd(i){if(i==="")return{scale:1,unit:""};const e=i.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;const t=e[1];let n=t===void 0?1:Number(t);if(tr(n))return;let r="";if(e[2]!==void 0){const s=Fd.get(e[2]);if(s===void 0)return;r=s.unit,s.exponent>0?n*=10**s.exponent:n/=10**-s.exponent}if(!(n<=0||!kt(n)))return{scale:n,unit:r}}function ZS(i){const e=Fd.get(i);if(e===void 0)throw new Error(`Invalid unit: ${se(i)}`);return e}function Dv(i,e){return e>=0?i*10**e:i/10**-e}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function LE(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=e[r]+t[r];return i}function Og(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=e[r]-t[r];return i}function LV(i,e,t,n){const r=i.length;for(let s=0;s<r;++s)i[s]=e[s]+t[s]*n;return i}function kV(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=e[r]*t;return i}function Pv(i){let e=1;for(let t=0,n=i.length;t<n;++t)e*=i[t];return e}function IV(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=Math.min(e[r],t[r]);return i}const Eo=new Float32Array(0),kE=new Float64Array(0);let TV=0;function lo(){return++TV}function DV(i,e){return _e(i.lowerBounds,e.lowerBounds)&&_e(i.upperBounds,e.upperBounds)}function PV(i,e){return i===void 0?e===void 0:e===void 0?!1:i.explicit===e.explicit&&_e(i.coordinates,e.coordinates)&&_e(i.labels,e.labels)}function AV(i,e){const t=new ue;for(let n=0,r=i.length;n<r;++n)t.set(i[n],e[n]);return i=Te(t.keys()),i.sort((n,r)=>n-r),e=Te(i,n=>t.get(n)),{coordinates:i,labels:e}}function IE(i){if(i.length===1)return i[0];const e=new ue;let t=!1;for(const s of i){s.explicit&&(t=!0);const o=s.coordinates,l=s.labels;for(let c=0,u=o.length;c<u;++c)e.set(o[c],l[c])}const n=Te(e.keys());n.sort((s,o)=>s-o);const r=Te(n,s=>e.get(s));return{explicit:t,coordinates:n,labels:r}}function qS(i){if(i=i.filter(e=>e!==void 0),i.length!==0)return IE(i)}function MV(i,e){return _e(i.transform,e.transform)&&DV(i.box,e.box)}function Mu(i,e){return i.valid===e.valid&&i.rank===e.rank&&_e(i.names,e.names)&&_e(i.ids,e.ids)&&_e(i.timestamps,e.timestamps)&&_e(i.units,e.units)&&_e(i.scales,e.scales)&&wg(i.boundingBoxes,e.boundingBoxes,MV)&&wg(i.coordinateArrays,e.coordinateArrays,PV)}function mt(i){const e=i.names,t=i.units,n=i.scales;var r=i.valid;const s=r===void 0?!0:r;var o=i.rank;const l=o===void 0?e.length:o;var c=i.timestamps;const u=c===void 0?e.map(()=>Number.NEGATIVE_INFINITY):c;var f=i.ids;const g=f===void 0?e.map((I,M)=>-M):f;var v=i.boundingBoxes;const y=v===void 0?[]:v;var C=i.coordinateArrays;const w=C===void 0?new Array(l):C;var S=i.bounds;const L=S===void 0?VV(y,l):S;return{valid:s,rank:l,names:e,timestamps:u,ids:g,units:t,scales:n,boundingBoxes:y,bounds:L,coordinateArrays:w}}const Ur=mt({valid:!1,names:[],units:[],scales:kE,boundingBoxes:[]}),Lo=mt({valid:!0,names:[],units:[],scales:kE,boundingBoxes:[]});function RV(i){var e=_n(i,2),t=oe(e,2);const n=t[0],r=t[1],s=gi(n),o=Ie(r),l=Fd.get(o);if(l===void 0)throw new Error(`Invalid unit: ${se(o)}`);return{unit:l.unit,scale:Dv(s,l.exponent)}}function Ru(i,e=!1){if(i===void 0)return Ur;ge(i);const t=Nv(di(i),e),n=t.length,r=new Array(n),s=new Float64Array(n),o=new Array(n);for(let l=0;l<n;++l)Y(i,t[l],c=>{if(Array.isArray(c)){var u=RV(c);const f=u.unit,g=u.scale;r[l]=f,s[l]=g}else{ge(c);let f=Y(c,"coordinates",gE),g=Y(c,"labels",Sn),v=f.length;if(v!==g.length)throw new Error(`Length of coordinates array (${v}) does not match length of labels array (${g.length})`);r[l]="",s[l]=1,o[l]=j({explicit:!0},AV(f,g))}});return mt({valid:!1,names:t,units:r,scales:s,coordinateArrays:o})}function Bg(i){const e=i.rank;if(e===0)return;const t=i.names,n=i.units,r=i.scales,s=i.coordinateArrays,o={};for(let l=0;l<e;++l){const c=t[l],u=s[l];u!=null&&u.explicit?o[c]={coordinates:Te(u.coordinates),labels:u.labels}:o[c]=[r[l],n[l]]}return o}class Av extends gt{constructor(){super(Ur)}toJSON(){return Bg(this.value)}reset(){this.value=Ur}restoreState(e){this.value=Ru(e)}}function TE(i,e){let t=(i+e)/2;return kt(t)||(t=Math.min(Math.max(0,i),e)),t}function NV(i,e){const t=e.lowerBounds,n=e.upperBounds,r=i.length;for(let s=0;s<r;++s)i[s]=TE(t[s],n[s]);return i}function ya(i){const e=i.lowerBounds.length;return{box:i,transform:Ts(Float64Array,e,e+1)}}function DE(i,e,t){var n=i.box;const r=n.lowerBounds,s=n.upperBounds,o=i.transform,l=r.length,c=t,u=o[c*l+e];let f=u,g=u,v=!1;for(let y=0;y<l;++y){let C=o[c*y+e];if(C===0)continue;const w=C*r[y],S=C*s[y];f+=Math.min(w,S),g+=Math.max(w,S),v=!0}if(v)return{lower:f,upper:g}}function VV(i,e){const t=new Float64Array(e),n=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),n.fill(Number.POSITIVE_INFINITY);for(const r of i)for(let s=0;s<e;++s){const o=DE(r,s,e);if(o===void 0)continue;const l=o.lower,c=o.upper;t[s]=t[s]===Number.NEGATIVE_INFINITY?l:Math.min(t[s],l),n[s]=n[s]===Number.POSITIVE_INFINITY?c:Math.max(n[s],c)}return{lowerBounds:t,upperBounds:n}}function OV(i,e,t){const n=i.transform,r=i.box,s=t.length,o=r.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<s;++c){const u=t[c];if(u!==-1)for(let f=0;f<=o;++f)l[f*e+u]=n[f*s+c]}return{transform:l,box:r}}function PE(i,e){const t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},n=new Float64Array(2*i);return n[e]=1,{transform:n,box:t}}function AE(i,e,t){if(e===t)return i;const n=i.box,r=n.lowerBounds.length,s=new Float64Array((r+1)*t);return kv(s,t,i.transform,e,e,r+1),{box:n,transform:s}}function BV(i,e){const t=i.rank,n=i.sourceRank;if(t!==e.rank||n!==e.sourceRank)return!1;const r=i.inputSpace,s=e.inputSpace;return!_e(s.scales,r.scales)||!_e(s.units,r.units)||!_e(e.outputSpace.names,i.outputSpace.names)?!1:NE(i.transform,t,i.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function Xi(i){return{rank:i.rank,sourceRank:i.rank,inputSpace:i,outputSpace:i,transform:Ts(Float64Array,i.rank+1)}}function _V(i,e,t,n){let r=i.transform,s=i.box;const o=i.box.lowerBounds.length,l=n.length,c=new Float64Array((o+1)*l);for(let u=0;u<l;++u){const f=n[u];for(let v=0;v<o;++v){let y=0;for(let C=0;C<l;++C){const w=t[C];y+=e[(l+1)*C+u]*r[l*v+C]*(w/f)}c[l*v+u]=y}let g=e[(l+1)*l+u];for(let v=0;v<l;++v){const y=t[v];g+=e[(l+1)*v+u]*r[l*o+v]*(y/f)}c[o*l+u]=g}return{transform:c,box:s}}function ME(i,e,t){return i.boundingBoxes.map(n=>_V(n,e,i.scales,t))}function _g(i,e,t){const n=mt({valid:i.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:ME(i,e,t.scales),coordinateArrays:t.coordinateArrays});return Mu(n,t)?t:n}function Mv(i,e=!1){if(e){const t=Number(i);if($i(t)&&t>=0)return!0}return i.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function Ph(i,e=!1){const t=new je;for(const n of i){if(!Mv(n,e)||t.has(n))return!1;t.add(n)}return!0}function Rv(i){const e=i.length,t=new Array(e);t.fill(!0);for(let n=0;n<e;++n){const r=i[n];if(!Mv(r)){t[n]=!1;continue}const s=i.indexOf(r,n+1);s!==-1&&(t[n]=!1,t[s]=!1)}return t}function nd(i){return i.endsWith("'")}function RE(i){return i.endsWith("'")||i.endsWith("^")}function FV(i){return i.endsWith("^")}function UV(i){return!RE(i)}function zV(i,e,t){const n=new Float64Array(i),r=e.length,s=(r+1)*r;for(let o=0;o<r;++o)n[s+o]*=e[o]/t[o];return n}function NE(i,e,t,n,r,s){if(!SV(i,e+1,n,r+1,e,e))return!1;for(let o=0;o<e;++o){const l=i[(e+1)*e+o],c=n[(r+1)*r+o];if(l*(t[o]/s[o])!==c)return!1}for(let o=e;o<r;++o)if(n[(r+1)*r+o]!==0)return!1;for(let o=e;o<r;++o){for(let l=0;l<e;++l)if(n[(r+1)*l+o]!==0)return!1;for(let l=0;l<r;++l){const c=n[(r+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function GV(i,e){if(!e.includes(i))return i;var t=i.match(/^([^']*)('?)$/),n=oe(t,3);const r=n[1],s=n[2];for(let o=0;;++o){const l=`${r}${o}${s}`;if(!e.includes(l))return l}}function WV(i,e){const t=i.inputSpace,n=i.transform,r=t.ids,s=t.rank,o=e.rank,l=e.names,c=e.units,u=e.scales,f=new Array(s);f.fill(!0);const g=[],v=e.ids.map((W,F)=>{const le=r.indexOf(W);return le!==-1?f[le]=!1:g.push(F),le}),y=i.outputSpace,C=y.names,w=y.units,S=y.scales,L=y.ids,I=y.timestamps,M=y.coordinateArrays,R=f,D=[],T=[],A=new Float64Array(o),V=[],O=[],_=new Array(o);let H=0;const U=new Float64Array((o+1)**2);U[U.length-1]=1;for(let W=0;W<s;++W)if(!R[W]){D[H]=C[W],V[H]=L[W],T[H]=w[W],A[H]=S[W],O[H]=I[W],_[H]=M[W];for(let F=0;F<o;++F){const le=v[F];le!==-1&&(U[F*(o+1)+H]=n[le*(s+1)+W])}U[o*(o+1)+H]=n[s*(s+1)+W],++H}for(const W of g)V[H]=lo(),D[H]=GV(l[W],D),A[H]=u[W],T[H]=c[W],U[W*(o+1)+H]=1,++H;const B=mt({valid:e.valid,rank:o,names:D,ids:V,timestamps:O,units:T,scales:A,boundingBoxes:ME(e,U,A),coordinateArrays:_});return{rank:o,sourceRank:i.sourceRank,inputSpace:e,outputSpace:B,transform:U}}function YS(i){const e=_g(i.inputSpace,i.transform,i.outputSpace);return e===i.outputSpace?i:{rank:i.rank,sourceRank:i.sourceRank,inputSpace:i.inputSpace,transform:i.transform,outputSpace:e}}class KS{constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new xe,this.inputSpaceChanged=new xe,this.defaultTransform=YS(e);const n=this;this.outputSpace={changed:n.changed,get value(){return n.value.outputSpace},set value(r){const s=n.value;if(Mu(s.outputSpace,r)||s.rank!==r.rank)return;const o=zV(s.transform,s.outputSpace.scales,r.scales);n.value_={sourceRank:s.sourceRank,rank:s.rank,inputSpace:s.inputSpace,outputSpace:_g(s.inputSpace,o,r),transform:o},n.changed.dispatch()}},this.inputSpace={changed:n.inputSpaceChanged,get value(){return n.value.inputSpace},set value(r){const s=n.value;Mu(s.inputSpace,r)||(n.value_=WV(s,r),n.inputSpaceChanged.dispatch(),n.changed.dispatch())}}}set value(e){const t=this.value;e!==t&&(this.value_=YS(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let e=this.value_;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){const e=this.value,t=e.rank,n=e.transform,r=e.inputSpace,s=e.outputSpace,o=e.sourceRank,l=this.defaultTransform,c=this.mutableSourceRank,u=l.inputSpace,f=l.rank,g=l.transform,v=l.outputSpace,y=r.units,C=r.scales,w=o===t&&_e(C,c?s.scales:u.scales)&&_e(y,c?s.units:u.units),S=NE(g,f,v.scales,n,t,s.scales),L=_e(v.names,s.names);if(!(S&&L&&w))return{sourceRank:o,transform:S?void 0:n,outputSpace:e.outputSpace,inputSpace:w?void 0:r}}set transform(e){const t=this.value,n=t.inputSpace;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:n,transform:e,outputSpace:_g(n,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){const U=e.inputSpace||e.outputSpace,B=U.rank,W=mt({rank:B,names:U.names.map((F,le)=>`${le}`),units:U.units,scales:U.scales,coordinateArrays:U.coordinateArrays});this.value={rank:B,transform:e.transform||Ts(Float64Array,B+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:W};return}var t=this.defaultTransform;const n=t.inputSpace,r=t.sourceRank,s=t.outputSpace,o=t.transform,l=t.rank,c=e.inputSpace,u=e.sourceRank,f=e.outputSpace,g=e.transform,v=e.outputSpace.rank,y=n.names,C=c!==void 0?c.names:y,w=new Array(r);for(let U=0;U<r;++U){let B=C.indexOf(y[U]);B>=u&&(B=-1),w[U]=B}const S=v-u+r;for(let U=u;U<v;++U)w[r+U-u]=U;const L=new Float64Array(S),I=new Array(S),M=[];for(let U=0;U<r;++U){const B=w[U];B===-1||c===void 0?(L[U]=n.scales[U],M[U]=n.units[U],I[U]=n.coordinateArrays[U]):(L[U]=c.scales[B],M[U]=c.units[B],I[U]=qS([n.coordinateArrays[U],c.coordinateArrays[B]]))}const R=c||f,D=y.slice(0,r),T=s.names.slice(0,r),A=s.coordinateArrays.slice(0,r),V=new Float64Array(S),O=[];for(let U=0;U<S;++U){const B=w[U];B===-1?(V[U]=s.scales[U],O[U]=s.units[U],A[U]=s.coordinateArrays[U]):(T[U]=f.names[B],O[U]=f.units[B],V[U]=f.scales[B],A[U]=f.coordinateArrays[B])}if(!Ph(T)){this.reset();return}for(let U=r;U<S;++U){const B=U-r+u;L[U]=R.scales[B],M[U]=R.units[B],D[U]=`${U}`}const _=new Float64Array((S+1)**2);_[_.length-1]=1;for(let U=0;U<S;++U){const B=w[U];let W;B===-1||g===void 0?U>=r?W=0:W=o[l*(l+1)+U]*(s.scales[U]/V[U]):W=g[v*(v+1)+B],_[S*(S+1)+U]=W;for(let F=0;F<S;++F){const le=w[F];let de;B===-1!=(le===-1)?de=0:B===-1||g===void 0?B>=r||le>=r?de=B===le?1:0:de=o[F*(l+1)+U]:de=g[le*(v+1)+B],_[F*(S+1)+U]=de}}const H=n.boundingBoxes.map(U=>AE(U,l,S));for(let U=r;U<S;++U)H.push(PE(S,U));for(let U=0;U<S;++U){if(_[S*(S+1)+U]!==0)continue;let B;for(let F=0;F<S;++F){const le=_[F*(S+1)+U];if(le!==0)if(le===1)if(B===void 0)B=F;else{B=null;break}else{B=null;break}}if(B==null)continue;let W=I[B];W!==void 0&&(W.explicit&&(W=j(j({},W),{explicit:!1})),A[U]=qS([W,A[U]]))}this.value={rank:S,transform:_,sourceRank:r,outputSpace:mt({rank:S,names:T,scales:V,units:O,coordinateArrays:A}),inputSpace:mt({rank:S,names:D,scales:L,units:M,coordinateArrays:I,boundingBoxes:H})}}toJSON(){return BE(this.spec)}restoreState(e){this.spec=OE(e)}}function $V(i,e=!1){const t=Ie(i);if(!Mv(t,e))throw new Error(`Invalid dimension name: ${se(t)}`);return t}function Nv(i,e=!1){const t=He(i,n=>$V(n,e));if(!Ph(t,e))throw new Error(`Invalid dimensions: ${se(t)}`);return t}class Vv{constructor(e,t){this.combined=e,this.bindings=new je,this.retainCount=0,this.prevCombined=this.combined.value,this.dimensionRefCounts=new ue,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t}getRenameValidity(e){const t=this.combined.value.names,n=Rv(e),r=e.length;for(let s=0;s<r;++s){if(!n[s])continue;const o=e[s];if(t.includes(o))continue;let l=!0;for(const c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}n[s]=l}return n}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){const e=this.combined,t=this.bindings,n=this.retainCount>0?1:0;if(t.size===0&&!n){e.value=Ur;return}const r=this.includeDimensionPredicate_,s=e.value;let o=Te(s.names),l=Te(s.units),c=Te(s.scales),u=Te(s.ids),f=Te(s.timestamps),g=s.names.map(()=>n?1:0);const v=[];let y=!1;for(const D of t){const T=D.space.value,A=D.prevValue,V=D.mappedDimensionIds;y=y||T.valid;const O=T.names,_=T.units,H=T.scales,U=T.ids,B=T.timestamps,W=[],F=[];v.push(F),D.mappedDimensionIds=W,D.prevValue=T;const le=O.length;for(let de=0;de<le;++de){const Re=O[de];if(!r(Re))continue;if(A!==void 0){const Be=U[de],qe=A.ids.indexOf(Be);if(qe!==-1){const Ze=V[qe];if(Ze!==void 0){const it=u.indexOf(Ze);if(it!==-1){W[de]=Ze,++g[it],F[de]=it;const ot=B[de];ot!==void 0&&!(ot<=f[it])&&(o[it]=Re,c[it]=H[de],l[it]=_[de],f[it]=ot);continue}}}}let ce=o.indexOf(Re);if(ce!==-1){W[de]=u[ce],++g[ce],F[de]=ce;continue}ce=o.length,F[de]=ce,g[ce]=1+n,o[ce]=Re,l[ce]=_[de],c[ce]=H[de],f[ce]=B[de];const Le=lo();u[ce]=Le,W[de]=Le}}const C=this.dimensionRefCounts;C.clear();let w=0,S=o.length;for(const D of t){const T=D.space.value,A=v[w++],V=T.rank,O=Te(T.names),_=Te(T.timestamps),H=Float64Array.from(T.scales),U=Te(T.units);for(let B=0;B<V;++B){const W=A[B];W!==void 0&&(U[B]=l[W],H[B]=c[W],_[B]=f[W],O[B]=o[W])}for(const B of O){let W=C.get(B);W===void 0?W=1:++W,C.set(B,W)}if(!_e(U,T.units)||!_e(H,T.scales)||!_e(O,T.names)||!_e(_,T.timestamps)){const B=mt({valid:T.valid,ids:T.ids,scales:H,units:U,names:O,timestamps:_,boundingBoxes:T.boundingBoxes,coordinateArrays:T.coordinateArrays});D.prevValue=B,D.space.value=B}}{for(let T=0;T<S;++T)r(o[T])||(g[T]=0);const D=(T,A)=>g[A]!==0;o=o.filter(D),l=l.filter(D),c=c.filter(D),u=u.filter(D),f=f.filter(D),g=g.filter(D),S=o.length}const L=[],I=new Array(S);for(let D=0,T=s.rank;D<T;++D){const A=s.coordinateArrays[D];if(!(A!=null&&A.explicit))continue;const V=u.indexOf(s.ids[D]);V!==-1&&(I[V]=[A])}for(const D of t){const T=D.space.value,A=T.rank,V=T.boundingBoxes,O=T.coordinateArrays,_=T.names.map(H=>o.indexOf(H));for(const H of V)L.push(OV(H,S,_));for(let H=0;H<A;++H){const U=O[H];if(U===void 0)continue;const B=_[H],W=I[B];W===void 0?I[B]=[U]:W.push(U)}}const M=new Array(S);for(let D=0;D<S;++D){const T=I[D];T!==void 0&&(M[D]=IE(T))}const R=mt({valid:y,ids:u,names:o,units:l,scales:new Float64Array(c),boundingBoxes:L,coordinateArrays:M});if(n)for(let D=0;D<S;++D)--g[D];Mu(s,R)||(this.prevCombined=R,e.value=R)}retain(){return++this.retainCount,()=>{--this.retainCount===0&&this.update()}}bind(e){const t={space:e,mappedDimensionIds:[],prevValue:void 0},n=this.bindings;n.size===0&&this.combined.changed.add(this.handleCombinedChanged),n.add(t);const r=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),s=()=>{r();const o=this.bindings;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),s}}function VE(i,e,t,n,r){const s=r.length,o=new i((s+1)**2);o[o.length-1]=1;for(let l=0;l<s;++l){const c=n[l];o[(s+1)*s+l]=e[(t+1)*t+c];for(let u=0;u<s;++u){const f=r[u];o[(s+1)*u+l]=e[(t+1)*f+c]}}return o}function jV(i){if(i===void 0)return;const e=new Float64Array(16);if(Array.isArray(i))if(i.length===16)for(let t=0;t<4;++t)for(let n=0;n<4;++n)e[t*4+n]=Tt(i[n*4+t]);else{_n(i,4);for(let t=0;t<4;++t){const n=_n(i[t],4);for(let r=0;r<4;++r)e[r*4+t]=Tt(n[r])}}else{ge(i);const t=zi(),n=Ne(),r=bt(1,1,1);we(i,"rotation",o=>{go(t,o),cd(t,t)}),we(i,"translation",o=>{go(n,o)}),we(i,"scale",o=>{go(r,o)});const s=Qe();eN(s,t,n,r),e.set(s)}return{sourceRank:3,transform:e,outputSpace:mt({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function OE(i){if(i===void 0)return;const e=ge(i),t=Y(e,"outputDimensions",Ru),n=t.rank,r=Y(e,"sourceRank",o=>{if(o===void 0)return n;if(!$i(o)||o<0||o>n)throw new Error(`Expected integer in range [0, ${n}] but received: ${se(o)}`);return o}),s=we(e,"inputDimensions",o=>{const l=Ru(o,!0);if(l.rank!==n)throw new Error(`Expected rank of ${n}, but received rank of: ${l.rank}`);return l});return{transform:we(e,"matrix",o=>{const l=new Float64Array((n+1)**2),c=_n(o,n);l[l.length-1]=1;for(let u=0;u<n;++u)try{const f=_n(c[u],n+1);for(let g=0;g<=n;++g)l[(n+1)*g+u]=Tt(f[g])}catch(f){throw new Error(`Error in row ${u}: ${f.message}`)}return l}),outputSpace:t,inputSpace:s,sourceRank:r}}function BE(i){if(i===void 0)return;const e=i.transform,t=i.outputSpace,n=i.inputSpace,r=i.sourceRank;let s;const o=t.rank;if(e!==void 0){s=[];for(let l=0;l<o;++l){const c=[];s[l]=c;for(let u=0;u<=o;++u)c[u]=e[(o+1)*u+l]}}return{sourceRank:r===o?void 0:r,matrix:s,outputDimensions:Bg(t),inputDimensions:n===void 0?void 0:Bg(n)}}function HV(i,e,t){const n=i.box,r=i.transform,s=i.box.lowerBounds.length,o=e.length,l=new Float64Array((s+1)*o);for(let c=0;c<o;++c)for(let u=0;u<=s;++u){const f=e[c];l[c+u*o]=r[f+u*t]}if(!l.every(c=>c===0))return{transform:l,box:n}}function Fg(i,e){const t=i.ids,n=i.names,r=i.scales,s=i.units,o=i.timestamps,l=i.coordinateArrays;return mt({rank:e.length,valid:i.valid,ids:e.map(c=>t[c]),names:e.map(c=>n[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>r[c]),units:e.map(c=>s[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:i.boundingBoxes.map(c=>HV(c,e,i.rank)).filter(c=>c!==void 0)})}function _E(i,e,t){return e===t?i:Fg(i,f2(i.rank,t,e))}function XS(i,e){const t=i.transform,n=i.rank,r=kh(t,n,[e]);if(r.length!==1)return;var s=oe(r,1);const o=s[0],l=Math.abs(t[(n+1)*o+e]),c=i.inputSpace;return{scale:c.scales[o]*l,unit:c.units[o]}}function QS(i,e){var t=i.defaultInputSpace;const n=t.scales,r=t.units;return e<n.length?{scale:n[e],unit:r[e]}:void 0}function JV(i){const e=i.rank;var t=i.bounds;const n=t.lowerBounds,r=t.upperBounds;if(n.some(c=>c!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(c=>!$i(c)||c<=0||c>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");const s=new Uint32Array(r),o=Pv(s),l=new Uint32Array(o*e);for(let c=0;c<o;++c){let u=c;for(let f=0;f<e;++f){const g=u%s[f];u=(u-g)/s[f],l[c*e+f]=g}}return{channelCoordinateSpace:i,shape:s,numChannels:o,coordinates:l}}function Tf(i,e,t,n,r,s){const o=t.scales,l=r.scales,c=r.rank,u=e+1;for(let f=0;f<c;++f){const g=s[f];if(g===-1)continue;const v=l[f];for(let y=0;y<e;++y){const C=n[y],w=o[C];i[u*y+g]*=w/v}}}function ZV(i,e,t,n,r=Lo){const s=t.inputSpace,o=t.rank,l=t.sourceRank,c=t.outputSpace,u=t.transform,f=s.names,g=c.names;let v;if(n!==void 0)v=Te(n.modelSubspaceDimensionIndices);else{v=[];for(let _=0;_<l;++_)v[_]=_}const y=v.length;for(let _=l;_<o;++_)v.push(_);const C=kh(t.transform,o,v,!0),w=v.length,S=v.map(_=>f[_]||`${_}`),L=C.map(_=>g[_]);if(w!==C.length)return{error:"Rank mismatch between model subspace dimensions ("+S.join(", ")+") and corresponding layer/global dimensions ("+L.join(", ")+")"};let I=VE(Float32Array,u,o,C,v);const M=C.map(_=>g[_]),R=e.names.map(_=>M.indexOf(_)),D=i.names.map(_=>M.indexOf(_));Tf(I,w,s,v,i,D),Tf(I,w,s,v,e,R);const T=r.names.map(_=>M.indexOf(_));Tf(I,w,s,v,r,T);const A=[],V=r.rank;if(n!==void 0){let _=n.subsourceToModelSubspaceTransform;y!==w&&(_=Iv(new Float32Array((w+1)**2),w,_,y)),I=Dh(new Float32Array((w+1)**2),w+1,I,w+1,_,w+1,w+1,w+1,w+1)}const O=new Uint32Array(V);for(let _=0;_<V;++_){const H=r.bounds.lowerBounds[_],U=r.bounds.upperBounds[_];if(H!==0||!$i(U)||U<=0||U>=2**32)return{error:`Channel dimension ${r.names[_]} must have lower bound of 0 and positive integer upper bound`};O[_]=U;const B=T[_];let W=-1;if(B!==-1)for(let F=0;F<w;++F){const le=I[B+F*(w+1)];if(le!==0){if(le!==1||W!==-1)return{error:`Channel dimension ${L[B]} must map to a single source dimension`};W=F}}A[_]=W}return{rank:w,unpaddedRank:y,modelDimensionNames:S,layerDimensionNames:L,localToRenderLayerDimensions:R,globalToRenderLayerDimensions:D,channelToRenderLayerDimensions:T,modelToRenderLayerTransform:I,channelToModelDimensions:A,channelSpaceShape:O}}function qV(i,e){return i===e?!0:i.error!==void 0||e.error!==void 0?!1:_e(i.modelDimensionNames,e.modelDimensionNames)&&_e(i.layerDimensionNames,e.layerDimensionNames)&&_e(i.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&_e(i.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&_e(i.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&_e(i.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&_e(i.channelSpaceShape,e.channelSpaceShape)}function FE(i,e,t,n,r){return wn((s,o,l,c)=>ZV(s,o,l,n,c),[i,e,t,r===void 0?aa(void 0):r],qV)}function YV(i,e,t,n){const r=t.globalToRenderLayerDimensions;for(let s=0;s<3;++s){let o=0;const l=n[s];if(l!==-1){const c=r[l];c!==-1&&(o=e[c])}i[s]=o}}function KV(i,e,t,n){const r=t.globalToRenderLayerDimensions;for(let s=0;s<3;++s){const o=n[s];if(o!==-1){const l=r[o];l!==-1&&(i[l]=e[s])}}}function UE(i,e){const t=i.rank,n=i.unpaddedRank;let r;n!==t&&e!==void 0&&(e=Iv(new Float32Array((t+1)**2),t,e,n)),e!==void 0?(r=new Float32Array((t+1)*(t+1)),Dh(r,t+1,i.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):r=i.modelToRenderLayerTransform;const s=new Float32Array((t+1)*(t+1)),o=Tv(s,t+1,r,t+1,t+1);if(o===0)throw new Error("Transform is singular");const l=i.globalToRenderLayerDimensions,c=i.localToRenderLayerDimensions,u=i.channelToRenderLayerDimensions,f=l.length,g=c.length,v=f+g,y=new Float32Array((v+1)*t);for(let D=0;D<t;++D){for(let T=0;T<f;++T){const A=l[T];A!==-1&&(y[D+T*t]=s[D+A*(t+1)])}for(let T=0;T<g;++T){const A=c[T];A!==-1&&(y[D+(f+T)*t]=s[D+A*(t+1)])}y[D+v*t]=s[D+t*(t+1)]}const C=u.length;let w=new Array(C);const S=[];for(let D=0;D<C;++D){const T=u[D];let A=-1;if(T!==-1){for(let V=0;V<t;++V){const O=r[T+V*(t+1)];if(O!==0){if(O!==1||A!==-1)throw new Error(`Channel dimension ${i.layerDimensionNames[T]} must map with stride 1 to a single data chunk dimensions`);A=V}}if(A!==-1){if(r[T+t*(t+1)]!==0)throw new Error(`Channel dimension ${i.layerDimensionNames[T]} must have an offset of 0 in the chunk coordinate space`);S.push(A)}}w[D]=A}const L=i.channelSpaceShape,I=Pv(L),M=S.length,R=new Uint32Array(I*M);for(let D=0;D<I;++D){let T=D,A=0;for(let V=0;V<C;++V){const O=T%L[V];T=(T-O)/L[V],w[V]!==-1&&(R[D*M+A]=O,++A)}}return{layerRank:t,modelTransform:i,chunkToLayerTransform:r,layerToChunkTransform:s,chunkToLayerTransformDet:o,combinedGlobalLocalRank:v,combinedGlobalLocalToChunkTransform:y,channelToChunkDimensionIndices:w,chunkChannelDimensionIndices:S,numChannels:I,chunkChannelCoordinates:R,channelSpaceShape:L}}function zE(i,e){const t=i.globalToRenderLayerDimensions,n=[],r=[];for(let s=0;s<3;++s){const o=e[s];if(o==-1)continue;const l=t[o];r.push(l),l!==-1&&n.push(l)}for(let s=r.length;s<3;++s)r[s]=-1;return{layerDisplayDimensionIndices:n,displayToLayerDimensionIndices:r}}function GE(i,e){const t=i.chunkToLayerTransform,n=i.modelTransform,r=n.rank,s=e.layerDisplayDimensionIndices,o=e.displayToLayerDimensionIndices,l=s.length,c=kh(t,r,s);if(c.length!==l){const g=n.modelDimensionNames,v=n.layerDimensionNames;throw new Error(`Rank mismatch between displayed layer dimensions (${Te(s,y=>v[y]).join(", ")}) and corresponding chunk dimensions (${Te(c,y=>g[y]).join(", ")})`)}const u=Qe();for(let g=0;g<3;++g){const v=o[g];if(v!==-1){for(let y=0;y<l;++y){const C=c[y];u[y*4+g]=t[C*(r+1)+v]}u[12+g]=t[r*(r+1)+v]}}const f=Qe();Cs(f,u);for(let g=c.length;g<3;++g)c[g]=-1;return{modelTransform:i.modelTransform,chunkTransform:i,displaySubspaceModelMatrix:u,displaySubspaceInvModelMatrix:f,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function gd(i,e,t,n,r){const s=e.length,o=t.length,l=i.length;let c=!0;for(let u=0;u<n;++u){let f=u,g=0;for(let v=0;v<s;++v)g+=r[f+v*n]*e[v];f+=s*n;for(let v=0;v<o;++v)g+=r[f+v*n]*t[v];g+=r[f+o*n],u<l?i[u]=g:(g<0||g>=1)&&(c=!1)}return c}function XV(i,e,t){i.fill(0),i[15]=1;let n=!0;const r=e.displayDimensionIndices,s=t.globalToRenderLayerDimensions,o=t.modelToRenderLayerTransform,l=t.rank;for(let c=0;c<3;++c){const u=r[c];if(u===-1){n=!1;continue}const f=s[u];if(f===-1){n=!1;continue}i[c+12]=o[f+l*(l+1)];for(let g=0;g<3;++g)i[c+4*g]=o[f+(l+1)*g]}if(!n){const c=e.globalDimensionNames,u=Te(r.filter(f=>f!==-1),f=>c[f]).join(", ");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(", ")}) to display dimensions (${u}) does not have full rank`)}}var QV=Ct.Object.getOwnPropertySymbols,eO={default:QV,__esModule:!0};const ew=It(eO);var tO=dv,iO=dM.f;f1("getOwnPropertyDescriptor",function(){return function(i,e){return iO(tO(i),e)}});var nO=Ct.Object,rO=function(i,e){return nO.getOwnPropertyDescriptor(i,e)},sO={default:rO,__esModule:!0};const Wn=It(sO);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Et;(function(i){i[i.GPU_MEMORY=0]="GPU_MEMORY",i[i.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",i[i.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",i[i.DOWNLOADING=3]="DOWNLOADING",i[i.QUEUED=4]="QUEUED",i[i.NEW=5]="NEW",i[i.FAILED=6]="FAILED",i[i.EXPIRED=7]="EXPIRED"})(Et||(Et={}));const WE=8;var Lr;(function(i){i[i.FIRST_TIER=0]="FIRST_TIER",i[i.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",i[i.VISIBLE=0]="VISIBLE",i[i.PREFETCH=1]="PREFETCH",i[i.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",i[i.RECENT=2]="RECENT",i[i.LAST_TIER=2]="LAST_TIER"})(Lr||(Lr={}));const $E=3;var Nu;(function(i){i[i.totalTime=0]="totalTime",i[i.totalChunks=1]="totalChunks"})(Nu||(Nu={}));var kr;(function(i){i[i.numChunks=0]="numChunks",i[i.systemMemoryBytes=1]="systemMemoryBytes",i[i.gpuMemoryBytes=2]="gpuMemoryBytes"})(kr||(kr={}));const ps=3;function Hs(i,e){return i*$E+e}function tw(i){return WE*$E*ps+i}const aO="ChunkQueueManager",oO="ChunkManager",lO="ChunkSource.invalidate",dO="ChunkQueueManager.requestChunkStatistics",cO="ChunkManager.chunkLayerStatistics";class Ov{constructor(){this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.numPrefetchChunksAvailable=0}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wt(i){let e=-1;return j(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,i()}))},{flush:()=>{e!==-1&&(e=-1,i())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}class jE{constructor(){this.map=new ue}get(e,t){let n=this.map,r=n.get(e);return r===void 0?(r=t(),r.registerDisposer(()=>{n.delete(e)}),n.set(e,r)):r.addRef(),r}}class HE extends jE{get(e,t){return typeof e!="string"&&(e=rn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new A1(t())).value}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uO(i){let e={antialias:!1,stencil:!0},t=i.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new jE,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(const n of["EXT_color_buffer_float"])if(!t.getExtension(n))throw new Error(`${n} extension not available`);for(const n of["EXT_float_blend"])t.getExtension(n);return t}class Bv{constructor(){this.width=0,this.height=0,this.logicalWidth=0,this.logicalHeight=0,this.visibleLeftFraction=0,this.visibleTopFraction=0,this.visibleWidthFraction=0,this.visibleHeightFraction=0}}function JE(i,e){const t=1/i.visibleWidthFraction,n=1/i.visibleHeightFraction,r=-1-(-1+2*i.visibleLeftFraction)*t;let s=-1-(-1+2*i.visibleTopFraction)*n;s=-s,e[0]=e[0]*t+e[3]*r,e[4]=e[4]*t+e[7]*r,e[8]=e[8]*t+e[11]*r,e[12]=e[12]*t+e[15]*r,e[1]=e[1]*n+e[3]*s,e[5]=e[5]*n+e[7]*s,e[9]=e[9]*n+e[11]*s,e[13]=e[13]*n+e[15]*s}function ZE(i,e){return i.width===e.width&&i.height===e.height&&i.logicalWidth===e.logicalWidth&&i.logicalHeight===e.logicalHeight&&i.visibleLeftFraction===e.visibleLeftFraction&&i.visibleTopFraction===e.visibleTopFraction}class qE extends K{constructor(e,t,n){super(),this.context=e,this.element=t,this.visibility=n,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new Bv,this.boundsObserversRegistered=!1,this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){const e=this.context;e.ensureBoundsUpdated();const t=e.boundsGeneration;if(t===this.boundsGeneration)return;this.boundsGeneration=t;const n=this.element;!this.boundsObserversRegistered&&e.monitorPanel(n)&&(this.boundsObserversRegistered=!0);const r=n.getBoundingClientRect(),s=e.container,o=e.canvasRect,l=e.canvas,c=l.width,u=l.height,f=c/o.width,g=u/o.height,v=o.left,y=o.top;let C=this.canvasRelativeLogicalLeft=Math.round((r.left-v)*f+n.clientLeft),w=this.canvasRelativeLogicalTop=Math.round((r.top-y)*g+n.clientTop),S=n.clientWidth,L=n.clientHeight,I=C+S,M=w+L,R=w,D=C,T=I,A=M;for(let H=n.parentElement;H!==null&&H!==s;H=H.parentElement){const U=H.getBoundingClientRect();U.x===0&&U.y===0&&U.width===0&&U.height===0||(D=Math.max(D,(U.left-v)*f),R=Math.max(R,(U.top-y)*g),T=Math.min(T,(U.right-v)*f),A=Math.min(A,(U.bottom-y)*g))}R=this.canvasRelativeClippedTop=Math.round(Math.max(R,0)),D=this.canvasRelativeClippedLeft=Math.round(Math.max(D,0)),T=Math.round(Math.min(T,c)),A=Math.round(Math.min(A,u));const V=this.renderViewport,O=V.width=Math.max(0,T-D),_=V.height=Math.max(0,A-R);V.logicalWidth=S,V.logicalHeight=L,V.visibleLeftFraction=(D-C)/S,V.visibleTopFraction=(R-w)/L,V.visibleWidthFraction=O/S,V.visibleHeightFraction=_/L}setGLClippedViewport(){const e=this.gl,t=this.canvasRelativeClippedTop,n=this.canvasRelativeClippedLeft;var r=this.renderViewport;const s=r.width,o=r.height,l=t+o;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let c=this.context.canvas.height-l;e.viewport(n,c,s,o),e.scissor(n,c,s,o)}setGLLogicalViewport(){const e=this.gl;var t=this.renderViewport;const n=t.width,r=t.height,s=t.logicalWidth,o=t.logicalHeight,l=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,l-(this.canvasRelativeLogicalTop+o),s,o),e.scissor(this.canvasRelativeClippedLeft,l-(this.canvasRelativeClippedTop+r),n,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;const e=this.element;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}}class YE extends qE{constructor(e,t,n){super(e,t,n),this.canvas=document.createElement("canvas"),this.canvasRenderingContext=this.canvas.getContext("2d");const r=this.canvas;t.appendChild(r),t.style.position="relative",r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.top="0",r.style.bottom="0"}draw(){this.drawIndirect();const e=this.renderViewport,t=this.canvas,n=e.logicalWidth,r=e.logicalHeight;t.width=n,t.height=r;const s=this.canvasRenderingContext;s==null||s.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,n,r,0,0,n,r)}}class hO extends ci{constructor(){super(Float64Array.of(0,0,1,1),e=>st(new Float64Array(4),e,Cv))}toJSON(){const e=this.value;var t=oe(e,4);const n=t[0],r=t[1],s=t[2],o=t[3];if(!(n===0&&r==0&&s===1&&o===1))return Te(e)}}class pO extends K{constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new xe,this.updateFinished=new xe,this.changed=this.updateFinished,this.panels=new je,this.resizeGeneration=0,this.boundsGeneration=-1,this.orderedPanels=[],this.frameNumber=0,this.panelAncestors=new ue,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.scheduleRedraw=this.registerCancellable(wt(()=>this.draw()));const t=this.canvas,n=this.resizeObserver;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",n.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",r=>{console.log(`Lost WebGL context: ${r.statusMessage}`),r.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=uO(t)}monitorPanel(e){const t=this.panelAncestors,n=this.container;if(!n.contains(e))return!1;for(;e!==n;){let r=t.get(e);if(r!==void 0){++r.count;break}const s=e.parentElement;r={parent:s,count:1},t.set(e,r),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=s}return!0}unmonitorPanel(e){const t=this.panelAncestors,n=this.container;for(;e!==n;){const r=t.get(e);if(r.count!==1){--r.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=r.parent}}applyWindowedViewportToElement(e,t){var n=oe(t,4);const r=n[0],s=n[1],o=n[2],l=n[3],c=1/o,u=1/l;e.style.position="absolute",e.style.top=`${-u*s*100}%`,e.style.left=`${-c*r*100}%`,e.style.width=`${c*100}%`,e.style.height=`${u*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(const e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){const e=this.resizeGeneration;if(this.boundsGeneration===e)return;const t=this.canvas;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=this.orderedPanels,n=this.panels;t.length!==n.size&&(t.push(...n),t.sort((r,s)=>r.drawOrder-s.drawOrder));for(const r of t){if(!r.shouldDraw)continue;r.ensureBoundsUpdated();const s=r.renderViewport;s.width===0||s.height===0||r.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){var e=this.canvas;const t=e.width,n=e.height,r=new Float32Array(t*n);for(const o of this.panels){if(!o.shouldDraw)continue;const l=o.getDepthArray();if(l===void 0)continue;const c=o.canvasRelativeClippedTop,u=o.canvasRelativeClippedLeft;var s=o.renderViewport;const f=s.width,g=s.height;for(let v=0;v<g;++v){const y=(g-1-v)*f;r.set(l.subarray(y,y+f),(c+v)*f+u)}}return r}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class KE extends Bv{constructor(){super(...arguments),this.globalPosition=Eo,this.projectionMat=Qe(),this.viewMatrix=Qe(),this.invViewMatrix=Qe(),this.viewProjectionMat=Qe(),this.invViewProjectionMat=Qe()}}function fO(i,e){return i.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&ZE(i,e)&&_e(i.globalPosition,e.globalPosition)&&_e(i.projectionMat,e.projectionMat)&&_e(i.viewMatrix,e.viewMatrix)}function XE(i){const e=i.viewMatrix,t=i.viewProjectionMat;Cs(e,i.invViewMatrix),fi(t,i.projectionMat,e),Cs(i.invViewProjectionMat,t)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gO="rendered_view.addLayer",mO="rendered_view.removeLayer",vO="SharedProjectionParameters",yO="SharedProjectionParameters.changed";var lr;(function(i){i[i.info=0]="info",i[i.warning=1]="warning",i[i.error=2]="error"})(lr||(lr={}));class qo{constructor(){this.changed=new xe,this.messages=[],this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){const e=this.messages;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{const t=this.children;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Wi](){yield*this.messages;for(const e of this.children)yield*e}}var iw=jo,bO=mh,SO=jr("species"),QE=function(i,e){var t=iw(i).constructor,n;return t===void 0||(n=iw(t)[SO])==null?e:bO(n)},wO=function(i,e,t){var n=t===void 0;switch(e.length){case 0:return n?i():i.call(t);case 1:return n?i(e[0]):i.call(t,e[0]);case 2:return n?i(e[0],e[1]):i.call(t,e[0],e[1]);case 3:return n?i(e[0],e[1],e[2]):i.call(t,e[0],e[1],e[2]);case 4:return n?i(e[0],e[1],e[2],e[3]):i.call(t,e[0],e[1],e[2],e[3])}return i.apply(t,e)},jc=fa,CO=wO,nw=uM,rw=cM,Vr=Hr,sw=Vr.process,Ug=Vr.setImmediate,aw=Vr.clearImmediate,ow=Vr.MessageChannel,Df=Vr.Dispatch,Pf=0,rd={},lw="onreadystatechange",Js,Af,Mf,Xl=function(){var i=+this;if(rd.hasOwnProperty(i)){var e=rd[i];delete rd[i],e()}},dw=function(i){Xl.call(i.data)};(!Ug||!aw)&&(Ug=function(i){for(var e=[],t=1;arguments.length>t;)e.push(arguments[t++]);return rd[++Pf]=function(){CO(typeof i=="function"?i:Function(i),e)},Js(Pf),Pf},aw=function(i){delete rd[i]},sv(sw)=="process"?Js=function(i){sw.nextTick(jc(Xl,i,1))}:Df&&Df.now?Js=function(i){Df.now(jc(Xl,i,1))}:ow?(Af=new ow,Mf=Af.port2,Af.port1.onmessage=dw,Js=jc(Mf.postMessage,Mf,1)):Vr.addEventListener&&typeof postMessage=="function"&&!Vr.importScripts?(Js=function(i){Vr.postMessage(i+"","*")},Vr.addEventListener("message",dw,!1)):lw in rw("script")?Js=function(i){nw.appendChild(rw("script"))[lw]=function(){nw.removeChild(this),Xl.call(i)}}:Js=function(i){setTimeout(jc(Xl,i,1),0)});var eL={set:Ug},na=Hr,xO=eL.set,cw=na.MutationObserver||na.WebKitMutationObserver,zg=na.process,Rf=na.Promise,uw=sv(zg)=="process",EO=function(){var i,e,t,n=function(){var l,c;for(uw&&(l=zg.domain)&&l.exit();i;){c=i.fn,i=i.next;try{c()}catch(u){throw i?t():e=void 0,u}}e=void 0,l&&l.enter()};if(uw)t=function(){zg.nextTick(n)};else if(cw&&!(na.navigator&&na.navigator.standalone)){var r=!0,s=document.createTextNode("");new cw(n).observe(s,{characterData:!0}),t=function(){s.data=r=!r}}else if(Rf&&Rf.resolve){var o=Rf.resolve(void 0);t=function(){o.then(n)}}else t=function(){xO.call(na,n)};return function(l){var c={fn:l,next:void 0};e&&(e.next=c),i||(i=c,t()),e=c}},Ah={},hw=mh;function LO(i){var e,t;this.promise=new i(function(n,r){if(e!==void 0||t!==void 0)throw TypeError("Bad Promise constructor");e=n,t=r}),this.resolve=hw(e),this.reject=hw(t)}Ah.f=function(i){return new LO(i)};var tL=function(i){try{return{e:!1,v:i()}}catch(e){return{e:!0,v:e}}},kO=Hr,pw=kO.navigator,IO=pw&&pw.userAgent||"",TO=jo,DO=ks,PO=Ah,iL=function(i,e){if(TO(i),DO(e)&&e.constructor===i)return e;var t=PO.f(i),n=t.resolve;return n(e),t.promise},AO=gM,ys=Hr,co=fa,MO=yh,sn=Yt,RO=ks,NO=mh,VO=Sh,fw=Ho,OO=QE,nL=eL.set,rL=EO(),sL=Ah,Gg=tL,BO=IO,_O=iL,Ds="Promise",aL=ys.TypeError,ko=ys.process,gw=ko&&ko.versions,FO=gw&&gw.v8||"",Qn=ys[Ds],md=MO(ko)=="process",hu=function(){},Hc,oL,mw,_v,vd=oL=sL.f,Mh=!!function(){try{var i=Qn.resolve(1),e=(i.constructor={})[jr("species")]=function(t){t(hu,hu)};return(md||typeof PromiseRejectionEvent=="function")&&i.then(hu)instanceof e&&FO.indexOf("6.6")!==0&&BO.indexOf("Chrome/66")===-1}catch{}}(),lL=function(i){var e;return RO(i)&&typeof(e=i.then)=="function"?e:!1},Fv=function(i,e){if(!i._n){i._n=!0;var t=i._c;rL(function(){for(var n=i._v,r=i._s==1,s=0,o=function(l){var c=r?l.ok:l.fail,u=l.resolve,f=l.reject,g=l.domain,v,y,C;try{c?(r||(i._h==2&&zO(i),i._h=1),c===!0?v=n:(g&&g.enter(),v=c(n),g&&(g.exit(),C=!0)),v===l.promise?f(aL("Promise-chain cycle")):(y=lL(v))?y.call(v,u,f):u(v)):f(n)}catch(w){g&&!C&&g.exit(),f(w)}};t.length>s;)o(t[s++]);i._c=[],i._n=!1,e&&!i._h&&UO(i)})}},UO=function(i){nL.call(ys,function(){var e=i._v,t=vw(i),n,r,s;if(t&&(n=Gg(function(){md?ko.emit("unhandledRejection",e,i):(r=ys.onunhandledrejection)?r({promise:i,reason:e}):(s=ys.console)&&s.error&&s.error("Unhandled promise rejection",e)}),i._h=md||vw(i)?2:1),i._a=void 0,t&&n.e)throw n.v})},vw=function(i){return i._h!==1&&(i._a||i._c).length===0},zO=function(i){nL.call(ys,function(){var e;md?ko.emit("rejectionHandled",i):(e=ys.onrejectionhandled)&&e({promise:i,reason:i._v})})},mo=function(i){var e=this;e._d||(e._d=!0,e=e._w||e,e._v=i,e._s=2,e._a||(e._a=e._c.slice()),Fv(e,!0))},Wg=function(i){var e=this,t;if(!e._d){e._d=!0,e=e._w||e;try{if(e===i)throw aL("Promise can't be resolved itself");(t=lL(i))?rL(function(){var n={_w:e,_d:!1};try{t.call(i,co(Wg,n,1),co(mo,n,1))}catch(r){mo.call(n,r)}}):(e._v=i,e._s=1,Fv(e,!1))}catch(n){mo.call({_w:e,_d:!1},n)}}};Mh||(Qn=function(i){VO(this,Qn,Ds,"_h"),NO(i),Hc.call(this);try{i(co(Wg,this,1),co(mo,this,1))}catch(e){mo.call(this,e)}},Hc=function(i){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},Hc.prototype=bh(Qn.prototype,{then:function(i,e){var t=vd(OO(this,Qn));return t.ok=typeof i=="function"?i:!0,t.fail=typeof e=="function"&&e,t.domain=md?ko.domain:void 0,this._c.push(t),this._a&&this._a.push(t),this._s&&Fv(this,!1),t.promise},catch:function(i){return this.then(void 0,i)}}),mw=function(){var i=new Hc;this.promise=i,this.resolve=co(Wg,i,1),this.reject=co(mo,i,1)},sL.f=vd=function(i){return i===Qn||i===_v?new mw(i):oL(i)});sn(sn.G+sn.W+sn.F*!Mh,{Promise:Qn});u1(Qn,Ds);w1(Ds);_v=Ct[Ds];sn(sn.S+sn.F*!Mh,Ds,{reject:function(i){var e=vd(this),t=e.reject;return t(i),e.promise}});sn(sn.S+sn.F*AO,Ds,{resolve:function(i){return _O(this===_v?Qn:this,i)}});sn(sn.S+sn.F*!(Mh&&k1()(function(i){Qn.all(i).catch(hu)})),Ds,{all:function(i){var e=this,t=vd(e),n=t.resolve,r=t.reject,s=Gg(function(){var o=[],l=0,c=1;fw(i,!1,function(u){var f=l++,g=!1;o.push(void 0),c++,e.resolve(u).then(function(v){g||(g=!0,o[f]=v,--c||n(o))},r)}),--c||n(o)});return s.e&&r(s.v),t.promise},race:function(i){var e=this,t=vd(e),n=t.reject,r=Gg(function(){fw(i,!1,function(s){e.resolve(s).then(t.resolve,n)})});return r.e&&n(r.v),t.promise}});var Nf=Yt,GO=Ct,WO=Hr,$O=QE,yw=iL;Nf(Nf.P+Nf.R,"Promise",{finally:function(i){var e=$O(this,GO.Promise||WO.Promise),t=typeof i=="function";return this.then(t?function(n){return yw(e,i()).then(function(){return n})}:i,t?function(n){return yw(e,i()).then(function(){throw n})}:i)}});var bw=Yt,jO=Ah,HO=tL;bw(bw.S,"Promise",{try:function(i){var e=jO.f(this),t=HO(i);return(t.e?e.reject:e.resolve)(t.v),e.promise}});var JO=Ct.Promise,ZO={default:JO,__esModule:!0};const Ot=It(ZO);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qO{constructor(){this.name="CancellationError",this.message="CANCELED"}toString(){return"CANCELED"}}const Es=new qO;function YO(i){if(i.isCanceled===!0)throw Es}const $g=()=>{},qt={isCanceled:!1,add:()=>$g,remove:$g};class Ps{cancel(){const e=this.handlers;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let t=this.handlers;return t===null?(e(),$g):(t===void 0&&(t=this.handlers=new je),t.add(e),()=>{this.remove(e)})}remove(e){const t=this.handlers;t==null||t.delete(e)}}class KO extends Ps{constructor(){super(...arguments),this.consumers=new je}addConsumer(e=qt){const t=this.consumers;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}}function XO(i,e){return new Ot((t,n)=>{if(i===qt){e(t,n,qt);return}const r=new Ps,s=i.add(()=>{r.cancel()});e(o=>{s(),t(o)},o=>{s(),n(o)},r)})}const dL=!(typeof Window<"u"&&self instanceof Window),jg="rpc.promise.response",cL="rpc.promise.cancel";var uL=new ue;function _t(i,e){uL.set(i,e)}class QO extends Error{constructor(e,t){super(t),this.name=e,this.message=t}}function hL(i,e){_t(i,function(t){let n=t.id;const r=new Ps;let s=e.call(this,t,r);this.set(n,{promise:s,cancellationToken:r}),s.then(({value:o,transfers:l})=>{this.delete(n),this.invoke(jg,{id:n,value:o},l)},o=>{this.delete(n),this.invoke(jg,{id:n,error:o.message,errorName:o.name})})})}_t(cL,function(i){let e=i.id;const t=this.get(e);t!==void 0&&t.cancellationToken.cancel()});_t(jg,function(i){let e=i.id;var t=this.get(e);let n=t.resolve,r=t.reject;this.delete(e),i.hasOwnProperty("value")?n(i.value):i.errorName===Es.name?r(Es):r(new QO(i.errorName,i.error))});const eB=dL?-1:0;class tB{constructor(e){this.target=e,this.objects=new ue,this.nextId=eB,e.onmessage=t=>{let n=t.data;uL.get(n.functionName).call(this,n)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}getOptionalRef(e){if(e===void 0)return;let t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}invoke(e,t,n){t.functionName=e,this.target.postMessage(t,n)}promiseInvoke(e,t,n=qt,r){return XO(n,(s,o,l)=>{const c=t.id=this.newId();this.set(c,{resolve:s,reject:o}),this.invoke(e,t,r),l.add(()=>{this.invoke(cL,{id:c})})})}newId(){return dL?this.nextId--:this.nextId++}}class ur extends K{constructor(){super(...arguments),this.rpc=null,this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let e=this.rpc,t=this.rpcId;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}}function iB(i,e,t={}){e!=null&&i.initializeSharedObject(e,t.id)}class Rh extends ur{constructor(e,t={}){super(),iB(this,e,t)}}_t("SharedObject.dispose",function(i){let e=this.get(i.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});const nB="Worker";_t(nB,function(i){const e=i.port,t=i.path;new Worker(t).postMessage({port:e},[e])});_t("SharedObject.refCountReachedZero",function(i){let e=this.get(i.id),t=i.gen;e.counterpartRefCountReachedZero(t)});const pL=new ue;function Ln(i){return e=>{e.prototype.RPC_TYPE_ID=i}}function Nh(i){return e=>{if(i!==void 0)e.prototype.RPC_TYPE_ID=i;else if(i=e.prototype.RPC_TYPE_ID,i===void 0)throw new Error("RPC_TYPE_ID should have already been defined");pL.set(i,e)}}_t("SharedObject.new",function(i){let e=this,t=i.type,n=pL.get(t),r=new n(e,i);--r.refCount});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var rB=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s},pu;const fL="SharedWatchableValue.changed";let Di=pu=class extends Rh{constructor(i,e={}){super(i,e),this.updatingValue_=!1,i!==void 0&&(this.base=new gt(e.value),this.setupChangedHandler())}initializeCounterpart(i,e={}){e.value=this.value,super.initializeCounterpart(i,e)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{const i=this.rpc;i!==null&&i.invoke(fL,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(i,e){let t=new pu;return t.base=e,t.setupChangedHandler(),t.initializeCounterpart(i),t}static make(i,e){return pu.makeFromExisting(i,new gt(e))}get value(){return this.base.value}set value(i){this.base.value=i}get changed(){return this.base.changed}};Di=pu=rB([Nh("SharedWatchableValue")],Di);_t(fL,function(i){const e=this.get(i.id);e.updatingValue_=!0,e.base.value=i.value,e.updatingValue_=!1});class Zt extends gt{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}Zt.VISIBLE=Number.POSITIVE_INFINITY;Zt.IGNORED=Number.NEGATIVE_INFINITY;class yd extends Zt{constructor(){super(...arguments),this.contributors=new ue}add(e){const t=this.contributors,n=e.changed.add(()=>{this.update()}),r=()=>{t.delete(r),n(),this.update()};return t.set(r,e),this.update(),r}update(){let e=Number.NEGATIVE_INFINITY;for(const t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function Vh(i){return class extends i{constructor(){super(...arguments),this.visibility=new yd}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(Di.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var sB=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s},aB=globalThis&&globalThis.__rest||function(i,e){var t={};for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.indexOf(n)<0&&(t[n]=i[n]);if(i!=null&&typeof ew=="function")for(var r=0,n=ew(i);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(i,n[r])&&(t[n[r]]=i[n[r]]);return t},En;(function(i){i[i.DATA=0]="DATA",i[i.ANNOTATION=1]="ANNOTATION",i[i.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(En||(En={}));function oB(){return new J2([En.DATA,En.ANNOTATION,En.DEFAULT_ANNOTATION])}class gL extends K{constructor(){super(...arguments),this.role=En.DATA,this.messages=new qo,this.layerChanged=new xe,this.redrawNeeded=new xe,this.layerChunkProgressInfo=new Ov}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,n,r){}}class mL extends gL{constructor(){super(...arguments),this.visibility=new yd}attach(e){}}function Vu(i,e,t){let n=t.state;if(n===void 0||n.transform!==i||n.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),n=t.state={transform:i,displayDimensionRenderInfo:e,modelTransform:void 0},i.error!==void 0){t.messages.addMessage({severity:lr.error,message:i.error});return}try{const r=Qe();XV(r,e,i),n.modelTransform=r}catch(r){t.messages.addMessage({severity:lr.error,message:r.message})}}return n.modelTransform}class vL extends K{constructor(e){super(),this.renderViewport=new Bv,this.changed=new at;var t=e.parametersConstructor;const n=t===void 0?KE:t,r=e.navigationState,s=e.update;var o=e.isEqual;const l=o===void 0?fO:o;this.oldValue_=new n,this.value_=new n;const c=()=>{const f=this.oldValue_,g=this.value_;f.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,j(f,this.renderViewport);let v=f.globalPosition;const y=r.position.value,C=y.length;v.length!==C&&(f.globalPosition=v=new Float32Array(C)),v.set(y),s(f,r),!l(f,g)&&(this.value_=f,this.oldValue_=g,this.changed.dispatch(g,f))},u=this.update=this.registerCancellable(ct(c,0));this.registerDisposer(r.changed.add(u)),c()}setViewport(e){ZE(e,this.renderViewport)||(j(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}}let Ou=class extends ur{constructor(i,e,t=10){super(),this.base=e,this.updateInterval=t,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable(ct((n,r)=>{let s;r.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo?(s=r,this.prevDisplayDimensionRenderInfo=r.displayDimensionRenderInfo):(r.displayDimensionRenderInfo,s=aB(r,["displayDimensionRenderInfo"])),this.rpc.invoke(yO,{id:this.rpcId,value:s})},this.updateInterval)),this.initializeCounterpart(i,{value:e.value}),this.registerDisposer(e.changed.add(this.update))}flush(){this.update.flush()}};Ou=sB([Ln(vO)],Ou);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qt{constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new xe}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){if(this.value_!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class As extends K{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");let n=this.element;n.type="checkbox";const r=()=>{var s;const o=this.model.value;this.element.checked=o,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(s=o?t.enableTitle:t.disableTitle)!==null&&s!==void 0?s:"")};this.registerDisposer(e.changed.add(r)),r(),this.registerEventListener(n,"change",function(s){e.value=this.checked}),n.addEventListener("mousedown",s=>{s.preventDefault()})}disposed(){let e=this.element,t=e.parentElement;t&&t.removeChild(e),super.disposed()}}class pn extends K{constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable(ct(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yL(i){try{return i()}catch(e){return{error:e.message}}}function lB(i){if(i.error!==void 0)throw new Error(i.error);return i}class Uv extends K{constructor(e,t){if(super(),this.register=e,this.changed=new xe,this.disposerMap=new ue,t===void 0)this.map=new ue;else{const r=this.map=new ue(t),s=this.disposerMap;for(const o of r){var n=oe(o,2);const l=n[0],c=n[1],u=new K;s.set(l,u),e(u,c,l)}}}get value(){return this.map}set(e,t){const n=this.map,r=this.disposerMap;let s=r.get(e);return s!==void 0&&s.dispose(),s=new K,r.set(e,s),n.set(e,t),this.register(s,t,e),this.changed.dispatch(),this}delete(e){const t=this.map,n=this.disposerMap,r=n.get(e);return r!==void 0?(r.dispose(),n.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Wi](){return pv(this.map)}clear(){const e=this.map,t=this.disposerMap;if(e.size>0){for(const n of t.values())n.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){const e=this.map,t=this.disposerMap;for(const n of t.values())n.dispose();e.clear(),t.clear(),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Sw=ln("objectId");let dB=0;function Ci(i){if(i instanceof Object){let e=i[Sw];return e===void 0&&(e=i[Sw]=dB++),`o${e}`}else return""+se(i)}var Hg;(function(i){i[i.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",i[i.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(Hg||(Hg={}));function cB(i){i=i.replace("\0","");let e=[];for(let t of i.split(`
`)){let n=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);n!==null?e.push({message:n[3].trim(),file:parseInt(n[1],10),line:parseInt(n[2],10)}):(n=t.match(/^ERROR:\s*(.+)$/),n!==null?e.push({message:n[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}class uB extends Error{constructor(e,t,n,r){const s=`Error compiling ${Hg[e].toLowerCase()} shader: ${n}`;super(s),this.name="ShaderCompilationError",this.log=n,this.message=s,this.shaderType=e,this.source=t,this.errorMessages=r}}class hB extends Error{constructor(e,t,n){const r=`Error linking shader: ${n}`;super(r),this.name="ShaderLinkError",this.log=n,this.message=r,this.vertexSource=e,this.fragmentSource=t}}function ww(i,e,t){var n=i.createShader(t);if(i.shaderSource(n,e),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS)){let r=i.getShaderInfoLog(n)||"";throw new uB(t,e,r,cB(r))}return n}class pB extends K{constructor(e,t,n,r,s,o){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=n,this.attributes=new ue,this.uniforms=new ue,this.vertexShaderInputBinders={};let l=this.vertexShader=ww(e,t,e.VERTEX_SHADER),c=this.fragmentShader=ww(e,n,e.FRAGMENT_SHADER),u=e.createProgram();if(e.attachShader(u,l),e.attachShader(u,c),e.linkProgram(u),!e.getProgramParameter(u,e.LINK_STATUS)){let v=e.getProgramInfoLog(u)||"";throw new hB(t,n,v)}this.program=u;let f=this.uniforms,g=this.attributes;if(r)for(let v of r)f.set(v,e.getUniformLocation(u,v));if(s)for(let v of s)g.set(v,e.getAttribLocation(u,v))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){this.gl.useProgram(this.program)}disposed(){let e=this.gl;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}}function fB(i,e,t,n,r){i.drawArraysInstanced(e,t,n,r)}class Cw{constructor(){this.code="",this.parts=new je}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}}const Jg={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D};class da{constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new je,this.fragmentExtensions="",this.vertexCode=new Cw,this.vertexMain="",this.fragmentCode=new Cw,this.outputBufferCode="",this.fragmentMain="",this.required=new je,this.uniforms=new Array,this.attributes=new Array,this.initializers=[],this.textureUnits=new ue,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let n=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,n),n}addTextureSampler(e,t,n,r){let s=this.allocateTextureUnit(n,r);return this.addUniform(`highp ${e}`,t,r),this.addInitializer(o=>{if(r){let l=new Int32Array(r);for(let c=0;c<r;++c)l[c]=c+s;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),s)}),s}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,n){return this.attributes.push(t),n!==void 0&&(this.attributesCode+=`layout(location = ${n})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,n=""){this.varyingsCodeVS+=`${n} out ${e} ${t};
`,this.varyingsCodeFS+=`${n} in ${e} ${t};
`}addOutputBuffer(e,t,n){n!==null&&(this.outputBufferCode+=`layout(location = ${n}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,n){return this.uniforms.push(t),n!=null?this.uniformsCode+=`uniform ${e} ${t}[${n}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,n=new pB(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);n.textureUnits=this.textureUnits;let r=this.initializers;if(r.length>0){n.bind();for(let s of r)s(n)}return n}}function Oh(){return new gt(void 0)}function zv(i){return new ci(i,Ie)}function Gv(i,e,t){const n=new ue,r=t.parameters,s=t.fallbackParameters,o=t.shaderError;var l=t.encodeParameters;const c=l===void 0?R=>R:l;var u=t.extraParameters;const f=u===void 0?aa(void 0):u;var g=t.encodeExtraParameters;const v=g===void 0?R=>R:g,y=t.getContextKey,C=t.defineShader;o!==void 0&&(o.value=void 0);var w=t.encodeContext;const S=w===void 0?y:w,L=rn(t.memoizeKey);function I(R,D,T){const A=se({id:L,context:S(R),parameters:c(D),extraParameters:v(T)});return e.memoize.get(A,()=>{const V=new da(e);return C(V,R,D,T),V.build()})}function M(R){const D=y(R);let T=n.get(D);T===void 0&&(T={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:r.value,extraParameters:f.value},n.set(D,T));const A=r.changed.count,V=f.changed.count;if(A===T.parametersGeneration&&V===T.extraParametersGeneration)return T;const O=T.parameters=r.value,_=T.extraParameters=f.value,H=T.shader;T.parametersGeneration=A,T.extraParametersGeneration=V;let U=null;try{U=I(R,O,_),T.fallback=!1,s!==void 0&&(s.value=O),o!==void 0&&(o.value=null)}catch(B){if(o!==void 0&&(o.value=B),s!==void 0)try{const W=s.value;U=I(R,W,_),T.parameters=W,T.fallback=!0}catch{}}return H!==null&&H.dispose(),T.shader=U,T}return i.registerDisposer(()=>{for(const R of n.values()){const D=R.shader;D!==null&&D.dispose()}}),M}function Io(i,e,t){return Gv(i,e,j(j({},t),{getContextKey:n=>n,encodeContext:n=>Ci(n),defineShader:(n,r,s,o)=>(n.require(r),t.defineShader(n,s,o))}))}function bd(i,e=1,t=0){return`
#line ${t} ${e}
`+i}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ki{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,n=WebGL2RenderingContext.FLOAT,r=!1,s=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,n,r,s,o)}bindToVertexAttribI(e,t,n=WebGL2RenderingContext.UNSIGNED_INT,r=0,s=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,n,r,s)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let n=this.gl;this.bind(),n.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,n,r){let s=new Ki(e,n);return s.setData(t,r),s}}function Sd(i,e,t,...n){return i.memoize.get(rn({id:"getMemoizedBuffer",getter:Ci(t),args:n}),()=>{const r=new A1(Ki.fromData(i,t(...n),e,WebGL2RenderingContext.STATIC_DRAW));return r.registerDisposer(r.value),r})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gB(i=-1,e=-1,t=1,n=1,r=1,s=1){return Sg(new Float32Array([i,e,i,n,t,n,t,e]),2,r,s)}function wd(i,e=-1,t=-1,n=1,r=1,s=1,o=1){return Sd(i,WebGL2RenderingContext.ARRAY_BUFFER,gB,e,t,n,r,s,o).value}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function To(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function mB(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function vB(i,e,t,n,r=WebGL2RenderingContext.RGBA8,s=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),To(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,t,n,0,s,o,null),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function yB(i,e,t){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bL(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain("v4f_fragColor = getValue0();")}function bB(i,e=bL,t=1){return i.memoize.get(`elementWiseTextureShader:${t}:${Ci(e)}`,()=>{let n=new da(i);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler",t),n.addInitializer(r=>{let s=[];for(let o=0;o<t;++o)s[o]=o;i.uniform1iv(r.uniform("uSampler"),s)});for(let r=0;r<t;++r)n.addFragmentCode(`
vec4 getValue${r}() {
  return texture(uSampler[${r}], vTexCoord);
}
`);return n.addUniform("mat4","uProjectionMatrix"),n.require(e),n.addAttribute("vec4","aVertexPosition"),n.addAttribute("vec2","aTexCoord"),n.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),n.build()})}function SB(i){return i.memoize.get("trivialColorShader",()=>{let e=new da(i);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class SL extends K{constructor(){super(...arguments),this.width=Number.NaN,this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}}class wB extends SL{constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){let e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class CB extends wB{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){let e=this.gl;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class xB extends CB{constructor(e){super(e,!0)}}class EB extends K{constructor(e){super(),this.gl=e,this.framebuffer=this.gl.createFramebuffer()}disposed(){this.gl.deleteFramebuffer(this.framebuffer)}bind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class ra extends SL{constructor(e,t,n,r){super(),this.gl=e,this.internalFormat=t,this.format=n,this.dataType=r,this.texture=e.createTexture()}performResize(){vB(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class LB extends ra{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,n=WebGL2RenderingContext.DEPTH_COMPONENT,r=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,n,r)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function Bu(i,e,t=WebGL2RenderingContext.RGBA8,n=WebGL2RenderingContext.RGBA,r=WebGL2RenderingContext.UNSIGNED_BYTE){let s=new Array;for(let o=0;o<e;++o)s[o]=new ra(i,t,n,r);return s}class Do extends K{constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=new Array,this.attachmentVerified=!1,this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];var n=t.framebuffer;let r=n===void 0?new EB(e):n,s=t.colorBuffers,o=t.depthBuffer;this.framebuffer=this.registerDisposer(r),this.colorBuffers=s,this.depthBuffer=o,o!==void 0&&this.registerDisposer(o);let l=this.fullAttachmentList;s.forEach((c,u)=>{this.registerDisposer(c),l[u]=e.COLOR_ATTACHMENT0+u})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let n=this.gl,r=this.depthBuffer;r!==void 0?(r.resize(e,t),r.attachToFramebuffer()):n.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((s,o)=>{s.resize(e,t),s.attachToFramebuffer(n.COLOR_ATTACHMENT0+o)}),n.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),n.viewport(0,0,e,t)}bindSingle(e){let t=this.gl;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,n,r,s=1,o=1){let l=this.gl;try{this.bindSingle(e),l.readPixels(t,n,s,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,r)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let e=this.gl,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class Po extends K{constructor(e,t){super(),this.gl=e,this.shader=t,this.copyVertexPositionsBuffer=wd(this.gl),this.copyTexCoordsBuffer=wd(this.gl,0,0,1,1),this.registerDisposer(t)}draw(...e){let t=this.gl,n=this.shader;n.bind();let r=e.length;for(let l=0;l<r;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,j1);let s=n.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(s,2);let o=n.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(s),t.disableVertexAttribArray(o);for(let l=0;l<r;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=bL,n=1){return e.memoize.get(`OffscreenCopyHelper:${n}:${Ci(t)}`,()=>new Po(e,bB(e,t,n)))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const kB=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`;var IB=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`;const Gt=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,TB=[Gt,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],wL=[Gt,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],Bh=[Gt,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],CL=[Gt,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],DB=[Gt,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],PB=[DB,Bh,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],AB=[CL,Bh,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],xL=[Gt,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],MB=[Gt,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],EL=[Gt,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],LL=[Gt,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],Wv=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,kL=[Gt,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],IL=[Gt,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],$v=[Gt,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],TL=[Gt,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`];var RB=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`;const NB=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,VB=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,OB=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,BB=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,jv=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,_B=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,FB=[jv,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],UB=[jv,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function wi(i,e=1){switch(i){case J.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case J.UINT8:case J.INT8:case J.UINT16:case J.INT16:case J.UINT32:case J.INT32:case J.UINT64:{const t=iE[i]?"":"u",n=EN[i]*8;if(e===1)return`${t}int${n}_t`;if(e>1&&e*n<=32)return`${t}int${n}x${e}_t`;break}}throw new Error(`No shader type for ${J[i]}[${e}].`)}const Yo={[J.UINT8]:EL,[J.INT8]:LL,[J.UINT16]:kL,[J.INT16]:IL,[J.UINT32]:$v,[J.INT32]:TL,[J.UINT64]:Gt,[J.FLOAT32]:Wv};function zB(i,e){return e===1?i:`vec${e}`}const GB={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function Ud(i,e,t,n,r,s,o=1){let l=0,c=s*o;for(;c>0;){const g=Math.min(4,c),v=zB(e,g);c-=g,i.addAttribute("highp "+v,`a${r}${l}`),++l}c=s*o;let u="";for(let g=0;g<o;++g){u+=`highp ${e}[${s}] get${r}${g}() {
  highp ${e}[${s}] result;
`;for(let v=0;v<s;++v){const y=g*s+v,C=Math.floor(y/4),w=y%4;u+=`  result[${v}] = a${r}${C}`,(w!==0||y!==c-1)&&(u+=`[${w}]`),u+=`;
`}u+=`  return result;
`,u+=`}
`}i.addVertexCode(u);const f=GB[t];i.addInitializer(g=>{const v=[];for(let y=0;y<l;++y)v[y]=g.attribute(`a${r}${y}`);g.vertexShaderInputBinders[r]={enable(y){const C=g.gl;for(let w=0;w<l;++w){const S=v[w];C.enableVertexAttribArray(S),C.vertexAttribDivisor(S,y)}},disable(){const y=g.gl;for(let C=0;C<l;++C){const w=v[C];y.vertexAttribDivisor(w,0),y.disableVertexAttribArray(w)}},bind(y,C){const w=g.gl;for(let S=0;S<l;++S){const L=v[S],I=Math.min(4,c-4*S);w.vertexAttribPointer(L,I,t,n,y,C),C+=f*I}}}})}class DL extends K{constructor(e,t,n=new yd){super(),this.channels=e,this.bounds=t,this.visibility=n,this.framebuffers=[],this.producerVisibility=new yd,this.frameNumber=-1}getFramebuffers(e){const t=this.framebuffers;for(;t.length<this.channels.value.length;){const n=new Do(e,{colorBuffers:Bu(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(n)}return t}disposed(){for(const e of this.framebuffers)e.dispose();this.framebuffers.length=0}}const xw=ln("histogramDataSamplerTextureUnit"),Ew=ln("histogramDepthTextureUnit"),Vf=4096,WB=2**14;class Hv extends K{constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{const t=new da(this.gl);return t.addOutputBuffer("vec4","outputValue",0),t.addAttribute("float","aInput1"),t.addTextureSampler("sampler2D","uDataSampler",xw),t.addTextureSampler("sampler2D","uDepthSampler",Ew),t.addVertexCode(OB),t.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),t.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),t.build()})()),this.inputIndexBuffer=this.registerDisposer(Sd(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(Vf)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new Hv(e))}compute(e,t,n,r,s){const o=this.gl,l=this.shader,c=r.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const u=l.textureUnit(xw),f=l.textureUnit(Ew);o.activeTexture(WebGL2RenderingContext.TEXTURE0+f),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),To(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+u);const g=r.frameNumber;r.frameNumber=s;for(let v=0;v<e;++v)o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n[v].texture),To(o),c[v].bind(256,1),s!==g&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,Vf,WB/Vf);o.disable(WebGL2RenderingContext.BLEND)}}const Jv={[J.UINT8]:"vec2",[J.INT8]:"vec2",[J.UINT16]:"vec2",[J.INT16]:"vec2",[J.FLOAT32]:"vec2",[J.UINT32]:"Uint32LerpParameters",[J.INT32]:"Int32LerpParameters",[J.UINT64]:"Uint64LerpParameters"},zd={[J.UINT8]:"",[J.INT8]:"",[J.UINT16]:"",[J.INT16]:"",[J.FLOAT32]:"",[J.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[J.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[J.UINT64]:[Gt,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]};function Wl(i){let e=`
float computeInvlerp(${wi(i)} inputValue, vec2 p) {
  float outputValue = float(toRaw(inputValue));
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;return[Yo[i],e]}function Lw(i){const e=wi(i);let t=i===J.INT32?"int":"uint",n=Jv[i];return[Yo[i],zd[i],`
float computeInvlerp(${e} inputValue, ${n} p) {
  ${t} v = toRaw(inputValue);
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
`]}const $B={[J.UINT8]:Wl(J.UINT8),[J.INT8]:Wl(J.INT8),[J.UINT16]:Wl(J.UINT16),[J.INT16]:Wl(J.INT16),[J.FLOAT32]:Wl(J.FLOAT32),[J.UINT32]:Lw(J.UINT32),[J.INT32]:Lw(J.INT32),[J.UINT64]:[Gt,Bh,CL,xL,zd[J.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function $l(i){let e=`
${wi(i)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return i===J.FLOAT32?e+=`return inputValue;
`:e+=`return ${J[i].toLowerCase()}FromFloat(round(inputValue));
`,e+=`
}
`,[Yo[i],e]}function kw(i){const e=wi(i);let t=Jv[i];return[Yo[i],zd[i],BB,i===J.UINT32?jv:FB,i===J.UINT32?_B:UB,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}const jB={[J.UINT8]:$l(J.UINT8),[J.INT8]:$l(J.INT8),[J.UINT16]:$l(J.UINT16),[J.INT16]:$l(J.INT16),[J.FLOAT32]:$l(J.FLOAT32),[J.UINT32]:kw(J.UINT32),[J.INT32]:kw(J.INT32),[J.UINT64]:[Gt,Bh,wL,PB,AB,xL,MB,zd[J.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function PL(i,e,t){const n=`uLerpParams_${e}`,r=`uLerpBounds_${e}`,s=`uLerpScalar_${e}`;let o="";switch(t){case J.INT8:case J.UINT8:case J.INT16:case J.UINT16:case J.FLOAT32:i.addUniform("vec2",n);break;case J.INT32:case J.UINT32:{const l=Jv[t];i.addUniform(`${t===J.INT32?"i":"u"}vec2`,r),i.addUniform("float",s),o+=`
#define ${n} ${l}(${r}[0], int(${r}[1]), ${s})
`;break}case J.UINT64:{i.addUniform("uvec3",r),i.addUniform("float",s),o+=`
#define ${n} Uint64LerpParameters(uint64_t(${r}.xy), int(${r}[2]), ${s})
`;break}}return[zd[t],o]}function AL(i,e,t,n=!1){return[Yo[t],PL(i,e,t),$B[t],`
float ${e}(${wi(t)} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${n?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`]}function HB(i,e,t){return[Yo[t],PL(i,e,t),jB[t],`
${wi(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}const Zs=new re;function Zv(i,e,t,n){const r=i.gl;switch(t){case J.INT8:case J.UINT8:case J.INT16:case J.UINT16:case J.FLOAT32:r.uniform2f(i.uniform(`uLerpParams_${e}`),n[0],1/(n[1]-n[0]));break;case J.INT32:case J.UINT32:{const s=n[0],o=n[1]-s,l=Math.max(0,Math.ceil(Yi(Math.abs(o)))-24),c=Math.pow(2,l)/o,u=i.uniform(`uLerpBounds_${e}`);t===J.UINT32?r.uniform2ui(u,s,l):r.uniform2i(u,s,l),r.uniform1f(i.uniform(`uLerpScalar_${e}`),c);break}case J.UINT64:{const s=n[0],o=n[1];re.absDifference(Zs,o,s);const l=Zs.high>0?32+Math.ceil(Yi(Zs.high)):Math.ceil(Yi(Zs.low)),c=Math.max(0,l-24);re.rshift(Zs,Zs,c);let u=1/Zs.low;re.compare(s,o)>0&&(u*=-1);const f=i.uniform(`uLerpBounds_${e}`);r.uniform3ui(f,s.low,s.high,c),r.uniform1f(i.uniform(`uLerpScalar_${e}`),u)}}}function JB(i){const e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return i.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function ZB(i){const e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/;let t=0,n=i;e:for(;i.length;){const r=i.match(e);if(r===null)break;const s=r[0];switch(s.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){i=i.substring(s.length);break e}break}i=i.substring(s.length)}return t!==0?-1:n.length-i.length}function qB(i){let e=[],t=new ue;if(i===void 0)return{errors:e,parameters:t};const n=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;i=i.trim(),i.length!=0;){const r=i.match(n);if(r===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}const s=r[1];i=i.substring(r[0].length);let o=ZB(i);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(i.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${s}: ${l}`);break}t.has(s)?e.push(`Duplicate #uicontrol parameter: ${s}`):t.set(s,l),i=i.substring(o),i=i.trim(),i.length>0&&!i.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),i=i.substring(1)}return{parameters:t,errors:e}}function YB(i,e){let t,n,r,s,o=[];i!=="float"&&i!=="uint"&&i!=="int"&&o.push("type must be float, int, or uint");for(const c of e){var l=oe(c,2);const u=l[0],f=l[1],g=()=>{if(typeof f!="number"){o.push(`Expected ${u} argument to be a number`);return}return(i==="int"||i==="uint")&&($i(f)||o.push(`Expected ${u} argument to be an integer`),i==="uint"&&f<0&&o.push(`Expected ${u} argument to be an unsigned integer`)),f};u==="min"?t=g():u==="max"?n=g():u==="default"?s=g():u==="step"?r=g():o.push(`Invalid parameter: ${u}`)}return t===void 0&&o.push("min must be specified"),n===void 0&&o.push("max must be specified"),t!==void 0&&n!==void 0&&(t>n&&o.push("min must be less than max"),r===void 0&&(i==="float"?r=(n-t)/100:r=1),s!==void 0?(s<t||s>n)&&o.push("default must be within valid range"):i==="float"?s=(t+n)/2:s=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:i,min:t,max:n,step:r,default:s},errors:void 0}}function KB(i,e){let t=!1,n=[];i!=="bool"&&n.push("type must be bool");for(const s of e){var r=oe(s,2);const o=r[0],l=r[1];if(o==="default"){if(typeof l!="boolean"){n.push(`Expected ${o} argument to be a boolean`);continue}t=l}else n.push(`Invalid parameter: ${o}`)}return n.length>0?{errors:n}:{control:{type:"checkbox",valueType:i,default:t},errors:void 0}}function XB(i,e){let t="white",n=[];i!=="vec3"&&n.push("type must be vec3");for(const s of e){var r=oe(s,2);const o=r[0],l=r[1];o==="default"?typeof l!="string"?n.push("Expected default argument to be a string"):t=l:n.push(`Invalid parameter: ${o}`)}return n.length>0?{errors:n}:{control:{type:"color",valueType:i,defaultString:t,default:ma(t)},errors:void 0}}function ML(i,e){typeof i=="number"&&(i=[i]);const t=new Array(e);return st(t,i,n=>{if(!$i(n)||n<0)throw new Error(`Expected non-negative integer, but received: ${se(n)}`);return n}),t}function QB(i,e,t){let n=[];const r=t.imageData;if(r===void 0)return n.push("invlerp control not supported"),{errors:n};i!=="invlerp"&&n.push("type must be invlerp");let s=new Array(r.channelRank).fill(0);const o=r.dataType;let l=!0,c=Od[o],u;for(let g of e){var f=oe(g,2);let v=f[0],y=f[1];try{switch(v){case"range":{c=Tu(y,o);break}case"window":{u=mE(Tu(y,o));break}case"clamp":{typeof y!="boolean"?n.push(`Invalid clamp value: ${se(y)}`):l=y;break}case"channel":{s=ML(y,s.length);break}default:n.push(`Invalid parameter: ${v}`);break}}catch(C){n.push(`Invalid ${v} value: ${C.message}`)}}return n.length>0?{errors:n}:{control:{type:"invlerp",dataType:o,clamp:l,default:{range:c,window:u??XN(c),channel:s}},errors:void 0}}const e_=new ue([["slider",YB],["color",XB],["invlerp",QB],["checkbox",KB]]);function _h(i,e={}){i=JB(i);const t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,n=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/;let r=[];const s=new ue,o=i.replace(t,(l,c,u)=>{var f;const g=c.match(n),v=()=>Math.max(0,i.substring(0,u).split(`
`).length-1);if(g===null)return r.push({line:v(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";const y=g[1],C=g[2],w=(f=g[3])!==null&&f!==void 0?f:y,S=g[4];var L=qB(S);const I=L.parameters,M=L.errors;for(const T of M)r.push({line:v(),message:T});if(s.has(C)&&r.push({line:v(),message:`Duplicate definition for control ${C}`}),M.length>0)return"";const R=e_.get(w);if(R===void 0)return r.push({line:v(),message:`Invalid control type ${w}`}),"";const D=R(y,I,e);if(D.errors!==void 0){for(const T of D.errors)r.push({line:v(),message:T});return""}return s.set(C,D.control),""});return{source:i,code:o,errors:r,controls:s}}function RL(i){return`u_shaderControl_${i}`}function Cd(i,e){const t=i.builderValues;for(const r of i.parseResult.controls){var n=oe(r,2);const s=n[0],o=n[1],l=RL(s),c=t[s];switch(o.type){case"invlerp":{const u=[AL(e,l,o.dataType,o.clamp),`
float ${l}() {
  return ${l}(getDataValue(${c.channel.join(",")}));
}
`];e.addFragmentCode(u),e.addFragmentCode(`#define ${s} ${l}
`);break}case"checkbox":{const u=`#define ${s} ${c.value}
`;e.addFragmentCode(u),e.addVertexCode(u);break}default:{e.addUniform(`highp ${o.valueType}`,l),e.addVertexCode(`#define ${s} ${l}
`),e.addFragmentCode(`#define ${s} ${l}
`);break}}}}function t_(i){const e={};for(const n of i){var t=oe(n,2);const r=t[0],s=t[1];e[r]=s}return e}function Iw(i){if(i!==void 0)return se(t_(i))}class i_{constructor(){this.changed=new xe,this.controls=void 0}get value(){return this.controls}set value(e){Iw(e)!==Iw(this.controls)&&(this.controls=e,this.changed.dispatch())}}function n_(i,e,t){return i===void 0?t:(ge(i),{range:we(i,"range",n=>Tu(n,e),t.range),window:we(i,"window",n=>mE(Tu(n,e)),t.window),channel:we(i,"channel",n=>ML(n,t.channel.length),t.channel)})}class r_ extends ci{constructor(e,t){super(t,n=>n_(n,e,t)),this.dataType=e,this.defaultValue=t}toJSON(){var e=this.value;const t=e.range,n=e.window,r=e.channel,s=this.dataType,o=this.defaultValue,l=$S(t,s,o.range),c=$S(n,s,o.window),u=_e(o.channel,r)?void 0:r;if(!(l===void 0&&c===void 0&&u===void 0))return{range:l,window:c,channel:u}}}function NL(i){switch(i.type){case"slider":return{trackable:new ci(i.default,e=>{let t;if(i.valueType==="float"?t=Tt(e):t=hi(e),t<i.min||t>i.max)throw new Error(`${se(e)} is outside valid range [${i.min}, ${i.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new ud(i.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new r_(i.dataType,i.default),getBuilderValue:e=>({channel:e.channel,dataType:i.dataType})};case"checkbox":return{trackable:new Qt(i.default),getBuilderValue:e=>({value:e})}}}function VL(i,e){return se(i)+"\0"+e.source}function qv(i){const e={};for(const r of i.controls){var t=oe(r,2);const s=t[0],o=t[1];var n=NL(o);const l=n.trackable,c=n.getBuilderValue;e[s]=c(l.value)}return{builderValues:e,parseResult:i,key:VL(e,i)}}class Yv extends K{constructor(e,t=aa({}),n){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=n,this.changed=new xe,this.controls=new i_,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new xe,this.state_=new ue,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();const r=this;this.parseErrors={changed:this.parseResultChanged,get value(){return r.handleFragmentMainChanged(),r.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return r.handleFragmentMainChanged(),r.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return r.parseResult_}},this.builderState=wn((l,c)=>{const u={};for(const v of c){var f=oe(v,2);const y=f[0];var g=f[1];const C=g.trackable,w=g.getBuilderValue,S=w(C.value);u[y]=S}return{key:VL(u,l),parseResult:l,builderValues:u}},[this.parseResult,this],(l,c)=>l.key===c.key);const s=wn(l=>{const c=[];for(const u of l.values()){const f=u.control,g=u.trackable;f.type==="invlerp"&&c.push({channel:g.value.channel})}return c},[this],(l,c)=>wg(l,c,(u,f)=>_e(u.channel,f.channel))),o=nr(l=>{const c=[];for(const u of l.values()){const f=u.control,g=u.trackable;f.type==="invlerp"&&c.push(g.value.window)}return c},this);this.histogramSpecifications=this.registerDisposer(new DL(s,o))}handleFragmentMainChanged(){const e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;const n=this.dataContext.value;if(n===null)this.parseResult_={source:"",code:"",controls:new ue,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{const r=this.parseResult_=_h(this.fragmentMain.value,n);this.parseErrors_=r.errors,this.processedFragmentMain_=r.code,r.errors.length===0&&(this.controls.value=r.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){const e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;const t=this.controls.value;if(t===void 0)return;let n=!1;const r=this.state_,s=this.unparsedJson;for(const u of r){var o=oe(u,2);const f=o[0],g=o[1];if(t.get(f)===void 0){g.trackable.changed.remove(this.changed.dispatch),r.delete(f),n=!0;continue}}for(const u of t){var l=oe(u,2);const f=l[0],g=l[1];let v=r.get(f);if(v!==void 0&&se(v.control)!==se(g)&&(v.trackable.changed.remove(this.changed.dispatch),v=void 0),v===void 0){var c=NL(g);const y=c.trackable,C=c.getBuilderValue;v={control:g,trackable:y,getBuilderValue:C},v.trackable.changed.add(this.changed.dispatch),r.set(f,v),n=!0}if(s!==void 0&&s.hasOwnProperty(f)){n=!0;try{v.trackable.restoreState(s[f])}catch{}}}s!==void 0&&(n=!0),this.unparsedJson=void 0,n&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;const t=this.state;if(ge(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(const r of t){var n=oe(r,2);const s=n[0],o=n[1].trackable;if(o.reset(),e.hasOwnProperty(s))try{o.restoreState(e[s])}catch{}}this.unparsedJson=void 0}reset(){for(const e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){const e=this.state,t=this.unparsedJson;if(t!==void 0)return t;const n={};let r=!0;for(const o of e){var s=oe(o,2);const l=s[0],c=s[1].trackable.toJSON();c!==void 0&&(n[l]=c,r=!1)}if(!r)return n}}function Tw(i,e,t,n,r){const s=RL(t),o=e.uniform(s);switch(n.type){case"slider":switch(n.valueType){case"int":case"uint":i.uniform1i(o,r);break;case"float":i.uniform1f(o,r)}break;case"color":i.uniform3fv(o,r);break;case"invlerp":Zv(e,s,n.dataType,r.range);break}}function Ao(i,e,t,n){const r=t.state;if(t.controls.value===n)for(const l of r){var s=oe(l,2);const c=s[0],u=s[1];Tw(i,e,c,u.control,u.trackable.value)}else for(const l of n){var o=oe(l,2);const c=o[0],u=o[1],f=r.get(c),g=f!==void 0&&se(f.control)===se(u)?f.trackable.value:u.default;Tw(i,e,c,u,g)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class s_ extends gt{}class a_ extends Uv{constructor(){super((e,{showMatches:t,segmentationState:n})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(n.changed.add(this.changed.dispatch)),e.registerDisposer(Fr((r,s)=>{if(s==null)return;const o=s.segmentationGroupState;r.registerDisposer(o.changed.add(this.changed.dispatch)),r.registerDisposer(Fr((l,c)=>{const u=c.visibleSegments;let f=u.size===0;l.registerDisposer(u.changed.add(()=>{const g=u.size===0;g!==f&&(f=g,this.changed.dispatch())}))},o))},n))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new gt(void 0),showMatches:new Qt(!1)},super.set(e,t)),t}}const Dw=`
void main() {
  setColor(defaultColor());
}
`;class o_ extends K{constructor(){super(...arguments),this.shader=zv(Dw),this.shaderControls=new Yv(this.shader),this.fallbackShaderControls=new gt(qv(_h(Dw))),this.shaderError=Oh(),this.color=new ud(bt(1,1,0)),this.relationshipStates=this.registerDisposer(new a_),this.ignoreNullSegmentFilter=new Qt(!0),this.displayUnfiltered=nr((e,t)=>{for(const n of e.values())if(n.showMatches.value){if(!t)return!1;const r=n.segmentationState.value;if(r!=null&&r.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter),this.hoverState=new s_(void 0)}}class Zg extends K{constructor(e){super();const t=e.transform,n=e.localPosition,r=e.source;var s=e.role;const o=s===void 0?En.ANNOTATION:s;this.transform=t,this.localPosition=n,this.source=this.registerDisposer(r),this.role=o,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(nr(l=>yL(()=>UE(lB(l))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){const e=this.dataSource;return e.layer.dataSources.indexOf(e)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fh{constructor(e,t,n){this.size=Cg(e),this.transform=K2(t),this.finiteRank=n;const r=Qe(),s=Tv(r,4,t,4,4);if(s===0)throw new Error("Transform is singular");this.invTransform=r,this.detTransform=s}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new Fh(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return yn(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return gN(e,t,this.transform)}globalToLocalNormal(e,t){return J1(e,t,this.transform)}}const l_=Qe();function d_(i,e){let t=0,n=Math.abs(i.detTransform);const r=i.transform,s=i.size;for(let o=0;o<3;++o){let l=0;for(let u=0;u<3;++u)l+=e[u*4+2]*r[4*o+u];const c=s[o];t+=Math.abs(l)*c,n*=c}return n/t}function OL(i,e,t){const n=i.curPositionInChunks,r=i.fixedPositionWithinChunk,s=i.nonDisplayLowerClipBound,o=i.nonDisplayUpperClipBound;var l=i.source.spec;const c=l.rank,u=l.chunkDataSize;if(!gd(n,e,t,i.layerRank,i.fixedLayerToChunkTransform))return!1;for(let f=0;f<c;++f){const g=n[f];if(g<s[f]||g>=o[f])return!1;const v=u[f],y=n[f]=Math.floor(g/v);r[f]=g-y*v}return!0}function c_(i,e){let t=e.length,n=0;if(t>1){let r=0;for(let s=0;s<t;++s){const o=e[s].chunkLayout;let l=d_(o,i);l>r&&(r=l,n=s)}}return n}const to=new Fh(Ne(),Qe(),0);class u_ extends KE{constructor(){super(...arguments),this.viewportNormalInGlobalCoordinates=Ne(),this.viewportNormalInCanonicalCoordinates=Ne(),this.centerDataPosition=Ne(),this.pixelSize=0}}function h_(i,e){if(i.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||i.pixelSize!==e.pixelSize)return!0;const t=i.viewMatrix,n=e.viewMatrix;for(let r=0;r<12;++r)if(t[r]!==n[r])return!0;return!1}class p_ extends ur{constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new ue,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((t,n)=>{h_(t,n)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;const e=this.projectionParameters.value.displayDimensionRenderInfo,t=this.visibleLayers;for(const s of t){var n=oe(s,2);const o=n[0];var r=n[1];const l=r.allSources,c=r.visibleSources,u=r.displayDimensionRenderInfo;if(c.length=0,u!==e||l.length===0)continue;const f=c_(this.projectionParameters.value.viewMatrix,l.map(v=>v[0])),g=l[f];for(const v of o.filterVisibleSources(this,g))c.push(v);c.reverse()}}}const f_=18;function _u(i){let e=i.rank,t=i.upperVoxelBound;var n=i.maxVoxelsPerChunkLog2;let r=n===void 0?f_:n,s=i.chunkToViewTransform,o=i.displayRank,l=i.minBlockSize,c=i.maxBlockSize;var u=i.lowerVoxelBound;const f=u===void 0?new Uint32Array(e):u,g=new Float32Array(e);for(let w=0;w<e;++w){let S=0;for(let L=0;L<o;++L){const I=s[w*o+L];S+=I*I}g[w]=Math.sqrt(S)}const v=new Uint32Array(e);l!==void 0?v.set(l):v.fill(1);const y=new Array(e);for(let w=0;w<e;++w){let S=Number.POSITIVE_INFINITY;g[w]===0?S=v[w]:(t!==void 0&&(S=Math.pow(2,Math.floor(Yi(t[w]-f[w])))),c!==void 0&&(S=Math.min(S,c[w]))),y[w]=S}function C(){let w=1/0,S=-1;for(let L=0;L<e;++L){if(v[L]>=y[L])continue;let I=v[L]*g[L];I<w&&(w=I,S=L)}return S}r-=Yi(Pv(v));for(let w=0;w<r;++w){let S=C();if(S===-1)break;v[S]*=2}return v}function g_(i){const e=[],t=i.displayRank,n=i.chunkToViewTransform,r=i.rank;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[_u(i)];for(let s=0;s<3;++s){const o=(s+2)%3,l=new Float32Array(n);for(let c=0;c<r;++c)l[c*t+o]=0;e[s]=_u(j(j({},i),{chunkToViewTransform:l}))}return e}var vo;(function(i){i[i.ISOTROPIC=0]="ISOTROPIC",i[i.FLAT=1]="FLAT"})(vo||(vo={}));function m_(i){if(i.chunkDataSizes!==void 0)return i.chunkDataSizes;var e=i.chunkLayoutPreference;switch(e===void 0?vo.ISOTROPIC:e){case vo.ISOTROPIC:return[_u(i)];case vo.FLAT:return g_(i)}}function Gd(i){const e=i.rank,t=i.chunkDataSize,n=i.upperVoxelBound;var r=i.lowerVoxelBound;const s=r===void 0?new Float32Array(e):r,o=new Float32Array(e),l=new Float32Array(e);for(let c=0;c<e;++c)o[c]=Math.floor(s[c]/t[c]),l[c]=Math.floor((n[c]-1)/t[c]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:o,upperChunkBound:l,lowerVoxelBound:s,upperVoxelBound:n}}function*v_(i,e,t){const n=i.projectionParameters.value.pixelSize*1.1,r=t[0].effectiveVoxelSize,s=e.renderScaleTarget.value,o=f=>{const g=n*s;for(let v=0;v<3;++v){const y=f[v];if(y>g&&y>1.01*r[v])return!0}return!1},l=(f,g)=>{const v=n*s;for(let y=0;y<3;++y){const C=f[y],w=g[y];if(Math.abs(v-C)<Math.abs(v-w)&&C<1.01*w)return!0}return!1};let c=t.length-1,u;for(;;){const f=t[c];if(u!==void 0&&!l(f.effectiveVoxelSize,u)||(yield f,c===0||!o(f.effectiveVoxelSize)))break;u=f.effectiveVoxelSize,--c}}const y_="SliceView",b_="sliceview/RenderLayer",S_="SliceView.addVisibleLayer",w_="SliceView.removeVisibleLayer",Kv=new Float32Array(3),Xv=new Float32Array(3),BL=Qe(),_L=new Float32Array(24);function FL(i,e,t,n){const r=Kv,s=Xv,o=e.lowerChunkDisplayBound,l=e.upperChunkDisplayBound;for(let g=0;g<3;++g)r[g]=Math.max(r[g],o[g]),s[g]=Math.min(s[g],l[g]);const c=e.curPositionInChunks,u=e.chunkDisplayDimensionIndices;function f(){if(!n(r[0],r[1],r[2],s[0],s[1],s[2],i))return;let g=0,v=Math.max(0,s[0]-r[0]),y=v;for(let L=1;L<3;++L){const I=Math.max(0,s[L]-r[L]);y*=I,I>v&&(v=I,g=L)}if(y===0)return;if(y===1){c[u[0]]=r[0],c[u[1]]=r[1],c[u[2]]=r[2],t(r,i);return}const C=r[g],w=s[g],S=Math.floor(.5*(C+w));s[g]=S,f(),s[g]=w,r[g]=S,f(),r[g]=C}f()}function UL(i,e,t,n){if(!OL(t,i.globalPosition,e))return;const r=t.chunkLayout.size,s=fi(BL,i.viewProjectionMat,t.chunkLayout.transform);for(let u=0;u<3;++u){const f=r[u];for(let g=0;g<4;++g)s[4*u+g]*=f}const o=_L;Eu(o,s);const l=Kv,c=Xv;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),FL(o,t,n,q1)}function C_(i,e,t,n,r){if(!OL(t,i.globalPosition,e))return;const s=n.size,o=fi(BL,i.viewProjectionMat,n.transform);for(let v=0;v<3;++v){const y=s[v];for(let C=0;C<4;++C)o[4*v+C]*=y}const l=l_;Cs(l,o);const c=Kv,u=Xv,f=.001;for(let v=0;v<3;++v){const y=l[12+v]+f/s[v],C=Math.abs(l[v]),w=Math.abs(l[4+v]);c[v]=Math.floor(y-C-w),u[v]=Math.floor(y+C+w+1)}const g=_L;for(let v=0;v<3;++v){const y=o[4*v],C=o[4*v+1],w=o[4*v+2];g[v]=y,g[4+v]=-y,g[8+v]=+C,g[12+v]=-C,g[16+v]=+w,g[20+v]=-w}{const v=o[12],y=o[4*3+1],C=o[4*3+2];g[3]=1+v,g[7]=1-v,g[11]=1+y,g[15]=1-y,g[19]=C,g[23]=-C}FL(g,t,r,vN)}function Qv(i,e){const t=e.finiteRank;if(t===3)return e;to.finiteRank=t,rN(to.size,e.size);const n=wu(to.transform,e.transform),r=wu(to.invTransform,e.invTransform);to.detTransform=e.detTransform;const s=i.invViewMatrix,o=i.width,l=i.height,c=K1(i.projectionMat);for(let u=t;u<3;++u){const f=s[12+u];let g=f,v=f;const y=Math.abs(s[u]*o);g-=y,v+=y;const C=Math.abs(s[u+4]*l);g-=C,v+=C;const w=Math.abs(s[u+8]*c);g-=w,v+=w;const S=Math.max(1,v-g);n[12+u]=g,n[5*u]=S}return Cs(r,n),to}const x_="annotation.MetadataChunkSource",E_="annotation.GeometryChunkSource",L_="annotation.SubsetGeometryChunkSource",k_="annotation.reference.add",I_="annotation.reference.delete",T_="annotation.commit",D_="annotation.commit",P_="annotation/SpatiallyIndexedRenderLayer",A_="annotation/PerspectiveRenderLayer:updateSources",M_="annotation/RenderLayer",R_="annotation/RenderLayer.updateSegmentation",N_=Rd();function V_(i,e,t,n,r,s){const o=i.displayDimensionRenderInfo,l=i.viewMatrix,c=i.projectionMat,u=i.width,f=i.height,g=o.voxelPhysicalScales,v=Math.abs(gv(Lh(N_,l))),y=Tg(g),C=yN(c)/v*y;if(n.length===0)return;const w=n[0];let S=Math.abs(w.chunkLayout.detTransform)*y;const L=w.lowerClipDisplayBound,I=w.upperClipDisplayBound;for(let A=0;A<3;++A)S*=I[A]-L[A];const M=Math.min(S,C),R=u*f,D=R/t**2/M;let T=0;for(let A=n.length-1;A>=0&&T<D;--A){const V=n[A],O=V.source.spec,_=V.chunkLayout,H=Tg(_.size)*Math.abs(_.detTransform)*y,U=O.limit,B=O.rank,W=V.nonDisplayLowerClipBound,F=V.nonDisplayUpperClipBound;let le=1;for(let Ze=0;Ze<B;++Ze){const it=F[Ze]-W[Ze];kt(it)&&(le/=it)}const de=U*le/H,Re=T+de,ce=Math.pow(1/Re,1/3),Le=Math.sqrt(R/(Re*M)),Be=(D-T)*H/le,qe=Math.min(1,Be/O.limit);UL(i,e,V,()=>{s(V,A,qe,ce,Le)}),T=Re}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xd=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;function zL(i,e){return{defineShader(t,n){const r=`prop_${n}`,s=`a_${r}`;t.addAttribute(`${i}`,s),t.addVertexCode(`${i} ${r}() { return ${s}; }`),t.addInitializer(o=>{const l=o.attribute(s),c=o.gl;o.vertexShaderInputBinders[r]=l===-1?{enable(){},disable(){},bind(){}}:{enable(u){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,u)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(u,f){e(c,l,u,f)}}})}}}function Of(i,e,t,n){return zL(i,(r,s,o,l)=>{r.vertexAttribPointer(s,e,t,n,o,l)})}function io(i,e,t){return zL(i,(n,r,s,o)=>{n.vertexAttribIPointer(r,e,t,s,o)})}const O_={rgb:Of("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:Of("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:Of("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:io("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:io("highp int",1,WebGL2RenderingContext.INT),uint16:io("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:io("highp int",1,WebGL2RenderingContext.SHORT),uint8:io("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:io("highp int",1,WebGL2RenderingContext.BYTE)};class Wd extends K{constructor(e,t,n,r,s,o,l){super(),this.gl=e,this.annotationType=t,this.rank=n,this.properties=r,this.shaderControlState=s,this.fallbackShaderParameters=o,this.shaderError=l;const c=this.serializedGeometryBytesPerAnnotation=Ui[t].serializedBytes(n);var u=vE(n,c,r);const f=u.offsets,g=u.serializedBytes,v=u.propertyGroupBytes;this.serializedBytesPerAnnotation=g,this.propertyOffsets=f,this.propertyGroupBytes=v,this.geometryDataStride=v[0]}getDependentShader(e,t){return Io(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(n,r)=>{const s=this.rank,o=this.properties,l=[],c=r.parseResult.code;for(let C=0,w=o.length;C<w;++C){const S=o[C],L=`prop_${S.identifier}`;c.match(new RegExp(`\\b${L}\\b`))&&(l.push(C),O_[S.type].defineShader(n,S.identifier,s))}const u=this.propertyOffsets,f=this.propertyGroupBytes,g=new Array(f.length);g[0]=0;for(let C=1;C<f.length;++C)g[C]=g[C-1]+f[C-1];n.addInitializer(C=>{const w=l.map(L=>C.vertexShaderInputBinders[`prop_${o[L].identifier}`]),S=w.length;C.vertexShaderInputBinders.properties={enable(L){for(let I=0;I<S;++I)w[I].enable(L)},bind(L,I){for(let R=0;R<S;++R){var M=u[l[R]];let D=M.group,T=M.offset;w[R].bind(f[D],I+T+g[D]*L)}},disable(){for(let L=0;L<S;++L)w[L].disable()}}}),n.addUniform("highp vec3","uColor"),n.addUniform("highp uint","uSelectedIndex"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec3","uSubspaceMatrix",s),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp float","uModelClipBounds",s*2),n.addUniform("highp uint","uPickID"),n.addVarying("highp uint","vPickID","flat"),n.addVertexCode(xd),n.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),n.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);const v=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;n.addVertexCode(v),n.addFragmentCode(v),n.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${s}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Cd(r,n),n.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setAxisColor(vec4 startColor, vec4 endColor);
void setAxisWidth(float width);
void setSphereColor(vec4 color);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerSize(float startSize, float endSize);
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize);

void setAxisPointMarkerColor(vec4 color);
void setAxisPointMarkerBorderColor(vec4 color);
void setAxisPointMarkerSize(float size);
void setAxisPointMarkerBorderWidth(float size);

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisColor(vec4 color) { setAxisColor(color, color); }
void setAxisColor(vec3 color) { setAxisColor(vec4(color, 1.0)); }
void setAxisColor(vec3 startColor, vec3 endColor) { setAxisColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerColor(vec3 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerColor(vec4 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec3 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec4 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerSize(float size) { setAxisEndpointMarkerSize(size, size); }
void setAxisEndpointMarkerBorderWidth(float size) { setAxisEndpointMarkerBorderWidth(size, size); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
  setAxisColor(color);
  setAxisEndpointMarkerColor(color);
  setSphereColor(color);
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(const C of ey){var y=oe(C,2);const w=y[0],S=y[1];w!==this.annotationType&&S.defineShaderNoOpSetters(n)}t(n),n.addVertexCode(`
#define main userMain
`+bd(r.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let n=`
void setPartIndex(${t.map((r,s)=>`highp uint partIndex${s}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((r,s)=>`highp uint pickOffset${s} = pickBaseOffset + partIndex${s};`).join(`
`)}
`;return t.length===0&&(n+=`
  highp uint pickOffset0 = pickBaseOffset;
`),n+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((r,s)=>` || selectedIndex == pickOffset${s}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(n),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,n){var r=e(t.renderContext.emitter);const s=r.shader,o=r.parameters;if(s===null)return;s.bind();const l=this.gl,c=t.renderContext,u=t.annotationLayer;if(Ao(l,s,this.shaderControlState,o.parseResult.controls),l.uniform3fv(s.uniform("uSubspaceMatrix"),t.subspaceMatrix),l.uniform1fv(s.uniform("uModelClipBounds"),t.modelClipBounds),l.uniformMatrix4fv(s.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),c.emitPickID&&l.uniform1ui(s.uniform("uPickID"),t.basePickId),c.emitColor){const g=u.state.displayState.color.value;l.uniform3f(s.uniform("uColor"),g[0],g[1],g[2]),l.uniform1ui(s.uniform("uSelectedIndex"),t.selectedIndex)}const f=s.vertexShaderInputBinders.properties;f.enable(1),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),f.bind(t.count,t.bufferOffset),n(s),f.disable()}}const ey=new ue;function $d(i,e){ey.set(i,e)}function sd(i){return ey.get(i)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ty=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s};class Ms{constructor(e){this.source=e,this.state=Et.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=Et.GPU_MEMORY}freeGPUMemory(e){this.state=Et.SYSTEM_MEMORY}}function Pw(i){if(typeof i!="number"||i<0)throw new Error(`Expected non-negative number as limit, but received: ${se(i)}`);return i}class Jc{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new ci(t,Pw),this.itemLimit=new ci(e,Pw)}}let qg=class extends ur{constructor(i,e,t,n){super(),this.gl=e,this.frameNumberCounter=t,this.capacities=n,this.visibleChunksChanged=new xe,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new Qt(!0,!0);const r=s=>({itemLimit:this.registerDisposer(Di.makeFromExisting(i,s.itemLimit)).rpcId,sizeLimit:this.registerDisposer(Di.makeFromExisting(i,s.sizeLimit)).rpcId});this.initializeCounterpart(i,{gpuMemoryCapacity:r(n.gpuMemory),systemMemoryCapacity:r(n.systemMemory),downloadCapacity:r(n.download),computeCapacity:r(n.compute),enablePrefetch:this.registerDisposer(Di.makeFromExisting(i,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let i=this.chunkUpdateDeadline,e;i===null||Date.now()<i?e=0:e=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(i=!1){let e=this.chunkUpdateDeadline;!i&&e===null&&(e=Date.now()+30);let t=!1,n=0;for(;;){if(!i&&Date.now()>e){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let r=this.pendingChunkUpdates;if(r==null)break;if(this.applyChunkUpdate(r)&&(t=!0),++n,(this.pendingChunkUpdates=r.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return t&&this.visibleChunksChanged.dispatch(),n}handleFetch_(i,e){var t=e.promise;const n=t.resolve,r=t.reject;if(t.cancellationToken.isCanceled){r(Es);return}const s=e.key,o=i.chunks.get(s);if(!o){r(new Error(`No chunk found at ${s} for source ${i.constructor.name}`));return}const l=o.data;if(!l){r(new Error(`At ${s} for source ${i.constructor.name}: chunk has no data`));return}n({value:l})}applyChunkUpdate(i){let e=!1;const t=this.rpc.get(i.source);if(i.promise!==void 0)this.handleFetch_(t,i);else if(i.id===void 0){for(const n of t.chunks.keys())t.deleteChunk(n);e=!0}else{let n=i.state;if(n===Et.EXPIRED)t.deleteChunk(i.id);else{let r,s=i.id;i.new?(r=t.getChunk(i),t.addChunk(s,r)):r=t.chunks.get(s);let o=r.state;if(n!==o)switch(n){case Et.GPU_MEMORY:r.copyToGPU(this.gl),e=!0;break;case Et.SYSTEM_MEMORY:r.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${Et[n]}`)}}}return e}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){const i=this.rpc,e=await i.promiseInvoke(dO,{queue:this.rpcId}),t=new ue;for(const r of e){var n=oe(r,2);const s=n[0],o=n[1],l=i.get(s);l!==void 0&&t.set(l,o)}return t}};qg=ty([Ln(aO)],qg);function GL(i,e){let t=i.get(e.source),n=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){n.applyChunkUpdate(e)&&n.visibleChunksChanged.dispatch();return}let r=n.pendingChunkUpdatesTail;r==null?(n.pendingChunkUpdates=e,n.pendingChunkUpdatesTail=e,n.scheduleChunkUpdate()):(r.nextUpdate=e,n.pendingChunkUpdatesTail=e)}_t("Chunk.update",function(i){GL(this,i)});hL("Chunk.retrieve",function(i,e){return new Ot((t,n)=>{i.promise={resolve:t,reject:n,cancellationToken:e},GL(this,i)})});_t(cO,function(i){const e=this.get(i.id);for(const t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(const t of i.layers){const n=this.get(t.id);if(n===void 0)continue;const r=n.layerChunkProgressInfo;r.numVisibleChunksAvailable=t.numVisibleChunksAvailable,r.numVisibleChunksNeeded=t.numVisibleChunksNeeded,r.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,r.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(r)}e.layerChunkStatisticsUpdated.dispatch()});let Yg=class extends ur{constructor(i){super(),this.chunkQueueManager=i,this.memoize=new HE,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new xe,this.registerDisposer(i.addRef()),this.initializeCounterpart(i.rpc,{chunkQueueManager:i.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(i,e){const t=i.encodeOptions(e);t.constructorId=Ci(i);const n=rn(t);return this.memoize.get(n,()=>{const r=new i(this,e);return r.initializeCounterpart(this.rpc,{}),r.key=t,r})}};Yg=ty([Ln(oO)],Yg);class Jr extends ur{constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new ue,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){const t=this.chunks.get(e);t.state===Et.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(lO,{id:this.rpcId})}static encodeOptions(e){return{}}}function Wt(i,e){let t=class extends i{constructor(...n){super(...n);const r=n[1];this.parameters=r.parameters}initializeCounterpart(n,r){r.parameters=this.parameters,super.initializeCounterpart(n,r)}static encodeOptions(n){return j({parameters:n.parameters},super.encodeOptions(n))}};return t=ty([Ln(e.RPC_ID)],t),t}class jd extends ur{constructor(e){super(),this.layerChunkProgressInfo=e}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Fn;(function(i){i[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"})(Fn||(Fn={}));class B_{}class __ extends K{constructor(e,t,n){super(),this.graph=e,this.segmentsState=t,this.transform=n}createRenderLayers(e,t,n){return[]}}function F_(i){return!(i.high>>>31)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const U_=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function z_(i,e,t){i.registerDisposer(e.visibleSegments.changed.add(t)),i.registerDisposer(e.segmentEquivalences.changed.add(t))}function G_(i,e,t){i.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),i.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function rr(i){return`${i.low},${i.high}`}function W_(i){return!!(i.high>>>31)}function WL(i){return i.useTemporaryVisibleSegments.value?i.temporaryVisibleSegments:i.visibleSegments}function $_(i){return i.useTemporarySegmentEquivalences.value?i.temporarySegmentEquivalences:i.segmentEquivalences}function Ko(i,e){const t=WL(i),n=$_(i);if(n.disjointSets){const r=n.disjointSets.visibleSegmentEquivalencePolicy.value;for(let s of t.unsafeKeys())if(r&Fn.NONREPRESENTATIVE_EXCLUDED){const o=n.get(s);e(s,o)}else{if(n.disjointSets===void 0||!n.disjointSets.isMinElement(s))continue;for(let o of n.setElements(s))r&Fn.REPRESENTATIVE_EXCLUDED&&r&Fn.MAX_REPRESENTATIVE&&W_(o)||e(o,s)}}}const oi=40,$L=.5,jL=-4;function fu(i){return(Yi(i)-jL)/$L}function j_(i){return 2**(i*$L+jL)}function ca(i){return new ci(i,gi)}class Mo{constructor(){this.visibility=new yd,this.changed=new xe,this.frameNumber=-1,this.spatialScales=new ue,this.numHistogramRows=1,this.value=new Uint32Array(oi*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,n,r){let s=this.spatialScales,o=this.numHistogramRows,l=this.value,c=s.get(e);if(c===void 0&&(c=s.size,s.set(e,c)),c>=o){this.numHistogramRows=o*=2;const f=new Uint32Array(o*oi*2);f.set(l),this.value=l=f}const u=c*oi*2+Math.min(Math.max(0,Math.round(fu(t))),oi-1);l[u]+=n,l[u+oi]+=r}}class iy extends gL{constructor(e,t,n){var r;super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new ue,this.visibleSourcesList_=[];var s=n.renderScaleTarget;const o=s===void 0?ca(1):s;this.renderScaleTarget=o,this.renderScaleHistogram=n.renderScaleHistogram,this.transform=n.transform,this.localPosition=n.localPosition,this.rpcTransfer=n.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer((r=n.dataHistogramSpecifications)!==null&&r!==void 0?r:new DL(aa([]),aa([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){const e=this.dataHistogramSpecifications;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){const n=this.visibleSources,r=n.get(e);r!==void 0?(++r.refCount,r.chunkTransform=t):(n.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){const t=this.visibleSources,n=t.get(e);n.refCount!==1?--n.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){const e=this.visibleSources,t=this.visibleSourcesList_;if(t.length===0&&e.size!==0){for(const n of e.values())t.push(n);t.sort((n,r)=>n.chunkTransform.chunkToLayerTransformDet-r.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){const e=this.registerDisposer(new jd(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,j({localPosition:this.registerDisposer(Di.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Di.makeFromExisting(t,this.renderScaleTarget)).rpcId},this.rpcTransfer)),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return v_(e,this,t)}}iy.prototype.RPC_TYPE_ID=b_;class Ro extends mL{draw(e,t){}isReady(e,t){return!0}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var H_=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s};class J_ extends p_{}const Z_=Vh(J_);function q_(i){return{source:i.source.addCounterpartRef(),effectiveVoxelSize:i.effectiveVoxelSize,layerRank:i.layerRank,nonDisplayLowerClipBound:i.nonDisplayLowerClipBound,nonDisplayUpperClipBound:i.nonDisplayUpperClipBound,lowerClipBound:i.lowerClipBound,upperClipBound:i.upperClipBound,lowerClipDisplayBound:i.lowerClipDisplayBound,upperClipDisplayBound:i.upperClipDisplayBound,chunkDisplayDimensionIndices:i.chunkDisplayDimensionIndices,lowerChunkDisplayBound:i.lowerChunkDisplayBound,upperChunkDisplayBound:i.upperChunkDisplayBound,fixedLayerToChunkTransform:i.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:i.combinedGlobalLocalToChunkTransform,chunkLayout:i.chunkLayout.toObject()}}function ny(i){return i.map(e=>e.map(q_))}function Bf(i,e){for(const t of e)for(const n of t){const r=n.source;i.removeSource(r),r.dispose()}}let Fu=class extends Z_{constructor(i,e,t,n){super(new vL({parametersConstructor:u_,navigationState:t,update:(o,l)=>{const c=o.invViewMatrix,u=o.centerDataPosition;l.toMat4(c);var f=o.displayDimensionRenderInfo;const g=f.canonicalVoxelFactors,v=f.voxelPhysicalScales;for(let D=0;D<3;++D)u[D]=c[12+D];const y=o.logicalWidth,C=o.logicalHeight,w=o.projectionMat,S=o.viewportNormalInGlobalCoordinates,L=o.viewportNormalInCanonicalCoordinates,I=l.relativeDepthRange;F1(w,-y/2,y/2,C/2,-C/2,-I,I),JE(o,w),XE(o);const M=o.viewMatrix;for(let D=0;D<3;++D){const T=S[D]=M[D*4+2];L[D]=T/g[D]}Cu(S,S),Cu(L,L);let R=0;for(let D=0;D<3;++D){const T=v[D],A=c[D];R+=(T*A)**2}R=Math.sqrt(R),o.pixelSize=R}})),this.chunkManager=i,this.layerManager=e,this.navigationState=t,this.wireFrame=n,this.gl=this.chunkManager.gl,this.viewChanged=new xe,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=new Array,this.offscreenFramebuffer=this.registerDisposer(new Do(this.gl,{colorBuffers:Bu(this.gl,1),depthBuffer:new LB(this.gl)})),this.histogramInputTextures=[],this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=Hv.get(this.gl),this.updateVisibleLayers=this.registerCancellable(ct(()=>{this.updateVisibleLayersNow()},0)),this.registerDisposer(t),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((o,l)=>{o.displayDimensionRenderInfo!==l.displayDimensionRenderInfo&&this.updateVisibleLayers()}));const r=this.chunkManager.rpc,s=this.sharedProjectionParameters=this.registerDisposer(new Ou(r,this.projectionParameters));this.initializeCounterpart(r,{chunkManager:i.rpcId,projectionParameters:s.rpcId}),this.registerDisposer(e.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(i.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(i,e){this.histogramGenerator.compute(i,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,e,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(i,e,t){C_(this.projectionParameters.value,i.renderLayer.localPosition.value,i,e,()=>{t(i.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let i=0,e=0;for(const t of this.visibleLayers.values()){const n=t.visibleSources;for(const r of n){const s=Qv(this.projectionParameters.value,r.chunkLayout),o=r.source.chunks;this.forEachVisibleChunk(r,s,l=>{const c=o.get(l);++e,c&&c.state===Et.GPU_MEMORY&&++i})}}return i===e}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(i,e){e.push(i.localPosition.changed.add(()=>this.invalidateVisibleChunks())),e.push(i.redrawNeeded.add(this.viewChanged.dispatch)),e.push(i.transform.changed.add(this.updateVisibleLayers)),e.push(i.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));const t=i.renderScaleHistogram;t!==void 0&&e.push(t.visibility.add(this.visibility)),e.push(i.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;const i=Date.now(),e=this.visibleLayers,t=this.visibleLayerList,n=this.projectionParameters.value.displayDimensionRenderInfo;let r=this.rpc,s={id:this.rpcId},o=!1;t.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof iy){t.push(c);let u=e.get(c);if(u===void 0){const f=[],g=new qo;u={messages:g,allSources:this.getTransformedSources(c,g),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:f,lastSeenGeneration:i,displayDimensionRenderInfo:n},f.push(c.messages.addChild(u.messages)),e.set(c.addRef(),u),this.bindVisibleRenderLayer(c,f)}else{u.lastSeenGeneration=i;const f=c.transform.changed.count;if(u.transformGeneration===f&&u.displayDimensionRenderInfo===n)continue;const g=u.allSources;u.allSources=this.getTransformedSources(c,u.messages),Bf(c,g),u.visibleSources.length=0,u.displayDimensionRenderInfo=n,u.transformGeneration=f}s.layerId=c.rpcId,s.sources=ny(u.allSources),this.flushBackendProjectionParameters(),r.invoke(S_,s),o=!0}for(const c of e){var l=oe(c,2);const u=l[0],f=l[1];f.lastSeenGeneration!==i&&(s.layerId=u.rpcId,r.invoke(w_,s),e.delete(u),Bf(u,f.allSources),wo(f.disposers),u.dispose(),o=!0)}return o&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),o}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(i){const e=this.offscreenFramebuffersWithHistograms;let t=e[i];if(t===void 0){const n=this.gl,r=this.histogramInputTextures,s=this.offscreenFramebuffer;r.length<i&&r.push(...Bu(n,i-r.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let o=[s.colorBuffers[0].addRef()];for(let l=0;l<i;++l)o.push(r[l].addRef());t=this.registerDisposer(new Do(n,{colorBuffers:o,depthBuffer:s.depthBuffer.addRef()})),e[i]=t}return t}updateRendering(){const i=this.projectionParameters.value,e=i.width,t=i.height;if(!this.renderingStale||!this.valid||e===0||t===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let n=this.gl,r=this.offscreenFramebuffer;r.bind(e,t),n.disable(n.SCISSOR_TEST),n.clearColor(0,0,0,0),n.colorMask(!0,!0,!0,!0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let s=0;const o=this.wireFrame.value,l={sliceView:this,projectionParameters:i,wireFrame:o};for(let c of this.visibleLayerList){const u=o?0:c.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(u).bind(e,t);for(let f=0;f<u;++f)n.clearBufferfv(WebGL2RenderingContext.COLOR,1+f,Ig);n.enable(WebGL2RenderingContext.DEPTH_TEST),n.depthFunc(WebGL2RenderingContext.LESS),n.clearDepth(1),n.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),c.setGLBlendMode(n,s),c.draw(l),++s}n.disable(WebGL2RenderingContext.BLEND),n.disable(WebGL2RenderingContext.DEPTH_TEST),r.unbind()}disposed(){for(const e of this.visibleLayers){var i=oe(e,2);const t=i[0],n=i[1];Bf(t,n.allSources),wo(n.disposers),t.dispose()}this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(i,e){const t=ry(this.projectionParameters.value.displayDimensionRenderInfo,i.transform.value,n=>i.getSources(n),e,i);for(const n of t)for(const r of n)i.addSource(r.source,r.chunkTransform);return t}};Fu=H_([Ln(y_)],Fu);class HL extends Jr{constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Te(e.chunkDataSize),lowerVoxelBound:Te(e.lowerVoxelBound),upperVoxelBound:Te(e.upperVoxelBound)}}static encodeOptions(e){const t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}}class JL extends Ms{constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=Et.SYSTEM_MEMORY}}let ZL=class qL extends K{constructor(e,t){super(),this.gl=e,this.copyVertexPositionsBuffer=wd(this.gl),this.textureCoordinateAdjustment=new Float32Array(4);let n=new da(e);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler"),n.addInitializer(r=>{e.uniform1i(r.uniform("uSampler"),0)}),n.addUniform("vec4","uColorFactor"),n.addUniform("vec4","uBackgroundColor"),n.addUniform("mat4","uProjectionMatrix"),n.addUniform("vec4","uTextureCoordinateAdjustment"),n.require(t),n.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),n.addAttribute("vec4","aVertexPosition"),n.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(n.build())}draw(e,t,n,r,s,o,l,c){let u=this.gl,f=this.shader,g=this.textureCoordinateAdjustment;g[0]=s,g[1]=o,g[2]=l-s,g[3]=c-o,f.bind(),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e),u.disable(WebGL2RenderingContext.BLEND),u.uniformMatrix4fv(f.uniform("uProjectionMatrix"),!1,t),u.uniform4fv(f.uniform("uColorFactor"),n),u.uniform4fv(f.uniform("uBackgroundColor"),r),u.uniform4fv(f.uniform("uTextureCoordinateAdjustment"),g);let v=f.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(v,2),u.drawArrays(u.TRIANGLE_FAN,0,4),u.disableVertexAttribArray(v),u.bindTexture(u.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${Ci(t)}`,()=>new qL(e,t))}};class Y_{constructor(e){this.chunkManager=e}}function ry(i,e,t,n,r){n.clearMessages();const s=L=>(n.addMessage({severity:lr.error,message:L}),[]);if(e.error!==void 0)return s(e.error);const o=e.rank,l=e.unpaddedRank,c=i.displayDimensionIndices,u=i.displayRank,f=i.canonicalVoxelFactors,g=zE(e,c),v=g.displayToLayerDimensionIndices,y=new Float32Array(u*l),C=e.modelToRenderLayerTransform;for(let L=0;L<u;++L){const I=v[L];if(I===-1)continue;const M=f[L];for(let R=0;R<l;++R)y[u*R+L]=C[(o+1)*R+I]*M}const w=t({displayRank:u,multiscaleToViewTransform:y,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),S=i.voxelPhysicalScales;try{const L=I=>{const M=I.chunkSource,R=M.spec;var D=I.lowerClipBound;const T=D===void 0?R.lowerVoxelBound:D;var A=I.upperClipBound;const V=A===void 0?R.upperVoxelBound:A,O=UE(e,I.chunkToMultiscaleTransform),_=R.chunkDataSize,H=O.channelToChunkDimensionIndices,U=new Float32Array(l),B=new Float32Array(l);U.set(T),B.set(V);const W=H.length,F=e.channelSpaceShape;for(let Ge=0;Ge<W;++Ge){const De=H[Ge];if(De===-1)continue;const St=F[Ge];if(_[De]!==St)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[Ge]]+` has extent ${St} but corresponding chunk dimension has extent ${_[De]}`);U[De]=Number.NEGATIVE_INFINITY,B[De]=Number.POSITIVE_INFINITY}const le=GE(O,g),de=Ne(),Re=Ne(),ce=Ne(),Le=Ne(),Be=Ne(),qe=le.numChunkDisplayDims,Ze=le.chunkDisplayDimensionIndices,it=O.combinedGlobalLocalToChunkTransform,ot=O.layerRank,ze=O.combinedGlobalLocalRank,Pe=new Float32Array(it);for(let Ge=0;Ge<qe;++Ge){const De=Ze[Ge];for(let St=0;St<=ze;++St)Pe[De+St*ot]=0;De<l?(Be[Ge]=R.chunkDataSize[De],de[Ge]=R.lowerChunkBound[De],Re[Ge]=R.upperChunkBound[De],ce[Ge]=T[De],Le[Ge]=V[De],U[De]=Number.NEGATIVE_INFINITY,B[De]=Number.POSITIVE_INFINITY):(Be[Ge]=1,de[Ge]=0,Re[Ge]=1,ce[Ge]=0,Le[Ge]=1)}Be.fill(1,qe),de.fill(0,qe),Re.fill(1,qe),ce.fill(0,qe),Le.fill(1,qe);const Ue=new Fh(Be,le.displaySubspaceModelMatrix,qe),We=Ue.localSpatialVectorToGlobal(Ne(),H1);for(let Ge=0;Ge<u;++Ge)We[Ge]=Math.abs(We[Ge]*S[Ge]);return We.fill(1,u),{layerRank:ot,lowerClipBound:T,upperClipBound:V,nonDisplayLowerClipBound:U,nonDisplayUpperClipBound:B,renderLayer:r,source:M,lowerChunkDisplayBound:de,upperChunkDisplayBound:Re,lowerClipDisplayBound:ce,upperClipDisplayBound:Le,effectiveVoxelSize:We,chunkLayout:Ue,chunkDisplayDimensionIndices:Ze,fixedLayerToChunkTransform:Pe,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:O.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:O,chunkDisplayTransform:le}};return w.map(I=>I.map(M=>L(M)))}catch(L){for(const R of w)for(const D of R)D.chunkSource.dispose();const I=i.globalDimensionNames,M=`Cannot render (${Te(i.displayDimensionIndices.filter(R=>R!==-1),R=>I[R]).join(", ")}) cross section: ${L.message}`;return s(M)}}let qs=null;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var K_=200;class tt{constructor(e=!1){if(qs===null){qs=document.createElement("ul"),qs.id="statusContainer";const n=document.getElementById("neuroglancer-container");n?n.appendChild(qs):document.body.appendChild(qs)}let t=document.createElement("li");this.element=t,e===!0&&(e=K_),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,qs.appendChild(t)}dispose(){qs.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let n=new tt(t.delay);n.setText(t.initialMessage);let r=n.dispose.bind(n);return e.then(r,s=>{let o;s instanceof Error?o=s.message:o=""+s;var l=t.errorPrefix;let c=l===void 0?"":l;n.setErrorMessage(c+o),n.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){const t=new tt;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){const n=this.showMessage(e);return window.setTimeout(()=>n.dispose(),t),n}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var sy=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s};function YL(i){let e=0;const t=i.typeToIds;for(const n of Br)e+=sd(n).pickIdsPerInstance*t[n].length;return e}class KL{constructor(e){this.bufferValid=!1,this.numPickIds=0,this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){const t=this.buffer;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class X_ extends Ms{constructor(e,t){super(e),t.data!==void 0&&(this.data=new KL(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class XL extends JL{constructor(e,t){super(e,t),t.data!==void 0&&(this.data=new KL(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}let No=class extends HL{constructor(i,e){super(i,e),this.immediateChunkUpdates=!0,(this.parent=e.parent).spatiallyIndexedSources.add(this);var t=this.spec;const n=t.rank,r=t.chunkDataSize,s=this.multiscaleToChunkTransform=new Float32Array((n+1)**2);Tv(s,n+1,this.spec.chunkToMultiscaleTransform,n+1,n+1);for(let o=0;o<n;++o)for(let l=0;l<n+1;++l)s[(n+1)*l+o]/=r[o]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(i,e){e.parent=this.parent.rpcId,super.initializeCounterpart(i,e)}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new XL(this,i)}};No=sy([Ln(E_)],No);let Kg=class extends Jr{constructor(i,e,t){super(i,{}),this.parent=e,this.relationshipIndex=t,this.immediateChunkUpdates=!0}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new X_(this,i)}};Kg=sy([Ln(L_)],Kg);class Q_ extends Ms{constructor(e,t){super(e),this.annotation=Lv(t.annotation)}}let Xg=class extends Jr{constructor(i,e){super(i),this.parent=e}getChunk(i){return new Q_(this,i)}addChunk(i,e){super.addChunk(i,e);const t=this.parent.references.get(i);t!==void 0&&(t.value=e.annotation,t.changed.dispatch())}deleteChunk(i){const e=this.parent.references.get(i);e!==void 0&&(e.value=void 0,e.changed.dispatch())}};Xg=sy([Ln(x_)],Xg);function QL(i,e,t,n){const r=new Uint8Array(i.data.length+n);for(const s of Br){if(s===t)continue;let o=i.typeToOffset[s],l=o;s>t&&(l+=n,i.typeToOffset[s]=l),r.set(i.data.subarray(o,o+i.typeToIds[s].length*e[s].serializedBytes),l)}return r}function Qg(i,e,t,n,r,s,o,l){const c=i.typeToOffset[t];let u=c,f=c;const g=e[t].propertyGroupBytes,v=g.length,y=i.typeToIds[t].length;for(let C=0;C<v;++C){const w=g[C];n.set(i.data.subarray(u+r*w,u+s*w),f+o*w),u+=w*y,f+=w*l}}function Zc(i,e,t){const n=e.type,r=t[n].rank,s=i.serializedAnnotations,o=s.typeToIds[n],l=s.typeToIdMaps[n],c=Ui[n],u=t[n].serializedBytes;let f=l.get(e.id);if(f===void 0){f=l.size,l.set(e.id,f);const w=QL(s,t,n,u);Qg(s,t,n,w,0,f,0,f+1),o.push(e.id),s.data=w}const g=s.typeToOffset[n],v=new DataView(s.data.buffer,s.data.byteOffset,s.data.byteLength),y=Vd===an.LITTLE,C=t[n];c.serialize(v,g+C.propertyGroupBytes[0]*f,y,r,e),C.serialize(v,g,f,o.length,y,e.properties),i.bufferValid=!1}function qc(i,e,t,n){const r=i.serializedAnnotations,s=r.typeToIdMaps[e],o=s.get(t);if(o===void 0)return!1;const l=r.typeToIds[e],c=n[e].serializedBytes,u=QL(r,n,e,-c);Qg(r,n,e,u,0,o,0,l.length-1),Qg(r,n,e,u,o+1,l.length,o,l.length-1),l.splice(o,1),s.delete(t);for(let f=o,g=l.length;f<g;++f)s.set(l[f],f);return r.data=u,i.bufferValid=!1,!0}function e3(){const i=[],e=[],t=[];for(const n of Br)i[n]=[],e[n]=0,t[n]=new ue;return new XL(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:i,typeToIdMaps:t})}class Un extends ur{constructor(e,t){super(),this.chunkManager=e,this.metadataChunkSource=this.registerDisposer(new Xg(this.chunkManager,this)),this.spatiallyIndexedSources=new je,this.temporary=e3(),this.references=new ue,this.localUpdates=new ue,this.numCommitsInProgress=0,this.changed=new xe,this.referencesChanged=new at,this.readonly=!1,this.childRefreshed=new xe,this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=xv(this.rank,this.properties);const n=this.segmentFilteredSources=[],r=t.relationships;this.relationships=r;for(let s=0,o=r.length;s<o;++s)n.push(this.registerDisposer(new Kg(e,this,s)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(const n of this.segmentFilteredSources)n.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(n=>n.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=Ev();const n=new cu(e.id);return n.value=e,this.references.set(n.id,n),this.referencesChanged.dispatch({action:"adding",id:n.id}),n.registerDisposer(()=>{this.references.delete(n.id),this.referencesChanged.dispatch({action:"deref",id:n.id})}),this.applyLocalUpdate(n,!1,t,e),n}applyLocalUpdate(e,t,n,r){const s=this.localUpdates,o=e.id;let l=this.localUpdates.get(o);const c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},s.set(o,l),this.forEachPossibleChunk(c,u=>{const f=u.data;if(f===void 0)return;const g=c.type;qc(f,g,o,this.annotationPropertySerializers)}),r!==null&&Zc(this.temporary.data,r,this.annotationPropertySerializers)):(r===null?qc(this.temporary.data,c.type,c.id,this.annotationPropertySerializers):Zc(this.temporary.data,r,this.annotationPropertySerializers),e.value=r),n)if(l.commitInProgress!==void 0)l.pendingCommit=r;else{if(r===null&&l.existingAnnotation===void 0){s.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,r)}this.notifyChanged(e.id,r||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(T_,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){const n=this.references.get(e),r=this.metadataChunkSource.chunks.get(e);r!==void 0&&(r.annotation=t||null),n!==void 0&&(n.value=t||null,n.changed.dispatch(),this.referencesChanged.dispatch({action:"changed",id:e})),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}updateReference(e){let t=this.references.get(e.id);if(t!==void 0)t.value=e;else{let n=new cu(e.id);this.references.set(e.id,n),n.value=e,this.referencesChanged.dispatch({action:"update",id:n.id}),n.registerDisposer(()=>{this.references.delete(n.id),this.referencesChanged.dispatch({action:"deref",id:n.id})})}}hasReference(e){return this.references.has(e)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new cu(e),this.references.set(e,t),this.referencesChanged.dispatch({action:"get",id:e}),this.rpc.invoke(k_,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.referencesChanged.dispatch({action:"deref",id:e}),this.rpc.invoke(I_,{id:this.rpcId,annotation:e})});const n=this.metadataChunkSource.chunks.get(e);return n!==void 0&&n.annotation!==null&&(t.value=n.annotation),t}forEachPossibleChunk(e,t){const n=e.relatedSegments;if(n!==void 0){const c=n.length,u=this.segmentFilteredSources;for(let f=0;f<c;++f){const g=n[f];if(g===void 0)return;const v=u[f];for(const y of g){const C=v.chunks.get(rr(y));C!==void 0&&t(C)}}}const r=this.rank,s=new Float32Array(r),o=new Float32Array(r),l=new Float32Array(r);for(const c of this.spatiallyIndexedSources){switch(e.type){case Me.POINT:Nr(s,c.multiscaleToChunkTransform,r+1,e.point,r),o.set(s);break;case Me.LINE:case Me.SPHERE:case Me.AXIS_ALIGNED_BOUNDING_BOX:Nr(s,c.multiscaleToChunkTransform,r+1,e.pointA,r),Nr(o,c.multiscaleToChunkTransform,r+1,e.pointB,r);break;case Me.ELLIPSOID:Nr(s,c.multiscaleToChunkTransform,r+1,e.center,r),wE(o,c.multiscaleToChunkTransform,r+1,e.radii,r);for(let g=0;g<r;++g){const v=s[g],y=o[g];s[g]=v-y,o[g]=v+y}break}let u=1;for(let g=0;g<r;++g){const v=s[g],y=o[g],C=Math.min(v,y),w=Math.max(v,y);s[g]=Math.ceil(C-1),o[g]=Math.floor(w+1),u*=o[g]-s[g]}const f=c.chunks;for(let g=0;g<u;++g){let v=g;for(let C=0;C<r;++C){const w=s[C],S=o[C]-w,L=l[C]=v%S;v=(v-L)/S}const y=f.get(l.join());y!==void 0&&t(y)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&n.reference.id!==t.id){if(n.commitInProgress===null)throw new Error("Received invalid successful update notification");n.reference.id=t.id,this.references.delete(e),this.references.set(t.id,n.reference.addRef()),this.localUpdates.delete(e),this.localUpdates.set(t.id,n),n.reference.value!==null&&(n.reference.value.id=t.id,qc(this.temporary.data,n.type,e,this.annotationPropertySerializers),Zc(this.temporary.data,n.reference.value,this.annotationPropertySerializers)),n.reference.changed.dispatch()}let r=n.existingAnnotation===void 0;n.existingAnnotation=t||void 0,n.commitInProgress=void 0;let s=n.pendingCommit;n.pendingCommit=void 0,t===null&&(s=void 0),s!==void 0?(s!==null&&(s.id=t.id),this.sendCommitRequest(n,s)):(this.revertLocalUpdate(n),r?(this.childAdded.dispatch(t),this.referencesChanged.dispatch({action:"added",id:t.id})):t===null?(this.references.get(e).dispose(),this.childDeleted.dispatch(e),this.referencesChanged.dispatch({action:"deleted",id:e})):(this.childUpdated.dispatch(t),this.referencesChanged.dispatch({action:"updated",id:t.id})))}disposed(){const e=this.commitStatus;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new tt(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid update notification");new tt().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(n),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){qc(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);const t=e.existingAnnotation;t!==void 0&&this.forEachPossibleChunk(t,s=>{const o=s.data;o!==void 0&&Zc(o,t,this.annotationPropertySerializers)});const n=e.reference,r=n.id;n.value=t||null,n.changed.dispatch(),n.dispose(),this.localUpdates.delete(r)}*[Wi](){}}_t(D_,function(i){const e=this.get(i.id),t=i.annotationId,n=i.error;if(n!==void 0)e.handleFailedUpdate(t,n);else{const r=Lv(i.newAnnotation);e.handleSuccessfulUpdate(t,r)}});/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Hd(i,e){return i<e?-1:i>e?1:0}const ek={offset:0,completions:[]};function Xo(i,e){return e.offset+=i,e}function _f(i,e){let t=[];for(let n of e)n.startsWith(i)&&t.push({value:n});return t.sort((n,r)=>Hd(n.value,r.value)),t}function Qo(i,e,t,n){let r=[];for(let s of e){let o=t(s);o.startsWith(i)&&r.push({value:o,description:n(s)})}return r.sort((s,o)=>Hd(s.value,o.value)),r}async function t3(i,e,t){if(i.startsWith("{"))return ek;const n=i.match(/^(?:(.*)[&;])?([^&;]*)$/)[2];let r=i.length-n.length;const s=n.indexOf("=");if(s===-1){const o=await e(n);return{offset:o.offset+r,completions:o.completions.map(l=>j(j({},l),{value:`${l.value}=`}))}}return Xo(r+s+1,await t(n.substring(0,s),n.substring(s+1)))}async function tk(i,e){return t3(i,async t=>{const n=[];for(const r of e){const s=r.key;s.value.startsWith(t)&&n.push(s)}return{offset:0,completions:n}},async(t,n)=>{for(const r of e)if(r.key.value===t)return{offset:0,completions:r.values.filter(s=>s.value.startsWith(n))};return ek})}class ik extends Error{constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function nk(i,e){e===void 0&&(i.indexOf("/")===-1?e=":":e="/");let t=i.lastIndexOf(e);return t===-1?0:t+1}function i3(i,e){let t=nk(i,e);return i.substring(t)}var zr;(function(i){i[i.annotations=0]="annotations",i[i.equivalences=1]="equivalences"})(zr||(zr={}));function rk(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new ue}}class ba extends K{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}const sk="local://annotations",em="local://equivalences";class n3 extends ba{get description(){return"Local in-memory"}async get(e){switch(e.url){case sk:{const t=e.transform;let n;if(t===void 0){const r=e.globalCoordinateSpace.value,s=r.rank,o=r.names,l=r.scales,c=r.units,u=mt({rank:s,scales:l,units:c,names:o.map((g,v)=>`${v}`)}),f=mt({rank:s,scales:l,units:c,names:o});n={rank:s,sourceRank:s,inputSpace:u,outputSpace:f,transform:Ts(Float64Array,s+1)}}else n=Xi(Lo);return{modelTransform:n,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:zr.annotations}}]}}case em:return{modelTransform:Xi(Lo),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:zr.equivalences}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:Qo(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}}const Aw=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class r3 extends K{constructor(e){super(),this.credentialsManager=e,this.dataSources=new ue([["local",new n3]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){const t=e.match(Aw);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');var n=oe(t,3);const r=n[1],s=n[2],o=this.dataSources.get(r);if(o===void 0)throw new Error(`Unsupported data source: ${se(r)}.`);return[o,s,r]}async get(e){const t=new je;var n=e.cancellationToken;const r=n===void 0?qt:n;let s=e.url;for(;;){var o=this.getProvider(e.url),l=oe(o,3);const c=l[0],u=l[1],f=l[2];t.add(e.url);try{return c.get(j(j({},e),{url:s,providerProtocol:f,providerUrl:u,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager}))}catch(g){if(g instanceof ik){const v=g.redirectTarget;if(t.has(v))throw Error(`Layer source redirection contains loop: ${se(Te(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${se(Te(t))}`);s=v;continue}throw g}}}convertLegacyUrl(e){try{var t=this.getProvider(e.url),n=oe(t,3);const r=n[0],s=n[1],o=n[2];return r.convertLegacyUrl(j(j({},e),{providerUrl:s,providerProtocol:o,registry:this}))}catch{return e.url}}normalizeUrl(e){try{var t=this.getProvider(e.url),n=oe(t,3);const r=n[0],s=n[1],o=n[2];return r.normalizeUrl(j(j({},e),{providerUrl:s,providerProtocol:o,registry:this}))}catch{return e.url}}async completeUrl(e){const t=e.url;var n=e.cancellationToken;const r=n===void 0?qt:n;let s=t.match(Aw),o=s[1];if(o===void 0)return Ot.resolve({offset:0,completions:Qo(t,this.dataSources,([l])=>`${l}://`,([,l])=>l.description)});{const l=this.dataSources.get(o);if(l!==void 0){const c=await l.completeUrl({registry:this,url:t,providerUrl:s[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return Xo(o.length+3,c)}throw null}}suggestLayerName(e){var t=this.getProvider(e),n=oe(t,2);let r=n[0],s=n[1];s.endsWith("/")&&(s=s.substring(0,s.length-1));let o=r.suggestLayerName;return o!==void 0?o(s):i3(s)}findSourceGroup(e){var t=this.getProvider(e),n=oe(t,3);let r=n[0],s=n[1],o=n[2];return(r.findSourceGroup||nk)(s)+o.length+3}}var s3=vh,a3=p1,o3=dv,l3=mM.f,ak=function(i){return function(e){for(var t=o3(e),n=a3(t),r=n.length,s=0,o=[],l;r>s;)l=n[s++],(!s3||l3.call(t,l))&&o.push(i?[l,t[l]]:t[l]);return o}},Mw=Yt,d3=ak(!0);Mw(Mw.S,"Object",{entries:function(i){return d3(i)}});var c3=Ct.Object.entries,u3={default:c3,__esModule:!0};const Jd=It(u3);var h3=bh,Ff=fh.getWeak,p3=jo,Rw=ks,f3=Sh,g3=Ho,ok=fv,Nw=vM,Vw=ga,m3=ok(5),v3=ok(6),y3=0,Yc=function(i){return i._l||(i._l=new lk)},lk=function(){this.a=[]},Uf=function(i,e){return m3(i.a,function(t){return t[0]===e})};lk.prototype={get:function(i){var e=Uf(this,i);if(e)return e[1]},has:function(i){return!!Uf(this,i)},set:function(i,e){var t=Uf(this,i);t?t[1]=e:this.a.push([i,e])},delete:function(i){var e=v3(this.a,function(t){return t[0]===i});return~e&&this.a.splice(e,1),!!~e}};var dk={getConstructor:function(i,e,t,n){var r=i(function(s,o){f3(s,r,e,"_i"),s._t=e,s._i=y3++,s._l=void 0,o!=null&&g3(o,t,s[n],s)});return h3(r.prototype,{delete:function(s){if(!Rw(s))return!1;var o=Ff(s);return o===!0?Yc(Vw(this,e)).delete(s):o&&Nw(o,this._i)&&delete o[this._i]},has:function(s){if(!Rw(s))return!1;var o=Ff(s);return o===!0?Yc(Vw(this,e)).has(s):o&&Nw(o,this._i)}}),r},def:function(i,e,t){var n=Ff(p3(e),!0);return n===!0?Yc(i).set(e,t):n[i._i]=t,i},ufstore:Yc},Ow=dk,b3=ga,Bw="WeakSet";wh(Bw,function(i){return function(){return i(this,arguments.length>0?arguments[0]:void 0)}},{add:function(i){return Ow.def(b3(this,Bw),i,!0)}},Ow,!1,!0);Ch("WeakSet");xh("WeakSet");var S3=Ct.WeakSet,w3={default:S3,__esModule:!0};const C3=It(w3);var x3=D1,E3=cv,L3="Expected a function";function k3(i,e,t){var n=!0,r=!0;if(typeof i!="function")throw new TypeError(L3);return E3(t)&&(n="leading"in t?!!t.leading:n,r="trailing"in t?!!t.trailing:r),x3(i,e,{leading:n,maxWait:e,trailing:r})}var I3=k3;const Uh=It(I3);function T3(i){return typeof i=="boolean"?{enabled:i}:(ge(i),{enabled:we(i,"enabled",oa)})}function ad(i,e=void 0){return typeof i=="string"?{url:i,transform:e,enableDefaultSubsources:!0,subsources:new ue}:(ge(i),{url:Y(i,"url",Ie),transform:Y(i,"transform",OE)||e,enableDefaultSubsources:we(i,"enableDefaultSubsources",oa,!0),subsources:we(i,"subsources",t=>Th(t,T3),new ue)})}function D3(i){return i.enabled}function _w(i){const e=BE(i.transform),t={};let n=!0;for(const s of i.subsources){var r=oe(s,2);const o=r[0],l=r[1],c=D3(l);c!==void 0&&(t[o]=c,n=!1)}return e===void 0&&n&&i.enableDefaultSubsources===!0?i.url:{url:i.url,transform:e,subsources:n?void 0:t,enableDefaultSubsources:i.enableDefaultSubsources===!0?void 0:!1}}class P3{constructor(e,t,n,r,s){this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=n,this.subsourceIndex=r,this.activated=void 0,this.guardValues=[],this.messages=new qo,this.isActiveChanged=new xe;let o;n===void 0||n.enabled===void 0?o=t.default&&s:o=n.enabled;const l=e.dataSource.modelTransform.sourceRank;let c=t.modelSubspaceDimensionIndices;if(c===void 0){c=new Array(l);for(let g=0;g<l;++g)c[g]=g}var u=t.subsourceToModelSubspaceTransform;const f=u===void 0?Ts(Float32Array,c.length+1):u;this.enabled=o,this.subsourceToModelSubspaceTransform=f,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(_e(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;const n=this.activated=new K;e(n),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:lr.error,message:e});const t=this.activated;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){const t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){const t=this.activated;var n=this.loadedDataSource;const r=n.layer,s=n.transform;return t.registerDisposer(FE(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,s,this,e))}}class ay extends K{constructor(e,t,n){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new xe,this.activatedSubsourcesChanged=new xe,this.messages=new qo,t.canChangeModelSpaceRank?(this.transform=new KS(Xi(mt({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new KS(t.modelTransform),n.transform!==void 0&&(this.transform.spec=n.transform);const r=n.subsources;this.enableDefaultSubsources=n.enableDefaultSubsources,this.subsources=t.subsources.map((s,o)=>new P3(this,s,r.get(s.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(const e of this.subsources){const t=e.activated;t!==void 0&&(e.activated=void 0,t.dispose())}}}class A3 extends K{constructor(e,t=void 0){super(),this.layer=e,this.changed=new xe,this.messages=new qo,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=rk():this.spec=t}get spec(){const e=this.loadState;if(e!==void 0&&e.error===void 0){const t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new ue(Te(e.subsources,n=>{const r=e.enableDefaultSubsources&&n.subsourceEntry.default;return[n.subsourceEntry.id,{enabled:n.enabled!==r?n.enabled:void 0}]}))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){const t=this.layer;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){const c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}const n=new K,r=n.registerDisposer(M1(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=n,this.spec_=e;const s=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new Ps;this.messages.addMessage({severity:lr.info,message:"Loading data source"}),o.get({chunkManager:s,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then(c=>{if(n.wasDisposed)return;this.messages.clearMessages();const u=n.registerDisposer(new ay(this,c,e));u.registerDisposer(t.addCoordinateSpace(u.transform.outputSpace)),u.registerDisposer(u.transform.changed.add(this.changed.dispatch)),this.loadState_=u,u.registerDisposer(u.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),r()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:lr.error,message:c.message}),this.changed.dispatch())}),n.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){const e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){const e=this.loadState;return e===void 0||e.error!==void 0?_w(this.spec):_w({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new ue(Te(e.subsources,t=>{const n=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==n?t.enabled:void 0}]}))})}}var Fw,Uw;function M3(){return Uw||(Uw=1,Fw=Object.is||function(i,e){return i===e?i!==0||1/i===1/e:i!=i&&e!=e}),Fw}var zw=Yt;zw(zw.S,"Object",{is:M3()});var R3=Ct.Object.is,N3={default:R3,__esModule:!0};const Gw=It(N3);var Ww,$w;function V3(){return $w||($w=1,Ww=Math.sign||function(i){return(i=+i)==0||i!=i?i:i<0?-1:1}),Ww}var jw=Yt;jw(jw.S,"Math",{sign:V3()});var O3=Ct.Math.sign,B3={default:O3,__esModule:!0};const Ed=It(B3);var Hw=Hr,_3=fv(0),F3=pM,ck=fh,U3=hM,zh=dk,uk=ks,Jw=ga,z3=ga,G3=!Hw.ActiveXObject&&"ActiveXObject"in Hw,Uu="WeakMap",W3=ck.getWeak,$3=Object.isExtensible,j3=zh.ufstore,zf,hk=function(i){return function(){return i(this,arguments.length>0?arguments[0]:void 0)}},pk={get:function(i){if(uk(i)){var e=W3(i);return e===!0?j3(Jw(this,Uu)).get(i):e?e[this._i]:void 0}},set:function(i,e){return zh.def(Jw(this,Uu),i,e)}},H3=wh(Uu,hk,pk,zh,!0,!0);z3&&G3&&(zf=zh.getConstructor(hk,Uu),U3(zf.prototype,pk),ck.NEED=!0,_3(["delete","has","get","set"],function(i){var e=H3.prototype,t=e[i];F3(e,i,function(n,r){if(uk(n)&&!$3(n)){this._f||(this._f=new zf);var s=this._f[i](n,r);return i=="set"?this:s}return t.call(this,n,r)})}));Ch("WeakMap");xh("WeakMap");var J3=Ct.WeakMap,Z3={default:J3,__esModule:!0};const fk=It(Z3);function Li(i,e,t){we(i,e,n=>t.restoreState(n))}class Gh extends K{constructor(){super(...arguments),this.children=new ue,this.changed=new xe}add(e,t){if(this.children.has(e))throw new Error(`Key ${se(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){const t=this.children;if(t.has(e))throw new Error(`Key ${se(e)} not registered.`);const n=t.get(e);this.children.delete(e),n.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){const e=this.changed;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){const e=this.baseJSON();for(let n of this.children){var t=oe(n,2);let r=t[0],s=t[1];e[r]=s.toJSON()}return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){ge(e);for(let n of this.children){var t=oe(n,2);let r=t[0],s=t[1];try{if(e.hasOwnProperty(r)){const o=e[r];if(o===void 0)continue;s.restoreState(o)}}catch(o){throw new Error(`Error restoring property ${se(r)}: ${o.message}`)}}}}const Zw=new fk;function Wh(i){let e=Zw.get(i);const t=i.changed.count;if(e!==void 0&&e.generation===t)return e;let n;if(i instanceof Gh){n=i.baseJSON();for(let s of i.children){var r=oe(s,2);let o=r[0],l=r[1];n[o]=Wh(l).value}}else n=i.toJSON();return e===void 0?(e={generation:t,value:n},Zw.set(i,e)):(e.generation=t,e.value=n),e}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $h{constructor(e,t,n=t){this.enumType=e,this.value_=t,this.defaultValue=n,this.changed=new xe}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=Ti(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}}var zt;(function(i){i[i.LINKED=0]="LINKED",i[i.RELATIVE=1]="RELATIVE",i[i.UNLINKED=2]="UNLINKED"})(zt||(zt={}));var zu;(function(i){i[i.LINKED=0]="LINKED",i[i.UNLINKED=2]="UNLINKED"})(zu||(zu={}));class q3 extends $h{constructor(e=zt.LINKED){super(zt,e)}}class Y3 extends $h{constructor(e=zu.LINKED){super(zu,e)}}const Kc=Ne(),gk=zi();function Zd(i,e,t,n){let r=!1,s;i.registerDisposer(e);const o=()=>{switch(r=!0,t.value){case zt.UNLINKED:if(n.isValid(i))break;case zt.LINKED:n.assign(i,e);break;case zt.RELATIVE:n.add(i,e,s);break}r=!1},l=()=>{if(!r)switch(t.value){case zt.UNLINKED:break;case zt.LINKED:n.assign(e,i);break;case zt.RELATIVE:n.subtract(e,i,s);break}};let c=zt.UNLINKED;const u=()=>{const f=t.value;if(f!==c)switch(f){case zt.UNLINKED:s=void 0;break;case zt.LINKED:s=void 0,n.assign(i,e);break;case zt.RELATIVE:s=n.difference(i,e);break}c=f,i.changed.dispatch()};return i.registerDisposer(i.changed.add(l)),i.registerDisposer(e.changed.add(o)),i.registerDisposer(t.changed.add(u)),u(),i}function mk(i,e,t,n){return Zd(i,e,t,n)}class Qs extends K{constructor(e){super(),this.coordinateSpace=e,this.coordinates_=Eo,this.changed=new xe,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=Eo,this.changed.dispatch()}set value(e){const t=this.curCoordinateSpace;t===void 0||!t.valid||t.rank!==e.length||(this.coordinates_.set(e),this.changed.dispatch())}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const n=e.rank;if(!e.valid)return;if(t===void 0||!t.valid){let f=this.coordinates_;if(!(f!==void 0&&f.length===n)){f=this.coordinates_=new Float32Array(n),NV(f,e.bounds);for(let g=0;g<n;++g)f[g]=Math.floor(f[g])+.5}this.changed.dispatch();return}const r=new Float32Array(n),s=this.coordinates_,o=e.ids,l=e.scales,c=t.ids,u=t.scales;for(let f=0;f<n;++f){const g=o[f],v=c.indexOf(g);v===-1?r[f]=TE(e.bounds.lowerBounds[f],e.bounds.upperBounds[f]):r[f]=s[v]*(u[v]/l[f])}this.coordinates_=r,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();const e=this.value;if(e.length!==0)return Te(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(He(e,Tt)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();const e=this.coordinates_,t=e.length;for(let n=0;n<t;++n)e[n]=Math.floor(e[n])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();const t=e.curCoordinateSpace,n=e.coordinates_;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(n),this.changed.dispatch()}static getOffset(e,t){const n=e.coordinates_,r=t.coordinates_;if(n.length===r.length)return Og(new Float32Array(n.length),n,r)}static addOffset(e,t,n,r=1){e.handleCoordinateSpaceChanged();const s=t.value;n!==void 0&&s.length===n.length&&(LV(e.value,s,n,r),e.changed.dispatch())}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}ge(t),Li(t,"voxelCoordinates",e)}}}}function vk(i,e,t){if(t===void 0||di(t).length===0){i.value=zt.LINKED;return}ge(t),i.value=zt.UNLINKED,Y(t,"value",n=>{n!==void 0&&e.restoreState(n)}),Y(t,"link",n=>i.restoreState(n))}class qd{constructor(e,t=new q3){this.peer=e,this.link=t}get changed(){return this.value.changed}toJSON(){const e=this.link;if(e.value!==zt.LINKED)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=zt.LINKED}restoreState(e){vk(this.link,this.value,e)}copyToPeer(){this.link.value!==zt.LINKED&&(this.link.value=zt.UNLINKED,this.peer.assign(this.value),this.link.value=zt.LINKED)}}class yk extends qd{constructor(e,t=new Y3){super(e,t)}}class bk extends qd{constructor(){super(...arguments),this.value=Zd(new Qs(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:Qs.getOffset,add:Qs.addOffset,subtract:(e,t,n)=>{Qs.addOffset(e,t,n,-1)}})}}function K3(i){return i[0]===0&&i[1]===0&&i[2]===0&&i[3]===1}class Vo extends K{constructor(e){super(),this.changed=new xe,e==null&&(e=zi()),this.orientation=e}toJSON(){let e=this.orientation;if(cd(this.orientation,this.orientation),!K3(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{go(this.orientation,e),cd(this.orientation,this.orientation)}catch{NS(this.orientation)}this.changed.dispatch()}reset(){NS(this.orientation),this.changed.dispatch()}snap(){let e=Rd();B1(e,this.orientation);let t=[!1,!1,!1];for(let n=0;n<3;++n){let r=0,s=0;for(let o=0;o<3;++o){let l=e[n*3+o];e[n*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(r)&&(r=l,s=o)}e[n*3+s]=Ed(r),t[s]=!0}W1(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let n=new Vo(vs(zi(),e.orientation,t)),r=!1;n.registerDisposer(e.changed.add(()=>{r||(s=!0,vs(n.orientation,e.orientation,t),n.changed.dispatch(),s=!1)}));let s=!1;const o=xu(zi(),t);return n.registerDisposer(n.changed.add(()=>{s||(r=!0,vs(e.orientation,n.orientation,o),e.changed.dispatch(),r=!1)})),n}assign(e){uN(this.orientation,e.orientation),this.changed.dispatch()}}class tm extends qd{constructor(){super(...arguments),this.value=Zd(new Vo,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{const n=zi();return vs(n,xu(n,t.orientation),e.orientation)},add:(e,t,n)=>{vs(e.orientation,t.orientation,n),e.changed.dispatch()},subtract:(e,t,n)=>{vs(e.orientation,t.orientation,xu(gk,n)),e.changed.dispatch()}})}}class Sk extends K{constructor(e){super(),this.coordinateSpace=e,this.changed=new xe,this.curCoordinateSpace=Ur,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Ur,this.changed.dispatch()}toJSON(){const e={};let t=!1;const n=this.value.factors;var r=this.curCoordinateSpace;const s=r.names,o=r.rank;for(let l=0;l<o;++l){const c=n[l];c!==1&&(e[s[l]]=c,t=!0)}if(t)return e}restoreState(e){const t=this.coordinateSpace.value,n=t.names,r=t.rank,s=new Float64Array(r);if(s.fill(-1),e!==void 0){const o=ge(e);for(let l=0;l<r;++l)s[l]=Y(o,n[l],c=>c===void 0?1:gi(c))}this.value_={factors:s},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){const t=this.coordinateSpace.value;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){const e=this.coordinateSpace.value;let t=this.value_;const n=this.curCoordinateSpace;if(n===e)return t;const r=n.ids,s=e.ids,o=e.rank,l=t.factors,c=new Float64Array(o);c.fill(1);for(let u=0;u<o;++u){const f=s[u],g=r.indexOf(f);g!==-1&&(c[u]=l[g])}return _e(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function qw(i,e,t,n,r){if(t===n)return e;const s=t.ids,o=n.rank,l=n.ids,c=new i(o);for(let u=0;u<o;++u){const f=l[u],g=s.indexOf(f);c[u]=g===-1?r(u):e[g]}return c}class X3 extends qd{constructor(){super(...arguments),this.value=Zd(new Sk(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{const n=e.value.factors,r=e.coordinateSpace.value,s=t.value.factors;return{coordinateSpace:r,offsets:Og(new Float64Array(n.length),n,s)}},add:(e,t,n)=>{const r=qw(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(LE(new Float64Array(r.length),r,t.value.factors))},subtract:(e,t,n)=>{const r=qw(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Og(new Float64Array(r.length),t.value.factors,r))},isValid:()=>!0})}}function Yw(i,e,t){const n=i.rank,r=i.names,s=i.units,o=e.displayRank,l=e.displayDimensionIndices,c=new Float64Array(3);let u=new Float64Array(3),f;const g=t.factors,v=new Array(3),y=new Float64Array(3);if(c.fill(1),u.fill(1),y.fill(1),v.fill(""),o===0)f=1;else{f=Number.POSITIVE_INFINITY;const C=i.scales;for(let w=0;w<o;++w){const S=l[w],L=u[w]=g[S]*C[S];f=Math.min(f,L),v[w]=s[S],y[w]=C[S]}for(let w=0;w<o;++w)c[w]=u[w]/f}return{globalRank:n,globalDimensionNames:r,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:v,displayDimensionScales:y,canonicalVoxelFactors:c,voxelPhysicalScales:u,canonicalVoxelPhysicalSize:f}}function Q3(i,e){return _e(i.globalDimensionNames,e.globalDimensionNames)&&_e(i.displayDimensionIndices,e.displayDimensionIndices)&&_e(i.canonicalVoxelFactors,e.canonicalVoxelFactors)&&_e(i.voxelPhysicalScales,e.voxelPhysicalScales)&&i.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&_e(i.displayDimensionUnits,e.displayDimensionUnits)&&_e(i.displayDimensionScales,e.displayDimensionScales)}class wk extends K{constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new xe,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=Yw(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);const n=()=>{this.value};this.registerDisposer(e.changed.add(n)),this.registerDisposer(t.changed.add(n))}get value(){var e=this.relativeDisplayScales;const t=e.value,n=e.coordinateSpace.value,r=this.displayDimensions.value,s=this.curRelativeDisplayScales,o=this.curDisplayDimensions,l=this.curCoordinateSpace;let c=this.value_;if(s!==t||o!==r||l!==n){this.curRelativeDisplayScales=t,this.curDisplayDimensions=r,this.curCoordinateSpace=n;const u=Yw(n,r,t);Q3(c,u)||(this.value_=c=u,this.changed.dispatch())}return c}}class Ck extends K{constructor(e){super(),this.coordinateSpace=e,this.changed=new xe,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){const e=this.coordinateSpace.value,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}const n=new Int32Array(3),r=t.coordinateSpace.ids,s=e.ids,o=t.displayDimensionIndices,l=t.displayRank;let c=0;for(let u=0;u<l;++u){const f=s.indexOf(r[o[u]]);f!==-1&&(n[c]=f,++c)}if(n.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,n),this.changed.dispatch()}setToDefault(e){const t=Math.min(e.rank,3),n=new Int32Array(3);n.fill(-1);for(let r=0;r<t;++r)n[r]=r;this.assignValue(e,t,n)}assignValue(e,t,n){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:n},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}const t=Nv(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");const n=this.coordinateSpace.value,r=new Int32Array(3);r.fill(-1);const s=n.names;let o=0;for(const l of t){const c=s.indexOf(l);c!==-1&&(r[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(n,o,r)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;const e=this.value,t=[],n=e.displayRank,r=e.displayDimensionIndices,s=e.coordinateSpace.names;if(n!==0){for(let o=0;o<n;++o)t[o]=s[r[o]];return t}}assign(e){if(e.default)this.default=!0;else{var t=e.value;const n=t.displayRank,r=t.displayDimensionIndices;this.setDimensionIndices(n,r)}}}class eF extends yk{constructor(e){super(e),this.value=mk(new Ck(this.peer.coordinateSpace),this.peer,this.link,{assign:(t,n)=>t.assign(n),isValid:()=>!0})}}class Oo extends K{constructor(e,t,n){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=n,this.changed=new xe,this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(n.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=Kc){var n=this.position;const r=n.coordinateSpace.value,s=n.value;var o=this.displayDimensions.value;const l=o.displayDimensionIndices,c=o.displayRank;if(r===void 0)return!1;t.fill(0);for(let u=0;u<c;++u){const f=l[u];t[u]=s[f]}if(e(t)!==!1){for(let u=0;u<c;++u){const f=l[u];s[f]=t[u]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){tN(e,this.orientation.orientation);const n=this.position.value;var r=this.displayDimensionRenderInfo.value;const s=r.canonicalVoxelFactors,o=r.displayDimensionIndices;for(let l=0;l<3;++l){const c=o[l],u=t/s[l];e[l]*=u,e[4+l]*=u,e[8+l]*=u,e[12+l]=n[c]||0}}toMat3(e,t){B1(e,this.orientation.orientation);var n=this.displayDimensionRenderInfo.value;const r=n.canonicalVoxelFactors,s=n.displayRank;for(let o=0;o<s;++o){const l=t/r[o];e[o]*=l,e[3+o]*=l,e[6+o]*=l}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;const n=this.position,r=n.value;var s=n.coordinateSpace.value.bounds;const o=s.lowerBounds,l=s.upperBounds;let c=r[e]+t;if(t>0){const u=l[e];kt(u)&&(c=Math.min(c,Math.ceil(u-1)))}else{const u=o[e];kt(u)&&(c=Math.max(c,Math.floor(u)))}r[e]=c,n.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;const n=fo(Kc,e,this.orientation.orientation),r=this.position,s=r.value;var o=this.displayDimensions.value;const l=o.displayDimensionIndices,c=o.displayRank;var u=r.coordinateSpace.value.bounds;const f=u.lowerBounds,g=u.upperBounds;for(let v=0;v<c;++v){const y=l[v],C=n[v];if(C===0)continue;let w=s[y]+C;if(C>0){const S=g[y];kt(S)&&(w=Math.min(w,Math.ceil(S-1)))}else{const S=f[y];kt(S)&&(w=Math.max(w,Math.floor(S)))}t&&(w=Math.floor(w)+.5),s[y]=w}this.position.changed.dispatch()}rotateRelative(e,t){var n=zi();kg(n,e,t);var r=this.orientation.orientation;vs(r,r,n),this.orientation.changed.dispatch()}rotateAbsolute(e,t,n){var r=this.position;const s=r.coordinateSpace.value,o=r.value;if(s===void 0)return;const l=this.relativeDisplayScales.value.factors;var c=this.displayDimensions.value;const u=c.displayDimensionIndices,f=c.displayRank,g=s.scales,v=zi();kg(v,e,t);const y=this.orientation.orientation,C=Kc;Kc.fill(0);for(let S=0;S<f;++S){const L=u[S],I=n[L]-o[L];C[S]=I*g[L]*l[L]}const w=xu(gk,y);fo(C,C,w),vs(y,v,y),fo(C,C,y);for(let S=0;S<f;++S){const L=u[S];o[L]=n[L]-C[S]/(g[L]*l[L])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;const n=this.displayDimensions.value.displayDimensionIndices,r=this.position.coordinateSpace.value.rank;for(let s=0;s<r;++s)if(n.indexOf(s)===-1&&e--===0){this.translateDimensionRelative(s,t);return}}}class im extends qd{constructor(e,t){super(e),this.value=(()=>{const n=new e.constructor(t),r=(u,f)=>{u.assign(f)},s=(u,f)=>u.value/f.value*(u.canonicalVoxelPhysicalSize/f.canonicalVoxelPhysicalSize),o=(u,f,g)=>{u.setPhysicalScale(f.value*g,f.canonicalVoxelPhysicalSize)},l=(u,f,g)=>{u.setPhysicalScale(f.value/g,f.canonicalVoxelPhysicalSize)},c=u=>u.coordinateSpaceValue.valid&&u.canonicalVoxelPhysicalSize!==0;return Zd(n,this.peer,this.link,{assign:r,isValid:c,difference:s,add:o,subtract:l}),n})()}}function Ld(i){return{changed:i.changed,toJSON(){return i.toJSON()},restoreState(e){vk(i.link,i.value.legacyJsonView,e)},reset(){i.reset()}}}class xk extends K{constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new xe,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){const t=this.canonicalVoxelPhysicalSize;Gw(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Gw(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){const e=this.value_;var t=this.displayDimensionRenderInfo;const n=t.value.canonicalVoxelPhysicalSize,r=t.relativeDisplayScales.coordinateSpace.value,s=this.curCanonicalVoxelPhysicalSize;if(!(!tr(e)&&n===s)){if(!tr(e)){s!==0&&(this.value_=e*(s/n),this.curCanonicalVoxelPhysicalSize=n,this.changed.dispatch());return}!r.valid||n===0||(this.curCanonicalVoxelPhysicalSize=n,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){const e=this.value;return tr(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=gi(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=gi(t)}}}setPhysicalScale(e,t){const n=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/n)}assign(e){const t=e.legacyValue;tr(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class tF extends xk{getDefaultValue(){const e=this.legacyValue_;if(tr(e))return 1;const t=this.canonicalVoxelPhysicalSize;return this.legacyValue_*1e-9/t}}class iF extends xk{getDefaultValue(){const e=this.legacyValue_;if(!tr(e)){this.legacyValue_=Number.NaN;const u=this.canonicalVoxelPhysicalSize;return 2*100*Math.tan(Math.PI/8)*1e-9*e/u}var t=this.coordinateSpaceValue.bounds;const n=t.lowerBounds,r=t.upperBounds;var s=this.displayDimensionRenderInfo.value;const o=s.canonicalVoxelFactors,l=s.displayDimensionIndices;let c=o.reduce((u,f,g)=>{const v=l[g],y=(r[v]-n[v])*f;return Math.max(u,y)},0);return kt(c)?c=2**Math.ceil(Yi(c)):c=1024,c}}class nm extends K{constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new xe,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let e=this.value_;if(e>0){const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize,n=this.canonicalVoxelPhysicalSize;t!==n&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=n/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){const e=this.value;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!kt(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){const n=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;e=e*(t/n)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class Kw extends yk{constructor(e,t){super(e),this.value=mk(new nm(e.defaultValue,t),this.peer,this.link,{assign:(n,r)=>n.assign(r),isValid:()=>!0})}}class Bo extends K{constructor(e,t,n){super(),this.pose=e,this.zoomFactor=t,this.depthRange=n,this.changed=new xe,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(n),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!tr(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nF="mesh/MeshLayer",rF="mesh/MultiscaleMeshLayer",sF="mesh/FragmentSource",aF="mesh/MultiscaleFragmentSource";var _r;(function(i){i[i.float32=0]="float32",i[i.uint10=1]="uint10",i[i.uint16=2]="uint16"})(_r||(_r={}));/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function oF(i,e,t){return i&1|e<<1&2|t<<2&4}function lF(i,e,t,n,r,s,o){const l=i.octree,c=i.lodScales,u=i.chunkGridSpatialOrigin,f=i.chunkShape,g=c.length-1,v=e[0],y=e[4],C=e[8],w=e[1],S=e[5],L=e[9],I=e[3],M=e[7],R=e[11],D=e[15],T=I>0?0:1,A=M>0?0:1,V=R>0?0:1,O=t[4*4],_=t[4*4+1],H=t[4*4+2],U=t[4*4+3];function B(Pe,Ue,We){return I*Pe+M*Ue+R*We+D}function W(Pe,Ue,We,Ge,De,St){return B(Pe+T*(Ge-Pe),Ue+A*(De-Ue),We+V*(St-We))}const F=B(-U*O,-U*_,-U*H),le=i.clipLowerBound[0],de=i.clipLowerBound[1],Re=i.clipLowerBound[2],ce=i.clipUpperBound[0],Le=i.clipUpperBound[1],Be=i.clipUpperBound[2],qe=Math.sqrt((v*r)**2+(w*s)**2),Ze=Math.sqrt((y*r)**2+(S*s)**2),it=Math.sqrt((C*r)**2+(L*s)**2),ot=Math.max(qe,Ze,it);function ze(Pe,Ue,We){const Ge=1<<Pe,De=Ue*5,St=l[De],dn=l[De+1],ei=l[De+2],X=l[De+3],ee=l[De+4];let ie=St*Ge*f[0]+u[0],fe=dn*Ge*f[1]+u[1],Ee=ei*Ge*f[2]+u[2],ye=ie+Ge*f[0],Je=fe+Ge*f[1],rt=Ee+Ge*f[2];if(ie=Math.max(ie,le),fe=Math.max(fe,de),Ee=Math.max(Ee,Re),ye=Math.min(ye,ce),Je=Math.min(Je,Le),rt=Math.min(rt,Be),q1(ie,fe,Ee,ye,Je,rt,t)){const lt=Math.max(F,W(ie,fe,Ee,ye,Je,rt))/ot;if(We===0||lt*n<We){const dt=c[Pe];if(dt!==0&&o(Pe,Ue,dt/lt,ee>>>31),Pe>0&&(dt===0||lt*n<dt)){const Pt=dt===0?We:dt,jt=(ee&2147483647)>>>0;for(let Ke=X;Ke<jt;++Ke)ze(Pe-1,Ke,Pt)}}}}ze(g,l.length/5-1,0)}function Xw(i,e,t,n,r,s,o,l){const c=i.lodScales;let u=0;for(;u+1<c.length&&c[u+1]!==0;)++u;const f=3,g=[];let v=0,y=0;function C(L,I){for(;;){if(v===0)return;const M=v-1,R=u-M,D=g[M*f],T=R===0?1:8,A=g[M*f+1],V=g[M*f+2];if(L===v){const O=I&T-1;y!==O&&D!==-1&&l(R,D,y,O,V),y=O+1;return}y!==T&&D!==-1&&l(R,D,y,T,V),y=A+1,--v}}let w=0;const S=i.octree;lF(i,e,t,n,r,s,(L,I,M,R)=>{if(!R&&!o(L,I,M)){w=Math.max(L,w);return}if(L<w)return;w=0;const D=I*5,T=S[D],A=S[D+1],V=S[D+2],O=oF(T,A,V),_=u-L;C(_,O);const H=_*f;g[H]=R?-1:I,g[H+1]=O,g[H+2]=M,y=0,v=_+1}),C(0,0)}function Ek(i,e,t){return`${i}/${e}:${t}`}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class el extends mL{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dF=3432918353,cF=461845907;function Gu(i,e){return e>>>=0,i>>>=0,e=ir(e,dF)>>>0,e=(e<<15|e>>>17)>>>0,e=ir(e,cF)>>>0,i=(i^e)>>>0,i=(i<<13|i>>>19)>>>0,i=i*5+3864292196>>>0,i}var uF=Ct.Symbol.for,hF={default:uF,__esModule:!0};const pF=It(hF),rm=3,fF=.8;let Ir=0,Tr=0,Qw=0,eC=0;class kd{constructor(e=kd.generateHashSeeds(rm)){this.hashSeeds=e,this.loadFactor=fF,this.size=0,this.emptyLow=4294967295,this.emptyHigh=4294967295,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=kd.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){const t=this.hashSeeds.length,n=new Array(t);for(let c=0;c<t;++c)n[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let r=this.mungedEmptyKey;if(r===-1)e:for(;;){r=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let u=this.getHash(c,r,r);for(let f=0;f<t;++f)if(n[f]===u)continue e}this.mungedEmptyKey=r;break}let s=this.table,o=this.emptyLow,l=this.emptyHigh;for(let c=0;c<t;++c){let u=n[c];s[u]===o&&s[u+1]===l&&(s[u]=r,s[u+1]=r)}try{e(s)}finally{for(let c=0;c<t;++c){let u=n[c];s[u]===r&&s[u+1]===r&&(s[u]=o,s[u+1]=l)}}}static generateHashSeeds(e=rm){return iV(new Uint32Array(e))}getHash(e,t,n){let r=this.hashSeeds[e];return r=Gu(r,t),r=Gu(r,n),this.entryStride*(r&this.tableSize-1)}*keys(){let e=this.emptyLow,t=this.emptyHigh,n=this.entryStride,r=this.table;for(let s=0,o=r.length;s<o;s+=n){let l=r[s],c=r[s+1];(l!==e||c!==t)&&(yield new re(l,c))}}*unsafeKeys(e=new re){let t=this.emptyLow,n=this.emptyHigh,r=this.entryStride,s=this.table;for(let o=0,l=s.length;o<l;o+=r){let c=s[o],u=s[o+1];(c!==t||u!==n)&&(e.low=c,e.high=u,yield e)}}indexOfPair(e,t){let n=this.table,r=this.emptyLow,s=this.emptyHigh;if(e===r&&t===s)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){let c=this.getHash(o,e,t);if(n[c]===e&&n[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let e=this.emptyLow,t=this.emptyHigh,n=this.table,r=this.entryStride,s,o;for(;s=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(s===e&&o===t)&&!this.hasPair(s,o)););this.emptyLow=s,this.emptyHigh=o;for(let l=0,c=n.length;l<c;l+=r)n[l]===e&&n[l+1]===t&&(n[l]=s,n[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let n=this.table;return n[t]=this.emptyLow,n[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let e=this.table,t=this.entryStride,n=this.emptyLow,r=this.emptyHigh,s=e.length;for(let o=0;o<s;o+=t)e[o]=n,e[o+1]=r}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){let n=Ir,r=Tr;this.storePending(e,t),e[t]=n,e[t+1]=r}storePending(e,t){Ir=e[t],Tr=e[t+1]}backupPending(){Qw=Ir,eC=Tr}restorePending(){Ir=Qw,Tr=eC}tryToInsert(){let e=0,t=this.emptyLow,n=this.emptyHigh,r=this.maxAttempts,s=this.table,o=this.hashSeeds.length,l=Math.floor(Math.random()*o);for(;;){let c=this.getHash(l,Ir,Tr);if(this.swapPending(s,c),Ir===t&&Tr===n)return!0;if(++e===r)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;let t=this.entryStride;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let n=this.emptyLow,r=this.emptyHigh,s=this.entryStride;for(let o=0,l=e.length;o<l;o+=s){let c=e[o],u=e[o+1];if((c!==n||u!==r)&&(this.storePending(e,o),!this.tryToInsert()))return!1}return!0}grow(e){let t=this.table,n=this.tableSize;for(;n<e;)n*=2;for(;;){for(let r=0;r<this.maxRehashAttempts;++r)if(this.rehash(t,n))return;n*=2}}insertInternal(){for(++this.generation,Ir===this.emptyLow&&Tr===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class Lk extends kd{add(e){let t=e.low,n=e.high;return this.hasPair(t,n)?!1:(Ir=t,Tr=n,this.insertInternal(),!0)}[Wi](){return this.unsafeKeys()}}Lk.prototype.entryStride=2;let jl=0,Hl=0,tC=0,iC=0;class oy extends kd{set(e,t){let n=e.low,r=e.high;return this.hasPair(n,r)?!1:(Ir=n,Tr=r,jl=t.low,Hl=t.high,this.insertInternal(),!0)}get(e,t){let n=this.indexOf(e);if(n===-1)return!1;let r=this.table;return t.low=r[n+2],t.high=r[n+3],!0}swapPending(e,t){let n=jl,r=Hl;super.swapPending(e,t),e[t+2]=n,e[t+3]=r}storePending(e,t){super.storePending(e,t),jl=e[t+2],Hl=e[t+3]}backupPending(){super.backupPending(),tC=jl,iC=Hl}restorePending(){super.restorePending(),jl=tC,Hl=iC}[Wi](){return this.unsafeEntries()}*entries(){let e=this.emptyLow,t=this.emptyHigh,n=this.entryStride,r=this.table;for(let s=0,o=r.length;s<o;s+=n){let l=r[s],c=r[s+1];if(l!==e||c!==t){let u=new re(l,c),f=new re(r[s+2],r[s+3]);yield[u,f]}}}*unsafeEntries(e=[new re,new re]){let t=this.emptyLow,n=this.emptyHigh,r=this.entryStride,s=this.table;var o=oe(e,2);let l=o[0],c=o[1];for(let u=0,f=s.length;u<f;u+=r){let g=s[u],v=s[u+1];(g!==t||v!==n)&&(l.low=g,l.high=v,c.low=s[u+2],c.high=s[u+3],yield e)}}}oy.prototype.entryStride=4;class jh{}const Ys=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],gF=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],Xc=["","r","rg","rgb","rgba"],mF=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],vF=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],yF=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],bF=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],nC=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],SF=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],wF=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function ly(i){return i===J.FLOAT32?"":iE[i]?"i":"u"}function Yd(i,e,t=1){switch(e){case J.UINT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=mF[t],i.textureFormat=Ys[t],i.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint8Array,i.samplerPrefix="u",i;case J.INT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=vF[t],i.textureFormat=Ys[t],i.texelType=WebGL2RenderingContext.BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Int8Array,i.samplerPrefix="i",i;case J.UINT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=yF[t],i.textureFormat=Ys[t],i.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint16Array,i.samplerPrefix="u",i;case J.INT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=bF[t],i.textureFormat=Ys[t],i.texelType=WebGL2RenderingContext.SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Int16Array,i.samplerPrefix="i",i;case J.UINT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=nC[t],i.textureFormat=Ys[t],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case J.INT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=SF[t],i.textureFormat=Ys[t],i.texelType=WebGL2RenderingContext.INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Int32Array,i.samplerPrefix="i",i;case J.UINT64:if(t<1||t>2)break;return i.texelsPerElement=1,i.textureInternalFormat=nC[t*2],i.textureFormat=Ys[t*2],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=2*t,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case J.FLOAT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=wF[t],i.textureFormat=gF[t],i.texelType=WebGL2RenderingContext.FLOAT,i.arrayElementsPerTexel=t,i.arrayConstructor=Float32Array,i.samplerPrefix="",i}throw new Error(`No supported texture format for ${J[e]}[${t}].`)}function dy(i,e,t){const n=e.arrayConstructor,r=e.arrayElementsPerTexel,s=e.textureInternalFormat,o=e.textureFormat,l=e.texelsPerElement,c=i.maxTextureSize,u=t.length/r;if(u*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+u);const f=Math.ceil(u/c),g=Math.ceil(Yi(f)),v=(1<<g)*l,y=Math.ceil(u/(1<<g)),C=v*y*r;t.constructor!==n&&(t=new n(t.buffer,t.byteOffset,t.byteLength/n.BYTES_PER_ELEMENT));let w=c2(t,C);i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),To(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,v,y,0,o,e.texelType,w)}function CF(i,e,t,n,r){const s=e.arrayConstructor,o=e.textureInternalFormat,l=e.textureFormat,c=e.texelsPerElement;t.constructor!==s&&(t=new s(t.buffer,t.byteOffset,t.byteLength/s.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),To(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,n*c,r,0,l,e.texelType,t)}function xF(i,e,t,n,r,s){const o=e.arrayConstructor,l=e.textureInternalFormat,c=e.textureFormat,u=e.texelsPerElement;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),mB(i),i.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,n*u,r,s,0,c,e.texelType,t)}function EF(i){switch(i){case J.UINT8:return EL;case J.INT8:return LL;case J.UINT16:return kL;case J.INT16:return IL;case J.UINT32:return $v;case J.INT32:return TL;case J.UINT64:return Gt;case J.FLOAT32:return Wv}}function kk(i,e,t,n,r,s){const o=wi(r,s);let l=[EF(r)],c=`
${o} ${i}(${n} index) {
`;switch(r){case J.UINT8:case J.UINT16:case J.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Xc[s]};
  return result;
`;break;case J.INT8:case J.INT16:case J.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Xc[s]};
  return result;
`;break;case J.UINT64:l.push(TB),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${Xc[s*2]});
`;break;case J.FLOAT32:l.push(Wv),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${Xc[s]};
`;break}return c+=`
}
`,l.push(c),l}class cy{constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let n=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let r=0;r<e;++r)n+=`, out ${t}vec4 output${r}`;n+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let r=0;r<e;++r)n+=`
  output${r} = texelFetch(sampler, ivec2(x + ${r}, y), 0);
`;return n+=`
}
`,[NB,n]}getAccessor(e,t,n,r=1){const s=ly(n);return[this.getReadTextureValueCode(1,s),...kk(e,this.readTextureValue,t,"highp uint",n,r)]}}class LF{constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){const n=this.textureDims;let r=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${n} p`;for(let s=0;s<e;++s)r+=`, out ${t}vec4 output${s}`;r+=`) {
`;for(let s=0;s<e;++s)r+=`
  output${s} = texelFetch(sampler, ivec${n}(p.x * ${e} + ${s}, p.y
                                         ${n===3?", p.z":""}), 0);
`;return r+=`
}
`,r}getAccessor(e,t,n,r=1){const s=ly(n);return[this.getReadTextureValueCode(1,s),...kk(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,n,r)]}}const Ik=[Gt,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],kF=Yd(new jh,J.UINT64,1);class Jl extends K{constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){let e=this.hashTable,t=e.generation;if(this.generation===t)return;const n=this.gl,r=this.texture;this.generation=t,n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r),e.tableWithMungedEmptyKey(s=>{dy(this.gl,kF,s)}),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}}class Tk{constructor(e,t=rm){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=pF(`gpuhashtable:${this.prefix}`),this.accessHelper=new cy(`gpuhashtable_${this.prefix}`),this.samplerName=this.prefix+"_sampler",this.hashSeedsName=this.prefix+"_seeds",this.hashKeyMask=this.prefix+"_keyMask",this.readTable=this.prefix+"_readTable"}defineShader(e){let t=this.hashSeedsName,n=this.samplerName,r=this.numAlternatives,s=this.hashKeyMask;e.addUniform("highp uint",t,r),e.addUniform("highp uint",s),e.addTextureSampler("usampler2D",n,this.textureUnitSymbol),e.addFragmentCode(Ik),e.addFragmentCode(Gt),e.addFragmentCode(wL),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,J.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<r;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${s};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,n){n.copyToGPU();const r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n.texture),e.uniform1ui(t.uniform(this.hashKeyMask),n.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),n.hashTable.hashSeeds)}disable(e,t){const n=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class Dk extends Tk{defineShader(e){super.defineShader(e);let t=this.numAlternatives,n=this.hashSeedsName,r=this.hashKeyMask,s=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)s+=`
  {
    uint h = hashCombine(${n}[${o}], x) & ${r};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;s+=`
  return false;
}
`,e.addFragmentCode(s)}get getFunctionName(){return`${this.prefix}_get`}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wu(i,e,t,n){e*=6;let r=Math.floor(e),s=e-r,o=n*(1-t),l=n*(1-t*s),c=n*(1-t*(1-s));switch(r%6){case 0:i[0]=n,i[1]=c,i[2]=o;break;case 1:i[0]=l,i[1]=n,i[2]=o;break;case 2:i[0]=o,i[1]=n,i[2]=c;break;case 3:i[0]=o,i[1]=l,i[2]=n;break;case 4:i[0]=c,i[1]=o,i[2]=n;break;case 5:i[0]=n,i[1]=o,i[2]=l;break}return i}function IF(i,e,t,n){const r=Math.max(Math.max(e,t),n),s=Math.min(Math.min(e,t),n);if(i[2]=r,s===r)i[0]=0,i[1]=0;else{const o=r-s;i[1]=o/r,e===r?i[0]=(t-n)/o:t===r?i[0]=2+(n-e)/o:i[0]=4+(e-t)/o,i[0]/=6,i[0]<0&&(i[0]+=1),i[0]>1&&(i[0]-=1)}return i}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const rC=2;class TF{constructor(e){this.prefix=e,this.seedName=this.prefix+"_seed"}defineShader(e){const t=this.seedName;e.addUniform("highp uint",t),e.addFragmentCode(Gt),e.addFragmentCode(Ik),e.addFragmentCode(IB);let n=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${rC} v;
`;for(let r=0;r<rC;++r)n+=`
  v[${r}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;n+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(n)}enable(e,t,n){e.uniform1ui(t.uniform(this.seedName),n)}}let sC=new Float32Array(3);function Pk(i){return`rgb(${i[0]*100}%,${i[1]*100}%,${i[2]*100}%)`}class uy{constructor(e=jS()){this.hashSeed=e,this.changed=new xe}static getDefault(){return new uy(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let n=Gu(this.hashSeed,t.low);n=Gu(n,t.high);const r=(n&255)/255,s=(n>>8&255)/255;return Wu(e,r,.5+.5*s,1),e}computeCssColor(e){return this.compute(sC,e),Pk(sC)}randomize(){this.hashSeed=jS(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){const t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class DF{constructor(e){this.prefix=e,this.hashMapShaderManager=new Dk("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec3 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,n){this.hashMapShaderManager.enable(e,t,n)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}const Ak="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYXJyb3dMZWZ0SWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iYXJyb3dMZWZ0SWNvblRpdGxlIj5BcnJvdyBMZWZ0PC90aXRsZT4gICAgCiAgICA8cGF0aCBkPSJNOSA2bC02IDYgNiA2Ii8+CiAgICA8cGF0aCBkPSJNMjEgMTJINCIvPgogICAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBkPSJNMyAxMmgxIi8+Cjwvc3ZnPg==",Mk="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYXJyb3dSaWdodEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImFycm93UmlnaHRJY29uVGl0bGUiPkFycm93IFJpZ2h0PC90aXRsZT4gICAgCiAgICA8cGF0aCBkPSJNMTUgMThsNi02LTYtNiIvPgogICAgPHBhdGggZD0iTTMgMTJoMTciLz4KICAgIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTIxIDEyaC0xIi8+Cjwvc3ZnPg==";/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class PF{constructor(e){if(this.parents=new Array,this.parentPriorities=new Array,this.bindings=new ue,e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(const n of e.bindings){var t=oe(n,2);const r=t[0],s=t[1];this.bindings.set(r,s)}}}addParent(e,t){const n=this.parents,r=this.parentPriorities;let s=0;const o=n.length;for(;s<o&&t<r[s];)++s;return n.splice(s,0,e),r.splice(s,0,t),()=>{this.removeParent(e)}}removeParent(e){const t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){const t=this.parents,n=this.parentPriorities,r=n.length;let s=0,o;for(;s<r&&n[s]>0;++s)if(o=t[s].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;s<r;++s)if(o=t[s].get(e),o!==void 0)return o}*getAll(e){const t=this.parents,n=this.parentPriorities,r=n.length;let s=0,o;for(;s<r&&n[s]>0;)o=t[s].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);s<r;)o=t[s].get(e),o!==void 0&&(yield o)}*entries(){const e=this.parents,t=this.parentPriorities,n=t.length;let r=0;for(;r<n&&t[r]>0;++r)yield*e[r].entries();for(yield*this.bindings.entries();r<n;++r)yield*e[r].entries()}}var aC;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(aC||(aC={}));function hy(i){return(i.ctrlKey?1:0)|(i.altKey?2:0)|(i.metaKey?4:0)|(i.shiftKey?8:0)}function sm(i,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=i,t}function AF(i,e,t){let n="";return e&1&&(n+="control+"),t&1&&(n+="control?+"),e&2&&(n+="alt+"),t&2&&(n+="alt?+"),e&4&&(n+="meta+"),t&4&&(n+="meta?+"),e&8&&(n+="shift+"),t&8&&(n+="shift?+"),n+=i,n}function oC(i){const e=i.indexOf(":");let t;if(e!==-1&&(t=i.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${se(t)}`);const n=i.substring(e+1).split("+");let r,s=0,o=0;e:for(let l of n)switch(l){case"control":s|=1;break;case"control?":o|=1;break;case"alt":s|=2;break;case"alt?":o|=2;break;case"meta":s|=4;break;case"meta?":o|=4;break;case"shift":s|=8;break;case"shift?":o|=8;break;default:if(r===void 0)r=l;else{r=void 0;break e}}if(r===void 0||s&o)throw new Error(`Invalid event identifier: ${se(i)}`);return{phase:t,keyName:r,modifiers:s,optionalModifiers:o}}function*MF(i,e,t){t===0&&(yield sm(i,e));for(let n=0;n<16;++n)(n&(e|t))===n&&(n&e)===e&&(yield sm(i,n))}function*lC(i){const e=i.phase,t=MF(i.keyName,i.modifiers,i.optionalModifiers);if(e===void 0)for(const n of t)yield`at:${n}`,yield`bubble:${n}`;else for(const n of t)yield`${e}:${n}`}function RF(i,e){const t=AF(i.keyName,i.modifiers,i.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:j(j({},e),{originalEventIdentifier:t})}class vt extends PF{static fromObject(e,t={}){const n=new vt;if(n.label=t.label,t.parents!==void 0)for(const s of t.parents){var r=oe(s,2);const o=r[0],l=r[1];n.addParent(o,l)}for(const s of di(e))n.set(s,e[s]);return n}setFromObject(e){for(const t of di(e))this.set(t,e[t])}set(e,t){const n=oC(e),r=RF(n,t);for(const s of lC(n))super.set(s,r)}delete(e){for(const t of lC(oC(e)))super.delete(t)}describe(){const e=[],t=new ue;for(const s of this.entries()){var n=oe(s,2);const o=n[1];t.set(o.originalEventIdentifier,o.action)}for(const s of t){var r=oe(s,2);const o=r[0],l=r[1];e.push(`${o}→${l}`)}return e.join(", ")}}function Rk(i,e,t){if(t===void 0)return;t.stopPropagation!==!1&&i.stopPropagation();const n=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),r=!i.target.dispatchEvent(n);(t.preventDefault!==!1||r)&&i.preventDefault()}const Hh=[];Hh[Event.AT_TARGET]="at";Hh[Event.CAPTURING_PHASE]="capture";Hh[Event.BUBBLING_PHASE]="bubble";function Nk(i,e,t,n,r){const s=Hh[t]+":"+i,o=r.get(s);Rk(e,n,o)}function Vk(i,e,t,n){Nk(sm(i,hy(e)),e,e.eventPhase,t,n)}function Se(i,e,t,n){return Bn(i,`action:${e}`,t,n)}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Gf;function NF(){if(Gf===void 0){const i=new vt;i.set("keyl","recolor"),i.set("keyx","clear-segments"),i.set("keys","toggle-show-slices"),i.set("keyb","toggle-scale-bar"),i.set("keyv","toggle-default-annotations"),i.set("keya","toggle-axis-lines"),i.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)i.set("digit"+e,"toggle-layer-"+e),i.set("control+digit"+e,"select-layer-"+e),i.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){const t=String.fromCharCode(97+e),n=String.fromCharCode(65+e);i.set(`alt?+control?+shift+key${t}`,`tool-${n}`)}i.set("keyn","add-layer"),i.set("keyh","help"),i.set("space","toggle-layout"),i.set("shift+space","toggle-layout-alternative"),i.set("backslash","toggle-show-statistics"),Gf=i}return Gf}let Wf;function Jh(){return Wf===void 0&&(Wf=vt.fromObject({"control+mousedown2":"select-position"})),Wf}let $f;function VF(){return $f===void 0&&($f=vt.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[Jh(),0]]})),$f}let jf;function Ok(){return jf===void 0&&(jf=vt.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:alt+mousedown2":"copy-segment-id","at:alt+shift+mousedown2":"add-copy-segment-id","at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[Jh(),0]]})),jf}let Hf;function OF(){return Hf===void 0&&(Hf=vt.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[Ok(),Number.NEGATIVE_INFINITY]]})),Hf}let Jf;function BF(){return Jf===void 0&&(Jf=vt.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[Ok(),Number.NEGATIVE_INFINITY]]})),Jf}function _F(i){i.global.addParent(NF(),Number.NEGATIVE_INFINITY),i.sliceView.addParent(BF(),Number.NEGATIVE_INFINITY),i.perspectiveView.addParent(OF(),Number.NEGATIVE_INFINITY)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function nt(i){for(;;){let e=i.firstChild;if(!e)break;i.removeChild(e)}}function Bt(i){let e=i.parentElement;return e?(e.removeChild(i),!0):!1}function qi(i,e=Math.max(1,i.value.length)){const t=`${e}ch`;i.style.width!==t&&(i.style.width="0px",i.offsetWidth,i.style.width=t)}function sr(i,e){let t=i.firstElementChild;for(const n of e)n!==t&&i.insertBefore(n,t),t=n.nextElementSibling;for(;t!==null;){let n=t.nextElementSibling;i.removeChild(t),t=n}}function py(i){return i instanceof HTMLElement?!!(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement||i.isContentEditable):!1}function FF(i){const e=i.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}let yo,od=[];function UF(){if(yo===void 0){const i=yo=document.createElement("div");i.classList.add("neuroglancer-drag-status"),document.body.appendChild(i)}return yo}function zF(){yo!==void 0&&(nt(yo),yo.style.display="none")}function Bk(i){const e=UF();nt(e),typeof i=="string"?e.appendChild(document.createTextNode(i)):e.appendChild(i()),e.style.display=""}function _k(i,e){T1(od,t=>!(t.target===i&&t.operation===e))}function ar(i,e,t){_k(i,e),od.push({target:i,operation:e,status:t}),Bk(t)}function ki(i,e){_k(i,e);const t=od.length===0?void 0:od[od.length-1];t===void 0?zF():Bk(t.status)}const GF=300,WF=100,Sa={side:"right",col:0,row:1/0,flex:1,size:GF,minSize:WF,visible:!1};class Rs{constructor(e=Sa,t=e){this.defaultValue=e,this.value=t,this.changed=new at,this.locationChanged=new at,this.locationChanged.add(this.changed.dispatch);const n=this;this.watchableVisible={get value(){return n.visible},set value(r){n.visible=r},changed:n.locationChanged}}toJSON(e=this.defaultValue){const t={},n=this.value;for(const r in n)n[r]!==e[r]&&(t[r]=n[r]);return t}get visible(){return this.value.visible}set visible(e){const t=this.value;t.visible!==e&&(this.value=j(j({},t),{visible:e}),this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;ge(e);const n={side:we(e,"side",r=>{if(r!=="left"&&r!=="right"&&r!=="top"&&r!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${se(r)}`);return r},t.side),col:we(e,"col",Tt,t.col),row:we(e,"row",Tt,t.row),flex:we(e,"flex",Tt,t.flex),size:we(e,"size",li,t.size),visible:we(e,"visible",oa,t.visible),minSize:t.minSize};this.value=n,this.locationChanged.dispatch()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zn(i,e,t){const n=i.view.document;let r=i.clientX,s=i.clientY;const o=f=>{const g=f.clientX-r,v=f.clientY-s;r=f.clientX,s=f.clientY,e(f,g,v)},l=i.button,c=f=>{n.removeEventListener("pointermove",o,!0),n.removeEventListener("pointerup",u,!1),t!==void 0&&t(f,f.clientX-r,f.clientY-s)},u=f=>{f.button===l&&c(f)};n.addEventListener("pointermove",o,!0),n.addEventListener("pointerup",u,!1),n.addEventListener("pointercancel",c,!1)}const $F="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iY2xvc2VJY29uVGl0bGUiPgogICAgPHRpdGxlIGlkPSJjbG9zZUljb25UaXRsZSI+Q2xvc2U8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik02LjM0MzE0NTc1IDYuMzQzMTQ1NzVMMTcuNjU2ODU0MiAxNy42NTY4NTQyTTYuMzQzMTQ1NzUgMTcuNjU2ODU0MkwxNy42NTY4NTQyIDYuMzQzMTQ1NzUiLz4KPC9zdmc+",jF="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0icmVmcmVzaEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9InJlZnJlc2hJY29uVGl0bGUiPlJlZnJlc2g8L3RpdGxlPiAgICAKICAgIDxwb2x5bGluZSBwb2ludHM9IjIyIDEyIDE5IDE1IDE2IDEyIi8+CiAgICA8cGF0aCBkPSJNMTEsMjAgQzYuNTgxNzIyLDIwIDMsMTYuNDE4Mjc4IDMsMTIgQzMsNy41ODE3MjIgNi41ODE3MjIsNCAxMSw0IEMxNS40MTgyNzgsNCAxOSw3LjU4MTcyMiAxOSwxMiBMMTksMTQiLz4KPC9zdmc+";function Lt(i){const e=i.title,t=i.onClick,n=i.href;let r;n!==void 0?(r=document.createElement("a"),r.href=n,r.target="_blank"):r=document.createElement("div"),e!==void 0&&(r.title=e),t!==void 0&&r.addEventListener("click",t);const s=i.svg;return r.className="neuroglancer-icon",s!==void 0&&(r.innerHTML=s),i.text!==void 0&&r.appendChild(document.createTextNode(i.text)),r}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fy(i={}){return Lt(j({svg:$F},i))}function HF(i={}){return Lt(j({svg:jF},i))}const bo="neuroglancer-drag-over",dC={row:"row",column:"col"},JF={left:"right",right:"left",top:"bottom",bottom:"top"},us={left:"column",right:"column",top:"row",bottom:"row"},Qc={left:"row",right:"row",top:"column",bottom:"column"},no={row:"width",column:"height"},cC={row:"left",column:"top"},ZF={row:"right",column:"bottom"},uC={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},eu={left:-1,right:1,top:-1,bottom:1};class wa extends K{constructor(e,t=new Rs){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new Zt(Zt.VISIBLE);const n=this.element;n.classList.add("neuroglancer-side-panel"),n.draggable=!0,n.addEventListener("dragstart",r=>{this.sidePanelManager.startDrag(this.makeDragSource(),r),n.style.backgroundColor="black",setTimeout(()=>{n.style.backgroundColor=""},0),ar(n,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),n.addEventListener("dragend",r=>{this.sidePanelManager.endDrag(),ki(n,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{const t=this.location.value;this.location.value=j(j({},t),e),this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){const t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");const n=e.title;let r;n!==void 0&&(r=document.createElement("div"),r.classList.add("neuroglancer-side-panel-title"),r.textContent=n,t.appendChild(r));const s=fy({title:"Close panel",onClick:()=>{this.close()}});return s.style.order="100",t.appendChild(s),this.element.appendChild(t),{titleBar:t,titleElement:r,closeButton:s}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}}class qF extends K{constructor(e,t,n=new Zt(Zt.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=n,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new at,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new je,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};const r=this.element,s=this.centerColumn;r.style.display="flex",r.style.flex="1",r.style.flexDirection="row",s.style.display="flex",s.style.flex="1",s.style.flexDirection="column",s.style.flexBasis="0px",s.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,eu[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,n,r,s=!1){const o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";const l=10,c=us[r],u=Qc[r];return o.style[no[u]]=`${l}px`,o.style[no[c]]="100%",s?(o.style.position="absolute",o.style[r]="50%",o.style[uC[r]]="-${size/2}px"):(o.style.position="relative",o.style[uC[JF[r]]]=`-${l}px`),o.addEventListener("dragenter",f=>{this.hasDroppablePanel()&&(o.classList.add(bo),f.preventDefault(),ar(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{ki(o,"drop"),o.classList.remove(bo)}),o.addEventListener("dragover",f=>{this.hasDroppablePanel()&&f.preventDefault()}),o.addEventListener("drop",f=>{const g=this.dragSource;if(g===void 0)return;ki(o,"drop"),o.classList.remove(bo);const v=us[e];g.dropAsNewPanel({side:e,row:v==="column"?n:t,col:v==="row"?n:t}),this.dragSource=void 0,f.preventDefault(),f.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)===null||t===void 0||t.dispose(),this.invalidateLayout()}disposed(){for(const e of this.registeredPanels){const t=e.panel;t==null||t.dispose()}super.disposed()}render(){this.layoutNeedsUpdate=!1;const e={left:[],right:[],top:[],bottom:[]};for(const o of this.registeredPanels)e[o.location.value.side].push(o);const t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),n=this;function*r(){yield n.sides.left.outerDropZoneElement,yield*t("left"),yield n.centerColumn,yield*t("right"),yield n.sides.right.outerDropZoneElement}sr(this.element,r());function*s(){yield n.sides.top.outerDropZoneElement,yield*t("top"),yield n.center,yield*t("bottom"),yield n.sides.bottom.outerDropZoneElement}sr(this.centerColumn,s())}makeCrossGutter(e,t){const n=document.createElement("div");n.style.position="relative";const r=Qc[e];n.className=`neuroglancer-resize-gutter-${r==="row"?"horizontal":"vertical"}`,n.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();const l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let c=l.element.getBoundingClientRect()[no[r]];const u=l.minSize,f=()=>{ar(n,"drag",`Drag to resize, current ${no[r]} is ${l.crossSize}px`)};f(),zn(o,(g,v,y)=>{const C=r==="row"?v:y;c-=eu[e]*C,l.crossSize=Math.max(u,Math.round(c)),f(),this.invalidateLayout()},()=>{ki(n,"drag")})});const s=this.makeDropZone(e,t-eu[e]*.5,0,e,!0);return n.appendChild(s),n}makeFlexGutter(e,t,n){const r=document.createElement("div");r.style.position="relative";const s=us[e];r.className=`neuroglancer-resize-gutter-${s==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();const c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;const u=c.cells,f=u[n];if(f===void 0||!f.registeredPanel.location.visible)return;let g=n+1;for(;g<u.length&&!u[g].registeredPanel.location.visible;)++g;if(g===u.length)return;const v=u[g],y=()=>{ar(r,"drag",`Drag to resize, current ${no[s]} ratio is ${f.registeredPanel.location.value.flex} : ${v.registeredPanel.location.value.flex}`)};y(),zn(l,C=>{const w=f.registeredPanel.panel,S=v.registeredPanel.panel;if(w===void 0||S===void 0)return;const L=w.element.getBoundingClientRect(),I=S.element.getBoundingClientRect(),M=Math.max(.1,Math.min(.9,s==="column"?(C.clientY-L.top)/(I.bottom-L.top):(C.clientX-L.left)/(I.right-L.left))),R=f.registeredPanel.location.value,D=v.registeredPanel.location.value,T=R.flex+D.flex;f.registeredPanel.location.value=j(j({},R),{flex:Math.round(M*T*100)/100}),v.registeredPanel.location.value=j(j({},D),{flex:Math.round((1-M)*T*100)/100}),y(),f.registeredPanel.location.locationChanged.dispatch(),v.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{ki(r,"drag")})});const o=this.makeDropZone(e,t,n+.5,cC[us[e]],!0);return r.appendChild(o),r}renderSide(e,t,n){const r=dC[Qc[e]],s=dC[us[e]];n.sort((c,u)=>{const f=c.location.value,g=u.location.value,v=f[s]-g[s];return v!==0?v:f[r]-g[r]});const o=this;function*l(){let c=0,u=n.length,f=0;for(;c<u;){const g=n[c].location.value[s];let v=c,y=0,C=0;do{const I=n[v].location.value;if(I[s]!==g)break;I.visible&&(++y,C=Math.max(C,I.minSize)),++v}while(v<u);const w=y>0;let S=t[f];if(S===void 0){const I=o.makeCrossGutter(e,f),M=document.createElement("div");M.className=`neuroglancer-side-panel-${us[e]}`,S=t[f]={element:M,gutterElement:I,cells:[],crossSize:-1,minSize:C,visible:w,beginDropZone:o.makeDropZone(e,f,-1/0,cC[us[e]]),endDropZone:o.makeDropZone(e,f,1/0,ZF[us[e]])}}else S.visible=w,S.minSize=C,S.crossSize=Math.max(S.crossSize,C);function*L(){yield S.beginDropZone;let I=0;for(let M=c,R=0;M<v;++M,++R){const D=n[M];let T=S.cells[R];T===void 0?T=S.cells[R]={registeredPanel:D,gutterElement:void 0}:T.registeredPanel=D;const A=T.registeredPanel.location.value;S.crossSize==-1&&(S.crossSize=Math.max(C,A.size)),(A[s]!==f||A[r]!==R||A.visible&&A.size!==S.crossSize)&&(T.registeredPanel.location.value=j(j({},A),{[s]:f,[r]:R,size:A.visible?S.crossSize:A.size}),T.registeredPanel.location.changed.dispatch());const V=A.visible&&o.visibility.visible;let O=D.panel;if(!V){O!==void 0&&(O.dispose(),D.panel=void 0);continue}++I,O===void 0&&(O=D.panel=D.makePanel()),O.element.style.flex=y>1?`${A.flex}`:"1",yield O.element,I===y?T.gutterElement=void 0:(T.gutterElement===void 0&&(T.gutterElement=o.makeFlexGutter(e,f,R)),yield T.gutterElement)}yield S.endDropZone}sr(S.element,L()),S.cells.length=v-c,w&&(S.element.style[no[Qc[e]]]=`${S.crossSize}px`,eu[e]>0?(yield S.gutterElement,yield S.element):(yield S.element,yield S.gutterElement)),c=v,++f}t.length=f}return l()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function on(i,e="text/plain"){let t=!1;const n=Bn(document,"copy",r=>{const s=r.clipboardData;s!==null&&(s.setData(e,i),t=!0),r.stopPropagation(),r.preventDefault()},!0);try{document.execCommand("copy")}finally{n()}return t}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zr extends K{constructor(e,t,n){super(),this.target=e,this.eventMap=t,this.registerEventListener(e,"wheel",r=>{n!==void 0&&n(r),this.dispatch("wheel",r)}),this.registerEventListener(e,"click",r=>{n!==void 0&&n(r),this.dispatch(`click${r.button}`,r)}),this.registerEventListener(e,"dblclick",r=>{n!==void 0&&n(r),this.dispatch(`dblclick${r.button}`,r)}),this.registerEventListener(e,"mousedown",r=>{n!==void 0&&n(r);let s=r.button;s===2&&(r.buttons&3)===1&&(s=0),this.dispatch(`mousedown${s}`,r)}),this.registerEventListener(e,"mouseup",r=>{n!==void 0&&n(r),this.dispatch(`mouseup${r.button}`,r)})}dispatch(e,t){Vk(e,t,t,this.eventMap)}}class er extends K{constructor(e,t){super(),this.element=Lt(j(j({},t),{onClick:()=>{e.value=!e.value}})),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");const n=()=>{const r=e.value;this.element.dataset.checked=r?"true":"false",this.element.title=(r?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(n)),n()}}const YF="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iY29weUljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImNvcHlJY29uVGl0bGUiPkNvcHk8L3RpdGxlPiAgICAKICAgIDxyZWN0IHdpZHRoPSIxMiIgaGVpZ2h0PSIxNCIgeD0iOCIgeT0iNyIvPgogICAgPHBvbHlsaW5lIHBvaW50cz0iMTYgMyA0IDMgNCAxNyIvPgo8L3N2Zz4=";function dr(i={}){return Lt(j({svg:YF},i))}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class KF extends K{constructor(e){super(),this.redraw=e}}class cr extends K{constructor(e,t,n=new Zt(Zt.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=n,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable(wt(()=>this.updateView())),this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(n.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;const e=this.model;if(e.changed.count===this.generation)return;this.disposeCurrentView();const t=this.currentViewDisposer=new KF(this.debouncedUpdateView);this.render(e.value,this.element,t)}disposeCurrentView(){let e=this.currentViewDisposer;e!==void 0&&e.dispose(),nt(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}function Fk(i={}){return Lt(j({text:"↗"},i))}function hC(i){return i.closest(".neuroglancer-selection-details")}class pC extends wa{constructor(e,t,n,r){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=n,this.selectedLayer=r,this.body=document.createElement("div");const s=this.element,o=this.body;s.classList.add("neuroglancer-selection-details"),this.registerDisposer(new Zr(this.element,Jh()));var l=this.addTitleBar({title:"Selection"});const c=l.titleBar,u=Lt({svg:Ak,title:"Previous selection",onClick:()=>{this.state.goBack()}}),f=Lt({svg:Mk,title:"Next selection",onClick:()=>{this.state.goForward()}});c.appendChild(u),c.appendChild(f),c.appendChild(this.registerDisposer(new er(t.pin,{text:"📌︎",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new cr(t,(g,v,y)=>{if(!(!t.location.visible||(u.style.visibility=t.canGoBack()?"visible":"hidden",f.style.visibility=t.canGoForward()?"visible":"hidden",g===void 0))){if(g.position!==void 0){const w=document.createElement("div");w.classList.add("neuroglancer-selection-details-position");const S=dr({title:"Copy position",onClick:()=>{on(M.map(D=>Math.floor(D)).join(", "))}});w.appendChild(S);var C=g.coordinateSpace;const L=C.rank,I=C.names,M=g.position;for(let D=0;D<L;++D){const T=document.createElement("span");T.classList.add("neuroglancer-selection-details-position-dimension");const A=document.createElement("span");A.classList.add("neuroglancer-selection-details-position-dimension-name"),A.textContent=I[D];const V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(M[D]).toString(),T.appendChild(A),T.appendChild(V),w.appendChild(T)}const R=Fk({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=M}});w.appendChild(R),v.appendChild(w)}for(const w of g.layers){const S=w.layer;v.appendChild(y.registerDisposer(new cr({value:void 0,changed:S.managedLayer.layerChanged},(L,I,M)=>{if(S.wasDisposed||!S.isReady)return;const R=document.createElement("div");if(R.classList.add("neuroglancer-selection-details-layer-body"),!S.displaySelectionState(w.state,R,M))return;const D=document.createElement("div");I.appendChild(D),D.classList.add("neuroglancer-selection-details-layer");const T=document.createElement("div");T.classList.add("neuroglancer-selection-details-layer-title"),T.textContent=S.managedLayer.name,T.addEventListener("click",()=>{this.selectedLayer.layer=S.managedLayer,this.selectedLayer.visible=!0}),T.title="Click to show layer side panel",D.appendChild(T),D.appendChild(R)})).element)}}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}const XF="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iZmlsdGVySWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iZmlsdGVySWNvblRpdGxlIj5GaWx0ZXI8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0xMCAxMi4yNjFMNC4wMjggMy45NzJoMTZMMTQgMTIuMzI5VjE3bC00IDN6Ii8+Cjwvc3ZnPg==";function QF(i={}){return Lt(j({svg:XF},i))}class Gr{constructor(e,t,n){this.key=e,this.value=t,this.label=n}toString(){const e=this.key,t=this.value,n=this.label;let r;return t===void 0?r=`${e}`:r=`${e}→${t}`,n===void 0?r:`${r} ${n}`}}class Uk extends K{constructor(){super(...arguments),this.selectedSegment=new re,this.baseSelectedSegment=new re,this.hasSelectedSegment=!1,this.changed=new xe}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){const n=this.selectedSegment,r=this.baseSelectedSegment;let s=0,o=0,l=0,c=0,u;if(e==null)u=!1;else if(typeof e=="number")s=l=e>>>0,o=c=e<0?4294967295:0,u=!0;else if(e instanceof Gr){const f=e.value||e.key;s=f.low,o=f.high,l=e.key.low,c=e.key.high,u=!0}else e instanceof re?(s=l=e.low,o=c=e.high,u=!0):u=!1;t&&s===0&&o===0&&(u=!1),u?u&&(!this.hasSelectedSegment||n.low!==s||n.high!==o||r.low!==l||r.high!==c)&&(n.low=s,n.high=o,r.low=l,r.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&re.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{const n=e.get(t);let r;n!==void 0&&(r=n.value),this.set(r,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function Id(i){i.useTemporarySegmentEquivalences.value=!1,i.useTemporaryVisibleSegments.value=!1,i.temporaryVisibleSegments.clear(),i.temporarySegmentEquivalences.clear()}function gy(i,e,t=!1){let n,r,s,o;if(typeof e=="number"?n=new re(e>>>0,e<0?4294967295:0):typeof e=="string"?n=re.parseString(e):n=t?e.clone():e,i==null)return n;var l=i.segmentationGroupState.value;const c=l.segmentEquivalences,u=l.segmentPropertyMap.value;return c.size!==0?(r=c.get(n),re.equal(r,n)?s=void 0:s=r):r=n,o=u==null?void 0:u.getSegmentLabel(r),o===void 0&&s==null?n:new Gr(n,s,o)}function ua(i,e){if(e instanceof Gr)return e;let t=gy(i,e);return t instanceof re?new Gr(t):t}function am(i,e){const t=e.length;i.value<t&&(i.value=t)}function _o(i,e){return Or(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),i.segmentationGroupState.value.maxIdLength)}const my=(()=>{const i=document.createElement("div");i.classList.add("neuroglancer-segment-list-entry");const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),i.appendChild(e);const t=dr({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");const n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry-copy-container");const r=n.childElementCount;n.appendChild(t);const s=e.childElementCount;e.appendChild(n);const o=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);const c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");const u=e.childElementCount;e.appendChild(c);const f=document.createElement("div");f.classList.add("neuroglancer-segment-list-entry-id");const g=c.childElementCount;c.appendChild(f);const v=document.createElement("span");v.classList.add("neuroglancer-segment-list-entry-name");const y=i.childElementCount;i.appendChild(v);const C=QF({title:"Filter by label"});C.classList.add("neuroglancer-segment-list-entry-filter");const w=i.childElementCount;return i.appendChild(C),{template:i,copyContainerIndex:s,copyIndex:r,visibleIndex:o,idContainerIndex:u,idIndex:g,labelIndex:y,filterIndex:w,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),eU=(()=>{const i=my,e=i.template.cloneNode(!0),t=e.children[0],n=t.children[i.idContainerIndex],r=n.childElementCount,s=n.children[i.idIndex].cloneNode(!0);s.classList.add("neuroglancer-segment-list-entry-unmapped-id"),n.appendChild(s);const o=t.children[i.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[i.copyIndex].cloneNode(!0)),j(j({},i),{template:e,unmappedIdIndex:r,unmappedCopyIndex:l})})();function zk(i){let e=my;const t=e.template.cloneNode(!0),n=[];for(let r=0;r<i;++r){n.push(t.childElementCount);const s=document.createElement("div");s.classList.add("neuroglancer-segment-list-entry-extra-property"),s.style.width=`max(var(--neuroglancer-column-${r}-width), var(--neuroglancer-column-${r}-label-width))`,t.appendChild(s)}return j(j({},e),{template:t,numericalPropertyIndices:n})}const fC=new fk;function tU(i){const e=f=>{const g=f.currentTarget,v=g.dataset.id,y=On;y.tryParseString(v),i.segmentSelectionState.set(y),hC(g)||i.selectSegment(y,!1)},t=f=>{const g=f.currentTarget,v=g.dataset.id,y=On;y.tryParseString(v),i.selectSegment(y,hC(g)?"toggle":!0)},n=()=>{i.segmentSelectionState.set(null)},r=f=>f.currentTarget.closest(".neuroglancer-segment-list-entry"),s=f=>{const g=r(f);on(g.dataset.id),f.stopPropagation()},o=f=>{const g=r(f);on(g.dataset.unmappedId),f.stopPropagation()},l=f=>{const g=r(f).dataset.id,v=On;v.tryParseString(g);const y=i.segmentationGroupState.value.visibleSegments;y.set(v,!y.has(v)),f.stopPropagation()},c=f=>{const g=r(f).dataset.id,v=On;v.tryParseString(g),i.filterBySegmentLabel(v),f.stopPropagation()},u=f=>{if(f.button!==2||f.ctrlKey||f.altKey||f.metaKey||f.shiftKey)return;const g=f.currentTarget.dataset.id,v=On;v.tryParseString(g),i.moveToSegment(v)};return(f,g)=>{const v=f.children,y=v[0].children;f.addEventListener("mousedown",u);const C=y[g.copyContainerIndex];g.unmappedCopyIndex!==-1&&C.children[g.unmappedCopyIndex].addEventListener("click",o),C.children[g.copyIndex].addEventListener("click",s),f.addEventListener("mouseenter",e),f.addEventListener("mouseleave",n),y[g.visibleIndex].addEventListener("click",l),v[g.filterIndex].addEventListener("click",c),f.addEventListener("action:select-position",t)}}class tl{constructor(e,t){if(this.displayState=e,this.template=t,e!==void 0){let n=fC.get(e);n===void 0&&(n=tU(e),fC.set(e,n)),this.registerEventHandlers=n}}static make(e,t){return new tl(e,t?eU:my)}get(e){const t=this.displayState;return this.getWithNormalizedId(ua(t,e))}getWithNormalizedId(e){var t,n;const r=this.displayState,s=this.template,o=s.template.cloneNode(!0),l=e.key,c=(t=e.value)!==null&&t!==void 0?t:l,u=c.toString();o.dataset.id=u;const f=o.children,g=f[0].children,v=g[s.idContainerIndex];v.children[s.idIndex].textContent=u;const y=s.unmappedIdIndex;if(r!==void 0?this.registerEventHandlers(o,s):g[s.visibleIndex].style.display="none",y!==-1){const C=v.children[y];if(re.equal(l,c)){C.style.display="none";const w=g[s.copyContainerIndex];w.children[s.unmappedCopyIndex].style.display="none"}else{const w=l.toString();o.dataset.unmappedId=w,C.textContent=w,r!==void 0&&am(r.segmentationGroupState.value.maxIdLength,w)}}return f[s.labelIndex].textContent=(n=e.label)!==null&&n!==void 0?n:"",r!==void 0&&(this.updateWithId(o,c),am(r.segmentationGroupState.value.maxIdLength,u)),o}update(e){const t=On,n=e.dataset.id;n!==void 0&&(t.parseString(n),this.updateWithId(e,t))}updateWithId(e,t){const n=e.children[0].children,r=this.template,s=this.displayState,o=s.segmentSelectionState,l=s.segmentationGroupState.value.visibleSegments;n[r.visibleIndex].checked=l.has(t),e.dataset.selected=(o.hasSelectedSegment&&re.equal(o.selectedSegment,t)).toString();const c=n[r.idContainerIndex];gC(c.children[r.idIndex],$u(this.displayState,t));const u=r.unmappedIdIndex;if(u!==-1){let f,g;if(s.baseSegmentColoring.value&&(f=e.dataset.unmappedId)!==void 0){const v=On;v.parseString(f),g=$u(this.displayState,v)}else g=H1;gC(c.children[u],g)}}}function gC(i,e){i.style.backgroundColor=Pk(e),i.style.color=ku(e)?"white":"black"}class Gk extends tl{constructor(e,t,n){var r;const s=e.segmentationGroupState.value.segmentPropertyMap.value,o=((r=s==null?void 0:s.numericalProperties)!==null&&r!==void 0?r:[]).filter(n),l=zk(o.length);super(e,l),this.parentElement=t,this.segmentPropertyMap=s,this.numericalProperties=o,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var t,n,r;const s=super.getWithNormalizedId(e),o=this.numericalProperties,l=this.template.numericalPropertyIndices;if(l.length>0){const c=(r=(t=this.segmentPropertyMap)===null||t===void 0?void 0:t.getSegmentInlineIndex((n=e.value)!==null&&n!==void 0?n:e.key))!==null&&r!==void 0?r:-1;if(c!==-1){const u=this.numericalPropertyWidths;for(let f=0,g=l.length;f<g;++f){const v=o[f].values[c];if(!isNaN(v)){const y=v.toString(),C=y.length;C>u[f]&&(u[f]=C,this.parentElement.style.setProperty(`--neuroglancer-column-${f}-width`,`${C}ch`)),s.children[l[f]].textContent=y}}}}return s}makeHeaderLabel(e,t,n){const r=document.createElement("span");r.textContent=e,r.classList.add("neuroglancer-segment-list-header-label"),r.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(n.style.textAlign="left");const s=document.createElement("span");s.classList.add("neuroglancer-segment-list-header-label-sort"),r.appendChild(s),s.textContent="▲";const o=FF(r).width;return this.parentElement.style.setProperty(t,`${o}px`),n.appendChild(r),{id:e,label:r,sortIcon:s}}getHeader(){const e=this.template,t=e.template.cloneNode(!0),n=t.children,r=n[0].children,s=r[e.copyContainerIndex];s.style.visibility="hidden",r[e.visibleIndex].style.visibility="hidden",n[e.filterIndex].style.visibility="hidden";const o=r[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",n[e.labelIndex])],c=this.numericalProperties,u=this.template.numericalPropertyIndices;for(let f=0,g=u.length;f<g;++f){const v=c[f],y=this.makeHeaderLabel(v.id,`--neuroglancer-column-${f}-label-width`,t.children[u[f]]),C=v.description;C&&(y.label.title=C),l.push(y)}return{container:t,propertyLabels:l}}}function Zh(i,e){return tl.make(i??void 0,!0).getWithNormalizedId(e)}function il(i,e,t){e.registerDisposer(Co((n,r)=>{z_(n,r,t)},i.segmentationGroupState)),e.registerDisposer(Co((n,r)=>{n.registerDisposer(r.segmentColorHash.changed.add(t)),n.registerDisposer(r.segmentDefaultColor.changed.add(t))},i.segmentationColorGroupState)),e.registerDisposer(i.saturation.changed.add(t)),e.registerDisposer(i.segmentSelectionState.changed.add(t)),e.registerDisposer(i.baseSegmentColoring.changed.add(t))}function vy(i,e){const t=e.redrawNeeded.dispatch;il(i,e,t),e.registerDisposer(Co((n,r)=>{G_(n,r,t)},i.segmentationGroupState))}function Wk(i,e){vy(i,e),e.registerDisposer(i.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function qh(i,e){Wk(i,e),e.registerDisposer(i.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}const $k=Eh(),On=new re;function $u(i,e,t=$k){if(i==null)return t.fill(1),t;const n=i.segmentationColorGroupState.value;if(n.segmentStatedColors.size!==0&&n.segmentStatedColors.get(e,On))return t[0]=(On.low&255)/255,t[1]=((On.low&65280)>>>8)/255,t[2]=((On.low&16711680)>>>16)/255,t;const r=n.segmentDefaultColor.value;return r!==void 0?(t[0]=r[0],t[1]=r[1],t[2]=r[2],t):(n.segmentColorHash.compute(t,e),t)}function jk(i,e,t=1){const n=$k;n[3]=t,$u(i,e,n);let r=i.saturation.value;i.segmentSelectionState.isSelected(e)&&(r>.5?r=r-=.5:r+=.5);for(let s=0;s<3;++s)n[s]=n[s]*r+(1-r);return n[0]*=t,n[1]*=t,n[2]*=t,n}function yy(i,e={}){for(const t of U_)e[t]=i[t].rpcId;return e}const iU=Vh(jd);class Yh extends iU{constructor(e,t,n){super(n),this.chunkManager=e,this.displayState=t}initializeCounterpartWithChunkManager(e){let t=this.displayState;e.chunkManager=this.chunkManager.rpcId,yy(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(Di.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(Di.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function Kh(i,e,t,n,r){const s=Math.min(1,i.objectAlpha.value),o=i.baseSegmentColoring.value;Ko(i.segmentationGroupState.value,(l,c)=>{let u=n==null?void 0:n.registerUint64(e,l),f=t?jk(i,o?l:c,s):void 0;r(l,f,u,c)})}const nU=Object.freeze(Object.defineProperty({__proto__:null,SegmentSelectionState:Uk,SegmentWidgetFactory:tl,SegmentWidgetWithExtraColumnsFactory:Gk,SegmentationLayerSharedObject:Yh,Uint64MapEntry:Gr,augmentSegmentId:ua,bindSegmentListWidth:_o,forEachVisibleSegmentToDraw:Kh,getBaseObjectColor:$u,getObjectColor:jk,makeSegmentWidget:Zh,maybeAugmentSegmentId:gy,registerCallbackWhenSegmentationDisplayStateChanged:il,registerRedrawWhenSegmentationDisplayState3DChanged:qh,registerRedrawWhenSegmentationDisplayStateChanged:vy,registerRedrawWhenSegmentationDisplayStateWithAlphaChanged:Wk,resetTemporaryVisibleSegmentsState:Id,segmentWidgetTemplateWithExtraColumns:zk,sendVisibleSegmentsState:yy,updateIdStringWidth:am},Symbol.toStringTag,{value:"Module"}));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Hk=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s};const rU=Qe(),gn=Rd();function Jk(i,e){e.vertexBuffer=Ki.fromData(i,e.meshData.vertexPositions,i.ARRAY_BUFFER,i.STATIC_DRAW),e.indexBuffer=Ki.fromData(i,e.meshData.indices,i.ELEMENT_ARRAY_BUFFER,i.STATIC_DRAW),e.normalBuffer=Ki.fromData(i,e.meshData.vertexNormals,i.ARRAY_BUFFER,i.STATIC_DRAW)}function Zk(i){i.vertexBuffer.dispose(),i.indexBuffer.dispose(),i.normalBuffer.dispose()}const sU=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function mC(i){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,n){n.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,i,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}const aU={[_r.float32]:mC(WebGL2RenderingContext.FLOAT),[_r.uint16]:mC(WebGL2RenderingContext.UNSIGNED_SHORT),[_r.uint10]:{defineShader:i=>{i.addAttribute("highp uint","aVertexPosition"),i.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(i,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(i,e)=>{i.disableVertexAttribArray(e.attribute("aVertexPosition"))}}};class qk{constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=aU[this.vertexPositionFormat]}beginLayer(e,t,n,r){let s=n.lightDirection,o=n.ambientLighting,l=n.directionalLighting,c=this.tempLightVec;vv(c,s,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);const u=r.silhouetteRendering.value;u>0&&e.uniform1f(t.uniform("uSilhouettePower"),u)}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginModel(e,t,n,r){const s=n.projectionParameters;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,fi(rU,s.viewProjectionMat,r)),Lh(gn,r),Y1(gn,gn,s.displayDimensionRenderInfo.canonicalVoxelFactors),Y2(gn,gn),q2(gn,gn),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,gn)}drawFragmentHelper(e,t,n,r,s){this.vertexPositionHandler.bind(e,t,n);const o=n.meshData;n.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),n.indexBuffer.bind();const l=o.indices;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,s-r,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,r*l.BYTES_PER_ELEMENT)}drawFragment(e,t,n){const r=n.meshData.indices;this.drawFragmentHelper(e,t,n,0,r.length)}drawMultiscaleFragment(e,t,n,r,s){const o=n.meshData.subChunkOffsets[r],l=n.meshData.subChunkOffsets[s];this.drawFragmentHelper(e,t,n,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){const t=e.registerDisposer(wn(n=>n>0,[e.displayState.silhouetteRendering]));return Io(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(n,r)=>{this.vertexPositionHandler.defineShader(n),n.addAttribute("highp vec2","aVertexNormal"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec4","uLightDirection"),n.addUniform("highp vec4","uColor"),n.addUniform("highp mat3","uNormalMatrix"),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp uint","uPickID"),r&&n.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(n.addUniform("highp vec3","uFragmentOrigin"),n.addUniform("highp vec3","uFragmentShape")),n.addVertexCode(sU);let s="";this.fragmentRelativeVertices?s+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:s+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,s+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,r&&(s+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),n.setVertexMain(s),n.setFragmentMain("emit(vColor, uPickID);")}})}}class vC extends el{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new qk(!1,_r.float32),this.getShader=this.meshShaderManager.makeGetter(this),qh(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let r=this.backend=this.registerDisposer(new Yh(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID=nF,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),r.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=this.gl,r=this.displayState,s=this.meshShaderManager;if(r.objectAlpha.value<=0)return;const o=Vu(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;var l=this.getShader(e.emitter);const c=l.shader;if(c===null)return;c.bind(),s.beginLayer(n,c,e,this.displayState),s.beginModel(n,c,e,o);const u=this.source.chunks;let f=0,g=0;const v=this.displayState.renderScaleHistogram,y=this.source.fragmentSource.chunks;Kh(r,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(C,w,S)=>{const L=rr(C),I=u.get(L);if(++f,I!==void 0){++g,e.emitColor&&s.setColor(n,c,w),e.emitPickID&&s.setPickID(n,c,S),f+=I.fragmentIds.length;for(const R of I.fragmentIds){var M=this.source.getFragmentKey(L,R);const D=M.key,T=y.get(D);T!==void 0&&T.state===Et.GPU_MEMORY&&(s.drawFragment(n,c,T),++g)}}}),e.emitColor&&(v.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),v.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,g,f-g)),s.endLayer(n,c)}isReady(){const e=this.displayState,t=this.source;let n=!0;const r=t.fragmentSource.chunks;return Ko(e.segmentationGroupState.value,s=>{const o=rr(s),l=t.chunks.get(o);if(l===void 0){n=!1;return}for(const u of l.fragmentIds){var c=this.source.getFragmentKey(o,u);const f=c.key,g=r.get(f);if(g===void 0||g.state!==Et.GPU_MEMORY){n=!1;return}}}),n}}class oU extends Ms{constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class lU extends Ms{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),Jk(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),Zk(this)}}class Kd extends Jr{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new om(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new oU(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}let om=class extends Jr{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new lU(this,i)}};om=Hk([Ln(sF)],om);function yC(i,e,t,n){const r=i.get(Ek(e,t,n));return r!==void 0&&r.state===Et.GPU_MEMORY}class Zf extends el{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new qk(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),qh(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let r=this.backend=this.registerDisposer(new Yh(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID=rF,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),r.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=this.gl,r=this.displayState,s=this.meshShaderManager;if(r.objectAlpha.value<=0)return;const o=Vu(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;var l=this.getShader(e.emitter);const c=l.shader;if(c===null)return;c.bind(),s.beginLayer(n,c,e,this.displayState);const u=this.displayState.renderScaleHistogram;e.emitColor&&u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Lh(gn,o),Y1(gn,gn,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);const f=Math.pow(Math.abs(gv(gn)),1/3),g=this.source.chunks,v=this.source.fragmentSource.chunks,y=e.projectionParameters,C=fi(Qe(),y.viewProjectionMat,o),w=Eu(new Float32Array(24),C),S=this.displayState.renderScaleTarget.value,L=this.source.format.fragmentRelativeVertices;s.beginModel(n,c,e,o);let I=0,M=0;Kh(r,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(R,D,T)=>{const A=rr(R),V=g.get(A);if(++I,V===void 0)return;++M;const O=V.manifest,_=O.octree,H=O.chunkShape,U=O.chunkGridSpatialOrigin,B=O.vertexOffsets;e.emitColor&&s.setColor(n,c,D),e.emitPickID&&s.setPickID(n,c,T),Xw(O,C,w,S,y.width,y.height,(W,F,le)=>{const de=yC(v,A,W,F);return e.emitColor&&u.add(O.lodScales[W]*f,le,de?1:0,de?0:1),de},(W,F,le,de)=>{const Re=Ek(A,W,F),ce=v.get(Re),Le=_[5*F],Be=_[5*F+1],qe=_[5*F+2],Ze=1<<W;L&&(n.uniform3f(c.uniform("uFragmentOrigin"),U[0]+Le*H[0]*Ze+B[W*3+0],U[1]+Be*H[1]*Ze+B[W*3+1],U[2]+qe*H[2]*Ze+B[W*3+2]),n.uniform3f(c.uniform("uFragmentShape"),H[0]*Ze,H[1]*Ze,H[2]*Ze)),s.drawMultiscaleFragment(n,c,ce,le,de)})}),u.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,M,I-M),s.endLayer(n,c)}isReady(e,t){let n=this.displayState;if(n.objectAlpha.value<=0)return!0;const r=Vu(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return!1;const s=this.source.chunks,o=this.source.fragmentSource.chunks,l=e.projectionParameters,c=fi(Qe(),l.viewProjectionMat,r),u=Eu(new Float32Array(24),c),f=this.displayState.renderScaleTarget.value;let g=!0;return Ko(n.segmentationGroupState.value,v=>{if(!g)return;const y=rr(v),C=s.get(y);if(C===void 0){g=!1;return}const w=C.manifest;Xw(w,c,u,f,l.width,l.height,(S,L)=>(g=g&&yC(o,y,S,L),g),()=>{})}),g}getObjectPosition(e){const t=this.displayState.transform.value;if(t.error!==void 0)return;const n=this.source.chunks.get(rr(e));if(n===void 0)return;const r=n.manifest,s=r.clipLowerBound,o=r.clipUpperBound,l=t.rank,c=new Float32Array(l);for(let f=0;f<3;++f)c[f]=(s[f]+o[f])/2;const u=new Float32Array(l);return Nr(u,t.modelToRenderLayerTransform,l+1,c,l),u}}class dU extends Ms{constructor(e,t){super(e),this.manifest=t.manifest}}class cU extends Ms{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),Jk(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),Zk(this)}}class Xh extends Jr{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new lm(this.chunkManager,this)),this.format=t.format}static encodeOptions(e){return j({format:e.format},super.encodeOptions(e))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new dU(this,e)}}let lm=class extends Jr{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new cU(this,i)}};lm=Hk([Ln(aF)],lm);var bC=Yt,uU=ak(!1);bC(bC.S,"Object",{values:function(i){return uU(i)}});var hU=Ct.Object.values,pU={default:hU,__esModule:!0};const dm=It(pU);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fU="skeleton/SkeletonLayer";/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const by=6,Sy=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function wy(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,by*e,t)}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gU(i,e){const t=new Float32Array((i+1)*(e+1)*3);let n=0;for(let r=0;r<=i;++r){const s=r*Math.PI/i,o=Math.sin(s),l=Math.cos(s);for(let c=0;c<=e;++c){const u=c*2*Math.PI/e,f=Math.sin(u),g=Math.cos(u);t[n++]=g*o,t[n++]=l,t[n++]=f*o}}return t}function mU(i,e){const t=new Uint16Array(i*e*6);let n=0;for(let r=0;r<i;r++)for(let s=0;s<e;s++){const o=r*(e+1)+s,l=o+e+1;t[n++]=o,t[n++]=l,t[n++]=o+1,t[n++]=l,t[n++]=l+1,t[n++]=o+1}return t}class Yk extends K{constructor(e,t,n){super(),this.vertexBuffer=this.registerDisposer(Sd(e,WebGL2RenderingContext.ARRAY_BUFFER,gU,t,n)).value,this.indexBuffer=this.registerDisposer(Sd(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,mU,t,n)).value,this.numIndices=t*n*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){const n=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(n,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(n)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Cy=by;function Xd(i,e){i.addVertexCode(Sy),i.addUniform("highp vec3","uCircleParams"),i.addVarying("highp vec4","vCircleCoord"),i.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),i.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function Qd(i,e,t){i.gl.uniform3f(i.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function ec(i,e,t){wy(i,e,t)}class vU extends K{constructor(e){super(),this.lightDirection=new Float32Array([1,0,0,0]),this.sphereHelper=this.registerDisposer(new Yk(e,20,20))}defineShader(e){e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVertexCode(`
float getRadiusAdjustment(vec3 vertex, float r) {
  float radiusAdjustment = 1.0;
  for (int i = 0; i < 3; ++i) {
    if (r != 0.0) {
      float d = vertex[i] - uModelClipBounds[i];
      radiusAdjustment -= d * d / (r * r);
    }
  }

  return sqrt(max(0.1, radiusAdjustment));
}
    `),this.sphereHelper.defineShader(e)}draw(e,t,n){const r=e.gl;r.uniformMatrix4fv(e.uniform("uNormalTransform"),!1,mv(Qe(),t.renderSubspaceInvModelMatrix)),r.uniform4f(e.uniform("uLightDirection"),this.lightDirection[0],this.lightDirection[1],this.lightDirection[2],this.lightDirection[3]),this.sphereHelper.draw(e,n)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bs=by;function hr(i,e=!1){i.addVertexCode(Sy),i.addUniform("highp vec3","uLineParams"),i.addVarying("highp float","vLineCoord"),i.addVarying("highp float","vLineFeatherFraction"),e&&(i.addVarying("highp float","vEndpointFraction"),i.addVarying("highp float","vLineCoordT"),i.addVarying("highp float","vLineBorderStartFraction")),i.addVertexCode(VB),i.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&i.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),i.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function pr(i,e,t){wy(i,e,t)}function fr(i,e,t){i.gl.uniform3f(i.uniform("uLineParams"),1/e.width,1/e.height,t)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wr(i){i.addAttribute("int","aDummyVertexId",0),i.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class gr extends K{constructor(e){super(),this.buffer=new Ki(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){const t=this.buffer,n=t.gl;t.bind(),e>this.size&&(this.size=e,n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),n.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),n.vertexAttribDivisor(0,0),n.enableVertexAttribArray(0)}disable(){this.buffer.gl.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new gr(e))}}const yU=Qe(),Kk=`void main() {
  emitDefault();
}
`,Zl=[],bU=Yd(new jh,J.FLOAT32,3);let Xk=class extends K{constructor(i,e){super(),this.base=i,this.targetIsSliceView=e,this.textureAccessHelper=new cy("vertexData"),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl)),this.edgeShaderGetter=Io(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(t,n)=>{if(n.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(t),this.defineAttributeAccess(t),hr(t),t.addAttribute("highp uvec2","aVertexIndex"),t.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;t.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),t.addFragmentCode(xd);const s=this.vertexAttributes,o=s.length;for(let l=1;l<o;++l){const c=s[l];t.addVarying(`highp ${c.glslDataType}`,`vCustom${l}`),r+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,t.addFragmentCode(`#define ${c.name} vCustom${l}
`)}t.setVertexMain(r),Cd(n,t),t.setFragmentMainFunction(bd(n.parseResult.code))}}),this.nodeShaderGetter=Io(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(t,n)=>{if(n.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(t),this.defineAttributeAccess(t),Xd(t,this.targetIsSliceView),t.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;t.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),t.addFragmentCode(xd);const s=this.vertexAttributes,o=s.length;for(let l=1;l<o;++l){const c=s[l];t.addVarying(`highp ${c.glslDataType}`,`vCustom${l}`),r+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,t.addFragmentCode(`#define ${c.name} vCustom${l}
`)}t.setVertexMain(r),Cd(n,t),t.setFragmentMainFunction(bd(n.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(i){Wr(i),i.addUniform("highp vec4","uColor"),i.addUniform("highp mat4","uProjection"),i.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(i){const e=this.textureAccessHelper;e.defineShader(i);const t=this.vertexAttributes.length;for(let n=Zl.length;n<t;++n)Zl[n]=ln(`SkeletonShader.vertexAttributeTextureUnit${n}`);this.vertexAttributes.forEach((n,r)=>{i.addTextureSampler(`${ly(n.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,Zl[r]),i.addVertexCode(e.getAccessor(`readAttribute${r}`,`uVertexAttributeSampler${r}`,n.dataType,n.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(i,e,t,n){const r=t.projectionParameters.viewProjectionMat;let s=fi(yU,r,n);i.uniformMatrix4fv(e.uniform("uProjection"),!1,s),this.vertexIdHelper.enable()}setColor(i,e,t){i.uniform4fv(e.uniform("uColor"),t)}setPickID(i,e,t){i.uniform1ui(e.uniform("uPickID"),t)}drawSkeleton(i,e,t,n,r){const s=this.vertexAttributes.length,o=n.vertexAttributeTextures;for(let l=0;l<s;++l){const c=WebGL2RenderingContext.TEXTURE0+e.textureUnit(Zl[l]);i.activeTexture(c),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o[l])}{e.bind();const l=e.attribute("aVertexIndex");n.indexBuffer.bindToVertexAttribI(l,2,WebGL2RenderingContext.UNSIGNED_INT),i.vertexAttribDivisor(l,1),fr(e,r,this.targetIsSliceView?1:0),pr(i,1,n.numIndices/2),i.vertexAttribDivisor(l,0),i.disableVertexAttribArray(l)}t!==null&&(t.bind(),Qd(t,r,{featherWidthInPixels:this.targetIsSliceView?1:0}),ec(t.gl,2,n.numVertices))}endLayer(i,e){const t=this.vertexAttributes.length;for(let n=0;n<t;++n){let r=e.textureUnit(Zl[n])+WebGL2RenderingContext.TEXTURE0;i.activeTexture(r),i.bindTexture(i.TEXTURE_2D,null)}this.vertexIdHelper.disable()}};var Fo;(function(i){i[i.LINES=0]="LINES",i[i.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(Fo||(Fo={}));class SC extends $h{constructor(e,t=e){super(Fo,e,t)}}class wC extends ci{constructor(e,t=e){super(e,gi,t)}}class SU{constructor(){this.compound=new Gh,this.shader=zv(Kk),this.shaderControlState=new Yv(this.shader),this.params2d={mode:new SC(Fo.LINES_AND_POINTS),lineWidth:new wC(2)},this.params3d={mode:new SC(Fo.LINES),lineWidth:new wC(1)};const e=this.compound;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){const e=this.compound.toJSON();for(const t of dm(e))if(t!==void 0)return e}}class wU extends K{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.layerChunkProgressInfo=new Ov,this.redrawNeeded=new xe,this.fallbackShaderParameters=new gt(qv(_h(Kk))),qh(n,this),this.displayState.shaderError.value=void 0;const r=n.skeletonRenderingOptions;this.registerDisposer(r.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let s=this.sharedObject=this.registerDisposer(new Yh(e,n,this.layerChunkProgressInfo));s.RPC_TYPE_ID=fU,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});const o=this.vertexAttributes=[xU];for(let c of t.vertexAttributes){var l=oe(c,2);let u=l[0],f=l[1];o.push({name:u,dataType:f.dataType,numComponents:f.numComponents,webglDataType:CU(f.dataType),glslDataType:f.numComponents>1?`vec${f.numComponents}`:"float"})}}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,n,r,s){let o=r.lineWidth.value;const l=this.gl,c=this.source,u=this.displayState;if(u.objectAlpha.value<=0)return;const f=Vu(u.transform.value,e.projectionParameters.displayDimensionRenderInfo,s);if(f===void 0)return;let g;r.mode.value===Fo.LINES_AND_POINTS?g=Math.max(5,o*2):g=o;const v=n.edgeShaderGetter(e.emitter),y=n.nodeShaderGetter(e.emitter),C=v.shader,w=v.parameters,S=y.shader,L=y.parameters;if(C===null||S===null)return;const I=this.displayState.skeletonRenderingOptions.shaderControlState;C.bind(),n.beginLayer(l,C,e,f),Ao(l,C,I,w.parseResult.controls),l.uniform1f(C.uniform("uLineWidth"),o),S.bind(),n.beginLayer(l,S,e,f),l.uniform1f(S.uniform("uNodeDiameter"),g),Ao(l,S,I,L.parseResult.controls);const M=c.chunks;Kh(u,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(R,D,T)=>{const A=rr(R),V=M.get(A);V===void 0||V.state!==Et.GPU_MEMORY||(D!==void 0&&(C.bind(),n.setColor(l,C,D),S.bind(),n.setColor(l,S,D)),T!==void 0&&(C.bind(),n.setPickID(l,C,T),S.bind(),n.setPickID(l,S,T)),n.drawSkeleton(l,C,S,V,e.projectionParameters))}),n.endLayer(l,C)}isReady(){const e=this.source,t=this.displayState;if(t.objectAlpha.value<=0)return!0;const n=e.chunks;let r=!0;return Ko(t.segmentationGroupState.value,s=>{const o=rr(s),l=n.get(o);if(l===void 0||l.state!==Et.GPU_MEMORY){r=!1;return}}),r}}class qf extends el{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new Xk(this.base,!1)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class CC extends Ro{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new Xk(this.base,!0)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}function CU(i){switch(i){case J.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${J[i]}`)}}const xU={dataType:J.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class EU extends Ms{constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;let n=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=n.length}copyToGPU(e){super.copyToGPU(e);const t=this.source.attributeTextureFormats,n=this.vertexAttributes,r=this.vertexAttributeOffsets,s=this.vertexAttributeTextures=[];for(let o=0,l=r.length;o<l;++o){const c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),dy(e,t[o],n.subarray(r[o],o+1!==l?r[o+1]:n.length)),s[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=Ki.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.vertexAttributeTextures;for(const n of t)e.deleteTexture(n);t.length=0,this.indexBuffer.dispose()}}const LU=new ue;function kU(i){const e=[bU];for(const t of i.values())e.push(Yd(new jh,t.dataType,t.numComponents));return e}class Qh extends Jr{constructor(e,t){super(e,t)}get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=kU(this.vertexAttributes)),e}getChunk(e){return new EU(this,e)}get vertexAttributes(){return LU}}function Qk(i,e,t,n){const r=e.dataType;e.defineShader(i,t);let s="",o="";if(t===0)s+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(s+=", "),s+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;i.addFragmentCode(kB);let l=`
${wi(r)} getDataValue(${s}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${n}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${wi(r)} getInterpolatedDataValue(${s}) {
  highp vec3 positionWithinChunk = ${n};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${wi(r)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${wi(r)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${wi(r)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;i.addFragmentCode(l),t<=1&&i.addFragmentCode(`
${wi(r)} getDataValue() { return getDataValue(0); }
${wi(r)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var eI=new Array;function tI(i){eI.push(i)}function IU(i,e){for(let t of eI){let n=t(i,e);if(n!=null)return n}throw new Error("No chunk format handler found.")}class tc extends HL{constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(IU(e.chunkQueueManager.gl,this.spec));const n=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(n),this.tempPositionWithinChunk=new Uint32Array(n)}static encodeSpec(e){const t=e;return j(j({},super.encodeSpec(e)),{dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Te(t.compressedSegmentationBlockSize),baseVoxelOffset:Te(t.baseVoxelOffset)})}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){const n=this.spec.rank,r=this.tempChunkGridPosition,s=this.tempPositionWithinChunk,o=this.spec;{const w=o.chunkDataSize;for(let S=0;S<n;++S){const L=e[S],I=w[S],M=Math.floor(L/I);r[S]=M,s[S]=Math.floor(L-I*M)}}const l=this.chunks.get(r.join());if(l===void 0)return null;const c=l.chunkDataSize;for(let w=0;w<3;++w)if(s[w]>=c[w])return;if(t.channelSpaceShape.length===0)return l.getValueAt(s);const u=t.numChannels,f=t.chunkChannelCoordinates,g=t.chunkChannelDimensionIndices,v=g.length;let y=0;const C=new Array(u);for(let w=0;w<u;++w){for(let S=0;S<v;++S)s[g[S]]=f[y++];C[w]=l.getValueAt(s)}return C}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class TU extends JL{constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}get chunkFormat(){return this.source.chunkFormat}}let Ns=class extends Y_{};const ju="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0icGx1c0ljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9InBsdXNJY29uVGl0bGUiPlBsdXM8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0yMCAxMkw0IDEyTTEyIDRMMTIgMjAiLz4KPC9zdmc+";function iI(i={}){return Lt(j({svg:ju},i))}const DU="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYXJyb3dVcEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImFycm93VXBJY29uVGl0bGUiPkFycm93IFVwPC90aXRsZT4gICAgCiAgICA8cGF0aCBkPSJNMTggOWwtNi02LTYgNiIvPgogICAgPHBhdGggZD0iTTEyIDIxVjQiLz4KICAgIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTEyIDN2MSIvPgo8L3N2Zz4=",Hu=new gt(0);window.addEventListener("keydown",i=>{Hu.value=hy(i)});window.addEventListener("keyup",i=>{Hu.value=hy(i)});const PU=new je(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),AU=new je(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class $n extends K{constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var n=t.target;let r=n.tagName;if(n===this.target)return!1;var s=r==="TEXTAREA"||r==="INPUT"||r==="BUTTON"||r==="SELECT",o=!s&&(n.isContentEditable||n.ownerDocument&&n.ownerDocument.designMode==="on");return!s&&!o||this.allShortcutsAreGlobal||PU.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:r==="INPUT"&&AU.has(n.type)?e!=="enter":r==="INPUT"||r==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){const t=MU(e);this.shouldIgnoreEvent(t,e)||Vk(t,e,e,this.eventMap)}}function MU(i){return i.code.toLowerCase()}function ql(i,e=i.value){i.style.minWidth=e.length+1+"ch"}const xC="neuroglancer-coordinate-space-transform-singleton";function EC(i,e){let t;i===Number.NEGATIVE_INFINITY?t="(-∞,":t=`[${Math.floor(i)},`;let n;return e===Number.POSITIVE_INFINITY?n="+∞)":n=`${Math.floor(e)})`,{lower:t,upper:n}}const LC=vt.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function kC(){const i=document.createElement("div"),e=document.createElement("input");i.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),i.appendChild(e);const t=document.createElement("div"),n=document.createElement("span");n.innerHTML=DU,t.appendChild(n);const r=document.createTextNode("");return t.appendChild(r),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),i.appendChild(t),{cellElement:i,inputElement:e,suggestionElement:t}}function IC(i,e,t,n,r){if(e===void 0||e.scale===t&&e.unit===n)i.style.display="none";else{i.style.display="";const s=la(e.scale,e.unit,{elide1:!1});i.lastChild.textContent=s,i.title=`${r}${s}`}}function TC(){const i=document.createElement("input");return i.spellcheck=!1,i.autocomplete="off",i.size=1,i.placeholder=" ",i.classList.add("neuroglancer-coordinate-space-transform-output-name"),i}function DC(i,e,t){const n=i.map(v=>fd(v.value));if(n.includes(void 0))return!1;const r=Float64Array.from(n,v=>v.scale),s=Te(n,v=>v.unit),o=t.value,l=o.scales,c=o.units,u=o.rank;for(let v=0;v<u;++v)e[v]||(r[v]=l[v],s[v]=c[v]);if(_e(l,r)&&_e(c,s))return!1;const f=o.timestamps.map((v,y)=>r[y]===l[y]&&s[y]===c[y]?v:Date.now()),g=mt({valid:o.valid,rank:o.rank,scales:r,units:s,timestamps:f,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=g,!0}function PC(i,e,t,n){const r=new Float64Array(i.scales),s=Te(i.units);if(r[e]===t&&s[e]===n)return i;const o=Te(i.timestamps);return r[e]=t,s[e]=n,o[e]=Date.now(),j(j({},i),{scales:r,units:s,timestamps:o})}class RU extends K{constructor(e,t,n){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=n,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=Lt({svg:ju,text:"S"}),this.addOutputDimensionIcon=Lt({svg:ju,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=TC(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=Lt({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{const _=this.transform,H=_.value.rank;_.transform=Ts(Float64Array,H+1)}}),this.resetToDefaultButton=Lt({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{const _=this.transform;if(_.mutableSourceRank)return;const H=_.defaultTransform;let U=H.outputSpace;const B=U.ids.map(()=>lo());_.value=j(j({},H),{outputSpace:j(j({},U),{ids:B})})}});const r=this.element,s=this.registerDisposer(new $n(r,LC));s.allShortcutsAreGlobal=!0,r.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new Zr(r,LC));const o=wt(()=>this.updateView());this.registerDisposer(e.changed.add(o));const l=this.coefficientContainer,c=this.translationContainer,u=this.outputNameContainer,f=this.inputNameContainer,g=this.inputScaleContainer,v=this.inputLowerBoundsContainer,y=this.inputUpperBoundsContainer,C=this.outputScaleContainer,w=this.addOutputDimensionCell,S=this.addOutputDimensionIcon,L=this.addSourceDimensionIcon,I=this.resetToIdentityButton,M=this.resetToDefaultButton;l.style.display="contents",c.style.display="contents",u.style.display="contents",f.style.display="contents",g.style.display="contents",C.style.display="contents",v.style.display="contents",y.style.display="contents";const R=document.createElement("div");R.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),I.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),M.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),R.appendChild(I),R.appendChild(M),r.appendChild(R);for(const _ of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){var D=oe(_,2);const H=D[0],U=D[1],B=document.createElement("div");B.classList.add(`neuroglancer-coordinate-space-transform-${H}-label`),B.classList.add("neuroglancer-coordinate-space-transform-label"),B.textContent=U,r.appendChild(B)}e.mutableSourceRank&&w.appendChild(L),w.appendChild(S),w.classList.add("neuroglancer-coordinate-space-transform-output-extend");const T="Embed in additional output dimension",A="Extend to additional source dimension";S.title=T,L.title=A,w.appendChild(this.addOutputDimensionInput),w.dataset.isActive="false",S.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=T,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),L.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=A,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),r.appendChild(l),r.appendChild(u),r.appendChild(f),r.appendChild(g),r.appendChild(C),r.appendChild(v),r.appendChild(y),l.appendChild(c),r.addEventListener("input",_=>{const H=_.target;if(H instanceof HTMLInputElement){ql(H);let U=this.inputScaleElements.indexOf(H);if(U!==-1){this.inputScaleModified[U]=!0,this.updateScaleValidity(H);return}if(U=this.outputScaleElements.indexOf(H),U!==-1){this.outputScaleModified[U]=!0,this.updateScaleValidity(H);return}if(U=this.outputNameElements.indexOf(H),U!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(H)){this.updateCoefficientValidity(H);return}}});const V=(_,H,U)=>{Se(r,_,B=>{B.stopPropagation();const W=B.target;if(!(W instanceof HTMLInputElement)||U!==0&&(W.selectionStart!==W.selectionEnd||W.selectionStart!==(U===1?W.value.length:0)))return;const F=this.getElementGridPosition(W);if(F===void 0)return;const le=this.getElementByGridPosition(F.row+H,F.col+U);le!==null&&(le.focus(),B.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);const O=(_,H)=>{_.addEventListener("focusout",U=>{const B=U.relatedTarget;B instanceof Node&&_.contains(B)||H(U)})};O(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),O(u,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),O(g,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),O(C,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),Se(r,"cancel",_=>{this.curTransform=void 0,this.updateView(),_.target.blur()}),Se(l,"commit",()=>{this.updateModelTransform()}),Se(u,"commit",()=>{this.updateModelOutputNames()}),Se(g,"commit",()=>{this.updateModelInputScales()}),Se(C,"commit",()=>{this.updateModelOutputScales()}),r.addEventListener("focusin",_=>{const H=_.target;H instanceof HTMLInputElement&&H.select()}),this.updateView()}updateWillBeDeletedAttributes(e){const t=this.transform.value.rank;e===void 0&&(e=new Array(t),e.fill(!1));const n=this.coefficientElements,r=this.inputBoundsElements,s=this.inputScaleElements;for(let l=0;l<t;++l){const c=e[l];for(let g=0;g<=t;++g){const v=n[t*g+l],y=g<t&&e[g];v.dataset.willBeDeleted=(c||y).toString()}s[l].dataset.willBeDeleted=c.toString();var o=r[l];const u=o.lower,f=o.upper;u.dataset.willBeDeleted=c.toString(),f.dataset.willBeDeleted=c.toString()}}updateAddOutputDimensionCellStyle(){const e=this.addOutputDimensionInput;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){const e=this.outputNameElements,t=e.map(f=>f.value);var n=this.transform,r=n.value;const s=r.sourceRank,o=r.rank,l=n.mutableSourceRank;if(e.length!==o+1)return;const c=Rv(t);let u=new Array(o);u.fill(!1);for(let f=0;f<=o;++f){let g=c[f];t[f].length===0&&(l||f>=s)&&(g=!0,u[f]=!0),e[f].dataset.isValid=g.toString()}this.updateWillBeDeletedAttributes(u),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){const t=fd(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){const t=kt(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{const t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{const t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{const t=this.coefficientElements.indexOf(e),n=this.transform.value.rank;if(t!==-1)return{row:t%n,col:Math.floor(t/n)}}{const t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){const n=this.transform.value.rank;return e===-1?t<0||t>=n?null:this.inputScaleElements[t]:t===-2?e<0||e>n?null:this.outputNameElements[e]:t===-1?e<0||e>=n?null:this.outputScaleElements[e]:e<0||e>=n||t<0||t>n?null:this.coefficientElements[t*n+e]}dimensionRefCount(e){return(nd(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return DC(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return DC(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){const e=this.outputNameElements.map(M=>M.value);var t=this.transform;const n=t.value,r=t.mutableSourceRank,s=n.outputSpace,o=n.rank,l=n.sourceRank;if(e.length!==o+1)return;const c=[],u=[],f=e[o].length!==0;let g=l;for(let M=0;M<=o;++M){const R=e[M];if(R.length===0){if(M<l){if(!r)return!1;--g}continue}u.push(R),c.push(M)}if(!Ph(u))return!1;const v=s.names;if(!f&&_e(v,u))return!0;let y=n.inputSpace,C=n.outputSpace,w=n.transform;if(f){this.addingSourceDimension&&++g;const M=e[o],R=(nd(M)?this.localCombiner:this.globalCombiner).combined.value,D=R.names.indexOf(M);let T,A;D!==-1?(T=R.units[D],A=R.scales[D]):(T="",A=1);const V=y.boundingBoxes.map(O=>AE(O,o,o+1));this.addingSourceDimension||V.push(PE(o+1,o)),y=mt({valid:y.valid,rank:o+1,names:[...y.names,""],ids:[...y.ids,lo()],timestamps:[...y.timestamps,Date.now()],scales:Float64Array.from([...y.scales,A]),units:[...y.units,T],boundingBoxes:V,coordinateArrays:[...y.coordinateArrays,void 0]}),C=mt({valid:s.valid,rank:o+1,names:[...s.names,M],ids:[...s.ids,lo()],timestamps:[...s.timestamps,Date.now()],scales:Float64Array.from([...s.scales,A]),units:[...s.units,T],coordinateArrays:[...s.coordinateArrays,void 0]}),w=Iv(new Float64Array((o+2)**2),o+1,w,o)}w=VE(Float64Array,w,y.rank,c,c),y=Fg(y,c),C=Fg(C,c);const S=C.ids.map((M,R)=>{const D=c[R];if(D===o)return M;const T=u[R],A=v[D];return T===A||this.dimensionRefCount(A)===1&&this.dimensionRefCount(T)===(v.includes(T)?1:0)?M:lo()}),L=C.timestamps.map((M,R)=>{const D=c[R];return D===o||u[R]===v[D]?M:Date.now()});C=j(j({},C),{names:u,ids:S,timestamps:L});let I={rank:C.rank,sourceRank:g,outputSpace:C,inputSpace:y,transform:w};return this.transform.value=I,!0}updateModelTransform(){const e=this.coefficientElements,t=this.transform.value.rank,n=new Float64Array((t+1)**2);n[n.length-1]=1;for(let r=0;r<t;++r)for(let s=0;s<=t;++s){const o=e[s*t+r],l=parseFloat(o.value);if(!kt(l))return!1;n[s*(t+1)+r]=l}return this.transform.transform=n,!0}updateViewOutputNames(){var e=this.transform.value;const t=e.outputSpace,n=e.rank;if(n!==this.curRank)return;const r=this.outputNameElements,s=t.names;for(let o=0;o<n;++o){const l=r[o];l.value=s[o],l.dataset.isValid="true",ql(l)}r[n].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){var e=this.transform.value;const t=e.transform,n=e.rank,r=this.coefficientElements;for(let s=0;s<n;++s)for(let o=0;o<=n;++o){const l=r[o*n+s];l.value=t[o*(n+1)+s].toString(),l.dataset.isValid="true",ql(l)}}ensureViewRankUpdated(){const e=this.transform.value,t=e.rank,n=e.sourceRank;if(this.curSourceRank===n&&this.curRank===t)return;const r=this.inputBoundsElements,s=this.inputNameElements,o=this.inputScaleElements,l=this.element,c=this.coefficientElements,u=this.outputNameElements,f=this.outputScaleElements,g=this.outputScaleSuggestionElements,v=this.inputScaleSuggestionElements,y=this.outputBoundsElements,C=this.coefficientContainer,w=this.translationContainer,S=this.outputNameContainer,L=this.inputNameContainer,I=this.inputScaleContainer,M=this.inputLowerBoundsContainer,R=this.inputUpperBoundsContainer,D=this.outputScaleContainer;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,nt(C),nt(w),C.appendChild(w),nt(S),nt(L),nt(I),nt(M),nt(R),nt(D),s.length=0,o.length=0,r.length=0,f.length=0,g.length=0,v.length=0,c.length=0,u.length=0,y.length=0;for(let V=0;V<t;++V){const O=_=>{_.classList.add("neuroglancer-coordinate-space-transform-input"),V>=n&&_.classList.add(xC)};{const _=document.createElement("div");_.classList.add("neuroglancer-coordinate-space-transform-input-name"),O(_),_.style.gridRowStart="sourceNames",_.style.gridColumnStart=`sourceDim ${V+1}`,L.appendChild(_),s.push(_)}{var T=kC();const _=T.cellElement,H=T.inputElement,U=T.suggestionElement;_.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),O(_),_.style.gridRowStart="sourceScales",_.style.gridColumnStart=`sourceDim ${V+1}`,I.appendChild(_),o.push(H),v.push(U);const B=V;U.addEventListener("click",()=>{const W=QS(this.transform,B);W!==void 0&&(this.transform.inputSpace.value=PC(this.transform.inputSpace.value,B,W.scale,W.unit))})}{const _=document.createElement("div");O(_),_.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),_.style.gridRowStart="sourceLower",_.style.gridColumnStart=`sourceDim ${V+1}`,M.appendChild(_);const H=document.createElement("div");O(H),H.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),H.style.gridRowStart="sourceUpper",H.style.gridColumnStart=`sourceDim ${V+1}`,R.appendChild(H),r.push({lower:_,upper:H})}}for(let V=0;V<t;++V){for(let O=0;O<=t;++O){const _=document.createElement("input");_.classList.add("neuroglancer-coordinate-space-transform-coeff"),_.spellcheck=!1,_.autocomplete="off",_.size=1,_.style.gridRowStart=`outputDim ${V+1}`,_.placeholder=" ",_.style.gridColumnStart=`sourceDim ${O+1}`,c[O*t+V]=_,O===t?_.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):O==n&&_.classList.add(xC),(O===t?w:C).appendChild(_)}{var A=kC();const O=A.cellElement,_=A.suggestionElement,H=A.inputElement;O.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),O.style.gridRowStart=`outputDim ${V+1}`,O.style.gridColumnStart="outputScales";const U=V;_.addEventListener("click",()=>{const B=this.transform.value,W=XS(B,U);W!==void 0&&(this.transform.outputSpace.value=PC(B.outputSpace,U,W.scale,W.unit))}),g.push(_),D.appendChild(O),f.push(H)}{const O=document.createElement("div");O.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),O.style.gridRowStart=`outputDim ${V+1}`,O.style.gridColumnStart="outputNames";const _=TC();_.title="Rebind to a different dimension",V>=n?_.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(_.title+=", or delete to remove source dimension"),_.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",u.push(_),S.appendChild(O),O.appendChild(_);const H=document.createElement("div");H.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),O.appendChild(H);const U=document.createElement("div");U.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),O.appendChild(U),y.push({lower:H,upper:U}),O.addEventListener("mousedown",B=>{B.target!==_&&(_.focus(),B.preventDefault())})}}u.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",S.appendChild(this.addOutputDimensionCell),this.curSourceRank=n,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;var e=this.transform.value;const t=e.inputSpace,n=e.rank,r=e.sourceRank,s=this.inputBoundsElements,o=this.inputNameElements,l=this.inputScaleElements,c=this.inputScaleSuggestionElements,u=t.names,f=t.scales,g=t.units;var v=t.bounds;const y=v.lowerBounds,C=v.upperBounds;for(let S=0;S<n;++S){const L=l[S],I=f[S],M=g[S];L.value=la(I,M,{elide1:!1}),L.dataset.isValid="true",ql(L);let R;if(S<r){let V=u[S];V||(V=`${S}`),o[S].textContent=V,R=`source dimension ${V}`,L.title=`Override scale of ${R}`}else R="singleton dimension",L.title=`Set extent of ${R}`;var w=EC(y[S],C[S]);const D=w.lower,T=w.upper,A=s[S];A.lower.textContent=D,A.lower.title=`Lower bound of ${R}`,A.upper.title=`Upper bound of ${R}`,A.upper.textContent=T,IC(c[S],QS(this.transform,S),I,M,`Revert scale of ${R} to `)}}updateViewOutputScales(){const e=this.transform.value;var t=e.outputSpace;const n=t.rank,r=t.names,s=t.units,o=t.scales;var l=t.bounds;const c=l.lowerBounds,u=l.upperBounds,f=this.outputScaleElements,g=this.outputBoundsElements,v=this.outputScaleSuggestionElements;for(let C=0;C<n;++C){const w=f[C],S=o[C],L=s[C];w.value=la(S,L,{elide1:!1}),ql(w);const I=r[C];w.dataset.isValid="true";const M=`Change coordinates of ${nd(I)?"local":"global"} dimension ${I}`;w.title=`${M} (does not rescale the source)`;var y=EC(c[C],u[C]);const R=y.lower,D=y.upper,T=g[C];T.lower.textContent=R,T.upper.textContent=D,IC(v[C],XS(e,C),S,L,`${M} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){var n=this.transform;const r=n.value,s=n.mutableSourceRank,o=n.defaultTransform,l=r.rank;this.resetToIdentityButton.style.visibility=e||!yV(r.transform,l+1,l+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!s&&(e||t||!BV(o,r))?"visible":"hidden"}updateView(){const e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){Bt(this.element),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function NU(i,e,{horizontal:t=!1,vertical:n=!0,topMargin:r=6,bottomMargin:s=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:u=!0}={}){const f=e.getBoundingClientRect();if(t){const g=i.ownerDocument.documentElement.clientWidth;let v=f.right,y=g-f.left;v>y?(i.style.left="",i.style.right=`${g-f.right}px`,u&&(i.style.maxWidth=v-o+"px")):(i.style.right="",i.style.left=`${f.left}px`,u&&(i.style.maxWidth=y-l+"px"))}if(n){const g=i.ownerDocument.documentElement.clientHeight;let v=f.top-r,y=g-f.bottom-s;i.style.left=`${f.left}px`,i.style.width=`${f.width}px`,v>y*3?(i.style.top="",i.style.bottom=`${g-f.top}px`,c&&(i.style.maxHeight=v+"px")):(i.style.top=`${f.bottom}px`,i.style.bottom="",c&&(i.style.maxHeight=y+"px"))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function VU(i){let e=pv(i);var t=e.next();let n=t.value;if(t.done)return"";let r=n.length;for(;r>0;){var s=e.next();let o=s.value;if(s.done)break;let l=0;for(;l<r&&n.charCodeAt(l)===o.charCodeAt(l);++l);r=l}return n.substring(0,r)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const AC=10,tu=.5;class OU{constructor(){this.anchorIndex=0,this.anchorClientOffset=0}splice(e){let t=this.anchorIndex,n=0;for(const r of e){if(n+=r.retainCount,t<n)break;const s=r.deleteCount;if(t<n+s){t=n;break}const o=r.insertCount;t=t-s+o,n+=o-o}this.anchorIndex=t}}class MC{constructor(){this.startIndex=0,this.endIndex=0,this.anchorIndex=0,this.anchorOffset=0,this.scrollOffset=0}}class BU{constructor(){this.itemSize=[],this.totalKnownSize=0,this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!==null&&t!==void 0?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,n=0){for(;t<e;++t)n+=this.getEstimatedSize(t);for(;t>e;--t)n-=this.getEstimatedSize(t-1);return n}getRangeSize(e,t){var n;let r=0;const s=this.itemSize,o=this.averageSize;for(let l=e;l<t;++l)r+=(n=s[l])!==null&&n!==void 0?n:o;return r}splice(e){let t=this.itemSize;t=this.itemSize=g2(t,e),this.totalKnownSize=t.reduce((n,r)=>n+r,0),this.numItemsInTotalKnownSize=t.reduce(n=>n+1,0)}}function _U(i,e,t,n,r,s){let o=s.anchorIndex,l=s.anchorClientOffset,c=r.getEstimatedOffset(o),u,f,g,v,y;if(n===0||r.totalKnownSize===0)u=Math.max(0,o-AC/2),f=Math.min(t,u+AC),y=o,g=0,v=l;else{const C=r.getEstimatedTotalSize(),w=Math.max(0,C-n);v=c-l,v=Math.max(0,Math.min(w,v));const S=v-2*tu*n,L=v-tu*n,I=v+n+tu*n,M=c-l+n+2*tu*n;u=Math.min(t,e.startIndex);let R=r.getEstimatedOffset(u,o,c);if(R<S)for(;u+1<t;++u){const T=r.getEstimatedSize(u);if(R+T>=L)break;R+=T}if(R>=L)for(;R>S&&u>0;--u){const T=r.getEstimatedSize(u-1);R-=T}f=Math.min(t,e.endIndex);let D=r.getEstimatedOffset(f,o,c);if(D<I)for(;D<=M&&f+1<=t;++f){const T=r.getEstimatedSize(f);D+=T}else if(D>=M)for(;f>u;--f){const T=r.getEstimatedSize(f-1);if(D-T<I)break;D-=T}for(y=o,g=c;y<u;++y){const T=r.getEstimatedSize(y);g+=T}for(;y>f;--y){const T=r.getEstimatedSize(y-1);g-=T}}i.startIndex=u,i.endIndex=f,i.anchorIndex=y,i.anchorOffset=g,i.scrollOffset=v}function FU(i,e){const t=e.getEstimatedOffset(i.anchorIndex),n=i.anchorOffset;i.anchorOffset=t,i.scrollOffset+=t-n}function UU(i,e){return i.startIndex<e.startIndex||i.endIndex>e.endIndex}class xy extends K{constructor(e){super(),this.element=document.createElement("div"),this.scrollContent=document.createElement("div"),this.header=document.createElement("div"),this.body=document.createElement("div"),this.topItems=document.createElement("div"),this.bottomItems=document.createElement("div"),this.renderedItems=[],this.renderGeneration=-1,this.listGeneration=-1,this.newRenderedItems=[],this.state=new OU,this.renderParams=new MC,this.newRenderParams=new MC,this.sizes=new BU,this.debouncedUpdateView=this.registerCancellable(wt(()=>this.updateView())),this.resizeObserver=new ResizeObserver(()=>this.updateView());const t=e.selectedIndex;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);const n=this.source=e.source;this.sizes.itemSize.length=n.length;const r=this.element,s=this.header,o=this.body,l=this.scrollContent,c=this.topItems,u=this.bottomItems;this.resizeObserver.observe(r),this.registerDisposer(()=>this.resizeObserver.disconnect()),r.appendChild(l),r.style.overflowAnchor="none",l.appendChild(s),l.appendChild(o),s.style.position="sticky",s.style.zIndex="1",s.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",s.style.width="min-content",s.style.minWidth="100%",u.style.width="min-content",u.style.minWidth="100%"):(l.style.width="100%",s.style.width="100%",u.style.width="100%"),o.appendChild(c),o.appendChild(u),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",u.style.height="0",u.style.position="relative",r.addEventListener("scroll",()=>{const f=r.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-f,this.renderParams.scrollOffset=f,this.debouncedUpdateView()}),n.changed!==void 0&&this.registerDisposer(n.changed.add(f=>{this.sizes.splice(f),this.state.splice(f),this.renderedItems.length=0,this.debouncedUpdateView()})),n.renderChanged!==void 0&&this.registerDisposer(n.renderChanged.add(this.debouncedUpdateView))}updateView(){const e=this.element;if(e.offsetHeight===0)return;const t=e.clientHeight-this.header.offsetHeight,n=this.source,r=this.state,s=this.sizes,o=n.length,l=this.body,c=this.topItems,u=this.bottomItems,f=n.changed,g=n.renderChanged;let v;for(;;){v=this.newRenderParams;const S=this.renderParams;_U(v,S,o,t,s,r);let L;if(g!==void 0&&g.count!==this.renderGeneration||f!==void 0&&f.count!==this.listGeneration?(this.renderGeneration=g===void 0?-1:g.count,this.listGeneration=f===void 0?-1:f.count,L=!0,this.renderedItems.length=0):L=!1,!L&&!UU(v,S)){S.scrollOffset=v.scrollOffset,v=S;break}this.renderParams=v,this.newRenderParams=S;const I=this.renderedItems,M=this.newRenderedItems;M.length=0,this.renderedItems=M,this.newRenderedItems=I;const R=this.source,D=R.render;var y=v;const T=y.startIndex,A=y.endIndex,V=y.anchorIndex;function*O(_,H){for(let U=_;U<H;++U){let B=I[U];B===void 0&&(B=D.call(R,U)),M[U]=B,yield B}}sr(c,O(T,V)),sr(u,O(V,A));for(let _=T;_<A;++_){const H=M[_].getBoundingClientRect().height,U=s.itemSize[_];U!==void 0&&(s.totalKnownSize-=U,--s.numItemsInTotalKnownSize),s.itemSize[_]=H,s.totalKnownSize+=H,++s.numItemsInTotalKnownSize}}FU(v,s),r.anchorIndex=v.anchorIndex,r.anchorClientOffset=v.anchorOffset-v.scrollOffset;const C=s.getRangeSize(v.startIndex,v.anchorIndex),w=s.getEstimatedTotalSize();l.style.height=`${w}px`,c.style.top=`${v.anchorOffset-C}px`,u.style.top=`${v.anchorOffset}px`,e.scrollTop=v.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){var t=this.renderParams;const n=t.startIndex,r=t.endIndex,s=this.renderedItems;for(let o=n;o<r;++o){const l=s[o];l!==void 0&&e(l,o)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){const t=this.sizes.getEstimatedOffset(e),n=t+this.sizes.getEstimatedSize(e),r=this.element.scrollTop;if(t<r)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>r&&n>r+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){Bt(this.element)}}const Yf="neuroglancer-multiline-autocomplete-completion-active";function zU(i){let e=document.createElement("div");return e.textContent=i.value,e}function*RC(i){for(;i.length>0;){const e=i.match(/[:/_]+/);if(e===null){yield i;return}const t=e.index+e[0].length;yield i.substring(0,t),i=i.substring(t)}}function GU(i){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=i.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=i.description||"",e.appendChild(t),e}const WU=vt.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),$U=200;class jU extends K{constructor(e){super(),this.element=document.createElement("div"),this.inputElement=document.createElement("span"),this.hintElement=document.createElement("span"),this.completionsVirtualList=void 0,this.onCommit=new at,this.onInput=new at,this.prevInputValue="",this.completionsVisible=!1,this.activeCompletionPromise=null,this.activeCompletionCancellationToken=void 0,this.hasFocus=!1,this.completionResult=null,this.dropdownContentsStale=!0,this.hasResultForDropdown=!1,this.commonPrefix="",this.completionDisabled=-1,this.activeIndex=-1,this.dropdownStyleStale=!0,this.resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()},this.resizeObserver=new ResizeObserver(this.resizeHandler),this.debouncedUpdateHintState=this.registerCancellable(ct(()=>this.updateHintState(),0)),this.completer=e.completer;var t=e.delay;const n=t===void 0?$U:t;let r=this.scheduleUpdateCompletions=ct(()=>{const u=this.activeCompletionCancellationToken=new Ps;let f=this.activeCompletionPromise=this.completer(this.value,u);f!==null&&f.then(g=>{this.activeCompletionPromise===f&&(this.setCompletions(g),this.activeCompletionPromise=null)})},n);this.registerDisposer(()=>{r.cancel()});const s=this.element,o=this.inputElement,l=this.hintElement;s.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.unobserve(o)),o.contentEditable="true",o.spellcheck=!1,s.appendChild(document.createTextNode("​")),s.appendChild(o),s.appendChild(l),o.classList.add("neuroglancer-multiline-autocomplete-input"),l.classList.add("neuroglancer-multiline-autocomplete-hint"),o.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),o.addEventListener("copy",u=>{const f=u.clipboardData;if(f!==null){const g=window.getSelection();g!==null&&!g.isCollapsed&&g.containsNode(o,!0)&&f.setData("text/plain",g.toString())}u.preventDefault(),u.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{const u=this.getSelectionRange(),f=this.completionDisabled;u!==void 0&&u.begin===f&&u.end===f||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),s.addEventListener("pointerdown",u=>{const f=u.target;if(f instanceof Node){if(o.contains(f))return;const g=this.completionsVirtualList;if(g!==void 0&&g.element.contains(f))return}o===document.activeElement&&(this.moveCaretToEndOfInput(),u.stopPropagation(),u.preventDefault())}),s.addEventListener("click",()=>{o.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();const u=document.createRange(),f=o.childNodes;u.setStart(o,0),f.length===0?u.setEnd(o,0):u.setEndAfter(f[f.length-1]);const g=window.getSelection();g!==null&&(g.removeAllRanges(),g.addRange(u)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{this.hasFocus&&(this.hasFocus=!1,this.updateDropdown()),this.debouncedUpdateHintState();const u=window.getSelection();u!==null&&u.containsNode(this.inputElement,!0)&&u.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});const c=this.registerDisposer(new $n(o,WU));c.allShortcutsAreGlobal=!0,Se(o,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),Se(o,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),Se(o,"home",()=>{this.moveCaretToBeginningOfInput()}),Se(o,"end",()=>{this.moveCaretToEndOfInput()}),Se(o,"choose-active-completion-or-prefix",u=>{this.selectActiveCompletion(!0)&&u.preventDefault()}),Se(o,"commit",u=>{if(this.selectActiveCompletion(!1))u.stopPropagation();else{let f=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,f)}}),Se(o,"cancel",u=>{u.stopPropagation(),this.cancel()&&(u.detail.preventDefault(),u.detail.stopPropagation())})}disableCompletion(){const e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){const e=window.getSelection();if(e===null||e.rangeCount===0)return;const t=e.getRangeAt(0),n=this.inputElement,r=document.createRange();r.setStart(n,0),r.setEnd(t.startContainer,t.startOffset);const s=r.toString().length,o=e.toString().length;return{begin:s,end:s+o}}setValueAndSelection(e,t=void 0){const n=this.completionDisabled!==-1;this.onInput.dispatch(e);const r=this.inputElement;nt(r);let s=0;const o=t!==void 0?document.createRange():void 0;let l=!0;for(const c of RC(e)){l||r.appendChild(document.createElement("wbr")),l=!1;const u=s+c.length,f=document.createTextNode(c);if(r.appendChild(f),o!==void 0){const g=t.begin,v=t.end;g>=s&&g<=u&&o.setStart(f,g-s),v>=s&&v<=u&&o.setEnd(f,v-s)}s=u}if(o!==void 0){l&&(o.setStart(r,0),o.setEnd(r,0));const c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=n&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){const e=this.inputElement;if(document.activeElement!==e)return!1;const t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){const e=this.value;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let t=this.completionsVirtualList;if(t===void 0)return;const n=t.element;for(let r=e.target;r instanceof HTMLElement&&r!==n;r=r.parentElement){const s=r.dataset.completionIndex;if(s!==void 0){this.selectCompletion(Number(s));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let t=this.activeIndex,n=this.completionResult.completions.length;t===-1?e>0?t=0:t=n-1:t=(t+e+n)%n,this.setActiveIndex(t)}shouldShowDropdown(){return this.completionResult===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){const e=this.completionsVirtualList,t=this.element;e!==void 0&&NU(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let e=this.completionsVirtualList;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();const r=this.completionResult;var t=r.makeElement;const s=t===void 0?zU:t;e=this.completionsVirtualList=new xy({source:{length:r.completions.length,render:o=>{const l=r.completions[o],c=s.call(r,l);return c.classList.add("neuroglancer-multiline-autocomplete-completion"),c.dataset.completionIndex=`${o}`,this.activeIndex===o&&c.classList.add(Yf),c}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",o=>{this.inputElement.focus(),o.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);const n=this.activeIndex;n!==-1&&this.completionsVirtualList.scrollItemIntoView(n)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let t=e.completions;if(t.length===0)return;const n=this.prevInputValue;if(n!==void 0){if(this.completionResult=e,t.length===1){let r=t[0];e.showSingleResult?this.hasResultForDropdown=!0:r.value.startsWith(n)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let r=VU(function*(){for(let o of e.completions)yield o.value}()),s=this.getCompletedValue(r);s.startsWith(n)&&(this.commonPrefix=s,this.setHintValue(s))}this.updateDropdown()}}setHintValue(e){const t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);const n=this.hintElement;nt(n);let r=!0;for(const s of RC(e)){r||n.appendChild(document.createElement("wbr")),r=!1;const o=document.createTextNode(s);n.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){let t=this.activeIndex;const n=this.completionsVirtualList;if(n!==void 0){if(t!==-1){const r=n.getItemElement(t);r!==void 0&&r.classList.remove(Yf)}if(e!==-1){let r=n.getItemElement(e);r!==void 0&&r.classList.add(Yf),n.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,n=this.prevInputValue;return n===void 0?"":n.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){const e=document.createRange(),t=this.inputElement;e.setStart(t,0),e.setEnd(t,0);const n=window.getSelection();n!==null&&(n.removeAllRanges(),n.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){const e=document.createRange(),t=this.inputElement,n=t.childNodes,r=n[n.length-1];r===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(r),e.setEndAfter(r));const s=window.getSelection();s!==null&&(s.removeAllRanges(),s.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let t=this.activeIndex;if(t===-1){if(!e)return!1;let r=this.completionResult;if(r!==null&&r.completions.length===1)t=0;else{let s=this.commonPrefix;return s.length>this.value.length?(this.value=s,this.moveCaretToEndOfInput(),!0):!1}}let n=this.getCompletedValueByIndex(t);return this.value===n?!1:(this.value=n,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;const e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";const e=this.completionsVirtualList;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){const e=this.completionsVirtualList;e!==void 0&&e.dispose(),Bt(this.element),this.cancelActiveCompletion(),super.disposed()}}class qr extends K{constructor(e=new Zt(Zt.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div"),this.element.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){Bt(this.element),super.disposed()}}class HU extends K{constructor(){super(...arguments),this.changed=new xe,this.options=new ue,this.optionsChanged=new xe,this.selectedValue=void 0,this.defaultValue=void 0,this.ready_=!0}get value(){const e=this.selectedValue;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0),this.selectedValue!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){const e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){const n=this.options;if(n.has(e))throw new Error(`Option already defined: ${se(e)}.`);n.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}toJSON(){const e=this.value,t=this.defaultValue;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}}class JU extends K{constructor(e,t,n=new Zt(Zt.VISIBLE),r=!1){super(),this.getter=e,this.selected=t,this.visibility=n,this.invalidateByDefault=r,this.element=document.createElement("div"),this.tabs=new ue,this.tabVisibilityChanged=new at,this.debouncedUpdateSelectedTab=this.registerCancellable(wt(()=>this.updateSelectedTab()));const s=this.element;s.className="neuroglancer-stack-view",this.registerDisposer(n.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){const t=this.tabs,n=t.get(e);n!==void 0&&(n.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){const t=this.tabs.get(e);t!==void 0&&(t.visibility.value=Zt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){const t=this.tabs;let n=t.get(e);n===void 0&&(n=this.getter(e),this.element.appendChild(n.element),t.set(e,n)),n.element.style.display="",n.visibility.value=Zt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){const e=this.displayedTab,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){const t=this.tabs;for(const r of t){var n=oe(r,2);const s=n[0],o=n[1];e!==void 0&&e(s)||(t.delete(s),o.dispose())}this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),Bt(this.element),super.disposed()}}class ZU extends HU{}function qU(i,e){const t="neuroglancer-selected-tab-label";e?i.classList.add(t):i.classList.remove(t)}class YU extends K{constructor(e,t=new Zt(Zt.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new ue,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable(wt(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;const n=this.element,r=this.tabBar;n.className="neuroglancer-tab-view",r.className="neuroglancer-tab-view-bar",n.appendChild(r),this.registerDisposer(t.changed.add(this.debouncedUpdateView));const s=this.stack=this.registerDisposer(new JU(e.makeTab,e.selectedTab,this.visibility));n.appendChild(s.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add(()=>this.updateTabLabelStyles())),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){const e=this.selectedTab.value;for(const n of this.tabLabels){var t=oe(n,2);const r=t[0],s=t[1];qU(s,r===e)}}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{const e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:n})=>n===t)!==void 0)}nt(this.tabBar),this.tabsGeneration=-1}}makeTabs(){const e=this.tabBar,t=this.tabLabels,n=this.handleTabElement;for(const r of this.tabs.value){const s=r.id,o=r.label,l=document.createElement("div");l.classList.add("neuroglancer-tab-label"),l.textContent=o,l.addEventListener("click",()=>{this.selectedTab.value=s}),n!==void 0&&n(s,l),t.set(s,l),e.appendChild(l)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){nt(this.tabBar),this.tabLabels.clear(),Bt(this.element),super.disposed()}}class KU extends jU{constructor(e){const t=e.source.layer.manager,n=(s,o)=>t.dataSourceProviderRegistry.completeUrl({url:s,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:GU,offset:l.offset,showSingleResult:!0}));super({completer:n,delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new gt(!1);const r=s=>{s!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};r(""),this.onInput.add(r)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class nI extends K{constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");const t=this.registerCancellable(wt(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>Bt(this.element)),this.updateView()}updateView(){const e=this.model,t=e.changed.count;if(t===this.generation)return;this.generation=t;const n=this.element;nt(n);const r=new je;for(const s of e){const o=`${s.severity} ${s.message}`;if(r.has(o))continue;r.add(o);const l=document.createElement("li");n.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${lr[s.severity]}`),l.textContent=s.message}}}class XU extends K{constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");const n=this.element;n.classList.add("neuroglancer-layer-data-source-subsource");const r=document.createElement("label"),s=document.createElement("span"),o=()=>{r.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));const l=this.registerDisposer(new As({get value(){return t.enabled},set value(C){t.enabled=C,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));r.classList.add("neuroglancer-layer-data-sources-info-line"),r.appendChild(l.element);const c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");const u=t.subsourceEntry.id;u!=="default"&&(c.textContent=u),r.appendChild(c),s.classList.add("neuroglancer-layer-data-sources-source-type");const f=this.registerDisposer(new nI(this.loadedSubsource.messages));n.appendChild(r),r.appendChild(s),n.appendChild(f.element);let g="";const v=t.subsourceEntry.subsource,y=v.volume;if(y instanceof Ns)g=`${J[y.dataType].toLowerCase()} volume`;else if(v.mesh instanceof Kd)g="meshes (single-res.)";else if(v.mesh instanceof Xh)g="meshes (multi-res.)";else if(v.mesh instanceof Qh)g="skeletons";else if(v.segmentPropertyMap!==void 0)g="segment property map";else if(v.local!==void 0)switch(v.local){case zr.annotations:g="Local annotations";break;case zr.equivalences:g="local segmentation graph";break}else v.staticAnnotations!==void 0?g="default annotations":v.annotation!==void 0?g="annotations":v.singleMesh!==void 0?g="single mesh":v.segmentationGraph!==void 0&&(g="segmentation graph");s.textContent=g}}class QU extends K{constructor(e){super(),this.source=e,this.element=document.createElement("div");const t=this.element,n=document.createElement("label");n.classList.add("neuroglancer-layer-data-sources-source-default"),n.appendChild(this.registerDisposer(new As({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(s){if(e.enableDefaultSubsources!==s){if(e.enableDefaultSubsources=s,s)for(const o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),n.appendChild(document.createTextNode("Enable default subsource set")),n.title="Enable the default set of subsources for this data source.",t.appendChild(n);for(const s of e.subsources)t.appendChild(this.registerDisposer(new XU(e,s)).element);const r=e.transform;if(r.mutableSourceRank||r.value.sourceRank!==0){const s=this.registerDisposer(new RU(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(s.element)}this.registerDisposer(()=>Bt(this.element))}}class ez extends K{constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;const n=this.urlInput=this.registerDisposer(new KU(this)),r=(o,l)=>{const c=this.source,u=c.spec,f=this.source.layer;if(o=f.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==n.value&&(n.disableCompletion(),n.setValueAndSelection(o,{begin:o.length,end:o.length})),n.dirty.value=!1,o&&o===u.url){l&&e.detectedLayerConstructor!==void 0&&rI(c.layer);return}if(f instanceof $r)try{const g=f.manager.dataSourceProviderRegistry.suggestLayerName(o);tT(f.managedLayer,g)}catch{}c.spec=j(j({},u),{url:o})};n.onCommit.add(r);const s=this.element;s.classList.add("neuroglancer-layer-data-source"),s.appendChild(n.element),s.appendChild(this.registerDisposer(new nI(t.messages)).element),this.updateView()}updateView(){const e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;const t=this.source.loadState;let n=this.loadedView;if(n!==void 0){if(n.source===t)return;n.dispose(),n=this.loadedView=void 0}t instanceof ay&&(n=this.loadedView=new QU(t),this.element.appendChild(n.element))}disposed(){const e=this.loadedView;e!==void 0&&e.dispose(),Bt(this.element),super.disposed()}}function rI(i){if(i instanceof $r){const e=i.detectedLayerConstructor;if(e!==void 0)return Oy(i.managedLayer,e),!0}return!1}class tz extends qr{constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new ue,this.addDataSourceIcon=iI({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;const t=this.element,n=this.dataSourcesContainer;t.classList.add("neuroglancer-layer-data-sources-tab"),n.classList.add("neuroglancer-layer-data-sources-container");const r=this.addDataSourceIcon;if(r.style.alignSelf="start",r.addEventListener("click",()=>{const o=this.layer.addDataSource(void 0);this.updateView();const l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof $r){const o=this.layerTypeDetection,l=this.layerTypeElement;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{rI(e)})}const s=this.reRender=wt(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(s)),this.registerDisposer(this.visibility.changed.add(s)),this.updateView()}updateLayerTypeDetection(){const e=(()=>{const n=this.layer;if(!(n instanceof $r))return;const r=n.detectedLayerConstructor;if(r!==void 0){for(const s of this.sourceViews.values())if(s.urlInput.dirty.value)return;return r}})();if(e===this.detectedLayerConstructor)return;const t=this.layerTypeDetection;if(this.detectedLayerConstructor=e,e!==void 0){const n=this.layerTypeElement;n.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){const e=this.sourceViews;for(const t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;const e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;const n=Date.now(),r=this.sourceViews,s=this.layer;function*o(){let l=!0;const c=s.dataSources;for(const u of c){let f=r.get(u);f===void 0&&(f=new ez(this,u),f.registerDisposer(f.urlInput.dirty.changed.add(this.reRender)),r.set(u,f)),f.seenGeneration=n,f.updateView();const g=u.spec.url;c.length===1&&g===""&&setTimeout(()=>{f.urlInput.inputElement.focus()},0),l=u.spec.url.length===0,yield f.element}l||(yield this.addDataSourceIcon)}sr(this.dataSourcesContainer,o.call(this));for(const l of r){var t=oe(l,2);const c=t[0],u=t[1];u.seenGeneration!==n&&(u.dispose(),r.delete(c))}}this.updateLayerTypeDetection()}}const iu="tab",NC="tabs",VC="panels",iz=j(j({},Sa),{row:0}),sI=j(j({},Sa),{visible:!0,row:0});class Td extends K{constructor(e){super(),this.panels=e,this.layer=this.panels.layer,this.location=new Rs(sI),this.tabsChanged=new at,this.selectedTab=new gt(void 0),this.tabs=[]}initialize(){const e=this.panels;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var t;e.specificationChanged.dispatch();const n=this.layer,r=n.manager.root.selectedLayer;if(((t=r.layer)===null||t===void 0?void 0:t.layer)!==n||this!==n.panels.panels[0])return;const s=this.location.value;r.location.value!==s&&(r.location.value=s,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)})}normalizeTabs(){const e=this.tabs;if(e.length===0){this.selectedTab.value=void 0;return}const t=this.layer.tabs.options,n=o=>{var l;return(l=t.get(o).order)!==null&&l!==void 0?l:0};e.sort((o,l)=>n(o)-n(l));const r=this.selectedTab,s=r.value;(s===void 0||!e.includes(s))&&(r.value=e[0])}pin(){var e;const t=this.layer,n=t.manager.root.selectedLayer;if(((e=n.layer)===null||e===void 0?void 0:e.layer)!==t||this!==t.panels.panels[0]||this.tabs.length===0)return;const r=this.panels,s=t.registerDisposer(new Td(r));r.panels.splice(0,1,s),r.panels.push(this),r.updateTabs(),s.initialize(),n.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var e;const t=this.panels,n=t.panels.indexOf(this);if(n===-1||n===0)return;const r=this.layer,s=r.manager.root.selectedLayer,o=(e=s.layer)===null||e===void 0?void 0:e.layer;s.visible&&o!=null&&o!=r&&o.panels.panels[0].pin(),t.panels.splice(n,1);var l=t.panels.splice(0,1,this),c=oe(l,1);const u=c[0];if(this.explicitTabs===void 0)r.unregisterDisposer(u);else{t.panels.push(u);for(let f=1,g=t.panels.length;f<g;++f){const v=t.panels[f];v.explicitTabs===void 0&&(v.explicitTabs=new je(v.tabs))}}this.explicitTabs=void 0,t.updateTabs(),s.layer=r.managedLayer,s.location.value=this.location.value,s.location.locationChanged.dispatch(),s.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;const n=this.panels;{const o=this.explicitTabs;o!==void 0&&o.delete(e)}const r=this.layer,s=r.registerDisposer(new Td(n));s.location.value=t,s.explicitTabs=new je([e]),n.panels.splice(1,0,s),n.updateTabs(),s.initialize(),r.manager.root.layerManager.layersChanged.dispatch(),n.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{const r=this.explicitTabs;r!==void 0&&r.delete(e)}{const r=t.explicitTabs;r!==void 0&&r.add(e)}const n=this.panels;n.updateTabs(),t.selectedTab.value=e,n.specificationChanged.dispatch()}mergeInto(e){const t=e.explicitTabs;if(t!==void 0)for(const n of this.tabs)t.add(n);this.panels.removePanel(this)}}class nz{constructor(e){this.layer=e,this.specificationChanged=new at,this.updating=!1,this.panels=[e.registerDisposer(new Td(this))]}restoreState(e){const t=this.panels;t[0].selectedTab.value=we(e,iu,Ie);const n=this.layer,r=n.tabs,s=new je(r.options.keys());we(e,VC,o=>He(o,l=>{ge(l);const c=new Td(this);c.location.restoreState(l),c.location.visible&&(c.selectedTab.value=we(l,iu,Ie),c.explicitTabs=we(l,NC,u=>{const f=new je;for(const g of Sn(u))s.has(g)&&(s.delete(g),f.add(g));return f}),c.explicitTabs===void 0?(c.tabs=Te(s),s.clear()):c.tabs=Te(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),n.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Te(s),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;const t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var e;const t=this.layer,n=t.tabs,r=new je(n.options.keys()),s=this.panels;this.updating=!0;const o=l=>{const c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Te(r),r.clear();else{l.tabs=Te(l.explicitTabs);for(const u of l.tabs)r.delete(u)}_e(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<s.length;){const c=s[l];if(c.location.visible&&(o(c),c.tabs.length!==0)){++l;continue}s.splice(l,1),t.unregisterDisposer(c)}if(o(s[0]),s[0].tabs.length===0){const l=this.layer.manager.root.selectedLayer;((e=l.layer)===null||e===void 0?void 0:e.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var e;const t=this.panels,n={};if(n[iu]=t[0].selectedTab.value,t.length>1){const r=[];for(let s=1,o=t.length;s<o;++s){const l=t[s],c=(e=l.location.toJSON())!==null&&e!==void 0?e:{};c[iu]=l.selectedTab.value;const u=l.explicitTabs;u!==void 0&&(c[NC]=Te(u)),r.push(c)}n[VC]=r}return n}}const rz=/^[A-Z]$/;class OC extends K{constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(Se(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}}class Uo extends K{constructor(e,t=!1){super(),this.layer=e,this.toggle=t,this.changed=new at,this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){const e=this.layer,t=this.keyBinding;t!==void 0&&e.toolBinder.set(t,void 0)}}class aI extends K{constructor(e){super(),this.layer=e,this.changed=new at}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){const e=this.layer;e.tool.value===this&&(e.tool.value=void 0)}}function BC(i,e){var t;if(e===void 0)return;typeof e=="string"&&(e={type:e}),ge(e);const n=Y(e,"type",Ie);let r=(t=cm.get(i.constructor))===null||t===void 0?void 0:t.get(n);if(r===void 0&&(r=az.get(n)),r===void 0)throw new Error(`Invalid tool type: ${se(e)}.`);return r(i,e)}function sz(i,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),ge(e);const t=Y(e,"type",Ie),n=oI.get(t);if(n===void 0)throw new Error(`Invalid tool type: ${se(e)}.`);return n(i,e)}const oI=new ue,az=new ue,cm=new ue;function ic(i,e){oI.set(i,e)}function Dd(i,e,t){let n=cm.get(i);n===void 0&&(n=new ue,cm.set(i,n)),n.set(e,t)}class oz extends K{constructor(e){super(),this.layer=e,this.changed=new at}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){const e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=sz(this.layer,e)}reset(){this.value=void 0}toJSON(){const e=this.value_;if(e!==void 0)return e.toJSON()}}class lz extends K{constructor(e){super(),this.inputEventMapBinder=e,this.bindings=new ue,this.changed=new at,this.debounceDeactivate=this.registerCancellable(ct(()=>this.deactivate_(),100)),this.debounceReactivate=this.registerCancellable(ct(()=>this.reactivateQueuedTool(),100))}get(e){return this.bindings.get(e)}set(e,t){const n=this.bindings,r=n.get(e);if(r!==void 0){r.keyBinding=void 0,n.delete(e);const s=r.layer.toolBinder;s.bindings.delete(e),s.jsonToKey.delete(se(r.toJSON())),this.destroyTool(r),s.changed.dispatch()}if(t!==void 0){const s=t.layer.toolBinder,o=se(t.toJSON()),l=s.jsonToKey.get(o);if(l!==void 0){const c=s.bindings.get(l);c.keyBinding=void 0,n.delete(l),s.bindings.delete(l),s.jsonToKey.delete(o),this.destroyTool(c)}s.bindings.set(e,t),t.keyBinding=e,s.jsonToKey.set(o,e),n.set(e,t),s.changed.dispatch()}this.changed.dispatch()}activate(e){const t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();const n=this.activeTool_;if(t===(n==null?void 0:n.tool)){t.toggle&&this.deactivate_();return}else n!==void 0&&(n.tool.toggle&&!t.toggle&&(this.queuedTool=n.tool),this.deactivate_());const r=new OC(t,this.inputEventMapBinder);if(this.activeTool_=r,!t.toggle){const s=`Key${e}`;r.registerEventListener(window,"keyup",o=>{o.code===s&&(this.debounceDeactivate(),this.debounceReactivate())}),r.registerEventListener(window,"blur",()=>{this.debounceDeactivate(),this.debounceReactivate()})}return t.activate(r),t}reactivateQueuedTool(){if(this.queuedTool){const e=new OC(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)===null||t===void 0?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();const e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}}class dz{constructor(e){this.layer=e,this.bindings=new ue,this.jsonToKey=new ue,this.changed=new at,e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){const n=BC(this.layer,t);n!==void 0&&this.set(e,n)}removeJsonString(e){const t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){const e=this.bindings;if(e.size===0)return;const t={};for(const r of e){var n=oe(r,2);const s=n[0],o=n[1];t[s]=o.toJSON()}return t}clear(){const e=this.globalBinder,t=this.bindings;if(t.size!==0){for(const r of t){var n=oe(r,2);const s=n[0],o=n[1];o.keyBinding=void 0,e.bindings.delete(s),e.destroyTool(o)}t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){ge(e);for(const n of Jd(e)){var t=oe(n,2);const r=t[0],s=t[1];if(!r.match(rz))throw new Error(`Invalid tool key: ${se(r)}`);const o=BC(this.layer,s);if(o===void 0)return;this.set(r,o)}}}}class lI extends K{constructor(e,t){super(),this.layer=e,this.toolJson=t,this.element=document.createElement("div"),this.toolJsonString=se(this.toolJson);const n=this.element;n.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(wt(()=>this.updateView())))),this.updateView(),n.title="click → bind key, dbclick → unbind",n.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),dI(this,n,r=>this.layer.toolBinder.setJson(r,this.toolJson))}updateView(){const e=this.layer.toolBinder.jsonToKey.get(this.toolJsonString);this.element.textContent=e??" "}}function dI(i,e,t){let n;e.addEventListener("mousedown",r=>{r.button!==0||n!==void 0||(r.preventDefault(),r.stopPropagation(),n=new K,i.registerDisposer(n),n.registerDisposer(new tt(!1)).setText("Press A-Z to bind key"),n.registerEventListener(window,"keydown",s=>{const o=s.code.match(/^Key([A-Z])$/);if(o===null)return;s.stopPropagation(),s.preventDefault();const l=o[1];t(l)},{capture:!0}),n.registerEventListener(window,"mouseup",s=>{s.button!==0||n===void 0||(s.preventDefault(),s.stopPropagation(),i.unregisterDisposer(n),n.dispose(),n=void 0)}))}),e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation()})}function Kf(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-tool-button"),n.appendChild(i.registerDisposer(new lI(e,t.toolJson)).element);const r=document.createElement("div");return r.classList.add("neuroglancer-tool-button-label"),r.textContent=t.label,t.title&&(r.title=t.title),n.appendChild(r),n}function cz(i){const e=i.registerDisposer(new tt(!1));e.element.classList.add("neuroglancer-tool-status");const t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);const n=i.inputEventMapBinder;return i.inputEventMapBinder=(r,s)=>{const o=document.createElement("div");o.textContent=r.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),n(r,s)},{message:e,content:t}}function ep(i){var e=cz(i);const t=e.message,n=e.content,r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");const s=document.createElement("div");s.classList.add("neuroglancer-tool-status-header-container"),s.appendChild(r),n.appendChild(s);const o=document.createElement("div");return o.classList.add("neuroglancer-tool-status-body"),n.appendChild(o),{message:t,body:o,header:r}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uz(i,e){i.remove(e)}function hz(i,e){i.add(e)}const cI="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImNvbnRyb2xzQWx0SWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iY29udHJvbHNBbHRJY29uVGl0bGUiPkNvbnRyb2xzPC90aXRsZT4KICAgIDxjaXJjbGUgY3g9IjkiIGN5PSI2IiByPSIyIi8+CiAgICA8cGF0aCBkPSJNNCA2SDciLz4KICAgIDxwYXRoIGQ9Ik0xMSA2SDIwIi8+CiAgICA8Y2lyY2xlIGN4PSI5IiBjeT0iMTgiIHI9IjIiLz4KICAgIDxwYXRoIGQ9Ik00IDE4SDciLz4KICAgIDxwYXRoIGQ9Ik0xMSAxOEgyMCIvPgogICAgPGNpcmNsZSBjeD0iMTUiIGN5PSIxMiIgcj0iMiIvPgogICAgPHBhdGggZD0iTTQgMTJIMTMiLz4KICAgIDxwYXRoIGQ9Ik0xNyAxMkwyMCAxMiIvPgo8L3N2Zz4=",pz="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImxheWVyc0ljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImxheWVyc0ljb25UaXRsZSI+TGF5ZXJzPC90aXRsZT4KICAgIDxwYXRoIGQ9Ik0xMiA0TDIwIDguMDAwMDRMMTIgMTJMNCA4LjAwMDA0TDEyIDRaIi8+CiAgICA8cGF0aCBkPSJNMjAgMTJMMTIgMTZMNCAxMiIvPgogICAgPHBhdGggZD0iTTIwIDE2TDEyIDIwTDQgMTYiLz4KPC9zdmc+",fz="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0ibGlzdEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9Imxpc3RJY29uVGl0bGUiLz4KICAgIAogICAgPHBhdGggZD0iTTEwIDdMMTggN00xMCAxMkwxOCAxMk0xMCAxN0wxOCAxNyIvPgogICAgPGxpbmUgeDE9IjciIHkxPSI3IiB4Mj0iNyIgeTI9IjciLz4KICAgIDxsaW5lIHgxPSI3IiB5MT0iMTIiIHgyPSI3IiB5Mj0iMTIiLz4KICAgIDxsaW5lIHgxPSI3IiB5MT0iMTciIHgyPSI3IiB5Mj0iMTciLz4KPC9zdmc+",gz="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0ic2V0dGluZ3NJY29uVGl0bGUiPgogICAgPHRpdGxlIGlkPSJzZXR0aW5nc0ljb25UaXRsZSI+U2V0dGluZ3M8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik01LjAzNTA2NDI5LDEyLjcwNTAzMzkgQzUuMDExODc0ODQsMTIuNDczMTY5NiA1LDEyLjIzNzk3MTYgNSwxMiBDNSwxMS43NjIwMjg0IDUuMDExODc0ODQsMTEuNTI2ODMwNCA1LjAzNTA2NDI5LDExLjI5NDk2NjEgTDMuMjA1NzcxMzcsOS4yMzIwNTA4MSBMNS4yMDU3NzEzNyw1Ljc2Nzk0OTE5IEw3LjkwNjk3MTMsNi4zMjA3MDkwNCBDOC4yODcyOTEyMyw2LjA0NjEzNDIgOC42OTYyOTI5OCw1LjgwODgyMjEyIDkuMTI4NjI1MzMsNS42MTQxMjQwMiBMMTAsMyBMMTQsMyBMMTQuODcxMzc0Nyw1LjYxNDEyNDAyIEMxNS4zMDM3MDcsNS44MDg4MjIxMiAxNS43MTI3MDg4LDYuMDQ2MTM0MiAxNi4wOTMwMjg3LDYuMzIwNzA5MDQgTDE4Ljc5NDIyODYsNS43Njc5NDkxOSBMMjAuNzk0MjI4Niw5LjIzMjA1MDgxIEwxOC45NjQ5MzU3LDExLjI5NDk2NjEgQzE4Ljk4ODEyNTIsMTEuNTI2ODMwNCAxOSwxMS43NjIwMjg0IDE5LDEyIEMxOSwxMi4yMzc5NzE2IDE4Ljk4ODEyNTIsMTIuNDczMTY5NiAxOC45NjQ5MzU3LDEyLjcwNTAzMzkgTDIwLjc5NDIyODYsMTQuNzY3OTQ5MiBMMTguNzk0MjI4NiwxOC4yMzIwNTA4IEwxNi4wOTMwMjg3LDE3LjY3OTI5MSBDMTUuNzEyNzA4OCwxNy45NTM4NjU4IDE1LjMwMzcwNywxOC4xOTExNzc5IDE0Ljg3MTM3NDcsMTguMzg1ODc2IEwxNCwyMSBMMTAsMjEgTDkuMTI4NjI1MzMsMTguMzg1ODc2IEM4LjY5NjI5Mjk4LDE4LjE5MTE3NzkgOC4yODcyOTEyMywxNy45NTM4NjU4IDcuOTA2OTcxMywxNy42NzkyOTEgTDUuMjA1NzcxMzcsMTguMjMyMDUwOCBMMy4yMDU3NzEzNywxNC43Njc5NDkyIEw1LjAzNTA2NDI5LDEyLjcwNTAzMzkgWiIvPgogICAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMSIvPgo8L3N2Zz4=";class nc extends K{}function uI(i){let e,t,n;return(r,s)=>t!==void 0&&(e===void 0||r===void 0||e.generation!==r.generation)?(e===void 0&&n.addConsumer(s),t):(e=void 0,n=new KO,t=i(r,n).then(o=>(e=o,n=void 0,o),o=>{throw n.isCanceled&&(n=void 0,t=void 0),o}),t)}function tp(i){let e=0;return uI((t,n)=>i(n).then(r=>({generation:++e,credentials:r})))}class mz{constructor(){this.providers=new ue,this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){const n=this.providers.get(e);if(n===void 0)throw new Error(`No registered credentials provider: ${se(e)}`);return n(t,this.topLevelManager)}}class vz extends K{constructor(e){super(),this.base=e,this.memoize=new HE}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class hI extends vz{constructor(){super(new mz),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class yz extends nc{constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=uI(n=>this.anonymous&&n===void 0?Ot.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(n)))}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nl=new hI;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mn(i,e){return t=>{t.style.flex=i,e(t)}}function ea(i,e){return t=>{t.style.display="flex",t.style.flexDirection=i;for(let n of e){let r=t.ownerDocument.createElement("div");t.appendChild(r),n(r)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bz=Qe();function pI(i,e){const t=_1(bz),n=i.globalPosition;var r=i.displayDimensionRenderInfo;const s=r.canonicalVoxelFactors,o=r.displayDimensionIndices;for(let l=0;l<3;++l){const c=o[l];t[12+l]=c===-1?0:n[c],t[5*l]=e/s[l]}return fi(t,i.viewProjectionMat,t),t}class ip extends K{constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer(Ki.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(Ki.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(SB(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new ip(e))}draw(e,t=!0){let n=this.trivialColorShader,r=this.gl;n.bind(),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,e);let s=n.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(s,4);let o=n.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(r.colorMask(!1,!1,!1,!0),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.colorMask(!0,!0,!0,!0),r.enable(r.BLEND),r.blendFunc(r.ONE_MINUS_DST_ALPHA,r.DST_ALPHA)),r.lineWidth(1),r.drawArrays(r.LINES,0,6),t&&r.disable(r.BLEND),r.disableVertexAttribArray(s),r.disableVertexAttribArray(o)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Sz="perspective_view/PerspectiveView";/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fI{constructor(){this.renderLayers=[null],this.pickData=[null],this.values=[0,0,0],this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,n=1,r=null){return this.register(e,n,t.low,t.high,r)}register(e,t=1,n=0,r=0,s=null){let o=this.renderLayers,l=this.values,c=this.nextPickID;this.nextPickID+=t;let u=o.length;o[u]=e;let f=u*3;return l[f]=c,l[f+1]=n,l[f+2]=r,this.pickData[u]=s,c}setMouseState(e,t){const n=this.renderLayers,r=this.values;let s=0,o=n.length-1;for(;s<o;){const v=Math.ceil(s+(o-s)/2);r[v*3]>t?o=v-1:s=v}const l=e.pickedRenderLayer=n[s],c=s*3,u=e.pickedOffset=t-r[c];let f=e.pickedValue;f.low=r[c+1],f.high=r[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;const g=this.pickData[s];l!==null&&l.updateMouseState(e,f,u,g)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uo{static insertAfter(e,t){let n=e.next0;t.next0=n,t.prev0=e,e.next0=t,n.prev0=t}static insertBefore(e,t){let n=e.prev0;t.prev0=n,t.next0=e,e.prev0=t,n.next0=t}static front(e){let t=e.next0;return t===e?null:t}static back(e){let t=e.prev0;return t===e?null:t}static pop(e){let t=e.next0,n=e.prev0;return t.prev0=n,n.next0=t,e.next0=null,e.prev0=null,e}static*iterator(e){for(let t=e.next0;t!==e;t=t.next0)yield t}static*reverseIterator(e){for(let t=e.prev0;t!==e;t=t.prev0)yield t}static initializeHead(e){e.next0=e.prev0=e}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wz{constructor(){uo.initializeHead(this)}}const um=new wz,Cz=window.top===window,Ey=ct(()=>{if(!Cz)return;var i=document;const e=i.activeElement;if(e===null||e===document.body){const t=uo.front(um);t!==null&&t.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{Ey()},!0);window.addEventListener("blur",()=>{Ey()},!0);class np extends K{constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable(ct(()=>{var t=document;const n=t.activeElement,r=this.element;r.contains(n)||py(n)||(n!=null&&(n===this.lastFocusedElement||n.contains(r))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),uo.insertBefore(um,this),this.registerEventListener(e,"focus",()=>{uo.pop(this),uo.insertAfter(um,this)}),Ey()}disposed(){uo.pop(this),super.disposed()}}const _C=10,xz=1e3,Ez=400,Lz=500,kz=Math.PI/20,Iz=20,Tz=10;function gI(i,e){return Math.sqrt(i*i+e*e)}function FC(i){var e=oe(i,2);let t=e[0],n=e[1];if(t.identifier>n.identifier){var r=[t,n];n=r[0],t=r[1]}const s=t.clientX-n.clientX,o=t.clientY-n.clientY,l=gI(s,o),c=Math.atan2(s,o);return{distance:l,angle:c}}function Dz(i,e){const t=Math.PI*2,n=Math.abs(i-e)%t;return Math.min(n,t-n)}class Pz extends K{constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new ue,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable(Uh((n,r,s,o)=>{const l={event:n,centerX:s,centerY:o};this.dispatch(`touchhold${n.targetTouches.length}`,n,l,r)},xz,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchmove",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchend",n=>{this.handleTouchEvent(n)})}dispatch(e,t,n,r=t.eventPhase){Nk(e,t,r,n,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;const t=new ue,n=this.prevTouches,r=this.prevEvent;let s=0,o=0;for(const w of e.targetTouches)t.set(w.identifier,w),s+=w.clientX,o+=w.clientY;s/=t.size,o/=t.size;for(const w of n.entries()){var l=oe(w,2);const S=l[0],L=l[1],I=t.get(S);if(I===void 0)n.delete(S);else{const M=I.clientX-L.clientX,R=I.clientY-L.clientY;(Math.abs(M)>=_C||Math.abs(R)>=_C)&&(this.moved=!0)}}if(r===void 0||r.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,s,o),(r===void 0||r.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){const w=Date.now();if(e.targetTouches.length===0&&w-this.tapStartTime<Ez){(this.curTapNumTouches!==this.priorTapNumTouches||w-this.tapEndTime>=Lz)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=w,this.priorTapNumTouches=this.curTapNumTouches;const S={event:e,centerX:s,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,S)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=s,this.prevCenterY=o,this.translated=!1,t.size===2){var c=FC(t.values());const w=c.distance,S=c.angle;this.prevDistance=w,this.prevAngle=S,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let u=this.prevCenterX,f=this.prevCenterY,g=this.translated;const v=s-u,y=o-f;if(g===!1&&gI(v,y)>=Tz&&(g=this.translated=!0),g===!0&&(v!==0||y!==0)){this.prevCenterX=s,this.prevCenterY=o;const w={event:e,deltaX:v,deltaY:y,centerX:s,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,w)}if(t.size===2){var C=FC(t.values());const w=C.distance,S=C.angle;let L=this.pinched,I=this.rotated,M=this.prevDistance,R=this.prevAngle;L===!1&&Math.abs(w-M)>=Iz&&(this.pinched=L=!0);const D=Dz(S,R);if(I===!1&&D>=kz&&(this.rotated=I=!0),L===!0&&w!=M){this.prevDistance=w;const T={event:e,distance:w,prevDistance:M,centerX:s,centerY:o};this.dispatch("touchpinch",e,T)}I===!0&&S!==R&&(this.prevAngle=S,this.dispatch("touchrotate",e,{event:e,centerX:s,centerY:o,angle:S,prevAngle:R}))}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Az=0,Mz=1,Rz=2;function Ju(i){let e=0;switch(i.deltaMode){case Az:e=1/200;break;case Mz:e=1/10;break;case Rz:e=2;break}return Math.exp(i.deltaY*e)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Xf=Ne();class UC{constructor(){this.pickIDs=new fI,this.viewportWidth=0,this.viewportHeight=0,this.invTransform=Qe(),this.frameNumber=-1}}class zC{constructor(){this.buffer=null,this.glWindowX=0,this.glWindowY=0}}const Nz=30,pi=5,pt=1+pi*2,Zu=(()=>{const i=pi**2,e=(r,s)=>(r-pi)**2+(s-pi)**2;let t=new Uint32Array(pt*pt),n=0;for(let r=0;r<pt;++r)for(let s=0;s<pt;++s)e(r,s)>i||(t[n++]=s*pt+r);return t=t.subarray(0,n),t.sort((r,s)=>{const o=r%pt,l=(r-o)/pt,c=s%pt,u=(s-c)/pt;return e(o,l)-e(c,u)}),t})();function mI(i,e,t,n,r,s,o){const l=n-pi,c=r-pi;if(!(l>=0&&c>=0&&l+pt<=s&&c+pt<=o))for(let u=0;u<pt;++u)for(let f=0;f<pt;++f){const g=l+f,v=c+u;(g<0||v<0||g>=s||v>=o)&&(i[e+(v*pt+g)*t]=0)}}class vI extends qE{constructor(e,t,n){super(e,t,n.visibility),this.viewer=n,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.pickingData=[new UC,new UC],this.pickRequests=[new zC,new zC],this.pickBufferContents=new Float32Array(2*4*pt*pt),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.inputEventMap=n.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP<"u"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new np(t)),this.registerDisposer(new $n(t,this.inputEventMap)),this.registerDisposer(new Zr(t,this.inputEventMap,r=>{this.onMousemove(r)})),this.registerDisposer(new Pz(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",r=>{r.target!==t&&this.onMouseout()},!0),Se(t,"select-position",()=>{this.viewer.selectionDetailsState.select(!1)}),Se(t,"snap",()=>{this.navigationState.pose.snap()}),Se(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),Se(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),Se(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),Se(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let r=0;r<3;++r){let s=fN[r];for(let o of[-1,1]){let l=o<0?"-":"+";Se(t,`rotate-relative-${s}${l}`,()=>{this.navigationState.pose.rotateRelative(Kn[r],o*.1)});let c=Ne();Se(t,`${s}${l}`,()=>{let u=this.navigationState,f=c;f[0]=0,f[1]=0,f[2]=0,f[r]=o,u.pose.translateVoxelsRelative(f,!0)})}}Se(t,"zoom-via-wheel",r=>{const s=r.detail;this.onMousemove(s,!1),this.zoomByMouse(Ju(s))}),Se(t,"adjust-depth-range-via-wheel",r=>{const s=r.detail;this.navigationState.depthRange.value*=Ju(s)}),Se(t,"translate-via-mouse-drag",r=>{zn(r.detail,(s,o,l)=>{this.translateByViewportPixels(o,l)})}),Se(t,"translate-in-plane-via-touchtranslate",r=>{const s=r.detail;this.translateByViewportPixels(s.deltaX,s.deltaY)}),Se(t,"translate-z-via-touchtranslate",r=>{const s=r.detail;let o=this.navigationState,l=Xf;l[0]=0,l[1]=0,l[2]=s.deltaY+s.deltaX,o.pose.translateVoxelsRelative(l,!0)});for(const r of[1,10])Se(t,`z+${r}-via-wheel`,s=>{const o=s.detail;let l=this.navigationState,c=Xf,u=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(u>0?-1:1)*r,l.pose.translateVoxelsRelative(c,!0)});Se(t,"move-to-mouse-position",()=>{const r=this.viewer.mouseState;r.updateUnconditionally()&&(this.navigationState.position.value=r.position)}),Se(t,"snap",()=>this.navigationState.pose.snap()),Se(t,"move-annotation",r=>{const s=this.viewer.mouseState,o=s.pickedAnnotationId,l=s.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){r.stopPropagation();let c=l.source.getReference(o),u=c.value;const f=sd(u.type),g=s.pickedOffset,v=l.chunkTransform.value;if(v.error!==void 0)return;const y=v.layerRank,C=new Float32Array(y);f.getRepresentativePoint(C,u,s.pickedOffset);let w=hN($1(),0,0);s.updateUnconditionally()&&zn(r.detail,(S,L,I)=>{pN(w,w,[L,I]);const M=new Float32Array(y);Nr(M,v.chunkToLayerTransform,y+1,C,y);const R=Xf,D=this.navigationState.pose.displayDimensions.value.displayDimensionIndices;YV(R,M,v.modelTransform,D),this.translateDataPointByViewportPixels(R,R,w[0],w[1]),KV(M,R,v.modelTransform,D);const T=new Float32Array(y);Nr(T,v.layerToChunkTransform,y+1,M,y);let A=f.updateViaRepresentativePoint(u,T,g);l.source.update(c,A)},S=>{l.source.commit(c),c.dispose()})}}),Se(t,"delete-annotation",()=>{const r=this.viewer.mouseState,s=r.pickedAnnotationId,o=r.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&s!==void 0){const l=o.source.getReference(s);try{o.source.delete(l)}finally{l.dispose()}}}),Se(t,"zoom-via-touchpinch",r=>{const s=r.detail;this.handleMouseMove(s.centerX,s.centerY);const o=s.prevDistance/s.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){const e=this.gl;for(const t of this.pickRequests){const n=t.sync;n!==null&&e.deleteSync(n),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){const t=this.gl;let n=e.buffer;n===null?(n=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*pt*pt,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n);const r=this.renderViewport;let s=this.mouseX-r.visibleLeftFraction*r.logicalWidth,o=r.height-(this.mouseY-r.visibleTopFraction*r.logicalHeight);this.issuePickRequest(s,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=s,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;const l=this.pickRequests;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+Nz}completePickInternal(e){const t=this.gl,n=this.pickBufferContents;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,n),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);const r=this.pickingData,s=e.frameNumber;this.completePickRequest(e.glWindowX,e.glWindowY,n,r[0].frameNumber===s?r[0]:r[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let n=this.context.frameNumber,r=-1;e&&(--n,r=n-1);const s=this.pickRequests,o=this.gl;let l=!1,c=!1,u;for(const g of s){const v=g.sync;if(v===null)continue;const y=g.frameNumber;if(!c&&y>=n-1){if(t||o.getSyncParameter(v,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(g),c=!0;else if(y!==r){l=!0;continue}}o.deleteSync(v),g.sync=null,u=g}const f=this.pickTimerId;l&&f===-1?this.scheduleCheckForPickRequestCompletion():!l&&f!==-1&&(window.clearTimeout(f),this.pickTimerId=-1),!e&&u!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(u)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){var e=this.renderViewport;const t=e.width,n=e.height;this.checkForPickRequestCompletion(!0);const r=this.pickingData;r[0]=r[1];const s=this.context.frameNumber,o=r[1];if(o.frameNumber=s,o.viewportWidth=t,o.viewportHeight=n,o.pickIDs.clear(),!this.drawWithPicking(o)){o.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){const e=Date.now(),t=this.nextPickRequestTime,n=this.pendingPickRequestTimerId;return e<t?(n==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;const e=this.context.frameNumber,t=this.gl,n=this.pickRequests;for(const r of n){let s=r.sync;if(s!==null)if(r.frameNumber<e-1)t.deleteSync(s);else continue;this.issuePickRequestInternal(r);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}const n=this.context.frameNumber,r=this.pickingData[1];r.frameNumber!==n||this.renderViewport.width!==r.viewportWidth||this.renderViewport.height!==r.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){const n=this.element,r=n.getBoundingClientRect(),s=e-(r.left+n.clientLeft),o=t-(r.top+n.clientTop),l=this.viewer.mouseState;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(s,o)}onMousemove(e,t=!0){const n=this.element;t&&e.target!==n||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let t=this.element;if(e.target!==t||e.targetTouches.length!==1)return;var n=e.targetTouches[0];const r=n.clientX,s=n.clientY;this.handleMouseMove(r,s)}disposed(){this.viewer.mouseState.removeForcer(this.mouseStateForcer);const e=this.gl;this.cancelPickRequests();const t=this.pendingPickRequestTimerId;t!==-1&&window.clearTimeout(t);for(const n of this.pickRequests)e.deleteBuffer(n.buffer);super.disposed()}}const Vz=[1.5,2,3,5,7.5,10];class Oz{constructor(){this.allowedSignificands=Vz,this.targetLengthInPixels=0,this.physicalSizePerPixel=0,this.prevPhysicalSizePerPixel=0,this.prevTargetLengthInPixels=0,this.prevPhysicalUnit="\0"}update(){let e=this.physicalSizePerPixel,t=this.targetLengthInPixels;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;const n=t*e,r=Math.floor(CE(n)),s=10**r,o=n/s;let l=1;for(let f of this.allowedSignificands)if(Math.abs(f-o)<Math.abs(l-o))l=f;else break;const c=l*s,u=xE(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${u.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(r-u.exponent),!0}}function Bz(i,e,t,n,r){const s=document.createElement("canvas"),o=s.getContext("2d"),l=r.textHeightInPixels*r.scaleFactor,c=`bold ${l}px ${r.fontName}`;o.font=c,o.fillStyle="white";const u=`${n}${i.physicalLength} ${i.physicalUnit}`,f=o.measureText(u),g=Math.max(i.lengthInPixels,f.width),v=r.barHeightInPixels*r.scaleFactor,y=r.barTopMarginInPixels*r.scaleFactor,C=v+y+l,w=r.paddingInPixels*r.scaleFactor,S=C+2*w,L=g+2*w;return s.width=L,s.height=S,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,L,S),o.fillStyle="white",o.fillText(u,L/2,S-w-v-y),o.fillRect(w,S-w-v,i.lengthInPixels,v),yB(e,t,s),{width:L,height:S}}class _z extends K{constructor(e,t=new Oz){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){const t=this.dimensions,n=this.label;let r=this.texture;if(!t.update()&&r!==null&&e===this.priorOptions&&n==this.prevLabel)return;r===null&&(r=this.texture=this.gl.createTexture());var s=Bz(t,this.gl,r,n,e);const o=s.width,l=s.height;this.priorOptions=e,this.prevLabel=n,this.width=o,this.height=l}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class yI extends K{constructor(e){super(),this.gl=e,this.scaleBarCopyHelper=this.registerDisposer(Po.get(this.gl)),this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new _z(e)))}draw(e,t,n,r,s){const o=this.scaleBars,l=t.displayRank,c=t.displayDimensionIndices,u=t.canonicalVoxelFactors,f=t.globalDimensionNames,g=t.displayDimensionUnits,v=t.displayDimensionScales,y=n.factors,C=Math.min(s.maxWidthFraction*e.logicalWidth,s.maxWidthInPixels*s.scaleFactor);let w=0;for(let M=0;M<l;++M){const R=c[M],D=g[M],T=y[R];let A,V,O;for(A=0;A<w&&(V=o[A],O=V.dimensions,!(O.physicalBaseUnit===D&&V.factor===T));++A);A===w&&(++w,V=o[A],V.label="",O=V.dimensions,V.factor=T,O.physicalBaseUnit=D,O.targetLengthInPixels=C,O.physicalSizePerPixel=v[M]*r/u[M]),V.label+=`${f[R]} `}const S=this.gl,L=this.scaleBarCopyHelper;let I=s.bottomPixelOffset*s.scaleFactor;for(let M=w-1;M>=0;--M){const R=o[M];w===1?R.label="":R.label+=": ",R.update(s),S.viewport(s.leftPixelOffset*s.scaleFactor-e.visibleLeftFraction*e.logicalWidth,I-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,R.width,R.height),L.draw(R.texture),I+=R.height+s.marginPixelsBetweenScaleBars*s.scaleFactor}}}const Fz={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},bI=j(j({},Fz),{maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5});function Uz(i){const e=j({},bI);for(const t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])Y(i,t,n=>{n!==void 0&&(e[t]=Jo(n))});return Y(i,"fontName",t=>{t!==void 0&&(e.fontName=Ie(t))}),e}class zz extends ci{constructor(){super(bI,Uz)}}var tn;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(tn||(tn={}));const Gz=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,Wz=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,$z=[Wz,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function Qf(i){i.addOutputBuffer("vec4","out_color",tn.COLOR),i.addOutputBuffer("highp vec4","out_z",tn.Z),i.addOutputBuffer("highp vec4","out_pickId",tn.PICK),i.addFragmentCode(Gz)}function jz(i){i.addOutputBuffer("vec4","v4f_fragData0",0),i.addOutputBuffer("vec4","v4f_fragData1",1),i.addFragmentCode($z)}const Er=Ne(),GC=Eh(),Hz=Qe();function Jz(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}const Zz=Vh(ur);class qz extends Zz{constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new Ou(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class Ly extends vI{constructor(e,t,n){super(e,t,n),this.sliceViews=this.registerDisposer(new Uv((s,o,l)=>{s.registerDisposer(l),s.registerDisposer(l.visibility.add(this.visibility))})),this.axesLineHelper=this.registerDisposer(ip.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(ZL.get(this.gl,Qf)),this.offscreenFramebuffer=this.registerDisposer(new Do(this.gl,{colorBuffers:[new ra(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new ra(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new ra(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new xB(this.gl)})),this.offscreenCopyHelper=this.registerDisposer(Po.get(this.gl)),this.transparencyCopyHelper=this.registerDisposer(Po.get(this.gl,Jz,2)),this.scaleBars=this.registerDisposer(new yI(this.gl)),this.projectionParameters=this.registerDisposer(new vL({navigationState:this.navigationState,update:(s,o)=>{const l=s.invViewMatrix,c=s.projectionMat,u=s.logicalWidth,f=s.logicalHeight,g=u/f,v=Math.PI/4;let y=o.relativeDepthRange,C=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){const w=Math.max(.1,1-y),S=1+y;F1(c,-g,g,-1,1,w,S)}else{const w=1/Math.tan(v/2);y/=w;const S=Math.max(.1,1-y),L=1+y;C*=w,iN(c,v,g,S,L)}JE(s,c),o.pose.toMat4(l,C),Q2(l,l,xg(Er,1,-1,-1)),X2(l,l,Kn[2]),XE(s)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());const r=this.sharedObject=this.registerDisposer(new qz(this));if(r.RPC_TYPE_ID=Sz,r.initializeCounterpart(n.rpc,{}),r.visibility.add(this.visibility),this.visibleLayerTracker=HI(this.viewer.layerManager,el,this.viewer.visibleLayerRoles,this),Se(t,"rotate-via-mouse-drag",s=>{zn(s.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative(Kn[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(Kn[0],-c/4*Math.PI/180)})}),Se(t,"rotate-in-plane-via-touchrotate",s=>{const o=s.detail;this.navigationState.pose.rotateRelative(Kn[2],o.angle-o.prevAngle)}),Se(t,"rotate-out-of-plane-via-touchtranslate",s=>{const o=s.detail;this.navigationState.pose.rotateRelative(Kn[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Kn[0],-o.deltaY/4*Math.PI/180)}),n.showSliceViewsCheckbox){let s=this.registerDisposer(new As(n.showSliceViews));s.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(s.element),this.element.appendChild(o)}this.registerDisposer(n.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(n.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){const n=Er;var r=this.projectionParameters.value;const s=r.viewProjectionMat,o=r.invViewProjectionMat,l=r.logicalWidth,c=r.logicalHeight;this.viewer.navigationState.pose.updateDisplayPosition(u=>{yn(n,u,s),n[0]+=-2*e/l,n[1]+=2*t/c,yn(u,n,o)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(const c of this.sliceViews){var e=oe(c,2);const u=e[0];if((e[1]||this.viewer.showSliceViews.value)&&!u.isReady())return!1}this.ensureBoundsUpdated();var t=this.renderViewport;const n=t.width,r=t.height;if(n===0||r===0)return!0;const s={projectionParameters:this.projectionParameters.value},o=this.visibleLayerTracker.visibleLayers;for(const c of o){var l=oe(c,2);const u=l[0],f=l[1];if(!u.isReady(s,f))return!1}return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;const e=this.offscreenFramebuffer;var t=this.renderViewport;const n=t.width,r=t.height,s=n*r,o=new Float32Array(s*4);try{e.bindSingle(tn.Z),this.gl.readPixels(0,0,n,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,o)}finally{e.framebuffer.unbind()}const l=new Float32Array(s);for(let c=0;c<s;++c)l[c]=o[c*4];return l}issuePickRequest(e,t){const n=this.offscreenFramebuffer;n.readPixelFloat32IntoBuffer(tn.Z,e-pi,t-pi,0,pt,pt),n.readPixelFloat32IntoBuffer(tn.PICK,e-pi,t-pi,4*4*pt*pt,pt,pt)}completePickRequest(e,t,n,r){const s=this.viewer.mouseState;s.pickedRenderLayer=null,mI(n,0,4,e,t,r.viewportWidth,r.viewportHeight);const o=Zu.length;for(let l=0;l<o;++l){const c=Zu[l];let u=n[4*c];if(u===0)continue;const f=c%pt,g=(c-f)/pt;let v=1-u;Er[0]=2*(e+f-pi)/r.viewportWidth-1,Er[1]=2*(t+g-pi)/r.viewportHeight-1,Er[2]=2*v-1,yn(Er,Er,r.invTransform);let y=s.position,C=s.unsnappedPosition;const w=this.navigationState.position.value,S=w.length;y.length!==S&&(y=s.position=new Float32Array(S)),C.length!==S&&(C=s.unsnappedPosition=new Float32Array(S)),y.set(w),s.coordinateSpace=this.navigationState.coordinateSpace.value;const L=this.navigationState.pose.displayDimensions.value,I=L.displayDimensionIndices;for(let R=0,D=I.length;R<D;++R)y[I[R]]=Er[R];C.set(y);const M=n[4*pt*pt+4*c];r.pickIDs.setMouseState(s,M),s.displayDimensions=L,s.setActive(!0);return}s.setActive(!1)}translateDataPointByViewportPixels(e,t,n,r){const s=Er;var o=this.projectionParameters.value;const l=o.viewProjectionMat,c=o.invViewProjectionMat,u=o.width,f=o.height;return yn(s,t,l),s[0]+=2*n/u,s[1]+=-2*r/f,yn(e,s,c)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new Do(this.gl,{colorBuffers:Bu(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;var t=this.renderViewport;const n=t.width,r=t.height,s=this.viewer.showSliceViews.value;for(const T of this.sliceViews){var o=oe(T,2);const A=o[0];(o[1]||s)&&A.updateRendering()}let l=this.gl;this.offscreenFramebuffer.bind(n,r),l.disable(l.SCISSOR_TEST),l.enable(WebGL2RenderingContext.STENCIL_TEST),l.stencilMask(4294967295),l.clearStencil(0),l.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),l.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);const c=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(c[0],c[1],c[2],0),l.clear(l.DEPTH_BUFFER_BIT),l.clearBufferfv(WebGL2RenderingContext.COLOR,tn.COLOR,[c[0],c[1],c[2],0]),l.clearBufferfv(WebGL2RenderingContext.COLOR,tn.Z,Ig),l.clearBufferfv(WebGL2RenderingContext.COLOR,tn.PICK,Ig),l.enable(l.DEPTH_TEST);const u=this.projectionParameters.value;let f=Ne();fo(f,Kn[2],this.navigationState.pose.orientation.orientation),vv(f,f,-1);let g=.2,v=1-g;const y={wireFrame:this.viewer.wireFrame.value,projectionParameters:u,lightDirection:f,ambientLighting:g,directionalLighting:v,pickIDs:e.pickIDs,emitter:Qf,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};wu(e.invTransform,u.invViewProjectionMat);const C=this.visibleLayerTracker.visibleLayers;let w=!1,S=!1;for(const T of C){var L=oe(T,2);const A=L[0],V=L[1];A.isTransparent?w=!0:A.isAnnotation?S=!0:A.draw(y,V)}if(this.drawSliceViews(y),S){l.enable(WebGL2RenderingContext.BLEND),l.depthFunc(WebGL2RenderingContext.LEQUAL),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const T of C){var I=oe(T,2);const A=I[0],V=I[1];A.isAnnotation&&A.draw(y,V)}l.depthFunc(WebGL2RenderingContext.LESS),l.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),w){l.depthMask(!1),l.enable(WebGL2RenderingContext.BLEND);const T=this.transparentConfiguration;T.bind(n,r),this.gl.clearColor(0,0,0,1),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),y.emitter=jz,l.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),y.emitPickID=!1;for(const A of C){var M=oe(A,2);const V=M[0],O=M[1];V.isTransparent&&V.draw(y,O)}l.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(tn.COLOR),l.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(T.colorBuffers[0].texture,T.colorBuffers[1].texture),l.depthMask(!0),l.disable(WebGL2RenderingContext.BLEND),l.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(n,r),l.enable(WebGL2RenderingContext.STENCIL_TEST),l.drawBuffers([l.NONE,l.COLOR_ATTACHMENT1,l.COLOR_ATTACHMENT2]),y.emitter=Qf,y.emitPickID=!0,y.emitColor=!1,l.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),l.stencilMask(2);for(const A of C){var R=oe(A,2);const V=R[0],O=R[1];!V.isTransparent||!V.transparentPickEnabled||V.draw(y,O)}l.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),l.stencilMask(0);for(const A of C){var D=oe(A,2);const V=D[0],O=D[1];!V.isTransparent||V.transparentPickEnabled||V.draw(y,O)}}if(l.stencilMask(4294967295),l.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){l.drawBuffers([l.COLOR_ATTACHMENT0]),l.disable(WebGL2RenderingContext.DEPTH_TEST),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);const T=this.scaleBars,A=this.viewer.scaleBarOptions.value;T.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,A),l.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[tn.COLOR].texture),!0}drawSliceViews(e){let t=this.sliceViewRenderHelper,n=e.lightDirection,r=e.ambientLighting,s=e.directionalLighting,o=e.projectionParameters.viewProjectionMat;const l=this.viewer.showSliceViews.value;for(const f of this.sliceViews){var c=oe(f,2);const g=c[0];if(!c[1]&&!l)continue;var u=g.projectionParameters.value;const v=u.width,y=u.height,C=u.invViewMatrix,w=u.viewportNormalInCanonicalCoordinates;if(v===0||y===0||!g.valid)continue;let S=Math.abs(yv(n,w)),L=r+S*s,I=Hz;_1(I),I[0]=v/2,I[5]=-y/2,fi(I,C,I),fi(I,o,I);const M=GC,R=this.viewer.crossSectionBackgroundColor.value;M[0]=R[0],M[1]=R[1],M[2]=R[2],M[3]=1,t.draw(g.offscreenFramebuffer.colorBuffers[0].texture,I,Nd(L,L,L,1),GC,0,0,1,1)}}drawAxisLines(){const e=this.viewer.navigationState.zoomFactor.value,t=this.projectionParameters.value,n=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,r=e*n,s=this.gl;s.drawBuffers([s.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(pI(t,r),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}var ho;(function(i){i[i.COLOR=0]="COLOR",i[i.PICK=1]="PICK",i[i.NUM_TEXTURES=2]="NUM_TEXTURES"})(ho||(ho={}));function Yz(i){i.addOutputBuffer("vec4","out_fragColor",0),i.addOutputBuffer("highp vec4","out_pickId",1),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function Kz(i){i.addOutputBuffer("vec4","out_fragColor",null),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}const Ks=Ne(),Xz=Ne(),Qz=Eh();class rp extends vI{constructor(e,t,n,r){super(e,t,r),this.sliceView=n,this.axesLineHelper=this.registerDisposer(ip.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(ZL.get(this.gl,Kz)),this.colorFactor=Nd(1,1,1,1),this.pickIDs=new fI,this.offscreenFramebuffer=this.registerDisposer(new Do(this.gl,{colorBuffers:[new ra(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new ra(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(Po.get(this.gl)),this.scaleBars=this.registerDisposer(new yI(this.gl)),r.wireFrame.changed.add(()=>this.scheduleRedraw()),Se(t,"rotate-via-mouse-drag",s=>{const o=this.viewer.mouseState;if(o.updateUnconditionally()){const l=Float32Array.from(o.position);zn(s.detail,(c,u,f)=>{const g=this.navigationState.pose,v=fo(Ks,Kn[0],g.orientation.orientation),y=fo(Xz,Kn[1],g.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(y,-u/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(v,-f/4*Math.PI/180,l)})}}),Se(t,"rotate-in-plane-via-touchrotate",s=>{const o=s.detail,l=this.viewer.mouseState;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(n),this.visibleLayerTracker=HI(this.viewer.layerManager,Ro,this.viewer.visibleLayerRoles,this),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.visibility.add(this.visibility)),this.registerDisposer(n.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(r.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(r.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){this.viewer.navigationState.pose.updateDisplayPosition(n=>{xg(n,-e,-t,0),yn(n,n,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,n,r){const s=this.sliceView.projectionParameters.value;return yn(e,t,s.viewMatrix),xg(e,e[0]+n,e[1]+r,e[2]),yn(e,e,s.invViewMatrix),e}isReady(){if(!this.visible)return!1;const e=this.sliceView;if(this.ensureBoundsUpdated(),!e.isReady())return!1;const t={projectionParameters:e.projectionParameters.value,sliceView:e};for(const r of this.visibleLayerTracker.visibleLayers){var n=oe(r,2);const s=n[0],o=n[1];if(!s.isReady(t,o))return!1}return!0}drawWithPicking(e){const t=this.sliceView;if(!t.valid)return!1;t.updateRendering();const n=t.projectionParameters.value,r=n.width,s=n.height,o=n.invViewProjectionMat;wu(e.invTransform,o);const l=this.gl;this.offscreenFramebuffer.bind(r,s),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const c=Qz,u=this.viewer.crossSectionBackgroundColor.value;c[0]=u[0],c[1]=u[1],c[2]=u[2],c[3]=1,this.offscreenFramebuffer.bindSingle(ho.COLOR),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,j1,this.colorFactor,c,0,0,1,1);const f=this.visibleLayerTracker.visibleLayers;let g=this.pickIDs;g.clear();const v={wireFrame:this.viewer.wireFrame.value,projectionParameters:n,pickIDs:g,emitter:Yz,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(r,s),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const C of f){var y=oe(C,2);const w=y[0],S=y[1];w.draw(v,S)}if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(ho.COLOR),this.viewer.showAxisLines.value){const C=Math.min(n.logicalWidth,n.logicalHeight)/4*1.5,w=this.viewer.navigationState.zoomFactor.value;this.axesLineHelper.draw(bN(pI(n,C*w)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(n,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[ho.COLOR].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){this.offscreenFramebuffer.readPixelFloat32IntoBuffer(ho.PICK,e-pi,t-pi,0,pt,pt)}completePickRequest(e,t,n,r){const s=this.viewer.mouseState;s.pickedRenderLayer=null,mI(n,0,4,e,t,r.viewportWidth,r.viewportHeight);const o=r.viewportWidth,l=r.viewportHeight,c=Zu.length,u=this.navigationState.position.value,f=u.length,g=this.navigationState.pose.displayDimensions.value,v=g.displayRank,y=g.displayDimensionIndices,C=(L,I,M)=>{const R=e+L,D=t+I;Ks[0]=2*R/o-1,Ks[1]=2*D/l-1,Ks[2]=0,yn(Ks,Ks,r.invTransform),M.set(u);for(let T=0;T<v;++T)M[y[T]]=Ks[T]};let w=s.unsnappedPosition;w.length!==f&&(w=s.unsnappedPosition=new Float32Array(f)),s.coordinateSpace=this.navigationState.coordinateSpace.value,s.displayDimensions=g,C(0,0,w);const S=(L,I,M)=>{let R=s.position;R.length!==f&&(R=s.position=new Float32Array(f)),C(L-pi,I-pi,R),this.pickIDs.setMouseState(s,M),s.setActive(!0)};for(let L=0;L<c;++L){const I=Zu[L],M=n[4*L];if(M===0)continue;const R=I%pt,D=(I-R)/pt;S(R,D,M);return}S(pi,pi,0)}zoomByMouse(e){const t=this.navigationState;if(!t.valid)return;var n=this.sliceView.projectionParameters.value;const r=n.width,s=n.height,o=n.invViewMatrix;var l=n.displayDimensionRenderInfo;const c=l.displayDimensionIndices,u=l.displayRank;let f=this.mouseX,g=this.mouseY;f-=r/2,g-=s/2;const v=this.navigationState.position.value;for(let y=0;y<u;++y){const C=c[y],w=o[y]*f+o[4+y]*g;v[C]+=w*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function SI(i,e){let t="";for(let n=0;n<=e&&(t=i.toFixed(n),parseFloat(t)!==i);++n);return t}const eG=["#f00","#0f0","#00f"],WC=vt.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function tG(i){if(i<1||i>1024){const e=Yi(i)|0,t=i/2**e;return`${SI(t,1)}p${e}`}return i.toString()}const iG=[i=>i.name,i=>i.scaleFactor],nG=2e3;class rG extends K{constructor(e,t,n,r="px"){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=n,this.displayUnit=r,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=Te(Array(3),(w,S)=>{const L=document.createElement("div");L.classList.add("neuroglancer-display-dimensions-widget-dimension"),L.style.display="contents",Se(L,"adjust-via-wheel",A=>{const V=A.detail.deltaY;V!==0&&this.zoomDimension(S,Ed(V))});const I=document.createElement("input");I.classList.add("neuroglancer-display-dimensions-widget-name"),I.title="Change display dimensions",I.spellcheck=!1,I.autocomplete="off",I.style.color=eG[S],I.style.gridColumn="1",I.style.gridRow=`${S+1}`,I.addEventListener("focus",()=>{I.select()}),L.appendChild(I);const M=document.createElement("span");M.classList.add("neuroglancer-display-dimensions-widget-scale-factor");const R=document.createElement("input");R.spellcheck=!1,R.title="Change relative scale at which dimension is displayed",R.autocomplete="off",M.style.gridColumn="2",M.style.gridRow=`${S+1}`,R.addEventListener("focus",()=>{R.select()}),M.appendChild(R),L.appendChild(M);const D=document.createElement("span");D.classList.add("neuroglancer-display-dimensions-widget-scale"),D.style.gridColumn="3",D.style.gridRow=`${S+1}`,L.appendChild(D),this.dimensionGridContainer.appendChild(L);const T={name:I,container:L,scaleFactor:R,scale:D,scaleFactorModified:!1};I.addEventListener("input",()=>{qi(I),this.updateNameValidity()}),Se(I,"commit",()=>{this.updateNames()}),I.addEventListener("blur",A=>{const V=A.relatedTarget;this.dimensionElements.some(O=>O.name===V)||this.updateNames()||this.updateView()}),M.addEventListener("click",A=>{A.target!==R&&(R.focus(),A.preventDefault())}),R.addEventListener("input",()=>{qi(R),T.scaleFactorModified=!0}),Se(R,"commit",()=>{this.updateScaleFactors()}),R.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(const A of iG)Se(A(T),"move-up",()=>{S!==0&&A(this.dimensionElements[S-1]).focus()}),Se(A(T),"move-down",()=>{S!==2&&A(this.dimensionElements[S+1]).focus()});return T}),this.scheduleUpdateView=wt(()=>this.updateView());const s=this.element,o=this.dimensionGridContainer,l=this.defaultCheckbox,c=document.createElement("label"),u=this.registerCancellable(ct(()=>{s.dataset.active="false"},nG)),f=()=>{s.dataset.active="true",u()};this.registerDisposer(t.changed.add(f)),this.registerDisposer(e.relativeDisplayScales.changed.add(f)),this.registerDisposer(n.changed.add(f)),s.classList.add("neuroglancer-display-dimensions-widget"),s.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),s.addEventListener("pointerleave",()=>{const w=document.activeElement;w instanceof HTMLElement&&s.contains(w)&&w.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));const g=this.registerDisposer(new $n(s,WC));g.allShortcutsAreGlobal=!0,this.registerDisposer(new Zr(s,WC)),Se(o,"cancel",()=>{this.updateView();const w=document.activeElement;w instanceof HTMLElement&&s.contains(w)&&w.blur()});const v=this.depthGridContainer;v.classList.add("neuroglancer-depth-range-widget-grid"),s.appendChild(v);const y=document.createElement("label"),C=document.createElement("input");C.type="checkbox",y.classList.add("neuroglancer-depth-range-relative-checkbox-label"),C.classList.add("neuroglancer-depth-range-relative-checkbox"),y.appendChild(C),y.appendChild(document.createTextNode("Zoom-relative")),C.addEventListener("change",()=>{const w=C.checked;let S=this.depthRange.value;w!==S<0&&(w?S=-S/this.zoom.value:S=-S*this.zoom.value,this.depthRange.value=S)}),y.title="Depth range is multiplied by scale",s.appendChild(y),Se(v,"adjust-via-wheel",w=>{const S=w.detail.deltaY;if(S===0)return;const L=this.depthRange.value;this.depthRange.value=L*2**Ed(S)}),this.registerDisposer(Fr((w,S,{factors:L})=>{nt(v);const I=S.displayRank,M=S.globalDimensionNames,R=S.displayDimensionIndices,D=S.displayDimensionUnits,T=S.displayDimensionScales,A=S.canonicalVoxelFactors,V=[],O=()=>{C.checked=this.depthRange.value<0;let U=this.depthRange.value;U<0&&(U*=-this.zoom.value);for(const B of V){const W=B.input;W.value=la(U*B.scale,B.unit,{precision:2,elide1:!1}),qi(W)}},_=U=>{const B=fd(U.input.value);if(B===void 0||B.unit!==U.unit)return!1;let W=B.scale/U.scale;return this.depthRange.value<0&&(W=-W/this.zoom.value),this.depthRange.value=W,!0};for(let U=0;U<I;++U){const B=R[U],W=M[B],F=D[U],le=L[B];let de=V.find(Re=>Re.unit===F&&Re.factor===le);if(de===void 0){const Re=document.createElement("div");Re.title="Visible depth range",Re.style.display="contents",v.appendChild(Re);const ce=document.createElement("span");ce.textContent="±",Re.appendChild(ce);const Le=document.createElement("input");Le.spellcheck=!1,Le.autocomplete="off",Le.addEventListener("focus",()=>{Le.select()}),Se(Le,"commit",()=>{_(de)}),Le.addEventListener("change",()=>{_(de)||O()}),Le.addEventListener("input",()=>{qi(Le)}),Re.appendChild(Le);const Be=document.createElement("span");Be.classList.add("neuroglancer-depth-range-widget-dimension-names"),Re.appendChild(Be),de={unit:F,factor:le,dimensionNames:[],input:Le,label:Be,scale:T[U]/A[U]},V.push(de)}de.dimensionNames.push(W)}for(const U of V)U.dimensionNames.length!==I&&(U.label.textContent=U.dimensionNames.join(" "));w.registerDisposer(Se(v,"cancel",()=>{O();const U=document.activeElement;U instanceof HTMLElement&&v.contains(U)&&U.blur()}));const H=w.registerCancellable(wt(O));w.registerDisposer(this.depthRange.changed.add(H)),w.registerDisposer(this.zoom.changed.add(H)),O()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();const n=this.displayDimensions,r=this.relativeDisplayScales,s=n.value.displayDimensionIndices[e];if(s===-1)return;const o=r.value.factors,l=new Float64Array(o);l[s]*=2**-t,r.setFactors(l)}updateNameValidity(){const e=this.dimensionElements,t=this.displayDimensions.value.displayDimensionIndices,n=e.map(l=>l.name.value),r=Rv(n),s=this.displayDimensions.coordinateSpace.value.names,o=n.length;for(let l=0;l<o;++l){let c=r[l];const u=n[l];let f=-1;u.length===0?c=!0:(f=s.indexOf(u),f===-1&&(c=!1));const g=e[l];g.name.dataset.isValid=c.toString(),g.container.dataset.isModified=(f!==t[l]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){const e=this.dimensionElements.map(o=>o.name.value).filter(o=>o.length>0);if(!Ph(e))return!1;const t=this.displayDimensionRenderInfo.displayDimensions;if(e.length===0)return t.reset(),!0;const n=new Int32Array(3);n.fill(-1);const r=t.coordinateSpace.value.names,s=e.length;for(let o=0;o<s;++o){const l=r.indexOf(e[o]);if(l===-1)return!1;n[o]=l}return _e(n,t.value.displayDimensionIndices)||t.setDimensionIndices(s,n),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){const e=this.displayDimensions,t=this.relativeDisplayScales;var n=e.value;const r=n.displayDimensionIndices,s=n.displayRank,o=t.value.factors,l=this.dimensionElements,c=new Float64Array(o);for(let u=0;u<s;++u){const f=l[u];if(!f.scaleFactorModified)continue;const g=Number(f.scaleFactor.value),v=r[u];!kt(g)||g<=0||(c[v]=g)}return _e(c,o)||t.setFactors(c),!0}updateView(){const e=this.dimensionElements,t=this.displayDimensions.default;var n=this.displayDimensionRenderInfo.value;const r=n.displayDimensionIndices,s=n.canonicalVoxelFactors,o=n.displayDimensionUnits,l=n.displayDimensionScales,c=n.globalDimensionNames,u=this.relativeDisplayScales.value.factors;this.defaultCheckbox.checked=t;const f=this.zoom.value,g=r[0];let v=!0;if(g!==-1){const y=o[0],C=u[g];for(let w=1;w<3;++w){const S=r[w];if(S!==-1&&(o[w]!==y||u[S]!==C)){v=!1;break}}}for(let y=0;y<3;++y){const C=r[y],w=e[y];if(delete w.name.dataset.isValid,w.container.dataset.isModified=(C===-1).toString(),C===-1)w.name.value="",w.scale.textContent="",w.scaleFactor.value="";else{w.name.value=c[C];const S=l[y]*f/s[y];if(y===0||!v){const L=la(S,o[y],{precision:2,elide1:!1});w.scale.textContent=`${L}/${this.displayUnit}`}else w.scale.textContent="";w.scaleFactor.value=tG(u[C])}qi(w.name),qi(w.scaleFactor)}}disposed(){Bt(this.element),super.disposed()}}const wI=new ue([["xy",void 0],["xz",dN(zi(),zi(),Math.PI/2)],["yz",cN(zi(),zi(),Math.PI/2)]]),CI="◻",hm=new ue([["4panel","◱"],["3d",CI]]);function sG(i,e){let t;return e===void 0?t=i.navigationState.addRef():t=new Bo(new Oo(i.navigationState.pose.position.addRef(),i.navigationState.pose.displayDimensionRenderInfo.addRef(),Vo.makeRelative(i.navigationState.pose.orientation,e)),i.navigationState.zoomFactor.addRef(),i.navigationState.depthRange.addRef()),new Fu(i.chunkManager,i.layerManager,t,i.wireFrame)}function ld(i,e){return sG(i,wI.get(e))}function aG(i){return new ue([["xy",ld(i,"xy")],["xz",ld(i,"xz")],["yz",ld(i,"yz")]])}function xI(i){return{crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor,selectionDetailsState:i.selectionDetailsState,mouseState:i.mouseState,layerManager:i.layerManager,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,visibleLayerRoles:i.visibleLayerRoles,selectedLayer:i.selectedLayer,visibility:i.visibility,scaleBarOptions:i.scaleBarOptions}}function ky(i){const e=i.viewer;return j(j({},xI(e)),{navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:i.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc})}function qu(i){return j(j({},xI(i)),{navigationState:i.navigationState,inputEventMap:i.inputEventBindings.sliceView})}function zo(i,e){const t=e.navigationState;e.element.appendChild(i.registerDisposer(new rG(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof rp?"px":"vh")).element)}function Go(i,e,t){const n=document.createElement("div");n.className="neuroglancer-data-panel-layout-controls",i.registerDisposer(()=>Bt(n));for(let r=0;r<2;++r){const s=t[Math.min(t.length-1,r)];i.registerDisposer(Se(e.element,r===0?"toggle-layout":"toggle-layout-alternative",o=>{i.container.name=s,o.stopPropagation()}))}for(const r of t){const s=document.createElement("button"),o=document.createElement("div");s.appendChild(o),o.textContent=hm.get(r),s.title=`Switch to ${r} layout.`,s.addEventListener("click",()=>{i.container.name=r}),n.appendChild(s)}e.element.appendChild(n)}function oG(i,e){const t=new Fu(i.chunkManager,i.layerManager,e.navigationState.addRef(),i.wireFrame),n=()=>{const r=e.width.value,s=e.height.value;t.projectionParameters.setViewport({width:r,height:s,logicalWidth:r,logicalHeight:s,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(n)),t.registerDisposer(e.height.changed.add(n)),n(),t}function Iy(i,e,t){const n=new ue;(()=>{const r=new je;for(const o of t.values()){if(r.add(o),n.has(o))continue;const l=oG(i,o);e.sliceViews.set(l,!0),n.set(o,l)}for(const o of n){var s=oe(o,2);const l=s[0],c=s[1];r.has(l)||e.sliceViews.delete(c)}})()}class lG extends K{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=aG(n),o=n.display;const l=j(j({},ky(e)),{showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),c=j(j({},qu(n)),{showScaleBar:n.showScaleBar}),u=j(j({},qu(n)),{showScaleBar:new Qt(!1,!1)}),f=(v,y,C,w)=>{const S=this.registerDisposer(new rp(o,y,s.get(v),C));return w&&zo(this,S),Go(this,S,[v,`${v}-3d`]),S};let g=[mn(1,ea("column",[mn(1,ea("row",[mn(1,v=>{f("xy",v,c,!0)}),mn(1,v=>{f("xz",v,u,!1)})])),mn(1,ea("row",[mn(1,v=>{let y=this.registerDisposer(new Ly(o,v,l));for(let C of s.values())y.sliceViews.set(C.addRef(),!1);zo(this,y),Iy(n,y,r),Go(this,y,["3d"])}),mn(1,v=>{f("yz",v,u,!1)})]))]))];ea("row",g)(t)}disposed(){nt(this.rootElement),super.disposed()}}class dG extends K{constructor(e,t,n,r,s,o){super(),this.container=e,this.rootElement=t,this.viewer=n,this.direction=r;let l=ld(n,s),c=n.display;const u=j(j({},ky(e)),{showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),f=j(j({},qu(n)),{showScaleBar:n.showScaleBar});mn(1,ea(r,[mn(1,g=>{const v=this.registerDisposer(new rp(c,g,l,f));zo(this,v),Go(this,v,[s,"4panel"])}),mn(1,g=>{let v=this.registerDisposer(new Ly(c,g,u));v.sliceViews.set(l.addRef(),!1),Iy(n,v,o),zo(this,v),Go(this,v,["3d","4panel"])})]))(t)}disposed(){nt(this.rootElement),super.disposed()}}class cG extends K{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=ld(n,r);const o=j(j({},qu(n)),{showScaleBar:n.showScaleBar});ea("row",[mn(1,l=>{const c=this.registerDisposer(new rp(n.display,l,s,o));zo(this,c),Go(this,c,["4panel",`${r}-3d`])})])(t)}disposed(){nt(this.rootElement),super.disposed()}}class uG extends K{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=j(j({},ky(e)),{showSliceViews:new Qt(!1,!1)});ea("row",[mn(1,o=>{const l=this.registerDisposer(new Ly(n.display,o,s));Iy(n,l,r),zo(this,l),Go(this,l,["4panel"])})])(t)}disposed(){nt(this.rootElement),super.disposed()}}const pm=new ue([["4panel",{factory:(i,e,t,n)=>new lG(i,e,t,n)}],["3d",{factory:(i,e,t,n)=>new uG(i,e,t,n)}]]);for(const i of wI.keys()){pm.set(i,{factory:(t,n,r)=>new cG(t,n,r,i)});const e=`${i}-3d`;hm.set(i,CI),hm.set(e,"◫"),pm.set(e,{factory:(t,n,r,s)=>new dG(t,n,r,"row",i,s)})}function EI(i){let e=pm.get(i);if(e===void 0)throw new Error(`Invalid layout name: ${se(i)}.`);return e}function hG(i){return EI(i),i}class pG extends K{constructor(e){super(),this.width=new ci(1e3,li),this.height=new ci(1e3,li),this.changed=new xe,this.position=new bk(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new tm(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new im(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Bo(new Oo(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){ge(e),Li(e,"width",this.width),Li(e,"height",this.height),Li(e,"position",Ld(this.position)),Li(e,"orientation",this.orientation),Li(e,"scale",this.scale),Li(e,"zoom",Ld(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class fG extends Uv{constructor(e){super((t,n)=>t.registerDisposer(t.registerDisposer(n).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){ge(e);for(const t of di(e)){const n=new pG(this.parentNavigationState);try{this.set(t,n.addRef()),n.restoreState(e[t])}finally{n.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;const e={};for(const n of this){var t=oe(n,2);const r=t[0],s=t[1];e[r]=s.toJSON()}return e}}class gG extends K{constructor(e,t){super(),this.changed=new xe,this.orthographicProjection=new Qt(!1),this.type=new ci(t,hG),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new fG(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(ge(e),Y(e,"type",t=>this.type.restoreState(t)),Y(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),Y(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){const e=this.type,t=this.crossSections,n=this.orthographicProjection.toJSON();return t.size===0&&n===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:n}}}class mG extends K{constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new gG(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";const n=this.registerCancellable(ct(()=>this.updateLayout(),0));this.specification.type.changed.add(n),Se(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>n.flush())),n()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let e=this.layout;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=EI(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}const LI=new ue;function Ca(i,e){LI.set(i,e)}function vG(i){const e=new r3(i.credentialsManager);for(const n of LI){var t=oe(n,2);const r=t[0],s=t[1];e.register(r,s(i))}return e}class ha extends Error{constructor(e,t,n,r){let s=`Fetching ${se(e)} resulted in HTTP error ${t}`;n&&(s+=`: ${n}`),s+=".",super(s),this.name="HttpError",this.message=s,this.url=e,this.status=t,this.statusText=n,r&&(this.response=r)}static fromResponse(e){return new ha(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let n;return typeof e=="string"?n=e:n=e.url,new ha(n,0,"Network or CORS error")}return t}}async function $C(i,e){let t;try{t=await fetch(i,e)}catch(n){throw ha.fromRequestError(i,n)}if(!t.ok)throw ha.fromResponse(t);return t}function kI(i){return i.arrayBuffer()}function jn(i){return i.json()}async function or(i,e,t,n=qt){if(n===qt){const o=await $C(i,e);return await t(o)}const r=new AbortController,s=n.add(()=>r.abort());try{const o=await $C(i,j(j({},e),{signal:r.signal}));return await t(o)}finally{s()}}function Wo(i){const e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/;let t=i.match(e);if(t===null)throw new Error(`Invalid URL: ${se(i)}`);return{protocol:t[1],host:t[2],path:t[3]}}function sp(i){return i instanceof ha?i.status===0||i.status===403||i.status===404:!1}const yG=32,bG=3,SG=500,wG=1e4;function jC(i){return Math.min(2**i*SG,wG/2)*(1+Math.random())}async function Ty(i,e,t,n,r,s,o=qt){let l;e:for(let c=0;;){YO(o),c>1&&await new Ot(u=>setTimeout(u,jC(c-2))),l=await i.get(l,o);t:for(let u=0;;)try{return await or(typeof e=="function"?e(l.credentials):e,r(l.credentials,t),n,o)}catch(f){if(f instanceof ha){if(s(f,l.credentials)==="refresh"){if(++c===bG)throw f;continue e}if(++u===yG)throw f;await new Ot(g=>setTimeout(g,jC(u-1)));continue t}throw f}}}function ta(i,e,t,n,r=qt){return i===void 0?or(e,t,n,r):Ty(i,e,t,n,(s,o)=>{if(!s.accessToken)return o;const l=new Headers(o.headers);return l.set("Authorization",`${s.tokenType} ${s.accessToken}`),j(j({},o),{headers:l})},(s,o)=>{const l=s.status;if(l===401)return"refresh";if(l===504||l===503)return"retry";if(l===403&&!o.accessToken)return"refresh";throw s},r)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function CG(i,e,t,n,r){const s=await ta(i,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(n)}`,{},f=>f.text(),r),o=new DOMParser().parseFromString(s,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let f=0,g=l.snapshotLength;f<g;++f)c.push(l.snapshotItem(f).textContent||"");const u=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let f=0,g=u.snapshotLength;f<g;++f)c.push(u.snapshotItem(f).textContent||"");return c}async function fm(i,e,t,n,r){if(!n.startsWith("/"))throw null;const s=await CG(i,t,n.substring(1),"/",r);let o=n.lastIndexOf("/");return{offset:o+e.length+1,completions:s.map(l=>({value:l.substring(o)}))}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xG extends nc{constructor(e){super(),this.bucket=e,this.get=tp(async()=>{var t;const n=this.bucket,r=await or(`https://s3.amazonaws.com/${n}?location`,{},o=>o.text()),s=new DOMParser().parseFromString(r,"application/xml").querySelector("LocationConstraint");if(s===null)throw new Error(`Unable to determine location of S3 bucket: ${n}`);return{region:((t=s.textContent)===null||t===void 0?void 0:t.trim())||"us-east-1"}})}}let nu;function II(i){return nu===void 0&&(nu=new hI,nu.register("s3",e=>new xG(e))),nu.getCredentialsProvider("s3",i)}async function EG(i,e,t,n,r,s=qt){const o=(await i.get()).credentials.region;return await or(`https://${e}.s3.${o}.amazonaws.com${t}`,n,r,s)}async function LG(i,e,t){const n=(await II(i).get()).credentials.region;return await fm(void 0,`s3://${i}`,`https://${i}.s3.${n}.amazonaws.com`,e,t)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kG(i,e){return i.getCredentialsProvider("middleauthapp",new URL(e).origin)}function ru(i,e,t){const n=/^\/([^\/]+)/,r=t.match(n);if(r!==null)return typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?i.getCredentialsProvider("gcs",{bucket:r[1]}):i.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:r[1]})}function rl(i,e){const t=Wo(i);switch(t.protocol){case"gs":case"gs+json":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:i};case"gs+ngauth+http":return{credentialsProvider:ru(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:ru(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:ru(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:ru(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return i=i.substr(11),{credentialsProvider:kG(e,i),url:i};case"s3":return{credentialsProvider:II(t.host),url:i};default:return{credentialsProvider:void 0,url:i}}}async function xa(i,e,t,n,r=qt){const s=Wo(e);switch(s.protocol){case"gs":return ta(i,`https://www.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,t,n,r);case"gs+json":return ta(i,`https://storage.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media`,t,n,r);case"gs+xml":return ta(i,`https://storage.googleapis.com/${s.host}${s.path}`,t,n,r);case"s3":return EG(i,s.host,s.path,t,n,r);default:return ta(i,e,t,n,r)}}const IG=typeof STATE_SERVERS<"u"&&di(STATE_SERVERS).length>0;class TG extends K{constructor(e){if(super(),this.element=document.createElement("div"),this.button=Lt({text:"Share",title:"Share State"}),typeof STATE_SERVERS>"u")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(di(STATE_SERVERS).length>1){const n=document.createElement("select");n.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{const r=e.selectedStateServer.value;dm(STATE_SERVERS).map(s=>s.url).includes(r)&&(n.value=r)})),this.registerEventListener(n,"change",()=>{e.selectedStateServer.value=n.value});for(let r of Jd(STATE_SERVERS)){var t=oe(r,2);let s=t[0],o=t[1];const l=document.createElement("option");l.textContent=s,l.value=o.url,l.selected=!!o.default,n.appendChild(l)}this.element.appendChild(n),this.selectStateServerElement=n}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{const n=this.selectStateServerElement?this.selectStateServerElement.value:dm(STATE_SERVERS)[0].url,r=new URL(n).protocol;var s=rl(n,nl);const o=s.url,l=s.credentialsProvider;tt.forPromise(xa(l,o,{method:"POST",headers:{"Content-Type":"application/json"},body:se(e.state.toJSON())},jn).then(c=>{const u=new URL(c);u.protocol=r;const f=`${window.location.origin}/#!${u}`;navigator.clipboard.writeText(f).then(()=>{tt.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{tt.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${n}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}function DG(i){return i.startsWith("key")?i.substring(3):i.startsWith("digit")||i.startsWith("arrow")?i.substring(5):i}function PG(i){return i.split("+").map(DG).join("+")}const AG=j(j({},Sa),{side:"left",row:1});class MG{constructor(){this.location=new Rs(AG)}get changed(){return this.location.changed}toJSON(){return va(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class RG extends wa{constructor(e,t,n,r,s){super(e,t.location),this.bindings=n,this.toolBinder=s,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});const o=document.createElement("div");o.classList.add("neuroglancer-help-body");const l=this.scroll;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);const c=this.registerCancellable(wt(()=>this.updateView()));this.registerDisposer(s.changed.add(c)),this.registerDisposer(r.layersChanged.add(c)),this.updateView()}updateView(){const e=this.scroll,t=this.bindings,n=this.toolBinder;nt(e);const r=new ue;function s(y,C){for(const S of y.parents)S.label!==void 0?o(S.label,S):s(S,C);for(const S of y.bindings.entries()){var w=oe(S,2);const L=w[0],I=w[1],M=L.indexOf(":"),R=L.substring(M+1);C.set(R,I.action)}}function o(y,C){if(r.has(C))return;const w={label:y,entries:new ue};s(C,w.entries),r.set(C,w)}for(const y of t){var l=oe(y,2);const C=l[0],w=l[1];o(C,w)}const c=(y,C)=>{let w=document.createElement("h2");w.textContent=y,e.appendChild(w);for(const L of C){var S=oe(L,2);const I=S[0],M=S[1];let R=document.createElement("div");R.className="dt",R.textContent=PG(I);let D=document.createElement("div");D.className="dd",D.textContent=M,e.appendChild(R),e.appendChild(D)}},u=new ue;for(const y of n.bindings){var f=oe(y,2);const C=f[0],w=f[1];let S=u.get(w.layer);S===void 0&&(S=[],u.set(w.layer,S)),S.push([`shift+key${C.toLowerCase()}`,w.description])}const g=Te(u.entries());g.length>0&&(g[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),g.sort((y,C)=>y[0].managedLayer.nonArchivedLayerIndex-C[0].managedLayer.nonArchivedLayerIndex));for(const y of g){var v=oe(y,2);const C=v[0],w=v[1];w.sort(),c(`Tool bindings for layer ${C.managedLayer.nonArchivedLayerIndex+1}: ${C.managedLayer.name}`,w)}for(const y of r.values())c(y.label,y.entries)}}function NG(i,e){i.style.display="block";const t=i.offsetWidth,n=i.offsetHeight,r=document.documentElement.clientWidth,s=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(r-t,e.clientX),l=document.documentElement.scrollTop+Math.min(s-n,e.clientY);i.style.left=o+"px",i.style.top=l+"px"}class VG extends K{constructor(e){super(),this.element=document.createElement("div"),this.parentDisposers=new ue,this.disabledValue=!1,this.opened=new xe,this.closed=new xe;const t=this.element;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){const t=this.parentDisposers;t.has(e)||t.set(e,Bn(e,"contextmenu",n=>{this.show(n),n.stopPropagation(),n.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();const t=this.element,n=Bn(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),r=Bn(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),s=()=>{r(),n(),t.style.display="none"};this.opened.dispatch(),NG(t,e),this.menuDisposer=s}unregisterParent(e){const t=this.parentDisposers,n=t.get(e);n!==void 0&&(n(),t.delete(e))}disposed(){const e=this.parentDisposers;for(const t of e.values())t();e.clear(),Bt(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}function OG(i){return wN(new TextEncoder().encode(i))}function BG(i){return new TextDecoder().decode(CN(i))}function _G(i,e){if(i.startsWith(e))try{const t=BG(i.substring(e.length));return JSON.parse(t)}catch{return}}function FG(i,e){return i+OG(se(e))}function UG(i,e){for(const t of i){const n=_G(t,e);if(n!==void 0)return{parameters:n,dragType:t}}}let TI;function Dy(i,e){return i.dataTransfer.dropEffect=e,TI=e,e}function gm(){return TI}function zG(i){return i.draggable=!0,Bn(i,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}const DI="neuroglancer-layer\0";let bn;function PI(i,e){var t;i.dataTransfer.setData(FG(DI,e.layers.map(s=>({name:s.name,visible:s.visible}))),se({layers:e.layers.map(s=>s.toJSON()),layout:e.layoutSpec})),bn!==void 0&&bn.disposer();let n,r=()=>{e.manager.unregisterDisposer(r);for(const s of e.layers)s.dispose();e.manager.dispose(),bn===n&&(bn=void 0)};bn=n={manager:e.manager.addRef(),layers:e.layers.map(s=>s.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(t=e.isLayerListPanel)!==null&&t!==void 0?t:!1,disposer:r}}function ap(i="none"){if(bn!==void 0){if(i==="move"){const e=new je(bn.layers);bn.manager.layerManager.filter(t=>!e.has(t))}bn.disposer()}}function Yu(i){return UG(i.dataTransfer.types,DI)}function AI(i){if(bn!==void 0&&bn.manager.rootLayers===i.rootLayers)return bn}class HC{initializeExternalLayers(e){const t=this.dragType;if(t!==void 0)try{var n=JSON.parse(e.dataTransfer.getData(t));const s=n.layers,o=n.layout;if(!Array.isArray(s)||this.numSourceLayers!==s.length)throw new Error("Invalid layer drop data");this.layoutSpec=o;for(const l of this.layers){var r=oe(l,2);const c=r[0],u=r[1];uW(c,s[u])}}catch{return!1}return!0}updateArchiveStates(e){const t=this.targetIsLayerListPanel,n=e.dataTransfer.dropEffect;for(const r of this.layers.keys()){let s=t;t&&!r.archived&&n!=="copy"&&this.sourceIsLayerListPanel&&(s=!1),(r.archived!==s||s&&r.visible)&&(r.archived=s,s&&(r.visible=!1),r.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}}function MI(i,e,t){let n;i.shiftKey?n="copy":i.ctrlKey&&t?n="move":n=e;let r="";const s=o=>{r!==""&&(r+=", "),r+=o};return e!=="none"&&n!==e&&(i.shiftKey?s(`release SHIFT to ${e}`):s(`release CONTROL to ${e}`)),n!=="copy"&&s("hold SHIFT to copy"),n!=="move"&&t&&e!=="move"&&s("hold CONTROL to move"),{dropEffect:n,dropEffectMessage:r}}function RI(i,e,t,n){const r=AI(e);let s=!1,o;return r===void 0?o="copy":n?(r.isLayerListPanel||(s=!0),o="link"):r.manager===e&&r.isLayerListPanel===t?(o="move",s=!0):t?o="none":(r.isLayerListPanel||(s=!0),o="link"),MI(i,o,s)}function GG(i,e,t,n){const r=RI(i,e,t,n);return Dy(i,r.dropEffect),r}function mm(i,e,t){const n=t.forceCopy,r=t.newTarget;var s=t.isLayerListPanel;const o=s===void 0?!1:s,l=AI(e);if(!n&&l!==void 0){const u=!r&&l.manager===e&&(l.isLayerListPanel===o||l.isLayerListPanel),f=new HC;return f.manager=e,f.numSourceLayers=l.layers.length,f.sourceManager=l.manager,f.targetIsLayerListPanel=o,f.sourceIsLayerListPanel=l.isLayerListPanel,f.moveSupported=u,f.layers=new ue,f.forceCopy=!1,f.layoutSpec=l.layoutSpec,u?l.layers.forEach((g,v)=>{f.layers.set(g,v)}):l.layers.forEach((g,v)=>{(r||!e.layerManager.has(g))&&f.layers.set(g.addRef(),v)}),f}const c=Yu(i);if(c!==void 0)try{const u=He(c.parameters,(g,v)=>{const y=Y(g,"name",Ie);let C=Y(g,"visible",oa);const w=new Ry(y,e);return o&&(C=!1),w.visible=C,w.archived=o,[w,v]}),f=new HC;return f.numSourceLayers=u.length,f.targetIsLayerListPanel=o,f.sourceIsLayerListPanel=!1,f.sourceManager=void 0,f.moveSupported=!1,f.forceCopy=l!==void 0,f.manager=e,f.dragType=c.dragType,f.layers=new ue(u),f}catch{}}function vm(i,e){return i.moveSupported?!1:(i.manager.layerManager.filter(t=>!i.layers.has(t)),e!==void 0&&i.layers.has(e))}function op(i,e,t,n=!1){function r(s,o){let l=i.dropLayers;var c=o?RI(s,i.manager,n,!1):{dropEffect:gm(),dropEffectMessage:""};const u=c.dropEffect,f=c.dropEffectMessage;if(u===void 0)return;Dy(s,u);let g=!0;if(!(l!==void 0&&!l.compatibleWithMethod(u)&&(i.dropLayers=void 0,vm(l,t)))){if(l===void 0){if(l=i.dropLayers=mm(s,i.manager,{forceCopy:u==="copy",newTarget:!1,isLayerListPanel:n}),l===void 0)return;g=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:u,dropEffectMessage:f};if(g){const v=i.manager.layerManager,y=new je;let C=Number.POSITIVE_INFINITY;const w=v.managedLayers=v.managedLayers.filter((L,I)=>l.layers.has(L)?(C===Number.POSITIVE_INFINITY&&(C=I),y.add(L),!1):!0);let S;t!==void 0?(S=w.indexOf(t),C<=S&&++S):S=w.length;for(const L of l.layers.keys())y.has(L)||l.layers.delete(L);w.splice(S,0,...l.layers.keys()),v.layersChanged.dispatch()}else{let v;t!==void 0&&(v=i.manager.layerManager.managedLayers.indexOf(t));for(const y of l.layers.keys())i.manager.add(y,v)}return{dropLayers:l,dropEffect:u,dropEffectMessage:f}}}e.addEventListener("dragenter",s=>{r(s,!0)!==void 0?s.preventDefault():ki(i.element,"drop")}),e.addEventListener("drop",s=>{var o;s.preventDefault(),i.dragEnterCount=0,ki(i.element,"drop");const l=(o=r(s,!1))===null||o===void 0?void 0:o.dropLayers;if(i.dropLayers=void 0,l!==void 0){if(!l.initializeExternalLayers(s)){vm(l);return}l.updateArchiveStates(s),ap(l.method==="move"?void 0:s.dataTransfer.dropEffect)}}),e.addEventListener("dragover",s=>{const o=r(s,!0);if(o===void 0){ki(i.element,"drop");return}const l=o.dropLayers,c=o.dropEffect,u=o.dropEffectMessage,f=l.layers.size;let g="";const v=l.numSourceLayers===1?"":"s",y=l.numSourceLayers;if(c==="none")g=`Cannot link dragged layer${v} here`;else{const C=y===f?`${y}`:`${f}/${y}`;g=`Drop to ${c} ${C} layer${v}`}u&&(g+=` (${u})`),ar(i.element,"drop",g),s.preventDefault(),s.stopPropagation()})}function NI(i,e,t,n){e.draggable=!0,e.addEventListener("dragstart",r=>{ar(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),PI(r,{manager:i.manager,layers:[t],layoutSpec:n.getLayoutSpec(),isLayerListPanel:n.isLayerListPanel}),r.stopPropagation()}),e.addEventListener("dragend",()=>{ki(e,"drag"),ap()})}function VI(i){i.element.addEventListener("dragenter",()=>{++i.dragEnterCount}),i.element.addEventListener("dragleave",()=>{if(--i.dragEnterCount!==0)return;ki(i.element,"drop");const e=i.dropLayers;e!==void 0&&(vm(e),i.manager.layerManager.layersChanged.dispatch(),i.dropLayers=void 0)})}const WG="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYmluSWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iYmluSWNvblRpdGxlIj5CaW48L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0xOSA2TDUgNk0xNCA1TDEwIDVNNiAxMEw2IDIwQzYgMjAuNjY2NjY2NyA2LjMzMzMzMzMzIDIxIDcgMjEgNy42NjY2NjY2NyAyMSAxMSAyMSAxNyAyMSAxNy42NjY2NjY3IDIxIDE4IDIwLjY2NjY2NjcgMTggMjAgMTggMTkuMzMzMzMzMyAxOCAxNiAxOCAxMCIvPgo8L3N2Zz4=";function Ss(i={}){const e=Lt(j({svg:WG},i)),t=e.firstElementChild;return t.style.fill="white",e}var JC=Yt,$G=dv,jG=gh;JC(JC.S,"String",{raw:function(i){for(var e=$G(i.raw),t=jG(e.length),n=arguments.length,r=[],s=0;t>s;)r.push(String(e[s++])),s<n&&r.push(String(arguments[s]));return r.join("")}});var HG=Ct.String.raw,JG={default:HG,__esModule:!0};const Ql=It(JG),gu="neuroglancer-position",ZC=vt.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),ZG=[i=>i.nameElement,i=>i.coordinate,i=>i.scaleElement];function mu(i,e){const t=i.coordinateArrays[e];return t===void 0?t:i.units[e]!=""||i.scales[e]!==1?null:t}let qG=class{constructor(i,e){this.coordinateSpace=i,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.coordinateLabelWidth=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;const t=this.container,n=this.scaleElement,r=this.scaleContainer,s=this.coordinate,o=this.nameElement,l=this.nameContainer,c=this.coordinateLabel;t.title="",t.classList.add("neuroglancer-position-dimension"),t.draggable=!0,t.tabIndex=-1,t.appendChild(l),t.appendChild(n),l.appendChild(o),l.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.appendChild(n),o.classList.add("neuroglancer-position-dimension-name"),o.disabled=!0,o.spellcheck=!1,o.autocomplete="off",o.required=!0,o.placeholder=" ",r.classList.add("neuroglancer-position-dimension-scale-container"),n.classList.add("neuroglancer-position-dimension-scale"),n.disabled=!0,n.spellcheck=!1,n.autocomplete="off",t.appendChild(r),t.appendChild(s),s.type="text",s.classList.add("neuroglancer-position-dimension-coordinate"),s.spellcheck=!1,s.autocomplete="off",s.pattern=Ql`(-?\d+(?:\.(?:\d+)?)?)`;const u=mu(i,e);if(u!=null){let f=0;for(const g of u.labels)f=Math.max(f,g.length);this.coordinateLabelWidth=f,c.style.width=`${f+2}ch`,t.appendChild(c)}s.required=!0,s.placeholder=" ",c.classList.add("neuroglancer-position-dimension-coordinate-label")}};function ym(i,e,t,n){return Math.floor((i-e)*(n-1)/(t-e))}function YG(i,e,t){const n=i.boundingBoxes,r=i.bounds,s=Math.floor(r.lowerBounds[e]),o=Math.ceil(r.upperBounds[e]-1);if(!kt(s)||!kt(o))return;const l=[],c=f=>ym(f,s,o,t),u=i.rank;for(const f of n){const g=DE(f,e,u);g!==void 0&&(g.lower=c(g.lower),g.upper=c(Math.ceil(g.upper-1)),l.push(g))}return l.sort((f,g)=>{const v=f.lower-g.lower;return v!==0?v:g.upper-g.upper}),T1(l,(f,g)=>{if(g===0)return!0;const v=l[g-1];return v.lower!==f.lower||v.upper!==f.upper}),{lowerBound:s,upperBound:o,normalizedBounds:l}}const bm=10,Sm=15,KG=10,eg=bm+Sm+KG;function XG(i,e,t){e.clearRect(0,0,i.width,i.height);const n=t.normalizedBounds;function r(l){e.fillRect(0,l,bm,1)}e.fillStyle="#fff";for(const l of n){const c=l.lower,u=l.upper;r(c),r(u)}const s=n.length;e.fillStyle="#ccc";for(let l=0;l<s;++l){var o=n[l];const c=o.lower,u=o.upper,f=Math.floor(l*Sm/s),g=Math.max(1,Sm/s);e.fillRect(f+bm,c,g,u+1-c)}}function qC(i,e){qi(i,e.length+1)}function YC(i){const e=i.value;qi(i),i.parentElement.dataset.isEmpty=e===""?"true":"false"}class lp extends K{constructor(e,t,{copyButton:n=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new ue,this.dimensionWidgetList=[],this.dragSource=void 0;const r=this.element,s=this.dimensionContainer;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(wt(()=>this.updateDimensions())))),r.className="neuroglancer-position-widget",s.style.display="contents",r.appendChild(s),n){const l=dr({title:"Copy position to clipboard",onClick:()=>{const c=on(this.getPositionText());tt.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(gu,se({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,r.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(wt(()=>this.updateView()))));const o=this.registerDisposer(new $n(r,ZC));o.allShortcutsAreGlobal=!0,this.registerDisposer(new Zr(r,ZC)),this.registerDisposer(Se(r,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();const c=l.target;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");const n=document.createElement("canvas"),r=n.getContext("2d"),s=document.createElement("div"),o=document.createElement("div");o.appendChild(s);const l=document.createTextNode("");s.appendChild(l);const c=document.createElement("div"),u=document.createElement("div");o.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),u.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(o),t.appendChild(c),t.appendChild(u),t.appendChild(n);const f=100;n.width=eg,n.height=f,c.style.marginTop=`${f-1}px`;let g,v,y;const C=()=>{const M=this.dimensionWidgetList.indexOf(e);if(M===-1)return;const R=e.coordinateSpace,D=YG(R,M,f);if(D===void 0||R.bounds.lowerBounds[M]+1===R.bounds.upperBounds[M]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";const T=D.lowerBound,A=D.upperBound;g=T,v=A,l.textContent=T.toString(),c.textContent=A.toString(),XG(n,r,D);const V=this.position.value[M];if(V>=T&&V<=A&&(r.fillStyle="#f66",r.fillRect(0,ym(V,T,A,f),eg,1)),y!==void 0&&y>=T&&y<=A){r.fillStyle="#66f";const O=ym(y,T,A,f);r.fillRect(0,O,eg,1),u.textContent=y.toString();const _=s.clientHeight;s.style.visibility=O>_?"":"hidden",c.style.visibility=O<f-_?"":"hidden",u.style.display="",u.style.visibility="visible",u.style.marginTop=`${O}px`}else s.style.visibility="",u.style.display="none",c.style.visibility=""},w=e.dropdownOwner,S=w.registerCancellable(wt(C));w.registerDisposer(this.position.changed.add(S));const L=M=>{if(g===void 0||v===void 0)return;const R=n.getBoundingClientRect();let D=(M.clientY-R.top)/R.height;return D=Math.max(0,D),D=Math.min(1,D),Math.round(D*(v-g))+g},I=M=>{const R=this.dimensionWidgetList.indexOf(e);if(R===-1)return;const D=L(M);if(D===void 0)return;const T=this.position,A=T.value;A[R]=D+.5,e.modified=!1,T.value=A};n.addEventListener("pointermove",M=>{y=L(M),S()}),n.addEventListener("pointerleave",()=>{y=void 0,S()}),n.addEventListener("pointerdown",M=>{M.preventDefault(),M.stopPropagation(),!(M.ctrlKey||M.altKey||M.shiftKey||M.metaKey)&&(zn(M,R=>{e.dropdownOwner!==void 0&&(y=void 0,I(R),S(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),I(M))}),C()}openCoordinateArrayDropdown(e,t,n){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");const r=n.coordinates,s=n.labels,o=r.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let l=0;l<o;++l){const c=document.createElement("div");c.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");const u=document.createElement("div");u.classList.add("neuroglancer-dimension-dropdown-coordinate");const f=document.createElement("div");f.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),f.textContent=s[l],u.textContent=r[l].toString(),c.appendChild(u),c.appendChild(f),c.addEventListener("click",()=>{const g=this.dimensionWidgetList.indexOf(e);if(g===-1)return;const v=this.position,y=v.value;y[g]=r[l]+.5,e.modified=!1,v.value=y}),t.appendChild(c)}}openDropdown(e){if(e.dropdownOwner!==void 0)return;const t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();const n=e.dropdownOwner=new K,r=document.createElement("div");r.draggable=!0,r.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),r.addEventListener("pointerenter",()=>{e.hasFocus=!0}),r.tabIndex=-1,e.container.appendChild(r);const s=mu(e.coordinateSpace,t);s==null?this.openRegularDropdown(e,r):this.openCoordinateArrayDropdown(e,r,s),this.widgetWithOpenDropdown=e,n.registerDisposer(()=>{Bt(r),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),n.registerEventListener(document,"pointerdown",o=>{const l=o.target;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;const t=e.dropdownOwner;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();const n=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(n===null)break;if(n[1]!==void 0&&document.execCommand("insertText",void 0,n[1]),n[2]!==void 0){const r=this.dimensionWidgetList,s=r.indexOf(e);if(s===-1||s+1===r.length)break;const o=t.substring(n[0].length);e=r[s+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;const n=this.position.coordinateSpace;n.value=_E(n.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){const n=new qG(e,t);n.container.addEventListener("dragstart",r=>{this.dragSource=n,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),n.container.addEventListener("dragenter",r=>{const s=this.dragSource;if(s===void 0||s===n)return;const o=this.dimensionWidgetList,l=o.indexOf(s),c=o.indexOf(n);l===-1||c===-1||(r.preventDefault(),this.reorderDimensionTo(c,l))}),n.container.addEventListener("dragend",r=>{this.dragSource===n&&(this.dragSource=void 0)}),n.nameContainer.addEventListener("dblclick",()=>{n.nameElement.disabled=!1,n.nameElement.focus(),n.nameElement.select()}),n.scaleContainer.addEventListener("dblclick",()=>{n.scaleElement.disabled=!1,n.scaleElement.focus(),n.scaleElement.select()}),n.coordinate.addEventListener("focus",()=>{n.coordinate.select()}),n.container.addEventListener("focusin",()=>{n.hasFocus=!0,this.updateDropdownVisibility(n)}),n.container.addEventListener("focusout",r=>{const s=r.relatedTarget;s instanceof Node&&n.container.contains(s)||(n.hasFocus=!1,this.updateDropdownVisibility(n))}),n.container.addEventListener("click",r=>{(!(r.target instanceof HTMLInputElement)||r.target.disabled)&&n.coordinate.focus()}),n.coordinate.addEventListener("paste",r=>{const s=n.coordinate,o=s.value,l=r.clipboardData;if(l===null)return;let c=l.getData("text"),u=s.selectionEnd,f=s.selectionStart;if(f!==0||u!==o.length){f==null&&(f=0),u==null&&(u=0);const g=c.match(/[^\-0-9\.]/);g!==null&&(c=c.substring(0,g.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(n,c);r.preventDefault(),r.stopPropagation()}),n.coordinate.addEventListener("input",()=>{n.modified=!0;const r=n.coordinate,s=r.value;let o=r.selectionDirection,l=r.selectionEnd,c=r.selectionStart;c===null&&(c=0),l===null&&(l=c);let u="";const f=/[^\-0-9\.]/g;u+=s.substring(0,c).replace(f,"");const g=u.length;u+=s.substring(c,l).replace(f,"");const v=u.length;u+=s.substring(l).replace(f,""),r.value=u,r.selectionStart=g,r.selectionEnd=v,r.selectionDirection=o,qC(r,u),l===c&&l===s.length&&s.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(n,1)}),n.nameElement.addEventListener("input",()=>{const r=n.nameElement;qi(r),this.updateNameValidity()}),n.scaleElement.addEventListener("input",()=>{const r=n.scaleElement;YC(r),this.updateScaleValidity(n)}),n.coordinate.addEventListener("blur",r=>{const s=r.relatedTarget;this.dimensionWidgetList.some(o=>o.coordinate===s)||n.modified&&this.updatePosition()}),n.nameElement.addEventListener("blur",r=>{n.nameElement.disabled=!0;const s=r.relatedTarget;this.dimensionWidgetList.some(o=>o.nameElement===s)||this.updateNames()||this.forceUpdateDimensions()}),n.scaleElement.addEventListener("blur",r=>{n.scaleElement.disabled=!0;const s=r.relatedTarget;this.dimensionWidgetList.some(o=>o.scaleElement===s)||this.updateScales()||this.forceUpdateDimensions()}),Se(n.container,"adjust-via-wheel",r=>{const s=r.detail.deltaY;s!==0&&this.adjustDimension(n,Ed(s))}),Se(n.container,"adjust-up",()=>{this.adjustDimension(n,-1)}),Se(n.container,"adjust-down",()=>{this.adjustDimension(n,1)});for(const r of ZG){const s=r(n);Se(s,"maybe-tab-forward",o=>{this.handleLeftRightMovement(o,n,1,r)}),Se(s,"maybe-tab-backward",o=>{this.handleLeftRightMovement(o,n,-1,r)}),Se(s,"tab-forward",()=>{this.selectAdjacentField(n,1,r)}),Se(s,"tab-backward",()=>{this.selectAdjacentField(n,-1,r)})}return Se(n.coordinate,"commit",()=>{this.updatePosition()}),Se(n.nameElement,"commit",()=>{this.updateNames()}),Se(n.scaleElement,"commit",()=>{this.updateScales()}),Se(n.coordinate,"delete-backward",r=>{r.stopPropagation();const s=n.coordinate;s.selectionStart===s.selectionEnd&&s.selectionStart===0&&(r.preventDefault(),this.selectAdjacentCoordinate(n,-1))}),n}forceUpdateDimensions(){let e=this.position.coordinateSpace.value;e.valid||(e=Ur),this.coordinateSpace=e;const t=this.dimensionWidgets,n=this.dimensionWidgetList;n.length=0;var r=e;const s=r.names,o=r.ids,l=r.scales,c=r.units;sr(this.dimensionContainer,o.map((f,g)=>{let v=t.get(f);v===void 0?(v=this.newDimension(e,g),t.set(f,v)):v.coordinateSpace=e;const y=s[g];v.nameElement.value=y,delete v.nameElement.dataset.isValid,qi(v.nameElement);const C=mu(e,g);C===void 0?v.container.dataset.coordinateArray="none":C===null?v.container.dataset.coordinateArray="invalid":v.container.dataset.coordinateArray="valid",v.scaleContainer.title="Drag to reorder, double click to change scale",C===null&&(v.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");var w=EE(l[g],c[g]);const S=w.scale,L=w.prefix,I=w.unit,M=`${S}${L}${I}`;return v.scaleElement.value=M,delete v.scaleElement.dataset.isValid,YC(v.scaleElement),n.push(v),v.container}));for(const f of t){var u=oe(f,2);const g=u[0],v=u[1];v.coordinateSpace!==e&&(this.closeDropdown(v),t.delete(g))}}updateDimensions(){this.position.coordinateSpace.value!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,n){const r=this.dimensionWidgetList;let s=r.indexOf(e);if(s!==-1)for(;;){if(s+=t,s<0||s>=r.length)return!1;const o=r[s],l=n(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,n=>n.coordinate)}handleLeftRightMovement(e,t,n,r){e.stopPropagation();const s=r(t);s.selectionStart!==s.selectionEnd||s.selectionStart!==(n===1?s.value.length:0)||this.selectAdjacentField(t,n,r)&&e.preventDefault()}updateNameValidity(){const e=this.dimensionWidgetList,t=e.map(s=>s.nameElement.value),n=t.length,r=this.combiner.getRenameValidity(t);for(let s=0;s<n;++s)e[s].nameElement.dataset.isValid=r[s]===!1?"false":"true"}updateScaleValidity(e){const t=fd(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){const n=this.dimensionWidgetList.indexOf(e);if(n===-1)return;this.updatePosition();const r=this.position;if(!r.valid)return;const s=r.coordinateSpace.value.bounds,o=Float32Array.from(r.value);let l=Math.floor(o[n]+t);if(t>0){const c=s.upperBounds[n];kt(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{const c=s.lowerBounds[n];kt(c)&&(l=Math.max(l,Math.floor(c)))}o[n]=l+.5,this.position.value=o,this.updateView()}updatePosition(){const e=this.dimensionWidgetList,t=this.position,n=t.value;if(n===void 0)return;const r=e.length;for(let s=0;s<r;++s){const o=e[s];o.modified=!1;const l=Number(o.coordinate.value);kt(l)&&(n[s]=l+($i(l)?.5:0))}t.value=n}updateNames(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,n=t.value,r=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(r).includes(!1))return!1;const s=n.names;if(_e(s,r))return!1;const o=n.timestamps.map((c,u)=>s[u]===r[u]?c:Date.now()),l=j(j({},n),{names:r,timestamps:o});return t.value=l,!0}updateScales(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,n=t.value,r=e.map(g=>fd(g.scaleElement.value));if(r.includes(void 0))return!1;const s=Float64Array.from(r,g=>g.scale),o=Te(r,g=>g.unit),l=n.scales,c=n.units;if(_e(l,s)&&_e(c,o))return!1;const u=n.timestamps.map((g,v)=>s[v]===l[v]&&o[v]===c[v]?g:Date.now()),f=mt({valid:n.valid,rank:n.rank,scales:s,units:o,timestamps:u,ids:n.ids,names:n.names,boundingBoxes:n.boundingBoxes,coordinateArrays:n.coordinateArrays});return t.value=f,!0}getPositionText(){const e=this.position;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();const e=this.position.value,t=this.dimensionWidgetList,n=t.length;if(e===void 0)return;const r=this.coordinateSpace;for(let s=0;s<n;++s){const o=t[s],l=o.coordinate,c=Math.floor(e[s]),u=c.toString();qC(l,u),l.value=u;const f=mu(r,s);let g="";if(f!=null){const y=f.coordinates,C=u2(y,c,(w,S)=>w-S);C!==y.length&&(g=f.labels[C])}const v=o.coordinateLabel;v.textContent=g}}disposed(){this.closeDropdown(),Bt(this.element),super.disposed()}}class QG extends K{constructor(e,t,n){super(),this.element=e,this.mouseState=t,this.coordinateSpace=n,this.tempPosition=Ne(),e.className="neuroglancer-mouse-position-widget";const r=this.registerCancellable(wt(()=>this.updateView()));this.registerDisposer(t.changed.add(r)),this.registerDisposer(n.changed.add(r))}updateView(){let e="";const t=this.mouseState,n=this.coordinateSpace.value;if(t.active&&n!==void 0){const r=t.position,s=n.rank,o=n.names;for(let l=0;l<s;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(r[l])}`}this.element.textContent=e}disposed(){Bt(this.element),super.disposed()}}class e4 extends K{constructor(e,t){var n;super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";const r=this.element,s=this.labelElement,o=this.layerNumberElement,l=this.valueElement,c=this.visibleProgress,u=this.prefetchProgress,f=this.labelElementText;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(c),r.appendChild(u),s.className="neuroglancer-layer-item-label",s.appendChild(f),c.className="neuroglancer-layer-item-visible-progress",u.className="neuroglancer-layer-item-prefetch-progress",o.className="neuroglancer-layer-item-number",l.className="neuroglancer-layer-item-value";const g=document.createElement("div");g.className="neuroglancer-layer-item-value-container";const v=document.createElement("div");v.className="neuroglancer-layer-item-button-container";const y=fy();y.title="Remove layer from this layer group";const C=HF();C.title="Refresh data",this.registerEventListener(C,"click",L=>{L.stopPropagation();const I=this.layer.layer;if(I&&I.dataSources&&I.dataSources[0].loadState){const M=I.dataSources[0].loadState;if(M instanceof ay){const R=M.dataSource;if(R&&R.subsources[0]&&R.subsources[0].subsource){const D=R.subsources[0].subsource.annotation;D!=null&&D.invalidateCache&&D.invalidateCache()}}}}),y.addEventListener("click",L=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),L.stopPropagation()});const w=Ss();w.title="Delete this layer",w.addEventListener("click",L=>{ll(this.layer),L.stopPropagation()}),r.appendChild(o),g.appendChild(l),g.appendChild(v),v.appendChild(y),v.appendChild(w),r.appendChild(s),!((n=e.layer)===null||n===void 0)&&n.allowingRefresh&&r.appendChild(C),r.appendChild(g);const S=this.registerDisposer(new lp(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(S.element),S.element.addEventListener("click",L=>{L.stopPropagation()}),S.element.addEventListener("dblclick",L=>{L.stopPropagation()}),r.addEventListener("click",L=>{L.ctrlKey?t.selectedLayer.toggle(e):L.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),r.addEventListener("contextmenu",L=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,L.stopPropagation(),L.preventDefault()}),NI(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),op(this.panel,r,this.layer)}update(){const e=this.layer,t=this.element;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let n=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(n+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),n+=", drag to move, shift+drag to copy",t.title=n}disposed(){this.element.remove(),super.disposed()}}class t4 extends K{constructor(e,t,n,r,s,o){super(),this.display=e,this.manager=t,this.viewerNavigationState=n,this.selectedLayer=r,this.getLayoutSpecForDrag=s,this.showLayerHoverValues=o,this.layerWidgets=new ue,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.positionWidget=this.registerDisposer(new lp(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner)),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable(wt(()=>this.update())),this.registerDisposer(r);const l=this.element;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(r.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=Lt({svg:ju,title:"Click to add layer, control+click/right click/⌘+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let u=this.dropZone=document.createElement("div");u.className="neuroglancer-layer-panel-drop-zone";const f=v=>{if(v.ctrlKey||v.metaKey||v.type==="contextmenu"){const y=YI(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(y),this.selectedLayer.layer=y,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",f),this.registerEventListener(c,"contextmenu",f),l.appendChild(c),l.appendChild(u),this.registerDisposer(zG(c)),l.appendChild(this.positionWidget.element);const g=()=>{const v=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=v===zt.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(g)),g(),this.update(),this.updateChunkStatistics(),VI(this),op(this,u,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(wt(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,Bt(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let n of this.layerWidgets){var t=oe(n,2);let r=t[0],s=t[1],o=r.layer,l="";if(o!==null){let c=e.get(o);if(c!==void 0){const u=c.value;u!==void 0&&(l=""+u)}}if(l!==s.prevValueText){if(s.prevValueText=l,l.length>s.maxLength){const c=s.maxLength=l.length;s.valueElement.style.width=`${c}ch`}s.valueElement.textContent=l}}}updateChunkStatistics(){for(const t of this.layerWidgets){var e=oe(t,2);const n=e[0],r=e[1];let s=0,o=0,l=0,c=0;const u=n.layer;if(u!==null)for(const f of u.renderLayers){const g=f.layerChunkProgressInfo;s+=g.numVisibleChunksNeeded,o+=g.numVisibleChunksAvailable,l+=g.numPrefetchChunksNeeded,c+=g.numPrefetchChunksAvailable}r.visibleProgress.style.width=`${o/Math.max(1,s)*100}%`,r.prefetchProgress.style.width=`${c/Math.max(1,l)*100}%`}}updateLayers(){var e;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let t=this.element,n=new je,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(const l of this.manager.layerManager.managedLayers){if(l.archived&&!(!((e=this.dropLayers)===null||e===void 0)&&e.layers.has(l)))continue;n.add(l);let c=this.layerWidgets.get(l);const u=l.nonArchivedLayerIndex;c===void 0&&(c=new e4(l,this),this.layerWidgets.set(l,c)),c.layerNumberElement.textContent=""+(1+u),c.update();var s=c;let f=s.element;f!==r&&t.insertBefore(c.element,r),r=f.nextElementSibling}for(let l of this.layerWidgets){var o=oe(l,2);let c=o[0],u=o[1];n.has(c)||(this.layerWidgets.delete(c),u.dispose())}}addLayerMenu(){nT(this.manager,this.selectedLayer)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function OI(i,e){const t=Bn(i,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(gu)!==-1){o.stopPropagation();const l=ge(JSON.parse(o.dataTransfer.getData(gu))),c=Y(l,"dimensions",Nv),u=Y(l,"position",y=>He(y,Tt));if(u.length!==c.length)throw new Error("length mismatch between position and dimensions");const f=u.length,g=e.coordinateSpace.value.names,v=e.value;for(let y=0;y<f;++y){const C=g.indexOf(c[y]);C!==-1&&(v[C]=u[y])}e.changed.dispatch()}}),n=o=>{o.dataTransfer.types.indexOf(gu)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},r=Bn(i,"dragenter",n),s=Bn(i,"dragover",n);return()=>{r(),s(),t()}}class BI extends K{constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new ue;const t=this.element,n=this.valueIndexMap;let r=0;for(const s of di(e.enumType))if(isNaN(Number(s))){const o=document.createElement("option");o.textContent=o.value=s.toLowerCase(),t.appendChild(o),n.set(e.enumType[s],r),++r}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",s=>{s.preventDefault(),s.stopPropagation(),this.adjustViaWheel(s)}),this.updateView()}adjustViaWheel(e){const t=this.element;let n=e.deltaY;n>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):n<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){const e=this.element;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}const Py="neuroglancer-layer-group-viewer";function KC(i){return i.dataTransfer.types.indexOf(Py)!==-1}let Xn;function i4(i){if(Xn&&Xn.viewer.layerSpecification.rootLayers===i.rootLayers)return Xn.viewer}function n4(i,e){const t=i4(e);let n,r=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?n="copy":(r=!0,n="move"),MI(i,n,r)}class r4 extends K{constructor(e){super(),this.relativeDisplayScales=new X3(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new eF(e.navigationState.pose.displayDimensions.addRef()),this.position=new bk(e.navigationState.position.addRef()),this.crossSectionOrientation=new tm(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new wk(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new im(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new Kw(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new Kw(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Bo(new Oo(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new tm(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new im(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Bo(new Oo(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(const e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",Ld(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}function s4(i,e){const t=new VG(i),n=t.element;n.classList.add("neuroglancer-layer-group-viewer-context-menu");const r=document.createElement("button");r.textContent="Remove layer group",n.appendChild(r),t.registerEventListener(r,"click",()=>{e.layerSpecification.layerManager.clear()});const s=e.viewerNavigationState;for(const l of[["Render scale factors",s.relativeDisplayScales.link],["Render dimensions",s.displayDimensions.link],["Position",s.position.link],["Cross-section orientation",s.crossSectionOrientation.link],["Cross-section zoom",s.crossSectionScale.link],["Cross-section depth range",s.crossSectionDepthRange.link],["3-D projection orientation",s.projectionOrientation.link],["3-D projection zoom",s.projectionScale.link],["3-D projection depth range",s.projectionDepthRange.link]]){var o=oe(l,2);const c=o[0],u=o[1],f=t.registerDisposer(new BI(u)),g=document.createElement("label");g.style.display="flex",g.style.flexDirection="row",g.style.whiteSpace="nowrap",g.textContent=c,g.appendChild(f.element),n.appendChild(g)}return t}class Ku extends K{constructor(e,t,n={}){super(),this.element=e,this.viewerState=t,this.state=new Gh,this.options=j({showLayerPanel:new Qt(!0),showViewerMenu:!1,showLayerHoverValues:new Qt(!0)},n),this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new r4(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof XI?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(r=>r.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new np(e)),this.layout=this.registerDisposer(new mG(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(OI(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable(ct(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(Se(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return j({type:"viewer"},this.state.toJSON())}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),Li(e,"crossSectionZoom",Ld(this.viewerNavigationState.crossSectionScale)),Li(e,"perspectiveZoom",Ld(this.viewerNavigationState.projectionScale)),Li(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){const e=this.options,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){const n=this.layerPanel=new t4(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(n.registerDisposer(s4(n.element,this)),n.element.title="Right click for options, drag to move/copy layer group."):n.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS<"u"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{const s=document.createElement("button");s.textContent="Clear segments",s.title='De-select all objects ("x")',s.addEventListener("click",o=>{Rk(o,o,{action:"clear-segments"})}),n.element.appendChild(s)}for(const s of["3d","xy","xz","yz"]){const o=document.createElement("button");o.textContent=s,o.title=`Switch to ${s} layout`,o.addEventListener("click",()=>{let l;this.layout.name===s?s!=="3d"?l=`${s}-3d`:l="4panel":l=s,this.layout.name=l}),n.element.appendChild(o)}}n.element.draggable=!0;const r=n.element;r.addEventListener("dragstart",s=>{ar(n.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),PI(s,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});const o=()=>{Xn&&Xn.viewer===this&&(Xn=void 0),this.unregisterDisposer(o)};Xn={viewer:this,disposer:o},this.registerDisposer(o);const l=this.toJSON();delete l.layers,s.dataTransfer.setData(Py,se(l)),n.element.style.backgroundColor="black",setTimeout(()=>{n.element.style.backgroundColor=""},0)}),n.element.addEventListener("dragend",()=>{ki(r,"drag"),ap(),Xn!==void 0&&Xn.viewer===this&&Xn.disposer()}),this.element.insertBefore(r,this.element.firstChild)}}disposed(){nt(this.element);const e=this.layerPanel;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}const XC=ln("layoutComponentContainer");class vu extends K{constructor(e,t,n){super(),this.viewer=e,this.parent=n,this.changed=new xe,this.element=document.createElement("div");const r=this.element;r.style.display="flex",r.style.flex="1",r.style.position="relative",r.style.alignItems="stretch",r[XC]=this,this.setSpecification(t);const s=[],o=c=>{const u=document.createElement("div");u.className="neuroglancer-layout-split-drop-zone";let f;switch(u.style[c]="0",c){case"left":case"right":f="row",u.style.width="10px",u.style.height="100%";break;case"top":case"bottom":f="column",u.style.height="10px",u.style.width="100%";break}u.style.display="none",s.push({element:u,direction:f,orientation:c}),r.appendChild(u),FI(u,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,f==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;r.addEventListener("dragenter",c=>{if(!l&&Yu(c)!==void 0){l=!0;for(const u of s){const f=u.element,g=u.direction,v=u.orientation;if(n!==void 0&&g===n.direction&&((v==="left"||v==="top")&&n.get(0)!==this||(v==="bottom"||v==="right")&&n.get(n.length-1)!==this))continue;const y=this.component;y instanceof Cm&&y.direction===g||(f.style.display="block")}}},!0),r.addEventListener("drop",c=>{if(l){l=!1;for(const u of s){const f=u.element;f.style.display="none"}}},!0),r.addEventListener("dragleave",c=>{const u=c.relatedTarget;if(l&&!(u instanceof HTMLElement&&this.element.contains(u))){l=!1;for(const f of s){const g=f.element;g.style.display="none"}}},!0)}unsetComponent(){const e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Ku){const t=e.layerManager,n=e.registerCancellable(ct(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&n()})),n()}else if(e instanceof Cm){const t=e.registerCancellable(ct(()=>{const n=e.length;if(n===0&&this.parent!==void 0)this.dispose();else if(n===1){const r=e.get(0).component;let s;if(this.parent===void 0&&r instanceof Ku){s=r.layout.specification.toJSON(),r.viewerNavigationState.copyToParent();const o=r.layerManager.managedLayers,l=new je(o),c=r.layerSpecification;c.rootLayers.filter(g=>l.has(g)||g.archived);const u=[],f=c.rootLayers.managedLayers;for(let g=0,v=f.length;g<v;++g)l.has(f[g])&&u.push(g);for(let g=0,v=o.length;g<v;++g)f[u[g]]=o[g];c.rootLayers.layersChanged.dispatch()}else s=r.toJSON();this.setSpecification(s)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(a4(this,e))}static getFromElement(e){return e[XC]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){const t={type:"viewer"},n=this.parent;if(n!==void 0){if(e==="left"&&n.direction==="row"||e==="top"&&n.direction==="column")return{newContainer:n.insertChild(t,this),existingContainer:this};if(e==="right"&&n.direction==="row"||e==="bottom"&&n.direction==="column")return{newContainer:n.insertChild(t),existingContainer:this}}let r;const s=this.component;s instanceof wm?r=s.layerGroupViewer.toJSON():r=s.toJSON();let o,l;const c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,r]},l=0;break;case"right":case"bottom":o={type:c,children:[r,t]},l=1;break}this.setSpecification(o);const u=this.component;return{newContainer:u.get(l),existingContainer:u.get(1-l)}}}function _I(i){return{mouseState:i.mouseState,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,showScaleBar:i.showScaleBar,scaleBarOptions:i.scaleBarOptions,showPerspectiveSliceViews:i.showPerspectiveSliceViews,inputEventBindings:i.inputEventBindings,visibility:i.visibility,selectedLayer:i.selectedLayer,visibleLayerRoles:i.visibleLayerRoles,navigationState:i.navigationState.addRef(),perspectiveNavigationState:i.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor}}class wm extends K{constructor(e,t,n){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new Ku(e,j({display:n.display,layerSpecification:n.layerSpecification.addRef()},_I(n)),{showLayerPanel:n.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:n.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function FI(i,e,t,n){i.addEventListener("dragenter",r=>{Yu(r)!==void 0&&i.classList.add("neuroglancer-drag-over")}),i.addEventListener("dragleave",()=>{ki(i,"drop"),i.classList.remove("neuroglancer-drag-over")}),i.addEventListener("dragover",r=>{const s=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),ar(i,"drop",l),r.stopPropagation(),r.preventDefault()};if(KC(r)){const o=n4(r,e);Dy(r,o.dropEffect),s(o,`Drop to ${o.dropEffect} layer group as new ${n}`);return}if(Yu(r)!==void 0){const o=GG(r,e,!1,!0);s(o,`Drop to ${o.dropEffect} layer as new ${n}`);return}}),i.addEventListener("drop",r=>{i.classList.remove("neuroglancer-drag-over"),ki(i,"drop");let s,o;if(KC(r)){r.stopPropagation();try{o=JSON.parse(r.dataTransfer.getData(Py))}catch{return}if(s=mm(r,e,{forceCopy:!1,newTarget:!0}),s===void 0)return}else{if(s=mm(r,e,{forceCopy:gm()==="copy",newTarget:!0}),s===void 0)return;o=s.layoutSpec}if(!s.initializeExternalLayers(r)){if(!s.moveSupported)for(const u of s.layers.keys())u.dispose();return}r.preventDefault();const l=r.dataTransfer.dropEffect=gm();ap(l);const c=t();s.updateArchiveStates(r);for(const u of s.layers.keys())c.layerSpecification.add(u);try{c.restoreState(o)}catch{c.layout.reset()}})}class Cm extends K{constructor(e,t,n,r){super(),this.element=e,this.direction=t,this.container=r,this.changed=new xe,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(const s of n)this.insertChild(s)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){const t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",FI(t,this.viewer.layerSpecification,()=>{const n=t.nextElementSibling;let r;return n!==null&&(r=vu.getFromElement(n)),this.insertChild({type:"viewer",layers:[]},r).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{Bt(t)}),t}get viewer(){return this.container.viewer}get(e){return vu.getFromElement(this.element.children[e*2+1])}insertChild(e,t){const n=new vu(this.viewer,e,this),r=this.makeDropPlaceholder(n);n.element.classList.add("neuroglancer-stack-layout-child"),n.registerDisposer(n.changed.add(this.changed.dispatch)),n.registerDisposer(()=>{this.element.removeChild(n.element),this.changed.dispatch()});const s=t!==void 0?t.element:null;return this.element.insertBefore(n.element,s),this.element.insertBefore(r,s),this.changed.dispatch(),n}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Wi](){const e=this.length;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Te(this).map(e=>e.toJSON())}}}function a4(i,e){const t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(i.parent!==void 0)throw new Error(`Invalid layout component specification: ${se(e)}`);return new wm(t,e,i.viewer)}ge(e);const n=Y(e,"type",Ie);switch(n){case"row":case"column":return new Cm(t,n,Y(e,"children",r=>{const s=He(r,o=>o);if(i.parent===void 0&&s.length===0)throw new Error("Stack layout requires at least one child.");return s}),i);case"viewer":{const r=i.viewer,s=new XI(r.layerSpecification.addRef()),o=new Ku(t,j({display:r.display,layerSpecification:s},_I(r)),{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new wm(t,e,i.viewer)}}class o4 extends K{constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new vu(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let xm=0;const l4=vt.fromObject({escape:{action:"close"}});class dp extends K{constructor(){super(),this.keyMap=new vt,this.keyMap.addParent(l4,Number.NEGATIVE_INFINITY),++xm;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new np(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new $n(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--xm,document.body.removeChild(this.container),super.disposed()}}const d4="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImV5ZUNyb3NzZWRJY29uVGl0bGUiPgoJPHRpdGxlIGlkPSJleWVDcm9zc2VkSWNvblRpdGxlIj5IaWRkZW4gKGNyb3NzZWQgZXllKTwvdGl0bGU+Cgk8cGF0aCBkPSJNMjIgMTJDMjIgMTIgMTkgMTggMTIgMThDNSAxOCAyIDEyIDIgMTJDMiAxMiA1IDYgMTIgNkMxOSA2IDIyIDEyIDIyIDEyWiIvPgoJPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIvPgoJPHBhdGggZD0iTTMgMjFMMjAgNCIvPgo8L3N2Zz4=",c4="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImV5ZUljb25UaXRsZSI+Cgk8dGl0bGUgaWQ9ImV5ZUljb25UaXRsZSI+VmlzaWJsZSAoZXllKTwvdGl0bGU+Cgk8cGF0aCBkPSJNMjIgMTJDMjIgMTIgMTkgMTggMTIgMThDNSAxOCAyIDEyIDIgMTJDMiAxMiA1IDYgMTIgNkMxOSA2IDIyIDEyIDIyIDEyWiIvPgoJPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIvPgo8L3N2Zz4=",u4="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iY3Vyc29ySWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iY3Vyc29ySWNvblRpdGxlIj5DdXJzb3I8L3RpdGxlPiAgICAKICAgIDxwb2x5Z29uIHBvaW50cz0iNyAyMCA3IDQgMTkgMTYgMTIgMTYgNyAyMSIvPgo8L3N2Zz4=",h4=vt.fromObject({escape:{action:"cancel"}});class UI extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("input");const t=this.element;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";const n=this.registerDisposer(new $n(t,h4));n.allShortcutsAreGlobal=!0,Se(t,"cancel",r=>{this.updateView(),t.blur(),r.stopPropagation(),r.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){tT(this.layer,this.element.value)}}class p4 extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");const t=this.element,n=this.measureElement;t.classList.add("neuroglancer-layer-side-panel-type"),n.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(n);for(const s of Qu){var r=oe(s,2);const o=r[0],l=r[1];if(l.type!==o)continue;const c=document.createElement("option");c.textContent=l.typeAbbreviation,c.value=o,t.appendChild(c)}t.addEventListener("change",()=>{const s=t.value,o=Qu.get(s);Oy(this.layer.managedLayer,o)}),this.updateView()}updateView(){const e=this.layer.type,t=this.element,n=this.measureElement;n.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${n.offsetWidth}px`}disposed(){this.measureElement.remove()}}class Xu extends wa{constructor(e,t){super(e,t.location),this.panelState=t;const n=this.layer=t.layer,r=this.element;var s=this.addTitleBar({});const o=s.titleBar;o.classList.add("neuroglancer-layer-side-panel-title"),o.appendChild(this.registerDisposer(new p4(n)).element),o.appendChild(this.registerDisposer(new UI(n.managedLayer)).element),this.registerDisposer(Or(u=>{r.dataset.neuroglancerLayerVisible=u.toString()},{get value(){return n.managedLayer.visible},changed:n.managedLayer.layerChanged}));const l=this.registerDisposer(new er({get value(){return n.managedLayer.pickEnabled},set value(u){n.managedLayer.pickEnabled=u},changed:n.managedLayer.layerChanged},{svg:u4,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new pn({get value(){return n.managedLayer.supportsPickOption},changed:n.managedLayer.layerChanged},l.element)),o.appendChild(l.element);const c={get value(){return t!==n.panels.panels[0]},set value(u){u?t.pin():t.unpin()},changed:n.manager.root.layerManager.layersChanged};o.appendChild(this.registerDisposer(new er(c,{text:"📌︎",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Or(u=>{r.dataset.neuroglancerLayerPanelPinned=u.toString()},c)),o.appendChild(Ss({title:"Delete layer",onClick:()=>{ll(this.layer.managedLayer)}})),this.tabView=new YU({makeTab:u=>n.tabs.options.get(u).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new V1({get value(){return t.tabs.map(u=>({id:u,label:n.tabs.options.get(u).label}))},changed:t.tabsChanged})),handleTabElement:(u,f)=>{f.draggable=!0,f.addEventListener("dragstart",g=>{g.stopPropagation(),g.dataTransfer.setData("neuroglancer-side-panel","");let v="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(y=>y!==t&&y.location.visible)&&(v+=`, or move tab to other ${se(n.managedLayer.name)} panel`),ar(f,"drag",v),this.sidePanelManager.startDrag({dropAsNewPanel:y=>{this.panelState.splitOffTab(u,j(j({},sI),y))},canDropAsTabs:y=>y instanceof Xu&&y.layer===this.layer&&y!==this?1:0,dropAsTab:y=>{this.panelState.moveTabTo(u,y.panelState)}},g)}),f.addEventListener("dragend",g=>{ki(f,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return j(j({},super.makeDragSource()),{canDropAsTabs:e=>e instanceof Xu&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}})}makeTabDropZone(){const e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var n;const r=this.sidePanelManager.dragSource,s=(n=r==null?void 0:r.canDropAsTabs)===null||n===void 0?void 0:n.call(r,this);s&&(e.classList.add(bo),ar(e,"drop",`Move ${s} ${s===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{ki(e,"drop"),e.classList.remove(bo)}),e.addEventListener("dragover",t=>{var n;const r=this.sidePanelManager.dragSource;!((n=r==null?void 0:r.canDropAsTabs)===null||n===void 0)&&n.call(r,this)&&t.preventDefault()}),e.addEventListener("drop",t=>{var n;ki(e,"drop");const r=this.sidePanelManager.dragSource;!((n=r==null?void 0:r.canDropAsTabs)===null||n===void 0)&&n.call(r,this)&&(e.classList.remove(bo),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class f4 extends K{constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new ue,this.generation=0,this.layersNeedUpdate=!0;const n=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(n)),this.registerDisposer(t.layerManager.layersChanged.add(n)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)===null||e===void 0?void 0:e.layer)!==null&&t!==void 0?t:void 0}update(){var e;if(!this.layersNeedUpdate)return;const t=this.selectedLayerState.layerManager;let n=++this.generation;this.layersNeedUpdate=!1;const r=this.layerSidePanels,s=l=>{let c=r.get(l);c===void 0?(c={generation:n,unregister:this.sidePanelManager.registerPanel({location:l.location,makePanel:()=>new Xu(this.sidePanelManager,l)})},r.set(l,c)):c.generation=n};{const l=this.getSelectedUserLayer(),c=this.selectedLayerState.location;if(l===void 0||!c.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:c,makePanel:()=>new wa(this.sidePanelManager,c)}));else{(e=this.placeholderSelectedLayerPanel)===null||e===void 0||e.call(this),this.placeholderSelectedLayerPanel=void 0;const u=l.panels.panels[0];u.location.value=c.value,s(u)}}for(const l of t.managedLayers){const c=l.layer;if(c===null)continue;const u=c.panels.panels;for(let f=1,g=u.length;f<g;++f)s(u[f])}for(const l of r){var o=oe(l,2);const c=o[0],u=o[1];u.generation!==n&&(u.unregister(),r.delete(c))}}disposed(){var e;(e=this.placeholderSelectedLayerPanel)===null||e===void 0||e.call(this);for(const t of this.layerSidePanels.values()){const n=t.unregister;n()}}}const g4=j(j({},Sa),{side:"left",row:0});class m4{constructor(){this.location=new Rs(g4)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return va(this.location.toJSON())}}class v4 extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("div");const t=this.element,n=Lt({svg:c4,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),r=Lt({svg:d4,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(r),t.appendChild(n);const s=()=>{const o=this.layer.visible;n.style.display=o?"":"none",r.style.display=o?"none":""};s(),this.registerDisposer(e.layerChanged.add(s))}}function y4(i){const e=i.manager.root.selectedLayer,t=new er({get value(){return e.layer===i&&e.visible},set value(n){n?(e.layer=i,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:cI});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}class b4 extends K{constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;const n=this.element,r=this.numberElement;n.classList.add("neuroglancer-layer-list-panel-item"),r.classList.add("neuroglancer-layer-list-panel-item-number"),n.appendChild(this.registerDisposer(new As({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),n.appendChild(r),n.appendChild(this.registerDisposer(new v4(t)).element),n.appendChild(this.registerDisposer(new UI(t)).element),n.appendChild(this.registerDisposer(y4(t)).element);const s=Ss({title:"Delete layer",onClick:()=>{ll(this.layer)}});s.classList.add("neuroglancer-layer-list-panel-item-delete"),n.appendChild(s),NI(e,n,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),op(e,n,t,!0),n.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),n.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}}class S4 extends wa{constructor(e,t,n){super(e,n.location),this.manager=t,this.state=n,this.items=new ue,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;const r=this.itemContainer,s=this.layerDropZone;var o=this.addTitleBar({title:""});const l=o.titleElement;this.titleElement=l,r.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(r),s.style.flex="1";const c=this.registerCancellable(wt(()=>this.render()));this.visibility.changed.add(c),this.registerDisposer(this.layerManager.layersChanged.add(c)),this.registerDisposer(this.selectedLayer.changed.add(c)),VI(this),op(this,s,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){const e=this,t=this.selectedLayer.layer,n=++this.generation;let r=0,s=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){const u=e.items;let f=0;for(const y of e.layerManager.managedLayers)y.archived||++f;const g=`${(f+1).toString().length}ch`;for(const y of e.layerManager.managedLayers){y.visible?++r:y.archived?++o:++s;let C=u.get(y);C===void 0&&(C=e.registerDisposer(new b4(e,y)),u.set(y,C)),C.generation=n;const w=y.nonArchivedLayerIndex;C.numberElement.style.width=g,w===-1?C.numberElement.style.visibility="hidden":(C.numberElement.style.visibility="",C.numberElement.textContent=`${w+1}`),C.element.dataset.selected=(y===t).toString(),C.element.dataset.archived=y.archived.toString(),yield C.element}for(const y of u){var v=oe(y,2);const C=v[0],w=v[1];n!==w.generation&&(u.delete(C),e.unregisterDisposer(w),w.dispose())}yield e.layerDropZone}sr(this.itemContainer,l());let c="Layers";if(r||s||o){c+=" (";let u="";r+s&&(c+=`${r}/${s+r} visible`,u=", "),o&&(c+=`${u}${o} archived`),c+=")"}this.titleElement.textContent=c}}class w4 extends K{constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");const t=this.registerCancellable(wt(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0;const t=this.layerManager.managedLayers;for(const r of t)r.archived&&++e;const n=this.element;if(e!==0){const r=t.length;n.textContent=`${r-e}/${r}`}else n.textContent=""}}var QC={exports:{}},ex;function sl(){return ex||(ex=1,function(i,e){(function(t,n){i.exports=n()})(bM,function(){var t=navigator.userAgent,n=navigator.platform,r=/gecko\/\d/i.test(t),s=/MSIE \d/.test(t),o=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(t),l=/Edge\/(\d+)/.exec(t),c=s||o||l,u=c&&(s?document.documentMode||6:+(l||o)[1]),f=!l&&/WebKit\//.test(t),g=f&&/Qt\/\d+\.\d+/.test(t),v=!l&&/Chrome\/(\d+)/.exec(t),y=v&&+v[1],C=/Opera\//.test(t),w=/Apple Computer/.test(navigator.vendor),S=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(t),L=/PhantomJS/.test(t),I=w&&(/Mobile\/\w+/.test(t)||navigator.maxTouchPoints>2),M=/Android/.test(t),R=I||M||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(t),D=I||/Mac/.test(n),T=/\bCrOS\b/.test(t),A=/win/i.test(n),V=C&&t.match(/Version\/(\d*\.\d*)/);V&&(V=Number(V[1])),V&&V>=15&&(C=!1,f=!0);var O=D&&(g||C&&(V==null||V<12.11)),_=r||c&&u>=9;function H(a){return new RegExp("(^|\\s)"+a+"(?:$|\\s)\\s*")}var U=function(a,d){var p=a.className,h=H(d).exec(p);if(h){var m=p.slice(h.index+h[0].length);a.className=p.slice(0,h.index)+(m?h[1]+m:"")}};function B(a){for(var d=a.childNodes.length;d>0;--d)a.removeChild(a.firstChild);return a}function W(a,d){return B(a).appendChild(d)}function F(a,d,p,h){var m=document.createElement(a);if(p&&(m.className=p),h&&(m.style.cssText=h),typeof d=="string")m.appendChild(document.createTextNode(d));else if(d)for(var b=0;b<d.length;++b)m.appendChild(d[b]);return m}function le(a,d,p,h){var m=F(a,d,p,h);return m.setAttribute("role","presentation"),m}var de;document.createRange?de=function(a,d,p,h){var m=document.createRange();return m.setEnd(h||a,p),m.setStart(a,d),m}:de=function(a,d,p){var h=document.body.createTextRange();try{h.moveToElementText(a.parentNode)}catch{return h}return h.collapse(!0),h.moveEnd("character",p),h.moveStart("character",d),h};function Re(a,d){if(d.nodeType==3&&(d=d.parentNode),a.contains)return a.contains(d);do if(d.nodeType==11&&(d=d.host),d==a)return!0;while(d=d.parentNode)}function ce(a){var d=a.ownerDocument||a,p;try{p=a.activeElement}catch{p=d.body||null}for(;p&&p.shadowRoot&&p.shadowRoot.activeElement;)p=p.shadowRoot.activeElement;return p}function Le(a,d){var p=a.className;H(d).test(p)||(a.className+=(p?" ":"")+d)}function Be(a,d){for(var p=a.split(" "),h=0;h<p.length;h++)p[h]&&!H(p[h]).test(d)&&(d+=" "+p[h]);return d}var qe=function(a){a.select()};I?qe=function(a){a.selectionStart=0,a.selectionEnd=a.value.length}:c&&(qe=function(a){try{a.select()}catch{}});function Ze(a){return a.display.wrapper.ownerDocument}function it(a){return ot(a.display.wrapper)}function ot(a){return a.getRootNode?a.getRootNode():a.ownerDocument}function ze(a){return Ze(a).defaultView}function Pe(a){var d=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,d)}}function Ue(a,d,p){d||(d={});for(var h in a)a.hasOwnProperty(h)&&(p!==!1||!d.hasOwnProperty(h))&&(d[h]=a[h]);return d}function We(a,d,p,h,m){d==null&&(d=a.search(/[^\s\u00a0]/),d==-1&&(d=a.length));for(var b=h||0,x=m||0;;){var E=a.indexOf("	",b);if(E<0||E>=d)return x+(d-b);x+=E-b,x+=p-x%p,b=E+1}}var Ge=function(){this.id=null,this.f=null,this.time=0,this.handler=Pe(this.onTimeout,this)};Ge.prototype.onTimeout=function(a){a.id=0,a.time<=+new Date?a.f():setTimeout(a.handler,a.time-+new Date)},Ge.prototype.set=function(a,d){this.f=d;var p=+new Date+a;(!this.id||p<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,a),this.time=p)};function De(a,d){for(var p=0;p<a.length;++p)if(a[p]==d)return p;return-1}var St=50,dn={toString:function(){return"CodeMirror.Pass"}},ei={scroll:!1},X={origin:"*mouse"},ee={origin:"+move"};function ie(a,d,p){for(var h=0,m=0;;){var b=a.indexOf("	",h);b==-1&&(b=a.length);var x=b-h;if(b==a.length||m+x>=d)return h+Math.min(x,d-m);if(m+=b-h,m+=p-m%p,h=b+1,m>=d)return h}}var fe=[""];function Ee(a){for(;fe.length<=a;)fe.push(ye(fe)+" ");return fe[a]}function ye(a){return a[a.length-1]}function Je(a,d){for(var p=[],h=0;h<a.length;h++)p[h]=d(a[h],h);return p}function rt(a,d,p){for(var h=0,m=p(d);h<a.length&&p(a[h])<=m;)h++;a.splice(h,0,d)}function lt(){}function dt(a,d){var p;return Object.create?p=Object.create(a):(lt.prototype=a,p=new lt),d&&Ue(d,p),p}var Pt=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function jt(a){return/\w/.test(a)||a>""&&(a.toUpperCase()!=a.toLowerCase()||Pt.test(a))}function Ke(a,d){return d?d.source.indexOf("\\w")>-1&&jt(a)?!0:d.test(a):jt(a)}function mi(a){for(var d in a)if(a.hasOwnProperty(d)&&a[d])return!1;return!0}var ft=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function et(a){return a.charCodeAt(0)>=768&&ft.test(a)}function Ft(a,d,p){for(;(p<0?d>0:d<a.length)&&et(a.charAt(d));)d+=p;return d}function Kt(a,d,p){for(var h=d>p?-1:1;;){if(d==p)return d;var m=(d+p)/2,b=h<0?Math.ceil(m):Math.floor(m);if(b==d)return a(b)?d:p;a(b)?p=b:d=b+h}}function kn(a,d,p,h){if(!a)return h(d,p,"ltr",0);for(var m=!1,b=0;b<a.length;++b){var x=a[b];(x.from<p&&x.to>d||d==p&&x.to==d)&&(h(Math.max(x.from,d),Math.min(x.to,p),x.level==1?"rtl":"ltr",b),m=!0)}m||h(d,p,"ltr")}var Vs=null;function Yr(a,d,p){var h;Vs=null;for(var m=0;m<a.length;++m){var b=a[m];if(b.from<d&&b.to>d)return m;b.to==d&&(b.from!=b.to&&p=="before"?h=m:Vs=m),b.from==d&&(b.from!=b.to&&p!="before"?h=m:Vs=m)}return h??Vs}var gp=function(){var a="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",d="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function p(P){return P<=247?a.charAt(P):1424<=P&&P<=1524?"R":1536<=P&&P<=1785?d.charAt(P-1536):1774<=P&&P<=2220?"r":8192<=P&&P<=8203?"w":P==8204?"b":"L"}var h=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,m=/[stwN]/,b=/[LRr]/,x=/[Lb1n]/,E=/[1n]/;function k(P,z,$){this.level=P,this.from=z,this.to=$}return function(P,z){var $=z=="ltr"?"L":"R";if(P.length==0||z=="ltr"&&!h.test(P))return!1;for(var q=P.length,Z=[],te=0;te<q;++te)Z.push(p(P.charCodeAt(te)));for(var ae=0,pe=$;ae<q;++ae){var me=Z[ae];me=="m"?Z[ae]=pe:pe=me}for(var Ce=0,ve=$;Ce<q;++Ce){var ke=Z[Ce];ke=="1"&&ve=="r"?Z[Ce]="n":b.test(ke)&&(ve=ke,ke=="r"&&(Z[Ce]="R"))}for(var Fe=1,Ve=Z[0];Fe<q-1;++Fe){var Ye=Z[Fe];Ye=="+"&&Ve=="1"&&Z[Fe+1]=="1"?Z[Fe]="1":Ye==","&&Ve==Z[Fe+1]&&(Ve=="1"||Ve=="n")&&(Z[Fe]=Ve),Ve=Ye}for(var xt=0;xt<q;++xt){var si=Z[xt];if(si==",")Z[xt]="N";else if(si=="%"){var At=void 0;for(At=xt+1;At<q&&Z[At]=="%";++At);for(var Ji=xt&&Z[xt-1]=="!"||At<q&&Z[At]=="1"?"1":"N",Oi=xt;Oi<At;++Oi)Z[Oi]=Ji;xt=At-1}}for(var Ht=0,Bi=$;Ht<q;++Ht){var ui=Z[Ht];Bi=="L"&&ui=="1"?Z[Ht]="L":b.test(ui)&&(Bi=ui)}for(var Xt=0;Xt<q;++Xt)if(m.test(Z[Xt])){var Jt=void 0;for(Jt=Xt+1;Jt<q&&m.test(Z[Jt]);++Jt);for(var Vt=(Xt?Z[Xt-1]:$)=="L",_i=(Jt<q?Z[Jt]:$)=="L",Ka=Vt==_i?Vt?"L":"R":$,ds=Xt;ds<Jt;++ds)Z[ds]=Ka;Xt=Jt-1}for(var Si=[],Yn,ai=0;ai<q;)if(x.test(Z[ai])){var cf=ai;for(++ai;ai<q&&x.test(Z[ai]);++ai);Si.push(new k(0,cf,ai))}else{var xr=ai,$s=Si.length,js=z=="rtl"?1:0;for(++ai;ai<q&&Z[ai]!="L";++ai);for(var Ei=xr;Ei<ai;)if(E.test(Z[Ei])){xr<Ei&&(Si.splice($s,0,new k(1,xr,Ei)),$s+=js);var Xa=Ei;for(++Ei;Ei<ai&&E.test(Z[Ei]);++Ei);Si.splice($s,0,new k(2,Xa,Ei)),$s+=js,xr=Ei}else++Ei;xr<ai&&Si.splice($s,0,new k(1,xr,ai))}return z=="ltr"&&(Si[0].level==1&&(Yn=P.match(/^\s+/))&&(Si[0].from=Yn[0].length,Si.unshift(new k(0,0,Yn[0].length))),ye(Si).level==1&&(Yn=P.match(/\s+$/))&&(ye(Si).to-=Yn[0].length,Si.push(new k(0,q-Yn[0].length,q)))),z=="rtl"?Si.reverse():Si}}();function Xe(a,d){var p=a.order;return p==null&&(p=a.order=gp(a.text,d)),p}var ac=[],Oe=function(a,d,p){if(a.addEventListener)a.addEventListener(d,p,!1);else if(a.attachEvent)a.attachEvent("on"+d,p);else{var h=a._handlers||(a._handlers={});h[d]=(h[d]||ac).concat(p)}};function mr(a,d){return a._handlers&&a._handlers[d]||ac}function vi(a,d,p){if(a.removeEventListener)a.removeEventListener(d,p,!1);else if(a.detachEvent)a.detachEvent("on"+d,p);else{var h=a._handlers,m=h&&h[d];if(m){var b=De(m,p);b>-1&&(h[d]=m.slice(0,b).concat(m.slice(b+1)))}}}function Mt(a,d){var p=mr(a,d);if(p.length)for(var h=Array.prototype.slice.call(arguments,2),m=0;m<p.length;++m)p[m].apply(null,h)}function Rt(a,d,p){return typeof d=="string"&&(d={type:d,preventDefault:function(){this.defaultPrevented=!0}}),Mt(a,p||d.type,a,d),Mi(d)||d.codemirrorIgnore}function cn(a){var d=a._handlers&&a._handlers.cursorActivity;if(d)for(var p=a.curOp.cursorActivityHandlers||(a.curOp.cursorActivityHandlers=[]),h=0;h<d.length;++h)De(p,d[h])==-1&&p.push(d[h])}function ji(a,d){return mr(a,d).length>0}function In(a){a.prototype.on=function(d,p){Oe(this,d,p)},a.prototype.off=function(d,p){vi(this,d,p)}}function yi(a){a.preventDefault?a.preventDefault():a.returnValue=!1}function La(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}function Mi(a){return a.defaultPrevented!=null?a.defaultPrevented:a.returnValue==!1}function Kr(a){yi(a),La(a)}function cl(a){return a.target||a.srcElement}function Tn(a){var d=a.which;return d==null&&(a.button&1?d=1:a.button&2?d=3:a.button&4&&(d=2)),D&&a.ctrlKey&&d==1&&(d=3),d}var mp=function(){if(c&&u<9)return!1;var a=F("div");return"draggable"in a||"dragDrop"in a}(),ka;function oc(a){if(ka==null){var d=F("span","​");W(a,F("span",[d,document.createTextNode("x")])),a.firstChild.offsetHeight!=0&&(ka=d.offsetWidth<=1&&d.offsetHeight>2&&!(c&&u<8))}var p=ka?F("span","​"):F("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return p.setAttribute("cm-text",""),p}var ul;function Xr(a){if(ul!=null)return ul;var d=W(a,document.createTextNode("AخA")),p=de(d,0,1).getBoundingClientRect(),h=de(d,1,2).getBoundingClientRect();return B(a),!p||p.left==p.right?!1:ul=h.right-p.right<3}var un=`

b`.split(/\n/).length!=3?function(a){for(var d=0,p=[],h=a.length;d<=h;){var m=a.indexOf(`
`,d);m==-1&&(m=a.length);var b=a.slice(d,a.charAt(m-1)=="\r"?m-1:m),x=b.indexOf("\r");x!=-1?(p.push(b.slice(0,x)),d+=x+1):(p.push(b),d=m+1)}return p}:function(a){return a.split(/\r\n?|\n/)},Qr=window.getSelection?function(a){try{return a.selectionStart!=a.selectionEnd}catch{return!1}}:function(a){var d;try{d=a.ownerDocument.selection.createRange()}catch{}return!d||d.parentElement()!=a?!1:d.compareEndPoints("StartToEnd",d)!=0},lc=function(){var a=F("div");return"oncopy"in a?!0:(a.setAttribute("oncopy","return;"),typeof a.oncopy=="function")}(),Dn=null;function vp(a){if(Dn!=null)return Dn;var d=W(a,F("span","x")),p=d.getBoundingClientRect(),h=de(d,0,1).getBoundingClientRect();return Dn=Math.abs(p.left-h.left)>1}var Ia={},Pn={};function An(a,d){arguments.length>2&&(d.dependencies=Array.prototype.slice.call(arguments,2)),Ia[a]=d}function Ta(a,d){Pn[a]=d}function Da(a){if(typeof a=="string"&&Pn.hasOwnProperty(a))a=Pn[a];else if(a&&typeof a.name=="string"&&Pn.hasOwnProperty(a.name)){var d=Pn[a.name];typeof d=="string"&&(d={name:d}),a=dt(d,a),a.name=d.name}else{if(typeof a=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(a))return Da("application/xml");if(typeof a=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(a))return Da("application/json")}return typeof a=="string"?{name:a}:a||{name:"null"}}function Pa(a,d){d=Da(d);var p=Ia[d.name];if(!p)return Pa(a,"text/plain");var h=p(a,d);if(es.hasOwnProperty(d.name)){var m=es[d.name];for(var b in m)m.hasOwnProperty(b)&&(h.hasOwnProperty(b)&&(h["_"+b]=h[b]),h[b]=m[b])}if(h.name=d.name,d.helperType&&(h.helperType=d.helperType),d.modeProps)for(var x in d.modeProps)h[x]=d.modeProps[x];return h}var es={};function Aa(a,d){var p=es.hasOwnProperty(a)?es[a]:es[a]={};Ue(d,p)}function Hn(a,d){if(d===!0)return d;if(a.copyState)return a.copyState(d);var p={};for(var h in d){var m=d[h];m instanceof Array&&(m=m.concat([])),p[h]=m}return p}function hl(a,d){for(var p;a.innerMode&&(p=a.innerMode(d),!(!p||p.mode==a));)d=p.state,a=p.mode;return p||{mode:a,state:d}}function Ma(a,d,p){return a.startState?a.startState(d,p):!0}var Nt=function(a,d,p){this.pos=this.start=0,this.string=a,this.tabSize=d||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=p};Nt.prototype.eol=function(){return this.pos>=this.string.length},Nt.prototype.sol=function(){return this.pos==this.lineStart},Nt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Nt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Nt.prototype.eat=function(a){var d=this.string.charAt(this.pos),p;if(typeof a=="string"?p=d==a:p=d&&(a.test?a.test(d):a(d)),p)return++this.pos,d},Nt.prototype.eatWhile=function(a){for(var d=this.pos;this.eat(a););return this.pos>d},Nt.prototype.eatSpace=function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},Nt.prototype.skipToEnd=function(){this.pos=this.string.length},Nt.prototype.skipTo=function(a){var d=this.string.indexOf(a,this.pos);if(d>-1)return this.pos=d,!0},Nt.prototype.backUp=function(a){this.pos-=a},Nt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=We(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?We(this.string,this.lineStart,this.tabSize):0)},Nt.prototype.indentation=function(){return We(this.string,null,this.tabSize)-(this.lineStart?We(this.string,this.lineStart,this.tabSize):0)},Nt.prototype.match=function(a,d,p){if(typeof a=="string"){var h=function(x){return p?x.toLowerCase():x},m=this.string.substr(this.pos,a.length);if(h(m)==h(a))return d!==!1&&(this.pos+=a.length),!0}else{var b=this.string.slice(this.pos).match(a);return b&&b.index>0?null:(b&&d!==!1&&(this.pos+=b[0].length),b)}},Nt.prototype.current=function(){return this.string.slice(this.start,this.pos)},Nt.prototype.hideFirstChars=function(a,d){this.lineStart+=a;try{return d()}finally{this.lineStart-=a}},Nt.prototype.lookAhead=function(a){var d=this.lineOracle;return d&&d.lookAhead(a)},Nt.prototype.baseToken=function(){var a=this.lineOracle;return a&&a.baseToken(this.pos)};function Ae(a,d){if(d-=a.first,d<0||d>=a.size)throw new Error("There is no line "+(d+a.first)+" in the document.");for(var p=a;!p.lines;)for(var h=0;;++h){var m=p.children[h],b=m.chunkSize();if(d<b){p=m;break}d-=b}return p.lines[d]}function vr(a,d,p){var h=[],m=d.line;return a.iter(d.line,p.line+1,function(b){var x=b.text;m==p.line&&(x=x.slice(0,p.ch)),m==d.line&&(x=x.slice(d.ch)),h.push(x),++m}),h}function pl(a,d,p){var h=[];return a.iter(d,p,function(m){h.push(m.text)}),h}function Qi(a,d){var p=d-a.height;if(p)for(var h=a;h;h=h.parent)h.height+=p}function N(a){if(a.parent==null)return null;for(var d=a.parent,p=De(d.lines,a),h=d.parent;h;d=h,h=h.parent)for(var m=0;h.children[m]!=d;++m)p+=h.children[m].chunkSize();return p+d.first}function G(a,d){var p=a.first;e:do{for(var h=0;h<a.children.length;++h){var m=a.children[h],b=m.height;if(d<b){a=m;continue e}d-=b,p+=m.chunkSize()}return p}while(!a.lines);for(var x=0;x<a.lines.length;++x){var E=a.lines[x],k=E.height;if(d<k)break;d-=k}return p+x}function ne(a,d){return d>=a.first&&d<a.first+a.size}function he(a,d){return String(a.lineNumberFormatter(d+a.firstLineNumber))}function Q(a,d,p){if(p===void 0&&(p=null),!(this instanceof Q))return new Q(a,d,p);this.line=a,this.ch=d,this.sticky=p}function be(a,d){return a.line-d.line||a.ch-d.ch}function ut(a,d){return a.sticky==d.sticky&&be(a,d)==0}function ti(a){return Q(a.line,a.ch)}function Ri(a,d){return be(a,d)<0?d:a}function Ra(a,d){return be(a,d)<0?a:d}function u0(a,d){return Math.max(a.first,Math.min(d,a.first+a.size-1))}function $e(a,d){if(d.line<a.first)return Q(a.first,0);var p=a.first+a.size-1;return d.line>p?Q(p,Ae(a,p).text.length):cP(d,Ae(a,d.line).text.length)}function cP(a,d){var p=a.ch;return p==null||p>d?Q(a.line,d):p<0?Q(a.line,0):a}function h0(a,d){for(var p=[],h=0;h<d.length;h++)p[h]=$e(a,d[h]);return p}var dc=function(a,d){this.state=a,this.lookAhead=d},Jn=function(a,d,p,h){this.state=d,this.doc=a,this.line=p,this.maxLookAhead=h||0,this.baseTokens=null,this.baseTokenPos=1};Jn.prototype.lookAhead=function(a){var d=this.doc.getLine(this.line+a);return d!=null&&a>this.maxLookAhead&&(this.maxLookAhead=a),d},Jn.prototype.baseToken=function(a){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=a;)this.baseTokenPos+=2;var d=this.baseTokens[this.baseTokenPos+1];return{type:d&&d.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-a}},Jn.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},Jn.fromSaved=function(a,d,p){return d instanceof dc?new Jn(a,Hn(a.mode,d.state),p,d.lookAhead):new Jn(a,Hn(a.mode,d),p)},Jn.prototype.save=function(a){var d=a!==!1?Hn(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new dc(d,this.maxLookAhead):d};function p0(a,d,p,h){var m=[a.state.modeGen],b={};b0(a,d.text,a.doc.mode,p,function(P,z){return m.push(P,z)},b,h);for(var x=p.state,E=function(P){p.baseTokens=m;var z=a.state.overlays[P],$=1,q=0;p.state=!0,b0(a,d.text,z.mode,p,function(Z,te){for(var ae=$;q<Z;){var pe=m[$];pe>Z&&m.splice($,1,Z,m[$+1],pe),$+=2,q=Math.min(Z,pe)}if(te)if(z.opaque)m.splice(ae,$-ae,Z,"overlay "+te),$=ae+2;else for(;ae<$;ae+=2){var me=m[ae+1];m[ae+1]=(me?me+" ":"")+"overlay "+te}},b),p.state=x,p.baseTokens=null,p.baseTokenPos=1},k=0;k<a.state.overlays.length;++k)E(k);return{styles:m,classes:b.bgClass||b.textClass?b:null}}function f0(a,d,p){if(!d.styles||d.styles[0]!=a.state.modeGen){var h=fl(a,N(d)),m=d.text.length>a.options.maxHighlightLength&&Hn(a.doc.mode,h.state),b=p0(a,d,h);m&&(h.state=m),d.stateAfter=h.save(!m),d.styles=b.styles,b.classes?d.styleClasses=b.classes:d.styleClasses&&(d.styleClasses=null),p===a.doc.highlightFrontier&&(a.doc.modeFrontier=Math.max(a.doc.modeFrontier,++a.doc.highlightFrontier))}return d.styles}function fl(a,d,p){var h=a.doc,m=a.display;if(!h.mode.startState)return new Jn(h,!0,d);var b=uP(a,d,p),x=b>h.first&&Ae(h,b-1).stateAfter,E=x?Jn.fromSaved(h,x,b):new Jn(h,Ma(h.mode),b);return h.iter(b,d,function(k){yp(a,k.text,E);var P=E.line;k.stateAfter=P==d-1||P%5==0||P>=m.viewFrom&&P<m.viewTo?E.save():null,E.nextLine()}),p&&(h.modeFrontier=E.line),E}function yp(a,d,p,h){var m=a.doc.mode,b=new Nt(d,a.options.tabSize,p);for(b.start=b.pos=h||0,d==""&&g0(m,p.state);!b.eol();)bp(m,b,p.state),b.start=b.pos}function g0(a,d){if(a.blankLine)return a.blankLine(d);if(a.innerMode){var p=hl(a,d);if(p.mode.blankLine)return p.mode.blankLine(p.state)}}function bp(a,d,p,h){for(var m=0;m<10;m++){h&&(h[0]=hl(a,p).mode);var b=a.token(d,p);if(d.pos>d.start)return b}throw new Error("Mode "+a.name+" failed to advance stream.")}var m0=function(a,d,p){this.start=a.start,this.end=a.pos,this.string=a.current(),this.type=d||null,this.state=p};function v0(a,d,p,h){var m=a.doc,b=m.mode,x;d=$e(m,d);var E=Ae(m,d.line),k=fl(a,d.line,p),P=new Nt(E.text,a.options.tabSize,k),z;for(h&&(z=[]);(h||P.pos<d.ch)&&!P.eol();)P.start=P.pos,x=bp(b,P,k.state),h&&z.push(new m0(P,x,Hn(m.mode,k.state)));return h?z:new m0(P,x,k.state)}function y0(a,d){if(a)for(;;){var p=a.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!p)break;a=a.slice(0,p.index)+a.slice(p.index+p[0].length);var h=p[1]?"bgClass":"textClass";d[h]==null?d[h]=p[2]:new RegExp("(?:^|\\s)"+p[2]+"(?:$|\\s)").test(d[h])||(d[h]+=" "+p[2])}return a}function b0(a,d,p,h,m,b,x){var E=p.flattenSpans;E==null&&(E=a.options.flattenSpans);var k=0,P=null,z=new Nt(d,a.options.tabSize,h),$,q=a.options.addModeClass&&[null];for(d==""&&y0(g0(p,h.state),b);!z.eol();){if(z.pos>a.options.maxHighlightLength?(E=!1,x&&yp(a,d,h,z.pos),z.pos=d.length,$=null):$=y0(bp(p,z,h.state,q),b),q){var Z=q[0].name;Z&&($="m-"+($?Z+" "+$:Z))}if(!E||P!=$){for(;k<z.start;)k=Math.min(z.start,k+5e3),m(k,P);P=$}z.start=z.pos}for(;k<z.pos;){var te=Math.min(z.pos,k+5e3);m(te,P),k=te}}function uP(a,d,p){for(var h,m,b=a.doc,x=p?-1:d-(a.doc.mode.innerMode?1e3:100),E=d;E>x;--E){if(E<=b.first)return b.first;var k=Ae(b,E-1),P=k.stateAfter;if(P&&(!p||E+(P instanceof dc?P.lookAhead:0)<=b.modeFrontier))return E;var z=We(k.text,null,a.options.tabSize);(m==null||h>z)&&(m=E-1,h=z)}return m}function hP(a,d){if(a.modeFrontier=Math.min(a.modeFrontier,d),!(a.highlightFrontier<d-10)){for(var p=a.first,h=d-1;h>p;h--){var m=Ae(a,h).stateAfter;if(m&&(!(m instanceof dc)||h+m.lookAhead<d)){p=h+1;break}}a.highlightFrontier=Math.min(a.highlightFrontier,p)}}var S0=!1,yr=!1;function pP(){S0=!0}function fP(){yr=!0}function cc(a,d,p){this.marker=a,this.from=d,this.to=p}function gl(a,d){if(a)for(var p=0;p<a.length;++p){var h=a[p];if(h.marker==d)return h}}function gP(a,d){for(var p,h=0;h<a.length;++h)a[h]!=d&&(p||(p=[])).push(a[h]);return p}function mP(a,d,p){var h=p&&window.WeakSet&&(p.markedSpans||(p.markedSpans=new WeakSet));h&&a.markedSpans&&h.has(a.markedSpans)?a.markedSpans.push(d):(a.markedSpans=a.markedSpans?a.markedSpans.concat([d]):[d],h&&h.add(a.markedSpans)),d.marker.attachLine(a)}function vP(a,d,p){var h;if(a)for(var m=0;m<a.length;++m){var b=a[m],x=b.marker,E=b.from==null||(x.inclusiveLeft?b.from<=d:b.from<d);if(E||b.from==d&&x.type=="bookmark"&&(!p||!b.marker.insertLeft)){var k=b.to==null||(x.inclusiveRight?b.to>=d:b.to>d);(h||(h=[])).push(new cc(x,b.from,k?null:b.to))}}return h}function yP(a,d,p){var h;if(a)for(var m=0;m<a.length;++m){var b=a[m],x=b.marker,E=b.to==null||(x.inclusiveRight?b.to>=d:b.to>d);if(E||b.from==d&&x.type=="bookmark"&&(!p||b.marker.insertLeft)){var k=b.from==null||(x.inclusiveLeft?b.from<=d:b.from<d);(h||(h=[])).push(new cc(x,k?null:b.from-d,b.to==null?null:b.to-d))}}return h}function Sp(a,d){if(d.full)return null;var p=ne(a,d.from.line)&&Ae(a,d.from.line).markedSpans,h=ne(a,d.to.line)&&Ae(a,d.to.line).markedSpans;if(!p&&!h)return null;var m=d.from.ch,b=d.to.ch,x=be(d.from,d.to)==0,E=vP(p,m,x),k=yP(h,b,x),P=d.text.length==1,z=ye(d.text).length+(P?m:0);if(E)for(var $=0;$<E.length;++$){var q=E[$];if(q.to==null){var Z=gl(k,q.marker);Z?P&&(q.to=Z.to==null?null:Z.to+z):q.to=m}}if(k)for(var te=0;te<k.length;++te){var ae=k[te];if(ae.to!=null&&(ae.to+=z),ae.from==null){var pe=gl(E,ae.marker);pe||(ae.from=z,P&&(E||(E=[])).push(ae))}else ae.from+=z,P&&(E||(E=[])).push(ae)}E&&(E=w0(E)),k&&k!=E&&(k=w0(k));var me=[E];if(!P){var Ce=d.text.length-2,ve;if(Ce>0&&E)for(var ke=0;ke<E.length;++ke)E[ke].to==null&&(ve||(ve=[])).push(new cc(E[ke].marker,null,null));for(var Fe=0;Fe<Ce;++Fe)me.push(ve);me.push(k)}return me}function w0(a){for(var d=0;d<a.length;++d){var p=a[d];p.from!=null&&p.from==p.to&&p.marker.clearWhenEmpty!==!1&&a.splice(d--,1)}return a.length?a:null}function bP(a,d,p){var h=null;if(a.iter(d.line,p.line+1,function(Z){if(Z.markedSpans)for(var te=0;te<Z.markedSpans.length;++te){var ae=Z.markedSpans[te].marker;ae.readOnly&&(!h||De(h,ae)==-1)&&(h||(h=[])).push(ae)}}),!h)return null;for(var m=[{from:d,to:p}],b=0;b<h.length;++b)for(var x=h[b],E=x.find(0),k=0;k<m.length;++k){var P=m[k];if(!(be(P.to,E.from)<0||be(P.from,E.to)>0)){var z=[k,1],$=be(P.from,E.from),q=be(P.to,E.to);($<0||!x.inclusiveLeft&&!$)&&z.push({from:P.from,to:E.from}),(q>0||!x.inclusiveRight&&!q)&&z.push({from:E.to,to:P.to}),m.splice.apply(m,z),k+=z.length-3}}return m}function C0(a){var d=a.markedSpans;if(d){for(var p=0;p<d.length;++p)d[p].marker.detachLine(a);a.markedSpans=null}}function x0(a,d){if(d){for(var p=0;p<d.length;++p)d[p].marker.attachLine(a);a.markedSpans=d}}function uc(a){return a.inclusiveLeft?-1:0}function hc(a){return a.inclusiveRight?1:0}function wp(a,d){var p=a.lines.length-d.lines.length;if(p!=0)return p;var h=a.find(),m=d.find(),b=be(h.from,m.from)||uc(a)-uc(d);if(b)return-b;var x=be(h.to,m.to)||hc(a)-hc(d);return x||d.id-a.id}function E0(a,d){var p=yr&&a.markedSpans,h;if(p)for(var m=void 0,b=0;b<p.length;++b)m=p[b],m.marker.collapsed&&(d?m.from:m.to)==null&&(!h||wp(h,m.marker)<0)&&(h=m.marker);return h}function L0(a){return E0(a,!0)}function pc(a){return E0(a,!1)}function SP(a,d){var p=yr&&a.markedSpans,h;if(p)for(var m=0;m<p.length;++m){var b=p[m];b.marker.collapsed&&(b.from==null||b.from<d)&&(b.to==null||b.to>d)&&(!h||wp(h,b.marker)<0)&&(h=b.marker)}return h}function k0(a,d,p,h,m){var b=Ae(a,d),x=yr&&b.markedSpans;if(x)for(var E=0;E<x.length;++E){var k=x[E];if(k.marker.collapsed){var P=k.marker.find(0),z=be(P.from,p)||uc(k.marker)-uc(m),$=be(P.to,h)||hc(k.marker)-hc(m);if(!(z>=0&&$<=0||z<=0&&$>=0)&&(z<=0&&(k.marker.inclusiveRight&&m.inclusiveLeft?be(P.to,p)>=0:be(P.to,p)>0)||z>=0&&(k.marker.inclusiveRight&&m.inclusiveLeft?be(P.from,h)<=0:be(P.from,h)<0)))return!0}}}function Mn(a){for(var d;d=L0(a);)a=d.find(-1,!0).line;return a}function wP(a){for(var d;d=pc(a);)a=d.find(1,!0).line;return a}function CP(a){for(var d,p;d=pc(a);)a=d.find(1,!0).line,(p||(p=[])).push(a);return p}function Cp(a,d){var p=Ae(a,d),h=Mn(p);return p==h?d:N(h)}function I0(a,d){if(d>a.lastLine())return d;var p=Ae(a,d),h;if(!ts(a,p))return d;for(;h=pc(p);)p=h.find(1,!0).line;return N(p)+1}function ts(a,d){var p=yr&&d.markedSpans;if(p){for(var h=void 0,m=0;m<p.length;++m)if(h=p[m],!!h.marker.collapsed&&(h.from==null||!h.marker.widgetNode&&h.from==0&&h.marker.inclusiveLeft&&xp(a,d,h)))return!0}}function xp(a,d,p){if(p.to==null){var h=p.marker.find(1,!0);return xp(a,h.line,gl(h.line.markedSpans,p.marker))}if(p.marker.inclusiveRight&&p.to==d.text.length)return!0;for(var m=void 0,b=0;b<d.markedSpans.length;++b)if(m=d.markedSpans[b],m.marker.collapsed&&!m.marker.widgetNode&&m.from==p.to&&(m.to==null||m.to!=p.from)&&(m.marker.inclusiveLeft||p.marker.inclusiveRight)&&xp(a,d,m))return!0}function br(a){a=Mn(a);for(var d=0,p=a.parent,h=0;h<p.lines.length;++h){var m=p.lines[h];if(m==a)break;d+=m.height}for(var b=p.parent;b;p=b,b=p.parent)for(var x=0;x<b.children.length;++x){var E=b.children[x];if(E==p)break;d+=E.height}return d}function fc(a){if(a.height==0)return 0;for(var d=a.text.length,p,h=a;p=L0(h);){var m=p.find(0,!0);h=m.from.line,d+=m.from.ch-m.to.ch}for(h=a;p=pc(h);){var b=p.find(0,!0);d-=h.text.length-b.from.ch,h=b.to.line,d+=h.text.length-b.to.ch}return d}function Ep(a){var d=a.display,p=a.doc;d.maxLine=Ae(p,p.first),d.maxLineLength=fc(d.maxLine),d.maxLineChanged=!0,p.iter(function(h){var m=fc(h);m>d.maxLineLength&&(d.maxLineLength=m,d.maxLine=h)})}var Na=function(a,d,p){this.text=a,x0(this,d),this.height=p?p(this):1};Na.prototype.lineNo=function(){return N(this)},In(Na);function xP(a,d,p,h){a.text=d,a.stateAfter&&(a.stateAfter=null),a.styles&&(a.styles=null),a.order!=null&&(a.order=null),C0(a),x0(a,p);var m=h?h(a):1;m!=a.height&&Qi(a,m)}function EP(a){a.parent=null,C0(a)}var LP={},kP={};function T0(a,d){if(!a||/^\s*$/.test(a))return null;var p=d.addModeClass?kP:LP;return p[a]||(p[a]=a.replace(/\S+/g,"cm-$&"))}function D0(a,d){var p=le("span",null,null,f?"padding-right: .1px":null),h={pre:le("pre",[p],"CodeMirror-line"),content:p,col:0,pos:0,cm:a,trailingSpace:!1,splitSpaces:a.getOption("lineWrapping")};d.measure={};for(var m=0;m<=(d.rest?d.rest.length:0);m++){var b=m?d.rest[m-1]:d.line,x=void 0;h.pos=0,h.addToken=TP,Xr(a.display.measure)&&(x=Xe(b,a.doc.direction))&&(h.addToken=PP(h.addToken,x)),h.map=[];var E=d!=a.display.externalMeasured&&N(b);AP(b,h,f0(a,b,E)),b.styleClasses&&(b.styleClasses.bgClass&&(h.bgClass=Be(b.styleClasses.bgClass,h.bgClass||"")),b.styleClasses.textClass&&(h.textClass=Be(b.styleClasses.textClass,h.textClass||""))),h.map.length==0&&h.map.push(0,0,h.content.appendChild(oc(a.display.measure))),m==0?(d.measure.map=h.map,d.measure.cache={}):((d.measure.maps||(d.measure.maps=[])).push(h.map),(d.measure.caches||(d.measure.caches=[])).push({}))}if(f){var k=h.content.lastChild;(/\bcm-tab\b/.test(k.className)||k.querySelector&&k.querySelector(".cm-tab"))&&(h.content.className="cm-tab-wrap-hack")}return Mt(a,"renderLine",a,d.line,h.pre),h.pre.className&&(h.textClass=Be(h.pre.className,h.textClass||"")),h}function IP(a){var d=F("span","•","cm-invalidchar");return d.title="\\u"+a.charCodeAt(0).toString(16),d.setAttribute("aria-label",d.title),d}function TP(a,d,p,h,m,b,x){if(d){var E=a.splitSpaces?DP(d,a.trailingSpace):d,k=a.cm.state.specialChars,P=!1,z;if(!k.test(d))a.col+=d.length,z=document.createTextNode(E),a.map.push(a.pos,a.pos+d.length,z),c&&u<9&&(P=!0),a.pos+=d.length;else{z=document.createDocumentFragment();for(var $=0;;){k.lastIndex=$;var q=k.exec(d),Z=q?q.index-$:d.length-$;if(Z){var te=document.createTextNode(E.slice($,$+Z));c&&u<9?z.appendChild(F("span",[te])):z.appendChild(te),a.map.push(a.pos,a.pos+Z,te),a.col+=Z,a.pos+=Z}if(!q)break;$+=Z+1;var ae=void 0;if(q[0]=="	"){var pe=a.cm.options.tabSize,me=pe-a.col%pe;ae=z.appendChild(F("span",Ee(me),"cm-tab")),ae.setAttribute("role","presentation"),ae.setAttribute("cm-text","	"),a.col+=me}else q[0]=="\r"||q[0]==`
`?(ae=z.appendChild(F("span",q[0]=="\r"?"␍":"␤","cm-invalidchar")),ae.setAttribute("cm-text",q[0]),a.col+=1):(ae=a.cm.options.specialCharPlaceholder(q[0]),ae.setAttribute("cm-text",q[0]),c&&u<9?z.appendChild(F("span",[ae])):z.appendChild(ae),a.col+=1);a.map.push(a.pos,a.pos+1,ae),a.pos++}}if(a.trailingSpace=E.charCodeAt(d.length-1)==32,p||h||m||P||b||x){var Ce=p||"";h&&(Ce+=h),m&&(Ce+=m);var ve=F("span",[z],Ce,b);if(x)for(var ke in x)x.hasOwnProperty(ke)&&ke!="style"&&ke!="class"&&ve.setAttribute(ke,x[ke]);return a.content.appendChild(ve)}a.content.appendChild(z)}}function DP(a,d){if(a.length>1&&!/  /.test(a))return a;for(var p=d,h="",m=0;m<a.length;m++){var b=a.charAt(m);b==" "&&p&&(m==a.length-1||a.charCodeAt(m+1)==32)&&(b=" "),h+=b,p=b==" "}return h}function PP(a,d){return function(p,h,m,b,x,E,k){m=m?m+" cm-force-border":"cm-force-border";for(var P=p.pos,z=P+h.length;;){for(var $=void 0,q=0;q<d.length&&($=d[q],!($.to>P&&$.from<=P));q++);if($.to>=z)return a(p,h,m,b,x,E,k);a(p,h.slice(0,$.to-P),m,b,null,E,k),b=null,h=h.slice($.to-P),P=$.to}}}function P0(a,d,p,h){var m=!h&&p.widgetNode;m&&a.map.push(a.pos,a.pos+d,m),!h&&a.cm.display.input.needsContentAttribute&&(m||(m=a.content.appendChild(document.createElement("span"))),m.setAttribute("cm-marker",p.id)),m&&(a.cm.display.input.setUneditable(m),a.content.appendChild(m)),a.pos+=d,a.trailingSpace=!1}function AP(a,d,p){var h=a.markedSpans,m=a.text,b=0;if(!h){for(var x=1;x<p.length;x+=2)d.addToken(d,m.slice(b,b=p[x]),T0(p[x+1],d.cm.options));return}for(var E=m.length,k=0,P=1,z="",$,q,Z=0,te,ae,pe,me,Ce;;){if(Z==k){te=ae=pe=q="",Ce=null,me=null,Z=1/0;for(var ve=[],ke=void 0,Fe=0;Fe<h.length;++Fe){var Ve=h[Fe],Ye=Ve.marker;if(Ye.type=="bookmark"&&Ve.from==k&&Ye.widgetNode)ve.push(Ye);else if(Ve.from<=k&&(Ve.to==null||Ve.to>k||Ye.collapsed&&Ve.to==k&&Ve.from==k)){if(Ve.to!=null&&Ve.to!=k&&Z>Ve.to&&(Z=Ve.to,ae=""),Ye.className&&(te+=" "+Ye.className),Ye.css&&(q=(q?q+";":"")+Ye.css),Ye.startStyle&&Ve.from==k&&(pe+=" "+Ye.startStyle),Ye.endStyle&&Ve.to==Z&&(ke||(ke=[])).push(Ye.endStyle,Ve.to),Ye.title&&((Ce||(Ce={})).title=Ye.title),Ye.attributes)for(var xt in Ye.attributes)(Ce||(Ce={}))[xt]=Ye.attributes[xt];Ye.collapsed&&(!me||wp(me.marker,Ye)<0)&&(me=Ve)}else Ve.from>k&&Z>Ve.from&&(Z=Ve.from)}if(ke)for(var si=0;si<ke.length;si+=2)ke[si+1]==Z&&(ae+=" "+ke[si]);if(!me||me.from==k)for(var At=0;At<ve.length;++At)P0(d,0,ve[At]);if(me&&(me.from||0)==k){if(P0(d,(me.to==null?E+1:me.to)-k,me.marker,me.from==null),me.to==null)return;me.to==k&&(me=!1)}}if(k>=E)break;for(var Ji=Math.min(E,Z);;){if(z){var Oi=k+z.length;if(!me){var Ht=Oi>Ji?z.slice(0,Ji-k):z;d.addToken(d,Ht,$?$+te:te,pe,k+Ht.length==Z?ae:"",q,Ce)}if(Oi>=Ji){z=z.slice(Ji-k),k=Ji;break}k=Oi,pe=""}z=m.slice(b,b=p[P++]),$=T0(p[P++],d.cm.options)}}}function A0(a,d,p){this.line=d,this.rest=CP(d),this.size=this.rest?N(ye(this.rest))-p+1:1,this.node=this.text=null,this.hidden=ts(a,d)}function gc(a,d,p){for(var h=[],m,b=d;b<p;b=m){var x=new A0(a.doc,Ae(a.doc,b),b);m=b+x.size,h.push(x)}return h}var Va=null;function MP(a){Va?Va.ops.push(a):a.ownsGroup=Va={ops:[a],delayedCallbacks:[]}}function RP(a){var d=a.delayedCallbacks,p=0;do{for(;p<d.length;p++)d[p].call(null);for(var h=0;h<a.ops.length;h++){var m=a.ops[h];if(m.cursorActivityHandlers)for(;m.cursorActivityCalled<m.cursorActivityHandlers.length;)m.cursorActivityHandlers[m.cursorActivityCalled++].call(null,m.cm)}}while(p<d.length)}function NP(a,d){var p=a.ownsGroup;if(p)try{RP(p)}finally{Va=null,d(p)}}var ml=null;function ii(a,d){var p=mr(a,d);if(p.length){var h=Array.prototype.slice.call(arguments,2),m;Va?m=Va.delayedCallbacks:ml?m=ml:(m=ml=[],setTimeout(VP,0));for(var b=function(E){m.push(function(){return p[E].apply(null,h)})},x=0;x<p.length;++x)b(x)}}function VP(){var a=ml;ml=null;for(var d=0;d<a.length;++d)a[d]()}function M0(a,d,p,h){for(var m=0;m<d.changes.length;m++){var b=d.changes[m];b=="text"?BP(a,d):b=="gutter"?N0(a,d,p,h):b=="class"?Lp(a,d):b=="widget"&&_P(a,d,h)}d.changes=null}function vl(a){return a.node==a.text&&(a.node=F("div",null,null,"position: relative"),a.text.parentNode&&a.text.parentNode.replaceChild(a.node,a.text),a.node.appendChild(a.text),c&&u<8&&(a.node.style.zIndex=2)),a.node}function OP(a,d){var p=d.bgClass?d.bgClass+" "+(d.line.bgClass||""):d.line.bgClass;if(p&&(p+=" CodeMirror-linebackground"),d.background)p?d.background.className=p:(d.background.parentNode.removeChild(d.background),d.background=null);else if(p){var h=vl(d);d.background=h.insertBefore(F("div",null,p),h.firstChild),a.display.input.setUneditable(d.background)}}function R0(a,d){var p=a.display.externalMeasured;return p&&p.line==d.line?(a.display.externalMeasured=null,d.measure=p.measure,p.built):D0(a,d)}function BP(a,d){var p=d.text.className,h=R0(a,d);d.text==d.node&&(d.node=h.pre),d.text.parentNode.replaceChild(h.pre,d.text),d.text=h.pre,h.bgClass!=d.bgClass||h.textClass!=d.textClass?(d.bgClass=h.bgClass,d.textClass=h.textClass,Lp(a,d)):p&&(d.text.className=p)}function Lp(a,d){OP(a,d),d.line.wrapClass?vl(d).className=d.line.wrapClass:d.node!=d.text&&(d.node.className="");var p=d.textClass?d.textClass+" "+(d.line.textClass||""):d.line.textClass;d.text.className=p||""}function N0(a,d,p,h){if(d.gutter&&(d.node.removeChild(d.gutter),d.gutter=null),d.gutterBackground&&(d.node.removeChild(d.gutterBackground),d.gutterBackground=null),d.line.gutterClass){var m=vl(d);d.gutterBackground=F("div",null,"CodeMirror-gutter-background "+d.line.gutterClass,"left: "+(a.options.fixedGutter?h.fixedPos:-h.gutterTotalWidth)+"px; width: "+h.gutterTotalWidth+"px"),a.display.input.setUneditable(d.gutterBackground),m.insertBefore(d.gutterBackground,d.text)}var b=d.line.gutterMarkers;if(a.options.lineNumbers||b){var x=vl(d),E=d.gutter=F("div",null,"CodeMirror-gutter-wrapper","left: "+(a.options.fixedGutter?h.fixedPos:-h.gutterTotalWidth)+"px");if(E.setAttribute("aria-hidden","true"),a.display.input.setUneditable(E),x.insertBefore(E,d.text),d.line.gutterClass&&(E.className+=" "+d.line.gutterClass),a.options.lineNumbers&&(!b||!b["CodeMirror-linenumbers"])&&(d.lineNumber=E.appendChild(F("div",he(a.options,p),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+h.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+a.display.lineNumInnerWidth+"px"))),b)for(var k=0;k<a.display.gutterSpecs.length;++k){var P=a.display.gutterSpecs[k].className,z=b.hasOwnProperty(P)&&b[P];z&&E.appendChild(F("div",[z],"CodeMirror-gutter-elt","left: "+h.gutterLeft[P]+"px; width: "+h.gutterWidth[P]+"px"))}}}function _P(a,d,p){d.alignable&&(d.alignable=null);for(var h=H("CodeMirror-linewidget"),m=d.node.firstChild,b=void 0;m;m=b)b=m.nextSibling,h.test(m.className)&&d.node.removeChild(m);V0(a,d,p)}function FP(a,d,p,h){var m=R0(a,d);return d.text=d.node=m.pre,m.bgClass&&(d.bgClass=m.bgClass),m.textClass&&(d.textClass=m.textClass),Lp(a,d),N0(a,d,p,h),V0(a,d,h),d.node}function V0(a,d,p){if(O0(a,d.line,d,p,!0),d.rest)for(var h=0;h<d.rest.length;h++)O0(a,d.rest[h],d,p,!1)}function O0(a,d,p,h,m){if(d.widgets)for(var b=vl(p),x=0,E=d.widgets;x<E.length;++x){var k=E[x],P=F("div",[k.node],"CodeMirror-linewidget"+(k.className?" "+k.className:""));k.handleMouseEvents||P.setAttribute("cm-ignore-events","true"),UP(k,P,p,h),a.display.input.setUneditable(P),m&&k.above?b.insertBefore(P,p.gutter||p.text):b.appendChild(P),ii(k,"redraw")}}function UP(a,d,p,h){if(a.noHScroll){(p.alignable||(p.alignable=[])).push(d);var m=h.wrapperWidth;d.style.left=h.fixedPos+"px",a.coverGutter||(m-=h.gutterTotalWidth,d.style.paddingLeft=h.gutterTotalWidth+"px"),d.style.width=m+"px"}a.coverGutter&&(d.style.zIndex=5,d.style.position="relative",a.noHScroll||(d.style.marginLeft=-h.gutterTotalWidth+"px"))}function yl(a){if(a.height!=null)return a.height;var d=a.doc.cm;if(!d)return 0;if(!Re(document.body,a.node)){var p="position: relative;";a.coverGutter&&(p+="margin-left: -"+d.display.gutters.offsetWidth+"px;"),a.noHScroll&&(p+="width: "+d.display.wrapper.clientWidth+"px;"),W(d.display.measure,F("div",[a.node],null,p))}return a.height=a.node.parentNode.offsetHeight}function Sr(a,d){for(var p=cl(d);p!=a.wrapper;p=p.parentNode)if(!p||p.nodeType==1&&p.getAttribute("cm-ignore-events")=="true"||p.parentNode==a.sizer&&p!=a.mover)return!0}function mc(a){return a.lineSpace.offsetTop}function kp(a){return a.mover.offsetHeight-a.lineSpace.offsetHeight}function B0(a){if(a.cachedPaddingH)return a.cachedPaddingH;var d=W(a.measure,F("pre","x","CodeMirror-line-like")),p=window.getComputedStyle?window.getComputedStyle(d):d.currentStyle,h={left:parseInt(p.paddingLeft),right:parseInt(p.paddingRight)};return!isNaN(h.left)&&!isNaN(h.right)&&(a.cachedPaddingH=h),h}function Zn(a){return St-a.display.nativeBarWidth}function Os(a){return a.display.scroller.clientWidth-Zn(a)-a.display.barWidth}function Ip(a){return a.display.scroller.clientHeight-Zn(a)-a.display.barHeight}function zP(a,d,p){var h=a.options.lineWrapping,m=h&&Os(a);if(!d.measure.heights||h&&d.measure.width!=m){var b=d.measure.heights=[];if(h){d.measure.width=m;for(var x=d.text.firstChild.getClientRects(),E=0;E<x.length-1;E++){var k=x[E],P=x[E+1];Math.abs(k.bottom-P.bottom)>2&&b.push((k.bottom+P.top)/2-p.top)}}b.push(p.bottom-p.top)}}function _0(a,d,p){if(a.line==d)return{map:a.measure.map,cache:a.measure.cache};if(a.rest){for(var h=0;h<a.rest.length;h++)if(a.rest[h]==d)return{map:a.measure.maps[h],cache:a.measure.caches[h]};for(var m=0;m<a.rest.length;m++)if(N(a.rest[m])>p)return{map:a.measure.maps[m],cache:a.measure.caches[m],before:!0}}}function GP(a,d){d=Mn(d);var p=N(d),h=a.display.externalMeasured=new A0(a.doc,d,p);h.lineN=p;var m=h.built=D0(a,h);return h.text=m.pre,W(a.display.lineMeasure,m.pre),h}function F0(a,d,p,h){return qn(a,Oa(a,d),p,h)}function Tp(a,d){if(d>=a.display.viewFrom&&d<a.display.viewTo)return a.display.view[Fs(a,d)];var p=a.display.externalMeasured;if(p&&d>=p.lineN&&d<p.lineN+p.size)return p}function Oa(a,d){var p=N(d),h=Tp(a,p);h&&!h.text?h=null:h&&h.changes&&(M0(a,h,p,Rp(a)),a.curOp.forceUpdate=!0),h||(h=GP(a,d));var m=_0(h,d,p);return{line:d,view:h,rect:null,map:m.map,cache:m.cache,before:m.before,hasHeights:!1}}function qn(a,d,p,h,m){d.before&&(p=-1);var b=p+(h||""),x;return d.cache.hasOwnProperty(b)?x=d.cache[b]:(d.rect||(d.rect=d.view.text.getBoundingClientRect()),d.hasHeights||(zP(a,d.view,d.rect),d.hasHeights=!0),x=$P(a,d,p,h),x.bogus||(d.cache[b]=x)),{left:x.left,right:x.right,top:m?x.rtop:x.top,bottom:m?x.rbottom:x.bottom}}var U0={left:0,right:0,top:0,bottom:0};function z0(a,d,p){for(var h,m,b,x,E,k,P=0;P<a.length;P+=3)if(E=a[P],k=a[P+1],d<E?(m=0,b=1,x="left"):d<k?(m=d-E,b=m+1):(P==a.length-3||d==k&&a[P+3]>d)&&(b=k-E,m=b-1,d>=k&&(x="right")),m!=null){if(h=a[P+2],E==k&&p==(h.insertLeft?"left":"right")&&(x=p),p=="left"&&m==0)for(;P&&a[P-2]==a[P-3]&&a[P-1].insertLeft;)h=a[(P-=3)+2],x="left";if(p=="right"&&m==k-E)for(;P<a.length-3&&a[P+3]==a[P+4]&&!a[P+5].insertLeft;)h=a[(P+=3)+2],x="right";break}return{node:h,start:m,end:b,collapse:x,coverStart:E,coverEnd:k}}function WP(a,d){var p=U0;if(d=="left")for(var h=0;h<a.length&&(p=a[h]).left==p.right;h++);else for(var m=a.length-1;m>=0&&(p=a[m]).left==p.right;m--);return p}function $P(a,d,p,h){var m=z0(d.map,p,h),b=m.node,x=m.start,E=m.end,k=m.collapse,P;if(b.nodeType==3){for(var z=0;z<4;z++){for(;x&&et(d.line.text.charAt(m.coverStart+x));)--x;for(;m.coverStart+E<m.coverEnd&&et(d.line.text.charAt(m.coverStart+E));)++E;if(c&&u<9&&x==0&&E==m.coverEnd-m.coverStart?P=b.parentNode.getBoundingClientRect():P=WP(de(b,x,E).getClientRects(),h),P.left||P.right||x==0)break;E=x,x=x-1,k="right"}c&&u<11&&(P=jP(a.display.measure,P))}else{x>0&&(k=h="right");var $;a.options.lineWrapping&&($=b.getClientRects()).length>1?P=$[h=="right"?$.length-1:0]:P=b.getBoundingClientRect()}if(c&&u<9&&!x&&(!P||!P.left&&!P.right)){var q=b.parentNode.getClientRects()[0];q?P={left:q.left,right:q.left+_a(a.display),top:q.top,bottom:q.bottom}:P=U0}for(var Z=P.top-d.rect.top,te=P.bottom-d.rect.top,ae=(Z+te)/2,pe=d.view.measure.heights,me=0;me<pe.length-1&&!(ae<pe[me]);me++);var Ce=me?pe[me-1]:0,ve=pe[me],ke={left:(k=="right"?P.right:P.left)-d.rect.left,right:(k=="left"?P.left:P.right)-d.rect.left,top:Ce,bottom:ve};return!P.left&&!P.right&&(ke.bogus=!0),a.options.singleCursorHeightPerLine||(ke.rtop=Z,ke.rbottom=te),ke}function jP(a,d){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!vp(a))return d;var p=screen.logicalXDPI/screen.deviceXDPI,h=screen.logicalYDPI/screen.deviceYDPI;return{left:d.left*p,right:d.right*p,top:d.top*h,bottom:d.bottom*h}}function G0(a){if(a.measure&&(a.measure.cache={},a.measure.heights=null,a.rest))for(var d=0;d<a.rest.length;d++)a.measure.caches[d]={}}function W0(a){a.display.externalMeasure=null,B(a.display.lineMeasure);for(var d=0;d<a.display.view.length;d++)G0(a.display.view[d])}function bl(a){W0(a),a.display.cachedCharWidth=a.display.cachedTextHeight=a.display.cachedPaddingH=null,a.options.lineWrapping||(a.display.maxLineChanged=!0),a.display.lineNumChars=null}function $0(a){return v&&M?-(a.body.getBoundingClientRect().left-parseInt(getComputedStyle(a.body).marginLeft)):a.defaultView.pageXOffset||(a.documentElement||a.body).scrollLeft}function j0(a){return v&&M?-(a.body.getBoundingClientRect().top-parseInt(getComputedStyle(a.body).marginTop)):a.defaultView.pageYOffset||(a.documentElement||a.body).scrollTop}function Dp(a){var d=Mn(a),p=d.widgets,h=0;if(p)for(var m=0;m<p.length;++m)p[m].above&&(h+=yl(p[m]));return h}function vc(a,d,p,h,m){if(!m){var b=Dp(d);p.top+=b,p.bottom+=b}if(h=="line")return p;h||(h="local");var x=br(d);if(h=="local"?x+=mc(a.display):x-=a.display.viewOffset,h=="page"||h=="window"){var E=a.display.lineSpace.getBoundingClientRect();x+=E.top+(h=="window"?0:j0(Ze(a)));var k=E.left+(h=="window"?0:$0(Ze(a)));p.left+=k,p.right+=k}return p.top+=x,p.bottom+=x,p}function H0(a,d,p){if(p=="div")return d;var h=d.left,m=d.top;if(p=="page")h-=$0(Ze(a)),m-=j0(Ze(a));else if(p=="local"||!p){var b=a.display.sizer.getBoundingClientRect();h+=b.left,m+=b.top}var x=a.display.lineSpace.getBoundingClientRect();return{left:h-x.left,top:m-x.top}}function yc(a,d,p,h,m){return h||(h=Ae(a.doc,d.line)),vc(a,h,F0(a,h,d.ch,m),p)}function Rn(a,d,p,h,m,b){h=h||Ae(a.doc,d.line),m||(m=Oa(a,h));function x(te,ae){var pe=qn(a,m,te,ae?"right":"left",b);return ae?pe.left=pe.right:pe.right=pe.left,vc(a,h,pe,p)}var E=Xe(h,a.doc.direction),k=d.ch,P=d.sticky;if(k>=h.text.length?(k=h.text.length,P="before"):k<=0&&(k=0,P="after"),!E)return x(P=="before"?k-1:k,P=="before");function z(te,ae,pe){var me=E[ae],Ce=me.level==1;return x(pe?te-1:te,Ce!=pe)}var $=Yr(E,k,P),q=Vs,Z=z(k,$,P=="before");return q!=null&&(Z.other=z(k,q,P!="before")),Z}function J0(a,d){var p=0;d=$e(a.doc,d),a.options.lineWrapping||(p=_a(a.display)*d.ch);var h=Ae(a.doc,d.line),m=br(h)+mc(a.display);return{left:p,right:p,top:m,bottom:m+h.height}}function Pp(a,d,p,h,m){var b=Q(a,d,p);return b.xRel=m,h&&(b.outside=h),b}function Ap(a,d,p){var h=a.doc;if(p+=a.display.viewOffset,p<0)return Pp(h.first,0,null,-1,-1);var m=G(h,p),b=h.first+h.size-1;if(m>b)return Pp(h.first+h.size-1,Ae(h,b).text.length,null,1,1);d<0&&(d=0);for(var x=Ae(h,m);;){var E=HP(a,x,m,d,p),k=SP(x,E.ch+(E.xRel>0||E.outside>0?1:0));if(!k)return E;var P=k.find(1);if(P.line==m)return P;x=Ae(h,m=P.line)}}function Z0(a,d,p,h){h-=Dp(d);var m=d.text.length,b=Kt(function(x){return qn(a,p,x-1).bottom<=h},m,0);return m=Kt(function(x){return qn(a,p,x).top>h},b,m),{begin:b,end:m}}function q0(a,d,p,h){p||(p=Oa(a,d));var m=vc(a,d,qn(a,p,h),"line").top;return Z0(a,d,p,m)}function Mp(a,d,p,h){return a.bottom<=p?!1:a.top>p?!0:(h?a.left:a.right)>d}function HP(a,d,p,h,m){m-=br(d);var b=Oa(a,d),x=Dp(d),E=0,k=d.text.length,P=!0,z=Xe(d,a.doc.direction);if(z){var $=(a.options.lineWrapping?ZP:JP)(a,d,p,b,z,h,m);P=$.level!=1,E=P?$.from:$.to-1,k=P?$.to:$.from-1}var q=null,Z=null,te=Kt(function(Fe){var Ve=qn(a,b,Fe);return Ve.top+=x,Ve.bottom+=x,Mp(Ve,h,m,!1)?(Ve.top<=m&&Ve.left<=h&&(q=Fe,Z=Ve),!0):!1},E,k),ae,pe,me=!1;if(Z){var Ce=h-Z.left<Z.right-h,ve=Ce==P;te=q+(ve?0:1),pe=ve?"after":"before",ae=Ce?Z.left:Z.right}else{!P&&(te==k||te==E)&&te++,pe=te==0?"after":te==d.text.length?"before":qn(a,b,te-(P?1:0)).bottom+x<=m==P?"after":"before";var ke=Rn(a,Q(p,te,pe),"line",d,b);ae=ke.left,me=m<ke.top?-1:m>=ke.bottom?1:0}return te=Ft(d.text,te,1),Pp(p,te,pe,me,h-ae)}function JP(a,d,p,h,m,b,x){var E=Kt(function($){var q=m[$],Z=q.level!=1;return Mp(Rn(a,Q(p,Z?q.to:q.from,Z?"before":"after"),"line",d,h),b,x,!0)},0,m.length-1),k=m[E];if(E>0){var P=k.level!=1,z=Rn(a,Q(p,P?k.from:k.to,P?"after":"before"),"line",d,h);Mp(z,b,x,!0)&&z.top>x&&(k=m[E-1])}return k}function ZP(a,d,p,h,m,b,x){var E=Z0(a,d,h,x),k=E.begin,P=E.end;/\s/.test(d.text.charAt(P-1))&&P--;for(var z=null,$=null,q=0;q<m.length;q++){var Z=m[q];if(!(Z.from>=P||Z.to<=k)){var te=Z.level!=1,ae=qn(a,h,te?Math.min(P,Z.to)-1:Math.max(k,Z.from)).right,pe=ae<b?b-ae+1e9:ae-b;(!z||$>pe)&&(z=Z,$=pe)}}return z||(z=m[m.length-1]),z.from<k&&(z={from:k,to:z.to,level:z.level}),z.to>P&&(z={from:z.from,to:P,level:z.level}),z}var Bs;function Ba(a){if(a.cachedTextHeight!=null)return a.cachedTextHeight;if(Bs==null){Bs=F("pre",null,"CodeMirror-line-like");for(var d=0;d<49;++d)Bs.appendChild(document.createTextNode("x")),Bs.appendChild(F("br"));Bs.appendChild(document.createTextNode("x"))}W(a.measure,Bs);var p=Bs.offsetHeight/50;return p>3&&(a.cachedTextHeight=p),B(a.measure),p||1}function _a(a){if(a.cachedCharWidth!=null)return a.cachedCharWidth;var d=F("span","xxxxxxxxxx"),p=F("pre",[d],"CodeMirror-line-like");W(a.measure,p);var h=d.getBoundingClientRect(),m=(h.right-h.left)/10;return m>2&&(a.cachedCharWidth=m),m||10}function Rp(a){for(var d=a.display,p={},h={},m=d.gutters.clientLeft,b=d.gutters.firstChild,x=0;b;b=b.nextSibling,++x){var E=a.display.gutterSpecs[x].className;p[E]=b.offsetLeft+b.clientLeft+m,h[E]=b.clientWidth}return{fixedPos:Np(d),gutterTotalWidth:d.gutters.offsetWidth,gutterLeft:p,gutterWidth:h,wrapperWidth:d.wrapper.clientWidth}}function Np(a){return a.scroller.getBoundingClientRect().left-a.sizer.getBoundingClientRect().left}function Y0(a){var d=Ba(a.display),p=a.options.lineWrapping,h=p&&Math.max(5,a.display.scroller.clientWidth/_a(a.display)-3);return function(m){if(ts(a.doc,m))return 0;var b=0;if(m.widgets)for(var x=0;x<m.widgets.length;x++)m.widgets[x].height&&(b+=m.widgets[x].height);return p?b+(Math.ceil(m.text.length/h)||1)*d:b+d}}function Vp(a){var d=a.doc,p=Y0(a);d.iter(function(h){var m=p(h);m!=h.height&&Qi(h,m)})}function _s(a,d,p,h){var m=a.display;if(!p&&cl(d).getAttribute("cm-not-content")=="true")return null;var b,x,E=m.lineSpace.getBoundingClientRect();try{b=d.clientX-E.left,x=d.clientY-E.top}catch{return null}var k=Ap(a,b,x),P;if(h&&k.xRel>0&&(P=Ae(a.doc,k.line).text).length==k.ch){var z=We(P,P.length,a.options.tabSize)-P.length;k=Q(k.line,Math.max(0,Math.round((b-B0(a.display).left)/_a(a.display))-z))}return k}function Fs(a,d){if(d>=a.display.viewTo||(d-=a.display.viewFrom,d<0))return null;for(var p=a.display.view,h=0;h<p.length;h++)if(d-=p[h].size,d<0)return h}function Ni(a,d,p,h){d==null&&(d=a.doc.first),p==null&&(p=a.doc.first+a.doc.size),h||(h=0);var m=a.display;if(h&&p<m.viewTo&&(m.updateLineNumbers==null||m.updateLineNumbers>d)&&(m.updateLineNumbers=d),a.curOp.viewChanged=!0,d>=m.viewTo)yr&&Cp(a.doc,d)<m.viewTo&&ns(a);else if(p<=m.viewFrom)yr&&I0(a.doc,p+h)>m.viewFrom?ns(a):(m.viewFrom+=h,m.viewTo+=h);else if(d<=m.viewFrom&&p>=m.viewTo)ns(a);else if(d<=m.viewFrom){var b=bc(a,p,p+h,1);b?(m.view=m.view.slice(b.index),m.viewFrom=b.lineN,m.viewTo+=h):ns(a)}else if(p>=m.viewTo){var x=bc(a,d,d,-1);x?(m.view=m.view.slice(0,x.index),m.viewTo=x.lineN):ns(a)}else{var E=bc(a,d,d,-1),k=bc(a,p,p+h,1);E&&k?(m.view=m.view.slice(0,E.index).concat(gc(a,E.lineN,k.lineN)).concat(m.view.slice(k.index)),m.viewTo+=h):ns(a)}var P=m.externalMeasured;P&&(p<P.lineN?P.lineN+=h:d<P.lineN+P.size&&(m.externalMeasured=null))}function is(a,d,p){a.curOp.viewChanged=!0;var h=a.display,m=a.display.externalMeasured;if(m&&d>=m.lineN&&d<m.lineN+m.size&&(h.externalMeasured=null),!(d<h.viewFrom||d>=h.viewTo)){var b=h.view[Fs(a,d)];if(b.node!=null){var x=b.changes||(b.changes=[]);De(x,p)==-1&&x.push(p)}}}function ns(a){a.display.viewFrom=a.display.viewTo=a.doc.first,a.display.view=[],a.display.viewOffset=0}function bc(a,d,p,h){var m=Fs(a,d),b,x=a.display.view;if(!yr||p==a.doc.first+a.doc.size)return{index:m,lineN:p};for(var E=a.display.viewFrom,k=0;k<m;k++)E+=x[k].size;if(E!=d){if(h>0){if(m==x.length-1)return null;b=E+x[m].size-d,m++}else b=E-d;d+=b,p+=b}for(;Cp(a.doc,p)!=p;){if(m==(h<0?0:x.length-1))return null;p+=h*x[m-(h<0?1:0)].size,m+=h}return{index:m,lineN:p}}function qP(a,d,p){var h=a.display,m=h.view;m.length==0||d>=h.viewTo||p<=h.viewFrom?(h.view=gc(a,d,p),h.viewFrom=d):(h.viewFrom>d?h.view=gc(a,d,h.viewFrom).concat(h.view):h.viewFrom<d&&(h.view=h.view.slice(Fs(a,d))),h.viewFrom=d,h.viewTo<p?h.view=h.view.concat(gc(a,h.viewTo,p)):h.viewTo>p&&(h.view=h.view.slice(0,Fs(a,p)))),h.viewTo=p}function K0(a){for(var d=a.display.view,p=0,h=0;h<d.length;h++){var m=d[h];!m.hidden&&(!m.node||m.changes)&&++p}return p}function Sl(a){a.display.input.showSelection(a.display.input.prepareSelection())}function X0(a,d){d===void 0&&(d=!0);var p=a.doc,h={},m=h.cursors=document.createDocumentFragment(),b=h.selection=document.createDocumentFragment(),x=a.options.$customCursor;x&&(d=!0);for(var E=0;E<p.sel.ranges.length;E++)if(!(!d&&E==p.sel.primIndex)){var k=p.sel.ranges[E];if(!(k.from().line>=a.display.viewTo||k.to().line<a.display.viewFrom)){var P=k.empty();if(x){var z=x(a,k);z&&Op(a,z,m)}else(P||a.options.showCursorWhenSelecting)&&Op(a,k.head,m);P||YP(a,k,b)}}return h}function Op(a,d,p){var h=Rn(a,d,"div",null,null,!a.options.singleCursorHeightPerLine),m=p.appendChild(F("div"," ","CodeMirror-cursor"));if(m.style.left=h.left+"px",m.style.top=h.top+"px",m.style.height=Math.max(0,h.bottom-h.top)*a.options.cursorHeight+"px",/\bcm-fat-cursor\b/.test(a.getWrapperElement().className)){var b=yc(a,d,"div",null,null),x=b.right-b.left;m.style.width=(x>0?x:a.defaultCharWidth())+"px"}if(h.other){var E=p.appendChild(F("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));E.style.display="",E.style.left=h.other.left+"px",E.style.top=h.other.top+"px",E.style.height=(h.other.bottom-h.other.top)*.85+"px"}}function Sc(a,d){return a.top-d.top||a.left-d.left}function YP(a,d,p){var h=a.display,m=a.doc,b=document.createDocumentFragment(),x=B0(a.display),E=x.left,k=Math.max(h.sizerWidth,Os(a)-h.sizer.offsetLeft)-x.right,P=m.direction=="ltr";function z(ve,ke,Fe,Ve){ke<0&&(ke=0),ke=Math.round(ke),Ve=Math.round(Ve),b.appendChild(F("div",null,"CodeMirror-selected","position: absolute; left: "+ve+`px;
                             top: `+ke+"px; width: "+(Fe??k-ve)+`px;
                             height: `+(Ve-ke)+"px"))}function $(ve,ke,Fe){var Ve=Ae(m,ve),Ye=Ve.text.length,xt,si;function At(Ht,Bi){return yc(a,Q(ve,Ht),"div",Ve,Bi)}function Ji(Ht,Bi,ui){var Xt=q0(a,Ve,null,Ht),Jt=Bi=="ltr"==(ui=="after")?"left":"right",Vt=ui=="after"?Xt.begin:Xt.end-(/\s/.test(Ve.text.charAt(Xt.end-1))?2:1);return At(Vt,Jt)[Jt]}var Oi=Xe(Ve,m.direction);return kn(Oi,ke||0,Fe??Ye,function(Ht,Bi,ui,Xt){var Jt=ui=="ltr",Vt=At(Ht,Jt?"left":"right"),_i=At(Bi-1,Jt?"right":"left"),Ka=ke==null&&Ht==0,ds=Fe==null&&Bi==Ye,Si=Xt==0,Yn=!Oi||Xt==Oi.length-1;if(_i.top-Vt.top<=3){var ai=(P?Ka:ds)&&Si,cf=(P?ds:Ka)&&Yn,xr=ai?E:(Jt?Vt:_i).left,$s=cf?k:(Jt?_i:Vt).right;z(xr,Vt.top,$s-xr,Vt.bottom)}else{var js,Ei,Xa,uf;Jt?(js=P&&Ka&&Si?E:Vt.left,Ei=P?k:Ji(Ht,ui,"before"),Xa=P?E:Ji(Bi,ui,"after"),uf=P&&ds&&Yn?k:_i.right):(js=P?Ji(Ht,ui,"before"):E,Ei=!P&&Ka&&Si?k:Vt.right,Xa=!P&&ds&&Yn?E:_i.left,uf=P?Ji(Bi,ui,"after"):k),z(js,Vt.top,Ei-js,Vt.bottom),Vt.bottom<_i.top&&z(E,Vt.bottom,null,_i.top),z(Xa,_i.top,uf-Xa,_i.bottom)}(!xt||Sc(Vt,xt)<0)&&(xt=Vt),Sc(_i,xt)<0&&(xt=_i),(!si||Sc(Vt,si)<0)&&(si=Vt),Sc(_i,si)<0&&(si=_i)}),{start:xt,end:si}}var q=d.from(),Z=d.to();if(q.line==Z.line)$(q.line,q.ch,Z.ch);else{var te=Ae(m,q.line),ae=Ae(m,Z.line),pe=Mn(te)==Mn(ae),me=$(q.line,q.ch,pe?te.text.length+1:null).end,Ce=$(Z.line,pe?0:null,Z.ch).start;pe&&(me.top<Ce.top-2?(z(me.right,me.top,null,me.bottom),z(E,Ce.top,Ce.left,Ce.bottom)):z(me.right,me.top,Ce.left-me.right,me.bottom)),me.bottom<Ce.top&&z(E,me.bottom,null,Ce.top)}p.appendChild(b)}function Bp(a){if(a.state.focused){var d=a.display;clearInterval(d.blinker);var p=!0;d.cursorDiv.style.visibility="",a.options.cursorBlinkRate>0?d.blinker=setInterval(function(){a.hasFocus()||Fa(a),d.cursorDiv.style.visibility=(p=!p)?"":"hidden"},a.options.cursorBlinkRate):a.options.cursorBlinkRate<0&&(d.cursorDiv.style.visibility="hidden")}}function Q0(a){a.hasFocus()||(a.display.input.focus(),a.state.focused||Fp(a))}function _p(a){a.state.delayingBlurEvent=!0,setTimeout(function(){a.state.delayingBlurEvent&&(a.state.delayingBlurEvent=!1,a.state.focused&&Fa(a))},100)}function Fp(a,d){a.state.delayingBlurEvent&&!a.state.draggingText&&(a.state.delayingBlurEvent=!1),a.options.readOnly!="nocursor"&&(a.state.focused||(Mt(a,"focus",a,d),a.state.focused=!0,Le(a.display.wrapper,"CodeMirror-focused"),!a.curOp&&a.display.selForContextMenu!=a.doc.sel&&(a.display.input.reset(),f&&setTimeout(function(){return a.display.input.reset(!0)},20)),a.display.input.receivedFocus()),Bp(a))}function Fa(a,d){a.state.delayingBlurEvent||(a.state.focused&&(Mt(a,"blur",a,d),a.state.focused=!1,U(a.display.wrapper,"CodeMirror-focused")),clearInterval(a.display.blinker),setTimeout(function(){a.state.focused||(a.display.shift=!1)},150))}function wc(a){for(var d=a.display,p=d.lineDiv.offsetTop,h=Math.max(0,d.scroller.getBoundingClientRect().top),m=d.lineDiv.getBoundingClientRect().top,b=0,x=0;x<d.view.length;x++){var E=d.view[x],k=a.options.lineWrapping,P=void 0,z=0;if(!E.hidden){if(m+=E.line.height,c&&u<8){var $=E.node.offsetTop+E.node.offsetHeight;P=$-p,p=$}else{var q=E.node.getBoundingClientRect();P=q.bottom-q.top,!k&&E.text.firstChild&&(z=E.text.firstChild.getBoundingClientRect().right-q.left-1)}var Z=E.line.height-P;if((Z>.005||Z<-.005)&&(m<h&&(b-=Z),Qi(E.line,P),eb(E.line),E.rest))for(var te=0;te<E.rest.length;te++)eb(E.rest[te]);if(z>a.display.sizerWidth){var ae=Math.ceil(z/_a(a.display));ae>a.display.maxLineLength&&(a.display.maxLineLength=ae,a.display.maxLine=E.line,a.display.maxLineChanged=!0)}}}Math.abs(b)>2&&(d.scroller.scrollTop+=b)}function eb(a){if(a.widgets)for(var d=0;d<a.widgets.length;++d){var p=a.widgets[d],h=p.node.parentNode;h&&(p.height=h.offsetHeight)}}function Cc(a,d,p){var h=p&&p.top!=null?Math.max(0,p.top):a.scroller.scrollTop;h=Math.floor(h-mc(a));var m=p&&p.bottom!=null?p.bottom:h+a.wrapper.clientHeight,b=G(d,h),x=G(d,m);if(p&&p.ensure){var E=p.ensure.from.line,k=p.ensure.to.line;E<b?(b=E,x=G(d,br(Ae(d,E))+a.wrapper.clientHeight)):Math.min(k,d.lastLine())>=x&&(b=G(d,br(Ae(d,k))-a.wrapper.clientHeight),x=k)}return{from:b,to:Math.max(x,b+1)}}function KP(a,d){if(!Rt(a,"scrollCursorIntoView")){var p=a.display,h=p.sizer.getBoundingClientRect(),m=null,b=p.wrapper.ownerDocument;if(d.top+h.top<0?m=!0:d.bottom+h.top>(b.defaultView.innerHeight||b.documentElement.clientHeight)&&(m=!1),m!=null&&!L){var x=F("div","​",null,`position: absolute;
                         top: `+(d.top-p.viewOffset-mc(a.display))+`px;
                         height: `+(d.bottom-d.top+Zn(a)+p.barHeight)+`px;
                         left: `+d.left+"px; width: "+Math.max(2,d.right-d.left)+"px;");a.display.lineSpace.appendChild(x),x.scrollIntoView(m),a.display.lineSpace.removeChild(x)}}}function XP(a,d,p,h){h==null&&(h=0);var m;!a.options.lineWrapping&&d==p&&(p=d.sticky=="before"?Q(d.line,d.ch+1,"before"):d,d=d.ch?Q(d.line,d.sticky=="before"?d.ch-1:d.ch,"after"):d);for(var b=0;b<5;b++){var x=!1,E=Rn(a,d),k=!p||p==d?E:Rn(a,p);m={left:Math.min(E.left,k.left),top:Math.min(E.top,k.top)-h,right:Math.max(E.left,k.left),bottom:Math.max(E.bottom,k.bottom)+h};var P=Up(a,m),z=a.doc.scrollTop,$=a.doc.scrollLeft;if(P.scrollTop!=null&&(Cl(a,P.scrollTop),Math.abs(a.doc.scrollTop-z)>1&&(x=!0)),P.scrollLeft!=null&&(Us(a,P.scrollLeft),Math.abs(a.doc.scrollLeft-$)>1&&(x=!0)),!x)break}return m}function QP(a,d){var p=Up(a,d);p.scrollTop!=null&&Cl(a,p.scrollTop),p.scrollLeft!=null&&Us(a,p.scrollLeft)}function Up(a,d){var p=a.display,h=Ba(a.display);d.top<0&&(d.top=0);var m=a.curOp&&a.curOp.scrollTop!=null?a.curOp.scrollTop:p.scroller.scrollTop,b=Ip(a),x={};d.bottom-d.top>b&&(d.bottom=d.top+b);var E=a.doc.height+kp(p),k=d.top<h,P=d.bottom>E-h;if(d.top<m)x.scrollTop=k?0:d.top;else if(d.bottom>m+b){var z=Math.min(d.top,(P?E:d.bottom)-b);z!=m&&(x.scrollTop=z)}var $=a.options.fixedGutter?0:p.gutters.offsetWidth,q=a.curOp&&a.curOp.scrollLeft!=null?a.curOp.scrollLeft:p.scroller.scrollLeft-$,Z=Os(a)-p.gutters.offsetWidth,te=d.right-d.left>Z;return te&&(d.right=d.left+Z),d.left<10?x.scrollLeft=0:d.left<q?x.scrollLeft=Math.max(0,d.left+$-(te?0:10)):d.right>Z+q-3&&(x.scrollLeft=d.right+(te?0:10)-Z),x}function zp(a,d){d!=null&&(xc(a),a.curOp.scrollTop=(a.curOp.scrollTop==null?a.doc.scrollTop:a.curOp.scrollTop)+d)}function Ua(a){xc(a);var d=a.getCursor();a.curOp.scrollToPos={from:d,to:d,margin:a.options.cursorScrollMargin}}function wl(a,d,p){(d!=null||p!=null)&&xc(a),d!=null&&(a.curOp.scrollLeft=d),p!=null&&(a.curOp.scrollTop=p)}function eA(a,d){xc(a),a.curOp.scrollToPos=d}function xc(a){var d=a.curOp.scrollToPos;if(d){a.curOp.scrollToPos=null;var p=J0(a,d.from),h=J0(a,d.to);tb(a,p,h,d.margin)}}function tb(a,d,p,h){var m=Up(a,{left:Math.min(d.left,p.left),top:Math.min(d.top,p.top)-h,right:Math.max(d.right,p.right),bottom:Math.max(d.bottom,p.bottom)+h});wl(a,m.scrollLeft,m.scrollTop)}function Cl(a,d){Math.abs(a.doc.scrollTop-d)<2||(r||Wp(a,{top:d}),ib(a,d,!0),r&&Wp(a),Ll(a,100))}function ib(a,d,p){d=Math.max(0,Math.min(a.display.scroller.scrollHeight-a.display.scroller.clientHeight,d)),!(a.display.scroller.scrollTop==d&&!p)&&(a.doc.scrollTop=d,a.display.scrollbars.setScrollTop(d),a.display.scroller.scrollTop!=d&&(a.display.scroller.scrollTop=d))}function Us(a,d,p,h){d=Math.max(0,Math.min(d,a.display.scroller.scrollWidth-a.display.scroller.clientWidth)),!((p?d==a.doc.scrollLeft:Math.abs(a.doc.scrollLeft-d)<2)&&!h)&&(a.doc.scrollLeft=d,ob(a),a.display.scroller.scrollLeft!=d&&(a.display.scroller.scrollLeft=d),a.display.scrollbars.setScrollLeft(d))}function xl(a){var d=a.display,p=d.gutters.offsetWidth,h=Math.round(a.doc.height+kp(a.display));return{clientHeight:d.scroller.clientHeight,viewHeight:d.wrapper.clientHeight,scrollWidth:d.scroller.scrollWidth,clientWidth:d.scroller.clientWidth,viewWidth:d.wrapper.clientWidth,barLeft:a.options.fixedGutter?p:0,docHeight:h,scrollHeight:h+Zn(a)+d.barHeight,nativeBarWidth:d.nativeBarWidth,gutterWidth:p}}var zs=function(a,d,p){this.cm=p;var h=this.vert=F("div",[F("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),m=this.horiz=F("div",[F("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");h.tabIndex=m.tabIndex=-1,a(h),a(m),Oe(h,"scroll",function(){h.clientHeight&&d(h.scrollTop,"vertical")}),Oe(m,"scroll",function(){m.clientWidth&&d(m.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,c&&u<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};zs.prototype.update=function(a){var d=a.scrollWidth>a.clientWidth+1,p=a.scrollHeight>a.clientHeight+1,h=a.nativeBarWidth;if(p){this.vert.style.display="block",this.vert.style.bottom=d?h+"px":"0";var m=a.viewHeight-(d?h:0);this.vert.firstChild.style.height=Math.max(0,a.scrollHeight-a.clientHeight+m)+"px"}else this.vert.scrollTop=0,this.vert.style.display="",this.vert.firstChild.style.height="0";if(d){this.horiz.style.display="block",this.horiz.style.right=p?h+"px":"0",this.horiz.style.left=a.barLeft+"px";var b=a.viewWidth-a.barLeft-(p?h:0);this.horiz.firstChild.style.width=Math.max(0,a.scrollWidth-a.clientWidth+b)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&a.clientHeight>0&&(h==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:p?h:0,bottom:d?h:0}},zs.prototype.setScrollLeft=function(a){this.horiz.scrollLeft!=a&&(this.horiz.scrollLeft=a),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},zs.prototype.setScrollTop=function(a){this.vert.scrollTop!=a&&(this.vert.scrollTop=a),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},zs.prototype.zeroWidthHack=function(){var a=D&&!S?"12px":"18px";this.horiz.style.height=this.vert.style.width=a,this.horiz.style.visibility=this.vert.style.visibility="hidden",this.disableHoriz=new Ge,this.disableVert=new Ge},zs.prototype.enableZeroWidthBar=function(a,d,p){a.style.visibility="";function h(){var m=a.getBoundingClientRect(),b=p=="vert"?document.elementFromPoint(m.right-1,(m.top+m.bottom)/2):document.elementFromPoint((m.right+m.left)/2,m.bottom-1);b!=a?a.style.visibility="hidden":d.set(1e3,h)}d.set(1e3,h)},zs.prototype.clear=function(){var a=this.horiz.parentNode;a.removeChild(this.horiz),a.removeChild(this.vert)};var El=function(){};El.prototype.update=function(){return{bottom:0,right:0}},El.prototype.setScrollLeft=function(){},El.prototype.setScrollTop=function(){},El.prototype.clear=function(){};function za(a,d){d||(d=xl(a));var p=a.display.barWidth,h=a.display.barHeight;nb(a,d);for(var m=0;m<4&&p!=a.display.barWidth||h!=a.display.barHeight;m++)p!=a.display.barWidth&&a.options.lineWrapping&&wc(a),nb(a,xl(a)),p=a.display.barWidth,h=a.display.barHeight}function nb(a,d){var p=a.display,h=p.scrollbars.update(d);p.sizer.style.paddingRight=(p.barWidth=h.right)+"px",p.sizer.style.paddingBottom=(p.barHeight=h.bottom)+"px",p.heightForcer.style.borderBottom=h.bottom+"px solid transparent",h.right&&h.bottom?(p.scrollbarFiller.style.display="block",p.scrollbarFiller.style.height=h.bottom+"px",p.scrollbarFiller.style.width=h.right+"px"):p.scrollbarFiller.style.display="",h.bottom&&a.options.coverGutterNextToScrollbar&&a.options.fixedGutter?(p.gutterFiller.style.display="block",p.gutterFiller.style.height=h.bottom+"px",p.gutterFiller.style.width=d.gutterWidth+"px"):p.gutterFiller.style.display=""}var rb={native:zs,null:El};function sb(a){a.display.scrollbars&&(a.display.scrollbars.clear(),a.display.scrollbars.addClass&&U(a.display.wrapper,a.display.scrollbars.addClass)),a.display.scrollbars=new rb[a.options.scrollbarStyle](function(d){a.display.wrapper.insertBefore(d,a.display.scrollbarFiller),Oe(d,"mousedown",function(){a.state.focused&&setTimeout(function(){return a.display.input.focus()},0)}),d.setAttribute("cm-not-content","true")},function(d,p){p=="horizontal"?Us(a,d):Cl(a,d)},a),a.display.scrollbars.addClass&&Le(a.display.wrapper,a.display.scrollbars.addClass)}var tA=0;function Gs(a){a.curOp={cm:a,viewChanged:!1,startHeight:a.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++tA,markArrays:null},MP(a.curOp)}function Ws(a){var d=a.curOp;d&&NP(d,function(p){for(var h=0;h<p.ops.length;h++)p.ops[h].cm.curOp=null;iA(p)})}function iA(a){for(var d=a.ops,p=0;p<d.length;p++)nA(d[p]);for(var h=0;h<d.length;h++)rA(d[h]);for(var m=0;m<d.length;m++)sA(d[m]);for(var b=0;b<d.length;b++)aA(d[b]);for(var x=0;x<d.length;x++)oA(d[x])}function nA(a){var d=a.cm,p=d.display;dA(d),a.updateMaxLine&&Ep(d),a.mustUpdate=a.viewChanged||a.forceUpdate||a.scrollTop!=null||a.scrollToPos&&(a.scrollToPos.from.line<p.viewFrom||a.scrollToPos.to.line>=p.viewTo)||p.maxLineChanged&&d.options.lineWrapping,a.update=a.mustUpdate&&new Ec(d,a.mustUpdate&&{top:a.scrollTop,ensure:a.scrollToPos},a.forceUpdate)}function rA(a){a.updatedDisplay=a.mustUpdate&&Gp(a.cm,a.update)}function sA(a){var d=a.cm,p=d.display;a.updatedDisplay&&wc(d),a.barMeasure=xl(d),p.maxLineChanged&&!d.options.lineWrapping&&(a.adjustWidthTo=F0(d,p.maxLine,p.maxLine.text.length).left+3,d.display.sizerWidth=a.adjustWidthTo,a.barMeasure.scrollWidth=Math.max(p.scroller.clientWidth,p.sizer.offsetLeft+a.adjustWidthTo+Zn(d)+d.display.barWidth),a.maxScrollLeft=Math.max(0,p.sizer.offsetLeft+a.adjustWidthTo-Os(d))),(a.updatedDisplay||a.selectionChanged)&&(a.preparedSelection=p.input.prepareSelection())}function aA(a){var d=a.cm;a.adjustWidthTo!=null&&(d.display.sizer.style.minWidth=a.adjustWidthTo+"px",a.maxScrollLeft<d.doc.scrollLeft&&Us(d,Math.min(d.display.scroller.scrollLeft,a.maxScrollLeft),!0),d.display.maxLineChanged=!1);var p=a.focus&&a.focus==ce(it(d));a.preparedSelection&&d.display.input.showSelection(a.preparedSelection,p),(a.updatedDisplay||a.startHeight!=d.doc.height)&&za(d,a.barMeasure),a.updatedDisplay&&jp(d,a.barMeasure),a.selectionChanged&&Bp(d),d.state.focused&&a.updateInput&&d.display.input.reset(a.typing),p&&Q0(a.cm)}function oA(a){var d=a.cm,p=d.display,h=d.doc;if(a.updatedDisplay&&ab(d,a.update),p.wheelStartX!=null&&(a.scrollTop!=null||a.scrollLeft!=null||a.scrollToPos)&&(p.wheelStartX=p.wheelStartY=null),a.scrollTop!=null&&ib(d,a.scrollTop,a.forceScroll),a.scrollLeft!=null&&Us(d,a.scrollLeft,!0,!0),a.scrollToPos){var m=XP(d,$e(h,a.scrollToPos.from),$e(h,a.scrollToPos.to),a.scrollToPos.margin);KP(d,m)}var b=a.maybeHiddenMarkers,x=a.maybeUnhiddenMarkers;if(b)for(var E=0;E<b.length;++E)b[E].lines.length||Mt(b[E],"hide");if(x)for(var k=0;k<x.length;++k)x[k].lines.length&&Mt(x[k],"unhide");p.wrapper.offsetHeight&&(h.scrollTop=d.display.scroller.scrollTop),a.changeObjs&&Mt(d,"changes",d,a.changeObjs),a.update&&a.update.finish()}function Hi(a,d){if(a.curOp)return d();Gs(a);try{return d()}finally{Ws(a)}}function ni(a,d){return function(){if(a.curOp)return d.apply(a,arguments);Gs(a);try{return d.apply(a,arguments)}finally{Ws(a)}}}function xi(a){return function(){if(this.curOp)return a.apply(this,arguments);Gs(this);try{return a.apply(this,arguments)}finally{Ws(this)}}}function ri(a){return function(){var d=this.cm;if(!d||d.curOp)return a.apply(this,arguments);Gs(d);try{return a.apply(this,arguments)}finally{Ws(d)}}}function Ll(a,d){a.doc.highlightFrontier<a.display.viewTo&&a.state.highlight.set(d,Pe(lA,a))}function lA(a){var d=a.doc;if(!(d.highlightFrontier>=a.display.viewTo)){var p=+new Date+a.options.workTime,h=fl(a,d.highlightFrontier),m=[];d.iter(h.line,Math.min(d.first+d.size,a.display.viewTo+500),function(b){if(h.line>=a.display.viewFrom){var x=b.styles,E=b.text.length>a.options.maxHighlightLength?Hn(d.mode,h.state):null,k=p0(a,b,h,!0);E&&(h.state=E),b.styles=k.styles;var P=b.styleClasses,z=k.classes;z?b.styleClasses=z:P&&(b.styleClasses=null);for(var $=!x||x.length!=b.styles.length||P!=z&&(!P||!z||P.bgClass!=z.bgClass||P.textClass!=z.textClass),q=0;!$&&q<x.length;++q)$=x[q]!=b.styles[q];$&&m.push(h.line),b.stateAfter=h.save(),h.nextLine()}else b.text.length<=a.options.maxHighlightLength&&yp(a,b.text,h),b.stateAfter=h.line%5==0?h.save():null,h.nextLine();if(+new Date>p)return Ll(a,a.options.workDelay),!0}),d.highlightFrontier=h.line,d.modeFrontier=Math.max(d.modeFrontier,h.line),m.length&&Hi(a,function(){for(var b=0;b<m.length;b++)is(a,m[b],"text")})}}var Ec=function(a,d,p){var h=a.display;this.viewport=d,this.visible=Cc(h,a.doc,d),this.editorIsHidden=!h.wrapper.offsetWidth,this.wrapperHeight=h.wrapper.clientHeight,this.wrapperWidth=h.wrapper.clientWidth,this.oldDisplayWidth=Os(a),this.force=p,this.dims=Rp(a),this.events=[]};Ec.prototype.signal=function(a,d){ji(a,d)&&this.events.push(arguments)},Ec.prototype.finish=function(){for(var a=0;a<this.events.length;a++)Mt.apply(null,this.events[a])};function dA(a){var d=a.display;!d.scrollbarsClipped&&d.scroller.offsetWidth&&(d.nativeBarWidth=d.scroller.offsetWidth-d.scroller.clientWidth,d.heightForcer.style.height=Zn(a)+"px",d.sizer.style.marginBottom=-d.nativeBarWidth+"px",d.sizer.style.borderRightWidth=Zn(a)+"px",d.scrollbarsClipped=!0)}function cA(a){if(a.hasFocus())return null;var d=ce(it(a));if(!d||!Re(a.display.lineDiv,d))return null;var p={activeElt:d};if(window.getSelection){var h=ze(a).getSelection();h.anchorNode&&h.extend&&Re(a.display.lineDiv,h.anchorNode)&&(p.anchorNode=h.anchorNode,p.anchorOffset=h.anchorOffset,p.focusNode=h.focusNode,p.focusOffset=h.focusOffset)}return p}function uA(a){if(!(!a||!a.activeElt||a.activeElt==ce(ot(a.activeElt)))&&(a.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(a.activeElt.nodeName)&&a.anchorNode&&Re(document.body,a.anchorNode)&&Re(document.body,a.focusNode))){var d=a.activeElt.ownerDocument,p=d.defaultView.getSelection(),h=d.createRange();h.setEnd(a.anchorNode,a.anchorOffset),h.collapse(!1),p.removeAllRanges(),p.addRange(h),p.extend(a.focusNode,a.focusOffset)}}function Gp(a,d){var p=a.display,h=a.doc;if(d.editorIsHidden)return ns(a),!1;if(!d.force&&d.visible.from>=p.viewFrom&&d.visible.to<=p.viewTo&&(p.updateLineNumbers==null||p.updateLineNumbers>=p.viewTo)&&p.renderedView==p.view&&K0(a)==0)return!1;lb(a)&&(ns(a),d.dims=Rp(a));var m=h.first+h.size,b=Math.max(d.visible.from-a.options.viewportMargin,h.first),x=Math.min(m,d.visible.to+a.options.viewportMargin);p.viewFrom<b&&b-p.viewFrom<20&&(b=Math.max(h.first,p.viewFrom)),p.viewTo>x&&p.viewTo-x<20&&(x=Math.min(m,p.viewTo)),yr&&(b=Cp(a.doc,b),x=I0(a.doc,x));var E=b!=p.viewFrom||x!=p.viewTo||p.lastWrapHeight!=d.wrapperHeight||p.lastWrapWidth!=d.wrapperWidth;qP(a,b,x),p.viewOffset=br(Ae(a.doc,p.viewFrom)),a.display.mover.style.top=p.viewOffset+"px";var k=K0(a);if(!E&&k==0&&!d.force&&p.renderedView==p.view&&(p.updateLineNumbers==null||p.updateLineNumbers>=p.viewTo))return!1;var P=cA(a);return k>4&&(p.lineDiv.style.display="none"),hA(a,p.updateLineNumbers,d.dims),k>4&&(p.lineDiv.style.display=""),p.renderedView=p.view,uA(P),B(p.cursorDiv),B(p.selectionDiv),p.gutters.style.height=p.sizer.style.minHeight=0,E&&(p.lastWrapHeight=d.wrapperHeight,p.lastWrapWidth=d.wrapperWidth,Ll(a,400)),p.updateLineNumbers=null,!0}function ab(a,d){for(var p=d.viewport,h=!0;;h=!1){if(!h||!a.options.lineWrapping||d.oldDisplayWidth==Os(a)){if(p&&p.top!=null&&(p={top:Math.min(a.doc.height+kp(a.display)-Ip(a),p.top)}),d.visible=Cc(a.display,a.doc,p),d.visible.from>=a.display.viewFrom&&d.visible.to<=a.display.viewTo)break}else h&&(d.visible=Cc(a.display,a.doc,p));if(!Gp(a,d))break;wc(a);var m=xl(a);Sl(a),za(a,m),jp(a,m),d.force=!1}d.signal(a,"update",a),(a.display.viewFrom!=a.display.reportedViewFrom||a.display.viewTo!=a.display.reportedViewTo)&&(d.signal(a,"viewportChange",a,a.display.viewFrom,a.display.viewTo),a.display.reportedViewFrom=a.display.viewFrom,a.display.reportedViewTo=a.display.viewTo)}function Wp(a,d){var p=new Ec(a,d);if(Gp(a,p)){wc(a),ab(a,p);var h=xl(a);Sl(a),za(a,h),jp(a,h),p.finish()}}function hA(a,d,p){var h=a.display,m=a.options.lineNumbers,b=h.lineDiv,x=b.firstChild;function E(te){var ae=te.nextSibling;return f&&D&&a.display.currentWheelTarget==te?te.style.display="none":te.parentNode.removeChild(te),ae}for(var k=h.view,P=h.viewFrom,z=0;z<k.length;z++){var $=k[z];if(!$.hidden)if(!$.node||$.node.parentNode!=b){var q=FP(a,$,P,p);b.insertBefore(q,x)}else{for(;x!=$.node;)x=E(x);var Z=m&&d!=null&&d<=P&&$.lineNumber;$.changes&&(De($.changes,"gutter")>-1&&(Z=!1),M0(a,$,P,p)),Z&&(B($.lineNumber),$.lineNumber.appendChild(document.createTextNode(he(a.options,P)))),x=$.node.nextSibling}P+=$.size}for(;x;)x=E(x)}function $p(a){var d=a.gutters.offsetWidth;a.sizer.style.marginLeft=d+"px",ii(a,"gutterChanged",a)}function jp(a,d){a.display.sizer.style.minHeight=d.docHeight+"px",a.display.heightForcer.style.top=d.docHeight+"px",a.display.gutters.style.height=d.docHeight+a.display.barHeight+Zn(a)+"px"}function ob(a){var d=a.display,p=d.view;if(!(!d.alignWidgets&&(!d.gutters.firstChild||!a.options.fixedGutter))){for(var h=Np(d)-d.scroller.scrollLeft+a.doc.scrollLeft,m=d.gutters.offsetWidth,b=h+"px",x=0;x<p.length;x++)if(!p[x].hidden){a.options.fixedGutter&&(p[x].gutter&&(p[x].gutter.style.left=b),p[x].gutterBackground&&(p[x].gutterBackground.style.left=b));var E=p[x].alignable;if(E)for(var k=0;k<E.length;k++)E[k].style.left=b}a.options.fixedGutter&&(d.gutters.style.left=h+m+"px")}}function lb(a){if(!a.options.lineNumbers)return!1;var d=a.doc,p=he(a.options,d.first+d.size-1),h=a.display;if(p.length!=h.lineNumChars){var m=h.measure.appendChild(F("div",[F("div",p)],"CodeMirror-linenumber CodeMirror-gutter-elt")),b=m.firstChild.offsetWidth,x=m.offsetWidth-b;return h.lineGutter.style.width="",h.lineNumInnerWidth=Math.max(b,h.lineGutter.offsetWidth-x)+1,h.lineNumWidth=h.lineNumInnerWidth+x,h.lineNumChars=h.lineNumInnerWidth?p.length:-1,h.lineGutter.style.width=h.lineNumWidth+"px",$p(a.display),!0}return!1}function Hp(a,d){for(var p=[],h=!1,m=0;m<a.length;m++){var b=a[m],x=null;if(typeof b!="string"&&(x=b.style,b=b.className),b=="CodeMirror-linenumbers")if(d)h=!0;else continue;p.push({className:b,style:x})}return d&&!h&&p.push({className:"CodeMirror-linenumbers",style:null}),p}function db(a){var d=a.gutters,p=a.gutterSpecs;B(d),a.lineGutter=null;for(var h=0;h<p.length;++h){var m=p[h],b=m.className,x=m.style,E=d.appendChild(F("div",null,"CodeMirror-gutter "+b));x&&(E.style.cssText=x),b=="CodeMirror-linenumbers"&&(a.lineGutter=E,E.style.width=(a.lineNumWidth||1)+"px")}d.style.display=p.length?"":"none",$p(a)}function kl(a){db(a.display),Ni(a),ob(a)}function pA(a,d,p,h){var m=this;this.input=p,m.scrollbarFiller=F("div",null,"CodeMirror-scrollbar-filler"),m.scrollbarFiller.setAttribute("cm-not-content","true"),m.gutterFiller=F("div",null,"CodeMirror-gutter-filler"),m.gutterFiller.setAttribute("cm-not-content","true"),m.lineDiv=le("div",null,"CodeMirror-code"),m.selectionDiv=F("div",null,null,"position: relative; z-index: 1"),m.cursorDiv=F("div",null,"CodeMirror-cursors"),m.measure=F("div",null,"CodeMirror-measure"),m.lineMeasure=F("div",null,"CodeMirror-measure"),m.lineSpace=le("div",[m.measure,m.lineMeasure,m.selectionDiv,m.cursorDiv,m.lineDiv],null,"position: relative; outline: none");var b=le("div",[m.lineSpace],"CodeMirror-lines");m.mover=F("div",[b],null,"position: relative"),m.sizer=F("div",[m.mover],"CodeMirror-sizer"),m.sizerWidth=null,m.heightForcer=F("div",null,null,"position: absolute; height: "+St+"px; width: 1px;"),m.gutters=F("div",null,"CodeMirror-gutters"),m.lineGutter=null,m.scroller=F("div",[m.sizer,m.heightForcer,m.gutters],"CodeMirror-scroll"),m.scroller.setAttribute("tabIndex","-1"),m.wrapper=F("div",[m.scrollbarFiller,m.gutterFiller,m.scroller],"CodeMirror"),v&&y>=105&&(m.wrapper.style.clipPath="inset(0px)"),m.wrapper.setAttribute("translate","no"),c&&u<8&&(m.gutters.style.zIndex=-1,m.scroller.style.paddingRight=0),!f&&!(r&&R)&&(m.scroller.draggable=!0),a&&(a.appendChild?a.appendChild(m.wrapper):a(m.wrapper)),m.viewFrom=m.viewTo=d.first,m.reportedViewFrom=m.reportedViewTo=d.first,m.view=[],m.renderedView=null,m.externalMeasured=null,m.viewOffset=0,m.lastWrapHeight=m.lastWrapWidth=0,m.updateLineNumbers=null,m.nativeBarWidth=m.barHeight=m.barWidth=0,m.scrollbarsClipped=!1,m.lineNumWidth=m.lineNumInnerWidth=m.lineNumChars=null,m.alignWidgets=!1,m.cachedCharWidth=m.cachedTextHeight=m.cachedPaddingH=null,m.maxLine=null,m.maxLineLength=0,m.maxLineChanged=!1,m.wheelDX=m.wheelDY=m.wheelStartX=m.wheelStartY=null,m.shift=!1,m.selForContextMenu=null,m.activeTouch=null,m.gutterSpecs=Hp(h.gutters,h.lineNumbers),db(m),p.init(m)}var Lc=0,wr=null;c?wr=-.53:r?wr=15:v?wr=-.7:w&&(wr=-1/3);function cb(a){var d=a.wheelDeltaX,p=a.wheelDeltaY;return d==null&&a.detail&&a.axis==a.HORIZONTAL_AXIS&&(d=a.detail),p==null&&a.detail&&a.axis==a.VERTICAL_AXIS?p=a.detail:p==null&&(p=a.wheelDelta),{x:d,y:p}}function fA(a){var d=cb(a);return d.x*=wr,d.y*=wr,d}function ub(a,d){v&&y==102&&(a.display.chromeScrollHack==null?a.display.sizer.style.pointerEvents="none":clearTimeout(a.display.chromeScrollHack),a.display.chromeScrollHack=setTimeout(function(){a.display.chromeScrollHack=null,a.display.sizer.style.pointerEvents=""},100));var p=cb(d),h=p.x,m=p.y,b=wr;d.deltaMode===0&&(h=d.deltaX,m=d.deltaY,b=1);var x=a.display,E=x.scroller,k=E.scrollWidth>E.clientWidth,P=E.scrollHeight>E.clientHeight;if(h&&k||m&&P){if(m&&D&&f){e:for(var z=d.target,$=x.view;z!=E;z=z.parentNode)for(var q=0;q<$.length;q++)if($[q].node==z){a.display.currentWheelTarget=z;break e}}if(h&&!r&&!C&&b!=null){m&&P&&Cl(a,Math.max(0,E.scrollTop+m*b)),Us(a,Math.max(0,E.scrollLeft+h*b)),(!m||m&&P)&&yi(d),x.wheelStartX=null;return}if(m&&b!=null){var Z=m*b,te=a.doc.scrollTop,ae=te+x.wrapper.clientHeight;Z<0?te=Math.max(0,te+Z-50):ae=Math.min(a.doc.height,ae+Z+50),Wp(a,{top:te,bottom:ae})}Lc<20&&d.deltaMode!==0&&(x.wheelStartX==null?(x.wheelStartX=E.scrollLeft,x.wheelStartY=E.scrollTop,x.wheelDX=h,x.wheelDY=m,setTimeout(function(){if(x.wheelStartX!=null){var pe=E.scrollLeft-x.wheelStartX,me=E.scrollTop-x.wheelStartY,Ce=me&&x.wheelDY&&me/x.wheelDY||pe&&x.wheelDX&&pe/x.wheelDX;x.wheelStartX=x.wheelStartY=null,Ce&&(wr=(wr*Lc+Ce)/(Lc+1),++Lc)}},200)):(x.wheelDX+=h,x.wheelDY+=m))}}var en=function(a,d){this.ranges=a,this.primIndex=d};en.prototype.primary=function(){return this.ranges[this.primIndex]},en.prototype.equals=function(a){if(a==this)return!0;if(a.primIndex!=this.primIndex||a.ranges.length!=this.ranges.length)return!1;for(var d=0;d<this.ranges.length;d++){var p=this.ranges[d],h=a.ranges[d];if(!ut(p.anchor,h.anchor)||!ut(p.head,h.head))return!1}return!0},en.prototype.deepCopy=function(){for(var a=[],d=0;d<this.ranges.length;d++)a[d]=new ht(ti(this.ranges[d].anchor),ti(this.ranges[d].head));return new en(a,this.primIndex)},en.prototype.somethingSelected=function(){for(var a=0;a<this.ranges.length;a++)if(!this.ranges[a].empty())return!0;return!1},en.prototype.contains=function(a,d){d||(d=a);for(var p=0;p<this.ranges.length;p++){var h=this.ranges[p];if(be(d,h.from())>=0&&be(a,h.to())<=0)return p}return-1};var ht=function(a,d){this.anchor=a,this.head=d};ht.prototype.from=function(){return Ra(this.anchor,this.head)},ht.prototype.to=function(){return Ri(this.anchor,this.head)},ht.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Nn(a,d,p){var h=a&&a.options.selectionsMayTouch,m=d[p];d.sort(function(q,Z){return be(q.from(),Z.from())}),p=De(d,m);for(var b=1;b<d.length;b++){var x=d[b],E=d[b-1],k=be(E.to(),x.from());if(h&&!x.empty()?k>0:k>=0){var P=Ra(E.from(),x.from()),z=Ri(E.to(),x.to()),$=E.empty()?x.from()==x.head:E.from()==E.head;b<=p&&--p,d.splice(--b,2,new ht($?z:P,$?P:z))}}return new en(d,p)}function rs(a,d){return new en([new ht(a,d||a)],0)}function ss(a){return a.text?Q(a.from.line+a.text.length-1,ye(a.text).length+(a.text.length==1?a.from.ch:0)):a.to}function hb(a,d){if(be(a,d.from)<0)return a;if(be(a,d.to)<=0)return ss(d);var p=a.line+d.text.length-(d.to.line-d.from.line)-1,h=a.ch;return a.line==d.to.line&&(h+=ss(d).ch-d.to.ch),Q(p,h)}function Jp(a,d){for(var p=[],h=0;h<a.sel.ranges.length;h++){var m=a.sel.ranges[h];p.push(new ht(hb(m.anchor,d),hb(m.head,d)))}return Nn(a.cm,p,a.sel.primIndex)}function pb(a,d,p){return a.line==d.line?Q(p.line,a.ch-d.ch+p.ch):Q(p.line+(a.line-d.line),a.ch)}function gA(a,d,p){for(var h=[],m=Q(a.first,0),b=m,x=0;x<d.length;x++){var E=d[x],k=pb(E.from,m,b),P=pb(ss(E),m,b);if(m=E.to,b=P,p=="around"){var z=a.sel.ranges[x],$=be(z.head,z.anchor)<0;h[x]=new ht($?P:k,$?k:P)}else h[x]=new ht(k,k)}return new en(h,a.sel.primIndex)}function Zp(a){a.doc.mode=Pa(a.options,a.doc.modeOption),Il(a)}function Il(a){a.doc.iter(function(d){d.stateAfter&&(d.stateAfter=null),d.styles&&(d.styles=null)}),a.doc.modeFrontier=a.doc.highlightFrontier=a.doc.first,Ll(a,100),a.state.modeGen++,a.curOp&&Ni(a)}function fb(a,d){return d.from.ch==0&&d.to.ch==0&&ye(d.text)==""&&(!a.cm||a.cm.options.wholeLineUpdateBefore)}function qp(a,d,p,h){function m(Ce){return p?p[Ce]:null}function b(Ce,ve,ke){xP(Ce,ve,ke,h),ii(Ce,"change",Ce,d)}function x(Ce,ve){for(var ke=[],Fe=Ce;Fe<ve;++Fe)ke.push(new Na(P[Fe],m(Fe),h));return ke}var E=d.from,k=d.to,P=d.text,z=Ae(a,E.line),$=Ae(a,k.line),q=ye(P),Z=m(P.length-1),te=k.line-E.line;if(d.full)a.insert(0,x(0,P.length)),a.remove(P.length,a.size-P.length);else if(fb(a,d)){var ae=x(0,P.length-1);b($,$.text,Z),te&&a.remove(E.line,te),ae.length&&a.insert(E.line,ae)}else if(z==$)if(P.length==1)b(z,z.text.slice(0,E.ch)+q+z.text.slice(k.ch),Z);else{var pe=x(1,P.length-1);pe.push(new Na(q+z.text.slice(k.ch),Z,h)),b(z,z.text.slice(0,E.ch)+P[0],m(0)),a.insert(E.line+1,pe)}else if(P.length==1)b(z,z.text.slice(0,E.ch)+P[0]+$.text.slice(k.ch),m(0)),a.remove(E.line+1,te);else{b(z,z.text.slice(0,E.ch)+P[0],m(0)),b($,q+$.text.slice(k.ch),Z);var me=x(1,P.length-1);te>1&&a.remove(E.line+1,te-1),a.insert(E.line+1,me)}ii(a,"change",a,d)}function as(a,d,p){function h(m,b,x){if(m.linked)for(var E=0;E<m.linked.length;++E){var k=m.linked[E];if(k.doc!=b){var P=x&&k.sharedHist;p&&!P||(d(k.doc,P),h(k.doc,m,P))}}}h(a,null,!0)}function gb(a,d){if(d.cm)throw new Error("This document is already in use.");a.doc=d,d.cm=a,Vp(a),Zp(a),mb(a),a.options.direction=d.direction,a.options.lineWrapping||Ep(a),a.options.mode=d.modeOption,Ni(a)}function mb(a){(a.doc.direction=="rtl"?Le:U)(a.display.lineDiv,"CodeMirror-rtl")}function mA(a){Hi(a,function(){mb(a),Ni(a)})}function kc(a){this.done=[],this.undone=[],this.undoDepth=a?a.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=a?a.maxGeneration:1}function Yp(a,d){var p={from:ti(d.from),to:ss(d),text:vr(a,d.from,d.to)};return bb(a,p,d.from.line,d.to.line+1),as(a,function(h){return bb(h,p,d.from.line,d.to.line+1)},!0),p}function vb(a){for(;a.length;){var d=ye(a);if(d.ranges)a.pop();else break}}function vA(a,d){if(d)return vb(a.done),ye(a.done);if(a.done.length&&!ye(a.done).ranges)return ye(a.done);if(a.done.length>1&&!a.done[a.done.length-2].ranges)return a.done.pop(),ye(a.done)}function yb(a,d,p,h){var m=a.history;m.undone.length=0;var b=+new Date,x,E;if((m.lastOp==h||m.lastOrigin==d.origin&&d.origin&&(d.origin.charAt(0)=="+"&&m.lastModTime>b-(a.cm?a.cm.options.historyEventDelay:500)||d.origin.charAt(0)=="*"))&&(x=vA(m,m.lastOp==h)))E=ye(x.changes),be(d.from,d.to)==0&&be(d.from,E.to)==0?E.to=ss(d):x.changes.push(Yp(a,d));else{var k=ye(m.done);for((!k||!k.ranges)&&Ic(a.sel,m.done),x={changes:[Yp(a,d)],generation:m.generation},m.done.push(x);m.done.length>m.undoDepth;)m.done.shift(),m.done[0].ranges||m.done.shift()}m.done.push(p),m.generation=++m.maxGeneration,m.lastModTime=m.lastSelTime=b,m.lastOp=m.lastSelOp=h,m.lastOrigin=m.lastSelOrigin=d.origin,E||Mt(a,"historyAdded")}function yA(a,d,p,h){var m=d.charAt(0);return m=="*"||m=="+"&&p.ranges.length==h.ranges.length&&p.somethingSelected()==h.somethingSelected()&&new Date-a.history.lastSelTime<=(a.cm?a.cm.options.historyEventDelay:500)}function bA(a,d,p,h){var m=a.history,b=h&&h.origin;p==m.lastSelOp||b&&m.lastSelOrigin==b&&(m.lastModTime==m.lastSelTime&&m.lastOrigin==b||yA(a,b,ye(m.done),d))?m.done[m.done.length-1]=d:Ic(d,m.done),m.lastSelTime=+new Date,m.lastSelOrigin=b,m.lastSelOp=p,h&&h.clearRedo!==!1&&vb(m.undone)}function Ic(a,d){var p=ye(d);p&&p.ranges&&p.equals(a)||d.push(a)}function bb(a,d,p,h){var m=d["spans_"+a.id],b=0;a.iter(Math.max(a.first,p),Math.min(a.first+a.size,h),function(x){x.markedSpans&&((m||(m=d["spans_"+a.id]={}))[b]=x.markedSpans),++b})}function SA(a){if(!a)return null;for(var d,p=0;p<a.length;++p)a[p].marker.explicitlyCleared?d||(d=a.slice(0,p)):d&&d.push(a[p]);return d?d.length?d:null:a}function wA(a,d){var p=d["spans_"+a.id];if(!p)return null;for(var h=[],m=0;m<d.text.length;++m)h.push(SA(p[m]));return h}function Sb(a,d){var p=wA(a,d),h=Sp(a,d);if(!p)return h;if(!h)return p;for(var m=0;m<p.length;++m){var b=p[m],x=h[m];if(b&&x)e:for(var E=0;E<x.length;++E){for(var k=x[E],P=0;P<b.length;++P)if(b[P].marker==k.marker)continue e;b.push(k)}else x&&(p[m]=x)}return p}function Ga(a,d,p){for(var h=[],m=0;m<a.length;++m){var b=a[m];if(b.ranges){h.push(p?en.prototype.deepCopy.call(b):b);continue}var x=b.changes,E=[];h.push({changes:E});for(var k=0;k<x.length;++k){var P=x[k],z=void 0;if(E.push({from:P.from,to:P.to,text:P.text}),d)for(var $ in P)(z=$.match(/^spans_(\d+)$/))&&De(d,Number(z[1]))>-1&&(ye(E)[$]=P[$],delete P[$])}}return h}function Kp(a,d,p,h){if(h){var m=a.anchor;if(p){var b=be(d,m)<0;b!=be(p,m)<0?(m=d,d=p):b!=be(d,p)<0&&(d=p)}return new ht(m,d)}else return new ht(p||d,d)}function Tc(a,d,p,h,m){m==null&&(m=a.cm&&(a.cm.display.shift||a.extend)),bi(a,new en([Kp(a.sel.primary(),d,p,m)],0),h)}function wb(a,d,p){for(var h=[],m=a.cm&&(a.cm.display.shift||a.extend),b=0;b<a.sel.ranges.length;b++)h[b]=Kp(a.sel.ranges[b],d[b],null,m);var x=Nn(a.cm,h,a.sel.primIndex);bi(a,x,p)}function Xp(a,d,p,h){var m=a.sel.ranges.slice(0);m[d]=p,bi(a,Nn(a.cm,m,a.sel.primIndex),h)}function Cb(a,d,p,h){bi(a,rs(d,p),h)}function CA(a,d,p){var h={ranges:d.ranges,update:function(m){this.ranges=[];for(var b=0;b<m.length;b++)this.ranges[b]=new ht($e(a,m[b].anchor),$e(a,m[b].head))},origin:p&&p.origin};return Mt(a,"beforeSelectionChange",a,h),a.cm&&Mt(a.cm,"beforeSelectionChange",a.cm,h),h.ranges!=d.ranges?Nn(a.cm,h.ranges,h.ranges.length-1):d}function xb(a,d,p){var h=a.history.done,m=ye(h);m&&m.ranges?(h[h.length-1]=d,Dc(a,d,p)):bi(a,d,p)}function bi(a,d,p){Dc(a,d,p),bA(a,a.sel,a.cm?a.cm.curOp.id:NaN,p)}function Dc(a,d,p){(ji(a,"beforeSelectionChange")||a.cm&&ji(a.cm,"beforeSelectionChange"))&&(d=CA(a,d,p));var h=p&&p.bias||(be(d.primary().head,a.sel.primary().head)<0?-1:1);Eb(a,kb(a,d,h,!0)),!(p&&p.scroll===!1)&&a.cm&&a.cm.getOption("readOnly")!="nocursor"&&Ua(a.cm)}function Eb(a,d){d.equals(a.sel)||(a.sel=d,a.cm&&(a.cm.curOp.updateInput=1,a.cm.curOp.selectionChanged=!0,cn(a.cm)),ii(a,"cursorActivity",a))}function Lb(a){Eb(a,kb(a,a.sel,null,!1))}function kb(a,d,p,h){for(var m,b=0;b<d.ranges.length;b++){var x=d.ranges[b],E=d.ranges.length==a.sel.ranges.length&&a.sel.ranges[b],k=Pc(a,x.anchor,E&&E.anchor,p,h),P=x.head==x.anchor?k:Pc(a,x.head,E&&E.head,p,h);(m||k!=x.anchor||P!=x.head)&&(m||(m=d.ranges.slice(0,b)),m[b]=new ht(k,P))}return m?Nn(a.cm,m,d.primIndex):d}function Wa(a,d,p,h,m){var b=Ae(a,d.line);if(b.markedSpans)for(var x=0;x<b.markedSpans.length;++x){var E=b.markedSpans[x],k=E.marker,P="selectLeft"in k?!k.selectLeft:k.inclusiveLeft,z="selectRight"in k?!k.selectRight:k.inclusiveRight;if((E.from==null||(P?E.from<=d.ch:E.from<d.ch))&&(E.to==null||(z?E.to>=d.ch:E.to>d.ch))){if(m&&(Mt(k,"beforeCursorEnter"),k.explicitlyCleared))if(b.markedSpans){--x;continue}else break;if(!k.atomic)continue;if(p){var $=k.find(h<0?1:-1),q=void 0;if((h<0?z:P)&&($=Ib(a,$,-h,$&&$.line==d.line?b:null)),$&&$.line==d.line&&(q=be($,p))&&(h<0?q<0:q>0))return Wa(a,$,d,h,m)}var Z=k.find(h<0?-1:1);return(h<0?P:z)&&(Z=Ib(a,Z,h,Z.line==d.line?b:null)),Z?Wa(a,Z,d,h,m):null}}return d}function Pc(a,d,p,h,m){var b=h||1,x=Wa(a,d,p,b,m)||!m&&Wa(a,d,p,b,!0)||Wa(a,d,p,-b,m)||!m&&Wa(a,d,p,-b,!0);return x||(a.cantEdit=!0,Q(a.first,0))}function Ib(a,d,p,h){return p<0&&d.ch==0?d.line>a.first?$e(a,Q(d.line-1)):null:p>0&&d.ch==(h||Ae(a,d.line)).text.length?d.line<a.first+a.size-1?Q(d.line+1,0):null:new Q(d.line,d.ch+p)}function Tb(a){a.setSelection(Q(a.firstLine(),0),Q(a.lastLine()),ei)}function Db(a,d,p){var h={canceled:!1,from:d.from,to:d.to,text:d.text,origin:d.origin,cancel:function(){return h.canceled=!0}};return p&&(h.update=function(m,b,x,E){m&&(h.from=$e(a,m)),b&&(h.to=$e(a,b)),x&&(h.text=x),E!==void 0&&(h.origin=E)}),Mt(a,"beforeChange",a,h),a.cm&&Mt(a.cm,"beforeChange",a.cm,h),h.canceled?(a.cm&&(a.cm.curOp.updateInput=2),null):{from:h.from,to:h.to,text:h.text,origin:h.origin}}function $a(a,d,p){if(a.cm){if(!a.cm.curOp)return ni(a.cm,$a)(a,d,p);if(a.cm.state.suppressEdits)return}if(!((ji(a,"beforeChange")||a.cm&&ji(a.cm,"beforeChange"))&&(d=Db(a,d,!0),!d))){var h=S0&&!p&&bP(a,d.from,d.to);if(h)for(var m=h.length-1;m>=0;--m)Pb(a,{from:h[m].from,to:h[m].to,text:m?[""]:d.text,origin:d.origin});else Pb(a,d)}}function Pb(a,d){if(!(d.text.length==1&&d.text[0]==""&&be(d.from,d.to)==0)){var p=Jp(a,d);yb(a,d,p,a.cm?a.cm.curOp.id:NaN),Tl(a,d,p,Sp(a,d));var h=[];as(a,function(m,b){!b&&De(h,m.history)==-1&&(Nb(m.history,d),h.push(m.history)),Tl(m,d,null,Sp(m,d))})}}function Ac(a,d,p){var h=a.cm&&a.cm.state.suppressEdits;if(!(h&&!p)){for(var m=a.history,b,x=a.sel,E=d=="undo"?m.done:m.undone,k=d=="undo"?m.undone:m.done,P=0;P<E.length&&(b=E[P],!(p?b.ranges&&!b.equals(a.sel):!b.ranges));P++);if(P!=E.length){for(m.lastOrigin=m.lastSelOrigin=null;;)if(b=E.pop(),b.ranges){if(Ic(b,k),p&&!b.equals(a.sel)){bi(a,b,{clearRedo:!1});return}x=b}else if(h){E.push(b);return}else break;var z=[];Ic(x,k),k.push({changes:z,generation:m.generation}),m.generation=b.generation||++m.maxGeneration;for(var $=ji(a,"beforeChange")||a.cm&&ji(a.cm,"beforeChange"),q=function(ae){var pe=b.changes[ae];if(pe.origin=d,$&&!Db(a,pe,!1))return E.length=0,{};z.push(Yp(a,pe));var me=ae?Jp(a,pe):ye(E);Tl(a,pe,me,Sb(a,pe)),!ae&&a.cm&&a.cm.scrollIntoView({from:pe.from,to:ss(pe)});var Ce=[];as(a,function(ve,ke){!ke&&De(Ce,ve.history)==-1&&(Nb(ve.history,pe),Ce.push(ve.history)),Tl(ve,pe,null,Sb(ve,pe))})},Z=b.changes.length-1;Z>=0;--Z){var te=q(Z);if(te)return te.v}}}}function Ab(a,d){if(d!=0&&(a.first+=d,a.sel=new en(Je(a.sel.ranges,function(m){return new ht(Q(m.anchor.line+d,m.anchor.ch),Q(m.head.line+d,m.head.ch))}),a.sel.primIndex),a.cm)){Ni(a.cm,a.first,a.first-d,d);for(var p=a.cm.display,h=p.viewFrom;h<p.viewTo;h++)is(a.cm,h,"gutter")}}function Tl(a,d,p,h){if(a.cm&&!a.cm.curOp)return ni(a.cm,Tl)(a,d,p,h);if(d.to.line<a.first){Ab(a,d.text.length-1-(d.to.line-d.from.line));return}if(!(d.from.line>a.lastLine())){if(d.from.line<a.first){var m=d.text.length-1-(a.first-d.from.line);Ab(a,m),d={from:Q(a.first,0),to:Q(d.to.line+m,d.to.ch),text:[ye(d.text)],origin:d.origin}}var b=a.lastLine();d.to.line>b&&(d={from:d.from,to:Q(b,Ae(a,b).text.length),text:[d.text[0]],origin:d.origin}),d.removed=vr(a,d.from,d.to),p||(p=Jp(a,d)),a.cm?xA(a.cm,d,h):qp(a,d,h),Dc(a,p,ei),a.cantEdit&&Pc(a,Q(a.firstLine(),0))&&(a.cantEdit=!1)}}function xA(a,d,p){var h=a.doc,m=a.display,b=d.from,x=d.to,E=!1,k=b.line;a.options.lineWrapping||(k=N(Mn(Ae(h,b.line))),h.iter(k,x.line+1,function(Z){if(Z==m.maxLine)return E=!0,!0})),h.sel.contains(d.from,d.to)>-1&&cn(a),qp(h,d,p,Y0(a)),a.options.lineWrapping||(h.iter(k,b.line+d.text.length,function(Z){var te=fc(Z);te>m.maxLineLength&&(m.maxLine=Z,m.maxLineLength=te,m.maxLineChanged=!0,E=!1)}),E&&(a.curOp.updateMaxLine=!0)),hP(h,b.line),Ll(a,400);var P=d.text.length-(x.line-b.line)-1;d.full?Ni(a):b.line==x.line&&d.text.length==1&&!fb(a.doc,d)?is(a,b.line,"text"):Ni(a,b.line,x.line+1,P);var z=ji(a,"changes"),$=ji(a,"change");if($||z){var q={from:b,to:x,text:d.text,removed:d.removed,origin:d.origin};$&&ii(a,"change",a,q),z&&(a.curOp.changeObjs||(a.curOp.changeObjs=[])).push(q)}a.display.selForContextMenu=null}function ja(a,d,p,h,m){var b;h||(h=p),be(h,p)<0&&(b=[h,p],p=b[0],h=b[1]),typeof d=="string"&&(d=a.splitLines(d)),$a(a,{from:p,to:h,text:d,origin:m})}function Mb(a,d,p,h){p<a.line?a.line+=h:d<a.line&&(a.line=d,a.ch=0)}function Rb(a,d,p,h){for(var m=0;m<a.length;++m){var b=a[m],x=!0;if(b.ranges){b.copied||(b=a[m]=b.deepCopy(),b.copied=!0);for(var E=0;E<b.ranges.length;E++)Mb(b.ranges[E].anchor,d,p,h),Mb(b.ranges[E].head,d,p,h);continue}for(var k=0;k<b.changes.length;++k){var P=b.changes[k];if(p<P.from.line)P.from=Q(P.from.line+h,P.from.ch),P.to=Q(P.to.line+h,P.to.ch);else if(d<=P.to.line){x=!1;break}}x||(a.splice(0,m+1),m=0)}}function Nb(a,d){var p=d.from.line,h=d.to.line,m=d.text.length-(h-p)-1;Rb(a.done,p,h,m),Rb(a.undone,p,h,m)}function Dl(a,d,p,h){var m=d,b=d;return typeof d=="number"?b=Ae(a,u0(a,d)):m=N(d),m==null?null:(h(b,m)&&a.cm&&is(a.cm,m,p),b)}function Pl(a){this.lines=a,this.parent=null;for(var d=0,p=0;p<a.length;++p)a[p].parent=this,d+=a[p].height;this.height=d}Pl.prototype={chunkSize:function(){return this.lines.length},removeInner:function(a,d){for(var p=a,h=a+d;p<h;++p){var m=this.lines[p];this.height-=m.height,EP(m),ii(m,"delete")}this.lines.splice(a,d)},collapse:function(a){a.push.apply(a,this.lines)},insertInner:function(a,d,p){this.height+=p,this.lines=this.lines.slice(0,a).concat(d).concat(this.lines.slice(a));for(var h=0;h<d.length;++h)d[h].parent=this},iterN:function(a,d,p){for(var h=a+d;a<h;++a)if(p(this.lines[a]))return!0}};function Al(a){this.children=a;for(var d=0,p=0,h=0;h<a.length;++h){var m=a[h];d+=m.chunkSize(),p+=m.height,m.parent=this}this.size=d,this.height=p,this.parent=null}Al.prototype={chunkSize:function(){return this.size},removeInner:function(a,d){this.size-=d;for(var p=0;p<this.children.length;++p){var h=this.children[p],m=h.chunkSize();if(a<m){var b=Math.min(d,m-a),x=h.height;if(h.removeInner(a,b),this.height-=x-h.height,m==b&&(this.children.splice(p--,1),h.parent=null),(d-=b)==0)break;a=0}else a-=m}if(this.size-d<25&&(this.children.length>1||!(this.children[0]instanceof Pl))){var E=[];this.collapse(E),this.children=[new Pl(E)],this.children[0].parent=this}},collapse:function(a){for(var d=0;d<this.children.length;++d)this.children[d].collapse(a)},insertInner:function(a,d,p){this.size+=d.length,this.height+=p;for(var h=0;h<this.children.length;++h){var m=this.children[h],b=m.chunkSize();if(a<=b){if(m.insertInner(a,d,p),m.lines&&m.lines.length>50){for(var x=m.lines.length%25+25,E=x;E<m.lines.length;){var k=new Pl(m.lines.slice(E,E+=25));m.height-=k.height,this.children.splice(++h,0,k),k.parent=this}m.lines=m.lines.slice(0,x),this.maybeSpill()}break}a-=b}},maybeSpill:function(){if(!(this.children.length<=10)){var a=this;do{var d=a.children.splice(a.children.length-5,5),p=new Al(d);if(a.parent){a.size-=p.size,a.height-=p.height;var h=De(a.parent.children,a);a.parent.children.splice(h+1,0,p)}else{var m=new Al(a.children);m.parent=a,a.children=[m,p],a=m}p.parent=a.parent}while(a.children.length>10);a.parent.maybeSpill()}},iterN:function(a,d,p){for(var h=0;h<this.children.length;++h){var m=this.children[h],b=m.chunkSize();if(a<b){var x=Math.min(d,b-a);if(m.iterN(a,x,p))return!0;if((d-=x)==0)break;a=0}else a-=b}}};var Ml=function(a,d,p){if(p)for(var h in p)p.hasOwnProperty(h)&&(this[h]=p[h]);this.doc=a,this.node=d};Ml.prototype.clear=function(){var a=this.doc.cm,d=this.line.widgets,p=this.line,h=N(p);if(!(h==null||!d)){for(var m=0;m<d.length;++m)d[m]==this&&d.splice(m--,1);d.length||(p.widgets=null);var b=yl(this);Qi(p,Math.max(0,p.height-b)),a&&(Hi(a,function(){Vb(a,p,-b),is(a,h,"widget")}),ii(a,"lineWidgetCleared",a,this,h))}},Ml.prototype.changed=function(){var a=this,d=this.height,p=this.doc.cm,h=this.line;this.height=null;var m=yl(this)-d;m&&(ts(this.doc,h)||Qi(h,h.height+m),p&&Hi(p,function(){p.curOp.forceUpdate=!0,Vb(p,h,m),ii(p,"lineWidgetChanged",p,a,N(h))}))},In(Ml);function Vb(a,d,p){br(d)<(a.curOp&&a.curOp.scrollTop||a.doc.scrollTop)&&zp(a,p)}function EA(a,d,p,h){var m=new Ml(a,p,h),b=a.cm;return b&&m.noHScroll&&(b.display.alignWidgets=!0),Dl(a,d,"widget",function(x){var E=x.widgets||(x.widgets=[]);if(m.insertAt==null?E.push(m):E.splice(Math.min(E.length,Math.max(0,m.insertAt)),0,m),m.line=x,b&&!ts(a,x)){var k=br(x)<a.scrollTop;Qi(x,x.height+yl(m)),k&&zp(b,m.height),b.curOp.forceUpdate=!0}return!0}),b&&ii(b,"lineWidgetAdded",b,m,typeof d=="number"?d:N(d)),m}var Ob=0,os=function(a,d){this.lines=[],this.type=d,this.doc=a,this.id=++Ob};os.prototype.clear=function(){if(!this.explicitlyCleared){var a=this.doc.cm,d=a&&!a.curOp;if(d&&Gs(a),ji(this,"clear")){var p=this.find();p&&ii(this,"clear",p.from,p.to)}for(var h=null,m=null,b=0;b<this.lines.length;++b){var x=this.lines[b],E=gl(x.markedSpans,this);a&&!this.collapsed?is(a,N(x),"text"):a&&(E.to!=null&&(m=N(x)),E.from!=null&&(h=N(x))),x.markedSpans=gP(x.markedSpans,E),E.from==null&&this.collapsed&&!ts(this.doc,x)&&a&&Qi(x,Ba(a.display))}if(a&&this.collapsed&&!a.options.lineWrapping)for(var k=0;k<this.lines.length;++k){var P=Mn(this.lines[k]),z=fc(P);z>a.display.maxLineLength&&(a.display.maxLine=P,a.display.maxLineLength=z,a.display.maxLineChanged=!0)}h!=null&&a&&this.collapsed&&Ni(a,h,m+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,a&&Lb(a.doc)),a&&ii(a,"markerCleared",a,this,h,m),d&&Ws(a),this.parent&&this.parent.clear()}},os.prototype.find=function(a,d){a==null&&this.type=="bookmark"&&(a=1);for(var p,h,m=0;m<this.lines.length;++m){var b=this.lines[m],x=gl(b.markedSpans,this);if(x.from!=null&&(p=Q(d?b:N(b),x.from),a==-1))return p;if(x.to!=null&&(h=Q(d?b:N(b),x.to),a==1))return h}return p&&{from:p,to:h}},os.prototype.changed=function(){var a=this,d=this.find(-1,!0),p=this,h=this.doc.cm;!d||!h||Hi(h,function(){var m=d.line,b=N(d.line),x=Tp(h,b);if(x&&(G0(x),h.curOp.selectionChanged=h.curOp.forceUpdate=!0),h.curOp.updateMaxLine=!0,!ts(p.doc,m)&&p.height!=null){var E=p.height;p.height=null;var k=yl(p)-E;k&&Qi(m,m.height+k)}ii(h,"markerChanged",h,a)})},os.prototype.attachLine=function(a){if(!this.lines.length&&this.doc.cm){var d=this.doc.cm.curOp;(!d.maybeHiddenMarkers||De(d.maybeHiddenMarkers,this)==-1)&&(d.maybeUnhiddenMarkers||(d.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(a)},os.prototype.detachLine=function(a){if(this.lines.splice(De(this.lines,a),1),!this.lines.length&&this.doc.cm){var d=this.doc.cm.curOp;(d.maybeHiddenMarkers||(d.maybeHiddenMarkers=[])).push(this)}},In(os);function Ha(a,d,p,h,m){if(h&&h.shared)return LA(a,d,p,h,m);if(a.cm&&!a.cm.curOp)return ni(a.cm,Ha)(a,d,p,h,m);var b=new os(a,m),x=be(d,p);if(h&&Ue(h,b,!1),x>0||x==0&&b.clearWhenEmpty!==!1)return b;if(b.replacedWith&&(b.collapsed=!0,b.widgetNode=le("span",[b.replacedWith],"CodeMirror-widget"),h.handleMouseEvents||b.widgetNode.setAttribute("cm-ignore-events","true"),h.insertLeft&&(b.widgetNode.insertLeft=!0)),b.collapsed){if(k0(a,d.line,d,p,b)||d.line!=p.line&&k0(a,p.line,d,p,b))throw new Error("Inserting collapsed marker partially overlapping an existing one");fP()}b.addToHistory&&yb(a,{from:d,to:p,origin:"markText"},a.sel,NaN);var E=d.line,k=a.cm,P;if(a.iter(E,p.line+1,function($){k&&b.collapsed&&!k.options.lineWrapping&&Mn($)==k.display.maxLine&&(P=!0),b.collapsed&&E!=d.line&&Qi($,0),mP($,new cc(b,E==d.line?d.ch:null,E==p.line?p.ch:null),a.cm&&a.cm.curOp),++E}),b.collapsed&&a.iter(d.line,p.line+1,function($){ts(a,$)&&Qi($,0)}),b.clearOnEnter&&Oe(b,"beforeCursorEnter",function(){return b.clear()}),b.readOnly&&(pP(),(a.history.done.length||a.history.undone.length)&&a.clearHistory()),b.collapsed&&(b.id=++Ob,b.atomic=!0),k){if(P&&(k.curOp.updateMaxLine=!0),b.collapsed)Ni(k,d.line,p.line+1);else if(b.className||b.startStyle||b.endStyle||b.css||b.attributes||b.title)for(var z=d.line;z<=p.line;z++)is(k,z,"text");b.atomic&&Lb(k.doc),ii(k,"markerAdded",k,b)}return b}var Rl=function(a,d){this.markers=a,this.primary=d;for(var p=0;p<a.length;++p)a[p].parent=this};Rl.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var a=0;a<this.markers.length;++a)this.markers[a].clear();ii(this,"clear")}},Rl.prototype.find=function(a,d){return this.primary.find(a,d)},In(Rl);function LA(a,d,p,h,m){h=Ue(h),h.shared=!1;var b=[Ha(a,d,p,h,m)],x=b[0],E=h.widgetNode;return as(a,function(k){E&&(h.widgetNode=E.cloneNode(!0)),b.push(Ha(k,$e(k,d),$e(k,p),h,m));for(var P=0;P<k.linked.length;++P)if(k.linked[P].isParent)return;x=ye(b)}),new Rl(b,x)}function Bb(a){return a.findMarks(Q(a.first,0),a.clipPos(Q(a.lastLine())),function(d){return d.parent})}function kA(a,d){for(var p=0;p<d.length;p++){var h=d[p],m=h.find(),b=a.clipPos(m.from),x=a.clipPos(m.to);if(be(b,x)){var E=Ha(a,b,x,h.primary,h.primary.type);h.markers.push(E),E.parent=h}}}function IA(a){for(var d=function(h){var m=a[h],b=[m.primary.doc];as(m.primary.doc,function(k){return b.push(k)});for(var x=0;x<m.markers.length;x++){var E=m.markers[x];De(b,E.doc)==-1&&(E.parent=null,m.markers.splice(x--,1))}},p=0;p<a.length;p++)d(p)}var TA=0,Vi=function(a,d,p,h,m){if(!(this instanceof Vi))return new Vi(a,d,p,h,m);p==null&&(p=0),Al.call(this,[new Pl([new Na("",null)])]),this.first=p,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=p;var b=Q(p,0);this.sel=rs(b),this.history=new kc(null),this.id=++TA,this.modeOption=d,this.lineSep=h,this.direction=m=="rtl"?"rtl":"ltr",this.extend=!1,typeof a=="string"&&(a=this.splitLines(a)),qp(this,{from:b,to:b,text:a}),bi(this,rs(b),ei)};Vi.prototype=dt(Al.prototype,{constructor:Vi,iter:function(a,d,p){p?this.iterN(a-this.first,d-a,p):this.iterN(this.first,this.first+this.size,a)},insert:function(a,d){for(var p=0,h=0;h<d.length;++h)p+=d[h].height;this.insertInner(a-this.first,d,p)},remove:function(a,d){this.removeInner(a-this.first,d)},getValue:function(a){var d=pl(this,this.first,this.first+this.size);return a===!1?d:d.join(a||this.lineSeparator())},setValue:ri(function(a){var d=Q(this.first,0),p=this.first+this.size-1;$a(this,{from:d,to:Q(p,Ae(this,p).text.length),text:this.splitLines(a),origin:"setValue",full:!0},!0),this.cm&&wl(this.cm,0,0),bi(this,rs(d),ei)}),replaceRange:function(a,d,p,h){d=$e(this,d),p=p?$e(this,p):d,ja(this,a,d,p,h)},getRange:function(a,d,p){var h=vr(this,$e(this,a),$e(this,d));return p===!1?h:p===""?h.join(""):h.join(p||this.lineSeparator())},getLine:function(a){var d=this.getLineHandle(a);return d&&d.text},getLineHandle:function(a){if(ne(this,a))return Ae(this,a)},getLineNumber:function(a){return N(a)},getLineHandleVisualStart:function(a){return typeof a=="number"&&(a=Ae(this,a)),Mn(a)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(a){return $e(this,a)},getCursor:function(a){var d=this.sel.primary(),p;return a==null||a=="head"?p=d.head:a=="anchor"?p=d.anchor:a=="end"||a=="to"||a===!1?p=d.to():p=d.from(),p},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:ri(function(a,d,p){Cb(this,$e(this,typeof a=="number"?Q(a,d||0):a),null,p)}),setSelection:ri(function(a,d,p){Cb(this,$e(this,a),$e(this,d||a),p)}),extendSelection:ri(function(a,d,p){Tc(this,$e(this,a),d&&$e(this,d),p)}),extendSelections:ri(function(a,d){wb(this,h0(this,a),d)}),extendSelectionsBy:ri(function(a,d){var p=Je(this.sel.ranges,a);wb(this,h0(this,p),d)}),setSelections:ri(function(a,d,p){if(a.length){for(var h=[],m=0;m<a.length;m++)h[m]=new ht($e(this,a[m].anchor),$e(this,a[m].head||a[m].anchor));d==null&&(d=Math.min(a.length-1,this.sel.primIndex)),bi(this,Nn(this.cm,h,d),p)}}),addSelection:ri(function(a,d,p){var h=this.sel.ranges.slice(0);h.push(new ht($e(this,a),$e(this,d||a))),bi(this,Nn(this.cm,h,h.length-1),p)}),getSelection:function(a){for(var d=this.sel.ranges,p,h=0;h<d.length;h++){var m=vr(this,d[h].from(),d[h].to());p=p?p.concat(m):m}return a===!1?p:p.join(a||this.lineSeparator())},getSelections:function(a){for(var d=[],p=this.sel.ranges,h=0;h<p.length;h++){var m=vr(this,p[h].from(),p[h].to());a!==!1&&(m=m.join(a||this.lineSeparator())),d[h]=m}return d},replaceSelection:function(a,d,p){for(var h=[],m=0;m<this.sel.ranges.length;m++)h[m]=a;this.replaceSelections(h,d,p||"+input")},replaceSelections:ri(function(a,d,p){for(var h=[],m=this.sel,b=0;b<m.ranges.length;b++){var x=m.ranges[b];h[b]={from:x.from(),to:x.to(),text:this.splitLines(a[b]),origin:p}}for(var E=d&&d!="end"&&gA(this,h,d),k=h.length-1;k>=0;k--)$a(this,h[k]);E?xb(this,E):this.cm&&Ua(this.cm)}),undo:ri(function(){Ac(this,"undo")}),redo:ri(function(){Ac(this,"redo")}),undoSelection:ri(function(){Ac(this,"undo",!0)}),redoSelection:ri(function(){Ac(this,"redo",!0)}),setExtending:function(a){this.extend=a},getExtending:function(){return this.extend},historySize:function(){for(var a=this.history,d=0,p=0,h=0;h<a.done.length;h++)a.done[h].ranges||++d;for(var m=0;m<a.undone.length;m++)a.undone[m].ranges||++p;return{undo:d,redo:p}},clearHistory:function(){var a=this;this.history=new kc(this.history),as(this,function(d){return d.history=a.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(a){return a&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(a){return this.history.generation==(a||this.cleanGeneration)},getHistory:function(){return{done:Ga(this.history.done),undone:Ga(this.history.undone)}},setHistory:function(a){var d=this.history=new kc(this.history);d.done=Ga(a.done.slice(0),null,!0),d.undone=Ga(a.undone.slice(0),null,!0)},setGutterMarker:ri(function(a,d,p){return Dl(this,a,"gutter",function(h){var m=h.gutterMarkers||(h.gutterMarkers={});return m[d]=p,!p&&mi(m)&&(h.gutterMarkers=null),!0})}),clearGutter:ri(function(a){var d=this;this.iter(function(p){p.gutterMarkers&&p.gutterMarkers[a]&&Dl(d,p,"gutter",function(){return p.gutterMarkers[a]=null,mi(p.gutterMarkers)&&(p.gutterMarkers=null),!0})})}),lineInfo:function(a){var d;if(typeof a=="number"){if(!ne(this,a)||(d=a,a=Ae(this,a),!a))return null}else if(d=N(a),d==null)return null;return{line:d,handle:a,text:a.text,gutterMarkers:a.gutterMarkers,textClass:a.textClass,bgClass:a.bgClass,wrapClass:a.wrapClass,widgets:a.widgets}},addLineClass:ri(function(a,d,p){return Dl(this,a,d=="gutter"?"gutter":"class",function(h){var m=d=="text"?"textClass":d=="background"?"bgClass":d=="gutter"?"gutterClass":"wrapClass";if(!h[m])h[m]=p;else{if(H(p).test(h[m]))return!1;h[m]+=" "+p}return!0})}),removeLineClass:ri(function(a,d,p){return Dl(this,a,d=="gutter"?"gutter":"class",function(h){var m=d=="text"?"textClass":d=="background"?"bgClass":d=="gutter"?"gutterClass":"wrapClass",b=h[m];if(b)if(p==null)h[m]=null;else{var x=b.match(H(p));if(!x)return!1;var E=x.index+x[0].length;h[m]=b.slice(0,x.index)+(!x.index||E==b.length?"":" ")+b.slice(E)||null}else return!1;return!0})}),addLineWidget:ri(function(a,d,p){return EA(this,a,d,p)}),removeLineWidget:function(a){a.clear()},markText:function(a,d,p){return Ha(this,$e(this,a),$e(this,d),p,p&&p.type||"range")},setBookmark:function(a,d){var p={replacedWith:d&&(d.nodeType==null?d.widget:d),insertLeft:d&&d.insertLeft,clearWhenEmpty:!1,shared:d&&d.shared,handleMouseEvents:d&&d.handleMouseEvents};return a=$e(this,a),Ha(this,a,a,p,"bookmark")},findMarksAt:function(a){a=$e(this,a);var d=[],p=Ae(this,a.line).markedSpans;if(p)for(var h=0;h<p.length;++h){var m=p[h];(m.from==null||m.from<=a.ch)&&(m.to==null||m.to>=a.ch)&&d.push(m.marker.parent||m.marker)}return d},findMarks:function(a,d,p){a=$e(this,a),d=$e(this,d);var h=[],m=a.line;return this.iter(a.line,d.line+1,function(b){var x=b.markedSpans;if(x)for(var E=0;E<x.length;E++){var k=x[E];!(k.to!=null&&m==a.line&&a.ch>=k.to||k.from==null&&m!=a.line||k.from!=null&&m==d.line&&k.from>=d.ch)&&(!p||p(k.marker))&&h.push(k.marker.parent||k.marker)}++m}),h},getAllMarks:function(){var a=[];return this.iter(function(d){var p=d.markedSpans;if(p)for(var h=0;h<p.length;++h)p[h].from!=null&&a.push(p[h].marker)}),a},posFromIndex:function(a){var d,p=this.first,h=this.lineSeparator().length;return this.iter(function(m){var b=m.text.length+h;if(b>a)return d=a,!0;a-=b,++p}),$e(this,Q(p,d))},indexFromPos:function(a){a=$e(this,a);var d=a.ch;if(a.line<this.first||a.ch<0)return 0;var p=this.lineSeparator().length;return this.iter(this.first,a.line,function(h){d+=h.text.length+p}),d},copy:function(a){var d=new Vi(pl(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return d.scrollTop=this.scrollTop,d.scrollLeft=this.scrollLeft,d.sel=this.sel,d.extend=!1,a&&(d.history.undoDepth=this.history.undoDepth,d.setHistory(this.getHistory())),d},linkedDoc:function(a){a||(a={});var d=this.first,p=this.first+this.size;a.from!=null&&a.from>d&&(d=a.from),a.to!=null&&a.to<p&&(p=a.to);var h=new Vi(pl(this,d,p),a.mode||this.modeOption,d,this.lineSep,this.direction);return a.sharedHist&&(h.history=this.history),(this.linked||(this.linked=[])).push({doc:h,sharedHist:a.sharedHist}),h.linked=[{doc:this,isParent:!0,sharedHist:a.sharedHist}],kA(h,Bb(this)),h},unlinkDoc:function(a){if(a instanceof Dt&&(a=a.doc),this.linked)for(var d=0;d<this.linked.length;++d){var p=this.linked[d];if(p.doc==a){this.linked.splice(d,1),a.unlinkDoc(this),IA(Bb(this));break}}if(a.history==this.history){var h=[a.id];as(a,function(m){return h.push(m.id)},!0),a.history=new kc(null),a.history.done=Ga(this.history.done,h),a.history.undone=Ga(this.history.undone,h)}},iterLinkedDocs:function(a){as(this,a)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(a){return this.lineSep?a.split(this.lineSep):un(a)},lineSeparator:function(){return this.lineSep||`
`},setDirection:ri(function(a){a!="rtl"&&(a="ltr"),a!=this.direction&&(this.direction=a,this.iter(function(d){return d.order=null}),this.cm&&mA(this.cm))})}),Vi.prototype.eachLine=Vi.prototype.iter;var _b=0;function DA(a){var d=this;if(Fb(d),!(Rt(d,a)||Sr(d.display,a))){yi(a),c&&(_b=+new Date);var p=_s(d,a,!0),h=a.dataTransfer.files;if(!(!p||d.isReadOnly()))if(h&&h.length&&window.FileReader&&window.File)for(var m=h.length,b=Array(m),x=0,E=function(){++x==m&&ni(d,function(){p=$e(d.doc,p);var Z={from:p,to:p,text:d.doc.splitLines(b.filter(function(te){return te!=null}).join(d.doc.lineSeparator())),origin:"paste"};$a(d.doc,Z),xb(d.doc,rs($e(d.doc,p),$e(d.doc,ss(Z))))})()},k=function(Z,te){if(d.options.allowDropFileTypes&&De(d.options.allowDropFileTypes,Z.type)==-1){E();return}var ae=new FileReader;ae.onerror=function(){return E()},ae.onload=function(){var pe=ae.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(pe)){E();return}b[te]=pe,E()},ae.readAsText(Z)},P=0;P<h.length;P++)k(h[P],P);else{if(d.state.draggingText&&d.doc.sel.contains(p)>-1){d.state.draggingText(a),setTimeout(function(){return d.display.input.focus()},20);return}try{var z=a.dataTransfer.getData("Text");if(z){var $;if(d.state.draggingText&&!d.state.draggingText.copy&&($=d.listSelections()),Dc(d.doc,rs(p,p)),$)for(var q=0;q<$.length;++q)ja(d.doc,"",$[q].anchor,$[q].head,"drag");d.replaceSelection(z,"around","paste"),d.display.input.focus()}}catch{}}}}function PA(a,d){if(c&&(!a.state.draggingText||+new Date-_b<100)){Kr(d);return}if(!(Rt(a,d)||Sr(a.display,d))&&(d.dataTransfer.setData("Text",a.getSelection()),d.dataTransfer.effectAllowed="copyMove",d.dataTransfer.setDragImage&&!w)){var p=F("img",null,null,"position: fixed; left: 0; top: 0;");p.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",C&&(p.width=p.height=1,a.display.wrapper.appendChild(p),p._top=p.offsetTop),d.dataTransfer.setDragImage(p,0,0),C&&p.parentNode.removeChild(p)}}function AA(a,d){var p=_s(a,d);if(p){var h=document.createDocumentFragment();Op(a,p,h),a.display.dragCursor||(a.display.dragCursor=F("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),a.display.lineSpace.insertBefore(a.display.dragCursor,a.display.cursorDiv)),W(a.display.dragCursor,h)}}function Fb(a){a.display.dragCursor&&(a.display.lineSpace.removeChild(a.display.dragCursor),a.display.dragCursor=null)}function Ub(a){if(document.getElementsByClassName){for(var d=document.getElementsByClassName("CodeMirror"),p=[],h=0;h<d.length;h++){var m=d[h].CodeMirror;m&&p.push(m)}p.length&&p[0].operation(function(){for(var b=0;b<p.length;b++)a(p[b])})}}var zb=!1;function MA(){zb||(RA(),zb=!0)}function RA(){var a;Oe(window,"resize",function(){a==null&&(a=setTimeout(function(){a=null,Ub(NA)},100))}),Oe(window,"blur",function(){return Ub(Fa)})}function NA(a){var d=a.display;d.cachedCharWidth=d.cachedTextHeight=d.cachedPaddingH=null,d.scrollbarsClipped=!1,a.setSize()}for(var ls={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Nl=0;Nl<10;Nl++)ls[Nl+48]=ls[Nl+96]=String(Nl);for(var Mc=65;Mc<=90;Mc++)ls[Mc]=String.fromCharCode(Mc);for(var Vl=1;Vl<=12;Vl++)ls[Vl+111]=ls[Vl+63235]="F"+Vl;var Cr={};Cr.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Cr.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Cr.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Cr.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Cr.default=D?Cr.macDefault:Cr.pcDefault;function VA(a){var d=a.split(/-(?!$)/);a=d[d.length-1];for(var p,h,m,b,x=0;x<d.length-1;x++){var E=d[x];if(/^(cmd|meta|m)$/i.test(E))b=!0;else if(/^a(lt)?$/i.test(E))p=!0;else if(/^(c|ctrl|control)$/i.test(E))h=!0;else if(/^s(hift)?$/i.test(E))m=!0;else throw new Error("Unrecognized modifier name: "+E)}return p&&(a="Alt-"+a),h&&(a="Ctrl-"+a),b&&(a="Cmd-"+a),m&&(a="Shift-"+a),a}function OA(a){var d={};for(var p in a)if(a.hasOwnProperty(p)){var h=a[p];if(/^(name|fallthrough|(de|at)tach)$/.test(p))continue;if(h=="..."){delete a[p];continue}for(var m=Je(p.split(" "),VA),b=0;b<m.length;b++){var x=void 0,E=void 0;b==m.length-1?(E=m.join(" "),x=h):(E=m.slice(0,b+1).join(" "),x="...");var k=d[E];if(!k)d[E]=x;else if(k!=x)throw new Error("Inconsistent bindings for "+E)}delete a[p]}for(var P in d)a[P]=d[P];return a}function Ja(a,d,p,h){d=Rc(d);var m=d.call?d.call(a,h):d[a];if(m===!1)return"nothing";if(m==="...")return"multi";if(m!=null&&p(m))return"handled";if(d.fallthrough){if(Object.prototype.toString.call(d.fallthrough)!="[object Array]")return Ja(a,d.fallthrough,p,h);for(var b=0;b<d.fallthrough.length;b++){var x=Ja(a,d.fallthrough[b],p,h);if(x)return x}}}function Gb(a){var d=typeof a=="string"?a:ls[a.keyCode];return d=="Ctrl"||d=="Alt"||d=="Shift"||d=="Mod"}function Wb(a,d,p){var h=a;return d.altKey&&h!="Alt"&&(a="Alt-"+a),(O?d.metaKey:d.ctrlKey)&&h!="Ctrl"&&(a="Ctrl-"+a),(O?d.ctrlKey:d.metaKey)&&h!="Mod"&&(a="Cmd-"+a),!p&&d.shiftKey&&h!="Shift"&&(a="Shift-"+a),a}function $b(a,d){if(C&&a.keyCode==34&&a.char)return!1;var p=ls[a.keyCode];return p==null||a.altGraphKey?!1:(a.keyCode==3&&a.code&&(p=a.code),Wb(p,a,d))}function Rc(a){return typeof a=="string"?Cr[a]:a}function Za(a,d){for(var p=a.doc.sel.ranges,h=[],m=0;m<p.length;m++){for(var b=d(p[m]);h.length&&be(b.from,ye(h).to)<=0;){var x=h.pop();if(be(x.from,b.from)<0){b.from=x.from;break}}h.push(b)}Hi(a,function(){for(var E=h.length-1;E>=0;E--)ja(a.doc,"",h[E].from,h[E].to,"+delete");Ua(a)})}function Qp(a,d,p){var h=Ft(a.text,d+p,p);return h<0||h>a.text.length?null:h}function ef(a,d,p){var h=Qp(a,d.ch,p);return h==null?null:new Q(d.line,h,p<0?"after":"before")}function tf(a,d,p,h,m){if(a){d.doc.direction=="rtl"&&(m=-m);var b=Xe(p,d.doc.direction);if(b){var x=m<0?ye(b):b[0],E=m<0==(x.level==1),k=E?"after":"before",P;if(x.level>0||d.doc.direction=="rtl"){var z=Oa(d,p);P=m<0?p.text.length-1:0;var $=qn(d,z,P).top;P=Kt(function(q){return qn(d,z,q).top==$},m<0==(x.level==1)?x.from:x.to-1,P),k=="before"&&(P=Qp(p,P,1))}else P=m<0?x.to:x.from;return new Q(h,P,k)}}return new Q(h,m<0?p.text.length:0,m<0?"before":"after")}function BA(a,d,p,h){var m=Xe(d,a.doc.direction);if(!m)return ef(d,p,h);p.ch>=d.text.length?(p.ch=d.text.length,p.sticky="before"):p.ch<=0&&(p.ch=0,p.sticky="after");var b=Yr(m,p.ch,p.sticky),x=m[b];if(a.doc.direction=="ltr"&&x.level%2==0&&(h>0?x.to>p.ch:x.from<p.ch))return ef(d,p,h);var E=function(me,Ce){return Qp(d,me instanceof Q?me.ch:me,Ce)},k,P=function(me){return a.options.lineWrapping?(k=k||Oa(a,d),q0(a,d,k,me)):{begin:0,end:d.text.length}},z=P(p.sticky=="before"?E(p,-1):p.ch);if(a.doc.direction=="rtl"||x.level==1){var $=x.level==1==h<0,q=E(p,$?1:-1);if(q!=null&&($?q<=x.to&&q<=z.end:q>=x.from&&q>=z.begin)){var Z=$?"before":"after";return new Q(p.line,q,Z)}}var te=function(me,Ce,ve){for(var ke=function(xt,si){return si?new Q(p.line,E(xt,1),"before"):new Q(p.line,xt,"after")};me>=0&&me<m.length;me+=Ce){var Fe=m[me],Ve=Ce>0==(Fe.level!=1),Ye=Ve?ve.begin:E(ve.end,-1);if(Fe.from<=Ye&&Ye<Fe.to||(Ye=Ve?Fe.from:E(Fe.to,-1),ve.begin<=Ye&&Ye<ve.end))return ke(Ye,Ve)}},ae=te(b+h,h,z);if(ae)return ae;var pe=h>0?z.end:E(z.begin,-1);return pe!=null&&!(h>0&&pe==d.text.length)&&(ae=te(h>0?0:m.length-1,h,P(pe)),ae)?ae:null}var Ol={selectAll:Tb,singleSelection:function(a){return a.setSelection(a.getCursor("anchor"),a.getCursor("head"),ei)},killLine:function(a){return Za(a,function(d){if(d.empty()){var p=Ae(a.doc,d.head.line).text.length;return d.head.ch==p&&d.head.line<a.lastLine()?{from:d.head,to:Q(d.head.line+1,0)}:{from:d.head,to:Q(d.head.line,p)}}else return{from:d.from(),to:d.to()}})},deleteLine:function(a){return Za(a,function(d){return{from:Q(d.from().line,0),to:$e(a.doc,Q(d.to().line+1,0))}})},delLineLeft:function(a){return Za(a,function(d){return{from:Q(d.from().line,0),to:d.from()}})},delWrappedLineLeft:function(a){return Za(a,function(d){var p=a.charCoords(d.head,"div").top+5,h=a.coordsChar({left:0,top:p},"div");return{from:h,to:d.from()}})},delWrappedLineRight:function(a){return Za(a,function(d){var p=a.charCoords(d.head,"div").top+5,h=a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:p},"div");return{from:d.from(),to:h}})},undo:function(a){return a.undo()},redo:function(a){return a.redo()},undoSelection:function(a){return a.undoSelection()},redoSelection:function(a){return a.redoSelection()},goDocStart:function(a){return a.extendSelection(Q(a.firstLine(),0))},goDocEnd:function(a){return a.extendSelection(Q(a.lastLine()))},goLineStart:function(a){return a.extendSelectionsBy(function(d){return jb(a,d.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(a){return a.extendSelectionsBy(function(d){return Hb(a,d.head)},{origin:"+move",bias:1})},goLineEnd:function(a){return a.extendSelectionsBy(function(d){return _A(a,d.head.line)},{origin:"+move",bias:-1})},goLineRight:function(a){return a.extendSelectionsBy(function(d){var p=a.cursorCoords(d.head,"div").top+5;return a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:p},"div")},ee)},goLineLeft:function(a){return a.extendSelectionsBy(function(d){var p=a.cursorCoords(d.head,"div").top+5;return a.coordsChar({left:0,top:p},"div")},ee)},goLineLeftSmart:function(a){return a.extendSelectionsBy(function(d){var p=a.cursorCoords(d.head,"div").top+5,h=a.coordsChar({left:0,top:p},"div");return h.ch<a.getLine(h.line).search(/\S/)?Hb(a,d.head):h},ee)},goLineUp:function(a){return a.moveV(-1,"line")},goLineDown:function(a){return a.moveV(1,"line")},goPageUp:function(a){return a.moveV(-1,"page")},goPageDown:function(a){return a.moveV(1,"page")},goCharLeft:function(a){return a.moveH(-1,"char")},goCharRight:function(a){return a.moveH(1,"char")},goColumnLeft:function(a){return a.moveH(-1,"column")},goColumnRight:function(a){return a.moveH(1,"column")},goWordLeft:function(a){return a.moveH(-1,"word")},goGroupRight:function(a){return a.moveH(1,"group")},goGroupLeft:function(a){return a.moveH(-1,"group")},goWordRight:function(a){return a.moveH(1,"word")},delCharBefore:function(a){return a.deleteH(-1,"codepoint")},delCharAfter:function(a){return a.deleteH(1,"char")},delWordBefore:function(a){return a.deleteH(-1,"word")},delWordAfter:function(a){return a.deleteH(1,"word")},delGroupBefore:function(a){return a.deleteH(-1,"group")},delGroupAfter:function(a){return a.deleteH(1,"group")},indentAuto:function(a){return a.indentSelection("smart")},indentMore:function(a){return a.indentSelection("add")},indentLess:function(a){return a.indentSelection("subtract")},insertTab:function(a){return a.replaceSelection("	")},insertSoftTab:function(a){for(var d=[],p=a.listSelections(),h=a.options.tabSize,m=0;m<p.length;m++){var b=p[m].from(),x=We(a.getLine(b.line),b.ch,h);d.push(Ee(h-x%h))}a.replaceSelections(d)},defaultTab:function(a){a.somethingSelected()?a.indentSelection("add"):a.execCommand("insertTab")},transposeChars:function(a){return Hi(a,function(){for(var d=a.listSelections(),p=[],h=0;h<d.length;h++)if(d[h].empty()){var m=d[h].head,b=Ae(a.doc,m.line).text;if(b){if(m.ch==b.length&&(m=new Q(m.line,m.ch-1)),m.ch>0)m=new Q(m.line,m.ch+1),a.replaceRange(b.charAt(m.ch-1)+b.charAt(m.ch-2),Q(m.line,m.ch-2),m,"+transpose");else if(m.line>a.doc.first){var x=Ae(a.doc,m.line-1).text;x&&(m=new Q(m.line,1),a.replaceRange(b.charAt(0)+a.doc.lineSeparator()+x.charAt(x.length-1),Q(m.line-1,x.length-1),m,"+transpose"))}}p.push(new ht(m,m))}a.setSelections(p)})},newlineAndIndent:function(a){return Hi(a,function(){for(var d=a.listSelections(),p=d.length-1;p>=0;p--)a.replaceRange(a.doc.lineSeparator(),d[p].anchor,d[p].head,"+input");d=a.listSelections();for(var h=0;h<d.length;h++)a.indentLine(d[h].from().line,null,!0);Ua(a)})},openLine:function(a){return a.replaceSelection(`
`,"start")},toggleOverwrite:function(a){return a.toggleOverwrite()}};function jb(a,d){var p=Ae(a.doc,d),h=Mn(p);return h!=p&&(d=N(h)),tf(!0,a,h,d,1)}function _A(a,d){var p=Ae(a.doc,d),h=wP(p);return h!=p&&(d=N(h)),tf(!0,a,p,d,-1)}function Hb(a,d){var p=jb(a,d.line),h=Ae(a.doc,p.line),m=Xe(h,a.doc.direction);if(!m||m[0].level==0){var b=Math.max(p.ch,h.text.search(/\S/)),x=d.line==p.line&&d.ch<=b&&d.ch;return Q(p.line,x?0:b,p.sticky)}return p}function Nc(a,d,p){if(typeof d=="string"&&(d=Ol[d],!d))return!1;a.display.input.ensurePolled();var h=a.display.shift,m=!1;try{a.isReadOnly()&&(a.state.suppressEdits=!0),p&&(a.display.shift=!1),m=d(a)!=dn}finally{a.display.shift=h,a.state.suppressEdits=!1}return m}function FA(a,d,p){for(var h=0;h<a.state.keyMaps.length;h++){var m=Ja(d,a.state.keyMaps[h],p,a);if(m)return m}return a.options.extraKeys&&Ja(d,a.options.extraKeys,p,a)||Ja(d,a.options.keyMap,p,a)}var UA=new Ge;function Bl(a,d,p,h){var m=a.state.keySeq;if(m){if(Gb(d))return"handled";if(/\'$/.test(d)?a.state.keySeq=null:UA.set(50,function(){a.state.keySeq==m&&(a.state.keySeq=null,a.display.input.reset())}),Jb(a,m+" "+d,p,h))return!0}return Jb(a,d,p,h)}function Jb(a,d,p,h){var m=FA(a,d,h);return m=="multi"&&(a.state.keySeq=d),m=="handled"&&ii(a,"keyHandled",a,d,p),(m=="handled"||m=="multi")&&(yi(p),Bp(a)),!!m}function Zb(a,d){var p=$b(d,!0);return p?d.shiftKey&&!a.state.keySeq?Bl(a,"Shift-"+p,d,function(h){return Nc(a,h,!0)})||Bl(a,p,d,function(h){if(typeof h=="string"?/^go[A-Z]/.test(h):h.motion)return Nc(a,h)}):Bl(a,p,d,function(h){return Nc(a,h)}):!1}function zA(a,d,p){return Bl(a,"'"+p+"'",d,function(h){return Nc(a,h,!0)})}var nf=null;function qb(a){var d=this;if(!(a.target&&a.target!=d.display.input.getField())&&(d.curOp.focus=ce(it(d)),!Rt(d,a))){c&&u<11&&a.keyCode==27&&(a.returnValue=!1);var p=a.keyCode;d.display.shift=p==16||a.shiftKey;var h=Zb(d,a);C&&(nf=h?p:null,!h&&p==88&&!lc&&(D?a.metaKey:a.ctrlKey)&&d.replaceSelection("",null,"cut")),r&&!D&&!h&&p==46&&a.shiftKey&&!a.ctrlKey&&document.execCommand&&document.execCommand("cut"),p==18&&!/\bCodeMirror-crosshair\b/.test(d.display.lineDiv.className)&&GA(d)}}function GA(a){var d=a.display.lineDiv;Le(d,"CodeMirror-crosshair");function p(h){(h.keyCode==18||!h.altKey)&&(U(d,"CodeMirror-crosshair"),vi(document,"keyup",p),vi(document,"mouseover",p))}Oe(document,"keyup",p),Oe(document,"mouseover",p)}function Yb(a){a.keyCode==16&&(this.doc.sel.shift=!1),Rt(this,a)}function Kb(a){var d=this;if(!(a.target&&a.target!=d.display.input.getField())&&!(Sr(d.display,a)||Rt(d,a)||a.ctrlKey&&!a.altKey||D&&a.metaKey)){var p=a.keyCode,h=a.charCode;if(C&&p==nf){nf=null,yi(a);return}if(!(C&&(!a.which||a.which<10)&&Zb(d,a))){var m=String.fromCharCode(h??p);m!="\b"&&(zA(d,a,m)||d.display.input.onKeyPress(a))}}}var WA=400,rf=function(a,d,p){this.time=a,this.pos=d,this.button=p};rf.prototype.compare=function(a,d,p){return this.time+WA>a&&be(d,this.pos)==0&&p==this.button};var _l,Fl;function $A(a,d){var p=+new Date;return Fl&&Fl.compare(p,a,d)?(_l=Fl=null,"triple"):_l&&_l.compare(p,a,d)?(Fl=new rf(p,a,d),_l=null,"double"):(_l=new rf(p,a,d),Fl=null,"single")}function Xb(a){var d=this,p=d.display;if(!(Rt(d,a)||p.activeTouch&&p.input.supportsTouch())){if(p.input.ensurePolled(),p.shift=a.shiftKey,Sr(p,a)){f||(p.scroller.draggable=!1,setTimeout(function(){return p.scroller.draggable=!0},100));return}if(!sf(d,a)){var h=_s(d,a),m=Tn(a),b=h?$A(h,m):"single";ze(d).focus(),m==1&&d.state.selectingText&&d.state.selectingText(a),!(h&&jA(d,m,h,b,a))&&(m==1?h?JA(d,h,b,a):cl(a)==p.scroller&&yi(a):m==2?(h&&Tc(d.doc,h),setTimeout(function(){return p.input.focus()},20)):m==3&&(_?d.display.input.onContextMenu(a):_p(d)))}}}function jA(a,d,p,h,m){var b="Click";return h=="double"?b="Double"+b:h=="triple"&&(b="Triple"+b),b=(d==1?"Left":d==2?"Middle":"Right")+b,Bl(a,Wb(b,m),m,function(x){if(typeof x=="string"&&(x=Ol[x]),!x)return!1;var E=!1;try{a.isReadOnly()&&(a.state.suppressEdits=!0),E=x(a,p)!=dn}finally{a.state.suppressEdits=!1}return E})}function HA(a,d,p){var h=a.getOption("configureMouse"),m=h?h(a,d,p):{};if(m.unit==null){var b=T?p.shiftKey&&p.metaKey:p.altKey;m.unit=b?"rectangle":d=="single"?"char":d=="double"?"word":"line"}return(m.extend==null||a.doc.extend)&&(m.extend=a.doc.extend||p.shiftKey),m.addNew==null&&(m.addNew=D?p.metaKey:p.ctrlKey),m.moveOnDrag==null&&(m.moveOnDrag=!(D?p.altKey:p.ctrlKey)),m}function JA(a,d,p,h){c?setTimeout(Pe(Q0,a),0):a.curOp.focus=ce(it(a));var m=HA(a,p,h),b=a.doc.sel,x;a.options.dragDrop&&mp&&!a.isReadOnly()&&p=="single"&&(x=b.contains(d))>-1&&(be((x=b.ranges[x]).from(),d)<0||d.xRel>0)&&(be(x.to(),d)>0||d.xRel<0)?ZA(a,h,d,m):qA(a,h,d,m)}function ZA(a,d,p,h){var m=a.display,b=!1,x=ni(a,function(P){f&&(m.scroller.draggable=!1),a.state.draggingText=!1,a.state.delayingBlurEvent&&(a.hasFocus()?a.state.delayingBlurEvent=!1:_p(a)),vi(m.wrapper.ownerDocument,"mouseup",x),vi(m.wrapper.ownerDocument,"mousemove",E),vi(m.scroller,"dragstart",k),vi(m.scroller,"drop",x),b||(yi(P),h.addNew||Tc(a.doc,p,null,null,h.extend),f&&!w||c&&u==9?setTimeout(function(){m.wrapper.ownerDocument.body.focus({preventScroll:!0}),m.input.focus()},20):m.input.focus())}),E=function(P){b=b||Math.abs(d.clientX-P.clientX)+Math.abs(d.clientY-P.clientY)>=10},k=function(){return b=!0};f&&(m.scroller.draggable=!0),a.state.draggingText=x,x.copy=!h.moveOnDrag,Oe(m.wrapper.ownerDocument,"mouseup",x),Oe(m.wrapper.ownerDocument,"mousemove",E),Oe(m.scroller,"dragstart",k),Oe(m.scroller,"drop",x),a.state.delayingBlurEvent=!0,setTimeout(function(){return m.input.focus()},20),m.scroller.dragDrop&&m.scroller.dragDrop()}function Qb(a,d,p){if(p=="char")return new ht(d,d);if(p=="word")return a.findWordAt(d);if(p=="line")return new ht(Q(d.line,0),$e(a.doc,Q(d.line+1,0)));var h=p(a,d);return new ht(h.from,h.to)}function qA(a,d,p,h){c&&_p(a);var m=a.display,b=a.doc;yi(d);var x,E,k=b.sel,P=k.ranges;if(h.addNew&&!h.extend?(E=b.sel.contains(p),E>-1?x=P[E]:x=new ht(p,p)):(x=b.sel.primary(),E=b.sel.primIndex),h.unit=="rectangle")h.addNew||(x=new ht(p,p)),p=_s(a,d,!0,!0),E=-1;else{var z=Qb(a,p,h.unit);h.extend?x=Kp(x,z.anchor,z.head,h.extend):x=z}h.addNew?E==-1?(E=P.length,bi(b,Nn(a,P.concat([x]),E),{scroll:!1,origin:"*mouse"})):P.length>1&&P[E].empty()&&h.unit=="char"&&!h.extend?(bi(b,Nn(a,P.slice(0,E).concat(P.slice(E+1)),0),{scroll:!1,origin:"*mouse"}),k=b.sel):Xp(b,E,x,X):(E=0,bi(b,new en([x],0),X),k=b.sel);var $=p;function q(ve){if(be($,ve)!=0)if($=ve,h.unit=="rectangle"){for(var ke=[],Fe=a.options.tabSize,Ve=We(Ae(b,p.line).text,p.ch,Fe),Ye=We(Ae(b,ve.line).text,ve.ch,Fe),xt=Math.min(Ve,Ye),si=Math.max(Ve,Ye),At=Math.min(p.line,ve.line),Ji=Math.min(a.lastLine(),Math.max(p.line,ve.line));At<=Ji;At++){var Oi=Ae(b,At).text,Ht=ie(Oi,xt,Fe);xt==si?ke.push(new ht(Q(At,Ht),Q(At,Ht))):Oi.length>Ht&&ke.push(new ht(Q(At,Ht),Q(At,ie(Oi,si,Fe))))}ke.length||ke.push(new ht(p,p)),bi(b,Nn(a,k.ranges.slice(0,E).concat(ke),E),{origin:"*mouse",scroll:!1}),a.scrollIntoView(ve)}else{var Bi=x,ui=Qb(a,ve,h.unit),Xt=Bi.anchor,Jt;be(ui.anchor,Xt)>0?(Jt=ui.head,Xt=Ra(Bi.from(),ui.anchor)):(Jt=ui.anchor,Xt=Ri(Bi.to(),ui.head));var Vt=k.ranges.slice(0);Vt[E]=YA(a,new ht($e(b,Xt),Jt)),bi(b,Nn(a,Vt,E),X)}}var Z=m.wrapper.getBoundingClientRect(),te=0;function ae(ve){var ke=++te,Fe=_s(a,ve,!0,h.unit=="rectangle");if(Fe)if(be(Fe,$)!=0){a.curOp.focus=ce(it(a)),q(Fe);var Ve=Cc(m,b);(Fe.line>=Ve.to||Fe.line<Ve.from)&&setTimeout(ni(a,function(){te==ke&&ae(ve)}),150)}else{var Ye=ve.clientY<Z.top?-20:ve.clientY>Z.bottom?20:0;Ye&&setTimeout(ni(a,function(){te==ke&&(m.scroller.scrollTop+=Ye,ae(ve))}),50)}}function pe(ve){a.state.selectingText=!1,te=1/0,ve&&(yi(ve),m.input.focus()),vi(m.wrapper.ownerDocument,"mousemove",me),vi(m.wrapper.ownerDocument,"mouseup",Ce),b.history.lastSelOrigin=null}var me=ni(a,function(ve){ve.buttons===0||!Tn(ve)?pe(ve):ae(ve)}),Ce=ni(a,pe);a.state.selectingText=Ce,Oe(m.wrapper.ownerDocument,"mousemove",me),Oe(m.wrapper.ownerDocument,"mouseup",Ce)}function YA(a,d){var p=d.anchor,h=d.head,m=Ae(a.doc,p.line);if(be(p,h)==0&&p.sticky==h.sticky)return d;var b=Xe(m);if(!b)return d;var x=Yr(b,p.ch,p.sticky),E=b[x];if(E.from!=p.ch&&E.to!=p.ch)return d;var k=x+(E.from==p.ch==(E.level!=1)?0:1);if(k==0||k==b.length)return d;var P;if(h.line!=p.line)P=(h.line-p.line)*(a.doc.direction=="ltr"?1:-1)>0;else{var z=Yr(b,h.ch,h.sticky),$=z-x||(h.ch-p.ch)*(E.level==1?-1:1);z==k-1||z==k?P=$<0:P=$>0}var q=b[k+(P?-1:0)],Z=P==(q.level==1),te=Z?q.from:q.to,ae=Z?"after":"before";return p.ch==te&&p.sticky==ae?d:new ht(new Q(p.line,te,ae),h)}function eS(a,d,p,h){var m,b;if(d.touches)m=d.touches[0].clientX,b=d.touches[0].clientY;else try{m=d.clientX,b=d.clientY}catch{return!1}if(m>=Math.floor(a.display.gutters.getBoundingClientRect().right))return!1;h&&yi(d);var x=a.display,E=x.lineDiv.getBoundingClientRect();if(b>E.bottom||!ji(a,p))return Mi(d);b-=E.top-x.viewOffset;for(var k=0;k<a.display.gutterSpecs.length;++k){var P=x.gutters.childNodes[k];if(P&&P.getBoundingClientRect().right>=m){var z=G(a.doc,b),$=a.display.gutterSpecs[k];return Mt(a,p,a,z,$.className,d),Mi(d)}}}function sf(a,d){return eS(a,d,"gutterClick",!0)}function tS(a,d){Sr(a.display,d)||KA(a,d)||Rt(a,d,"contextmenu")||_||a.display.input.onContextMenu(d)}function KA(a,d){return ji(a,"gutterContextMenu")?eS(a,d,"gutterContextMenu",!1):!1}function iS(a){a.display.wrapper.className=a.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+a.options.theme.replace(/(^|\s)\s*/g," cm-s-"),bl(a)}var qa={toString:function(){return"CodeMirror.Init"}},nS={},Vc={};function XA(a){var d=a.optionHandlers;function p(h,m,b,x){a.defaults[h]=m,b&&(d[h]=x?function(E,k,P){P!=qa&&b(E,k,P)}:b)}a.defineOption=p,a.Init=qa,p("value","",function(h,m){return h.setValue(m)},!0),p("mode",null,function(h,m){h.doc.modeOption=m,Zp(h)},!0),p("indentUnit",2,Zp,!0),p("indentWithTabs",!1),p("smartIndent",!0),p("tabSize",4,function(h){Il(h),bl(h),Ni(h)},!0),p("lineSeparator",null,function(h,m){if(h.doc.lineSep=m,!!m){var b=[],x=h.doc.first;h.doc.iter(function(k){for(var P=0;;){var z=k.text.indexOf(m,P);if(z==-1)break;P=z+m.length,b.push(Q(x,z))}x++});for(var E=b.length-1;E>=0;E--)ja(h.doc,m,b[E],Q(b[E].line,b[E].ch+m.length))}}),p("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\u202d\u202e\u2066\u2067\u2069\ufeff\ufff9-\ufffc]/g,function(h,m,b){h.state.specialChars=new RegExp(m.source+(m.test("	")?"":"|	"),"g"),b!=qa&&h.refresh()}),p("specialCharPlaceholder",IP,function(h){return h.refresh()},!0),p("electricChars",!0),p("inputStyle",R?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),p("spellcheck",!1,function(h,m){return h.getInputField().spellcheck=m},!0),p("autocorrect",!1,function(h,m){return h.getInputField().autocorrect=m},!0),p("autocapitalize",!1,function(h,m){return h.getInputField().autocapitalize=m},!0),p("rtlMoveVisually",!A),p("wholeLineUpdateBefore",!0),p("theme","default",function(h){iS(h),kl(h)},!0),p("keyMap","default",function(h,m,b){var x=Rc(m),E=b!=qa&&Rc(b);E&&E.detach&&E.detach(h,x),x.attach&&x.attach(h,E||null)}),p("extraKeys",null),p("configureMouse",null),p("lineWrapping",!1,eM,!0),p("gutters",[],function(h,m){h.display.gutterSpecs=Hp(m,h.options.lineNumbers),kl(h)},!0),p("fixedGutter",!0,function(h,m){h.display.gutters.style.left=m?Np(h.display)+"px":"0",h.refresh()},!0),p("coverGutterNextToScrollbar",!1,function(h){return za(h)},!0),p("scrollbarStyle","native",function(h){sb(h),za(h),h.display.scrollbars.setScrollTop(h.doc.scrollTop),h.display.scrollbars.setScrollLeft(h.doc.scrollLeft)},!0),p("lineNumbers",!1,function(h,m){h.display.gutterSpecs=Hp(h.options.gutters,m),kl(h)},!0),p("firstLineNumber",1,kl,!0),p("lineNumberFormatter",function(h){return h},kl,!0),p("showCursorWhenSelecting",!1,Sl,!0),p("resetSelectionOnContextMenu",!0),p("lineWiseCopyCut",!0),p("pasteLinesPerSelection",!0),p("selectionsMayTouch",!1),p("readOnly",!1,function(h,m){m=="nocursor"&&(Fa(h),h.display.input.blur()),h.display.input.readOnlyChanged(m)}),p("screenReaderLabel",null,function(h,m){m=m===""?null:m,h.display.input.screenReaderLabelChanged(m)}),p("disableInput",!1,function(h,m){m||h.display.input.reset()},!0),p("dragDrop",!0,QA),p("allowDropFileTypes",null),p("cursorBlinkRate",530),p("cursorScrollMargin",0),p("cursorHeight",1,Sl,!0),p("singleCursorHeightPerLine",!0,Sl,!0),p("workTime",100),p("workDelay",100),p("flattenSpans",!0,Il,!0),p("addModeClass",!1,Il,!0),p("pollInterval",100),p("undoDepth",200,function(h,m){return h.doc.history.undoDepth=m}),p("historyEventDelay",1250),p("viewportMargin",10,function(h){return h.refresh()},!0),p("maxHighlightLength",1e4,Il,!0),p("moveInputWithCursor",!0,function(h,m){m||h.display.input.resetPosition()}),p("tabindex",null,function(h,m){return h.display.input.getField().tabIndex=m||""}),p("autofocus",null),p("direction","ltr",function(h,m){return h.doc.setDirection(m)},!0),p("phrases",null)}function QA(a,d,p){var h=p&&p!=qa;if(!d!=!h){var m=a.display.dragFunctions,b=d?Oe:vi;b(a.display.scroller,"dragstart",m.start),b(a.display.scroller,"dragenter",m.enter),b(a.display.scroller,"dragover",m.over),b(a.display.scroller,"dragleave",m.leave),b(a.display.scroller,"drop",m.drop)}}function eM(a){a.options.lineWrapping?(Le(a.display.wrapper,"CodeMirror-wrap"),a.display.sizer.style.minWidth="",a.display.sizerWidth=null):(U(a.display.wrapper,"CodeMirror-wrap"),Ep(a)),Vp(a),Ni(a),bl(a),setTimeout(function(){return za(a)},100)}function Dt(a,d){var p=this;if(!(this instanceof Dt))return new Dt(a,d);this.options=d=d?Ue(d):{},Ue(nS,d,!1);var h=d.value;typeof h=="string"?h=new Vi(h,d.mode,null,d.lineSeparator,d.direction):d.mode&&(h.modeOption=d.mode),this.doc=h;var m=new Dt.inputStyles[d.inputStyle](this),b=this.display=new pA(a,h,m,d);b.wrapper.CodeMirror=this,iS(this),d.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),sb(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new Ge,keySeq:null,specialChars:null},d.autofocus&&!R&&b.input.focus(),c&&u<11&&setTimeout(function(){return p.display.input.reset(!0)},20),tM(this),MA(),Gs(this),this.curOp.forceUpdate=!0,gb(this,h),d.autofocus&&!R||this.hasFocus()?setTimeout(function(){p.hasFocus()&&!p.state.focused&&Fp(p)},20):Fa(this);for(var x in Vc)Vc.hasOwnProperty(x)&&Vc[x](this,d[x],qa);lb(this),d.finishInit&&d.finishInit(this);for(var E=0;E<af.length;++E)af[E](this);Ws(this),f&&d.lineWrapping&&getComputedStyle(b.lineDiv).textRendering=="optimizelegibility"&&(b.lineDiv.style.textRendering="auto")}Dt.defaults=nS,Dt.optionHandlers=Vc;function tM(a){var d=a.display;Oe(d.scroller,"mousedown",ni(a,Xb)),c&&u<11?Oe(d.scroller,"dblclick",ni(a,function(k){if(!Rt(a,k)){var P=_s(a,k);if(!(!P||sf(a,k)||Sr(a.display,k))){yi(k);var z=a.findWordAt(P);Tc(a.doc,z.anchor,z.head)}}})):Oe(d.scroller,"dblclick",function(k){return Rt(a,k)||yi(k)}),Oe(d.scroller,"contextmenu",function(k){return tS(a,k)}),Oe(d.input.getField(),"contextmenu",function(k){d.scroller.contains(k.target)||tS(a,k)});var p,h={end:0};function m(){d.activeTouch&&(p=setTimeout(function(){return d.activeTouch=null},1e3),h=d.activeTouch,h.end=+new Date)}function b(k){if(k.touches.length!=1)return!1;var P=k.touches[0];return P.radiusX<=1&&P.radiusY<=1}function x(k,P){if(P.left==null)return!0;var z=P.left-k.left,$=P.top-k.top;return z*z+$*$>20*20}Oe(d.scroller,"touchstart",function(k){if(!Rt(a,k)&&!b(k)&&!sf(a,k)){d.input.ensurePolled(),clearTimeout(p);var P=+new Date;d.activeTouch={start:P,moved:!1,prev:P-h.end<=300?h:null},k.touches.length==1&&(d.activeTouch.left=k.touches[0].pageX,d.activeTouch.top=k.touches[0].pageY)}}),Oe(d.scroller,"touchmove",function(){d.activeTouch&&(d.activeTouch.moved=!0)}),Oe(d.scroller,"touchend",function(k){var P=d.activeTouch;if(P&&!Sr(d,k)&&P.left!=null&&!P.moved&&new Date-P.start<300){var z=a.coordsChar(d.activeTouch,"page"),$;!P.prev||x(P,P.prev)?$=new ht(z,z):!P.prev.prev||x(P,P.prev.prev)?$=a.findWordAt(z):$=new ht(Q(z.line,0),$e(a.doc,Q(z.line+1,0))),a.setSelection($.anchor,$.head),a.focus(),yi(k)}m()}),Oe(d.scroller,"touchcancel",m),Oe(d.scroller,"scroll",function(){d.scroller.clientHeight&&(Cl(a,d.scroller.scrollTop),Us(a,d.scroller.scrollLeft,!0),Mt(a,"scroll",a))}),Oe(d.scroller,"mousewheel",function(k){return ub(a,k)}),Oe(d.scroller,"DOMMouseScroll",function(k){return ub(a,k)}),Oe(d.wrapper,"scroll",function(){return d.wrapper.scrollTop=d.wrapper.scrollLeft=0}),d.dragFunctions={enter:function(k){Rt(a,k)||Kr(k)},over:function(k){Rt(a,k)||(AA(a,k),Kr(k))},start:function(k){return PA(a,k)},drop:ni(a,DA),leave:function(k){Rt(a,k)||Fb(a)}};var E=d.input.getField();Oe(E,"keyup",function(k){return Yb.call(a,k)}),Oe(E,"keydown",ni(a,qb)),Oe(E,"keypress",ni(a,Kb)),Oe(E,"focus",function(k){return Fp(a,k)}),Oe(E,"blur",function(k){return Fa(a,k)})}var af=[];Dt.defineInitHook=function(a){return af.push(a)};function Ul(a,d,p,h){var m=a.doc,b;p==null&&(p="add"),p=="smart"&&(m.mode.indent?b=fl(a,d).state:p="prev");var x=a.options.tabSize,E=Ae(m,d),k=We(E.text,null,x);E.stateAfter&&(E.stateAfter=null);var P=E.text.match(/^\s*/)[0],z;if(!h&&!/\S/.test(E.text))z=0,p="not";else if(p=="smart"&&(z=m.mode.indent(b,E.text.slice(P.length),E.text),z==dn||z>150)){if(!h)return;p="prev"}p=="prev"?d>m.first?z=We(Ae(m,d-1).text,null,x):z=0:p=="add"?z=k+a.options.indentUnit:p=="subtract"?z=k-a.options.indentUnit:typeof p=="number"&&(z=k+p),z=Math.max(0,z);var $="",q=0;if(a.options.indentWithTabs)for(var Z=Math.floor(z/x);Z;--Z)q+=x,$+="	";if(q<z&&($+=Ee(z-q)),$!=P)return ja(m,$,Q(d,0),Q(d,P.length),"+input"),E.stateAfter=null,!0;for(var te=0;te<m.sel.ranges.length;te++){var ae=m.sel.ranges[te];if(ae.head.line==d&&ae.head.ch<P.length){var pe=Q(d,P.length);Xp(m,te,new ht(pe,pe));break}}}var Vn=null;function Oc(a){Vn=a}function of(a,d,p,h,m){var b=a.doc;a.display.shift=!1,h||(h=b.sel);var x=+new Date-200,E=m=="paste"||a.state.pasteIncoming>x,k=un(d),P=null;if(E&&h.ranges.length>1)if(Vn&&Vn.text.join(`
`)==d){if(h.ranges.length%Vn.text.length==0){P=[];for(var z=0;z<Vn.text.length;z++)P.push(b.splitLines(Vn.text[z]))}}else k.length==h.ranges.length&&a.options.pasteLinesPerSelection&&(P=Je(k,function(me){return[me]}));for(var $=a.curOp.updateInput,q=h.ranges.length-1;q>=0;q--){var Z=h.ranges[q],te=Z.from(),ae=Z.to();Z.empty()&&(p&&p>0?te=Q(te.line,te.ch-p):a.state.overwrite&&!E?ae=Q(ae.line,Math.min(Ae(b,ae.line).text.length,ae.ch+ye(k).length)):E&&Vn&&Vn.lineWise&&Vn.text.join(`
`)==k.join(`
`)&&(te=ae=Q(te.line,0)));var pe={from:te,to:ae,text:P?P[q%P.length]:k,origin:m||(E?"paste":a.state.cutIncoming>x?"cut":"+input")};$a(a.doc,pe),ii(a,"inputRead",a,pe)}d&&!E&&sS(a,d),Ua(a),a.curOp.updateInput<2&&(a.curOp.updateInput=$),a.curOp.typing=!0,a.state.pasteIncoming=a.state.cutIncoming=-1}function rS(a,d){var p=a.clipboardData&&a.clipboardData.getData("Text");if(p)return a.preventDefault(),!d.isReadOnly()&&!d.options.disableInput&&d.hasFocus()&&Hi(d,function(){return of(d,p,0,null,"paste")}),!0}function sS(a,d){if(!(!a.options.electricChars||!a.options.smartIndent))for(var p=a.doc.sel,h=p.ranges.length-1;h>=0;h--){var m=p.ranges[h];if(!(m.head.ch>100||h&&p.ranges[h-1].head.line==m.head.line)){var b=a.getModeAt(m.head),x=!1;if(b.electricChars){for(var E=0;E<b.electricChars.length;E++)if(d.indexOf(b.electricChars.charAt(E))>-1){x=Ul(a,m.head.line,"smart");break}}else b.electricInput&&b.electricInput.test(Ae(a.doc,m.head.line).text.slice(0,m.head.ch))&&(x=Ul(a,m.head.line,"smart"));x&&ii(a,"electricInput",a,m.head.line)}}}function aS(a){for(var d=[],p=[],h=0;h<a.doc.sel.ranges.length;h++){var m=a.doc.sel.ranges[h].head.line,b={anchor:Q(m,0),head:Q(m+1,0)};p.push(b),d.push(a.getRange(b.anchor,b.head))}return{text:d,ranges:p}}function lf(a,d,p,h){a.setAttribute("autocorrect",p?"on":"off"),a.setAttribute("autocapitalize",h?"on":"off"),a.setAttribute("spellcheck",!!d)}function oS(){var a=F("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; min-height: 1em; outline: none"),d=F("div",[a],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return f?a.style.width="1000px":a.setAttribute("wrap","off"),I&&(a.style.border="1px solid black"),d}function iM(a){var d=a.optionHandlers,p=a.helpers={};a.prototype={constructor:a,focus:function(){ze(this).focus(),this.display.input.focus()},setOption:function(h,m){var b=this.options,x=b[h];b[h]==m&&h!="mode"||(b[h]=m,d.hasOwnProperty(h)&&ni(this,d[h])(this,m,x),Mt(this,"optionChange",this,h))},getOption:function(h){return this.options[h]},getDoc:function(){return this.doc},addKeyMap:function(h,m){this.state.keyMaps[m?"push":"unshift"](Rc(h))},removeKeyMap:function(h){for(var m=this.state.keyMaps,b=0;b<m.length;++b)if(m[b]==h||m[b].name==h)return m.splice(b,1),!0},addOverlay:xi(function(h,m){var b=h.token?h:a.getMode(this.options,h);if(b.startState)throw new Error("Overlays may not be stateful.");rt(this.state.overlays,{mode:b,modeSpec:h,opaque:m&&m.opaque,priority:m&&m.priority||0},function(x){return x.priority}),this.state.modeGen++,Ni(this)}),removeOverlay:xi(function(h){for(var m=this.state.overlays,b=0;b<m.length;++b){var x=m[b].modeSpec;if(x==h||typeof h=="string"&&x.name==h){m.splice(b,1),this.state.modeGen++,Ni(this);return}}}),indentLine:xi(function(h,m,b){typeof m!="string"&&typeof m!="number"&&(m==null?m=this.options.smartIndent?"smart":"prev":m=m?"add":"subtract"),ne(this.doc,h)&&Ul(this,h,m,b)}),indentSelection:xi(function(h){for(var m=this.doc.sel.ranges,b=-1,x=0;x<m.length;x++){var E=m[x];if(E.empty())E.head.line>b&&(Ul(this,E.head.line,h,!0),b=E.head.line,x==this.doc.sel.primIndex&&Ua(this));else{var k=E.from(),P=E.to(),z=Math.max(b,k.line);b=Math.min(this.lastLine(),P.line-(P.ch?0:1))+1;for(var $=z;$<b;++$)Ul(this,$,h);var q=this.doc.sel.ranges;k.ch==0&&m.length==q.length&&q[x].from().ch>0&&Xp(this.doc,x,new ht(k,q[x].to()),ei)}}}),getTokenAt:function(h,m){return v0(this,h,m)},getLineTokens:function(h,m){return v0(this,Q(h),m,!0)},getTokenTypeAt:function(h){h=$e(this.doc,h);var m=f0(this,Ae(this.doc,h.line)),b=0,x=(m.length-1)/2,E=h.ch,k;if(E==0)k=m[2];else for(;;){var P=b+x>>1;if((P?m[P*2-1]:0)>=E)x=P;else if(m[P*2+1]<E)b=P+1;else{k=m[P*2+2];break}}var z=k?k.indexOf("overlay "):-1;return z<0?k:z==0?null:k.slice(0,z-1)},getModeAt:function(h){var m=this.doc.mode;return m.innerMode?a.innerMode(m,this.getTokenAt(h).state).mode:m},getHelper:function(h,m){return this.getHelpers(h,m)[0]},getHelpers:function(h,m){var b=[];if(!p.hasOwnProperty(m))return b;var x=p[m],E=this.getModeAt(h);if(typeof E[m]=="string")x[E[m]]&&b.push(x[E[m]]);else if(E[m])for(var k=0;k<E[m].length;k++){var P=x[E[m][k]];P&&b.push(P)}else E.helperType&&x[E.helperType]?b.push(x[E.helperType]):x[E.name]&&b.push(x[E.name]);for(var z=0;z<x._global.length;z++){var $=x._global[z];$.pred(E,this)&&De(b,$.val)==-1&&b.push($.val)}return b},getStateAfter:function(h,m){var b=this.doc;return h=u0(b,h??b.first+b.size-1),fl(this,h+1,m).state},cursorCoords:function(h,m){var b,x=this.doc.sel.primary();return h==null?b=x.head:typeof h=="object"?b=$e(this.doc,h):b=h?x.from():x.to(),Rn(this,b,m||"page")},charCoords:function(h,m){return yc(this,$e(this.doc,h),m||"page")},coordsChar:function(h,m){return h=H0(this,h,m||"page"),Ap(this,h.left,h.top)},lineAtHeight:function(h,m){return h=H0(this,{top:h,left:0},m||"page").top,G(this.doc,h+this.display.viewOffset)},heightAtLine:function(h,m,b){var x=!1,E;if(typeof h=="number"){var k=this.doc.first+this.doc.size-1;h<this.doc.first?h=this.doc.first:h>k&&(h=k,x=!0),E=Ae(this.doc,h)}else E=h;return vc(this,E,{top:0,left:0},m||"page",b||x).top+(x?this.doc.height-br(E):0)},defaultTextHeight:function(){return Ba(this.display)},defaultCharWidth:function(){return _a(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(h,m,b,x,E){var k=this.display;h=Rn(this,$e(this.doc,h));var P=h.bottom,z=h.left;if(m.style.position="absolute",m.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(m),k.sizer.appendChild(m),x=="over")P=h.top;else if(x=="above"||x=="near"){var $=Math.max(k.wrapper.clientHeight,this.doc.height),q=Math.max(k.sizer.clientWidth,k.lineSpace.clientWidth);(x=="above"||h.bottom+m.offsetHeight>$)&&h.top>m.offsetHeight?P=h.top-m.offsetHeight:h.bottom+m.offsetHeight<=$&&(P=h.bottom),z+m.offsetWidth>q&&(z=q-m.offsetWidth)}m.style.top=P+"px",m.style.left=m.style.right="",E=="right"?(z=k.sizer.clientWidth-m.offsetWidth,m.style.right="0px"):(E=="left"?z=0:E=="middle"&&(z=(k.sizer.clientWidth-m.offsetWidth)/2),m.style.left=z+"px"),b&&QP(this,{left:z,top:P,right:z+m.offsetWidth,bottom:P+m.offsetHeight})},triggerOnKeyDown:xi(qb),triggerOnKeyPress:xi(Kb),triggerOnKeyUp:Yb,triggerOnMouseDown:xi(Xb),execCommand:function(h){if(Ol.hasOwnProperty(h))return Ol[h].call(null,this)},triggerElectric:xi(function(h){sS(this,h)}),findPosH:function(h,m,b,x){var E=1;m<0&&(E=-1,m=-m);for(var k=$e(this.doc,h),P=0;P<m&&(k=df(this.doc,k,E,b,x),!k.hitSide);++P);return k},moveH:xi(function(h,m){var b=this;this.extendSelectionsBy(function(x){return b.display.shift||b.doc.extend||x.empty()?df(b.doc,x.head,h,m,b.options.rtlMoveVisually):h<0?x.from():x.to()},ee)}),deleteH:xi(function(h,m){var b=this.doc.sel,x=this.doc;b.somethingSelected()?x.replaceSelection("",null,"+delete"):Za(this,function(E){var k=df(x,E.head,h,m,!1);return h<0?{from:k,to:E.head}:{from:E.head,to:k}})}),findPosV:function(h,m,b,x){var E=1,k=x;m<0&&(E=-1,m=-m);for(var P=$e(this.doc,h),z=0;z<m;++z){var $=Rn(this,P,"div");if(k==null?k=$.left:$.left=k,P=lS(this,$,E,b),P.hitSide)break}return P},moveV:xi(function(h,m){var b=this,x=this.doc,E=[],k=!this.display.shift&&!x.extend&&x.sel.somethingSelected();if(x.extendSelectionsBy(function(z){if(k)return h<0?z.from():z.to();var $=Rn(b,z.head,"div");z.goalColumn!=null&&($.left=z.goalColumn),E.push($.left);var q=lS(b,$,h,m);return m=="page"&&z==x.sel.primary()&&zp(b,yc(b,q,"div").top-$.top),q},ee),E.length)for(var P=0;P<x.sel.ranges.length;P++)x.sel.ranges[P].goalColumn=E[P]}),findWordAt:function(h){var m=this.doc,b=Ae(m,h.line).text,x=h.ch,E=h.ch;if(b){var k=this.getHelper(h,"wordChars");(h.sticky=="before"||E==b.length)&&x?--x:++E;for(var P=b.charAt(x),z=Ke(P,k)?function($){return Ke($,k)}:/\s/.test(P)?function($){return/\s/.test($)}:function($){return!/\s/.test($)&&!Ke($)};x>0&&z(b.charAt(x-1));)--x;for(;E<b.length&&z(b.charAt(E));)++E}return new ht(Q(h.line,x),Q(h.line,E))},toggleOverwrite:function(h){h!=null&&h==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?Le(this.display.cursorDiv,"CodeMirror-overwrite"):U(this.display.cursorDiv,"CodeMirror-overwrite"),Mt(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==ce(it(this))},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:xi(function(h,m){wl(this,h,m)}),getScrollInfo:function(){var h=this.display.scroller;return{left:h.scrollLeft,top:h.scrollTop,height:h.scrollHeight-Zn(this)-this.display.barHeight,width:h.scrollWidth-Zn(this)-this.display.barWidth,clientHeight:Ip(this),clientWidth:Os(this)}},scrollIntoView:xi(function(h,m){h==null?(h={from:this.doc.sel.primary().head,to:null},m==null&&(m=this.options.cursorScrollMargin)):typeof h=="number"?h={from:Q(h,0),to:null}:h.from==null&&(h={from:h,to:null}),h.to||(h.to=h.from),h.margin=m||0,h.from.line!=null?eA(this,h):tb(this,h.from,h.to,h.margin)}),setSize:xi(function(h,m){var b=this,x=function(k){return typeof k=="number"||/^\d+$/.test(String(k))?k+"px":k};h!=null&&(this.display.wrapper.style.width=x(h)),m!=null&&(this.display.wrapper.style.height=x(m)),this.options.lineWrapping&&W0(this);var E=this.display.viewFrom;this.doc.iter(E,this.display.viewTo,function(k){if(k.widgets){for(var P=0;P<k.widgets.length;P++)if(k.widgets[P].noHScroll){is(b,E,"widget");break}}++E}),this.curOp.forceUpdate=!0,Mt(this,"refresh",this)}),operation:function(h){return Hi(this,h)},startOperation:function(){return Gs(this)},endOperation:function(){return Ws(this)},refresh:xi(function(){var h=this.display.cachedTextHeight;Ni(this),this.curOp.forceUpdate=!0,bl(this),wl(this,this.doc.scrollLeft,this.doc.scrollTop),$p(this.display),(h==null||Math.abs(h-Ba(this.display))>.5||this.options.lineWrapping)&&Vp(this),Mt(this,"refresh",this)}),swapDoc:xi(function(h){var m=this.doc;return m.cm=null,this.state.selectingText&&this.state.selectingText(),gb(this,h),bl(this),this.display.input.reset(),wl(this,h.scrollLeft,h.scrollTop),this.curOp.forceScroll=!0,ii(this,"swapDoc",this,m),m}),phrase:function(h){var m=this.options.phrases;return m&&Object.prototype.hasOwnProperty.call(m,h)?m[h]:h},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},In(a),a.registerHelper=function(h,m,b){p.hasOwnProperty(h)||(p[h]=a[h]={_global:[]}),p[h][m]=b},a.registerGlobalHelper=function(h,m,b,x){a.registerHelper(h,m,x),p[h]._global.push({pred:b,val:x})}}function df(a,d,p,h,m){var b=d,x=p,E=Ae(a,d.line),k=m&&a.direction=="rtl"?-p:p;function P(){var Ce=d.line+k;return Ce<a.first||Ce>=a.first+a.size?!1:(d=new Q(Ce,d.ch,d.sticky),E=Ae(a,Ce))}function z(Ce){var ve;if(h=="codepoint"){var ke=E.text.charCodeAt(d.ch+(p>0?0:-1));if(isNaN(ke))ve=null;else{var Fe=p>0?ke>=55296&&ke<56320:ke>=56320&&ke<57343;ve=new Q(d.line,Math.max(0,Math.min(E.text.length,d.ch+p*(Fe?2:1))),-p)}}else m?ve=BA(a.cm,E,d,p):ve=ef(E,d,p);if(ve==null)if(!Ce&&P())d=tf(m,a.cm,E,d.line,k);else return!1;else d=ve;return!0}if(h=="char"||h=="codepoint")z();else if(h=="column")z(!0);else if(h=="word"||h=="group")for(var $=null,q=h=="group",Z=a.cm&&a.cm.getHelper(d,"wordChars"),te=!0;!(p<0&&!z(!te));te=!1){var ae=E.text.charAt(d.ch)||`
`,pe=Ke(ae,Z)?"w":q&&ae==`
`?"n":!q||/\s/.test(ae)?null:"p";if(q&&!te&&!pe&&(pe="s"),$&&$!=pe){p<0&&(p=1,z(),d.sticky="after");break}if(pe&&($=pe),p>0&&!z(!te))break}var me=Pc(a,d,b,x,!0);return ut(b,me)&&(me.hitSide=!0),me}function lS(a,d,p,h){var m=a.doc,b=d.left,x;if(h=="page"){var E=Math.min(a.display.wrapper.clientHeight,ze(a).innerHeight||m(a).documentElement.clientHeight),k=Math.max(E-.5*Ba(a.display),3);x=(p>0?d.bottom:d.top)+p*k}else h=="line"&&(x=p>0?d.bottom+3:d.top-3);for(var P;P=Ap(a,b,x),!!P.outside;){if(p<0?x<=0:x>=m.height){P.hitSide=!0;break}x+=p*5}return P}var yt=function(a){this.cm=a,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Ge,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};yt.prototype.init=function(a){var d=this,p=this,h=p.cm,m=p.div=a.lineDiv;m.contentEditable=!0,lf(m,h.options.spellcheck,h.options.autocorrect,h.options.autocapitalize);function b(E){for(var k=E.target;k;k=k.parentNode){if(k==m)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(k.className))break}return!1}Oe(m,"paste",function(E){!b(E)||Rt(h,E)||rS(E,h)||u<=11&&setTimeout(ni(h,function(){return d.updateFromDOM()}),20)}),Oe(m,"compositionstart",function(E){d.composing={data:E.data,done:!1}}),Oe(m,"compositionupdate",function(E){d.composing||(d.composing={data:E.data,done:!1})}),Oe(m,"compositionend",function(E){d.composing&&(E.data!=d.composing.data&&d.readFromDOMSoon(),d.composing.done=!0)}),Oe(m,"touchstart",function(){return p.forceCompositionEnd()}),Oe(m,"input",function(){d.composing||d.readFromDOMSoon()});function x(E){if(!(!b(E)||Rt(h,E))){if(h.somethingSelected())Oc({lineWise:!1,text:h.getSelections()}),E.type=="cut"&&h.replaceSelection("",null,"cut");else if(h.options.lineWiseCopyCut){var k=aS(h);Oc({lineWise:!0,text:k.text}),E.type=="cut"&&h.operation(function(){h.setSelections(k.ranges,0,ei),h.replaceSelection("",null,"cut")})}else return;if(E.clipboardData){E.clipboardData.clearData();var P=Vn.text.join(`
`);if(E.clipboardData.setData("Text",P),E.clipboardData.getData("Text")==P){E.preventDefault();return}}var z=oS(),$=z.firstChild;lf($),h.display.lineSpace.insertBefore(z,h.display.lineSpace.firstChild),$.value=Vn.text.join(`
`);var q=ce(ot(m));qe($),setTimeout(function(){h.display.lineSpace.removeChild(z),q.focus(),q==m&&p.showPrimarySelection()},50)}}Oe(m,"copy",x),Oe(m,"cut",x)},yt.prototype.screenReaderLabelChanged=function(a){a?this.div.setAttribute("aria-label",a):this.div.removeAttribute("aria-label")},yt.prototype.prepareSelection=function(){var a=X0(this.cm,!1);return a.focus=ce(ot(this.div))==this.div,a},yt.prototype.showSelection=function(a,d){!a||!this.cm.display.view.length||((a.focus||d)&&this.showPrimarySelection(),this.showMultipleSelections(a))},yt.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},yt.prototype.showPrimarySelection=function(){var a=this.getSelection(),d=this.cm,p=d.doc.sel.primary(),h=p.from(),m=p.to();if(d.display.viewTo==d.display.viewFrom||h.line>=d.display.viewTo||m.line<d.display.viewFrom){a.removeAllRanges();return}var b=Bc(d,a.anchorNode,a.anchorOffset),x=Bc(d,a.focusNode,a.focusOffset);if(!(b&&!b.bad&&x&&!x.bad&&be(Ra(b,x),h)==0&&be(Ri(b,x),m)==0)){var E=d.display.view,k=h.line>=d.display.viewFrom&&dS(d,h)||{node:E[0].measure.map[2],offset:0},P=m.line<d.display.viewTo&&dS(d,m);if(!P){var z=E[E.length-1].measure,$=z.maps?z.maps[z.maps.length-1]:z.map;P={node:$[$.length-1],offset:$[$.length-2]-$[$.length-3]}}if(!k||!P){a.removeAllRanges();return}var q=a.rangeCount&&a.getRangeAt(0),Z;try{Z=de(k.node,k.offset,P.offset,P.node)}catch{}Z&&(!r&&d.state.focused?(a.collapse(k.node,k.offset),Z.collapsed||(a.removeAllRanges(),a.addRange(Z))):(a.removeAllRanges(),a.addRange(Z)),q&&a.anchorNode==null?a.addRange(q):r&&this.startGracePeriod()),this.rememberSelection()}},yt.prototype.startGracePeriod=function(){var a=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){a.gracePeriod=!1,a.selectionChanged()&&a.cm.operation(function(){return a.cm.curOp.selectionChanged=!0})},20)},yt.prototype.showMultipleSelections=function(a){W(this.cm.display.cursorDiv,a.cursors),W(this.cm.display.selectionDiv,a.selection)},yt.prototype.rememberSelection=function(){var a=this.getSelection();this.lastAnchorNode=a.anchorNode,this.lastAnchorOffset=a.anchorOffset,this.lastFocusNode=a.focusNode,this.lastFocusOffset=a.focusOffset},yt.prototype.selectionInEditor=function(){var a=this.getSelection();if(!a.rangeCount)return!1;var d=a.getRangeAt(0).commonAncestorContainer;return Re(this.div,d)},yt.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||ce(ot(this.div))!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},yt.prototype.blur=function(){this.div.blur()},yt.prototype.getField=function(){return this.div},yt.prototype.supportsTouch=function(){return!0},yt.prototype.receivedFocus=function(){var a=this,d=this;this.selectionInEditor()?setTimeout(function(){return a.pollSelection()},20):Hi(this.cm,function(){return d.cm.curOp.selectionChanged=!0});function p(){d.cm.state.focused&&(d.pollSelection(),d.polling.set(d.cm.options.pollInterval,p))}this.polling.set(this.cm.options.pollInterval,p)},yt.prototype.selectionChanged=function(){var a=this.getSelection();return a.anchorNode!=this.lastAnchorNode||a.anchorOffset!=this.lastAnchorOffset||a.focusNode!=this.lastFocusNode||a.focusOffset!=this.lastFocusOffset},yt.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var a=this.getSelection(),d=this.cm;if(M&&v&&this.cm.display.gutterSpecs.length&&nM(a.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var p=Bc(d,a.anchorNode,a.anchorOffset),h=Bc(d,a.focusNode,a.focusOffset);p&&h&&Hi(d,function(){bi(d.doc,rs(p,h),ei),(p.bad||h.bad)&&(d.curOp.selectionChanged=!0)})}}},yt.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var a=this.cm,d=a.display,p=a.doc.sel.primary(),h=p.from(),m=p.to();if(h.ch==0&&h.line>a.firstLine()&&(h=Q(h.line-1,Ae(a.doc,h.line-1).length)),m.ch==Ae(a.doc,m.line).text.length&&m.line<a.lastLine()&&(m=Q(m.line+1,0)),h.line<d.viewFrom||m.line>d.viewTo-1)return!1;var b,x,E;h.line==d.viewFrom||(b=Fs(a,h.line))==0?(x=N(d.view[0].line),E=d.view[0].node):(x=N(d.view[b].line),E=d.view[b-1].node.nextSibling);var k=Fs(a,m.line),P,z;if(k==d.view.length-1?(P=d.viewTo-1,z=d.lineDiv.lastChild):(P=N(d.view[k+1].line)-1,z=d.view[k+1].node.previousSibling),!E)return!1;for(var $=a.doc.splitLines(rM(a,E,z,x,P)),q=vr(a.doc,Q(x,0),Q(P,Ae(a.doc,P).text.length));$.length>1&&q.length>1;)if(ye($)==ye(q))$.pop(),q.pop(),P--;else if($[0]==q[0])$.shift(),q.shift(),x++;else break;for(var Z=0,te=0,ae=$[0],pe=q[0],me=Math.min(ae.length,pe.length);Z<me&&ae.charCodeAt(Z)==pe.charCodeAt(Z);)++Z;for(var Ce=ye($),ve=ye(q),ke=Math.min(Ce.length-($.length==1?Z:0),ve.length-(q.length==1?Z:0));te<ke&&Ce.charCodeAt(Ce.length-te-1)==ve.charCodeAt(ve.length-te-1);)++te;if($.length==1&&q.length==1&&x==h.line)for(;Z&&Z>h.ch&&Ce.charCodeAt(Ce.length-te-1)==ve.charCodeAt(ve.length-te-1);)Z--,te++;$[$.length-1]=Ce.slice(0,Ce.length-te).replace(/^\u200b+/,""),$[0]=$[0].slice(Z).replace(/\u200b+$/,"");var Fe=Q(x,Z),Ve=Q(P,q.length?ye(q).length-te:0);if($.length>1||$[0]||be(Fe,Ve))return ja(a.doc,$,Fe,Ve,"+input"),!0},yt.prototype.ensurePolled=function(){this.forceCompositionEnd()},yt.prototype.reset=function(){this.forceCompositionEnd()},yt.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},yt.prototype.readFromDOMSoon=function(){var a=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(a.readDOMTimeout=null,a.composing)if(a.composing.done)a.composing=null;else return;a.updateFromDOM()},80))},yt.prototype.updateFromDOM=function(){var a=this;(this.cm.isReadOnly()||!this.pollContent())&&Hi(this.cm,function(){return Ni(a.cm)})},yt.prototype.setUneditable=function(a){a.contentEditable="false"},yt.prototype.onKeyPress=function(a){a.charCode==0||this.composing||(a.preventDefault(),this.cm.isReadOnly()||ni(this.cm,of)(this.cm,String.fromCharCode(a.charCode==null?a.keyCode:a.charCode),0))},yt.prototype.readOnlyChanged=function(a){this.div.contentEditable=String(a!="nocursor")},yt.prototype.onContextMenu=function(){},yt.prototype.resetPosition=function(){},yt.prototype.needsContentAttribute=!0;function dS(a,d){var p=Tp(a,d.line);if(!p||p.hidden)return null;var h=Ae(a.doc,d.line),m=_0(p,h,d.line),b=Xe(h,a.doc.direction),x="left";if(b){var E=Yr(b,d.ch);x=E%2?"right":"left"}var k=z0(m.map,d.ch,x);return k.offset=k.collapse=="right"?k.end:k.start,k}function nM(a){for(var d=a;d;d=d.parentNode)if(/CodeMirror-gutter-wrapper/.test(d.className))return!0;return!1}function Ya(a,d){return d&&(a.bad=!0),a}function rM(a,d,p,h,m){var b="",x=!1,E=a.doc.lineSeparator(),k=!1;function P(Z){return function(te){return te.id==Z}}function z(){x&&(b+=E,k&&(b+=E),x=k=!1)}function $(Z){Z&&(z(),b+=Z)}function q(Z){if(Z.nodeType==1){var te=Z.getAttribute("cm-text");if(te){$(te);return}var ae=Z.getAttribute("cm-marker"),pe;if(ae){var me=a.findMarks(Q(h,0),Q(m+1,0),P(+ae));me.length&&(pe=me[0].find(0))&&$(vr(a.doc,pe.from,pe.to).join(E));return}if(Z.getAttribute("contenteditable")=="false")return;var Ce=/^(pre|div|p|li|table|br)$/i.test(Z.nodeName);if(!/^br$/i.test(Z.nodeName)&&Z.textContent.length==0)return;Ce&&z();for(var ve=0;ve<Z.childNodes.length;ve++)q(Z.childNodes[ve]);/^(pre|p)$/i.test(Z.nodeName)&&(k=!0),Ce&&(x=!0)}else Z.nodeType==3&&$(Z.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;q(d),d!=p;)d=d.nextSibling,k=!1;return b}function Bc(a,d,p){var h;if(d==a.display.lineDiv){if(h=a.display.lineDiv.childNodes[p],!h)return Ya(a.clipPos(Q(a.display.viewTo-1)),!0);d=null,p=0}else for(h=d;;h=h.parentNode){if(!h||h==a.display.lineDiv)return null;if(h.parentNode&&h.parentNode==a.display.lineDiv)break}for(var m=0;m<a.display.view.length;m++){var b=a.display.view[m];if(b.node==h)return sM(b,d,p)}}function sM(a,d,p){var h=a.text.firstChild,m=!1;if(!d||!Re(h,d))return Ya(Q(N(a.line),0),!0);if(d==h&&(m=!0,d=h.childNodes[p],p=0,!d)){var b=a.rest?ye(a.rest):a.line;return Ya(Q(N(b),b.text.length),m)}var x=d.nodeType==3?d:null,E=d;for(!x&&d.childNodes.length==1&&d.firstChild.nodeType==3&&(x=d.firstChild,p&&(p=x.nodeValue.length));E.parentNode!=h;)E=E.parentNode;var k=a.measure,P=k.maps;function z(pe,me,Ce){for(var ve=-1;ve<(P?P.length:0);ve++)for(var ke=ve<0?k.map:P[ve],Fe=0;Fe<ke.length;Fe+=3){var Ve=ke[Fe+2];if(Ve==pe||Ve==me){var Ye=N(ve<0?a.line:a.rest[ve]),xt=ke[Fe]+Ce;return(Ce<0||Ve!=pe)&&(xt=ke[Fe+(Ce?1:0)]),Q(Ye,xt)}}}var $=z(x,E,p);if($)return Ya($,m);for(var q=E.nextSibling,Z=x?x.nodeValue.length-p:0;q;q=q.nextSibling){if($=z(q,q.firstChild,0),$)return Ya(Q($.line,$.ch-Z),m);Z+=q.textContent.length}for(var te=E.previousSibling,ae=p;te;te=te.previousSibling){if($=z(te,te.firstChild,-1),$)return Ya(Q($.line,$.ch+ae),m);ae+=te.textContent.length}}var Ut=function(a){this.cm=a,this.prevInput="",this.pollingFast=!1,this.polling=new Ge,this.hasSelection=!1,this.composing=null,this.resetting=!1};Ut.prototype.init=function(a){var d=this,p=this,h=this.cm;this.createField(a);var m=this.textarea;a.wrapper.insertBefore(this.wrapper,a.wrapper.firstChild),I&&(m.style.width="0px"),Oe(m,"input",function(){c&&u>=9&&d.hasSelection&&(d.hasSelection=null),p.poll()}),Oe(m,"paste",function(x){Rt(h,x)||rS(x,h)||(h.state.pasteIncoming=+new Date,p.fastPoll())});function b(x){if(!Rt(h,x)){if(h.somethingSelected())Oc({lineWise:!1,text:h.getSelections()});else if(h.options.lineWiseCopyCut){var E=aS(h);Oc({lineWise:!0,text:E.text}),x.type=="cut"?h.setSelections(E.ranges,null,ei):(p.prevInput="",m.value=E.text.join(`
`),qe(m))}else return;x.type=="cut"&&(h.state.cutIncoming=+new Date)}}Oe(m,"cut",b),Oe(m,"copy",b),Oe(a.scroller,"paste",function(x){if(!(Sr(a,x)||Rt(h,x))){if(!m.dispatchEvent){h.state.pasteIncoming=+new Date,p.focus();return}var E=new Event("paste");E.clipboardData=x.clipboardData,m.dispatchEvent(E)}}),Oe(a.lineSpace,"selectstart",function(x){Sr(a,x)||yi(x)}),Oe(m,"compositionstart",function(){var x=h.getCursor("from");p.composing&&p.composing.range.clear(),p.composing={start:x,range:h.markText(x,h.getCursor("to"),{className:"CodeMirror-composing"})}}),Oe(m,"compositionend",function(){p.composing&&(p.poll(),p.composing.range.clear(),p.composing=null)})},Ut.prototype.createField=function(a){this.wrapper=oS(),this.textarea=this.wrapper.firstChild;var d=this.cm.options;lf(this.textarea,d.spellcheck,d.autocorrect,d.autocapitalize)},Ut.prototype.screenReaderLabelChanged=function(a){a?this.textarea.setAttribute("aria-label",a):this.textarea.removeAttribute("aria-label")},Ut.prototype.prepareSelection=function(){var a=this.cm,d=a.display,p=a.doc,h=X0(a);if(a.options.moveInputWithCursor){var m=Rn(a,p.sel.primary().head,"div"),b=d.wrapper.getBoundingClientRect(),x=d.lineDiv.getBoundingClientRect();h.teTop=Math.max(0,Math.min(d.wrapper.clientHeight-10,m.top+x.top-b.top)),h.teLeft=Math.max(0,Math.min(d.wrapper.clientWidth-10,m.left+x.left-b.left))}return h},Ut.prototype.showSelection=function(a){var d=this.cm,p=d.display;W(p.cursorDiv,a.cursors),W(p.selectionDiv,a.selection),a.teTop!=null&&(this.wrapper.style.top=a.teTop+"px",this.wrapper.style.left=a.teLeft+"px")},Ut.prototype.reset=function(a){if(!(this.contextMenuPending||this.composing&&a)){var d=this.cm;if(this.resetting=!0,d.somethingSelected()){this.prevInput="";var p=d.getSelection();this.textarea.value=p,d.state.focused&&qe(this.textarea),c&&u>=9&&(this.hasSelection=p)}else a||(this.prevInput=this.textarea.value="",c&&u>=9&&(this.hasSelection=null));this.resetting=!1}},Ut.prototype.getField=function(){return this.textarea},Ut.prototype.supportsTouch=function(){return!1},Ut.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!R||ce(ot(this.textarea))!=this.textarea))try{this.textarea.focus()}catch{}},Ut.prototype.blur=function(){this.textarea.blur()},Ut.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Ut.prototype.receivedFocus=function(){this.slowPoll()},Ut.prototype.slowPoll=function(){var a=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){a.poll(),a.cm.state.focused&&a.slowPoll()})},Ut.prototype.fastPoll=function(){var a=!1,d=this;d.pollingFast=!0;function p(){var h=d.poll();!h&&!a?(a=!0,d.polling.set(60,p)):(d.pollingFast=!1,d.slowPoll())}d.polling.set(20,p)},Ut.prototype.poll=function(){var a=this,d=this.cm,p=this.textarea,h=this.prevInput;if(this.contextMenuPending||this.resetting||!d.state.focused||Qr(p)&&!h&&!this.composing||d.isReadOnly()||d.options.disableInput||d.state.keySeq)return!1;var m=p.value;if(m==h&&!d.somethingSelected())return!1;if(c&&u>=9&&this.hasSelection===m||D&&/[\uf700-\uf7ff]/.test(m))return d.display.input.reset(),!1;if(d.doc.sel==d.display.selForContextMenu){var b=m.charCodeAt(0);if(b==8203&&!h&&(h="​"),b==8666)return this.reset(),this.cm.execCommand("undo")}for(var x=0,E=Math.min(h.length,m.length);x<E&&h.charCodeAt(x)==m.charCodeAt(x);)++x;return Hi(d,function(){of(d,m.slice(x),h.length-x,null,a.composing?"*compose":null),m.length>1e3||m.indexOf(`
`)>-1?p.value=a.prevInput="":a.prevInput=m,a.composing&&(a.composing.range.clear(),a.composing.range=d.markText(a.composing.start,d.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Ut.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Ut.prototype.onKeyPress=function(){c&&u>=9&&(this.hasSelection=null),this.fastPoll()},Ut.prototype.onContextMenu=function(a){var d=this,p=d.cm,h=p.display,m=d.textarea;d.contextMenuPending&&d.contextMenuPending();var b=_s(p,a),x=h.scroller.scrollTop;if(!b||C)return;var E=p.options.resetSelectionOnContextMenu;E&&p.doc.sel.contains(b)==-1&&ni(p,bi)(p.doc,rs(b),ei);var k=m.style.cssText,P=d.wrapper.style.cssText,z=d.wrapper.offsetParent.getBoundingClientRect();d.wrapper.style.cssText="position: static",m.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(a.clientY-z.top-5)+"px; left: "+(a.clientX-z.left-5)+`px;
      z-index: 1000; background: `+(c?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var $;f&&($=m.ownerDocument.defaultView.scrollY),h.input.focus(),f&&m.ownerDocument.defaultView.scrollTo(null,$),h.input.reset(),p.somethingSelected()||(m.value=d.prevInput=" "),d.contextMenuPending=Z,h.selForContextMenu=p.doc.sel,clearTimeout(h.detectingSelectAll);function q(){if(m.selectionStart!=null){var ae=p.somethingSelected(),pe="​"+(ae?m.value:"");m.value="⇚",m.value=pe,d.prevInput=ae?"":"​",m.selectionStart=1,m.selectionEnd=pe.length,h.selForContextMenu=p.doc.sel}}function Z(){if(d.contextMenuPending==Z&&(d.contextMenuPending=!1,d.wrapper.style.cssText=P,m.style.cssText=k,c&&u<9&&h.scrollbars.setScrollTop(h.scroller.scrollTop=x),m.selectionStart!=null)){(!c||c&&u<9)&&q();var ae=0,pe=function(){h.selForContextMenu==p.doc.sel&&m.selectionStart==0&&m.selectionEnd>0&&d.prevInput=="​"?ni(p,Tb)(p):ae++<10?h.detectingSelectAll=setTimeout(pe,500):(h.selForContextMenu=null,h.input.reset())};h.detectingSelectAll=setTimeout(pe,200)}}if(c&&u>=9&&q(),_){Kr(a);var te=function(){vi(window,"mouseup",te),setTimeout(Z,20)};Oe(window,"mouseup",te)}else setTimeout(Z,50)},Ut.prototype.readOnlyChanged=function(a){a||this.reset(),this.textarea.disabled=a=="nocursor",this.textarea.readOnly=!!a},Ut.prototype.setUneditable=function(){},Ut.prototype.needsContentAttribute=!1;function aM(a,d){if(d=d?Ue(d):{},d.value=a.value,!d.tabindex&&a.tabIndex&&(d.tabindex=a.tabIndex),!d.placeholder&&a.placeholder&&(d.placeholder=a.placeholder),d.autofocus==null){var p=ce(ot(a));d.autofocus=p==a||a.getAttribute("autofocus")!=null&&p==document.body}function h(){a.value=E.getValue()}var m;if(a.form&&(Oe(a.form,"submit",h),!d.leaveSubmitMethodAlone)){var b=a.form;m=b.submit;try{var x=b.submit=function(){h(),b.submit=m,b.submit(),b.submit=x}}catch{}}d.finishInit=function(k){k.save=h,k.getTextArea=function(){return a},k.toTextArea=function(){k.toTextArea=isNaN,h(),a.parentNode.removeChild(k.getWrapperElement()),a.style.display="",a.form&&(vi(a.form,"submit",h),!d.leaveSubmitMethodAlone&&typeof a.form.submit=="function"&&(a.form.submit=m))}},a.style.display="none";var E=Dt(function(k){return a.parentNode.insertBefore(k,a.nextSibling)},d);return E}function oM(a){a.off=vi,a.on=Oe,a.wheelEventPixels=fA,a.Doc=Vi,a.splitLines=un,a.countColumn=We,a.findColumn=ie,a.isWordChar=jt,a.Pass=dn,a.signal=Mt,a.Line=Na,a.changeEnd=ss,a.scrollbarModel=rb,a.Pos=Q,a.cmpPos=be,a.modes=Ia,a.mimeModes=Pn,a.resolveMode=Da,a.getMode=Pa,a.modeExtensions=es,a.extendMode=Aa,a.copyState=Hn,a.startState=Ma,a.innerMode=hl,a.commands=Ol,a.keyMap=Cr,a.keyName=$b,a.isModifierKey=Gb,a.lookupKey=Ja,a.normalizeKeyMap=OA,a.StringStream=Nt,a.SharedTextMarker=Rl,a.TextMarker=os,a.LineWidget=Ml,a.e_preventDefault=yi,a.e_stopPropagation=La,a.e_stop=Kr,a.addClass=Le,a.contains=Re,a.rmClass=U,a.keyNames=ls}XA(Dt),iM(Dt);var lM="iter insert remove copy getEditor constructor".split(" ");for(var _c in Vi.prototype)Vi.prototype.hasOwnProperty(_c)&&De(lM,_c)<0&&(Dt.prototype[_c]=function(a){return function(){return a.apply(this.doc,arguments)}}(Vi.prototype[_c]));return In(Vi),Dt.inputStyles={textarea:Ut,contenteditable:yt},Dt.defineMode=function(a){!Dt.defaults.mode&&a!="null"&&(Dt.defaults.mode=a),An.apply(this,arguments)},Dt.defineMIME=Ta,Dt.defineMode("null",function(){return{token:function(a){return a.skipToEnd()}}}),Dt.defineMIME("text/plain","null"),Dt.defineExtension=function(a,d){Dt.prototype[a]=d},Dt.defineDocExtension=function(a,d){Vi.prototype[a]=d},Dt.fromTextArea=aM,oM(Dt),Dt.version="5.65.18",Dt})}(QC)),QC.exports}(function(i,e){(function(t){t(sl())})(function(t){t.defineMode("javascript",function(n,r){var s=n.indentUnit,o=r.statementIndent,l=r.jsonld,c=r.json||l,u=r.trackScope!==!1,f=r.typescript,g=r.wordCharacters||/[\w$\xa1-\uffff]/,v=function(){function N(ti){return{type:ti,style:"keyword"}}var G=N("keyword a"),ne=N("keyword b"),he=N("keyword c"),Q=N("keyword d"),be=N("operator"),ut={type:"atom",style:"atom"};return{if:N("if"),while:G,with:G,else:ne,do:ne,try:ne,finally:ne,return:Q,break:Q,continue:Q,new:N("new"),delete:he,void:he,throw:he,debugger:N("debugger"),var:N("var"),const:N("var"),let:N("var"),function:N("function"),catch:N("catch"),for:N("for"),switch:N("switch"),case:N("case"),default:N("default"),in:be,typeof:be,instanceof:be,true:ut,false:ut,null:ut,undefined:ut,NaN:ut,Infinity:ut,this:N("this"),class:N("class"),super:N("atom"),yield:he,export:N("export"),import:N("import"),extends:he,await:he}}(),y=/[+\-*&%=<>!?|~^@]/,C=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function w(N){for(var G=!1,ne,he=!1;(ne=N.next())!=null;){if(!G){if(ne=="/"&&!he)return;ne=="["?he=!0:he&&ne=="]"&&(he=!1)}G=!G&&ne=="\\"}}var S,L;function I(N,G,ne){return S=N,L=ne,G}function M(N,G){var ne=N.next();if(ne=='"'||ne=="'")return G.tokenize=R(ne),G.tokenize(N,G);if(ne=="."&&N.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return I("number","number");if(ne=="."&&N.match(".."))return I("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(ne))return I(ne);if(ne=="="&&N.eat(">"))return I("=>","operator");if(ne=="0"&&N.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return I("number","number");if(/\d/.test(ne))return N.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),I("number","number");if(ne=="/")return N.eat("*")?(G.tokenize=D,D(N,G)):N.eat("/")?(N.skipToEnd(),I("comment","comment")):Qi(N,G,1)?(w(N),N.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),I("regexp","string-2")):(N.eat("="),I("operator","operator",N.current()));if(ne=="`")return G.tokenize=T,T(N,G);if(ne=="#"&&N.peek()=="!")return N.skipToEnd(),I("meta","meta");if(ne=="#"&&N.eatWhile(g))return I("variable","property");if(ne=="<"&&N.match("!--")||ne=="-"&&N.match("->")&&!/\S/.test(N.string.slice(0,N.start)))return N.skipToEnd(),I("comment","comment");if(y.test(ne))return(ne!=">"||!G.lexical||G.lexical.type!=">")&&(N.eat("=")?(ne=="!"||ne=="=")&&N.eat("="):/[<>*+\-|&?]/.test(ne)&&(N.eat(ne),ne==">"&&N.eat(ne))),ne=="?"&&N.eat(".")?I("."):I("operator","operator",N.current());if(g.test(ne)){N.eatWhile(g);var he=N.current();if(G.lastType!="."){if(v.propertyIsEnumerable(he)){var Q=v[he];return I(Q.type,Q.style,he)}if(he=="async"&&N.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return I("async","keyword",he)}return I("variable","variable",he)}}function R(N){return function(G,ne){var he=!1,Q;if(l&&G.peek()=="@"&&G.match(C))return ne.tokenize=M,I("jsonld-keyword","meta");for(;(Q=G.next())!=null&&!(Q==N&&!he);)he=!he&&Q=="\\";return he||(ne.tokenize=M),I("string","string")}}function D(N,G){for(var ne=!1,he;he=N.next();){if(he=="/"&&ne){G.tokenize=M;break}ne=he=="*"}return I("comment","comment")}function T(N,G){for(var ne=!1,he;(he=N.next())!=null;){if(!ne&&(he=="`"||he=="$"&&N.eat("{"))){G.tokenize=M;break}ne=!ne&&he=="\\"}return I("quasi","string-2",N.current())}var A="([{}])";function V(N,G){G.fatArrowAt&&(G.fatArrowAt=null);var ne=N.string.indexOf("=>",N.start);if(!(ne<0)){if(f){var he=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(N.string.slice(N.start,ne));he&&(ne=he.index)}for(var Q=0,be=!1,ut=ne-1;ut>=0;--ut){var ti=N.string.charAt(ut),Ri=A.indexOf(ti);if(Ri>=0&&Ri<3){if(!Q){++ut;break}if(--Q==0){ti=="("&&(be=!0);break}}else if(Ri>=3&&Ri<6)++Q;else if(g.test(ti))be=!0;else if(/["'\/`]/.test(ti))for(;;--ut){if(ut==0)return;var Ra=N.string.charAt(ut-1);if(Ra==ti&&N.string.charAt(ut-2)!="\\"){ut--;break}}else if(be&&!Q){++ut;break}}be&&!Q&&(G.fatArrowAt=ut)}}var O={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function _(N,G,ne,he,Q,be){this.indented=N,this.column=G,this.type=ne,this.prev=Q,this.info=be,he!=null&&(this.align=he)}function H(N,G){if(!u)return!1;for(var ne=N.localVars;ne;ne=ne.next)if(ne.name==G)return!0;for(var he=N.context;he;he=he.prev)for(var ne=he.vars;ne;ne=ne.next)if(ne.name==G)return!0}function U(N,G,ne,he,Q){var be=N.cc;for(B.state=N,B.stream=Q,B.marked=null,B.cc=be,B.style=G,N.lexical.hasOwnProperty("align")||(N.lexical.align=!0);;){var ut=be.length?be.pop():c?De:We;if(ut(ne,he)){for(;be.length&&be[be.length-1].lex;)be.pop()();return B.marked?B.marked:ne=="variable"&&H(N,he)?"variable-2":G}}}var B={state:null,marked:null,cc:null};function W(){for(var N=arguments.length-1;N>=0;N--)B.cc.push(arguments[N])}function F(){return W.apply(null,arguments),!0}function le(N,G){for(var ne=G;ne;ne=ne.next)if(ne.name==N)return!0;return!1}function de(N){var G=B.state;if(B.marked="def",!!u){if(G.context){if(G.lexical.info=="var"&&G.context&&G.context.block){var ne=Re(N,G.context);if(ne!=null){G.context=ne;return}}else if(!le(N,G.localVars)){G.localVars=new Be(N,G.localVars);return}}r.globalVars&&!le(N,G.globalVars)&&(G.globalVars=new Be(N,G.globalVars))}}function Re(N,G){if(G)if(G.block){var ne=Re(N,G.prev);return ne?ne==G.prev?G:new Le(ne,G.vars,!0):null}else return le(N,G.vars)?G:new Le(G.prev,new Be(N,G.vars),!1);else return null}function ce(N){return N=="public"||N=="private"||N=="protected"||N=="abstract"||N=="readonly"}function Le(N,G,ne){this.prev=N,this.vars=G,this.block=ne}function Be(N,G){this.name=N,this.next=G}var qe=new Be("this",new Be("arguments",null));function Ze(){B.state.context=new Le(B.state.context,B.state.localVars,!1),B.state.localVars=qe}function it(){B.state.context=new Le(B.state.context,B.state.localVars,!0),B.state.localVars=null}Ze.lex=it.lex=!0;function ot(){B.state.localVars=B.state.context.vars,B.state.context=B.state.context.prev}ot.lex=!0;function ze(N,G){var ne=function(){var he=B.state,Q=he.indented;if(he.lexical.type=="stat")Q=he.lexical.indented;else for(var be=he.lexical;be&&be.type==")"&&be.align;be=be.prev)Q=be.indented;he.lexical=new _(Q,B.stream.column(),N,null,he.lexical,G)};return ne.lex=!0,ne}function Pe(){var N=B.state;N.lexical.prev&&(N.lexical.type==")"&&(N.indented=N.lexical.indented),N.lexical=N.lexical.prev)}Pe.lex=!0;function Ue(N){function G(ne){return ne==N?F():N==";"||ne=="}"||ne==")"||ne=="]"?W():F(G)}return G}function We(N,G){return N=="var"?F(ze("vardef",G),La,Ue(";"),Pe):N=="keyword a"?F(ze("form"),dn,We,Pe):N=="keyword b"?F(ze("form"),We,Pe):N=="keyword d"?B.stream.match(/^\s*$/,!1)?F():F(ze("stat"),X,Ue(";"),Pe):N=="debugger"?F(Ue(";")):N=="{"?F(ze("}"),it,Kt,Pe,ot):N==";"?F():N=="if"?(B.state.lexical.info=="else"&&B.state.cc[B.state.cc.length-1]==Pe&&B.state.cc.pop()(),F(ze("form"),dn,We,Pe,ka)):N=="function"?F(un):N=="for"?F(ze("form"),it,oc,We,ot,Pe):N=="class"||f&&G=="interface"?(B.marked="keyword",F(ze("form",N=="class"?N:G),Ia,Pe)):N=="variable"?f&&G=="declare"?(B.marked="keyword",F(We)):f&&(G=="module"||G=="enum"||G=="type")&&B.stream.match(/^\s*\w/,!1)?(B.marked="keyword",G=="enum"?F(Ae):G=="type"?F(lc,Ue("operator"),Xe,Ue(";")):F(ze("form"),Mi,Ue("{"),ze("}"),Kt,Pe,Pe)):f&&G=="namespace"?(B.marked="keyword",F(ze("form"),De,We,Pe)):f&&G=="abstract"?(B.marked="keyword",F(We)):F(ze("stat"),Pt):N=="switch"?F(ze("form"),dn,Ue("{"),ze("}","switch"),it,Kt,Pe,Pe,ot):N=="case"?F(De,Ue(":")):N=="default"?F(Ue(":")):N=="catch"?F(ze("form"),Ze,Ge,We,Pe,ot):N=="export"?F(ze("stat"),Da,Pe):N=="import"?F(ze("stat"),es,Pe):N=="async"?F(We):G=="@"?F(De,We):W(ze("stat"),De,Ue(";"),Pe)}function Ge(N){if(N=="(")return F(Dn,Ue(")"))}function De(N,G){return ei(N,G,!1)}function St(N,G){return ei(N,G,!0)}function dn(N){return N!="("?W():F(ze(")"),X,Ue(")"),Pe)}function ei(N,G,ne){if(B.state.fatArrowAt==B.stream.start){var he=ne?Je:ye;if(N=="(")return F(Ze,ze(")"),et(Dn,")"),Pe,Ue("=>"),he,ot);if(N=="variable")return W(Ze,Mi,Ue("=>"),he,ot)}var Q=ne?ie:ee;return O.hasOwnProperty(N)?F(Q):N=="function"?F(un,Q):N=="class"||f&&G=="interface"?(B.marked="keyword",F(ze("form"),vp,Pe)):N=="keyword c"||N=="async"?F(ne?St:De):N=="("?F(ze(")"),X,Ue(")"),Pe,Q):N=="operator"||N=="spread"?F(ne?St:De):N=="["?F(ze("]"),Nt,Pe,Q):N=="{"?Ft(Ke,"}",null,Q):N=="quasi"?W(fe,Q):N=="new"?F(rt(ne)):F()}function X(N){return N.match(/[;\}\)\],]/)?W():W(De)}function ee(N,G){return N==","?F(X):ie(N,G,!1)}function ie(N,G,ne){var he=ne==!1?ee:ie,Q=ne==!1?De:St;if(N=="=>")return F(Ze,ne?Je:ye,ot);if(N=="operator")return/\+\+|--/.test(G)||f&&G=="!"?F(he):f&&G=="<"&&B.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?F(ze(">"),et(Xe,">"),Pe,he):G=="?"?F(De,Ue(":"),Q):F(Q);if(N=="quasi")return W(fe,he);if(N!=";"){if(N=="(")return Ft(St,")","call",he);if(N==".")return F(jt,he);if(N=="[")return F(ze("]"),X,Ue("]"),Pe,he);if(f&&G=="as")return B.marked="keyword",F(Xe,he);if(N=="regexp")return B.state.lastType=B.marked="operator",B.stream.backUp(B.stream.pos-B.stream.start-1),F(Q)}}function fe(N,G){return N!="quasi"?W():G.slice(G.length-2)!="${"?F(fe):F(X,Ee)}function Ee(N){if(N=="}")return B.marked="string-2",B.state.tokenize=T,F(fe)}function ye(N){return V(B.stream,B.state),W(N=="{"?We:De)}function Je(N){return V(B.stream,B.state),W(N=="{"?We:St)}function rt(N){return function(G){return G=="."?F(N?dt:lt):G=="variable"&&f?F(ji,N?ie:ee):W(N?St:De)}}function lt(N,G){if(G=="target")return B.marked="keyword",F(ee)}function dt(N,G){if(G=="target")return B.marked="keyword",F(ie)}function Pt(N){return N==":"?F(Pe,We):W(ee,Ue(";"),Pe)}function jt(N){if(N=="variable")return B.marked="property",F()}function Ke(N,G){if(N=="async")return B.marked="property",F(Ke);if(N=="variable"||B.style=="keyword"){if(B.marked="property",G=="get"||G=="set")return F(mi);var ne;return f&&B.state.fatArrowAt==B.stream.start&&(ne=B.stream.match(/^\s*:\s*/,!1))&&(B.state.fatArrowAt=B.stream.pos+ne[0].length),F(ft)}else{if(N=="number"||N=="string")return B.marked=l?"property":B.style+" property",F(ft);if(N=="jsonld-keyword")return F(ft);if(f&&ce(G))return B.marked="keyword",F(Ke);if(N=="[")return F(De,kn,Ue("]"),ft);if(N=="spread")return F(St,ft);if(G=="*")return B.marked="keyword",F(Ke);if(N==":")return W(ft)}}function mi(N){return N!="variable"?W(ft):(B.marked="property",F(un))}function ft(N){if(N==":")return F(St);if(N=="(")return W(un)}function et(N,G,ne){function he(Q,be){if(ne?ne.indexOf(Q)>-1:Q==","){var ut=B.state.lexical;return ut.info=="call"&&(ut.pos=(ut.pos||0)+1),F(function(ti,Ri){return ti==G||Ri==G?W():W(N)},he)}return Q==G||be==G?F():ne&&ne.indexOf(";")>-1?W(N):F(Ue(G))}return function(Q,be){return Q==G||be==G?F():W(N,he)}}function Ft(N,G,ne){for(var he=3;he<arguments.length;he++)B.cc.push(arguments[he]);return F(ze(G,ne),et(N,G),Pe)}function Kt(N){return N=="}"?F():W(We,Kt)}function kn(N,G){if(f){if(N==":")return F(Xe);if(G=="?")return F(kn)}}function Vs(N,G){if(f&&(N==":"||G=="in"))return F(Xe)}function Yr(N){if(f&&N==":")return B.stream.match(/^\s*\w+\s+is\b/,!1)?F(De,gp,Xe):F(Xe)}function gp(N,G){if(G=="is")return B.marked="keyword",F()}function Xe(N,G){if(G=="keyof"||G=="typeof"||G=="infer"||G=="readonly")return B.marked="keyword",F(G=="typeof"?St:Xe);if(N=="variable"||G=="void")return B.marked="type",F(cn);if(G=="|"||G=="&")return F(Xe);if(N=="string"||N=="number"||N=="atom")return F(cn);if(N=="[")return F(ze("]"),et(Xe,"]",","),Pe,cn);if(N=="{")return F(ze("}"),Oe,Pe,cn);if(N=="(")return F(et(Rt,")"),ac,cn);if(N=="<")return F(et(Xe,">"),Xe);if(N=="quasi")return W(vi,cn)}function ac(N){if(N=="=>")return F(Xe)}function Oe(N){return N.match(/[\}\)\]]/)?F():N==","||N==";"?F(Oe):W(mr,Oe)}function mr(N,G){if(N=="variable"||B.style=="keyword")return B.marked="property",F(mr);if(G=="?"||N=="number"||N=="string")return F(mr);if(N==":")return F(Xe);if(N=="[")return F(Ue("variable"),Vs,Ue("]"),mr);if(N=="(")return W(Qr,mr);if(!N.match(/[;\}\)\],]/))return F()}function vi(N,G){return N!="quasi"?W():G.slice(G.length-2)!="${"?F(vi):F(Xe,Mt)}function Mt(N){if(N=="}")return B.marked="string-2",B.state.tokenize=T,F(vi)}function Rt(N,G){return N=="variable"&&B.stream.match(/^\s*[?:]/,!1)||G=="?"?F(Rt):N==":"?F(Xe):N=="spread"?F(Rt):W(Xe)}function cn(N,G){if(G=="<")return F(ze(">"),et(Xe,">"),Pe,cn);if(G=="|"||N=="."||G=="&")return F(Xe);if(N=="[")return F(Xe,Ue("]"),cn);if(G=="extends"||G=="implements")return B.marked="keyword",F(Xe);if(G=="?")return F(Xe,Ue(":"),Xe)}function ji(N,G){if(G=="<")return F(ze(">"),et(Xe,">"),Pe,cn)}function In(){return W(Xe,yi)}function yi(N,G){if(G=="=")return F(Xe)}function La(N,G){return G=="enum"?(B.marked="keyword",F(Ae)):W(Mi,kn,Tn,mp)}function Mi(N,G){if(f&&ce(G))return B.marked="keyword",F(Mi);if(N=="variable")return de(G),F();if(N=="spread")return F(Mi);if(N=="[")return Ft(cl,"]");if(N=="{")return Ft(Kr,"}")}function Kr(N,G){return N=="variable"&&!B.stream.match(/^\s*:/,!1)?(de(G),F(Tn)):(N=="variable"&&(B.marked="property"),N=="spread"?F(Mi):N=="}"?W():N=="["?F(De,Ue("]"),Ue(":"),Kr):F(Ue(":"),Mi,Tn))}function cl(){return W(Mi,Tn)}function Tn(N,G){if(G=="=")return F(St)}function mp(N){if(N==",")return F(La)}function ka(N,G){if(N=="keyword b"&&G=="else")return F(ze("form","else"),We,Pe)}function oc(N,G){if(G=="await")return F(oc);if(N=="(")return F(ze(")"),ul,Pe)}function ul(N){return N=="var"?F(La,Xr):N=="variable"?F(Xr):W(Xr)}function Xr(N,G){return N==")"?F():N==";"?F(Xr):G=="in"||G=="of"?(B.marked="keyword",F(De,Xr)):W(De,Xr)}function un(N,G){if(G=="*")return B.marked="keyword",F(un);if(N=="variable")return de(G),F(un);if(N=="(")return F(Ze,ze(")"),et(Dn,")"),Pe,Yr,We,ot);if(f&&G=="<")return F(ze(">"),et(In,">"),Pe,un)}function Qr(N,G){if(G=="*")return B.marked="keyword",F(Qr);if(N=="variable")return de(G),F(Qr);if(N=="(")return F(Ze,ze(")"),et(Dn,")"),Pe,Yr,ot);if(f&&G=="<")return F(ze(">"),et(In,">"),Pe,Qr)}function lc(N,G){if(N=="keyword"||N=="variable")return B.marked="type",F(lc);if(G=="<")return F(ze(">"),et(In,">"),Pe)}function Dn(N,G){return G=="@"&&F(De,Dn),N=="spread"?F(Dn):f&&ce(G)?(B.marked="keyword",F(Dn)):f&&N=="this"?F(kn,Tn):W(Mi,kn,Tn)}function vp(N,G){return N=="variable"?Ia(N,G):Pn(N,G)}function Ia(N,G){if(N=="variable")return de(G),F(Pn)}function Pn(N,G){if(G=="<")return F(ze(">"),et(In,">"),Pe,Pn);if(G=="extends"||G=="implements"||f&&N==",")return G=="implements"&&(B.marked="keyword"),F(f?Xe:De,Pn);if(N=="{")return F(ze("}"),An,Pe)}function An(N,G){if(N=="async"||N=="variable"&&(G=="static"||G=="get"||G=="set"||f&&ce(G))&&B.stream.match(/^\s+#?[\w$\xa1-\uffff]/,!1))return B.marked="keyword",F(An);if(N=="variable"||B.style=="keyword")return B.marked="property",F(Ta,An);if(N=="number"||N=="string")return F(Ta,An);if(N=="[")return F(De,kn,Ue("]"),Ta,An);if(G=="*")return B.marked="keyword",F(An);if(f&&N=="(")return W(Qr,An);if(N==";"||N==",")return F(An);if(N=="}")return F();if(G=="@")return F(De,An)}function Ta(N,G){if(G=="!"||G=="?")return F(Ta);if(N==":")return F(Xe,Tn);if(G=="=")return F(St);var ne=B.state.lexical.prev,he=ne&&ne.info=="interface";return W(he?Qr:un)}function Da(N,G){return G=="*"?(B.marked="keyword",F(Ma,Ue(";"))):G=="default"?(B.marked="keyword",F(De,Ue(";"))):N=="{"?F(et(Pa,"}"),Ma,Ue(";")):W(We)}function Pa(N,G){if(G=="as")return B.marked="keyword",F(Ue("variable"));if(N=="variable")return W(St,Pa)}function es(N){return N=="string"?F():N=="("?W(De):N=="."?W(ee):W(Aa,Hn,Ma)}function Aa(N,G){return N=="{"?Ft(Aa,"}"):(N=="variable"&&de(G),G=="*"&&(B.marked="keyword"),F(hl))}function Hn(N){if(N==",")return F(Aa,Hn)}function hl(N,G){if(G=="as")return B.marked="keyword",F(Aa)}function Ma(N,G){if(G=="from")return B.marked="keyword",F(De)}function Nt(N){return N=="]"?F():W(et(St,"]"))}function Ae(){return W(ze("form"),Mi,Ue("{"),ze("}"),et(vr,"}"),Pe,Pe)}function vr(){return W(Mi,Tn)}function pl(N,G){return N.lastType=="operator"||N.lastType==","||y.test(G.charAt(0))||/[,.]/.test(G.charAt(0))}function Qi(N,G,ne){return G.tokenize==M&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(G.lastType)||G.lastType=="quasi"&&/\{\s*$/.test(N.string.slice(0,N.pos-(ne||0)))}return{startState:function(N){var G={tokenize:M,lastType:"sof",cc:[],lexical:new _((N||0)-s,0,"block",!1),localVars:r.localVars,context:r.localVars&&new Le(null,null,!1),indented:N||0};return r.globalVars&&typeof r.globalVars=="object"&&(G.globalVars=r.globalVars),G},token:function(N,G){if(N.sol()&&(G.lexical.hasOwnProperty("align")||(G.lexical.align=!1),G.indented=N.indentation(),V(N,G)),G.tokenize!=D&&N.eatSpace())return null;var ne=G.tokenize(N,G);return S=="comment"?ne:(G.lastType=S=="operator"&&(L=="++"||L=="--")?"incdec":S,U(G,ne,S,L,N))},indent:function(N,G){if(N.tokenize==D||N.tokenize==T)return t.Pass;if(N.tokenize!=M)return 0;var ne=G&&G.charAt(0),he=N.lexical,Q;if(!/^\s*else\b/.test(G))for(var be=N.cc.length-1;be>=0;--be){var ut=N.cc[be];if(ut==Pe)he=he.prev;else if(ut!=ka&&ut!=ot)break}for(;(he.type=="stat"||he.type=="form")&&(ne=="}"||(Q=N.cc[N.cc.length-1])&&(Q==ee||Q==ie)&&!/^[,\.=+\-*:?[\(]/.test(G));)he=he.prev;o&&he.type==")"&&he.prev.type=="stat"&&(he=he.prev);var ti=he.type,Ri=ne==ti;return ti=="vardef"?he.indented+(N.lastType=="operator"||N.lastType==","?he.info.length+1:0):ti=="form"&&ne=="{"?he.indented:ti=="form"?he.indented+s:ti=="stat"?he.indented+(pl(N,G)?o||s:0):he.info=="switch"&&!Ri&&r.doubleIndentSwitch!=!1?he.indented+(/^(?:case|default)\b/.test(G)?s:2*s):he.align?he.column+(Ri?0:1):he.indented+(Ri?0:s)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:c?null:"/*",blockCommentEnd:c?null:"*/",blockCommentContinue:c?null:" * ",lineComment:c?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:c?"json":"javascript",jsonldMode:l,jsonMode:c,expressionAllowed:Qi,skipExpression:function(N){U(N,"atom","atom","true",new t.StringStream("",2,null))}}}),t.registerHelper("wordChars","javascript",/[\w$]/),t.defineMIME("text/javascript","javascript"),t.defineMIME("text/ecmascript","javascript"),t.defineMIME("application/javascript","javascript"),t.defineMIME("application/x-javascript","javascript"),t.defineMIME("application/ecmascript","javascript"),t.defineMIME("application/json",{name:"javascript",json:!0}),t.defineMIME("application/x-json",{name:"javascript",json:!0}),t.defineMIME("application/manifest+json",{name:"javascript",json:!0}),t.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),t.defineMIME("text/typescript",{name:"javascript",typescript:!0}),t.defineMIME("application/typescript",{name:"javascript",typescript:!0})})})();var C4={exports:{}};(function(i,e){(function(t){t(sl())})(function(t){function n(l,c,u,f){if(u&&u.call){var g=u;u=null}else var g=o(l,u,"rangeFinder");typeof c=="number"&&(c=t.Pos(c,0));var v=o(l,u,"minFoldSize");function y(L){var I=g(l,c);if(!I||I.to.line-I.from.line<v)return null;if(f==="fold")return I;for(var M=l.findMarksAt(I.from),R=0;R<M.length;++R)if(M[R].__isFold){if(!L)return null;I.cleared=!0,M[R].clear()}return I}var C=y(!0);if(o(l,u,"scanUp"))for(;!C&&c.line>l.firstLine();)c=t.Pos(c.line-1,0),C=y(!1);if(!(!C||C.cleared||f==="unfold")){var w=r(l,u,C);t.on(w,"mousedown",function(L){S.clear(),t.e_preventDefault(L)});var S=l.markText(C.from,C.to,{replacedWith:w,clearOnEnter:o(l,u,"clearOnEnter"),__isFold:!0});S.on("clear",function(L,I){t.signal(l,"unfold",l,L,I)}),t.signal(l,"fold",l,C.from,C.to)}}function r(l,c,u){var f=o(l,c,"widget");if(typeof f=="function"&&(f=f(u.from,u.to)),typeof f=="string"){var g=document.createTextNode(f);f=document.createElement("span"),f.appendChild(g),f.className="CodeMirror-foldmarker"}else f&&(f=f.cloneNode(!0));return f}t.newFoldFunction=function(l,c){return function(u,f){n(u,f,{rangeFinder:l,widget:c})}},t.defineExtension("foldCode",function(l,c,u){n(this,l,c,u)}),t.defineExtension("isFolded",function(l){for(var c=this.findMarksAt(l),u=0;u<c.length;++u)if(c[u].__isFold)return!0}),t.commands.toggleFold=function(l){l.foldCode(l.getCursor())},t.commands.fold=function(l){l.foldCode(l.getCursor(),null,"fold")},t.commands.unfold=function(l){l.foldCode(l.getCursor(),{scanUp:!1},"unfold")},t.commands.foldAll=function(l){l.operation(function(){for(var c=l.firstLine(),u=l.lastLine();c<=u;c++)l.foldCode(t.Pos(c,0),{scanUp:!1},"fold")})},t.commands.unfoldAll=function(l){l.operation(function(){for(var c=l.firstLine(),u=l.lastLine();c<=u;c++)l.foldCode(t.Pos(c,0),{scanUp:!1},"unfold")})},t.registerHelper("fold","combine",function(){var l=Array.prototype.slice.call(arguments,0);return function(c,u){for(var f=0;f<l.length;++f){var g=l[f](c,u);if(g)return g}}}),t.registerHelper("fold","auto",function(l,c){for(var u=l.getHelpers(c,"fold"),f=0;f<u.length;f++){var g=u[f](l,c);if(g)return g}});var s={rangeFinder:t.fold.auto,widget:"↔",minFoldSize:0,scanUp:!1,clearOnEnter:!0};t.defineOption("foldOptions",null);function o(l,c,u){if(c&&c[u]!==void 0)return c[u];var f=l.options.foldOptions;return f&&f[u]!==void 0?f[u]:s[u]}t.defineExtension("foldOption",function(l,c){return o(this,l,c)})})})();var x4=C4.exports;(function(i,e){(function(t){t(sl(),x4)})(function(t){t.defineOption("foldGutter",!1,function(S,L,I){I&&I!=t.Init&&(S.clearGutter(S.state.foldGutter.options.gutter),S.state.foldGutter=null,S.off("gutterClick",g),S.off("changes",y),S.off("viewportChange",C),S.off("fold",w),S.off("unfold",w),S.off("swapDoc",y),S.off("optionChange",v)),L&&(S.state.foldGutter=new r(s(L)),f(S),S.on("gutterClick",g),S.on("changes",y),S.on("viewportChange",C),S.on("fold",w),S.on("unfold",w),S.on("swapDoc",y),S.on("optionChange",v))});var n=t.Pos;function r(S){this.options=S,this.from=this.to=0}function s(S){return S===!0&&(S={}),S.gutter==null&&(S.gutter="CodeMirror-foldgutter"),S.indicatorOpen==null&&(S.indicatorOpen="CodeMirror-foldgutter-open"),S.indicatorFolded==null&&(S.indicatorFolded="CodeMirror-foldgutter-folded"),S}function o(S,L){for(var I=S.findMarks(n(L,0),n(L+1,0)),M=0;M<I.length;++M)if(I[M].__isFold){var R=I[M].find(-1);if(R&&R.line===L)return I[M]}}function l(S){if(typeof S=="string"){var L=document.createElement("div");return L.className=S+" CodeMirror-guttermarker-subtle",L}else return S.cloneNode(!0)}function c(S,L,I){var M=S.state.foldGutter.options,R=L-1,D=S.foldOption(M,"minFoldSize"),T=S.foldOption(M,"rangeFinder"),A=typeof M.indicatorFolded=="string"&&u(M.indicatorFolded),V=typeof M.indicatorOpen=="string"&&u(M.indicatorOpen);S.eachLine(L,I,function(O){++R;var _=null,H=O.gutterMarkers;if(H&&(H=H[M.gutter]),o(S,R)){if(A&&H&&A.test(H.className))return;_=l(M.indicatorFolded)}else{var U=n(R,0),B=T&&T(S,U);if(B&&B.to.line-B.from.line>=D){if(V&&H&&V.test(H.className))return;_=l(M.indicatorOpen)}}!_&&!H||S.setGutterMarker(O,M.gutter,_)})}function u(S){return new RegExp("(^|\\s)"+S+"(?:$|\\s)\\s*")}function f(S){var L=S.getViewport(),I=S.state.foldGutter;I&&(S.operation(function(){c(S,L.from,L.to)}),I.from=L.from,I.to=L.to)}function g(S,L,I){var M=S.state.foldGutter;if(M){var R=M.options;if(I==R.gutter){var D=o(S,L);D?D.clear():S.foldCode(n(L,0),R)}}}function v(S,L){L=="mode"&&y(S)}function y(S){var L=S.state.foldGutter;if(L){var I=L.options;L.from=L.to=0,clearTimeout(L.changeUpdate),L.changeUpdate=setTimeout(function(){f(S)},I.foldOnChangeTimeSpan||600)}}function C(S){var L=S.state.foldGutter;if(L){var I=L.options;clearTimeout(L.changeUpdate),L.changeUpdate=setTimeout(function(){var M=S.getViewport();L.from==L.to||M.from-L.to>20||L.from-M.to>20?f(S):S.operation(function(){M.from<L.from&&(c(S,M.from,L.from),L.from=M.from),M.to>L.to&&(c(S,L.to,M.to),L.to=M.to)})},I.updateViewportTimeSpan||400)}}function w(S,L){var I=S.state.foldGutter;if(I){var M=L.line;M>=I.from&&M<I.to&&c(S,M,M+1)}}})})();(function(i,e){(function(t){t(sl())})(function(t){function n(r){return function(s,o){var l=o.line,c=s.getLine(l);function u(w){for(var S,L=o.ch,I=0;;){var M=L<=0?-1:c.lastIndexOf(w[0],L-1);if(M==-1){if(I==1)break;I=1,L=c.length;continue}if(I==1&&M<o.ch)break;if(S=s.getTokenTypeAt(t.Pos(l,M+1)),!/^(comment|string)/.test(S))return{ch:M+1,tokenType:S,pair:w};L=M-1}}function f(w){var S=1,L=s.lastLine(),I,M=w.ch,R;e:for(var D=l;D<=L;++D)for(var T=s.getLine(D),A=D==l?M:0;;){var V=T.indexOf(w.pair[0],A),O=T.indexOf(w.pair[1],A);if(V<0&&(V=T.length),O<0&&(O=T.length),A=Math.min(V,O),A==T.length)break;if(s.getTokenTypeAt(t.Pos(D,A+1))==w.tokenType){if(A==V)++S;else if(!--S){I=D,R=A;break e}}++A}return I==null||l==I?null:{from:t.Pos(l,M),to:t.Pos(I,R)}}for(var g=[],v=0;v<r.length;v++){var y=u(r[v]);y&&g.push(y)}g.sort(function(w,S){return w.ch-S.ch});for(var v=0;v<g.length;v++){var C=f(g[v]);if(C)return C}return null}}t.registerHelper("fold","brace",n([["{","}"],["[","]"]])),t.registerHelper("fold","brace-paren",n([["{","}"],["[","]"],["(",")"]])),t.registerHelper("fold","import",function(r,s){function o(v){if(v<r.firstLine()||v>r.lastLine())return null;var y=r.getTokenAt(t.Pos(v,1));if(/\S/.test(y.string)||(y=r.getTokenAt(t.Pos(v,y.end+1))),y.type!="keyword"||y.string!="import")return null;for(var C=v,w=Math.min(r.lastLine(),v+10);C<=w;++C){var S=r.getLine(C),L=S.indexOf(";");if(L!=-1)return{startCh:y.end,end:t.Pos(C,L)}}}var l=s.line,c=o(l),u;if(!c||o(l-1)||(u=o(l-2))&&u.end.line==l-1)return null;for(var f=c.end;;){var g=o(f.line+1);if(g==null)break;f=g.end}return{from:r.clipPos(t.Pos(l,c.startCh+1)),to:f}}),t.registerHelper("fold","include",function(r,s){function o(g){if(g<r.firstLine()||g>r.lastLine())return null;var v=r.getTokenAt(t.Pos(g,1));if(/\S/.test(v.string)||(v=r.getTokenAt(t.Pos(g,v.end+1))),v.type=="meta"&&v.string.slice(0,8)=="#include")return v.start+8}var l=s.line,c=o(l);if(c==null||o(l-1)!=null)return null;for(var u=l;;){var f=o(u+1);if(f==null)break;++u}return{from:t.Pos(l,c+1),to:r.clipPos(t.Pos(u))}})})})();var E4=sl();const gs=It(E4),L4=100;class k4 extends dp{constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=ct(()=>{const s=this.textEditor.getValue();try{const o=JSON.parse(s);this.parsedValue=o,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(o){this.parsedValue=null,this.applyButton.disabled=!0;let l=0,c=0,u="Unknown parse error";if(o instanceof Error){const f=o.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(f!==null){u=f[1];const g=parseInt(f[2],10),v=s.substring(0,g).split(`
`);l=v.length-1,c=v[v.length-1].length}else u=o.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:u,severity:"error",from:gs.Pos(l,c)}]})}},L4),this.content.classList.add("neuroglancer-state-editor");const t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;const n=this.closeButton=document.createElement("button");n.classList.add("close-button"),n.textContent="Close",this.content.appendChild(n),n.addEventListener("click",()=>this.dispose());const r=this.downloadButton=document.createElement("button");r.textContent="Download",r.title="Download state as a JSON file",this.content.appendChild(r),r.addEventListener("click",()=>this.downloadState()),this.textEditor=gs(s=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){const e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),n=URL.createObjectURL(t);e.href=n,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return se(Wh(this.viewer.state).value,null,"  ")}}var I4=I1,T4=D4(I4);function D4(i){return i&&i.__esModule?i:{default:i}}var P4=function(i){return Array.isArray(i)?i:(0,T4.default)(i)};const A4={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class M4{constructor(){this.location=new Rs(A4)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return va(this.location.toJSON())}}function R4(i){const e=new ue;function t(n,r){if(typeof n!="object"){e.set(r,""+n);return}for(const s of di(n))t(n[s],r+"."+s)}return t(i,""),e}function N4(i){const e=new je;e.add(".type");const t=new je;function n(r,s){for(const o of e)if(i[r].get(o)!==i[s].get(o))return!0;return!1}for(let r=0,s=i.length;r<s;++r){for(const l of i[r].keys())t.add(l);let o=[];for(let l=0;l<r;++l)n(r,l)||o.push(l);for(;o.length>0;){let l=o,c;for(const u of t){if(e.has(u))continue;const f=[];for(const g of o)i[g].get(u)===i[r].get(u)&&f.push(g);if(f.length<l.length&&(l=f,c=u),f.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Te(e)}function V4(i,e){const t={};for(const n of e){const r=i.get(n);if(r!==void 0){if(n==="")return r;t[n]=r}}return se(t)}function O4(i){return j({type:i.RPC_TYPE_ID},i.key||{})}function B4(i){const e=i.map(R4),t=N4(e);return e.map(n=>V4(n,t))}const _4=1e3,tg=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:i=>{let e=0;for(let t=0;t<WE;++t)e+=i[Hs(t,Lr.VISIBLE)*ps+kr.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:i=>i[Hs(Et.DOWNLOADING,Lr.VISIBLE)*ps+kr.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:i=>i[Hs(Et.SYSTEM_MEMORY,Lr.VISIBLE)*ps+kr.numChunks]+i[Hs(Et.SYSTEM_MEMORY_WORKER,Lr.VISIBLE)*ps+kr.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:i=>i[Hs(Et.GPU_MEMORY,Lr.VISIBLE)*ps+kr.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:i=>i[Hs(Et.FAILED,Lr.VISIBLE)*ps+kr.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:i=>i[Hs(Et.GPU_MEMORY,Lr.VISIBLE)*ps+kr.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:i=>i[tw(Nu.totalTime)]/i[tw(Nu.totalChunks)]}];class F4 extends wa{constructor(e,t,n){super(e,n.location),this.chunkQueueManager=t,this.displayState=n,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable(ct(()=>this.updateView(),0));const r=this.body;r.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(r),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;const e=this.chunkQueueManager;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},_4)})}updateView(){const e=this.data;if(e===void 0)return;const t=document.createElement("table"),n=[];for(const u of e){var r=oe(u,2);const f=r[0],g=r[1],v=[f];for(const y of tg){const C=y.getter;v.push(C(g))}n.push(v)}const s=B4(n.map(u=>O4(u[0]))),o=new ue;s.forEach((u,f)=>{o.set(n[f][0],u)});{const u=document.createElement("thead");let f=document.createElement("tr");u.appendChild(f);const g=y=>{const C=document.createElement("td");C.textContent=y,f.appendChild(C)};g("Name");let v;for(const y of tg){const C=y.label,w=C.indexOf("/");let S=C;if(w!==-1){if(S=C.substring(0,w),S===v){++f.lastElementChild.colSpan;continue}v=S}g(S)}f=document.createElement("tr"),u.appendChild(f);{const y=document.createElement("td");f.appendChild(y)}for(const y of tg){const C=y.label,w=C.indexOf("/");let S="";w!==-1&&(S=C.substring(w+1));const L=document.createElement("td");L.textContent=S,f.appendChild(L)}t.appendChild(u)}const l=document.createElement("tbody");for(const u of n){var c=P4(u);const f=c[0],g=c.slice(1),v=document.createElement("tr"),y=C=>{const w=document.createElement("td");w.textContent=C,v.appendChild(w)};y(o.get(f));for(const C of g)y(""+C);l.appendChild(v)}t.appendChild(l),nt(this.body),this.body.appendChild(t)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ay extends K{constructor(e,t=()=>bt(1,0,0)){super(),this.model=e,this.getDefaultColor=t,this.element=document.createElement("input");const n=this.element;n.classList.add("neuroglancer-color-widget"),n.type="color",n.addEventListener("change",()=>this.updateModel()),n.addEventListener("input",()=>this.updateModel()),n.addEventListener("wheel",r=>{r.stopPropagation(),r.preventDefault(),this.adjustHueViaWheel(r)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!==null&&e!==void 0?e:this.getDefaultColor()}updateView(){this.element.value=Gi(this.getRGB())}updateModel(){this.model.value=ma(this.element.value)}adjustHueViaWheel(e){const t=this.getRGB(),n=Ne();IF(n,t[0],t[1],t[2]);const r=e.deltaY;let s=Math.round(n[0]*256);s+=r>0?1:r<0?-1:0,s=(s+256)%256,n[0]=s/256,Wu(n,n[0],n[1],n[2]),this.model.value=n}}class U4 extends K{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let n=t.validator,r=t.label;const s=this.element,o=this.inputElement;n===void 0&&(e instanceof ci?n=e.validator:n=l=>l),this.validator=n,r!==void 0&&(s.textContent=r),s.appendChild(o),s.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(tr(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Bt(this.element),super.disposed()}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zI extends K{constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));const t=this.element;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){Bt(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!==null&&e!==void 0?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}const z4=j(j({},Sa),{side:"left",row:2});class G4{constructor(){this.location=new Rs(z4)}get changed(){return this.location.changed}toJSON(){return va(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class W4 extends wa{constructor(e,t,n){super(e,t.location),this.addTitleBar({title:"Settings"});const r=document.createElement("div");r.classList.add("neuroglancer-settings-body");let s=document.createElement("div");s.classList.add("neuroglancer-settings-scroll-container"),r.appendChild(s),this.addBody(r);{const u=this.registerDisposer(new zI(n.title));u.element.placeholder="Title",u.element.classList.add("neuroglancer-settings-title"),s.appendChild(u.element)}const o=(u,f)=>{const g=this.registerDisposer(new U4(f,{label:u}));g.element.classList.add("neuroglancer-settings-limit-widget"),s.appendChild(g.element)};o("GPU memory limit",n.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",n.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",n.chunkQueueManager.capacities.download.itemLimit);const l=(u,f)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new As(f));g.appendChild(v.element),s.appendChild(g)};l("Show axis lines",n.showAxisLines),l("Show scale bar",n.showScaleBar),l("Show cross sections in 3-d",n.showPerspectiveSliceViews),l("Show default annotations",n.showDefaultAnnotations),l("Show chunk statistics",n.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",n.wireFrame),l("Enable prefetching",n.chunkQueueManager.enablePrefetch);const c=(u,f)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new Ay(f));g.appendChild(v.element),s.appendChild(g)};c("Cross-section background",n.crossSectionBackgroundColor),c("Projection background",n.perspectiveViewBackgroundColor)}}class $4 extends K{constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable(wt(()=>{let r=this.viewContext;r!==void 0&&(this.unregisterDisposer(r),r.dispose()),this.viewContext=r=this.registerDisposer(new K),nt(this.element);const s=this.selectedTool;s!==void 0&&this.element.appendChild(this.makeWidget(r,s));const o=Te(this.toolBinder.bindings);o.sort(([c],[u])=>Hd(c,u));for(const c of o){var l=oe(c,2);const u=l[1];this.element.appendChild(this.makeWidget(r,u))}}));const n=this.element;n.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){const e=this.selectedLayer.layer;if(e===void 0)return;const t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let e=this.unbindPreviousLayer;e!==void 0&&e();const t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){const e=this.unbindPreviousLayer;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){const n=document.createElement("div");n.title="dblclick → unbind",t instanceof Uo&&(n.title+=", click → bind key"),n.className="neuroglancer-annotation-tool-status-widget";const r=document.createElement("div");r.className="neuroglancer-annotation-tool-status-widget-layer-number";const s=t.layer.managedLayer;s.manager.rootLayers.updateNonArchivedLayerIndices();const o=s.nonArchivedLayerIndex;r.textContent=(o+1).toString();const l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,n.addEventListener("dblclick",()=>{t instanceof aI?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Uo){const c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,n.appendChild(c),dI(e,n,u=>t.layer.toolBinder.set(u,t.addRef()))}return n.appendChild(r),n.appendChild(l),n}}function My(i){return encodeURI(i).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}class j4 extends K{constructor(e,t,n={}){super(),this.root=e,this.credentialsManager=t,this.parseError=new gt(void 0);var r=n.updateDelayMilliseconds;const s=r===void 0?200:r;var o=n.defaultFragment;const l=o===void 0?"{}":o;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());const c=ct(()=>this.setUrlHash(),s);this.registerDisposer(e.changed.add(c)),this.registerDisposer(()=>c.cancel()),this.defaultFragment=l}setUrlHash(){const e=Wh(this.root);if(e.generation!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let t=My(se(e.value));t!==this.prevStateString&&(this.prevStateString=t,decodeURIComponent(t)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+t))}}updateFromUrlHash(){try{let t=location.href.replace(/^[^#]+/,"");if((t===""||t==="#"||t==="#!")&&(t="#!"+this.defaultFragment),t.match(/^#!([a-z][a-z\d+-.]*):\/\//)){const n=t.substring(2);var e=rl(n,this.credentialsManager);const r=e.url,s=e.credentialsProvider;tt.forPromise(xa(s,r,{},jn).then(o=>{ge(o),this.root.reset(),this.root.restoreState(o)}),{initialMessage:`Loading state from ${n}`,errorPrefix:"Error loading state:"})}else if(t.startsWith("#!+")){t=t.slice(3),t=decodeURIComponent(t);let n=Iu(t);ge(n),this.root.restoreState(n),this.prevStateString=void 0}else if(t.startsWith("#!")){if(t=t.slice(2),t=decodeURIComponent(t),t===this.prevStateString)return;this.prevStateString=t,this.root.reset();let n=Iu(t);ge(n),this.root.restoreState(n)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(t){this.parseError.value=t}}}const H4=Object.freeze(Object.defineProperty({__proto__:null,UrlHashBinding:j4,encodeFragment:My},Symbol.toStringTag,{value:"Module"}));class J4 extends K{constructor(e,t,n=""){super(),this.gl=e,this.frameNumberCounter=t;const r=n+"chunk_worker.bundle.js";this.worker=typeof n=="string"?new Worker(r):n,this.chunkQueueManager=this.registerDisposer(new qg(new tB(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Jc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Jc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Jc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Jc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Yg(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}}const GI=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],WI=[...GI,"showLayerPanel","showLayerHoverValues"],$I=[...WI,"showUIControls","showPanelBorders"];function Z4(){return Object.fromEntries($I.map(i=>[i,new Qt(!0)]))}function q4(i,e){for(const t of $I){const n=e[t];n!==void 0&&(i[t].value=n)}}const Y4=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS<"u"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class K4 extends Gh{constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){const t=this.viewer;super.restoreState(e),we(e,"navigation",n=>{ge(n),we(n,"pose",r=>{ge(r),we(r,"position",s=>{ge(s),Li(s,"voxelCoordinates",t.position),we(s,"voxelSize",o=>{const l=st(new Float64Array(3),o,gi);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=mt({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),Li(r,"orientation",t.crossSectionOrientation)}),Li(n,"zoomFactor",t.crossSectionScale.legacyJsonView)}),Li(e,"perspectiveOrientation",t.projectionOrientation),Li(e,"perspectiveZoom",t.projectionScale.legacyJsonView),Li(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}const ws={expectingExternalUI:!1};class X4 extends K{constructor(e,t={}){super(),this.display=e,this.title=new ci(void 0,Ie),this.coordinateSpace=new Av,this.position=this.registerDisposer(new Qs(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new Sk(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new Ck(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new wk(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new Vo),this.crossSectionScale=this.registerDisposer(new tF(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new Vo),this.crossSectionDepthRange=this.registerDisposer(new nm(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new nm(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new iF(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new Bo(new Oo(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new Bo(new Oo(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new iW,this.layerManager=this.registerDisposer(new jI),this.selectedLayer=this.registerDisposer(new dW(this.layerManager.addRef())),this.showAxisLines=new Qt(!0,!0),this.wireFrame=new Qt(!1,!1),this.showScaleBar=new Qt(!0,!0),this.showPerspectiveSliceViews=new Qt(!0,!0),this.visibleLayerRoles=oB(),this.showDefaultAnnotations=new Qt(!0,!0),this.crossSectionBackgroundColor=new ud(bt(.5,.5,.5)),this.perspectiveViewBackgroundColor=new ud(bt(0,0,0)),this.scaleBarOptions=new zz,this.partialViewport=new hO,this.statisticsDisplayState=new M4,this.helpPanelState=new MG,this.settingsPanelState=new G4,this.layerSelectedValues=this.registerDisposer(new nW(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new rW(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new ci("",Ie),this.layerListPanelState=new m4,this.resetInitiated=new xe,this.makeUrlFromState=M=>ws.expectingExternalUI?"/#!"+My(se(M)):window.location.toString(),this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(M,R)=>{R.registerDisposer(this.inputEventBindings.sliceView.addParent(M,Number.POSITIVE_INFINITY)),R.registerDisposer(this.inputEventBindings.perspectiveView.addParent(M,Number.POSITIVE_INFINITY))},this.toolBinder=this.registerDisposer(new lz(this.toolInputEventMapBinder));var n=t.dataContext;const r=n===void 0?new J4(e.gl,e,t.bundleRoot):n;var s=t.visibility;const o=s===void 0?new Zt(Zt.VISIBLE):s;var l=t.inputEventBindings;const c=l===void 0?{global:new vt,sliceView:new vt,perspectiveView:new vt}:l;var u=t.element;const f=u===void 0?e.makeCanvasOverlayElement():u;var g=t.dataSourceProvider;const v=g===void 0?vG({credentialsManager:nl}):g;var y=t.uiConfiguration;const C=y===void 0?Z4():y;this.visibility=o,this.inputEventBindings=c,this.element=f,this.dataSourceProvider=v,this.uiConfiguration=C,this.registerDisposer(Or(M=>{this.display.applyWindowedViewportToElement(f,M)},this.partialViewport)),this.registerDisposer(()=>Bt(this.element)),this.dataContext=this.registerDisposer(r),q4(C,t);const w=j(j({},Y4),t),S=w.resetStateWhenEmpty,L=w.showLayerDialog;for(const M of WI)this.uiControlVisibility[M]=this.makeUiControlVisibilityState(M);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=L,this.resetStateWhenEmpty=S,this.layerSpecification=new hW(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(En.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(En.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));const I=this.registerCancellable(ct(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!xm&&this.showLayerDialog&&this.visibility.visible&&nT(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(I),I(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(OI(f,this.navigationState.position)),this.state=new K4(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}get expectingExternalUI(){return ws.expectingExternalUI}set expectingExternalUI(e){ws.expectingExternalUI=e}makeUiControlVisibilityState(e){const t=this.uiConfiguration.showUIControls,n=this.uiConfiguration[e];return this.registerDisposer(MS((r,s)=>r&&s,t,n))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){const e=this.element,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){const e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";const n=this.registerDisposer(new lp(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new pn(this.uiControlVisibility.showLocation,n.element)),t.appendChild(n.element);const r=this.registerDisposer(new QG(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(r.element.style.flex="1",r.element.style.alignSelf="center",this.registerDisposer(new pn(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element),typeof NEUROGLANCER_CREDIT_LINK<"u"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(const c of l){const u=c.url,f=c.text,g=document.createElement("a");g.style.marginRight="5px",g.href=u,g.textContent=f,g.style.fontFamily="sans-serif",g.style.color="yellow",g.target="_blank",t.appendChild(g)}}const s=this.registerDisposer(new $4(this.selectedLayer,this.toolBinder));if(t.appendChild(s.element),this.registerDisposer(new pn(this.uiControlVisibility.showAnnotationToolStatus,s.element)),IG){const l=this.registerDisposer(new TG(this));t.appendChild(l.element)}{const l=this.layerListPanelState,c=this.registerDisposer(new er(l.location.watchableVisible,{svg:pz,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new w4(this.layerManager)).element),this.registerDisposer(new pn(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{const l=this.selectionDetailsState,c=this.registerDisposer(new er(l.location.watchableVisible,{svg:fz,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new pn(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{const l=this.selectedLayer,c=this.registerDisposer(new er({get value(){return l.visible},set value(u){l.visible=u},changed:l.location.locationChanged},{svg:cI,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new pn(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{const l=Lt({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new pn(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{const l=dr({title:"Copy view URL to clipboard",onClick:()=>{const c=on(this.makeUrlFromState(this.state.toJSON()));tt.showTemporaryMessage(c?"URL copied to clipboard":"Failed to copy URL to clipboard")}});t.appendChild(l)}{const l=this.helpPanelState,c=this.registerDisposer(new er(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new pn(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{const l=this.settingsPanelState,c=this.registerDisposer(new er(l.location.watchableVisible,{svg:gz,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new pn(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new pn(MS((...l)=>l.reduce((c,u)=>c||u,!1),...GI.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new o4(this,"4panel")),this.sidePanelManager=this.registerDisposer(new qF(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new S4(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new f4(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new pC(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.closeSelectionTab=()=>{for(const l of this.sidePanelManager.registeredPanels)l.panel instanceof pC&&l.panel.close()},this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new F4(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{const l=this.inputEventBindings;return new RG(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new W4(this.sidePanelManager,this.settingsPanelState,this)}));const o=()=>{const l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){const e=this.element;this.registerDisposer(new $n(e,this.inputEventMap)),this.registerDisposer(new np(e))}bindAction(e,t){this.registerDisposer(Se(this.element,e,t))}bindCallback(e,t){const n=()=>{t(this)};this.registerDisposer(Se(this.element,e,n))}registerActionListeners(){for(const e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e),this.closeSelectionTab&&this.closeSelectionTab()});for(const e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});for(const e of["copy-segment-id","add-copy-segment-id"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e,this.selectedLayer.layer)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){const t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{const e=this.selectedLayer.layer;if(e===void 0){tt.showTemporaryMessage("The annotate command requires a layer to be selected.");return}const t=e.layer;if(t===null||t.tool.value===void 0){tt.showTemporaryMessage(`The selected layer (${se(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new k4(this)}copyJsonStateToUrl(){on(this.makeUrlFromState(this.state.toJSON()))}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let e=this.dataContext.chunkQueueManager;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}}const tx="tool",ix="toolBindings",ig="localPosition",nx="localDimensions",rx="source",Q4="transform",sx="pick";class eW{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}}class al extends K{constructor(e){super(),this.managedLayer=e,this.pick=new Qt(!0,!0),this.layersChanged=new xe,this.readyStateChanged=new xe,this.specificationChanged=new xe,this.renderLayers=new Array,this.loadingCounter=1,this.tabs=this.registerDisposer(new ZU),this.panels=new nz(this),this.tool=this.registerDisposer(new oz(this)),this.toolBinder=new dz(this),this.dataSourcesChanged=new xe,this.dataSources=[],this.allowingRefresh=!1,this.localCoordinateSpaceCombiner.includeDimensionPredicate=RE,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new tz(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=Eo,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){const n=(e.localCoordinateSpace=this.localCoordinateSpace.value).rank;if(n!==0){const r=we(t,ig,s=>st(new Float32Array(n),s,Tt));r===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=r)}(e.annotationId=we(t,"annotationId",Ie))!==void 0&&(e.annotationSourceIndex=we(t,"annotationSource",hi,0),e.annotationPartIndex=we(t,"annotationPart",hi),e.annotationSubsource=we(t,"annotationSubsource",Ie)),e.value=t.value}displaySelectionState(e,t,n){return!1}selectionStateToJson(e,t){const n={};if(e.localPositionValid){const r=e.localPosition;r.length>0&&(n.localPosition=Te(r))}return e.annotationId!==void 0&&(n.annotationId=e.annotationId,n.annotationPart=e.annotationPartIndex,n.annotationSource=e.annotationSourceIndex,n.annotationSubsource=e.annotationSubsource),e.value!=null&&(n.value=e.value),n}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;const n=this.localPosition.value;let r=e.localPosition;r.length!==n.length?e.localPosition=n.slice():r.set(n),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;const n=t.localPosition;e.localPosition.length!==n.length?e.localPosition=n.slice():e.localPosition.set(n),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){const t=new A3(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(const t of this.dataSources){const n=t.loadState;if(!(n===void 0||n.error!==void 0))for(const r of n.subsources)if(r.enabled)yield r;else{const s=r.activated;r.messages.clearMessages(),s!==void 0&&(s.dispose(),r.activated=void 0,n.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter===0&&this.readyStateChanged.dispatch()}markLoading(){const e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter===1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){const t=this.manager.root.coordinateSpaceCombiner.bind(e),n=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}initializationDone(){const e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,n,r){return e===void 0?[]:[ad(e,n)]}getDataSourceSpecifications(e){let t,n=Y(e,rx,s=>Array.isArray(s)?s.map(o=>ad(o)):typeof s=="object"?[ad(s)]:(t=s,[]));const r=Y(e,Q4,jV);return n.push(...this.getLegacyDataSourceSpecifications(t,e,r,n)),n=n.filter(s=>s.url),n.length===0&&n.push(rk()),n}restoreState(e){this.tool.restoreState(e[tx]),this.toolBinder.restoreState(e[ix]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[nx]),this.localPosition.restoreState(e[ig]),this.constructor.supportsPickOption&&this.pick.restoreState(e[sx]);for(const t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);const t=this.layersChanged;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){const t=this.renderLayers,n=this.layersChanged,r=t.indexOf(e);if(r===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(r,1),e.layerChanged.remove(n.dispatch),e.userLayer=void 0,e.dispose(),n.dispatch()}disposed(){const e=this.layersChanged;wo(this.dataSources);for(const t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let n,r=this.renderLayers,s=t.pickedRenderLayer;if(s!==null&&r.indexOf(s)!==-1&&(n=s.transformPickedValue(t),n=this.transformPickedValue(n),n!=null))return n;for(let o of r)if(n=o.getValueAt(e),n!=null)break;return this.transformPickedValue(n)}transformPickedValue(e){return e}toJSON(){return j({type:this.type,[rx]:tW(this.dataSources),[tx]:this.tool.toJSON(),[ix]:this.toolBinder.toJSON(),[nx]:this.localCoordinateSpace.toJSON(),[ig]:this.localPosition.toJSON(),[sx]:this.pick.toJSON()},this.panels.toJSON())}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){const n=this.manager.root.globalPosition,r=this.localPosition;e?(TS(n.value,t,e.globalToRenderLayerDimensions),TS(r.value,t,e.localToRenderLayerDimensions)):n.value.set(t),r.changed.dispatch(),n.changed.dispatch()}}al.supportsPickOption=!1;function tW(i){if(i.length!==0)return i.length===1?i[0].toJSON():i.map(e=>e.toJSON())}class Ry extends K{constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new Av,this.localCoordinateSpaceCombiner=new Vv(this.localCoordinateSpace,nd),this.localPosition=this.registerDisposer(new Qs(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new xe,this.layerChanged=new xe,this.specificationChanged=new xe,this.containers=new je,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){const n=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{n.forEach(r=>r())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){const e=this.layer;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){const t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(const t of this.manager.root.subsets){const n=t.layerManager;n.has(this)&&n.removeManagedLayer(this)}}else{for(const t of this.manager.root.subsets){const n=t.layerManager;n.has(this)||n.addManagedLayer(this.addRef())}this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class jI extends K{constructor(){super(),this.managedLayers=new Array,this.layerSet=new je,this.layersChanged=new xe,this.readyStateChanged=new xe,this.specificationChanged=new xe,this.boundPositions=new C3,this.numDirectUsers=0,this.nonArchivedLayerIndexGeneration=-1,this.renderLayerToManagedLayerMapGeneration=-1,this.renderLayerToManagedLayerMap_=new ue,this.scheduleRemoveLayersWithSingleRef=this.registerCancellable(ct(()=>this.removeLayersWithSingleRef(),0)),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){const e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(const n of this.managedLayers)n.archived||(n.nonArchivedLayerIndex=t++);for(const n of this.managedLayers)n.archived&&(n.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(const n of this.managedLayers)if(!n.archived){if(t===e)return n;++t}}get renderLayerToManagedLayerMap(){const e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(const n of this.managedLayers){const r=n.layer;if(r!==null)for(const s of r.renderLayers)t.set(s,n)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(n=>e(n)?!0:(this.unbindManagedLayer(n),this.layerSet.delete(n),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers===1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers===0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,hz),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,uz),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){const t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){const n=this.managedLayers.length;if(e===t||e<0||e>=n||t<0||t>=n)return;var r=this.managedLayers.splice(e,1),s=oe(r,1);let o=s[0];this.managedLayers.splice(t,0,o),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,n=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++n;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Wi](){for(let t of e.managedLayers)if(t.layer!==null)for(let n of t.layer.renderLayers)yield n}}}get visibleRenderLayers(){let e=this;return{*[Wi](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let n of t.layer.renderLayers)yield n}}}invokeAction(e,t){const n=new eW;for(let r of this.managedLayers){if(r.layer===null||!r.visible||t!==void 0&&r!==t)continue;let s=r.layer;s.handleAction(e,n);for(let o of s.renderLayers)o.handleAction(e)}for(const r of n.callbacks)r()}}class iW{constructor(){this.changed=new xe,this.coordinateSpace=Ur,this.position=Eo,this.unsnappedPosition=Eo,this.active=!1,this.displayDimensions=void 0,this.pickedRenderLayer=null,this.pickedValue=new re(0,0),this.pickedOffset=0,this.pickedAnnotationLayer=void 0,this.pickedAnnotationId=void 0,this.pickedAnnotationBuffer=void 0,this.pickedAnnotationBufferBaseOffset=void 0,this.pickedAnnotationIndex=void 0,this.pickedAnnotationCount=void 0,this.pickedAnnotationType=void 0,this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){const e=this.forcerFunction;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}}class nW extends K{constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new xe,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState;const t=this.changed.count;if(e.active)for(const n of this.layerManager.managedLayers){const r=n.layer;if(n.visible&&r!==null){const s=r.selectionState;s&&(r.resetSelectionState(s),s.generation=t,r.captureSelectionState(s,e))}}}get(e){this.update();const t=e.selectionState;if(!(t&&t.generation!==this.changed.count))return t}toJSON(){this.update();const e={};for(const t of this.layerManager.managedLayers){const n=t.layer;if(n){const r=this.get(n);r!==void 0&&(e[t.name]=n.selectionStateToJson(r,!0))}}return e}}const ax=10,Em=j(j({},Sa),{minSize:150,row:1}),ox=j(j({},Em),{visible:!0});class rW extends K{constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new xe,this.history=[],this.historyIndex=0,this.location=new Rs(Em),this.pin=new gt(!0),this.registerDisposer(Fr((n,r)=>{r||(this.capture(!0),n.registerDisposer(t.changed.add(n.registerCancellable(Uh(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){const e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;const e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){const t=this.history;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>ax&&t.splice(0,t.length-ax),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,n=!0,r=!0){if(n===!1&&(!this.location.visible||this.pin.value))return;const s={};e.initializeSelectionState(s),t(s)&&(r&&(this.location.visible=!0),n===!0?this.pin.value=!0:n==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:s}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){const e=this.value;let t;if(this.location.visible){if(t=this.location.toJSON(j(j({},ox),{visible:!ws.expectingExternalUI})),this.pin.value&&e!==void 0){const n={};for(const r of e.layers){let s=r.layer.selectionStateToJson(r.state,!1);di(s).length===0&&(s=void 0),n[r.layer.managedLayer.name]=s}e.position!==void 0&&(t.position=Te(e.position)),t.layers=n}}else t=this.location.toJSON(Em),t=va(t),t!==void 0&&(t.visible=!1);return t}select(e=!0){const t=this.pin;e&&(this.location.visible=!0),t.value=!t.value,t.value&&this.capture()}capture(e=!1){const t=sW(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}ge(e),this.location.restoreState(e,j(j({},ox),{visible:!ws.expectingExternalUI}));const t=this.coordinateSpace.value,n=t.rank>0?we(e,"position",s=>st(new Float32Array(t.rank),s,Tt)):void 0,r=[];we(e,"layers",s=>{ge(s);const o=this.layerSelectedValues.layerManager;for(const c of Jd(s)){var l=oe(c,2);const u=l[0],f=l[1],g=o.getLayerByName(u);if(g===void 0)return;const v=g.layer;if(v===null)return;ge(f);const y={};v.initializeSelectionState(y),v.selectionStateFromJson(y,f),r.push({layer:v,state:y})}}),this.pin.value=r.length>0||n!==void 0,this.value={position:n,coordinateSpace:t,layers:r}}}function sW(i){const e=i.mouseState;if(!e.active)return;const t=[];for(const n of i.layerManager.managedLayers){const r=n.layer;if(r===null)continue;const s=i.get(r);if(s===void 0)continue;const o={};r.initializeSelectionState(o),r.copySelectionState(o,s),t.push({layer:r,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}class aW extends K{constructor(e){super(),this.view=e,this.messages=new qo,this.seenGeneration=-1,this.state=void 0}}let oW=0;class lW extends K{constructor(e,t,n,r,s,o){super(),this.layerManager=e,this.renderLayerType=t,this.view=n,this.roles=r,this.layerAdded=s,this.visibility=o,this.visibleLayers_=new ue,this.debouncedUpdateVisibleLayers=this.registerCancellable(ct(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(r.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){const e=++oW,t=this.visibleLayers_,n=this.renderLayerType,r=this.layerAdded,s=this.roles;for(let l of this.layerManager.readyRenderLayers())if(l instanceof n&&s.has(l.role)){let c=l,u=t.get(c);u===void 0&&(u=new aW(this.view),u.registerDisposer(c.messages.addChild(u.messages)),u.registerDisposer(c.addRef()),u.registerDisposer(c.visibility.add(this.visibility)),t.set(c,u),r(c,u),c.attach(u)),u.seenGeneration=e}for(const l of t){var o=oe(l,2);const c=o[0],u=o[1];u.seenGeneration!==e&&(t.delete(c),u.dispose())}}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function HI(i,e,t,n,r){return n.registerDisposer(new lW(i,e,n,t,(s,o)=>{o.registerDisposer(s.redrawNeeded.add(()=>n.scheduleRedraw()));const l=s.backend;l&&(l.rpc.invoke(gO,{layer:l.rpcId,view:n.rpcId}),o.registerDisposer(()=>l.rpc.invoke(mO,{layer:l.rpcId,view:n.rpcId}))),n.scheduleRedraw(),o.registerDisposer(()=>n.scheduleRedraw())},n.visibility))}class dW extends K{constructor(e){super(),this.layerManager=e,this.changed=new xe,this.location=new Rs(iz),this.registerDisposer(e),this.location.changed.add(()=>{var t,n;this.changed.dispatch();const r=(n=(t=this.layer)===null||t===void 0?void 0:t.layer)!==null&&n!==void 0?n:void 0;if(r!==void 0){const s=this.location.value;if(s.visible){const o=r.panels.panels[0];o.location.value!==s&&(o.location.value=s,o.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){const n=this.layerManager.managedLayers;n.length>0?t=this.layer=n[0]:e=!1}if(e===!0&&t!==void 0){const n=t.layer;(n===null||n.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;const t=e.layer;t!==null&&t instanceof $r&&(t.dataSources.some(n=>n.spec.url.length!==0)||ll(e))}set layer(e){if(e===this.layer_)return;const t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){const n=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(n);const r=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{const s=e.layer;if(s!==null){const o=s.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(n),r()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){const e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),va(e)}restoreState(e){if(e===void 0){this.reset();return}ge(e),this.location.restoreState(e);const t=Y(e,"layer",Cn),n=t!==void 0?this.layerManager.getLayerByName(t):void 0;n===void 0&&(this.visible=!1),this.layer=n}reset(){this.location.reset(),this.layer=void 0}}class cW extends K{constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new xe,this.validate=ct(()=>{const n=this.layerName_;if(n!==void 0){const r=this.layerManager.getLayerByName(n);r!==void 0&&this.filter(r)?(this.layer_=r,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{const n=this.layer_;if(n!==void 0)if(!this.layerManager.layerSet.has(n)||!this.filter(n))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{const r=n.name;r!==this.layerName_&&(this.layerName_=r,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){const t=Cn(e);this.layerName=t}toJSON(){const e=this.layer_;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class lx extends K{constructor(e,t,n,r){super(),this.layerManager=e,this.layer=t,this.predicate=n,this.getGroup=r,this.linkedLayers_=new je,this.changed=new xe,this.linkedLayersChanged=new xe,this.root_=t;const s=this;this.root={get value(){return s.root_},changed:s.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;const t=Ie(e);this.linkByName(t)}toJSON(){const e=this.root.value;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){const t=this.getGroup,n=this.layer,r=this.root_;if(r===n){const o=this.linkedLayers_;if(o.size!==0){for(const l of o){const c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}const s=t(r);s.linkedLayers_.delete(n),s.linkedLayersChanged.dispatch(),this.root_=n,e&&this.changed.dispatch()}linkByName(e){const t=this.layer.managedLayer,n=this.layerManager.getLayerByName(e);if(n===void 0||n===t)return;const r=n.layer;r!==null&&this.predicate(r)&&this.linkToLayer(r)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);const t=this.getGroup,n=t(e).root_;if(n===this.layer)return;const r=t(n);r.linkedLayers_.add(this.layer),r.linkedLayersChanged.dispatch(),this.root_=n,this.changed.dispatch()}disposed(){this.isolate(!1)}}function JI(i,e){const t=we(e,"type",Ie,"auto");i.archived=we(e,"archived",oa,!1),i.archived?i.visible=!1:i.visible=we(e,"visible",oa,!0);const n=Qu.get(t)||$r;return i.layer=new n(i),e}function ZI(i,e){try{const t=i.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw ll(i),t}}function qI(i,e){try{ge(e),JI(i,e),ZI(i,e)}catch(t){throw ll(i),t}}function uW(i,e){try{qI(i,e)}catch(t){new tt().setErrorMessage(t instanceof Error?t.message:""+t)}}function YI(i,e,t){const n=new Ry(e,i);return qI(n,t),n}class KI extends K{constructor(){super(...arguments),this.changed=new xe}}class hW extends KI{constructor(e,t,n,r,s,o,l,c,u){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=n,this.chunkManager=r,this.selectionState=s,this.selectedLayer=o,this.coordinateSpace=l,this.globalPosition=c,this.toolBinder=u,this.coordinateSpaceCombiner=new Vv(this.coordinateSpace,UV),this.subsets=new je,this.layerSelectedValues=this.selectionState.layerSelectedValues,this.registerDisposer(n.layersChanged.add(this.changed.dispatch)),this.registerDisposer(n.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(ge(e),t=Jd(e).map(([r,s])=>typeof s=="string"?{name:r,source:s}:(ge(s),j(j({},s),{name:r}))));const n=[];for(const r of t){ge(r);const s=this.layerManager.getUniqueLayerName(Y(r,"name",Ie)),o=new Ry(s,this);try{JI(o,r),this.layerManager.addManagedLayer(o),n.push({managedLayer:o,spec:r})}catch(l){o.dispose(),new tt().setErrorMessage(`Error creating layer ${se(s)}: `+(l instanceof Error)?l.message:""+l)}}for(const r of n){const s=r.managedLayer,o=r.spec;try{ZI(s,o)}catch(l){new tt().setErrorMessage(`Error creating layer ${se(name)}: `+(l instanceof Error)?l.message:""+l)}}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){const e=[];let t=0;for(let n of this.layerManager.managedLayers){const r=n.toJSON();r!=null&&(e.push(r),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}}class XI extends KI{constructor(e){super(),this.master=e,this.changed=new xe,this.layerManager=this.registerDisposer(new jI),this.registerDisposer(e);const t=this.layerManager;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){const t=this.master.layerManager,n=[];for(const r of new je(He(e,Ie))){const s=t.getLayerByName(r);if(s===void 0)throw new Error(`Undefined layer referenced in subset specification: ${se(r)}`);s.archived||n.push(s)}this.layerManager.clear();for(const r of n)this.layerManager.addManagedLayer(r.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}const Qu=new ue,Ny=new ue,QI=[i=>{const e=i.volume;if(e===void 0)return;const t=Ny.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function ol(i,e=i.type){Qu.set(e,i)}function Vy(i){QI.push(i)}function eT(i,e){Ny.set(i,e)}function Oy(i,e){const t=i.layer;if(t===null)return;const n=t.toJSON(),r=new e(i);r.restoreState(n),r.initializationDone(),i.layer=r}function tT(i,e){return e!==i.name?(e=i.manager.root.layerManager.getUniqueLayerName(e),i.name=e,i.layerChanged.dispatch(),!0):!1}function ll(i){if(!i.wasDisposed)for(const e of i.containers)e.removeManagedLayer(i)}function Lm(i,e){return i===void 0?e:e===void 0?i:i.priority<e.priority?e:i}function pW(i){let e;for(const n of QI)e=Lm(e,n(i));const t=i.volume;if(t!==void 0){const n=Ny.get(t.volumeType);n!==void 0&&(e=Lm(e,{layerConstructor:n,priority:0}))}return e}function iT(i){let e;for(const t of i){const n=t.subsourceEntry.subsource;e=Lm(e,pW(n))}return e}class $r extends al{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=iT(e))===null||t===void 0?void 0:t.layerConstructor}}$r.type="new";$r.typeAbbreviation="new";class By extends al{activateDataSubsources(e){var t;const n=(t=iT(e))===null||t===void 0?void 0:t.layerConstructor;n!==void 0&&Oy(this.managedLayer,n)}}By.type="auto";By.typeAbbreviation="auto";function nT(i,e){const t=YI(i,"new layer",{type:"new"});i.add(t),e.layer=t,e.visible=!0}ol($r);ol(By);function dx(i,e){return e=ir(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=ir(e,461845907)>>>0,i^=e,i=(i<<13|i>>>19)>>>0,i=ir(i,5)+3864292196>>>0,i}function fW(i,e){return i^=e,i^=i>>>16,i=ir(i,2246822507)>>>0,i^=i>>>13,i*=3266489909,i^=i>>>16,i>>>0}function rT(i,e,t){let n=i;return n=dx(n,e),n=dx(n,t),fW(n,8)}class gW extends Jr{constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}function mW(i,e,t){const n=i.length-1;for(;;){if(e=e&n,i[e]===0){i[e]=t;return}++e}}function eh(i,e){return e<=255?new Uint8Array(i):e<=65535?new Uint16Array(i):new Uint32Array(i)}function vW(i){const e=i.length/2,t=2**(Math.ceil(Yi(e))+1),n=eh(t,e+1);for(let r=0;r<e;++r){const s=i[2*r],o=i[2*r+1];mW(n,rT(0,s,o),r+1)}return n}function yW(i,e,t,n){let r=rT(0,t,n);const s=i.length-1;for(;;){r=r&s;let o=i[r];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===n)return o;++r}}class sT{constructor(e){this.inlineProperties=e.inlineProperties}}class bW{constructor(e){var t;this.segmentPropertyMap=e;const n=e.inlineProperties;n!==void 0&&(this.inlineIdToIndex=vW(n.ids)),this.tags=n==null?void 0:n.properties.find(r=>r.type==="tags"),this.labels=n==null?void 0:n.properties.find(r=>r.type==="label"),this.numericalProperties=(t=n==null?void 0:n.properties.filter(r=>r.type==="number"))!==null&&t!==void 0?t:[]}getSegmentInlineIndex(e){const t=this.inlineIdToIndex;return t===void 0?-1:yW(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){const t=this.getSegmentInlineIndex(e);if(t===-1)return;const n=this.labels,r=this.tags;let s="";if(n!==void 0&&(s=n.values[t]),r!==void 0){const o=r.tags;let l=r.values[t];for(let c=0,u=l.length;c<u;++c){const f=o[l.charCodeAt(c)];s.length>0&&(s+=" "),s+="#",s+=f}}if(s.length!==0)return s}}function aT(i,e,t){for(let n=0,r=t.length;n<r;++n)e[t[n]]=i[n]}function SW(i){const e=i.length;if(e===0)return!0;let t=i[0],n=i[1];for(let r=0;r<e;r+=2){const s=i[r],o=i[r+1];if((o-n||s-t)<=0)return!1;t=s,n=o}return!0}function wW(i){const e=i.ids;if(SW(e))return i;const t=e.length/2,n=eh(t,t-1);for(let o=0;o<t;++o)n[o]=o;n.sort((o,l)=>{const c=e[o*2],u=e[o*2+1],f=e[l*2],g=e[l*2+1];return u-g||c-f});const r=new Uint32Array(t*2);for(let o=0;o<t;++o){const l=n[o];r[o*2]=e[l*2],r[o*2+1]=e[l*2+1]}const s=i.properties.map(o=>{const l=o.values,c=new l.constructor(t);for(let u=0;u<t;++u)c[u]=l[n[u]];return j(j({},o),{values:c})});return{ids:r,properties:s}}function CW(i,e,t){const n=new Array(e);return n.fill(""),aT(i.values,n,t),j(j({},i),{values:n})}function xW(i,e,t){const n=new Float32Array(e);return n.fill(Number.NaN),aT(i.values,n,t),j(j({},i),{values:n})}function cx(i,e,t){const n=i.type;return n==="label"||n==="description"||n==="string"||n==="tags"?CW(i,e,t):xW(i,e,t)}function EW(i,e){if(i===void 0)return e;if(e===void 0)return i;let t=0;const n=i.ids.length/2,r=e.ids.length/2,s=new Uint32Array(n),o=new Uint32Array(r),l=i.ids,c=e.ids;v2(n,r,(g,v)=>{const y=l[2*g+1],C=l[2*g],w=c[2*v+1],S=c[2*v];return y-w||C-S},g=>{s[g]=t,++t},g=>{o[g]=t,++t},(g,v)=>{s[g]=t,o[v]=t,++t});let u;if(t===n)u=l;else if(t===r)u=c;else{u=new Uint32Array(t*2);for(let g=0;g<n;++g){const v=s[g];u[2*v]=l[2*g],u[2*v+1]=l[2*g+1]}for(let g=0;g<r;++g){const v=o[g];u[2*v]=c[2*g],u[2*v+1]=c[2*g+1]}}const f=[];if(t===n)f.push(...i.properties);else for(const g of i.properties)f.push(cx(g,t,s));if(t===r)f.push(...e.properties);else for(const g of e.properties)f.push(cx(g,t,o));return{ids:u,properties:f}}function LW(i,e){return new sT({inlineProperties:EW(i.inlineProperties,e.inlineProperties)})}function kW(i){for(;;){if(i.length===0)return;if(i.length===1)return i[0];const e=[];for(let t=0,n=i.length;t<n;t+=2)t+1===n?e.push(i[t]):e.push(LW(i[t],i[t+1]));i=e}}function IW(i,e){return i.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>Ci(t))},()=>{const t=kW(e);if(t!==void 0)return new bW(t)})}const TW=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function DW(i,e){var t;if(e.match(TW)!==null){const g=e.split(/[\s,]+/),v=[],y=new je;for(let C=0,w=g.length;C<w;++C){const S=g[C];if(S==="")continue;const L=new re;if(!L.tryParseString(S))continue;const I=L.toString();y.has(I)||(y.add(I),v.push(L))}return v.sort(re.compare),{ids:v}}const n={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(t=i==null?void 0:i.segmentPropertyMap.inlineProperties)===null||t===void 0?void 0:t.properties,s=i==null?void 0:i.tags,o=(s==null?void 0:s.tags)||[],l=o.map(g=>g.toLowerCase()),c=i==null?void 0:i.labels,u=[];let f;for(let g=0;g<e.length;g=f){let v=e.indexOf(" ",g),y;if(v===-1?f=v=e.length:f=v+1,y=e.substring(g,v),y.length===0)continue;const C=(S,L)=>{const I=S.toLowerCase(),M=l.indexOf(I);if(M===-1){u.push({begin:L,end:v,message:`Invalid tag: ${S}`});return}if(S=o[M],n.includeTags.includes(S)||n.excludeTags.includes(S)){u.push({begin:L,end:v,message:`Duplicate tag: ${S}`});return}return S};if(y.startsWith("#")){const S=C(y.substring(1),g+1);S!==void 0&&n.includeTags.push(S);continue}if(y.startsWith("-#")){const S=C(y.substring(2),g+2);S!==void 0&&n.excludeTags.push(S);continue}if(y.startsWith("<")||y.startsWith(">")){let S=y.substring(1).toLowerCase();if(S!=="id"&&S!=="label"){const L=r==null?void 0:r.find(I=>I.id.toLowerCase()===S&&(I.type==="number"||I.type==="label"||I.type==="string"));if(L===void 0){u.push({begin:g+1,end:v,message:`Invalid field: ${S}`});continue}S=L.id}if(n.sortBy.find(L=>L.fieldId===S)!==void 0){u.push({begin:g+1,end:v,message:`Duplicate sort field: ${S}`});continue}n.sortBy.push({order:y[0],fieldId:S});continue}if(y.startsWith("|")){let S=y.substring(1).toLowerCase();if(S==="id"||S==="label")continue;const L=r==null?void 0:r.find(I=>I.id.toLowerCase()===S&&(I.type==="number"||I.type==="string"));if(L===void 0){u.push({begin:g+1,end:v,message:`Invalid field: ${S}`});continue}if(S=L.id,n.sortBy.find(I=>I.fieldId===S)||n.includeColumns.find(I=>I===S))continue;n.includeColumns.push(S);continue}if(y.startsWith("/")){if(n.regexp!==void 0){u.push({begin:g,end:v,message:"Only one regular expression allowed"});continue}if(n.prefix!==void 0){u.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(c===void 0){u.push({begin:g,end:v,message:"No label property"});continue}try{n.regexp=new RegExp(y.substring(1))}catch{u.push({begin:g,end:v,message:"Invalid regular expression syntax"})}continue}const w=y.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(w!==null){let S=w[1].toLowerCase();const L=w[2],I=i==null?void 0:i.numericalProperties.find(O=>O.id.toLowerCase()===S);if(I===void 0){u.push({begin:g,end:g+S.length,message:`Invalid numerical field: ${S}`});continue}S=I.id;let M;try{M=Bd(I.dataType,w[3])}catch(O){u.push({begin:g+w[1].length+w[2].length,end:v,message:O.message});continue}let R=n.numericalConstraints.find(O=>O.fieldId===S);R===void 0&&(R={fieldId:S,bounds:I.bounds},n.numericalConstraints.push(R));const D=pd(I.bounds,R.bounds[0]),T=pd(I.bounds,R.bounds[1]);let A=T,V=D;switch(L){case"<":A=Du(I.dataType,M,-1);break;case"<=":A=M;break;case"=":A=V=M;break;case">=":V=M;break;case">":V=Du(I.dataType,M,1);break}if(V=xn(D,V)>0?D:V,A=xn(T,A)<0?T:A,xn(V,A)>0){u.push({begin:g,end:v,message:"Constraint would not match any values"});continue}R.bounds=[V,A];continue}if(n.regexp!==void 0){u.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(c===void 0){u.push({begin:g,end:v,message:"No label property"});continue}n.prefix!==void 0?n.prefix+=` ${y}`:n.prefix=y}return u.length>0?{errors:u}:(n.sortBy.length===0&&n.sortBy.push({fieldId:oT(i),order:"<"}),n)}function ng(i){return"\\u"+i.toString(16).padStart(4,"0")}function PW(i,e){var t;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){const D=e.ids;return{query:e,total:-1,explicitIds:D,count:D.length}}const n=(t=i==null?void 0:i.segmentPropertyMap)===null||t===void 0?void 0:t.inlineProperties;if(n===void 0)return{query:e,count:0,total:-1};const r=n==null?void 0:n.properties,s=n.ids.length/2;let o=eh(s,s);for(let D=0;D<s;++D)o[D]=D;const l=D=>{let T=o.length,A=0;for(let V=0;V<T;++V){const O=o[V];D(O)&&(o[A]=O,++A)}o=o.subarray(0,A)};if(e.regexp!==void 0||e.prefix!==void 0){const D=i.labels.values,T=e.regexp,A=e.prefix;T!==void 0&&l(V=>D[V].match(T)!==null),A!==void 0&&l(V=>D[V].startsWith(A))}const c=e.includeTags,u=e.excludeTags,f=i.tags;if(c.length>0||u.length>0){const D=f.values,T=f.tags,A=[];for(const U of c)A.push([T.indexOf(U),1]);for(const U of u)A.push([T.indexOf(U),0]);A.sort((U,B)=>U[0]-B[0]);let V="^",O=0;const _=U=>{U<O||(V+=`[${ng(O)}-${ng(U)}]*`)};for(const U of A){var g=oe(U,2);const B=g[0],W=g[1];_(B-1),W&&(V+=ng(B)),O=B+1}_(65535),V+="$";const H=new RegExp(V);l(U=>D[U].match(H)!==null)}let v,y;const C=e.numericalConstraints;if(C.length>0){const D=i.numericalProperties,T=C.length,A=2**T-1;v=eh(o.length,A);for(let _=0;_<T;++_){const H=C[_],U=D.find(le=>le.id===H.fieldId).values,B=2**_;var w=oe(H.bounds,2);const W=w[0],F=w[1];for(let le=0,de=o.length;le<de;++le){const Re=U[o[le]];v[le]|=B*(Re>=W&&Re<=F)}}y=o,o=y.slice();let V=o.length,O=0;for(let _=0;_<V;++_)v[_]===A&&(o[O]=o[_],++O);o=o.subarray(0,O)}let S=[];if(f!==void 0){const D=[],T=f.tags,A=f.values,V=new Uint32Array(T.length);for(let O=0,_=o.length;O<_;++O){const H=A[o[O]];for(let U=0,B=H.length;U<B;++U)++V[H.charCodeAt(U)]}for(let O=0,_=T.length;O<_;++O){const H=V[O],U=T[O],B={tag:U,tagIndex:O,count:V[O]};e.includeTags.includes(U)||e.excludeTags.includes(U)?D.push(B):H>0&&S.push(B)}D.push(...S),S=D}const L=(D,T)=>{if(D.type!=="number"){const A=D.values;o.sort((V,O)=>Hd(A[V],A[O])*T)}else{const A=D.values;o.sort((V,O)=>(A[V]-A[O])*T)}},I=D=>{f!==void 0&&L(f,D);const T=i==null?void 0:i.labels;T!==void 0&&L(T,D)},M=e.sortBy;for(let D=M.length-1;D>=0;--D){var R=M[D];const T=R.fieldId,A=R.order,V=A==="<"?1:-1;if(T==="id"){if(D+1===M.length){if(A==="<")continue;o.reverse();continue}o.sort((O,_)=>V*(O-_));continue}else T==="label"?I(V):L(r.find(O=>O.id===T),V)}return{query:e,intermediateIndices:y,intermediateIndicesMask:v,indices:o,tags:S,count:o.length,total:s}}function AW(i,e,t){const n=e.values;var r=oe(t,2);const s=r[0],o=r[1],l=o<=s?0:256/(o-s),c=new Uint32Array(258),u=i.query.numericalConstraints,f=u.findIndex(g=>g.fieldId===e.id);if(f===-1){const g=i.indices;for(let v=0,y=g.length;v<y;++v){const C=n[g[v]];isNaN(C)||++c[Math.min(255,Math.max(-1,(C-s)*l))+1>>>0]}}else{const g=i.intermediateIndices,v=i.intermediateIndicesMask,y=2**u.length-1-2**f;for(let C=0,w=g.length;C<w;++C)if((v[C]&y)==y){const S=n[g[C]];isNaN(S)||++c[Math.min(255,Math.max(-1,(S-s)*l))+1>>>0]}}return{queryResult:i,histogram:c,window:t}}function MW(i,e,t,n){if(i===void 0){t.length=0,n.length=0;return}const r=i.numericalProperties,s=r.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let o=0;o<s;++o){const l=t[o],c=n[o],u=r[o];l!==void 0&&l.queryResult===e&&Mr(u.dataType,l.window,c)||(t[o]=AW(e,u,c))}}function oT(i){return i!=null&&i.tags||i!=null&&i.labels?"label":"id"}function RW(i,e){var t=e;const n=t.ids;if(n!==void 0)return n.map(g=>g.toString()).join(", ");let r="";e=e;var s=e;const o=s.prefix,l=s.regexp;o!==void 0?r=o:l!==void 0&&(r=`/${l}`);for(const g of e.includeTags)r.length>0&&(r+=" "),r+=`#${g}`;for(const g of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${g}`;for(const g of e.numericalConstraints){const v=g.fieldId,y=g.bounds;var c=oe(y,2);const C=c[0],w=c[1],S=i.numericalProperties.find(L=>L.id===v);if(!Mr(S.dataType,S.bounds,y)){if(xn(C,w)===0){r.length>0&&(r+=" "),r+=`${v}=${C}`;continue}if(xn(C,S.bounds[0])>0){r.length>0&&(r+=" ");const L=Du(S.dataType,C,-1),I=C.toString(),M=L.toString();S.dataType!==J.FLOAT32||I.length<=M.length?r+=`${v}>=${I}`:r+=`${v}>${M}`}if(xn(w,S.bounds[1])<0){r.length>0&&(r+=" ");const L=Du(S.dataType,w,1),I=w.toString(),M=L.toString();S.dataType!==J.FLOAT32||I.length<=M.length?r+=`${v}<=${I}`:r+=`${v}<${M}`}}}var u=e;let f=u.sortBy;if(f.length===1){const g=f[0];g.order==="<"&&g.fieldId===oT(i)&&(f=[])}for(const g of f)r.length>0&&(r+=" "),r+=`${g.order}${g.fieldId}`;for(const g of e.includeColumns)r.length>0&&(r+=" "),r+=`|${g}`;return r}const rg=new re;function yu(i,e,t){if(e===void 0)return;const n=e.explicitIds;if(n!==void 0){n.forEach(t);return}const r=e.indices;if(r!==void 0){var s=i==null?void 0:i.segmentPropertyMap.inlineProperties;const o=s.ids;for(let l=0,c=r.length;l<c;++l){const u=r[l];rg.low=o[u*2],rg.high=o[u*2+1],t(rg,l)}}}function NW(i,e,t){if(t.size===0)return 0;let n=0;return yu(i,e,r=>{t.has(r)&&++n}),n}function ux(i,e,t,n){const r=i.includeTags.filter(o=>o!==e),s=i.excludeTags.filter(o=>o!==e);return n===!0&&(t?r:s).push(e),j(j({},i),{includeTags:r,excludeTags:s})}function VW(i){return i.ids!==void 0?!1:i.errors!==void 0?!0:!(i.numericalConstraints.length>0||i.includeTags.length>0||i.excludeTags.length>0||i.prefix||i.regexp)}function _y(i,e){if(i===void 0||i.ids!==void 0||i.errors!==void 0)return!1;const t=i.sortBy,n=i.includeColumns;return t.find(r=>r.fieldId===e)!==void 0||n.includes(e)}const bu=ln("disjoint_sets:rank"),Rr=ln("disjoint_sets:parent"),th=ln("disjoint_sets:next"),ed=ln("disjoint_sets:prev");function sg(i){let e=i,t=i[Rr];for(;t!==i;)i=t,t=i[Rr];for(i=e[Rr];t!==i;)e[Rr]=t,e=i,i=e[Rr];return t}function OW(i,e){let t=i[bu],n=e[bu];return t>n?(e[Rr]=i,i):(i[Rr]=e,t===n&&(e[bu]=n+1),e)}function BW(i,e){let t=i[ed],n=e[ed];e[ed]=t,t[th]=e,i[ed]=n,n[th]=i}function*hx(i){let e=i;do yield e,e=e[th];while(e!==i)}function _W(i){i[Rr]=i,i[bu]=0,i[th]=i[ed]=i}const ro=ln("disjoint_sets:min");function px(i){return i[Rr]===i}class lT{constructor(){this.map=new ue,this.visibleSegmentEquivalencePolicy=new gt(Fn.MIN_REPRESENTATIVE),this.generation=0}has(e){let t=e.toString();return this.map.get(t)!==void 0}get(e){let t=e.toString(),n=this.map.get(t);return n===void 0?e:sg(n)[ro]}isMinElement(e){let t=this.get(e);return t===e||re.equal(t,e)}makeSet(e){let t=e.toString(),n=this.map,r=n.get(t);return r===void 0?(r=e.clone(),_W(r),r[ro]=r,n.set(t,r),r):sg(r)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let n=OW(e,t);BW(e,t);let r=e[ro],s=t[ro];const o=(this.visibleSegmentEquivalencePolicy.value&Fn.MAX_REPRESENTATIVE)!==0;return n[ro]=re.less(r,s)===o?s:r,!0}linkAll(e){for(let t=1,n=e.length;t<n;++t)this.link(e[0],e[t])}deleteSet(e){const t=this.map;let n=!1;for(const r of this.setElements(e))t.delete(r.toString()),n=!0;return n}*setElements(e){let t=e.toString(),n=this.map.get(t);n===void 0?yield e:yield*hx(n)}clear(){let e=this.map;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=sg(t)[ro],yield e}*roots(){for(let e of this.map.values())px(e)&&(yield e)}[Wi](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(px(t)){let n=new Array;for(let r of hx(t))n.push(r);n.sort(re.compare),e.push(n)}return e.sort((t,n)=>re.compare(t[0],n[0])),e.map(t=>t.map(n=>n.toString()))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var FW=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s},km;const UW="DisjointUint64Sets",dT="DisjointUint64Sets.add",cT="DisjointUint64Sets.clear",uT="DisjointUint64Sets.highBitRepresentativeChanged",hT="DisjointUint64Sets.deleteSet";let Pd=km=class extends Rh{constructor(){super(...arguments),this.disjointSets=new lT,this.changed=new xe}get value(){return this}static makeWithCounterpart(i,e){let t=new this;return t.disjointSets.visibleSegmentEquivalencePolicy=e,t.registerDisposer(e.changed.add(()=>{fx(t)})),t.initializeCounterpart(i),e.value&&fx(t),t}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(i,e){if(this.disjointSets.link(i,e)){let t=this.rpc;return t&&t.invoke(dT,{id:this.rpcId,al:i.low,ah:i.high,bl:e.low,bh:e.high}),this.changed.dispatch(),!0}return!1}linkAll(i){for(let e=1,t=i.length;e<t;++e)this.link(i[0],i[e])}has(i){return this.disjointSets.has(i)}get(i){return this.disjointSets.get(i)}clear(){if(this.disjointSets.clear()){let i=this.rpc;i&&i.invoke(cT,{id:this.rpcId}),this.changed.dispatch()}}setElements(i){return this.disjointSets.setElements(i)}deleteSet(i){if(this.disjointSets.deleteSet(i)){let e=this.rpc;e&&e.invoke(hT,{id:this.rpcId,l:i.low,h:i.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(i){if(i!==void 0){let e=[new re,new re];He(i,t=>{He(t,(n,r)=>{e[r%2].parseString(String(n),10),r!==0&&this.link(e[0],e[1])})})}}assignFrom(i){this.clear(),i instanceof km&&(i=i.disjointSets);for(const t of i){var e=oe(t,2);const n=e[0],r=e[1];this.link(n,r)}}};Pd=km=FW([Nh(UW)],Pd);const So=new re,ag=new re;_t(dT,function(i){let e=this.get(i.id);So.low=i.al,So.high=i.ah,ag.low=i.bl,ag.high=i.bh,e.disjointSets.link(So,ag)&&e.changed.dispatch()});_t(cT,function(i){let e=this.get(i.id);e.disjointSets.clear()&&e.changed.dispatch()});function fx(i){i.rpc.invoke(uT,{id:i.rpcId,value:i.disjointSets.visibleSegmentEquivalencePolicy.value})}_t(uT,function(i){let e=this.get(i.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=i.value});_t(hT,function(i){let e=this.get(i.id);So.low=i.l,So.high=i.h,e.disjointSets.deleteSet(So)&&e.changed.dispatch()});class zW extends B_{constructor(){super(...arguments),this.spanningTreeEdges=new ue,this.equivalences=new Pd,this.connections=new je,this.changed=new at}link(e,t){this.equivalences.link(e,t);for(const n of this.connections)n.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(const e of this.connections)og(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){const n=e.toString(),r=t.toString(),s=this.spanningTreeEdges;let o=s.get(n);o===void 0&&(o=new je,s.set(n,o));let l=s.get(r);l===void 0&&(l=new je,s.set(r,l)),o.add(r),l.add(n)}removeSpanningTreeEdge(e,t){const n=e.toString(),r=t.toString(),s=this.spanningTreeEdges,o=s.get(n),l=s.get(r);o.delete(r),o.size===0&&s.delete(n),l.delete(n),l.size===0&&s.delete(r)}*getSpanningTreeNeighbors(e){const t=new re,n=this.spanningTreeEdges.get(e.toString());if(n!==void 0)for(const r of n)t.parseString(r),yield t}restoreState(e){const t=this.equivalences,n=this.spanningTreeEdges;if(t.clear(),n.clear(),e===void 0)return;const r=[new re,new re];He(e,s=>{He(s,(o,l)=>{r[l%2].parseString(String(o),10),l!==0&&t.link(r[0],r[1])&&this.addSpanningTreeEdge(r[0],r[1])})})}toJSON(){const e=this.spanningTreeEdges;if(e.size===0)return;const t=new Array;for(let r of e){var n=oe(r,2);let s=n[0],o=n[1];const l=re.parseString(s);for(const c of o){const u=re.parseString(c);re.compare(l,u)>0||t.push([l,u])}}return t.sort((r,s)=>re.compare(r[0],s[0])||re.compare(r[1],s[1])),t.map(r=>r.map(s=>s.toString()))}get visibleSegmentEquivalencePolicy(){return Fn.MIN_REPRESENTATIVE}async merge(e,t){const n=this.equivalences;return re.equal(n.get(e),n.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),n.get(e))}async split(e,t){const n=this.computeSplit(e,t);if(n===void 0)throw new Error("Segments are already split");const r=n.includeBaseSegments,s=n.includeRepresentative,o=n.excludeBaseSegments,l=n.excludeRepresentative,c=this.equivalences;this.deleteSet(e),this.linkAll(r),this.linkAll(o);const u=(v,y)=>{for(const C of v)for(const w of this.getSpanningTreeNeighbors(C))re.equal(c.get(w),y)||this.removeSpanningTreeEdge(C,w)},f=c.get(e),g=c.get(t);u(r,f),u(o,g);for(const v of this.connections){const y=v.segmentsState.visibleSegments;y.has(l)&&(y.delete(l),y.add(s))}return this.normalizeAll(),this.changed.dispatch(),{include:f,exclude:g}}trackSegment(e,t){return()=>{}}computeSplit(e,t){const n=this.equivalences,r=n.get(e);if(!re.equal(r,n.get(t)))return;const s=new lT;for(const g of n.setElements(r))if(!re.equal(g,t))for(const v of this.getSpanningTreeNeighbors(g))re.equal(v,t)||s.link(g,v);const o=[],l=[],c=s.get(e);let u=e,f=t;for(const g of n.setElements(r))re.equal(s.get(g),c)?(o.push(g),re.compare(g,u)<0&&(u=g)):(l.push(g),re.compare(g,f)<0&&(f=g));return o.sort(re.compare),l.sort(re.compare),{includeBaseSegments:o,includeRepresentative:u,excludeBaseSegments:l,excludeRepresentative:f}}connect(e){const t=new GW(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),og(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable(ct(()=>og(e.visibleSegments,e.segmentEquivalences.disjointSets),0)))),this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}}function og(i,e){const t=[];for(const n of i.unsafeKeys()){const r=e.get(n);re.equal(n,r)||(t.push(r),i.delete(n))}for(const n of t)i.add(n)}class GW extends __{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var Ii;(function(i){i[i.UNKNOWN=0]="UNKNOWN",i[i.IMAGE=1]="IMAGE",i[i.SEGMENTATION=2]="SEGMENTATION"})(Ii||(Ii={}));function gx(i){const e=i.rank,t=i.dataType,n=i.compressedSegmentationBlockSize;var r=i.baseVoxelOffset;const s=r===void 0?new Float32Array(e):r;return j(j({},Gd(i)),{compressedSegmentationBlockSize:n,baseVoxelOffset:s,dataType:t})}function WW(i){if(i.compressedSegmentationBlockSize!==void 0||i.volumeType!==Ii.SEGMENTATION&&!i.volumeSourceOptions.discreteValues)return!1;switch(i.dataType){case J.UINT32:case J.UINT64:break;default:return!1}switch(i.rank){case 3:return!0;case 4:return i.chunkDataSize[3]===1;default:return!1}}function $W(i){let e=i.rank,t=i.lowerVoxelBound,n=i.upperVoxelBound;if(!WW(i))return gx(i);var r=i.volumeSourceOptions;let s=r.displayRank,o=r.multiscaleToViewTransform,l=i.chunkToMultiscaleTransform,c=i.chunkToViewTransform;c===void 0&&(c=Dh(new Float32Array(e*s),s,o,s,l,e+1,s,e,e));const u=i.maxCompressedSegmentationBlockSize,f=i.chunkDataSize;return gx(j(j({},i),{compressedSegmentationBlockSize:Float32Array.from(_u({rank:e,chunkToViewTransform:c,displayRank:s,lowerVoxelBound:t,upperVoxelBound:n,maxVoxelsPerChunkLog2:9,maxBlockSize:u===void 0?f:IV(new Uint32Array(e),f,u)}))}))}function rc(i){const e=i.rank;var t=i.volumeSourceOptions;const n=t.displayRank,r=t.multiscaleToViewTransform,s=t.modelChannelDimensionIndices,o=i.chunkToMultiscaleTransform,l=Dh(new Float32Array(n*e),n,r,n,o,e+1,n,e,e);let c=i.minBlockSize;c===void 0?(c=new Uint32Array(e),c.fill(1)):c=new Uint32Array(c);const u=i.lowerVoxelBound,f=i.upperVoxelBound;if(s.length!==0)for(const v of kh(o,e,s)){let y=f[v];u!==void 0&&(y-=u[v]),c[v]=y}var g=i.chunkDataSizes;return(g===void 0?m_(j(j({},i),{minBlockSize:c,chunkToViewTransform:l,displayRank:n})):g).map(v=>$W(j(j({},i),{chunkDataSize:v,chunkToViewTransform:l})))}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const jW=Ne(),HW=Ne(),mx=.001,JW=.001;function ZW(i){let e=0;for(var t=0;t<3;++t)i[t]<0&&(e+=1<<t);return e}const pT=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),qW=(()=>{const i=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],n=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],r=new Int32Array(8*8*6);for(let s=0;s<8;++s)for(let o=0;o<t.length;++o){const l=e[s]*8+t[o];r[s*8*6+o]=i[n[l]]}return r})();function ih(i){i.addUniform("highp vec3","uPlaneNormal"),i.addUniform("highp float","uPlaneDistance"),i.addUniform("highp ivec2","uVertexIndex",24),i.addUniform("highp vec3","uVertexBasePosition",8),i.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),pT)}),i.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${JW}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${mx}) && (lambda <= (1.0 + ${mx}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function YW(i,e,t){const n=i.gl;n.uniform3fv(i.uniform("uPlaneNormal"),e),n.uniform1f(i.uniform("uPlaneDistance"),t);const r=ZW(e);n.uniform2iv(i.uniform("uVertexIndex"),qW.subarray(r*48,(r+1)*48))}function Fy(i,e,t,n,r){const s=J1(jW,e,n);Cu(s,s);const o=yv(yn(HW,t,r),s);YW(i,s,o)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const KW=.001,XW=Qe();function QW(i,e){if(Wr(i),ih(i),i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),e){hr(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${bs};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}i.addVarying("highp vec3","vChunkPosition"),i.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${KW} * abs(uPlaneNormal);
`)}function e$(i,e,t){t&&fr(i,e,1)}function t$(i,e,t,n,r,s){const o=t.projectionParameters.value,l=o.centerDataPosition;Fy(e,o.viewportNormalInGlobalCoordinates,l,s.transform,s.invTransform),i.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,fi(XW,n,s.transform)),i.uniform3fv(e.uniform("uLowerClipBound"),r.lowerClipDisplayBound),i.uniform3fv(e.uniform("uUpperClipBound"),r.upperClipDisplayBound)}function i$(i,e,t){i.uniform3fv(e.uniform("uChunkDataSize"),t)}function n$(i,e,t,n){i.uniform3fv(e.uniform("uTranslation"),t),n?pr(e.gl,6,1):i.drawArrays(i.TRIANGLE_FAN,0,6)}function r$(i,e,t){return i>e?t>i?i:e>t?e:t:t>e?e:i>t?i:t}class fT extends iy{constructor(e,t){var n=t.shaderError;const r=n===void 0?Oh():n,s=t.shaderParameters;super(e.chunkManager,e,t);const o=this.gl;this.vertexIdHelper=this.registerDisposer(gr.get(o)),this.shaderParameters=s;const l=t.channelCoordinateSpace;this.channelCoordinateSpace=l===void 0?aa(Ur):l,this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch));const c=this.registerDisposer(wn((u,f)=>({numChannelDimensions:u.rank,dataHistogramChannelSpecifications:f}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Gv(this,o,{memoizeKey:`volume/RenderLayer:${Ci(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:s,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:c,defineShader:(u,f,g,v)=>{const y=f.chunkFormat,C=f.dataHistogramsEnabled,w=v.dataHistogramChannelSpecifications,S=v.numChannelDimensions;if(QW(u,y===null),u.addOutputBuffer("vec4","v4f_fragData0",0),u.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),y===null)return;Qk(u,y,S,"vChunkPosition");const L=w.length;if(C&&L>0){let I="";const M=y.dataType;for(let R=0;R<L;++R){const D=w[R].channel,T=`out_histogram${R}`;u.addOutputBuffer("vec4",T,1+R);const A=`getDataValue(${D.join(",")})`,V=`invlerpForHistogram${R}`;u.addFragmentCode(AL(u,V,M,!1)),u.addFragmentCode(`
float getHistogramValue${R}() {
  return invlerpForHistogram${R}(${A});
}
`),I+=`{
float x = getHistogramValue${R}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${T} = vec4(x, x, x, 1.0);
}`}u.addFragmentCode(`void userMain();
void main() {
  ${I}
  userMain();
}
#define main userMain
`)}this.defineShader(u,g)},getContextKey:u=>{var f;return`${(f=u.chunkFormat)===null||f===void 0?void 0:f.shaderKey}/${u.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let t=this.tempChunkPosition;for(const n of this.visibleSourcesList){const r=n.source,s=n.chunkTransform;if(!gd(t,e,this.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))continue;const o=r.getValueAt(t,s);if(o!=null)return o}return null}beginChunkFormat(e,t,n){const r=this.gl,s=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:s}),l=o.shader,c=o.parameters,u=o.fallback;if(l!==null&&(l.bind(),e$(l,n,t===null),t!==null)){if(s){const f=o.extraParameters.dataHistogramChannelSpecifications.length,g=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<f;++v)Zv(l,`invlerpForHistogram${v}`,t.dataType,g[v])}this.initializeShader(e,l,c,u),t.beginDrawing(r,l)}return o}endSlice(e,t,n){}draw(e){const t=e.sliceView,n=t.visibleLayers.get(this).visibleSources;if(n.length===0)return;const r=e.projectionParameters,s=e.wireFrame,o=this.gl;this.vertexIdHelper.enable();const l=Ne(),c=this.renderScaleHistogram;c!==void 0&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let u,f=null,g;const v=Ne(),y=()=>{f!==null&&(g!==null&&g.endDrawing(o,f),this.endSlice(t,f,u.parameters))};let C=!0;for(const w of n){const S=Qv(r,w.chunkLayout),L=w.chunkTransform.channelToChunkDimensionIndices,I=w.source,M=w.fixedPositionWithinChunk,R=w.chunkDisplayDimensionIndices;for(const U of R)M[U]=0;const D=s?null:I.chunkFormat;if(D!==g&&(g=D,y(),u=this.beginChunkFormat(t,D,r),f=u.shader),f===null)continue;const T=I.chunks;v.fill(1);let A=S.size,V;const O=I.spec.rank;t$(o,f,t,r.viewProjectionMat,w,S),D!==null&&D.beginSource(o,f),C=!0;let _=0,H=0;if(t.forEachVisibleChunk(w,S,U=>{let B=T.get(U);if(B&&B.state===Et.GPU_MEMORY){let W=B.chunkDataSize;if(W!==V){V=W;for(let le=0;le<3;++le){const de=R[le];v[le]=de===-1||de>=O?1:V[de]}i$(o,f,v)}const F=B.chunkGridPosition;for(let le=0;le<3;++le){const de=R[le];l[le]=de===-1||de>=O?0:A[le]*F[de]}D!==null&&D.bindChunk(o,f,B,M,R,L,C),C=!1,n$(o,f,l,s),++_}else++H}),(_!==0||H!==0)&&c!==void 0){const U=w.effectiveVoxelSize,B=r$(U[0],U[1],U[2]);c.add(B,B/r.pixelSize,_,H)}}if(y(),this.vertexIdHelper.disable(),!e.wireFrame){const w=this.getDataHistogramCount();w>0&&t.computeHistograms(w,this.dataHistogramSpecifications)}}}class vx{constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new oy}update(){let e=this.disjointSets;const t=e.generation;if(this.generation!==t){this.generation=t;let r=this.hashMap;r.clear();for(let s of e.mappings()){var n=oe(s,2);let o=n[0],l=n[1];r.set(o,l)}}}}class lg extends fT{constructor(e,t){super(e,{shaderParameters:new O1(n=>({hasEquivalences:n.registerDisposer(wn(r=>r.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:n.registerDisposer(wn(r=>r.size!==0,[t.segmentStatedColors])),hasSegmentDefaultColor:n.registerDisposer(wn(r=>r!==void 0,[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentationGroupState=this.displayState.segmentationGroupState.value,this.segmentColorShaderManager=new TF("segmentColorHash"),this.segmentStatedColorShaderManager=new DF("segmentStatedColor"),this.hashTableManager=new Tk("visibleSegments"),this.gpuHashTable=this.registerDisposer(Jl.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=Jl.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesShaderManager=new Dk("equivalences"),this.equivalencesHashMap=new vx(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new vx(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(Jl.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Jl.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),vy(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)===null||e===void 0||e.dispose()}getSources(e){return this.multiscaleSource.getSources(j(j({},e),{discreteValues:!0}))}defineShader(e,t){this.hashTableManager.defineShader(e);let n=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;n+=`return x;
}
`,e.addFragmentCode(n),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let r=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(r+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),r+=`
  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if (uSelectedSegment == value.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let s=`vec3 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),s+=`
  vec3 rgb;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {
    return rgb;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),s+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),s+=`  return segmentColorHash(value);
`),s+=`
}
`,e.addFragmentCode(s),r+=`
  vec3 rgb = getMappedIdColor(valueForColor);
  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));
`,e.setFragmentMain(r)}initializeShader(e,t,n){const r=this.gl,s=this.displayState,o=this.segmentationGroupState,l=this.displayState.segmentSelectionState;var c=this.displayState;const u=c.segmentDefaultColor.value,f=c.segmentColorHash.value,g=WL(o),v=this.displayState.ignoreNullVisibleSet.value;let y=0,C=0;if(l.hasSelectedSegment){let w=l.selectedSegment;y=w.low,C=w.high}if(r.uniform1f(t.uniform("uSelectedAlpha"),s.selectedAlpha.value),r.uniform1f(t.uniform("uSaturation"),s.saturation.value),r.uniform1f(t.uniform("uNotSelectedAlpha"),s.notSelectedAlpha.value),r.uniform2ui(t.uniform("uSelectedSegment"),y,C),r.uniform1ui(t.uniform("uShowAllSegments"),g.hashTable.size||!v?0:1),this.hashTableManager.enable(r,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),n.hasEquivalences){const w=o.useTemporarySegmentEquivalences.value;(w?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(r,t,w?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(u===void 0?this.segmentColorShaderManager.enable(r,t,f):r.uniform3fv(t.uniform("uSegmentDefaultColor"),u),n.hasSegmentStatedColors){const w=this.displayState.segmentStatedColors.value;let S=this.gpuSegmentStatedColorHashTable;(S===void 0||S.hashTable!==w.hashTable)&&(S==null||S.dispose(),this.gpuSegmentStatedColorHashTable=S=Jl.get(r,w.hashTable)),this.segmentStatedColorShaderManager.enable(r,t,S)}}endSlice(e,t,n){const r=this.gl;this.hashTableManager.disable(r,t),n.hasEquivalences&&this.equivalencesShaderManager.disable(r,t),n.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(r,t),super.endSlice(e,t,n)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function td(i=.5){return new ci(i,Cv)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Uy=12,gT=8,s$=6,a$=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function o$(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*s$*e,t)}const l$=0,zy=l$+1,Zi=zy+gT,d$=Zi+Uy,c$=d$+6,u$=Float32Array.from([0,0,0,0,0,1,Zi+0,1,0,0,1,0,1,Zi+1,0,1,0,0,1,1,Zi+2,1,1,0,1,1,1,Zi+3,0,0,0,0,1,0,Zi+4,0,0,1,0,1,1,Zi+5,1,0,0,1,1,0,Zi+6,1,0,1,1,1,1,Zi+7,0,0,0,1,0,0,Zi+8,0,0,1,1,0,1,Zi+9,0,1,0,1,1,0,Zi+10,0,1,1,1,1,1,Zi+11]),yx=Qe(),hs=new Float32Array(6);let mT=class extends Wd{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl))}defineShader(i){Wr(i);const e=this.rank;Ud(i,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",e,2),i.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(i,e,t){Cs(yx,e.modelViewProjectionMatrix),SN(yx,hs);const n=e.chunkDisplayTransform.numChunkDisplayDims;for(let r=0;r<n;++r)hs[r]=0,hs[r+3]=0;for(let r=n;r<3;++r){const s=Math.abs(hs[r+3]-hs[r]);hs[r]-=s,hs[r+3]+=s}super.enable(i,e,r=>{const s=r.vertexShaderInputBinders.Bounds;s.enable(1);const o=this.gl;o.uniform3fv(r.uniform("uModelSpaceBoundOffsets"),hs),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),s.bind(this.geometryDataStride,e.bufferOffset);const l=this.vertexIdHelper;l.enable(),t(r),l.disable(),s.disable()})}};function vT(i){i.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function yT(i){i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function Im(i){yT(i),i.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function h$(i){vT(i),i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}class p$ extends mT{constructor(){super(...arguments),this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(Ki.fromData(this.gl,Sg(u$,7,1,bs))),this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{const t=this.rank;this.defineShader(e),hr(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),Im(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)}),this.boxCornerOffsetsBuffer=this.registerDisposer(Ki.fromData(this.gl,Sg(pT,3,1,Cy))),this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{const t=this.rank;this.defineShader(e),Xd(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),Im(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${zy}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){const t=this.gl;this.enable(this.edgeShaderGetter,e,n=>{const r=n.attribute("aBoxCornerOffset1"),s=n.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(s,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),fr(n,e.renderContext.projectionParameters,1),pr(t,Uy,e.count),t.disableVertexAttribArray(r),t.disableVertexAttribArray(s)})}drawCorners(e){const t=this.gl;this.enable(this.cornerShaderGetter,e,n=>{const r=n.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),Qd(n,e.renderContext.projectionParameters,{featherWidthInPixels:0}),ec(n.gl,gT,e.count),t.disableVertexAttribArray(r)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}let f$=class extends mT{constructor(){super(...arguments),this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",i=>{const e=this.rank;super.defineShader(i),ih(i),hr(i),i.addVarying("highp float","vClipCoefficient"),Im(i),i.setVertexMain(`
float modelPositionA[${e}] = getBounds0();
float modelPositionB[${e}] = getBounds1();
for (int i = 0; i < ${e}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${bs};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(i)};
`),i.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)}),this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",i=>{const e=this.rank;super.defineShader(i),ih(i),i.addVarying("highp float","vClipCoefficient"),h$(i),i.setVertexMain(`
float modelPositionA[${e}] = getBounds0();
float modelPositionB[${e}] = getBounds1();
for (int i = 0; i < ${e}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(i)};
`),i.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(i,e,t){super.enable(i,e,n=>{const r=e.renderContext.sliceView.projectionParameters.value;Fy(n,r.viewportNormalInGlobalCoordinates,r.centerDataPosition,e.renderSubspaceModelMatrix,e.renderSubspaceInvModelMatrix),t(n)})}draw(i){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,i,()=>{fB(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,i.count)}),this.enableForBoundingBox(this.faceShaderGetter,i,e=>{fr(e,i.renderContext.projectionParameters,1),pr(e.gl,6,i.count)})}};function g$(i,e){const t=i.length;for(let n=0;n<t;++n){const r=e[n],s=e[n+t],o=i[n];i[n]=Math.abs(r-o)<Math.abs(s-o)?r:s}}$d(Me.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:f$,perspectiveViewRenderHelper:p$,defineShaderNoOpSetters(i){yT(i),vT(i)},pickIdsPerInstance:c$,snapPosition(i,e,t,n){const r=i.length,s=new Float32Array(e,t,r*2);n>=zy&&n<Zi&&g$(i,s)},getRepresentativePoint(i,e,t){i.set(e.pointA)},updateViaRepresentativePoint(i,e,t){const n=e.length,r=i.pointA,s=i.pointB,o=new Float32Array(n),l=new Float32Array(n);for(let c=0;c<n;++c){const u=o[c]=e[c];l[c]=s[c]+(u-r[c])}return j(j({},i),{pointA:o,pointB:l})}});const ao=0,Tm=ao+1,m$=Tm+2;function bT(i){i.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function ST(i){i.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}let bx=class extends Wd{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",i=>{const e=this.rank;this.defineShader(i),hr(i),i.addVarying(`highp float[${e}]`,"vModelPosition"),i.addVertexCode(`
float ng_LineWidth;
`),bT(i),i.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),i.setVertexMain(`
float modelPositionA[${e}] = getVertexPosition0();
float modelPositionB[${e}] = getVertexPosition1();
for (int i = 0; i < ${e}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(i)};
`),i.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",i=>{const e=this.rank;this.defineShader(i),Xd(i,this.targetIsSliceView),i.addVarying("highp float","vClipCoefficient"),i.addVarying("highp vec4","vBorderColor"),ST(i),i.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${Cy};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),i.setVertexMain(`
float modelPosition[${e}] = getVertexPosition0();
float modelPositionB[${e}] = getVertexPosition1();
for (int i = 0; i < ${e}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(i,"uint(getEndpointIndex()) + 1u")};
`),i.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(i){Wr(i);const e=this.rank;Ud(i,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",e,2)}enable(i,e,t){super.enable(i,e,n=>{const r=n.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),r.bind(this.geometryDataStride,e.bufferOffset);const s=this.vertexIdHelper;s.enable(),t(n),s.disable(),r.disable()})}drawEdges(i){this.enable(this.edgeShaderGetter,i,e=>{fr(e,i.renderContext.projectionParameters,1),pr(e.gl,1,i.count)})}drawEndpoints(i){this.enable(this.endpointShaderGetter,i,e=>{Qd(e,i.renderContext.projectionParameters,{featherWidthInPixels:.5}),ec(e.gl,2,i.count)})}draw(i){this.drawEdges(i),this.drawEndpoints(i)}};function v$(i,e){const t=i.length;Z1(i,e.subarray(0,t),e.subarray(t),i)}function y$(i,e,t){const n=i.length,r=n*t;for(let s=0;s<n;++s)i[s]=e[r+s]}$d(Me.LINE,{sliceViewRenderHelper:bx,perspectiveViewRenderHelper:bx,defineShaderNoOpSetters(i){bT(i),ST(i)},pickIdsPerInstance:m$,snapPosition(i,e,t,n){const r=i.length,s=new Float32Array(e,t,r*2);n===ao?v$(i,s):y$(i,s,n-Tm)},getRepresentativePoint(i,e,t){i.set(t===ao||t===Tm?e.pointA:e.pointB)},updateViaRepresentativePoint(i,e,t){let n=j({},i);const r=e.length;switch(t){case ao:{const s=i.pointA,o=i.pointB,l=new Float32Array(r),c=new Float32Array(r);for(let u=0;u<r;++u){const f=l[u]=e[u];c[u]=o[u]+(f-s[u])}return j(j({},i),{pointA:l,pointB:c})}case ao+1:return j(j({},i),{pointA:new Float32Array(e)});case ao+2:return j(j({},i),{pointB:new Float32Array(e)})}return n}});let Sx=class extends Wd{constructor(){super(...arguments),this.shaderGetter3d=this.getDependentShader("annotation/point:3d",i=>{Wr(i),Xd(i,this.targetIsSliceView),this.defineShaderCommon(i),i.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),i.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)}),this.makeShaderGetter2d=i=>this.getDependentShader(`annotation/point:2d:${i}`,e=>{Wr(e),hr(e,!0),this.defineShaderCommon(e),e.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${i}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${i}] = minZ;
subspacePositionB[${i}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)}),this.shaderGetter2d=this.makeShaderGetter2d(2),this.shaderGetter1d=this.makeShaderGetter2d(1),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl))}defineShaderCommon(i){const e=this.rank;Ud(i,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",e),i.addVarying("highp vec4","vBorderColor"),i.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),i.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${e}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(i)};
`)}enable(i,e,t){super.enable(i,e,n=>{const r=n.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),r.bind(this.geometryDataStride,e.bufferOffset);const s=this.vertexIdHelper;s.enable(),t(n),s.disable(),r.disable()})}draw(i){const e=i.chunkDisplayTransform.numChunkDisplayDims;switch(e){case 3:this.enable(this.shaderGetter3d,i,t=>{Qd(t,i.renderContext.projectionParameters,{featherWidthInPixels:1}),ec(t.gl,1,i.count)});break;case 2:case 1:this.enable(e===2?this.shaderGetter2d:this.shaderGetter1d,i,t=>{fr(t,i.renderContext.projectionParameters,1),pr(t.gl,1,i.count)});break}}};$d(Me.POINT,{sliceViewRenderHelper:Sx,perspectiveViewRenderHelper:Sx,defineShaderNoOpSetters(i){i.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(i,e,t){i.set(new Float32Array(e,t,i.length))},getRepresentativePoint(i,e){i.set(e.point)},updateViaRepresentativePoint(i,e){return j(j({},i),{point:new Float32Array(e)})}});/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wT=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,b$=[wT,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`],S$=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,w$=[wT,S$,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`],wx=Qe();let CT=class extends Wd{defineShader(i){const e=this.rank;Ud(i,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",e,2),i.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${e}] = getCenterAndRadii0();
  highp float modelRadii[${e}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${e}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${e}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(i,e,t){super.enable(i,e,n=>{const r=n.vertexShaderInputBinders.CenterAndRadii;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),r.bind(this.geometryDataStride,e.bufferOffset),t(n),r.disable()})}};class C$ extends CT{constructor(){super(...arguments),this.sphereRenderHelper=this.registerDisposer(new Yk(this.gl,10,10)),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)}),this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{const n=t.gl;let r=this.tempLightVec;var s=e.renderContext;let o=s.lightDirection,l=s.ambientLighting,c=s.directionalLighting;vv(r,o,c),r[3]=l,n.uniform4fv(t.uniform("uLightDirection"),r),n.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,mv(Qe(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class x$ extends CT{constructor(){super(...arguments),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Wr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(b$),e.addVertexCode(w$),e.addVertexCode(Sy),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)}),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{const n=t.gl,r=e.renderContext.sliceView.projectionParameters.value,s=fi(wx,e.renderSubspaceInvModelMatrix,r.invViewMatrix);n.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,s),n.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,r.projectionMat);const o=wx;Cs(o,s),n.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);const l=this.vertexIdHelper;l.enable(),wy(n,1,e.count),l.disable()})}}$d(Me.ELLIPSOID,{sliceViewRenderHelper:x$,perspectiveViewRenderHelper:C$,defineShaderNoOpSetters(i){i.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(i,e){i.set(e.center)},updateViaRepresentativePoint(i,e){return j(j({},i),{center:new Float32Array(e)})}});const oo=0,Dm=oo+1,E$=Dm+2;function Pm(i){i.addVertexCode(`
 void setAxisEndpointMarkerSize(float startSize, float endSize) {}
 void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {}
 void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
 void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
 `)}function Am(i){i.addVertexCode(`
 void setAxisWidth(float width) {}
 void setAxisColor(vec4 startColor, vec4 endColor) {}
 `)}function Mm(i){i.addVertexCode(`
 void setSphereColor(vec4 color) {}
 `)}class Cx extends Wd{constructor(){super(...arguments),this.sphereShader=this.registerDisposer(new vU(this.gl)),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/sphere/axis",e=>{const t=this.rank;this.defineShader(e),hr(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),Pm(e),Mm(e),e.addVertexCode(`
void setAxisWidth(float width) {
  ng_LineWidth = width;
}
void setAxisColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/sphere/endpoint",e=>{const t=this.rank;this.defineShader(e),Xd(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),Am(e),Mm(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${Cy};
}
void setAxisEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)}),this.sphereShadeGetter=this.getDependentShader("annotation/sphere/sphere",e=>{const t=this.rank;this.defineShader(e),this.sphereShader.defineShader(e),e.addVarying("highp float","vClipCoefficient"),Am(e),Pm(e),e.addVertexCode(`
 void setSphereColor(vec4 color) {
   vColor = color;
 }
 `),e.setVertexMain(`
 float modelPosition[${t}] = getVertexPosition0();
 float modelPositionB[${t}] = getVertexPosition1();
 float diameter = 0.0;
 for (int i = 0; i < ${t}; ++i) {
   float dx = modelPosition[i] - modelPositionB[i];
   diameter += dx * dx;
   modelPosition[i] = (modelPosition[i] + modelPositionB[i]) * 0.5;
 }
 float radius = sqrt(diameter) * 0.5;
 if (radius > 0.0) {
   vClipCoefficient = getRadiusAdjustment(vec3(modelPosition[0], modelPosition[1], modelPosition[2]), radius);
 } else {
   vClipCoefficient = 1.0;
 }

 // vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
 vColor = vec4(1.0, 0.0, 0.0, 0.5);
 // vColor = vec4(defaultColor(), 0.5);
 ${this.invokeUserMain}
 // float radius = diameter * 0.5;
 emitSphere(uModelViewProjection, uNormalTransform, projectModelVectorToSubspace(modelPosition), vec3(radius, radius, radius), uLightDirection);
 ${this.setPartIndex(e)};
 `),e.setFragmentMain(`
     vec4 color = vColor;
     color.a *= vClipCoefficient;
     emitAnnotation(color);
 `)})}defineShader(e){Wr(e);const t=this.rank;Ud(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,n,r=!0){super.enable(e,t,s=>{const o=s.vertexShaderInputBinders.VertexPosition;o.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.serializedBytesPerAnnotation,t.bufferOffset);const l=this.vertexIdHelper;r&&l.enable(),n(s),r&&l.disable(),o.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{fr(t,e.renderContext.projectionParameters,1),pr(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Qd(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),ec(t.gl,2,e.count)})}drawSphere(e){this.enable(this.sphereShadeGetter,e,t=>{this.sphereShader.draw(t,e,e.count)},!1)}draw(e){this.drawEdges(e),this.drawEndpoints(e),this.drawSphere(e)}}function L$(i,e){const t=i.length;Z1(i,e.subarray(0,t),e.subarray(t),i)}function k$(i,e,t){const n=i.length,r=n*t;for(let s=0;s<n;++s)i[s]=e[r+s]}$d(Me.SPHERE,{sliceViewRenderHelper:Cx,perspectiveViewRenderHelper:Cx,defineShaderNoOpSetters(i){Pm(i),Am(i),Mm(i)},pickIdsPerInstance:E$,snapPosition(i,e,t,n){const r=i.length,s=new Float32Array(e,t,r*2);n===oo?L$(i,s):k$(i,s,n-Dm)},getRepresentativePoint(i,e,t){i.set(t===oo||t===Dm?e.pointA:e.pointB)},updateViaRepresentativePoint(i,e,t){let n=j({},i);const r=e.length;switch(t){case oo:{const s=i.pointA,o=i.pointB,l=new Float32Array(r),c=new Float32Array(r);for(let u=0;u<r;++u){const f=l[u]=e[u];c[u]=o[u]+(f-s[u])}return j(j({},i),{pointA:l,pointB:c})}case oo+1:return j(j({},i),{pointA:new Float32Array(e)});case oo+2:return j(j({},i),{pointB:new Float32Array(e)})}return n}});/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xT=Qe(),ET=Ne();function LT(i){i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}const I$={defineShader(i){LT(i),hr(i),i.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),i.setVertexMain(`
int edgeIndex = gl_VertexID / ${bs};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){fr(i,e,1)},draw(i,e,t){const n=i.gl,r=xT,s=e.chunkLayout;fi(r,t.viewProjectionMat,s.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,r),n.uniform3fv(i.uniform("uChunkDataSize"),s.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const o=s.size,l=e.curPositionInChunks,c=e.chunkDisplayDimensionIndices,u=ET;for(let f=0;f<3;++f){const g=c[f];u[f]=(g===-1?0:l[g])*o[f]}n.uniform3fv(i.uniform("uTranslation"),u),pr(n,Uy,1)}},T$={defineShader(i){ih(i),LT(i),hr(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${bs};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){fr(i,e,1)},draw(i,e,t){const n=i.gl,r=xT,s=e.chunkLayout;fi(r,t.viewProjectionMat,s.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,r),n.uniform3fv(i.uniform("uChunkDataSize"),s.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const o=s.size,l=e.curPositionInChunks,c=e.chunkDisplayDimensionIndices,u=ET;for(let f=0;f<3;++f){const g=c[f];u[f]=(g===-1?0:l[g])*o[f]}n.uniform3fv(i.uniform("uTranslation"),u),Fy(i,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,s.transform,s.invTransform),pr(n,6,1)}};/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var D$=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s};const P$=Qe();function A$(i){if(i!==void 0)return e=>{const t=e.relatedSegments;if(t===void 0)return!1;for(let r=0,s=t.length;r<s;++r){const o=i[r];if(o==null)continue;var n=o.segmentationGroupState.value;const l=n.visibleSegments,c=n.segmentEquivalences;for(const u of t[r])if(l.has(c.get(u)))return!0}return!1}}function M$(i,e){const t=new mV(i.annotationPropertySerializers);for(const n of i)(e===void 0||e(n))&&t.add(n);return t.serialize()}let Rm=class extends Vh(jd){constructor(i,e,t,n){super(n),this.chunkManager=i,this.source=e,this.segmentationStates=t,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:e.rpcId,segmentationStates:this.serializeDisplayState()});const r=()=>{const s={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(R_,s)};this.registerDisposer(t.changed.add(r))}serializeDisplayState(){const i=this.segmentationStates.value;if(i!==void 0)return i.map(e=>e==null?e:yy(e.segmentationGroupState.value))}};Rm=D$([Ln(M_)],Rm);class R$ extends K{constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new Ov,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new xe,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.segmentationStates=this.registerDisposer(wn(r=>{var s=this.state;const o=s.displayState,l=s.source,c=o.relationshipStates;return o.displayUnfiltered.value?void 0:l.relationships.map(u=>{const f=c.get(u);return f.showMatches.value?f.segmentationState.value:void 0})},[this.state.displayState.relationshipStates],(r,s)=>r===void 0||s===void 0?r===s:_e(r,s))),this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Fr((r,s)=>{if(this.handleChangeAffectingBuffer(),s!==void 0)for(const o of s)o!=null&&r.registerDisposer(Co((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof xo||(this.sharedObject=this.registerDisposer(new Rm(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));const n=this.state.displayState;this.registerDisposer(n.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){const e=this.sharedObject;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){const e=this.source;if(e instanceof xo){const t=e.changed.count;if(this.generation!==t){let n=this.buffer;n===void 0&&(n=this.buffer=this.registerDisposer(new Ki(this.chunkManager.gl))),this.generation=t;const r=this.serializedAnnotations=M$(e,A$(this.segmentationStates.value));n.setData(this.serializedAnnotations.data),this.numPickIds=YL(r)}}}}function kT(i){const e=i.chunkTransform.modelTransform.unpaddedRank,t=new Float32Array(e*2),n=new Float32Array(e*3);n.fill(0),t.fill(1,e);const r=i.numChunkDisplayDims,s=i.chunkDisplayDimensionIndices;for(let o=0;o<r;++o){const l=s[o];t[e+l]=0,n[l*3+o]=1}return{modelClipBounds:t,renderSubspaceTransform:n}}function xx(i,e,t){t.clearMessages();const n=u=>{t.addMessage({severity:lr.error,message:u})};if(i.error!==void 0)return n(i.error);const r=zE(i.modelTransform,e.displayDimensionIndices);let s;try{s=GE(i,r)}catch(u){return n(u.message)}var o=kT(s);const l=o.modelClipBounds,c=o.renderSubspaceTransform;return{chunkTransform:i,chunkDisplayTransform:s,modelClipBounds:l,renderSubspaceTransform:c}}function Gy(i,e){class t extends i{constructor(r,s){super(),this.base=r,this.renderScaleHistogram=s,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;const o=r.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(const l of this.renderHelpers)l.dispose()}),this.role=r.state.role,this.registerDisposer(r.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){const r=this.base.source.rank;if(r===this.curRank)return;this.curRank=r,this.tempChunkPosition=new Float32Array(r);const s=this.renderHelpers,o=this.gl;for(const u of s)u.dispose();const l=this.base.source.properties,c=this.base.state.displayState;for(const u of Br){const f=sd(u),g=f[e],v=s[u]=new g(o,u,r,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);v.pickIdsPerInstance=f.pickIdsPerInstance,v.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(r){super.attach(r),this.handleRankChanged();const s=this.chunkTransform,o=r.view.displayDimensionRenderInfo.value;r.state={chunkTransform:s,displayDimensionRenderInfo:o,chunkRenderParameters:xx(s,o,r.messages)}}updateAttachmentState(r){const s=r.state;this.handleRankChanged();const o=this.chunkTransform,l=r.view.displayDimensionRenderInfo.value;return s!==void 0&&s.chunkTransform===o&&s.displayDimensionRenderInfo===l?s.chunkRenderParameters:(s.chunkTransform=o,s.displayDimensionRenderInfo=l,s.chunkRenderParameters=xx(o,l,r.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(r,s){const o=s.modelClipBounds,l=this.curRank,c=s.chunkTransform;gd(o.subarray(0,l),r.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(r,s,o,l=1){if(!r.bufferValid){let c=r.buffer;c===void 0&&(c=r.buffer=new Ki(this.gl));const u=r.serializedAnnotations;c.setData(u.data),r.numPickIds=YL(u),r.bufferValid=!0}this.drawGeometry(r,s,o,l)}drawGeometry(r,s,o,l=1){const c=this.base,u=o.chunkDisplayTransform,f=r.serializedAnnotations,g=f.typeToIdMaps,v=f.typeToOffset;let y=0;s.emitPickID&&(y=s.pickIDs.register(this,r.numPickIds,0,0,r));const C=c.hoverState.value,w=fi(P$,s.projectionParameters.viewProjectionMat,u.displaySubspaceModelMatrix),S={annotationLayer:c,renderContext:s,selectedIndex:0,basePickId:y,buffer:r.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:w,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:u.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:u.displaySubspaceInvModelMatrix,chunkDisplayTransform:u};for(const L of Br){const I=g[L];let M=I.size;if(M>0){const R=sd(L);let D=4294967295;if(C!==void 0){const T=I.get(C.id);T!==void 0&&(D=T*R.pickIdsPerInstance)}M=Math.round(M*l),S.count=M,S.bufferOffset=v[L],S.selectedIndex=D,this.renderHelpers[L].draw(S),S.basePickId+=M*R.pickIdsPerInstance}}}updateMouseState(r,s,o,l){const c=l.serializedAnnotations,u=c.typeToIds,f=c.typeToOffset,g=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(const y of Br){const C=u[y],w=sd(y),S=w.pickIdsPerInstance;if(o<C.length*S){const L=Math.floor(o/S),I=C[L],M=o%S;r.pickedAnnotationId=I,r.pickedAnnotationLayer=this.base.state,r.pickedOffset=M,r.pickedAnnotationBuffer=c.data.buffer,r.pickedAnnotationType=y,r.pickedAnnotationBufferBaseOffset=c.data.byteOffset+f[y],r.pickedAnnotationIndex=L,r.pickedAnnotationCount=C.length;const R=this.tempChunkPosition,D=v.chunkToLayerTransform,T=v.combinedGlobalLocalToChunkTransform,A=v.layerRank,V=v.modelTransform.globalToRenderLayerDimensions,O=r.position;if(!gd(R,O,this.base.state.localPosition.value,A,T))return;const _=this.base.source.annotationPropertySerializers[y];w.snapPosition(R,r.pickedAnnotationBuffer,r.pickedAnnotationBufferBaseOffset+r.pickedAnnotationIndex*_.propertyGroupBytes[0],M);const H=V.length;for(let U=0;U<H;++U){const B=V[U];if(B===-1)continue;let W=D[(g+1)*g+B];for(let F=0;F<g;++F)W+=R[F]*D[F*(A+1)+B];kt(W)&&(O[U]=W)}return}o-=C.length*S}}transformPickedValue(r){const s=r.pickedAnnotationBuffer;if(s===void 0)return;const o=this.base.source.properties;if(o.length===0)return;const l=r.pickedAnnotationBufferBaseOffset,c=r.pickedAnnotationType,u=r.pickedAnnotationIndex,f=r.pickedAnnotationCount,g=this.base.source.annotationPropertySerializers,v=new Array(o.length);return g[c].deserialize(new DataView(s),l,u,f,an.LITTLE===Vd,v),rV(o[0],v[0])}isReady(){const r=this.base.source;if(!(r instanceof Un))return!0;const s=this.base.segmentationStates.value;if(s===void 0)return!0;for(let o=0,l=s.length;o<l;++o){const c=s[o];if(c===null)return!1;if(c===void 0)continue;const u=r.segmentFilteredSources[o].chunks;let f=!1;if(Ko(c.segmentationGroupState.value,g=>{const v=rr(g);u.has(v)||(f=!0)}),f)return!1}return!0}}return t}const IT=i=>class extends i{constructor(){super(...arguments),this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(e,t){const n=this.updateAttachmentState(t);if(this.curRank===0||n===void 0)return;this.updateModelClipBounds(e,n);const r=this.base.source;if(r instanceof xo){const s=this.base;s.updateBuffer(),this.drawGeometry(s,e,n)}else{const s=this.renderScaleHistogram;s.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(r.temporary.data,e,n);const o=this.base.segmentationStates.value;let l=0,c=0;if(o!==void 0)for(let u=0,f=o.length;u<f;++u){const g=o[u];if(g==null)continue;const v=r.segmentFilteredSources[u].chunks;Ko(g.segmentationGroupState.value,y=>{const C=rr(y),w=v.get(C);if(w!==void 0&&w.state===Et.GPU_MEMORY){const S=w.data;if(S===void 0)return;this.drawGeometryChunkData(S,e,n),++l}else++c})}s.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,l,c)}}},TT=Gy(el,"perspectiveViewRenderHelper");class N$ extends IT(TT){}const DT=i=>{class e extends i{constructor(n){super(n.annotationLayer,n.renderScaleHistogram),this.wireFrameRenderHelper=this instanceof Ro?T$:I$,this.wireFrameShaderGetter=Io(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof Ro}`,parameters:aa(void 0),defineShader:o=>{this.wireFrameRenderHelper.defineShader(o)}}),this.renderScaleTarget=n.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));const r=this.registerDisposer(new jd(this.layerChunkProgressInfo)),s=this.base.chunkManager.rpc;r.RPC_TYPE_ID=P_,r.initializeCounterpart(s,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(Di.makeFromExisting(s,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Di.makeFromExisting(s,this.renderScaleTarget)).rpcId}),this.backend=r}attach(n){super.attach(n),n.state.sources=n.registerDisposer(Fr((r,s,o)=>{const l=ry(o,s,c=>this.base.state.source.getSources(c),n.messages,this);for(const c of l)for(const u of c)r.registerDisposer(u.source),j(u,kT(u.chunkDisplayTransform));return n.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(A_,{layer:this.backend.rpcId,view:n.view.rpcId,displayDimensionRenderInfo:o,sources:ny(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,n.view.displayDimensionRenderInfo))}draw(n,r){const s=this.updateAttachmentState(r);if(this.curRank===0||s===void 0)return;const o=r.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(n,s);const l=this.renderScaleHistogram;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const c=n.projectionParameters;let u;if(n.wireFrame){var f=this.wireFrameShaderGetter(n.emitter);const g=f.shader;if(g===null)return;g.bind(),this.wireFrameRenderHelper.initialize(g,c),u=g}V_(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(g,v,y,C,w)=>{const S=g.source.chunks.get(g.curPositionInChunks.join());let L;if(S===void 0||S.state!==Et.GPU_MEMORY)L=0;else{const I=S.data;if(I===void 0)return;u!==void 0?this.wireFrameRenderHelper.draw(u,g,c):this.drawGeometryChunkData(I,n,s,y),L=1}l.add(C,w,L,1-L)})}}return e},V$=DT(TT),O$=DT(Gy(Ro,"sliceViewRenderHelper")),B$=IT(Gy(Ro,"sliceViewRenderHelper"));class _$ extends K{constructor(){super(...arguments),this.changed=new xe,this.isLoadingChanged=new xe,this.states=[],this.relationships=[],this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount===0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let n=e.sourceIndex-t.sourceIndex;return n!==0?n:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){const e=new je;for(const t of this.states)for(const n of t.source.relationships)e.add(n);this.relationships=Te(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{const t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function F$(i,e){switch(e.type){case Me.AXIS_ALIGNED_BOUNDING_BOX:case Me.LINE:case Me.SPHERE:LE(i,e.pointA,e.pointB),kV(i,i,.5);break;case Me.POINT:i.set(e.point);break;case Me.ELLIPSOID:i.set(e.center);break}}function PT(i,e,t){e.error===void 0&&i.setLayerPosition(e.modelTransform,t)}function AT(i,e,t){const n=e.layerRank,r=new Float32Array(n);Ui[i.type].visitGeometry(i,(s,o)=>{r.set(s);const l=new Float32Array(n);(o?wE:Nr)(l,e.chunkToLayerTransform,n+1,r,n),t(l,o)})}class U$ extends qr{constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:y=>this.render(y),changed:new at},this.virtualList=new xy({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new ue,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.selectedAnnotationState=nr((y,C)=>{var w;if(y===void 0)return;const S=this.layer,L=(w=y.layers.find(R=>R.layer===S))===null||w===void 0?void 0:w.state;if(L===void 0)return;const I=L.annotationId;if(I===void 0)return;const M=this.annotationStates.states.find(R=>R.sourceIndex===L.annotationSourceIndex&&(L.annotationSubsource===void 0||R.subsourceId===L.annotationSubsource));if(M!==void 0)return{annotationId:I,annotationLayerState:M,pin:C}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin),this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(e.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");const n=document.createElement("div");n.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);const r=this.registerDisposer(new Ay(this.displayState.color));r.element.title="Change annotation display color",this.registerDisposer(new pn(nr(y=>y.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),r.element)),n.appendChild(r.element);const s=this.mutableControls,o=Lt({text:Ui[Me.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new _T(this.layer,{})}});s.appendChild(o);const l=Lt({text:Ui[Me.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new $y(this.layer,{})}});s.appendChild(l);const c=Lt({text:Ui[Me.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new jy(this.layer,{})}});s.appendChild(c);const u=Lt({text:Ui[Me.SPHERE].icon,title:"Annotate Sphere",onClick:()=>{this.layer.tool.value=new Hy(this.layer,{})}});s.appendChild(u);const f=Lt({text:Ui[Me.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new UT(this.layer,{})}});s.appendChild(f),n.appendChild(s),this.element.appendChild(n),this.element.appendChild(this.headerRow);const g=this.virtualList;g.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(g.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});const v=VF();this.registerDisposer(new Zr(this.virtualList.element,v)),this.virtualList.element.title=v.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){const e=this.annotationStates.states,t=this.attachedAnnotationStates,n=new ue;for(const s of t){var r=oe(s,2);const o=r[0],l=r[1];e.includes(o)||(t.delete(o),l.refCounted.dispose())}for(const s of e){const o=t.get(s);if(o!==void 0){n.set(s,o);continue}const l=s.source,c=new K;(l instanceof xo||l instanceof Un)&&(c.registerDisposer(l.childAdded.add(u=>this.addAnnotationElement(u,s))),c.registerDisposer(l.childUpdated.add(u=>this.updateAnnotationElement(u,s))),c.registerDisposer(l.childDeleted.add(u=>this.deleteAnnotationElement(u,s))),c.registerDisposer(l.childRefreshed.add(()=>this.clearAnnotationElement(s)))),c.registerDisposer(s.transform.changed.add(this.forceUpdateView)),n.set(s,{refCounted:c,annotations:[],idToIndex:new ue,listOffset:0})}this.attachedAnnotationStates=n,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){const e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,n=[],r=[];for(let s=0,o=t.rank;s<o;++s)this.annotationStates.states.some(l=>{const c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[s]!==-1})&&n.push(s);for(let s=0,o=e.rank;s<o;++s)this.annotationStates.states.some(l=>{const c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[s]!==-1})&&r.push(s);(!_e(n,this.globalDimensionIndices)||!_e(r,this.localDimensionIndices))&&(this.localDimensionIndices=r,this.globalDimensionIndices=n,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,n=!1){const r=this.attachedAnnotationStates.get(e);if(r==null)return;const s=r.idToIndex.get(t);if(s===void 0)return;const o=r.listOffset+s;return n&&this.virtualList.scrollItemIntoView(s),this.virtualList.getItemElement(o)}clearSelectionClass(){const e=this.previousSelectedState;if(e===void 0)return;this.previousSelectedState=void 0;const t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){const e=this.previousHoverId,t=this.previousHoverAnnotationLayerState;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;const n=this.getRenderedAnnotationListElement(t,e);n!==void 0&&n.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){const e=this.selectedAnnotationState.value,t=this.previousSelectedState;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;const n=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);n!==void 0&&n.classList.add("neuroglancer-annotation-selected")}updateHoverView(){const e=this.displayState.hoverState.value;let t,n;e!==void 0&&(t=e.id,n=e.annotationLayerState);const r=this.previousHoverId,s=this.previousHoverAnnotationLayerState;if(t===r&&n===s||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=n,t===void 0))return;const o=this.getRenderedAnnotationListElement(n,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){var t=this.listElements[e];const n=t.annotation,r=t.state;return this.makeAnnotationListElement(n,r)}setColumnWidth(e,t){t+=2;const n=this.columnWidths;n[e]>t||(n[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;const s=this.columnWidths;s.length=0;const o=this.headerRow,l=document.createElement("div");l.style.gridColumn="symbol";const c=document.createElement("div");c.style.gridColumn="delete",nt(o),o.appendChild(l);let u=0,f="[symbol] 2ch";const g=(C,w)=>{const S=document.createElement("div");S.classList.add("neuroglancer-annotations-view-dimension");const L=document.createElement("span");L.classList.add("neuroglancer-annotations-view-dimension-name"),L.textContent=C.names[w];const I=document.createElement("scale");I.classList.add("neuroglancer-annotations-view-dimension-scale"),I.textContent=la(C.scales[w],C.units[w],{precision:2}),S.appendChild(L),S.appendChild(I),S.style.gridColumn=`dim ${u+1}`,this.setColumnWidth(u,I.textContent.length+L.textContent.length+3),f+=` [dim] var(--neuroglancer-column-${u}-width)`,++u,o.appendChild(S)},v=this.layer.manager.root.coordinateSpace.value;for(const C of this.globalDimensionIndices)g(v,C);const y=this.layer.localCoordinateSpace.value;for(const C of this.localDimensionIndices)g(y,C);o.appendChild(c),f+=" [delete] 2ch",this.gridTemplate=f,o.style.gridTemplateColumns=f,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1;const t=this.listElements;t.length=0;for(const s of this.attachedAnnotationStates){var n=oe(s,2);const o=n[0],l=n[1];if(o.source.readonly||(e=!0),o.chunkTransform.value.error!==void 0)continue;const c=o.source,u=Te(c);l.annotations=u;const f=l.idToIndex;f.clear();for(let g=0,v=u.length;g<v;++g)f.set(u[g].id,g);for(const g of u)t.push({state:o,annotation:g})}const r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(const t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}clearAnnotationElement(e){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const t=this.attachedAnnotationStates.get(e);if(t!==void 0){const n=t.annotations.length;t.annotations=[],t.idToIndex.clear(),this.listElements=[],this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:n,insertCount:0}])}this.resetOnUpdate()}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const r=n.annotations.length;n.annotations.push(e),n.idToIndex.set(e.id,r);const s=n.listOffset+r;this.listElements.splice(s,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:s,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const r=n.idToIndex.get(e.id);if(r!==void 0){const s=n.listOffset+r;n.annotations[r]=e,this.listElements[s].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:s,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const r=n.idToIndex,s=r.get(e);if(s!==void 0){const o=n.listOffset+s,l=n.annotations;l.splice(s,1),r.delete(e);for(let c=s,u=l.length;c<u;++c)r.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){const n=t.chunkTransform.value,r=document.createElement("div");r.classList.add("neuroglancer-annotation-list-entry"),r.style.gridTemplateColumns=this.gridTemplate;const s=document.createElement("div");s.className="neuroglancer-annotation-icon",s.textContent=Ui[e.type].icon,r.appendChild(s);let o;const l=()=>{t.source.readonly||o===void 0&&(o=Ss({title:"Delete annotation",onClick:f=>{f.stopPropagation(),f.preventDefault();const g=t.source.getReference(e.id);try{t.source.delete(g)}finally{g.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),r.appendChild(o))};let c=0;if(AT(e,n,(f,g)=>{++c;const v=document.createElement("div");v.className="neuroglancer-annotation-position",r.appendChild(v);let y=0;const C=(w,S)=>{for(const L of w){const I=S[L];if(I!==-1){const M=Math.floor(f[I]),R=document.createElement("div"),D=M.toString();R.textContent=D,R.classList.add("neuroglancer-annotation-coordinate"),R.style.gridColumn=`dim ${y+1}`,this.setColumnWidth(y,D.length),v.appendChild(R)}++y}};C(this.globalDimensionIndices,n.modelTransform.globalToRenderLayerDimensions),C(this.localDimensionIndices,n.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;const f=document.createElement("div");f.classList.add("neuroglancer-annotation-description"),f.textContent=e.description,r.appendChild(f)}s.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),r.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),r.addEventListener("action:select-position",f=>{f.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),r.addEventListener("action:pin-annotation",f=>{f.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),r.addEventListener("action:move-to-annotation",f=>{f.stopPropagation(),f.preventDefault();const g=n.layerRank,v=new Float32Array(g),y=new Float32Array(g);F$(v,e),Nr(y,n.chunkToLayerTransform,g+1,v,g),PT(this.layer,n,y)});const u=this.selectedAnnotationState.value;return u!==void 0&&u.annotationLayerState===t&&u.annotationId===e.id&&r.classList.add("neuroglancer-annotation-selected"),r}}class z$ extends qr{constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new U$(this.layer,this.layer.annotationDisplayState));const t=this.element;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function $o(i){let e=[];const t=i.source.relationships,n=i.displayState.relationshipStates;for(let r=0,s=t.length;r<s;++r){const o=n.get(t[r]).segmentationState.value;if(o!=null&&o.segmentSelectionState.hasSelectedSegment){e[r]=[o.segmentSelectionState.selectedSegment.clone()];continue}e[r]=[]}return e}class MT extends aI{constructor(e,t){super(e)}get annotationLayer(){for(const e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}const RT="annotatePoint",NT="annotateLine",VT="annotateBoundingBox",OT="annotateEllipsoid",BT="annotateSphere";class _T extends MT{constructor(){super(...arguments),this.sourceSignalUpdated=!1}trigger(e){const t=this.annotationLayer;if(t!==void 0&&e.updateUnconditionally()){const n=Ad(e,t);if(n===void 0)return;const r={id:"",description:"",relatedSegments:$o(t),point:n,type:Me.POINT,properties:t.source.properties.map(o=>o.default)},s=t.source.add(r,!0);t.source instanceof Un?this.sourceSignalUpdated||(t.source.childAdded.add(o=>{o.source===void 0&&this.layer.selectAnnotation(t,o.id,!0,!ws.expectingExternalUI)}),this.sourceSignalUpdated=!0):this.layer.selectAnnotation(t,s.id,!0),s.dispose()}}get description(){return"annotate point"}toJSON(){return RT}}function Ad(i,e){const t=e.chunkTransform.value;if(t.error!==void 0)return;const n=new Float32Array(t.modelTransform.unpaddedRank);if(gd(n,i.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return n}class FT extends MT{trigger(e){const t=this.annotationLayer;if(t!==void 0&&e.updateUnconditionally()){const n=()=>{const r=this.inProgressAnnotation,s=r.reference,o=this.getUpdatedAnnotation(s.value,e,t);se(Vg(o,t.source))!==se(Vg(s.value,t.source))&&(r.annotationLayer.source.update(s,o),this.layer.selectAnnotation(t,s.id,!0,!ws.expectingExternalUI))};if(this.inProgressAnnotation===void 0){const r=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,r.id,!0,!ws.expectingExternalUI);const s=e.changed.add(n),o=()=>{s(),r.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:r,disposer:o}}else n(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}}class Wy extends FT{getInitialAnnotation(e,t){const n=Ad(e,t);return{id:"",type:this.annotationType,description:"",pointA:n,pointB:n,properties:t.source.properties.map(r=>r.default)}}getUpdatedAnnotation(e,t,n){const r=Ad(t,n);return r===void 0?e:j(j({},e),{pointB:r})}}class $y extends Wy{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,n){const r=super.getUpdatedAnnotation(e,t,n),s=r.pointA,o=r.pointB,l=s.length;for(let c=0;c<l;++c)s[c]===o[c]&&(o[c]+=1);return r}toJSON(){return VT}}$y.prototype.annotationType=Me.AXIS_ALIGNED_BOUNDING_BOX;class jy extends Wy{get description(){return"annotate line"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=$o(t),n}getUpdatedAnnotation(e,t,n){const r=super.getUpdatedAnnotation(e,t,n),s=this.initialRelationships,o=$o(n);return s===void 0?r.relatedSegments=o:r.relatedSegments=Te(o,(l,c)=>{const u=s[c];return l=l.filter(f=>u.findIndex(g=>re.equal(f,g))===-1),[...u,...l]}),r}toJSON(){return NT}}jy.prototype.annotationType=Me.LINE;class Hy extends Wy{get description(){return"annotate sphere"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=$o(t),n}getUpdatedAnnotation(e,t,n){const r=super.getUpdatedAnnotation(e,t,n),s=this.initialRelationships,o=$o(n);return s===void 0?r.relatedSegments=o:r.relatedSegments=Te(o,(l,c)=>{const u=s[c];return l=l.filter(f=>u.findIndex(g=>re.equal(f,g))===-1),[...u,...l]}),r}toJSON(){return BT}}Hy.prototype.annotationType=Me.SPHERE;class UT extends FT{getInitialAnnotation(e,t){const n=Ad(e,t);return{type:Me.ELLIPSOID,id:"",description:"",segments:$o(t),center:n,radii:bt(0,0,0),properties:t.source.properties.map(r=>r.default)}}getUpdatedAnnotation(e,t,n){const r=Ad(t,n);if(r===void 0)return e;const s=e.center,o=s.length;for(let l=0;l<o;++l)r[l]=Math.abs(s[l]-r[l]);return j(j({},e),{radii:r})}get description(){return"annotate ellipsoid"}toJSON(){return OT}}ic(RT,(i,e)=>new _T(i,e));ic(VT,(i,e)=>new $y(i,e));ic(NT,(i,e)=>new jy(i,e));ic(OT,(i,e)=>new UT(i,e));ic(BT,(i,e)=>new Hy(i,e));const G$=vt.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function W$(i,e,t,n){return new cr(t,(r,s,o)=>{const l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),r!=null&&o.registerDisposer(_o(r,l));const c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");const u=dr({title:"Copy segment IDs",onClick:()=>{on(e.map(C=>C.toString()).join(", "))}});c.appendChild(u);let f;if(r!=null&&(f=document.createElement("input"),f.type="checkbox",f.addEventListener("change",()=>{const C=r.segmentationGroupState.value.visibleSegments,w=e.some(S=>!C.has(S));for(const S of e)C.set(S,w)}),c.appendChild(f)),n!==void 0){const C=Ss({title:"Remove all IDs",onClick:()=>{n([])}});c.appendChild(C)}const g=document.createElement("span");if(g.classList.add("neuroglancer-related-segment-list-title"),g.textContent=i,c.appendChild(g),n!==void 0){const C=iI({title:"Add related segment ID",onClick:()=>{const w=new K,S=o.registerDisposer(M1(w)),L=document.createElement("div");L.classList.add("neuroglancer-segment-list-entry"),L.classList.add("neuroglancer-segment-list-entry-new");const I=dr({});if(I.classList.add("neuroglancer-segment-list-entry-copy"),L.appendChild(I),r!=null){const A=document.createElement("input");A.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),A.type="checkbox",L.appendChild(A)}const M=Ss({title:"Cancel adding new segment ID",onClick:()=>{S()}});M.classList.add("neuroglancer-segment-list-entry-delete"),L.appendChild(M);const R=document.createElement("input");R.autocomplete="off",R.spellcheck=!1,R.classList.add("neuroglancer-segment-list-entry-id");const D=w.registerDisposer(new $n(R,G$));D.allShortcutsAreGlobal=!0;const T=()=>{const A=new re;if(A.tryParseString(R.value))return R.dataset.valid="true",A;R.dataset.valid="false"};T(),R.addEventListener("input",()=>{T()}),R.addEventListener("blur",()=>{const A=T();A!==void 0&&n([...e,A]),S()}),Se(R,"cancel",S),Se(R,"commit",()=>{const A=T();A!==void 0&&n([...e,A]),S()}),L.appendChild(R),l.appendChild(L),R.focus(),w.registerDisposer(()=>{R.value="",L.remove()})}});c.appendChild(C)}l.appendChild(c);const v=[],y=tl.make(r??void 0,!1);for(const C of e){const w=y.get(C);if(v.push(w),n!==void 0){const S=Ss({title:"Remove ID",onClick:L=>{n(e.filter(I=>!re.equal(I,C))),L.stopPropagation()}});S.classList.add("neuroglancer-segment-list-entry-delete"),w.children[0].appendChild(S)}l.appendChild(w)}if(r!=null){const C=o.registerCancellable(wt(()=>{const w=r.segmentationGroupState.value.visibleSegments;let S=0;for(const L of e)w.has(L)&&++S;for(const L of v)y.update(L);f.checked=S===e.length&&S>0,f.indeterminate=S>0&&S<e.length}));C(),C.flush(),il(r,o,C),o.registerDisposer(r.segmentationGroupState.changed.add(C))}s.appendChild(l)})}const Ex="annotationColor";function Jy(i){class e extends i{constructor(...n){super(...n),this.annotationStates=this.registerDisposer(new _$),this.annotationDisplayState=new o_,this.annotationCrossSectionRenderScaleHistogram=new Mo,this.annotationCrossSectionRenderScaleTarget=ca(8),this.annotationProjectionRenderScaleHistogram=new Mo,this.annotationProjectionRenderScaleTarget=ca(8),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new z$(this)});let r;const s=()=>{const l=this.isReady;l&&r!==void 0?(r(),r=void 0):!l&&r===void 0&&(r=this.annotationStates.markLoading())};this.readyStateChanged.add(s),s();const o=this.manager.layerSelectedValues.mouseState;this.registerDisposer(o.changed.add(()=>{if(o.active){const l=o.pickedAnnotationLayer;if(l!==void 0&&this.annotationStates.states.includes(l)){const c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(n){}restoreState(n){super.restoreState(n),this.annotationDisplayState.color.restoreState(n[Ex])}captureSelectionState(n,r){super.captureSelectionState(n,r);const s=r.pickedAnnotationLayer;s===void 0||!this.annotationStates.states.includes(s)||(n.annotationId=r.pickedAnnotationId,n.annotationType=r.pickedAnnotationType,n.annotationBuffer=new Uint8Array(r.pickedAnnotationBuffer,r.pickedAnnotationBufferBaseOffset),n.annotationIndex=r.pickedAnnotationIndex,n.annotationCount=r.pickedAnnotationCount,n.annotationPartIndex=r.pickedOffset,n.annotationSourceIndex=s.sourceIndex,n.annotationSubsource=s.subsourceId)}displayAnnotationState(n,r,s){if(n.annotationId===void 0)return!1;const o=this.annotationStates.states.find(c=>c.sourceIndex===n.annotationSourceIndex&&(n.annotationSubsource===void 0||c.subsourceId===n.annotationSubsource));if(o===void 0)return!1;o.source instanceof Un;const l=s.registerDisposer(o.source.getReference(n.annotationId));return r.appendChild(s.registerDisposer(new cr(s.registerDisposer(new O1(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:u},f,g)=>{let v;if(c==null)if(n.annotationType!==void 0&&n.annotationBuffer!==void 0){const w=Ui[n.annotationType],S=o.source.rank,L=w.serializedBytes(S),I=n.annotationBuffer.byteOffset,M=new DataView(n.annotationBuffer.buffer),R=an.LITTLE===Vd,D=o.source.properties,T=new yE(S,L,D),A=n.annotationIndex,V=n.annotationCount;c=w.deserialize(M,I+T.propertyGroupBytes[0]*A,R,S,n.annotationId),T.deserialize(M,I,A,V,R,c.properties=new Array(D.length)),o.source.hasNonSerializedProperties()&&(v="Loading...")}else v=c===null?"Annotation not found":"Loading...";if(c!=null){const w=u.error===void 0?u.layerRank:0,S=document.createElement("div");S.classList.add("neuroglancer-selected-annotation-details-position-grid"),S.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${w}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,f.appendChild(S);const L=Ui[c.type],I=document.createElement("div");if(I.className="neuroglancer-selected-annotation-details-icon",I.textContent=L.icon,S.appendChild(I),w!==0){const O=u.modelTransform.layerDimensionNames;for(let _=0;_<w;++_){const H=document.createElement("div");H.classList.add("neuroglancer-selected-annotation-details-position-dim"),H.textContent=O[_],H.style.gridColumn=`dim ${_+1}`,S.appendChild(H)}AT(c,u,(_,H)=>{const U=dr({title:"Copy position",onClick:()=>{on(_.map(B=>Math.floor(B)).join(", "))}});U.style.gridColumn="copy",S.appendChild(U);for(let B=0;B<w;++B){const W=document.createElement("div");W.classList.add("neuroglancer-selected-annotation-details-position-coord"),W.style.gridColumn=`coord ${B+1}`,W.textContent=Math.floor(_[B]).toString(),S.appendChild(W)}if(!H){const B=Fk({title:"Move to position",onClick:()=>{PT(this,u,_)}});B.style.gridColumn="move",S.appendChild(B)}})}if(!o.source.readonly){const O=Ss({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});O.classList.add("neuroglancer-selected-annotation-details-delete"),S.appendChild(O)}var y=o.source;const M=y.relationships,R=y.properties,D=o.source.readonly;for(let O=0,_=R.length;O<_;++O){const H=R[O],U=document.createElement("label");U.classList.add("neuroglancer-annotation-property");const B=document.createElement("span");B.classList.add("neuroglancer-annotation-property-label"),B.textContent=H.identifier,U.appendChild(B);const W=H.description;W!==void 0&&(U.title=W);const F=c.properties[O],le=document.createElement("span");switch(le.classList.add("neuroglancer-annotation-property-value"),H.type){case"rgb":{const de=ia(F),Re=Gi(de);le.textContent=Re,le.style.backgroundColor=Re,le.style.color=ku(de)?"white":"black";break}case"rgba":{const de=ia(F);le.textContent=Gi(Ih(F)),le.style.backgroundColor=Gi(ia(F)),le.style.color=ku(de)?"white":"black";break}default:le.textContent=bE(H,F);break}U.appendChild(le),f.appendChild(U)}var C=c;const T=C.relatedSegments;for(let O=0,_=M.length;O<_;++O){const H=T===void 0?[]:T[O];if(H.length===0&&D)continue;const U=O,B=M[O];f.appendChild(g.registerDisposer(W$(B,H,o.displayState.relationshipStates.get(B).segmentationState,D?void 0:W=>{const F=l.value;if(F==null)return;let le=F.relatedSegments;le===void 0?le=o.source.relationships.map(()=>[]):le=le.slice(),le[U]=W;const de=j(j({},F),{relatedSegments:le});o.source.update(l,de),o.source.commit(l)})).element)}let A=null,V=o.source;if(V instanceof Un&&V.makeEditWidget&&(A=V.makeEditWidget(l),A&&(A.className="neuroglancer-annotation-details-description",f.appendChild(A))),(!o.source.readonly||c.description)&&A===null)if(o.source.readonly){const O=document.createElement("div");O.className="neuroglancer-annotation-details-description",O.textContent=c.description||"",f.appendChild(O)}else{const O=document.createElement("textarea");O.value=c.description||"",O.rows=3,O.className="neuroglancer-annotation-details-description",O.placeholder="Description",O.addEventListener("change",()=>{const _=O.value;o.source.update(l,j(j({},c),{description:_||void 0})),o.source.commit(l)}),f.appendChild(O)}}if(v!==void 0){const w=document.createElement("div");w.classList.add("neuroglancer-selection-annotation-status"),w.textContent=v,f.appendChild(w)}})).element),!0}displaySelectionState(n,r,s){let o=this.displayAnnotationState(n,r,s);return super.displaySelectionState(n,r,s)&&(o=!0),o}addLocalAnnotations(n,r,s){const o=n.subsourceEntry,l=new Zg({localPosition:this.localPosition,transform:n.getRenderLayerTransform(),source:r,displayState:this.annotationDisplayState,dataSource:n.loadedDataSource.layerDataSource,subsourceIndex:n.subsourceIndex,subsourceId:o.id,role:s});this.addAnnotationLayerState(l,n)}addStaticAnnotations(n){const r=n.subsourceEntry.subsource.staticAnnotations;return r===void 0?!1:(n.activate(()=>{this.addLocalAnnotations(n,r,En.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(n,r){const s=r.activated;s.registerDisposer(this.annotationStates.add(n));const o=new R$(this.manager.chunkManager,n.addRef());if(o.source instanceof Un){const l=new O$({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});s.registerDisposer(r.messages.addChild(l.messages));const c=new V$({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});s.registerDisposer(r.messages.addChild(c.messages)),s.registerDisposer(Fr((u,f)=>{f&&(u.registerDisposer(this.addRenderLayer(l.addRef())),u.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{const l=new B$(o,this.annotationCrossSectionRenderScaleHistogram);s.registerDisposer(this.addRenderLayer(l)),s.registerDisposer(r.messages.addChild(l.messages))}{const l=new N$(o.addRef(),this.annotationProjectionRenderScaleHistogram);s.registerDisposer(this.addRenderLayer(l)),s.registerDisposer(r.messages.addChild(l.messages))}}selectAnnotation(n,r,s,o=!0){this.manager.root.selectionState.captureSingleLayerState(this,l=>(l.annotationId=r,l.annotationSourceIndex=n.sourceIndex,l.annotationSubsource=n.subsourceId,!0),s,o)}toJSON(){const n=super.toJSON();return n[Ex]=this.annotationDisplayState.color.toJSON(),n}}return e}const Lx=vt.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});class zT extends K{constructor(e,t,n,r){super(),this.element=e,this.dataType=t,this.getModel=n,this.setModel=r,e.title=Lx.describe(),this.registerDisposer(new Zr(e,Lx)),Se(e,"set",s=>{const o=s.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;const u=id(l.window,l.range),f=eV(u,c),g=v=>{const y=this.getModel();this.setModel(nh(y,"range",f,v))};g(c),zn(o,v=>{const y=this.getTargetValue(v);y!==void 0&&g(y)})}),Se(e,"adjust-window-via-drag",s=>{const o=s.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),u=l<.5?0:1,f=g=>{const v=this.getModel();this.setModel(nh(v,"window",u,g))};zn(o,g=>{const v=this.getModel().window,y=this.getTargetFraction(g);f(u===0?Ar([c,v[1]],this.dataType,-y/(1-y)):Ar([v[0],c],this.dataType,1/y))})}),Se(e,"zoom-via-wheel",s=>{const o=s.detail,l=Ju(o),c=this.getTargetFraction(o),u=this.dataType,f=this.getModel(),g=Ar(f.window,u,c*(1-l)),v=Ar(f.window,u,(1-c)*l+c);this.setModel(j(j({},f),{window:[g,v],range:f.range}))})}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return Ar(this.getModel().window,this.dataType,e)}getTargetValue(e){const t=this.getTargetFraction(e);if(kt(t))return this.getWindowLerp(t)}}const kx=ln("histogramSamplerTexture");function nh(i,e,t,n,r=!1){const s=j({},i),o=i[e];if(s[e]=[o[0],o[1]],s[e][t]=n,e==="window"&&xn(n,o[1-t])*(2*t-1)<0&&(s[e][1-t]=n),e==="range"&&r){const l=[i.window[0],i.window[1]];for(let c=0;c<2;++c)xn(n,l[c])*(2*c-1)>0&&(l[c]=n);s.window=l}return s}const $$=254,Yl=$$+1;class j$ extends YE{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controller=this.registerDisposer(new zT(this.element,this.parent.dataType,()=>this.parent.trackable.value,t=>{this.parent.trackable.value=t})),this.dataValuesBuffer=this.registerDisposer(Sd(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{const t=new Uint8Array(Yl*bs);for(let n=0;n<Yl;++n)for(let r=0;r<bs;++r)t[n*bs+r]=n;return t})).value,this.lineShader=this.registerDisposer((()=>{const t=new da(this.gl);return hr(t),t.addTextureSampler("sampler2D","uHistogramSampler",kx),t.addOutputBuffer("vec4","out_color",0),t.addAttribute("uint","aDataValue"),t.addUniform("float","uBoundsFraction"),t.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),t.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Yl-1} ? cumSum : total;
if (dataValue == ${Yl-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),t.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),t.build()})()),this.regionCornersBuffer=wd(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{const t=new da(this.gl);return t.addAttribute("vec2","aVertexPosition"),t.addUniform("vec2","uBounds"),t.addUniform("vec4","uColor"),t.addOutputBuffer("vec4","out_color",0),t.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),t.setFragmentMain(`
out_color = uColor;
`),t.build()})()),this.element.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){const e=this.lineShader,t=this.gl,n=this.regionShader;var r=this.parent;const s=r.dataType,o=r.trackable.value;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{n.bind(),t.uniform4f(n.uniform("uColor"),.2,.2,.2,1);const l=fn(o.window,o.range[0]),c=fn(o.window,o.range[1]),u=Pu(s,o.window);t.uniform2f(n.uniform("uBounds"),Math.min(l,c)*u,Math.max(l,c)*u+(1-u));const f=n.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(f,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(f)}if(this.parent.histogramSpecifications.producerVisibility.visible){const l=this.renderViewport;e.bind(),fr(e,{width:l.logicalWidth,height:l.logicalHeight},1);const c=e.textureUnit(kx);t.uniform1f(e.uniform("uBoundsFraction"),Pu(s,o.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),To(t);const u=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(u,1,WebGL2RenderingContext.UNSIGNED_BYTE),pr(t,Yl,1),t.disableVertexAttribArray(u),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function H$(){}class J$ extends YE{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=wd(this.gl,-1,-1,1,1),this.element.classList.add("neuroglancer-invlerp-legend-panel");const t=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=Io(this,this.gl,j(j({},t),{memoizeKey:{id:"colorLegendShader",base:t.memoizeKey},defineShader:(n,r,s)=>{n.addOutputBuffer("vec4","v4f_fragData0",0),n.addAttribute("vec2","aVertexPosition"),n.addUniform("float","uLegendOffset"),n.addVarying("float","vLinearPosition"),n.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);const o=this.parent.dataType,l=wi(o);n.addFragmentCode(HB(n,"ng_colorLegendLerp",o)),n.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${l} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${l} getDataValue(int dummyChannel) {
  return getDataValue();
}
${l} getInterpolatedDataValue() {
  return getDataValue();
}
${l} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),t.defineShader(n,r,s)}}))}drawIndirect(){const e=this.shaderGetter(H$),t=e.shader;if(t===null)return;this.setGLLogicalViewport();const n=this.gl;n.clearColor(0,0,0,0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),n.enable(WebGL2RenderingContext.BLEND);var r=this.parent;const s=r.trackable.value.window,o=r.dataType;Zv(t,"ng_colorLegendLerp",this.parent.dataType,s);const l=tV(o,s);n.uniform1f(t.uniform("uLegendOffset"),kt(l)?l:0),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),n.disable(WebGL2RenderingContext.DEPTH_TEST),n.disable(WebGL2RenderingContext.STENCIL_TEST);const c=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(c,2,WebGL2RenderingContext.FLOAT),n.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),n.disableVertexAttribArray(c)}isReady(){return!0}}function Ix(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${i}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=i==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function Tx(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-invlerp-widget-bounds"),n.classList.add(`neuroglancer-invlerp-widget-${i}-bounds`);const r=[Ix(i,0),Ix(i,1)];for(let o=0;o<2;++o){const l=r[o];l.addEventListener("input",()=>{GT(l)}),l.addEventListener("change",()=>{const c=t.value,u=c[i];try{const f=Bd(e,l.value);t.value=nh(c,i,o,f,!0)}catch{Nm(l,u[o])}})}let s;return n.appendChild(r[0]),n.appendChild(r[1]),i==="range"&&(s=[document.createElement("div"),document.createElement("div"),document.createElement("div")],s[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),n.insertBefore(s[0],r[0]),n.insertBefore(s[1],r[1]),n.appendChild(s[2])),{container:n,inputs:r,spacers:s}}function GT(i){qi(i,Math.max(1,i.value.length+.1))}function Nm(i,e){let t;e instanceof re||$i(e)?t=e.toString():t=e.toPrecision(6),i.value=t,GT(i)}function WT(i){const e=i.value,t=e.range;i.value=j(j({},e),{range:[t[1],t[0]]})}function Z$(i,e,t){const n=e.value,r=Ar(n.range,i,.5-t/2),s=Ar(n.range,i,.5+t/2);e.value=j(j({},n),{range:[r,s]})}function q$(i,e,t,n,r){const s=Math.exp(r),o=e.value,l=Ar(t,i,.5-s/2+n),c=Ar(t,i,.5+s/2+n);e.value=j(j({},o),{range:[l,c]})}class Y$ extends qr{constructor(e,t,n,r,s,o,l){super(e),this.display=t,this.dataType=n,this.trackable=r,this.histogramSpecifications=s,this.histogramIndex=o,this.legendShaderOptions=l,this.cdfPanel=this.registerDisposer(new j$(this)),this.boundElements={range:Tx("range",this.dataType,this.trackable),window:Tx("window",this.dataType,this.trackable)},this.registerDisposer(s.visibility.add(this.visibility));const c=this.element,u=this.boundElements;if(l!==void 0){const g=this.registerDisposer(new J$(this));c.appendChild(g.element)}const f=g=>{const v=Lt({svg:g,title:"Invert range",onClick:()=>{this.invertRange()}});return u.range.spacers[1].appendChild(v),v};this.invertArrows=[f(Mk),f(Ak)],c.appendChild(u.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(u.window.container),this.updateView(),this.registerDisposer(r.changed.add(this.registerCancellable(wt(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){WT(this.trackable)}updateView(){const e=this.boundElements,t=this.trackable.value,n=this.dataType;for(let g=0;g<2;++g)Nm(e.range.inputs[g],t.range[g]),Nm(e.window.inputs[g],t.window[g]);const r=xn(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=r?"row-reverse":"row";const s=id(t.window,t.range),o=e.range.spacers,l=Pu(n,t.window),c=fn(t.window,s[r?1:0])*l,u=fn(t.window,s[r?0:1])*l+(1-l);o[r?2:0].style.width=`${c*100}%`,o[r?0:2].style.width=`${(1-u)*100}%`;const f=this.invertArrows;f[r?1:0].style.display="",f[r?0:1].style.display="none"}}const Zy="mergeSegments",qy="splitSegments",K$=vt.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),X$=vt.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class Q$ extends Uo{constructor(e){super(e),this.lastAnchorBaseSegment=new gt(void 0);const t=()=>{const n=e.anchorSegment.value;if(n===void 0)return;const r=e.displayState.segmentSelectionState;if(!r.hasSelectedSegment)return;const s=e.displayState.segmentationGroupState.value.segmentEquivalences,o=s.get(n);if(!re.equal(r.selectedSegment,o))return;const l=r.baseSelectedSegment,c=F_(l),u=s.disjointSets.visibleSegmentEquivalencePolicy.value;u&Fn.NONREPRESENTATIVE_EXCLUDED&&c||u&Fn.REPRESENTATIVE_EXCLUDED&&!c||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return Zy}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{let f=this.layer.anchorSegment.value,g=this.lastAnchorBaseSegment.value;if(f===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};const v=t.segmentEquivalences.get(f);return t.visibleSegments.has(v)?g===void 0||!re.equal(t.segmentEquivalences.get(g),v)?{anchorSegment:f,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:g,error:void 0}:{anchorSegment:f,error:"Anchor segment must be in visible set"}},r=()=>{var f=n();let g=f.anchorSegment,v=f.error;if(g===void 0||v!==void 0)return{anchorSegment:g,error:v,otherSegment:void 0,anchorSegmentValid:!1};const y=this.layer.displayState,C=y.segmentSelectionState.baseValue;return C===void 0||re.equal(y.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(g))?{anchorSegment:g,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:g,otherSegment:C,error:void 0,anchorSegmentValid:!0}};var s=ep(e);const o=s.body,l=s.header;l.textContent="Merge segments",o.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(K$),e.registerDisposer(()=>{Id(t)});const c=()=>{nt(o);const f=this.layer.displayState;var g=r();let v=g.anchorSegment,y=g.otherSegment,C=g.anchorSegmentValid,w=g.error;const S=I=>{const M=Zh(this.layer.displayState,I);return M.classList.add("neuroglancer-segment-list-entry-double-line"),M};if(v!==void 0&&o.appendChild(S(ua(f,v))),w!==void 0){const I=document.createElement("span");I.textContent=w,o.appendChild(I)}if(y!==void 0){const I=document.createElement("span");I.textContent=" merge ",o.appendChild(I),o.appendChild(S(ua(f,y)))}const L=t.segmentEquivalences;if(C){t.useTemporaryVisibleSegments.value=!0;const I=t.temporaryVisibleSegments;I.clear(),I.add(L.get(v)),y!==void 0&&I.add(L.get(y))}else{Id(t);return}};c(),e.registerDisposer(_o(this.layer.displayState,o));const u=e.registerCancellable(wt(c));il(this.layer.displayState,e,u),e.registerDisposer(this.layer.anchorSegment.changed.add(u)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(u)),e.bindAction("merge-segments",f=>{f.stopPropagation(),(async()=>{const g=t.graph.value;if(g===void 0)return;var v=r();const y=v.anchorSegment,C=v.otherSegment,w=v.error;if(!(y===void 0||C===void 0||w!==void 0))try{await g.merge(y,C),tt.showTemporaryMessage("Merge performed")}catch(S){tt.showTemporaryMessage(`Merge failed: ${S}`)}})()}),e.bindAction("set-anchor",f=>{f.stopPropagation();const g=this.layer.displayState.segmentSelectionState.baseValue;if(g===void 0)return;const v=this.layer.anchorSegment.value;if(t.visibleSegments.add(g),v===void 0||!re.equal(v,g)){this.layer.anchorSegment.value=g.clone();return}})}get description(){return"merge"}}class ej extends Uo{toJSON(){return qy}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{let g=this.layer.anchorSegment.value;if(g===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};const v=t.segmentEquivalences.get(g);return t.visibleSegments.has(v)?{anchorSegment:g,error:void 0}:{anchorSegment:g,error:"Anchor segment must be in visible set"}};var r=ep(e);const s=r.body,o=r.header;o.textContent="Split segments",s.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(X$);const l=()=>{var g=n();let v=g.anchorSegment,y=g.error;if(v===void 0||y!==void 0)return{anchorSegment:v,error:y,otherSegment:void 0,anchorSegmentValid:!1};const C=this.layer.displayState,w=C.segmentSelectionState.baseValue;return w===void 0||!re.equal(C.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(v))||re.equal(w,v)?{anchorSegment:v,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:v,otherSegment:w,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{Id(t)});const c=()=>{nt(s);const g=this.layer.displayState;var v=l();let y=v.anchorSegment,C=v.otherSegment,w=v.anchorSegmentValid,S=v.error,L,I;(()=>{const R=t.segmentEquivalences,D=this.layer.graphConnection;if(!w||D===void 0){Id(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,C!==void 0){const A=D.computeSplit(y,C);if(A!==void 0){L=new Gr(y,A.includeRepresentative),I=new Gr(C,A.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;const V=A.includeRepresentative,O=A.excludeRepresentative,_=t.temporarySegmentEquivalences;_.clear();for(const U of A.includeBaseSegments)_.link(U,V);for(const U of A.excludeBaseSegments)_.link(U,O);const H=t.temporaryVisibleSegments;H.clear(),H.add(V),H.add(O);return}}t.useTemporarySegmentEquivalences.value=!1;const T=t.temporaryVisibleSegments;T.clear(),T.add(R.get(y))}})();const M=R=>{const D=Zh(this.layer.displayState,R);return D.classList.add("neuroglancer-segment-list-entry-double-line"),D};if(y!==void 0&&s.appendChild(M(L??ua(g,y))),S!==void 0){const R=document.createElement("span");R.textContent=S,s.appendChild(R)}if(I!==void 0){const R=document.createElement("span");R.textContent=" split ",s.appendChild(R),s.appendChild(M(I))}};e.registerDisposer(_o(this.layer.displayState,s)),c();const u=e.registerCancellable(wt(c));il(this.layer.displayState,e,u),e.registerDisposer(this.layer.anchorSegment.changed.add(u));const f=async g=>{const v=t.graph.value;if(v===void 0)return;var y=l();const C=y.anchorSegment,w=y.otherSegment,S=y.error;if(!(C===void 0||w===void 0||S!==void 0))try{await v.split(C,w),g&&t.visibleSegments.add(t.segmentEquivalences.get(w)),tt.showTemporaryMessage("Split performed")}catch(L){tt.showTemporaryMessage(`Split failed: ${L}`)}};e.bindAction("split-segments",g=>{g.stopPropagation(),f(!1)}),e.bindAction("split-and-select-segments",g=>{g.stopPropagation(),f(!0)}),e.bindAction("set-anchor",g=>{g.stopPropagation();const v=this.layer.displayState.segmentSelectionState.baseValue;if(v===void 0)return;t.visibleSegments.add(v);const y=this.layer.anchorSegment.value;if(y===void 0||!re.equal(y,v)){this.layer.anchorSegment.value=v.clone();return}})}get description(){return"split"}}function tj(){Dd(Ai,Zy,i=>new Q$(i)),Dd(Ai,qy,i=>new ej(i))}/**
 * /**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2021 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yy="selectSegments",Vm="mousedown0",ij=vt.fromObject({[`at:alt?+shift?+${Vm}`]:"drag-select-segments"});var Fi;(function(i){i[i.IDLE=0]="IDLE",i[i.SELECT=1]="SELECT",i[i.DESELECT=2]="DESELECT"})(Fi||(Fi={}));class nj extends Uo{constructor(e){super(e)}toJSON(){return Yy}activate(e){const t=this.layer;var n=ep(e);const r=n.body,s=n.header;let o=Fi.IDLE,l=!1;e.bindInputEventMap(ij);const c=()=>Hu.value&2?Fi.DESELECT:Fi.SELECT,u=y=>{o!==y&&(o=y,l=!1,f())},f=()=>{nt(r);const y=document.createElement("span");switch(o){case Fi.IDLE:s.textContent="Select/Deselect segments",y.textContent=`${Vm} to select segments; alt+${Vm} to deselect segments.`;break;case Fi.SELECT:case Fi.DESELECT:s.textContent=`${o==Fi.SELECT?"Select":"Deselect"} segments`,y.textContent=`Drag to ${o==Fi.SELECT?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}r.appendChild(y)};f();const g=()=>{if(o==Fi.IDLE)return;const y=t.displayState.segmentSelectionState;if(y.hasSelectedSegment){const C=y.selectedSegment,w=t.displayState.segmentationGroupState.value.visibleSegments;switch(o){case Fi.SELECT:w.add(C);break;case Fi.DESELECT:w.delete(C);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{l&&g()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(f)),e.registerDisposer(Hu.changed.add(()=>{o!=Fi.IDLE&&u(c())}));const v=(y,C)=>{y.stopPropagation(),u(C),g();const w=y.detail.screenX,S=y.detail.screenY;zn(y.detail,(L,I,M)=>{if(!l){const R=L.screenX-w,D=L.screenY-S;R*R+D*D>25&&(g(),l=!0)}},L=>{l=!1,u(Fi.IDLE)})};e.bindAction("drag-select-segments",y=>v(y,c()))}get description(){return"select"}}function rj(){Dd(Ai,Yy,i=>new nj(i))}const sj=new re;class aj extends K{constructor(e,t,n,r){super(),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=n,this.parentElement=r,this.changed=new at,this.explicitSegmentsVisible=!1,this.visibleSegmentsGeneration=-1,this.queryResult=new gt(void 0),this.statusText=new gt(""),this.selectedMatches=0,this.matchStatusTextPrefix="",this.debouncedUpdate=ct(()=>this.update(),0),this.render=s=>{const o=this.explicitSegments;let l,c=!1;if(o!==void 0&&s<o.length)l=o[s],c=this.explicitSegmentsVisible;else{o!==void 0&&(s-=o.length),l=sj;const f=this.queryResult.value.indices[s],g=this.segmentPropertyMap.segmentPropertyMap.inlineProperties.ids;l.low=g[f*2],l.high=g[f*2+1]}const u=this.segmentWidgetFactory.get(l);return c&&(u.dataset.visibleList="true"),u},this.update(),this.registerDisposer(n.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)===null||e===void 0?void 0:e.count)!==null&&t!==void 0?t:0}update(){var e;const t=this.query.value,n=this.segmentPropertyMap,r=this.queryResult.value;let s;if(this.prevQuery===t)s=r;else{const S=DW(n,t);s=PW(n,S)}const o=[];let l=!1,c="";const u=this.segmentationDisplayState.segmentationGroupState.value.visibleSegments,f=u.changed.count,g=this.visibleSegmentsGeneration,v=VW(s.query);if(v){if(g!==f||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=f;const S=Te(u,I=>I.clone());S.sort(re.compare);const L=this.explicitSegments;L===void 0?(this.explicitSegments=S,o.push({retainCount:0,insertCount:S.length,deleteCount:0})):o.push(...m2(L,S,re.compare)),this.explicitSegments=S,l=!0}else o.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=f,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(o.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,l=!0),this.explicitSegmentsVisible=!1;var y=s;const C=y.explicitIds;if(C!==void 0?this.explicitSegments=C:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==s&&(o.push({retainCount:0,deleteCount:(e=r==null?void 0:r.count)!==null&&e!==void 0?e:0,insertCount:s.count}),l=!0,this.queryResult.value=s),s.explicitIds!==void 0?c=`${s.count} ids`:v?c=`${s.count} listed ids`:s.total>0&&(c=`${s.count}/${s.total} matches`),r!==s||f!==g){let S=c,L=0;n!==void 0&&s.count>0&&(L=NW(n,s,u),S+=` (${L} visible)`),this.selectedMatches=L,this.statusText.value=S}this.prevQuery=t,this.matchStatusTextPrefix=c;const w=this.explicitSegments;this.length=(this.explicitSegmentsVisible?w.length:0)+s.count,l&&this.changed.dispatch(o)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}}const Dx=vt.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),oj=100;function $T(i){qi(i,Math.max(1,i.value.length+.1))}function dg(i,e){let t;if($i(e))t=e.toString();else{const n=e.toString(),r=e.toPrecision(6);t=n.length<r.length?n:r}i.value=t,$T(i)}function lj(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${i}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(i==="range"?"range":"for distribution"),t.addEventListener("input",()=>{$T(t)}),t}function dj(i,e,t){if(i===void 0||i.indices===void 0)return;const n=i.query;let r=n.sortBy,s=n.includeColumns;_y(n,t)?(r=r.filter(o=>o.fieldId!==t),s=s.filter(o=>o!==t)):s.push(t),e(j(j({},n),{sortBy:r,includeColumns:s}))}function jT(i,e,t){var n;const r=i==null?void 0:i.query,s=r==null?void 0:r.sortBy;if(s===void 0)return;const o=r.includeColumns,l=((n=s.find(u=>u.fieldId===t))===null||n===void 0?void 0:n.order)==="<"?">":"<",c=o.filter(u=>u!==t);for(const u of s)u.fieldId!=="id"&&u.fieldId!=="label"&&u.fieldId!==t&&c.push(u.fieldId);e(j(j({},r),{sortBy:[{fieldId:t,order:l}],includeColumns:c}))}function HT(i,e,t){var n,r;const s=(n=i==null?void 0:i.query)===null||n===void 0?void 0:n.sortBy,o=(r=s==null?void 0:s.find(l=>l.fieldId===t))===null||r===void 0?void 0:r.order;e.textContent=o===">"?"▼":"▲",e.style.visibility=o===void 0?"":"visible",e.title=`Sort by ${t} in ${o==="<"?"descending":"ascending"} order`}class cj extends K{constructor(e,t,n){super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=n,this.propertyHistograms=[],this.bounds={window:new gt([]),range:new gt([])},this.throttledUpdate=this.registerCancellable(Uh(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable(wt(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable(ct(()=>this.setQueryFromBounds(),200));const r=e==null?void 0:e.numericalProperties,s=[];let o;if(r!==void 0&&r.length>0){o=document.createElement("details");const l=document.createElement("summary");l.textContent=`${r.length} numerical propert${r.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");const c=this.bounds.window.value;for(let u=0,f=r.length;u<f;++u){const g=r[u],v=this.makeNumericalPropertySummary(u,g);s.push(v),o.appendChild(v.element),c[u]=g.bounds}}this.listElement=o,this.properties=s,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){const e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;const t=e.query,n=[],r=this.bounds.range.value,s=this.properties;for(let o=0,l=s.length;o<l;++o){const c=s[o].property;n.push({fieldId:c.id,bounds:r[o]})}this.setQuery(j(j({},t),{numericalConstraints:n}))}getBounds(e){const t=this.bounds;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){const n=this.properties[e].property;let r=id(n.bounds,t.range);xn(r[0],r[1])>0&&(r=[r[1],r[0]]);const s=id(n.bounds,t.window),o=this.getBounds(e),l=this.properties[e].property.dataType;Mr(l,s,o.window)||(this.bounds.window.value[e]=s,this.bounds.window.changed.dispatch()),Mr(l,r,o.range)||(this.bounds.range.value[e]=r,this.bounds.range.changed.dispatch())}setBound(e,t,n,r){const s=this.segmentPropertyMap.numericalProperties[n].bounds;r=pd(s,r);const o=this.getBounds(n),l=nh(o,e,t,r,!0);this.setBounds(n,l)}handleNewQueryResult(){const e=this.queryResult.value;if(this.listElement!==void 0){if((e==null?void 0:e.indices)!==void 0){const t=e.query.numericalConstraints,n=this.segmentPropertyMap.numericalProperties,r=this.bounds.range.value,s=t.length,o=n.length;r.length=o;for(let l=0;l<o;++l)r[l]=n[l].bounds;for(let l=0;l<s;++l){const c=t[l],u=n.findIndex(f=>f.id===c.fieldId);r[u]=c.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){const e=this.queryResult.value;this.listElement!==void 0&&(MW(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();const e=this.listElement;if(e===void 0)return;const t=this.propertyHistograms;if(t.length===0){e.style.display="none";return}e.style.display="";const n=this.properties;for(let r=0,s=n.length;r<s;++r)this.updateNumericalPropertySummary(r,n[r],t[r])}makeNumericalPropertySummary(e,t){const n=document.createElement("div");n.classList.add("neuroglancer-segment-query-result-numerical-plot-container");const r=document.createElement("img");r.classList.add("neuroglancer-segment-query-result-numerical-plot");const s=new zT(r,t.dataType,()=>this.getBounds(e),f=>this.setBounds(e,f)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");const l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{dj(this.queryResult.value,this.setQuery,t.id)});const c=f=>{const g=document.createElement("div");g.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),g.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${f}`);const v=w=>{const S=lj(f,w);return S.addEventListener("change",()=>{if(this.bounds[f].value[e]!==void 0){try{const L=Bd(t.dataType,S.value);this.setBound(f,w,e,L),this.bounds[f].changed.dispatch()}catch{}dg(S,this.bounds[f].value[e][w])}}),S},y=[v(0),v(1)];let C;if(f==="range"){C=[document.createElement("div"),document.createElement("div"),document.createElement("div")],C[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),C[1].appendChild(l);const w=document.createElement("span");w.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),w.appendChild(document.createTextNode(t.id)),w.appendChild(o),w.addEventListener("click",()=>{jT(this.queryResult.value,this.setQuery,t.id)}),C[1].appendChild(w);const S=t.description;S&&(C[1].title=S),g.appendChild(C[0]),g.appendChild(y[0]);const L=document.createElement("div");L.textContent="≤",L.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(L),g.appendChild(C[1]);const I=document.createElement("div");I.textContent="≤",I.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(I),g.appendChild(y[1]),g.appendChild(C[2])}else g.appendChild(y[0]),g.appendChild(y[1]);return{container:g,spacers:C,inputs:y}},u={range:c("range"),window:c("window")};return n.appendChild(u.range.container),n.appendChild(r),n.appendChild(u.window.container),{property:t,controller:s,element:n,plotImg:r,boundElements:u,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,n){const r=t.bounds.window,s=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],c=t.property,u=this.queryResult.value,f=_y(u==null?void 0:u.query,c.id);if(t.columnCheckbox.checked=f,t.columnCheckbox.title=f?"Remove column from result table":"Add column to result table",HT(u,t.sortIcon,c.id),t.propertyHistogram===n&&Mr(c.dataType,r,s)&&Mr(c.dataType,o,l))return;const g=n.histogram,v="http://www.w3.org/2000/svg",y=document.createElementNS(v,"svg");y.setAttribute("width","1"),y.setAttribute("height","1"),y.setAttribute("preserveAspectRatio","none");const C=document.createElementNS(v,"rect"),w=fn(s,l[0]),S=fn(s,l[1]);C.setAttribute("x",`${w}`),C.setAttribute("y","0"),C.setAttribute("width",`${S-w}`),C.setAttribute("height","1"),C.setAttribute("fill","#4f4f4f"),y.appendChild(C);const L=g.length,I=(O,_,H)=>{const U=document.createElementNS(v,"polyline");let B="",W=0;for(let ce=O;ce<H;++ce)W+=g[ce];if(W===0)return;const F=fn(s,n.window[0]),le=fn(s,n.window[1]),de=(ce,Le)=>{const Be=ce/(L-2),qe=F*(1-Be)+le*Be;B+=` ${qe},${1-Le}`};O!==0&&de(O,0);let Re=0;for(let ce=O;ce<_;++ce){const Le=g[ce];Re+=Le,de(ce,Re/W)}return U.setAttribute("fill","none"),U.setAttribute("stroke-width","1px"),U.setAttribute("points",B),U.setAttribute("vector-effect","non-scaling-stroke"),U};{const O=I(0,L-1,L);O!==void 0&&(O.setAttribute("stroke","cyan"),y.appendChild(O))}if(!Mr(c.dataType,c.bounds,l)){const O=Math.floor(Math.max(0,Math.min(1,fn(n.window,l[0])))*(L-2)),_=Math.ceil(Math.max(0,Math.min(1,fn(n.window,l[1])))*(L-2)),H=I(O,_,_);H!==void 0&&(H.setAttribute("stroke","white"),y.appendChild(H))}const M=new XMLSerializer().serializeToString(y);t.plotImg.src=`data:image/svg+xml;base64,${btoa(M)}`,t.propertyHistogram=n;for(let O=0;O<2;++O)r[O]=s[O],dg(t.boundElements.window.inputs[O],s[O]),o[O]=l[O],dg(t.boundElements.range.inputs[O],l[O]);const R=t.boundElements.range.spacers,D=id(s,l),T=Pu(c.dataType,s),A=fn(s,D[0])*T,V=fn(s,D[1])*T+(1-T);R[0].style.width=`${A*100}%`,R[2].style.width=`${(1-V)*100}%`}}function uj(i,e){const t=i.tags;if(t===void 0||t.length===0)return;const n=i.query,r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-tag-list");for(const s of t){const o=s.tag,l=s.count,c=document.createElement("div");c.classList.add("neuroglancer-segment-query-result-tag");const u=document.createElement("span");u.classList.add("neuroglancer-segment-query-result-tag-name"),u.textContent=o,r.appendChild(c);const f=n.includeTags.includes(o),g=n.excludeTags.includes(o);let v;f?v="Remove tag from required set":g?v="Remove tag from excluded set":v="Add tag to required set",u.addEventListener("click",()=>{e(ux(n,o,!0,!f&&!g))}),u.title=v;const y=f||g,C=S=>{const L=S?l:i.count-l,I=document.createElement("div");if(I.classList.add("neuroglancer-segment-query-result-tag-toggle"),I.classList.add(`neuroglancer-segment-query-result-tag-${S?"include":"exclude"}`),c.appendChild(I),!y&&L===0)return;const M=S?f:g;I.appendChild(new er({get value(){return M},set value(R){e(ux(n,o,S,R))},changed:R1},{text:S?"+":"-",enableTitle:`Add tag to ${S?"required":"exclusion"} set`,disableTitle:`Remove tag from ${S?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};C(!0),C(!1),c.appendChild(u);const w=document.createElement("span");w.classList.add("neuroglancer-segment-query-result-tag-count"),y||(w.textContent=l.toString()),c.appendChild(w)}return r}class hj extends qr{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new cr(e.displayState.segmentationGroupState.value.graph,(c,u,f)=>{if(c===void 0)return;const g=document.createElement("div");g.className="neuroglancer-segmentation-toolbox",g.appendChild(Kf(f,e,{toolJson:Zy,label:"Merge",title:"Merge segments"})),g.appendChild(Kf(f,e,{toolJson:qy,label:"Split",title:"Split segments"})),u.appendChild(g)})).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(Kf(this,e,{toolJson:Yy,label:"Select",title:"Select/Deselect segments"})),t.appendChild(n);const r=document.createElement("input");r.classList.add("neuroglancer-segment-list-query"),r.addEventListener("focus",()=>{r.select()});const s=this.registerDisposer(new $n(r,Dx));s.allShortcutsAreGlobal=!0;const o=this.layer.displayState.segmentQuery,l=this.registerCancellable(ct(()=>{o.value=r.value},200));r.autocomplete="off",r.title=Dx.describe(),r.spellcheck=!1,r.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(Or(c=>{r.value=c},o)),this.registerDisposer(Or(c=>{Date.now()-c<100&&(setTimeout(()=>{r.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(r),t.appendChild(this.registerDisposer(new cr(e.displayState.segmentPropertyMap,(c,u,f)=>{const g=ce=>{r.focus(),r.select();const Le=RW(c,ce);document.execCommand("insertText",!1,Le),o.value=Le,r.select()},v=f.registerDisposer(new aj(o,c,e.displayState,u)),y=e.displayState.segmentationGroupState.value,C=document.createElement("ul");C.classList.add("neuroglancer-segment-query-errors"),u.appendChild(C);const w=document.createElement("div");w.classList.add("neuroglancer-segment-query-result-statistics");const S=document.createElement("span"),L=document.createElement("input");L.type="checkbox",L.checked=!0,L.title="Deselect all segment IDs",L.addEventListener("change",()=>{y.visibleSegments.clear()});const I=dr({title:"Copy visible segment IDs",onClick:()=>{const ce=Te(y.visibleSegments,Le=>Le.clone());ce.sort(re.compare),on(ce.join(", "))}}),M=document.createElement("span");S.appendChild(I),S.appendChild(L),S.appendChild(M);const R=document.createElement("span"),D=document.createElement("input"),T=dr({onClick:()=>{l(),l.flush(),v.debouncedUpdate.flush();const ce=v.queryResult.value;if(ce===void 0)return;const Le=new Array(ce.count);yu(c,ce,(Be,qe)=>{Le[qe]=Be.toString()}),on(Le.join(", "))}});D.type="checkbox";const A=()=>{l(),l.flush(),v.debouncedUpdate.flush();const ce=v.queryResult.value;if(ce===void 0)return;const Le=y.visibleSegments,Be=v.selectedMatches,qe=Be!==ce.count;if(qe&&ce.count-Be>oj){if(!U)return U=!0,V.textContent=`Confirm: show ${ce.count-Be} segments?`,!1;U=!1,H()}return yu(c,ce,Ze=>{Le.set(Ze,qe)}),!0};D.addEventListener("click",ce=>{A()||ce.preventDefault()});const V=document.createElement("span");R.appendChild(T),R.appendChild(D),R.appendChild(V),S.classList.add("neuroglancer-segment-list-status"),R.classList.add("neuroglancer-segment-list-status"),u.appendChild(w);const O=document.createElement("div");O.classList.add("neuroglancer-segment-query-result-statistics-separator"),u.appendChild(O),u.appendChild(R),u.appendChild(S);let _=-1;const H=()=>{const ce=y.visibleSegments.size;_!==ce&&(_=ce,M.textContent=`${ce} visible in total`,L.checked=ce>0,L.style.visibility=ce?"visible":"hidden",I.style.visibility=ce?"visible":"hidden"),V.textContent=v.statusText.value;const Le=v.numMatches,Be=v.selectedMatches;T.style.visibility=Le?"visible":"hidden",T.title=`Copy ${Le} segment ID(s)`,D.style.visibility=Le?"visible":"hidden",Be===0?(D.checked=!1,D.indeterminate=!1,D.title=`Show ${Le} segment ID(s)`):Be===Le?(D.checked=!0,D.indeterminate=!1,D.title=`Hide ${Be} segment ID(s)`):(D.checked=!0,D.indeterminate=!0,D.title=`Show ${Le-Be} segment ID(s)`)};H(),v.statusText.changed.add(H),f.registerDisposer(y.visibleSegments.changed.add(H));let U=!1;f.registerEventListener(r,"input",()=>{l(),U&&(U=!1,H())}),f.registerDisposer(Se(r,"cancel",()=>{r.focus(),r.select(),document.execCommand("delete"),r.blur(),r.value="",o.value="",U=!1,H()})),f.registerDisposer(Se(r,"toggle-listed",A)),f.registerDisposer(Se(r,"hide-all",()=>{y.visibleSegments.clear()})),f.registerDisposer(Se(r,"hide-listed",()=>{l(),l.flush(),v.debouncedUpdate.flush();const ce=y.visibleSegments;if(o.value==="")ce.clear();else{const Le=v.queryResult.value;if(Le===void 0)return;yu(c,Le,Be=>{ce.delete(Be)})}}));const B=f.registerDisposer(new xy({source:v,horizontalScroll:!0})),W=f.registerCancellable(wt(()=>{v.updateRenderedItems(B)})),F=this.layer.displayState;f.registerDisposer(F.segmentSelectionState.changed.add(W)),f.registerDisposer(y.visibleSegments.changed.add(W)),f.registerDisposer(F.segmentColorHash.changed.add(W)),f.registerDisposer(F.segmentStatedColors.changed.add(W)),f.registerDisposer(F.segmentDefaultColor.changed.add(W)),B.element.classList.add("neuroglancer-segment-list"),f.registerDisposer(e.bindSegmentListWidth(B.element)),f.registerDisposer(new Zr(B.element,Jh()));const le=f.registerDisposer(new cj(c,v.queryResult,g));{const ce=le.listElement;ce!==void 0&&w.appendChild(ce)}let de;const Re=ce=>{const Le=ce==null?void 0:ce.errors;if(nt(C),Le!==void 0)for(const Be of Le){const qe=document.createElement("li");qe.textContent=Be.message,C.appendChild(qe)}};Or(ce=>{if(v.segmentWidgetFactory=new Gk(v.segmentationDisplayState,v.parentElement,Be=>_y(ce==null?void 0:ce.query,Be.id)),B.scrollToTop(),nt(B.header),c!==void 0){const Be=v.segmentWidgetFactory.getHeader();Be.container.classList.add("neuroglancer-segment-list-header");for(const qe of Be.propertyLabels){const Ze=qe.label,it=qe.sortIcon,ot=qe.id;Ze.addEventListener("click",()=>{jT(v.queryResult.value,g,ot)}),HT(ce,it,ot)}B.header.appendChild(Be.container)}if(Re(ce),O.style.display="none",de==null||de.remove(),ce===void 0)return;let Le=ce.query;Le.errors!==void 0||Le.ids!==void 0||(de=uj(ce,g),de!==void 0&&w.appendChild(de),(le.properties.length>0||de!==void 0)&&(O.style.display=""))},v.queryResult),u.appendChild(B.element)})).element)}}function Ky(i={}){return Lt(j({text:"?"},i))}function JT(i,e,t,n){const r=document.createElement("label");r.classList.add("neuroglancer-layer-control-container");const s=document.createElement("div");s.classList.add("neuroglancer-layer-control-label-container");const o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),s.appendChild(o);const l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),r.appendChild(s);var c=t.makeControl(e,i,{labelContainer:s,labelTextContainer:l,display:e.manager.root.display,visibility:n});const u=c.control,f=c.controlElement;return f.classList.add("neuroglancer-layer-control-control"),r.appendChild(f),{controlContainer:r,label:o,labelContainer:s,labelTextContainer:l,control:u}}class ZT extends Uo{constructor(e,t){super(e),this.options=t}activate(e){const t=this.options,n=this.layer,r=t.isValid;if(r!==void 0&&!r(n).value)return;var s=ep(e);const o=s.header,l=s.body;var c=JT(e,n,t,new Zt(Zt.VISIBLE));const u=c.controlContainer,f=c.control,g=c.labelContainer;o.appendChild(g),l.appendChild(u),t.activateTool(e,f)}get description(){var e;const t=this.options;return(e=t.toolDescription)!==null&&e!==void 0?e:t.label}toJSON(){return this.options.toolJson}}function Px(i,e,t,n){var r=JT(i,e,t,n);const s=r.controlContainer,o=r.label;return s.classList.add("neuroglancer-layer-options-control-container"),o.prepend(i.registerDisposer(new lI(e,t.toolJson)).element),s}function Xy(i,e,t,n){const r=n.isValid;return r===void 0?Px(i,e,n,t):i.registerDisposer(new cr(r(e),(s,o,l)=>{s&&o.appendChild(Px(l,e,n,t))},t)).element}function qT(i,e){const t=e.toolJson,n=typeof t=="string"?t:t.type;Dd(i,n,r=>new ZT(r,e))}class Ax extends K{constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");const t=this.element,n=this.label,r=this.topRow,s=this.selectElement,o=this.linkedLayers,l=this.unlinkButton;r.appendChild(n),r.appendChild(s),r.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(r),t.appendChild(o),this.updateView();const c=ct(()=>this.updateView(),0);this.registerEventListener(s,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){const e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var e;const t=this.selectElement,n=this.group,r=n.predicate;nt(t);const s=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=s?"":"none";const o=this.linkedLayers,l=n.linkedLayers.size!==0;if(o.style.display=l?"":"none",this.unlinkButton.textContent=l?"Unlink all":"Unlink",l){this.element.style.display="",t.style.display="none",nt(o);for(const c of n.linkedLayers){const u=document.createElement("div");u.classList.add("neuroglancer-linked-layer-widget-layer");const f=fy({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});u.appendChild(f),u.appendChild(document.createTextNode(c.managedLayer.name)),o.appendChild(u)}}else{t.style.display="";const c=document.createElement("option");t.appendChild(c);let u=0;for(const f of this.group.layerManager.managedLayers){const g=f.layer;if(g!==null&&g!==n.layer&&r(g)){++u;const v=document.createElement("option"),y=f.name;v.textContent=y,v.value=y,t.appendChild(v)}}t.value=(e=n.toJSON())!==null&&e!==void 0?e:"",this.element.style.display=u===0?"none":""}}}const pj="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0ibWF4aW1pc2VJY29uVGl0bGUiPgogICAgPHRpdGxlIGlkPSJtYXhpbWlzZUljb25UaXRsZSI+TWF4aW1pc2UgVmlldzwvdGl0bGU+ICAgIAogICAgPHBvbHlsaW5lIHBvaW50cz0iMjEgMTYgMjEgMjEgMTYgMjEiLz4KICAgIDxwb2x5bGluZSBwb2ludHM9IjggMjEgMyAyMSAzIDE2Ii8+CiAgICA8cG9seWxpbmUgcG9pbnRzPSIxNiAzIDIxIDMgMjEgOCIvPgogICAgPHBvbHlsaW5lIHBvaW50cz0iMyA4IDMgMyA4IDMiLz4KPC9zdmc+";function Qy(i={}){return Lt(j({svg:pj},i))}(function(i,e){(function(t){t(sl())})(function(t){var n="CodeMirror-lint-markers",r="CodeMirror-lint-line-";function s(A,V,O){var _=document.createElement("div");_.className="CodeMirror-lint-tooltip cm-s-"+A.options.theme,_.appendChild(O.cloneNode(!0)),A.state.lint.options.selfContain?A.getWrapperElement().appendChild(_):document.body.appendChild(_);function H(U){if(!_.parentNode)return t.off(document,"mousemove",H);var B=Math.max(0,U.clientY-_.offsetHeight-5),W=Math.max(0,Math.min(U.clientX+5,_.ownerDocument.defaultView.innerWidth-_.offsetWidth));_.style.top=B+"px",_.style.left=W+"px"}return t.on(document,"mousemove",H),H(V),_.style.opacity!=null&&(_.style.opacity=1),_}function o(A){A.parentNode&&A.parentNode.removeChild(A)}function l(A){A.parentNode&&(A.style.opacity==null&&o(A),A.style.opacity=0,setTimeout(function(){o(A)},600))}function c(A,V,O,_){var H=s(A,V,O);function U(){t.off(_,"mouseout",U),H&&(l(H),H=null)}var B=setInterval(function(){if(H)for(var W=_;;W=W.parentNode){if(W&&W.nodeType==11&&(W=W.host),W==document.body)return;if(!W){U();break}}if(!H)return clearInterval(B)},400);t.on(_,"mouseout",U)}function u(A,V,O){this.marked=[],V instanceof Function&&(V={getAnnotations:V}),(!V||V===!0)&&(V={}),this.options={},this.linterOptions=V.options||{};for(var _ in f)this.options[_]=f[_];for(var _ in V)f.hasOwnProperty(_)?V[_]!=null&&(this.options[_]=V[_]):V.options||(this.linterOptions[_]=V[_]);this.timeout=null,this.hasGutter=O,this.onMouseOver=function(H){T(A,H)},this.waitingFor=0}var f={highlightLines:!1,tooltips:!0,delay:500,lintOnChange:!0,getAnnotations:null,async:!1,selfContain:null,formatAnnotation:null,onUpdateLinting:null};function g(A){var V=A.state.lint;V.hasGutter&&A.clearGutter(n),V.options.highlightLines&&v(A);for(var O=0;O<V.marked.length;++O)V.marked[O].clear();V.marked.length=0}function v(A){A.eachLine(function(V){var O=V.wrapClass&&/\bCodeMirror-lint-line-\w+\b/.exec(V.wrapClass);O&&A.removeLineClass(V,"wrap",O[0])})}function y(A,V,O,_,H){var U=document.createElement("div"),B=U;return U.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+O,_&&(B=U.appendChild(document.createElement("div")),B.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),H!=!1&&t.on(B,"mouseover",function(W){c(A,W,V,B)}),U}function C(A,V){return A=="error"?A:V}function w(A){for(var V=[],O=0;O<A.length;++O){var _=A[O],H=_.from.line;(V[H]||(V[H]=[])).push(_)}return V}function S(A){var V=A.severity;V||(V="error");var O=document.createElement("div");return O.className="CodeMirror-lint-message CodeMirror-lint-message-"+V,typeof A.messageHTML<"u"?O.innerHTML=A.messageHTML:O.appendChild(document.createTextNode(A.message)),O}function L(A,V){var O=A.state.lint,_=++O.waitingFor;function H(){_=-1,A.off("change",H)}A.on("change",H),V(A.getValue(),function(U,B){A.off("change",H),O.waitingFor==_&&(B&&U instanceof t&&(U=B),A.operation(function(){M(A,U)}))},O.linterOptions,A)}function I(A){var V=A.state.lint;if(V){var O=V.options,_=O.getAnnotations||A.getHelper(t.Pos(0,0),"lint");if(_)if(O.async||_.async)L(A,_);else{var H=_(A.getValue(),V.linterOptions,A);if(!H)return;H.then?H.then(function(U){A.operation(function(){M(A,U)})}):A.operation(function(){M(A,H)})}}}function M(A,V){var O=A.state.lint;if(O){var _=O.options;g(A);for(var H=w(V),U=0;U<H.length;++U){var B=H[U];if(B){for(var W=null,F=O.hasGutter&&document.createDocumentFragment(),le=0;le<B.length;++le){var de=B[le],Re=de.severity;Re||(Re="error"),W=C(W,Re),_.formatAnnotation&&(de=_.formatAnnotation(de)),O.hasGutter&&F.appendChild(S(de)),de.to&&O.marked.push(A.markText(de.from,de.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+Re,__annotation:de}))}O.hasGutter&&A.setGutterMarker(U,n,y(A,F,W,B.length>1,_.tooltips)),_.highlightLines&&A.addLineClass(U,"wrap",r+W)}}_.onUpdateLinting&&_.onUpdateLinting(V,H,A)}}function R(A){var V=A.state.lint;V&&(clearTimeout(V.timeout),V.timeout=setTimeout(function(){I(A)},V.options.delay))}function D(A,V,O){for(var _=O.target||O.srcElement,H=document.createDocumentFragment(),U=0;U<V.length;U++){var B=V[U];H.appendChild(S(B))}c(A,O,H,_)}function T(A,V){var O=V.target||V.srcElement;if(/\bCodeMirror-lint-mark-/.test(O.className)){for(var _=O.getBoundingClientRect(),H=(_.left+_.right)/2,U=(_.top+_.bottom)/2,B=A.findMarksAt(A.coordsChar({left:H,top:U},"client")),W=[],F=0;F<B.length;++F){var le=B[F].__annotation;le&&W.push(le)}W.length&&D(A,W,V)}}t.defineOption("lint",!1,function(A,V,O){if(O&&O!=t.Init&&(g(A),A.state.lint.options.lintOnChange!==!1&&A.off("change",R),t.off(A.getWrapperElement(),"mouseover",A.state.lint.onMouseOver),clearTimeout(A.state.lint.timeout),delete A.state.lint),V){for(var _=A.getOption("gutters"),H=!1,U=0;U<_.length;++U)_[U]==n&&(H=!0);var B=A.state.lint=new u(A,V,H);B.options.lintOnChange&&A.on("change",R),B.options.tooltips!=!1&&B.options.tooltips!="gutter"&&t.on(A.getWrapperElement(),"mouseover",B.onMouseOver),I(A)}}),t.defineExtension("performLint",function(){I(this)})})})();var fj=function(i){i.defineMode("glsl",function(s,o){var l=s.indentUnit,c=o.keywords||e(t),u=o.builtins||e(n),f=o.blockKeywords||e("case do else for if switch while struct"),g=o.atoms||e("null"),v=o.hooks||{},y=o.multiLineStrings,C=/[+\-*&%=<>!?|\/]/,w;function S(T,A){var V=T.next();if(v[V]){var O=v[V](T,A);if(O!==!1)return O}if(V=='"'||V=="'")return A.tokenize=L(V),A.tokenize(T,A);if(/[\[\]{}\(\),;\:\.]/.test(V))return w=V,"bracket";if(/\d/.test(V))return T.eatWhile(/[\w\.]/),"number";if(V=="/"){if(T.eat("*"))return A.tokenize=I,I(T,A);if(T.eat("/"))return T.skipToEnd(),"comment"}if(V=="#")return T.eatWhile(/[\S]+/),T.eatWhile(/[\s]+/),T.eatWhile(/[\S]+/),T.eatWhile(/[\s]+/),"comment";if(C.test(V))return T.eatWhile(C),"operator";T.eatWhile(/[\w\$_]/);var _=T.current();return c.propertyIsEnumerable(_)?(f.propertyIsEnumerable(_)&&(w="newstatement"),"keyword"):u.propertyIsEnumerable(_)?"builtin":g.propertyIsEnumerable(_)?"atom":"word"}function L(T){return function(A,V){for(var O=!1,_,H=!1;(_=A.next())!=null;){if(_==T&&!O){H=!0;break}O=!O&&_=="\\"}return(H||!(O||y))&&(V.tokenize=S),"string"}}function I(T,A){for(var V=!1,O;O=T.next();){if(O=="/"&&V){A.tokenize=S;break}V=O=="*"}return"comment"}function M(T,A,V,O,_){this.indented=T,this.column=A,this.type=V,this.align=O,this.prev=_}function R(T,A,V){return T.context=new M(T.indented,A,V,null,T.context)}function D(T){var A=T.context.type;return(A==")"||A=="]"||A=="}")&&(T.indented=T.context.indented),T.context=T.context.prev}return{startState:function(T){return{tokenize:null,context:new M((T||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(T,A){var V=A.context;if(T.sol()&&(V.align==null&&(V.align=!1),A.indented=T.indentation(),A.startOfLine=!0),T.eatSpace())return null;w=null;var O=(A.tokenize||S)(T,A);if(O=="comment"||O=="meta")return O;if(V.align==null&&(V.align=!0),(w==";"||w==":")&&V.type=="statement")D(A);else if(w=="{")R(A,T.column(),"}");else if(w=="[")R(A,T.column(),"]");else if(w=="(")R(A,T.column(),")");else if(w=="}"){for(;V.type=="statement";)V=D(A);for(V.type=="}"&&(V=D(A));V.type=="statement";)V=D(A)}else w==V.type?D(A):(V.type=="}"||V.type=="top"||V.type=="statement"&&w=="newstatement")&&R(A,T.column(),"statement");return A.startOfLine=!1,O},indent:function(T,A){if(T.tokenize!=S&&T.tokenize!=null)return 0;var V=A&&A.charAt(0),O=T.context,_=V==O.type;return O.type=="statement"?O.indented+(V=="{"?0:l):O.align?O.column+(_?0:1):O.indented+(_?0:l)},electricChars:"{}"}});function e(s){for(var o={},l=s.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",n="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function r(s,o){return o.startOfLine?(s.skipToEnd(),"meta"):!1}(function(){i.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(n),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":r}})})()};const gj=It(fj);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */gj(gs);const mj=500;class e0 extends K{constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=ct(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},mj),this.textEditor=gs(r=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));const t=this.state.shaderControlState;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();const n=new IntersectionObserver(r=>{r.some(s=>s.isIntersecting)&&this.textEditor.refresh()},{root:document.body});n.observe(this.element),this.registerDisposer(()=>n.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){var e=this.state.sourceStringNumber;const t=e===void 0?1:e,n=this.state.shaderError.value;let r;const s=this.state.shaderControlState;s!==void 0?r=s.parseErrors.value:r=[],n===void 0&&r.length===0?this.setValidState(void 0):n!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{const o=[];for(const l of r)o.push({message:l.message,severity:"error",from:gs.Pos(l.line)});if(n!=null)if(n.name==="ShaderCompilationError")for(const l of n.errorMessages)o.push({message:l.message,severity:"error",from:gs.Pos(l.file===t&&l.line||0)});else n.name==="ShaderLinkError"?o.push({message:n.log,severity:"error",from:gs.Pos(0)}):o.push({message:n.message,severity:"error",from:gs.Pos(0)});return o}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let t=this.element;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,Bt(this.element),this.textEditor=void 0,super.disposed()}}const vj=vt.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function yj(i){return{makeControl:(e,t,n)=>{var r=i(e);const s=r.watchableValue,o=r.channelCoordinateSpaceCombiner,l=r.dataType,c=r.defaultChannel,u=r.histogramSpecifications,f=r.legendShaderOptions,g=r.histogramIndex;if(o!==void 0&&c.length!==0){const y=t.registerDisposer(new Qs(o.combined)),C=t.registerDisposer(new lp(y,o,{copyButton:!1}));t.registerDisposer(y.changed.add(()=>{const S=y.value,L=Te(S,M=>Math.floor(M)),I=s.value;_e(I.channel,L)||(s.value=j(j({},s.value),{channel:L}))}));const w=()=>{const S=y.value,L=s.value;_e(S,L.channel)||(S.set(L.channel),y.changed.dispatch())};w(),t.registerDisposer(s.changed.add(w)),n.labelContainer.appendChild(C.element)}const v=t.registerDisposer(new Y$(n.visibility,n.display,l,s,u,g,c.length===0?f:void 0));return{control:v,controlElement:v.element}},activateTool:(e,t)=>{e.bindInputEventMap(vj),e.bindAction("adjust-contrast-via-wheel",n=>{n.stopPropagation();const r=Ju(n.detail);Z$(t.dataType,t.trackable,r)}),e.bindAction("adjust-via-drag",n=>{n.stopPropagation();let r=n.detail.screenX,s=n.detail.screenY,o=t.trackable.value.range,l=o,c=r,u=s;zn(n.detail,f=>{const g=t.trackable.value.range,v=f.screenX,y=f.screenY;Mr(t.dataType,g,l)||(o=g,r=c,s=u),q$(t.dataType,t.trackable,o,(y-s)*2/screen.height,(v-r)*4/screen.width),l=t.trackable.value.range,c=v,u=y})}),e.bindAction("invert-range",n=>{n.stopPropagation(),WT(t.trackable)})}}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function dd(i){return{makeControl:(e,t)=>{const n=i(e),r=t.registerDisposer(new As(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bj=vt.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function YT(i){return{makeControl:(e,t)=>{const n=i(e),r=t.registerDisposer(new Ay(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(bj),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustHueViaWheel(n.detail)})}}}class Sj extends K{constructor(e,{min:t=0,max:n=1,step:r=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");let s=this.element,o=this.inputElement,l=this.numericInputElement;s.className="range-slider";const c=f=>{f.min=""+t,f.max=""+n,f.step=""+r,f.valueAsNumber=this.value.value,this.registerEventListener(f,"change",()=>this.inputValueChanged(f)),this.registerEventListener(f,"input",()=>this.inputValueChanged(f)),this.registerEventListener(f,"wheel",g=>{this.adjustViaWheel(f,g)})};o.type="range",c(o),l.type="number";const u=Math.max(t.toString().length,n.toString().length,Math.min(n,t+r).toString().length,Math.max(t,n-r).toString().length);l.style.width=u+2+"ch",c(l),s.appendChild(o),s.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){const n=this.inputElement;let r=t.deltaY;r>0?(n.stepUp(),this.inputValueChanged(e)):r<0&&(n.stepDown(),this.inputValueChanged(e))}disposed(){Bt(this.element),super.disposed()}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wj=vt.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function ms(i){return{makeControl:(e,t)=>{var n=i(e);const r=n.value,s=n.options,o=t.registerDisposer(new Sj(r,s));return{control:o,controlElement:o.element}},activateTool:(e,t)=>{e.bindInputEventMap(wj),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(t.inputElement,n.detail)})}}}function Mx(i,e){const t=i.shaderControlState,n=t.state.get(e);if(n===void 0)return;const r=n.control;switch(r.type){case"slider":return ms(()=>({value:n.trackable,options:{min:r.min,max:r.max,step:r.step}}));case"color":return YT(()=>n.trackable);case"checkbox":return dd(()=>n.trackable);case"invlerp":{let o=0;for(const l of t.state){var s=oe(l,2);const c=s[0],u=s[1].control.type;if(c===e)break;u==="invlerp"&&++o}return yj(()=>({dataType:r.dataType,defaultChannel:r.default.channel,watchableValue:n.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:o,legendShaderOptions:i.legendShaderOptions}))}}}function KT(i,e,t){return{label:t,toolJson:Cj(t,e),makeControl:(n,r,s)=>{const o=i(n);return Mx(o,t).makeControl(n,r,s)},activateTool:(n,r)=>{const s=i(n.tool.layer);return Mx(s,t).activateTool(n,r)}}}class t0 extends qr{constructor(e,t,n,r={}){super(r.visibility),this.state=e,this.display=t,this.layer=n,this.options=r,this.controlDisposer=void 0;var s=r.toolId;const o=s===void 0?XT:s;this.toolId=o;const l=this.element;l.style.display="contents";const c=e.controls;this.registerDisposer(c.changed.add(this.registerCancellable(ct(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){const e=this.element;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),nt(e));const t=this.controlDisposer=new K,n=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(const r of this.state.state.keys())e.appendChild(Xy(t,this.layer,this.visibility,KT(n,this.toolId,r)))}disposed(){var e;(e=this.controlDisposer)===null||e===void 0||e.dispose(),super.disposed()}}const XT="shaderControl",QT="control";function Cj(i,e){return{type:e,[QT]:i}}class xj extends ZT{constructor(e,t,n,r){super(e,KT(()=>t,n,r)),this.layerShaderControls=t,this.control=r,this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable(ct(()=>{t.shaderControlState.state.get(r)===void 0&&this.unbind()}))))}activate(e){this.layerShaderControls.shaderControlState.state.get(this.control)!==void 0&&super.activate(e)}}function i0(i,e,t=XT){Dd(i,t,(n,r)=>{const s=Y(r,QT,Ie);return new xj(n,e(n),t,s)})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function eD(i){return new e0({fragmentMain:i.displayState.skeletonRenderingOptions.shader,shaderError:i.displayState.shaderError,shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState})}class Ej extends qr{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segmentation-rendering-tab");{const r=this.registerDisposer(new Ax(e.displayState.linkedSegmentationGroup));r.label.textContent="Linked to: ",t.appendChild(r.element)}{const r=this.registerDisposer(new Ax(e.displayState.linkedSegmentationColorGroup));r.label.textContent="Colors linked to: ",t.appendChild(r.element)}for(const r of r0)t.appendChild(Xy(this,e,this.visibility,r));const n=this.registerDisposer(new cr(e.hasSkeletonsLayer,(r,s,o)=>{if(!r)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(Qy({title:"Show larger editor view",onClick:()=>{new Lj(this.layer)}})),l.appendChild(Ky({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),s.appendChild(l);const u=o.registerDisposer(eD(this.layer));s.appendChild(u.element),s.appendChild(o.registerDisposer(new t0(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:n0})).element),u.textEditor.refresh()},this.visibility));t.appendChild(n.element)}}let Lj=class extends dp{constructor(i){super(),this.layer=i,this.codeWidget=this.registerDisposer(eD(this.layer)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var kj=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s},Om;let Bm=Om=class extends Rh{constructor(){super(...arguments),this.hashTable=new oy,this.changed=new at}get value(){return this}static makeWithCounterpart(i){let e=new Om;return e.initializeCounterpart(i),e}set_(i,e){return this.hashTable.set(i,e)}set(i,e){if(this.set_(i,e)){let t=this.rpc;t&&t.invoke("Uint64Map.set",{id:this.rpcId,key:i,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}get(i,e){return this.hashTable.get(i,e)}[Wi](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(i){return this.hashTable.delete(i)}delete(i){if(this.delete_(i)){let e=this.rpc;e&&e.invoke("Uint64Map.delete",{id:this.rpcId,key:i}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}assignFrom(i){this.clear();for(const t of i.unsafeEntries()){var e=oe(t,2);const n=e[0],r=e[1];this.set(n,r)}}clear(){if(this.hashTable.clear()){let i=this.rpc;i&&i.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let i={};for(let t of this.hashTable.unsafeEntries()){var e=oe(t,2);let n=e[0],r=e[1];i[n.toString()]=r.toString()}return i}};Bm=Om=kj([Nh("Uint64Map")],Bm);_t("Uint64Map.set",function(i){let e=this.get(i.id);e.set_(i.key,i.value)&&e.changed.dispatch()});_t("Uint64Map.delete",function(i){let e=this.get(i.id);e.delete_(i.key)&&e.changed.dispatch()});_t("Uint64Map.clear",function(i){let e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ij=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s},_m;let rh=_m=class extends Rh{constructor(){super(...arguments),this.hashTable=new Lk,this.changed=new at}get value(){return this}static makeWithCounterpart(i){let e=new _m;return e.initializeCounterpart(i),e}set(i,e){e?this.add(i):this.delete(i)}reserve_(i){return this.hashTable.reserve(i)}reserve(i){if(this.reserve_(i)){let e=this.rpc;e&&e.invoke("Uint64Set.reserve",{id:this.rpcId,value:i})}}add_(i){let e=!1;for(const t of i)e=this.hashTable.add(t)||e;return e}add(i){const e=Array().concat(i);if(this.add_(e)){let t=this.rpc;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}[Wi](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(i){let e=!1;for(const t of i)e=this.hashTable.delete(t)||e;return e}delete(i){const e=Array().concat(i);if(this.delete_(Array().concat(i))){let t=this.rpc;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let i=this.rpc;i&&i.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let i=new Array;for(let e of this.unsafeKeys())i.push(e.toString());return i.sort(),i}assignFrom(i){this.clear();for(const e of i.unsafeKeys())this.add(e)}};rh=_m=Ij([Nh("Uint64Set")],rh);_t("Uint64Set.reserve",function(i){let e=this.get(i.id);e.reserve_(i.value)&&e.changed.dispatch()});_t("Uint64Set.add",function(i){let e=this.get(i.id);e.add_(i.value)&&e.changed.dispatch()});_t("Uint64Set.delete",function(i){let e=this.get(i.id);e.delete_(i.value)&&e.changed.dispatch()});_t("Uint64Set.clear",function(i){let e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tj=vt.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function tD(i){return{makeControl:(e,t)=>{const n=i(e),r=t.registerDisposer(new BI(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(Tj),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(n.detail)})}}}const Dj=200,Rx=vt.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function Pj(i){if(i<1||i>1024){const e=Yi(i)|0,t=i/2**e;return`${SI(t,1)}p${e}`}return Math.round(i)+""}class Fm extends K{constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new gt(void 0),this.throttledUpdateView=this.registerCancellable(Uh(()=>this.debouncedUpdateView(),Dj,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable(ct(()=>this.updateView(),0));const n=this.canvas,r=this.label,s=this.element,o=this.legend,l=this.legendRenderScale,c=this.legendSpatialScale,u=this.legendChunks;r.className="neuroglancer-render-scale-widget-prompt",s.className="neuroglancer-render-scale-widget",s.title=Rx.describe(),o.className="neuroglancer-render-scale-widget-legend",s.appendChild(r),s.appendChild(n),s.appendChild(o),l.title="Target resolution of data in screen pixels",u.title="Number of chunks rendered",o.appendChild(l),o.appendChild(u),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new Zr(n,Rx)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));const f=v=>{const y=v.offsetX/n.width*oi;return j_(y)};this.registerEventListener(n,"pointermove",v=>{this.hoverTarget.value=[f(v),v.offsetY]}),this.registerEventListener(n,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(Se(n,"set",v=>{this.target.value=f(v.detail)})),this.registerDisposer(Se(n,"adjust-via-wheel",v=>{this.adjustViaWheel(v.detail)})),this.registerDisposer(Se(n,"reset",v=>{this.reset(),v.preventDefault()}));const g=new ResizeObserver(()=>this.debouncedUpdateView());g.observe(n),this.registerDisposer(()=>g.disconnect()),this.updateView()}adjustViaWheel(e){const t=e.deltaY;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**Ed(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){const e=this.ctx,t=this.canvas,n=t.width=t.offsetWidth,r=t.height=t.offsetHeight,s=this.target.value,o=this.hoverTarget.value;{const D=this.legendRenderScale,T=o===void 0?s:o[0],A=Pj(T);D.textContent=A+" px"}function l(D){return D*n/oi}e.clearRect(0,0,n,r);const c=this.histogram,u=c.value,f=c.spatialScales;c.visibility.visible||u.fill(0);const g=Te(f.keys());g.sort();const v=Ne();let y=1;const C=f.size;let w=0,S=0;for(let D=0;D<oi;++D){let T=0;for(let A=0;A<C;++A){const V=A*oi*2+D,O=u[V],_=u[V+oi];w+=O,S+=_,T+=O+_}y=Math.max(T,y)}const L=r/Math.log(1+y);function I(D){return r-Math.log(1+D)*L}let M;if(o!==void 0){const D=Math.floor(fu(o[0]));if(D>=0&&D<oi){let T=0;const A=o[1];for(let V=C-1;V>=0;--V){const O=g[V],_=2*f.get(O)*oi+D,H=u[_]+u[_+oi];if(H===0)continue;const U=Math.round(I(T));if(T+=H,Math.round(I(T))<=A&&A<=U){M=O;break}}}}if(M!==void 0){w=0,S=0;const D=2*f.get(M)*oi;for(let T=0;T<oi;++T){const A=D+T;w+=u[A],S+=u[A+oi]}kt(M)?this.legendSpatialScale.textContent=la(M,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${w}/${w+S}`;const R=g.map(D=>{const T=D===M?.5:1;let A;kt(D)?A=(Yi(D)*.1%1+1)%1:A=0,Wu(v,A,T,1);const V=Gi(v);Wu(v,A,T,.5);const O=Gi(v);return[V,O]});for(let D=0;D<oi;++D){let T=0;for(let A=C-1;A>=0;--A){const V=g[A],O=f.get(V)*oi*2+D,_=u[O],H=u[O+oi],U=_+H;if(U===0)continue;const B=Math.round(l(D)),W=Math.round(l(D+1)),F=Math.round(I(T));T+=U;const le=Math.round(I(T)),de=(_*le+H*F)/U;e.fillStyle=R[A][1],e.fillRect(B,le,W-B,de-le),e.fillStyle=R[A][0],e.fillRect(B,de,W-B,F-de)}}{const D=s;e.fillStyle="#fff";const T=l(fu(D));e.fillRect(Math.floor(T),0,1,r)}if(o!==void 0){const D=o[0];e.fillStyle="#888";const T=l(fu(D));e.fillRect(Math.floor(T),0,1,r)}}}const Aj=vt.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function sh(i){return{makeControl:(e,t)=>{var n=i(e);const r=n.histogram,s=n.target,o=t.registerDisposer(new Fm(r,s));return{control:o,controlElement:o.element}},activateTool:(e,t)=>{e.bindInputEventMap(Aj),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(n.detail)}),e.bindAction("reset",n=>{n.stopPropagation(),n.preventDefault(),t.reset()})}}}const Mj="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0icm90YXRlSWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0icm90YXRlSWNvblRpdGxlIj5Sb3RhdGU8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0yMiAxMmwtMyAzLTMtMyIvPgogICAgPHBhdGggZD0iTTIgMTJsMy0zIDMgMyIvPgogICAgPHBhdGggZD0iTTE5LjAxNiAxNHYtMS45NUE3LjA1IDcuMDUgMCAwIDAgOCA2LjIyIi8+CiAgICA8cGF0aCBkPSJNMTYuMDE2IDE3Ljg0NUE3LjA1IDcuMDUgMCAwIDEgNSAxMi4wMTVWMTAiLz4KICAgIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTUgMTBWOSIvPgogICAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBkPSJNMTkgMTV2LTEiLz4KPC9zdmc+";function ah(i,e){e?i.displayState.segmentDefaultColor.value=bt(1,0,0):i.displayState.segmentDefaultColor.value=void 0}function Rj(){const i=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:n})=>{const r=document.createElement("input");r.type="radio",r.addEventListener("change",()=>{ah(e,!r.checked)}),n.prepend(r);const s=document.createElement("div");s.classList.add("neuroglancer-segmentation-color-seed-control");const o=t.registerDisposer(new zI(e.displayState.segmentColorHash));s.appendChild(o.element);const l=Lt({svg:Mj,title:"Randomize",onClick:()=>i(e)});return s.appendChild(l),t.registerDisposer(Or(c=>{const u=c===void 0;s.style.visibility=u?"":"hidden",r.checked=u},e.displayState.segmentDefaultColor)),{controlElement:s,control:o}},activateTool:e=>{const t=e.tool.layer;ah(t,!1),i(t)}}}function Nj(){const i=YT(e=>e.displayState.segmentDefaultColor);return j(j({},i),{makeControl:(e,t,n)=>{const r=i.makeControl(e,t,n),s=r.controlElement,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{ah(e,o.checked),o.checked&&s.click()}),n.labelTextContainer.prepend(o),t.registerDisposer(Or(l=>{const c=l!==void 0;s.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),r},activateTool:(e,t)=>{ah(e.tool.layer,!0),i.activateTool(e,t)}})}const Um="selectedAlpha",zm="notSelectedAlpha",Gm="objectAlpha",Wm="saturation",$m="hideSegmentZero",jm="baseSegmentColoring",Hm="ignoreNullVisibleSet",Vj="mesh",Oj="skeletons",Nx="segments",oh="equivalences",Jm="colorSeed",Vx="segmentColors",Zm="meshRenderScale",qm="crossSectionRenderScale",lh="skeletonRendering",Bj="skeletonShader",Ox="segmentQuery",Ym="meshSilhouetteRendering",Bx="linkedSegmentationGroup",_x="linkedSegmentationColorGroup",Km="segmentDefaultColor",Fx="anchorSegment",n0="skeletonShaderControl";class iD extends K{constructor(e){super(),this.layer=e,this.specificationChanged=new at,this.localGraph=new zW,this.visibleSegments=this.registerDisposer(rh.makeWithCounterpart(this.layer.manager.rpc)),this.segmentPropertyMap=new gt(void 0),this.graph=new gt(void 0),this.segmentEquivalences=this.registerDisposer(Pd.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(wn(n=>n&&n.visibleSegmentEquivalencePolicy||Fn.MIN_REPRESENTATIVE,[this.graph])))),this.localSegmentEquivalences=!1,this.maxIdLength=new gt(1),this.hideSegmentZero=new Qt(!0,!0),this.segmentQuery=new ci("",Ie),this.temporaryVisibleSegments=this.layer.registerDisposer(rh.makeWithCounterpart(this.layer.manager.rpc)),this.temporarySegmentEquivalences=this.layer.registerDisposer(Pd.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=this.layer.registerDisposer(Di.make(this.layer.manager.rpc,!1)),this.useTemporarySegmentEquivalences=this.layer.registerDisposer(Di.make(this.layer.manager.rpc,!1));const t=this.specificationChanged;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){we(e,$m,t=>this.hideSegmentZero.restoreState(t)),we(e,oh,t=>{this.localGraph.restoreState(t)}),we(e,Nx,t=>{const n=this.segmentEquivalences,r=this.visibleSegments;He(t,s=>{let o=re.parseString(String(s),10);r.add(n.get(o))})}),we(e,Ox,t=>this.segmentQuery.restoreState(t))}toJSON(){const e={};e[$m]=this.hideSegmentZero.toJSON();let t=this.visibleSegments;t.size>0&&(e[Nx]=t.toJSON());let n=this.segmentEquivalences;return this.localSegmentEquivalences&&n.size>0&&(e[oh]=n.toJSON()),e[Ox]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}}class nD extends K{constructor(e){super(),this.layer=e,this.specificationChanged=new at,this.segmentColorHash=uy.getDefault(),this.segmentStatedColors=this.registerDisposer(new Bm),this.segmentDefaultColor=new tE;const t=this.specificationChanged;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){we(e,Jm,t=>this.segmentColorHash.restoreState(t)),we(e,Km,t=>this.segmentDefaultColor.restoreState(t)),we(e,Vx,t=>{let n=Th(t,s=>ma(String(s)));for(let s of n){var r=oe(s,2);let o=r[0],l=r[1];const c=re.parseString(String(o)),u=new re(Lu(l));this.segmentStatedColors.set(c,u)}})}toJSON(){const e={};e[Jm]=this.segmentColorHash.toJSON(),e[Km]=this.segmentDefaultColor.toJSON();const t=this.segmentStatedColors;if(t.size>0){const r=e[Vx]={};for(const s of t.unsafeEntries()){var n=oe(s,2);const o=n[0],l=n[1];r[o.toString()]=Gi(ia(l.low))}}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}}class Ux extends K{constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}get changed(){return this.linkedGroup.root.changed}get value(){const e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;const t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){const n=this.curGroupState;n!==void 0&&(t.assignFrom(n),n.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)===null||e===void 0||e.dispose()}}class _j{constructor(e){this.layer=e,this.segmentSelectionState=new Uk,this.selectedAlpha=td(.5),this.saturation=td(1),this.notSelectedAlpha=td(0),this.silhouetteRendering=new ci(0,Sv,0),this.objectAlpha=td(1),this.ignoreNullVisibleSet=new Qt(!0,!0),this.skeletonRenderingOptions=new SU,this.shaderError=Oh(),this.renderScaleHistogram=new Mo,this.renderScaleTarget=ca(1),this.selectSegment=this.layer.selectSegment,this.transparentPickEnabled=this.layer.pick,this.baseSegmentColoring=new Qt(!1,!1),this.filterBySegmentLabel=this.layer.filterBySegmentLabel,this.moveToSegment=t=>{this.layer.moveToSegment(t)},this.linkedSegmentationGroup=this.layer.registerDisposer(new lx(this.layer.manager.rootLayers,this.layer,t=>t instanceof Ai,t=>t.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new lx(this.layer.manager.rootLayers,this.layer,t=>t instanceof Ai,t=>t.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=this.layer.registerDisposer(new iD(this.layer)),this.originalSegmentationColorGroupState=this.layer.registerDisposer(new nD(this.layer)),e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new Ux(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new Ux(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new ou(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new Cf(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new Cf(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.segmentDefaultColor=this.layer.registerDisposer(new Cf(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.segmentQuery=this.layer.registerDisposer(new ou(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new ou(this.segmentationGroupState,t=>t.segmentPropertyMap))}}const Fj=Jy(al);class Ai extends Fj{constructor(e){super(e),this.sliceViewRenderScaleHistogram=new Mo,this.sliceViewRenderScaleTarget=ca(1),this.segmentQueryFocusTime=new gt(Number.NEGATIVE_INFINITY),this.selectSegment=(t,n)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=t.clone(),!0),n)},this.filterBySegmentLabel=t=>{const n=ua(this.displayState,t).label;n&&this.filterSegments(n)},this.filterSegments=t=>{this.displayState.segmentationGroupState.value.segmentQuery.value=t,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer},this.displayState=new _j(this),this.anchorSegment=new ci(void 0,t=>t===void 0?void 0:re.parseString(t)),this.has2dLayer=this.registerDisposer(nr(t=>t.some(n=>n instanceof lg),{changed:this.layersChanged,value:this.renderLayers})),this.has3dLayer=this.registerDisposer(nr(t=>t.some(n=>n instanceof vC||n instanceof Zf||n instanceof qf||n instanceof CC),{changed:this.layersChanged,value:this.renderLayers})),this.hasSkeletonsLayer=this.registerDisposer(nr(t=>t.some(n=>n instanceof qf),{changed:this.layersChanged,value:this.renderLayers})),this.registerDisposer(Co((t,n)=>{t.registerDisposer(n.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(Co((t,n)=>{t.registerDisposer(n.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new Ej(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new hj(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return _o(this.displayState,e)}get volumeOptions(){return{volumeType:Ii.SEGMENTATION}}activateDataSubsources(e){const t=[],n=this.displayState.linkedSegmentationGroup.root.value===this;let r;for(const o of e){if(this.addStaticAnnotations(o))continue;var s=o.subsourceEntry.subsource;const l=s.volume,c=s.mesh,u=s.segmentPropertyMap,f=s.segmentationGraph,g=s.local;if(l instanceof Ns){switch(l.dataType){case J.FLOAT32:o.deactivate("Data type not compatible with segmentation layer");continue}o.activate(()=>o.addRenderLayer(new lg(l,j(j({},this.displayState),{transform:o.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition}))),this.displayState.segmentationGroupState.value)}else c!==void 0?o.activate(()=>{const v=j(j({},this.displayState),{transform:o.getRenderLayerTransform()});if(c instanceof Kd)o.addRenderLayer(new vC(this.manager.chunkManager,c,v));else if(c instanceof Xh)o.addRenderLayer(new Zf(this.manager.chunkManager,c,v));else{const y=new wU(this.manager.chunkManager,c,v);o.addRenderLayer(new qf(y.addRef())),o.addRenderLayer(new CC(y))}},this.displayState.segmentationGroupState.value):u!==void 0?n?(o.activate(()=>{}),t.push(u)):o.deactivate("Not supported on non-root linked segmentation layers"):f!==void 0?n?r!==void 0?o.deactivate("Only one segmentation graph is supported"):(r=f,o.activate(v=>{this.graphConnection=v.registerDisposer(f.connect(this.displayState.segmentationGroupState.value));const y=j(j({},this.displayState),{transform:o.getRenderLayerTransform()}),C=this.graphConnection.createRenderLayers(this.manager.chunkManager,y,this.localPosition);for(const w of C)o.addRenderLayer(w)})):o.deactivate("Not supported on non-root linked segmentation layers"):g===zr.equivalences?n?r!==void 0?o.deactivate("Only one segmentation graph is supported"):(r=this.displayState.originalSegmentationGroupState.localGraph,o.activate(v=>{this.graphConnection=v.registerDisposer(r.connect(this.displayState.segmentationGroupState.value)),v.registerDisposer(()=>{this.graphConnection=void 0})})):o.deactivate("Not supported on non-root linked segmentation layers"):o.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=IW(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=r}getLegacyDataSourceSpecifications(e,t,n,r){const s=super.getLegacyDataSourceSpecifications(e,t,n,r),o=we(t,Vj,c=>c===null?null:Ie(c)),l=we(t,Oj,c=>c===null?null:Ie(c));if(o!==void 0||l!==void 0)for(const c of s)c.enableDefaultSubsources=!1,c.subsources=new ue([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&s.push(ad(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&s.push(ad(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[oh]!==void 0&&r.find(c=>c.url===em)===void 0&&s.push({url:em,enableDefaultSubsources:!0,transform:{outputSpace:Lo,sourceRank:0,transform:void 0,inputSpace:Lo},subsources:new ue}),s}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[Um]),this.displayState.saturation.restoreState(e[Wm]),this.displayState.notSelectedAlpha.restoreState(e[zm]),this.displayState.objectAlpha.restoreState(e[Gm]),this.displayState.baseSegmentColoring.restoreState(e[jm]),this.displayState.silhouetteRendering.restoreState(e[Ym]),this.displayState.ignoreNullVisibleSet.restoreState(e[Hm]);const t=this.displayState.skeletonRenderingOptions;t.restoreState(e[lh]);const n=e[Bj];n!==void 0&&t.shader.restoreState(n),this.displayState.renderScaleTarget.restoreState(e[Zm]),this.anchorSegment.restoreState(e[Fx]),this.sliceViewRenderScaleTarget.restoreState(e[qm]);const r=we(e,Bx,Ie);r!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(r);const s=we(e,_x,o=>o===!1?void 0:Ie(o),r);s!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(s),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var e;const t=super.toJSON();t[Um]=this.displayState.selectedAlpha.toJSON(),t[zm]=this.displayState.notSelectedAlpha.toJSON(),t[Wm]=this.displayState.saturation.toJSON(),t[Gm]=this.displayState.objectAlpha.toJSON(),t[jm]=this.displayState.baseSegmentColoring.toJSON(),t[Hm]=this.displayState.ignoreNullVisibleSet.toJSON(),t[Ym]=this.displayState.silhouetteRendering.toJSON(),t[Fx]=this.anchorSegment.toJSON(),t[lh]=this.displayState.skeletonRenderingOptions.toJSON(),t[Zm]=this.displayState.renderScaleTarget.toJSON(),t[qm]=this.sliceViewRenderScaleTarget.toJSON();var n=this.displayState;const r=n.linkedSegmentationGroup,s=n.linkedSegmentationColorGroup;return t[Bx]=r.toJSON(),s.root.value!==r.root.value&&(t[_x]=(e=s.toJSON())!==null&&e!==void 0?e:!1),t[oh]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),r.root.value===this&&j(t,this.displayState.segmentationGroupState.value.toJSON()),s.root.value===this&&j(t,this.displayState.segmentationColorGroupState.value.toJSON()),t}transformPickedValue(e){return e==null?e:gy(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;const n=this.displayState.segmentSelectionState;if(n.hasSelectedSegment){const r=n.selectedSegment,s=this.displayState.segmentationGroupState.value.visibleSegments,o=!s.has(r);(o||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=o),t.defer(()=>{t.segmentationToggleSegmentState===o&&s.set(r,o)})}break}case"copy-segment-id":{if(!this.pick.value)break;const n=this.displayState.segmentSelectionState;if(n.hasSelectedSegment){const r=n.selectedSegment;this.copiedSegments=[r.clone()];const s=r.toString();on(s)&&tt.showTemporaryMessage(s+" copied to clipboard")}break}case"add-copy-segment-id":{if(!this.pick.value)break;const n=this.displayState.segmentSelectionState;if(n.hasSelectedSegment){const r=n.selectedSegment;this.copiedSegments.push(r.clone());const s=this.copiedSegments.map(o=>o.toString()).join(",");on(s)&&tt.showTemporaryMessage(s+" copied to clipboard")}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);const n=new re;let r=e.value;typeof r=="number"&&(r=r.toString()),typeof r!="string"||!n.tryParseString(r)?e.value=void 0:e.value=n}selectionStateToJson(e,t){const n=super.selectionStateToJson(e,t);let r=e.value;return r instanceof Gr?t?n.value={key:r.key.toString(),value:r.value?r.value.toString():void 0,label:r.label}:n.value=(r.value||r.key).toString():r instanceof re&&(n.value=r.toString()),n}displaySegmentationSelection(e,t,n){const r=e.value;let s;if((typeof r=="number"||typeof r=="string")&&(s=new re,!s.tryParseString(r.toString())))return!1;if(r instanceof re)s=r.clone();else if(r instanceof Gr)s=r.key.clone();else return!1;const o=this.displayState,l=ua(o,s);var c=this.displayState.segmentationGroupState.value;const u=c.segmentEquivalences,f=c.segmentPropertyMap.value,g=u.get(s),v=Zh(this.displayState,l);if(il(o,n,n.redraw),n.registerDisposer(_o(o,v)),v.classList.add("neuroglancer-selection-details-segment"),t.appendChild(v),f!==void 0){const y=f.segmentPropertyMap.inlineProperties;if(y!==void 0){const C=f.getSegmentInlineIndex(g);if(C!==-1){for(const w of y.properties)if(w.type!=="label"){if(w.type==="description"){const S=w.values[C];if(!S)continue;const L=document.createElement("div");L.classList.add("neuroglancer-selection-details-segment-description"),L.textContent=S,t.appendChild(L)}else if(w.type==="number"||w.type==="string"){const S=w.values[C];if(w.type==="number"?isNaN(S):!S)continue;const L=document.createElement("div");L.classList.add("neuroglancer-selection-details-segment-property");const I=document.createElement("div");I.classList.add("neuroglancer-selection-details-segment-property-name"),I.textContent=w.id,w.description&&(I.title=w.description);const M=document.createElement("div");M.classList.add("neuroglancer-selection-details-segment-property-value"),M.textContent=S.toString(),L.appendChild(I),L.appendChild(M),t.appendChild(L)}}}}}return!0}displaySelectionState(e,t,n){let r=this.displaySegmentationSelection(e,t,n);return super.displaySelectionState(e,t,n)&&(r=!0),r}moveToSegment(e){for(const n of this.renderLayers){if(!(n instanceof Zf))continue;const r=n.getObjectPosition(e);if(r!==void 0){this.setLayerPosition(n.displayState.transform.value,r);return}}let t=!1;for(const n of this.renderLayers)if(n instanceof lg){const r=n.multiscaleSource;r.getSegmentPosition&&(t=!0,r.getSegmentPosition(e).then(s=>{this.setLayerPosition(null,s)}).catch(s=>{tt.showTemporaryMessage(`Failed to retrieve position for segment ${e}: ${s}`)}))}t||tt.showTemporaryMessage(`No position information loaded for segment ${e}`)}}Ai.type="segmentation";Ai.typeAbbreviation="seg";Ai.supportsPickOption=!0;const Uj=10;function zx(i){return[j({label:`Skeleton mode (${i})`,toolJson:`${lh}.mode${i}`,isValid:e=>e.hasSkeletonsLayer},tD(e=>e.displayState.skeletonRenderingOptions[`params${i}`].mode)),j({label:`Line width (${i})`,toolJson:`${lh}.lineWidth${i}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${i})`,title:`Skeleton line width (${i})`},ms(e=>({value:e.displayState.skeletonRenderingOptions[`params${i}`].lineWidth,options:{min:1,max:40,step:1}})))]}const r0=[j({label:"Color seed",title:"Color segments based on a hash of their id",toolJson:Jm},Rj()),j({label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:Km},Nj()),j({label:"Saturation",toolJson:Wm,title:"Saturation of segment colors"},ms(i=>({value:i.displayState.saturation}))),j({label:"Opacity (on)",toolJson:Um,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are selected"},ms(i=>({value:i.displayState.selectedAlpha}))),j({label:"Opacity (off)",toolJson:zm,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are not selected"},ms(i=>({value:i.displayState.notSelectedAlpha}))),j({label:"Resolution (slice)",toolJson:qm,isValid:i=>i.has2dLayer},sh(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))),j({label:"Resolution (mesh)",toolJson:Zm,isValid:i=>i.has3dLayer},sh(i=>({histogram:i.displayState.renderScaleHistogram,target:i.displayState.renderScaleTarget}))),j({label:"Opacity (3d)",toolJson:Gm,isValid:i=>i.has3dLayer,title:"Opacity of meshes and skeletons"},ms(i=>({value:i.displayState.objectAlpha}))),j({label:"Silhouette (3d)",toolJson:Ym,isValid:i=>i.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction"},ms(i=>({value:i.displayState.silhouetteRendering,options:{min:0,max:Uj,step:.1}}))),j({label:"Hide segment ID 0",toolJson:$m,title:"Disallow selection and display of segment id 0"},dd(i=>i.displayState.hideSegmentZero)),j({label:"Base segment coloring",toolJson:jm,title:"Color base segments individually"},dd(i=>i.displayState.baseSegmentColoring)),j({label:"Show all by default",title:"Show all segments if none are selected",toolJson:Hm},dd(i=>i.displayState.ignoreNullVisibleSet)),...zx("2d"),...zx("3d")];for(const i of r0)qT(Ai,i);ol(Ai);eT(Ii.SEGMENTATION,Ai);Vy(i=>{if(i.mesh!==void 0)return{layerConstructor:Ai,priority:1}});i0(Ai,i=>({shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState}),n0);tj();rj();const zj=Object.freeze(Object.defineProperty({__proto__:null,LAYER_CONTROLS:r0,SKELETON_RENDERING_SHADER_CONTROL_TOOL_ID:n0,SegmentationUserLayer:Ai,SegmentationUserLayerColorGroupState:nD,SegmentationUserLayerGroupState:iD},Symbol.toStringTag,{value:"Module"}));/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gj extends K{constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);const t=this.element,n=this.selectElement;t.appendChild(n),this.updateView(),this.registerEventListener(n,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add(ct(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){const e=this.selectElement,t=this.ref,n=t.filter;nt(e);const r=document.createElement("option");e.appendChild(r);for(const s of this.ref.layerManager.managedLayers)if(n(s)){const o=document.createElement("option"),l=s.name;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}}const Wj="points",cg="annotations",Gx="annotationProperties",Wx="annotationRelationships",$x="crossSectionAnnotationSpacing",jx="projectionAnnotationSpacing",Hx="shader",Jx="shaderControls";function $j(i,e){e!==void 0&&He(e,(t,n)=>{i.add({type:Me.POINT,id:""+n,point:fE(t),properties:[]})})}function jj(i){const e=i.layer;return e===null||e instanceof Ai}function Hj(i){if(i===void 0)return null;const e=i.layer;return e===null||!(e instanceof Ai)?null:e.displayState}const Zx="linkedSegmentationLayer",qx="filterBySegmentation",Yx="ignoreNullSegmentFilter";class Jj extends K{constructor(e,t,n){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=n,this.changed=new xe,this.curGeneration=-1,this.wasLoading=void 0,this.map=new ue,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){const e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;const n=this.map;let r=!1;for(const o of this.annotationStates.relationships){let l=n.get(o);l===void 0&&(l=this.addRelationship(o),r=!0),l.seenGeneration=e}if(!t)for(const o of n){var s=oe(o,2);const l=s[0];s[1].seenGeneration!==e&&(n.delete(l),r=!0)}r&&this.changed.dispatch()}addRelationship(e){const t=this.annotationDisplayState.relationshipStates.get(e),n=new cW(this.layerManager.addRef(),jj);n.registerDisposer(n.changed.add(()=>{t.segmentationState.value=n.layerName===void 0?void 0:Hj(n.layer)}));const r=t.showMatches,s={layerRef:n,showMatches:r,seenGeneration:-1};return n.changed.add(this.changed.dispatch),r.changed.add(this.changed.dispatch),this.map.set(e,s),s}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(const e of this.map.values())e.showMatches.reset()}toJSON(){const e=this.map;if(e.size===0)return{};let t;const n=[];for(const s of e){var r=oe(s,2);const o=r[0],l=r[1];l.showMatches.value&&n.push(o);const c=l.layerRef.layerName;c!==void 0&&((t=t||{})[o]=c)}return n.sort(),{[Zx]:t,[qx]:n.length===0?void 0:n}}restoreState(e){const t=this.annotationStates.isLoading;we(e,Zx,n=>{typeof n=="string"&&(n={segments:n}),ge(n);for(const s of di(n)){const o=Ie(n[s]);let l=this.map.get(s);if(l===void 0){if(!t)continue;l=this.addRelationship(s)}l.layerRef.layerName=o}for(const s of this.map){var r=oe(s,2);const o=r[0],l=r[1];Object.prototype.hasOwnProperty.call(n,o)||(l.layerRef.layerName=void 0)}}),we(e,qx,n=>{typeof n=="boolean"&&(n=n===!0?["segments"]:[]);for(const r of Sn(n)){let s=this.map.get(r);if(s===void 0){if(!t)continue;s=this.addRelationship(r)}s.showMatches.value=!0}})}disposed(){const e=this.map;for(const t of e.values())this.unbind(t);e.clear(),super.disposed()}}class Zj extends K{constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;const n=this.element,r=this.registerDisposer(new As(t.showMatches)),s=new Gj(t.layerRef);n.appendChild(r.element),n.appendChild(document.createTextNode(e)),n.appendChild(s.element)}}class qj extends K{constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new ue,this.element=document.createElement("div"),this.element.style.display="contents";const t=this.registerCancellable(wt(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){const e=this.linkedSegmentationLayers,t=e.annotationStates,n=t.changed.count,r=this.widgets;function*s(){for(const l of t.relationships){let c=r.get(l);c===void 0&&(c=new Zj(l,e.get(l))),c.seenGeneration=n,yield c.element}}for(const l of r){var o=oe(l,2);const c=o[0],u=o[1];u.seenGeneration!==n&&(u.dispose(),r.delete(c))}sr(this.element,s.call(this))}disposed(){super.disposed();for(const e of this.widgets.values())e.dispose()}}const Yj=Jy(al);class Ls extends Yj{constructor(e){super(e),this.annotationProperties=new gt(void 0),this.localAnnotationsJson=void 0,this.pointAnnotationsJson=void 0,this.linkedSegmentationLayers=this.registerDisposer(new Jj(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState)),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new Xj(this)}),this.tabs.default="annotations",this.allowingRefresh=!0}disposed(){const e=this.localAnnotations;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[cg],this.localAnnotationProperties=we(e,Gx,SE),this.localAnnotationRelationships=we(e,Wx,Sn,["segments"]),this.pointAnnotationsJson=e[Wj],this.annotationCrossSectionRenderScaleTarget.restoreState(e[$x]),this.annotationProjectionRenderScaleTarget.restoreState(e[jx]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[Yx]),this.annotationDisplayState.shader.restoreState(e[Hx]),this.annotationDisplayState.shaderControls.restoreState(e[Jx])}getLegacyDataSourceSpecifications(e,t,n,r){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,n,r);const s=we(t,"voxelSize",l=>st(new Float64Array(3),l,c=>gi(c)/1e9)),o=["m","m","m"];if(s!==void 0){const l=mt({rank:3,units:o,scales:s,names:["x","y","z"]});n===void 0?n={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:n=j(j({},n),{inputSpace:l})}return[{url:sk,transform:n,enableDefaultSubsources:!0,subsources:new ue}]}activateDataSubsources(e){var t;let n=!1,r;for(const o of e){const l=o.subsourceEntry,c=l.subsource.local,u=g=>r!==void 0&&rn(g)!==rn(r)?(o.deactivate("Annotation properties are not compatible"),!1):(r=g,!0);if(c===zr.annotations){if(n){o.deactivate("Only one local annotations source per layer is supported");continue}if(n=!0,!u((t=this.localAnnotationProperties)!==null&&t!==void 0?t:[]))continue;o.activate(g=>{var v;const y=this.localAnnotations=new hV(o.loadedDataSource.transform,(v=this.localAnnotationProperties)!==null&&v!==void 0?v:[],this.localAnnotationRelationships);try{y.restoreState(this.localAnnotationsJson)}catch{}g.registerDisposer(()=>{y.dispose(),this.localAnnotations=void 0}),g.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{$j(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;const C=new Zg({localPosition:this.localPosition,transform:g.registerDisposer(FE(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,o.loadedDataSource.transform,void 0)),source:y.addRef(),displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:En.ANNOTATION});this.addAnnotationLayerState(C,o)});continue}const f=l.subsource.annotation;if(f!==void 0){if(!u(f.properties))continue;o.activate(()=>{const g=new Zg({localPosition:this.localPosition,transform:o.getRenderLayerTransform(),source:f,displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:En.ANNOTATION});this.addAnnotationLayerState(g,o)});continue}o.deactivate("Not compatible with annotation layer")}const s=this.annotationProperties.value;rn(s)!==rn(r)&&(this.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){const t=e.registerDisposer(nr(r=>r.some(s=>s.source instanceof Un),this.annotationStates)),n=e.registerDisposer(new cr(t,(r,s,o)=>{if(r){{const l=o.registerDisposer(new Fm(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",s.appendChild(l.element)}{const l=o.registerDisposer(new Fm(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",s.appendChild(l.element)}}}));e.element.insertBefore(n.element,e.element.firstChild);{const r=e.registerDisposer(new As(this.annotationDisplayState.ignoreNullSegmentFilter)),s=document.createElement("label");s.appendChild(document.createTextNode("Ignore null related segment filter")),s.title="Display all annotations if filtering by related segments is enabled but no segments are selected",s.appendChild(r.element),e.element.appendChild(s)}e.element.appendChild(e.registerDisposer(new qj(this.linkedSegmentationLayers)).element)}toJSON(){const e=super.toJSON();e[$x]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[jx]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[cg]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[cg]=this.localAnnotationsJson),e[Gx]=cV(this.localAnnotationProperties);const t=this.localAnnotationRelationships;return e[Wx]=t&&t.length===1&&t[0]==="segments"?void 0:t,e[Yx]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[Hx]=this.annotationDisplayState.shader.toJSON(),e[Jx]=this.annotationDisplayState.shaderControls.toJSON(),j(e,this.linkedSegmentationLayers.toJSON()),e}}Ls.type="annotation";Ls.typeAbbreviation="ann";function rD(i){return new e0({shaderError:i.annotationDisplayState.shaderError,fragmentMain:i.annotationDisplayState.shader,shaderControlState:i.annotationDisplayState.shaderControls})}let Kj=class extends dp{constructor(i){super(),this.layer=i,this.codeWidget=this.registerDisposer(rD(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},Xj=class extends qr{constructor(i){super(),this.layer=i,this.codeWidget=this.registerDisposer(rD(this.layer));const e=this.element;e.classList.add("neuroglancer-annotation-rendering-tab"),e.appendChild(this.registerDisposer(new cr(i.annotationProperties,(r,s)=>{if(r===void 0||r.length===0)return;const o=document.createElement("div");s.appendChild(o),o.classList.add("neuroglancer-annotation-shader-property-list");for(const l of r){const c=document.createElement("div");c.classList.add("neuroglancer-annotation-shader-property");const u=document.createElement("span");u.classList.add("neuroglancer-annotation-shader-property-type"),u.textContent=l.type;const f=document.createElement("span");f.classList.add("neuroglancer-annotation-shader-property-identifier"),f.textContent=`prop_${l.identifier}`,c.appendChild(u),c.appendChild(f);const g=l.description;g!==void 0&&(c.title=g),o.appendChild(c)}})).element);let t=document.createElement("div");t.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let n=document.createElement("div");n.style.flex="1",n.textContent="Annotation shader:",t.appendChild(n),t.appendChild(Qy({title:"Show larger editor view",onClick:()=>{new Kj(this.layer)}})),t.appendChild(Ky({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),e.appendChild(t),e.appendChild(this.codeWidget.element),e.appendChild(this.registerDisposer(new t0(i.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};ol(Ls);ol(Ls,"pointAnnotation");Vy(i=>{if(i.local===zr.annotations)return{layerConstructor:Ls,priority:100};if(i.annotation!==void 0)return{layerConstructor:Ls,priority:1}});i0(Ls,i=>({shaderControlState:i.annotationDisplayState.shaderControls}));const Qj=Object.freeze(Object.defineProperty({__proto__:null,AnnotationUserLayer:Ls},Symbol.toStringTag,{value:"Module"})),eH=Is(Qj),tH=Is(nU),iH=Is(zj),nH=Is(xN);function rH(i){i.registerEventListener(document,"copy",e=>{if(py(e.target))return;const t=document.getSelection();if(t!==null&&t.type==="Range")return;const n=Wh(i.state).value,r=e.clipboardData;r!==null&&r.setData("text/plain",se(n,void 0,"  ")),e.preventDefault()})}function sH(i,e){let t=Ql`^[\[\]{}()\s,]*`;for(let s=0;s<e;++s)s!==0&&(t+=Ql`[,\s]+`),t+=Ql`(\d+(?:\.\d+)?)`;t+=Ql`[\[\]{}()\s,]*$`;const n=i.match(t);if(n===null)return;const r=new Float32Array(e);for(let s=0;s<e;++s){const o=Number(n[s+1]);if(!kt(o))return;r[s]=o}return r}function aH(i){i.registerEventListener(document,"paste",e=>{if(py(e.target))return;const t=e.clipboardData;if(t!==null){const n=t.getData("text/plain"),r=sH(n,i.coordinateSpace.value.rank);r!==void 0&&(i.navigationState.position.value=r)}e.preventDefault()})}const Kx=ln("SingleTextureVolumeChunk.textureUnit"),su=ln("SingleTextureVolumeChunk.textureLayout");class sD extends K{constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",Kx)}beginDrawing(e,t){let n=t.textureUnit(Kx);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),t[su]=null}endDrawing(e,t){e.bindTexture(Jg[this.shaderSamplerType],null),t[su]=null}bindChunk(e,t,n,r,s,o,l){let c=n.textureLayout;(t[su]!==c||l)&&(t[su]=c,this.setupTextureLayout(e,t,c,r,s,o)),e.bindTexture(Jg[this.shaderSamplerType],n.texture)}beginSource(e,t){}}class aD extends TU{constructor(e,t){super(e,t),this.texture=null,this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture();const n=Jg[this.chunkFormat.shaderSamplerType];e.bindTexture(n,t),this.setTextureData(e),e.bindTexture(n,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let oH=class oD extends K{constructor(e,t,n){super(),this.chunkDataSize=t,this.textureDims=n,this.textureShape=new Uint32Array(this.textureDims);const r=t.length;let s=0;for(const g of t)g!==1&&++s;const o=this.strides=new Uint32Array(r*n),l=n===3?e.max3dTextureSize:e.maxTextureSize;let c=0,u=1;const f=this.textureShape;f.fill(1);for(let g=0;g<r;++g){const v=t[g];if(v===1)continue;const y=v*u;let C;y>l||u!==1&&c+s<n?(++c,u=v,C=1):(C=u,u=y),o[n*g+c]=C,f[c]=u}}static get(e,t,n){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${n}`,()=>new oD(e,t,n))}},ug=new Uint32Array(3*5),lH=class lD extends sD{constructor(e,t,n,r){super(n,t),this.textureDims=r,Yd(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${r}D`,this.textureAccessHelper=new LF("chunkData",r)}static get(e,t,n){const r=`sliceview.UncompressedChunkFormat:${t}:${n}`;return e.memoize.get(r,()=>new lD(e,t,r,n))}defineShader(e,t){super.defineShader(e,t);const n=this.textureDims,r=`ivec${this.textureDims}`;let s=this.textureAccessHelper;const o=(4+t)*n;ug.length<o&&(ug=new Uint32Array(o)),e.addUniform(`highp ${r}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(s.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let l=`
${wi(this.dataType)} getDataValueAt(highp ivec3 p`;for(let c=0;c<t;++c)l+=`, highp int channelIndex${c}`;l+=`) {
  highp ${r} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let c=0;c<t;++c)l+=`
  offset += channelIndex${c} * uVolumeChunkStrides[${4+c}];
`;l+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(l)}setupTextureLayout(e,t,n,r,s,o){const l=ug,c=o.length,u=n.strides,f=r.length,g=this.textureDims;for(let y=0;y<g;++y){let C=0;for(let w=0;w<f;++w)C+=r[w]*u[w*g+y];l[y]=C}for(let y=0;y<3;++y){const C=s[y];if(!(C>=f))for(let w=0;w<g;++w)l[(y+1)*g+w]=u[C*g+w]}for(let y=0;y<c;++y){const C=o[y];if(C===-1)l.fill(0,(4+y)*g,(4+y+1)*g);else for(let w=0;w<g;++w)l[(4+y)*g+w]=u[C*g+w]}const v=(4+c)*g;g===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,v):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,v)}getTextureLayout(e,t){return oH.get(e,t,this.textureDims)}setTextureData(e,t,n){const r=t.textureShape;(this.textureDims===3?xF:CF)(e,this,n,r[0],r[1],r[2])}};class dH extends aD{setTextureData(e){let t=this.source,n=t.chunkFormatHandler,r=n.chunkFormat,s;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=s=n.textureLayout.addRef():this.textureLayout=s=r.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,s,this.data)}getValueAt(e){let t=this.chunkFormat;const n=this.chunkDataSize;let r=0,s=1;const o=e.length;for(let u=0;u<o;++u)r+=s*e[u],s*=n[u];let l=t.dataType,c=this.data;switch(l){case J.UINT8:case J.INT8:case J.FLOAT32:case J.UINT16:case J.INT16:case J.UINT32:case J.INT32:return c[r];case J.UINT64:{let u=r*2;return new re(c[u],c[u+1])}}}}class cH extends K{constructor(e,t){super();let n=0;for(const r of t.chunkDataSize)r>1&&++n;this.chunkFormat=this.registerDisposer(lH.get(e,t.dataType,n>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new dH(e,t)}}tI((i,e)=>e.compressedSegmentationBlockSize==null?new cH(i,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function dD(i,e,t,n,r,s){let o=0,l=0,c=1,u=1;for(let w=0;w<3;++w){let S=r[w],L=n[w],I=Math.floor(S/L),M=S%L;o+=I*c,c*=Math.ceil(t[w]/L),l+=M*u,u*=L}let f=e+o*2,g=i[f],v=i[f+1],y=g&16777215,C=g>>24&255;if(C>0){let w=(e+v&16777215)+Math.floor(l*C/32),S=i[w],L=l*C%32,I=S>>L&(1<<C)-1;y+=s*I}return y}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uH(i,e,t,n,r){let s=dD(i,e,t,n,r,1)+e;return i[s]}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hH(i,e,t,n,r,s){let o=dD(e,t,n,r,s,2)+t;return i.low=e[o],i.high=e[o+1],i}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class s0 extends K{constructor(e,t){super(),this.chunkDataSize=e,this.subchunkSize=t;const n=this.subchunkGridSize=Ne();for(let r=0;r<3;++r)n[r]=Math.ceil(e[r]/t[r])}static get(e,t,n){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${Dg(t)},${Dg(n)}`,()=>new s0(t,n))}}const pH=Yd(new jh,J.UINT32);let hg=new Uint32Array(4*4);class a0 extends sD{constructor(e,t,n,r){super(r,e),this.subchunkSize=t,this.numChannels=n,this.textureAccessHelper=new cy("chunkData")}static get(e,t,n,r){let s=`sliceview.CompressedSegmentationChunkFormat:${t}:${r}`,o=`${s}:${Dg(n)}`;return e.memoize.get(o,()=>new a0(t,n,r,s))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);const n=4*(4+t);hg.length<n&&(hg=new Uint32Array(n));let r=this.textureAccessHelper;r.defineShader(e);let s=u=>"compressedSegmentationChunkFormat_"+u;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(RB);const o=this.dataType,l=wi(o);o===J.UINT64?e.addFragmentCode(Gt):e.addFragmentCode($v),e.addFragmentCode(r.getAccessor(s("readTextureValue"),"uVolumeChunkSampler",J.UINT32,1));let c=`
uint ${s("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${s("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let u=0;u<t;++u)c+=`, highp int channelIndex${u}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let u=0;u<t;++u)c+=`
  chunkPositionFull += channelIndex${u} * uVolumeChunkStrides[${4+u}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${s("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${s("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${s("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${s("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===J.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===J.UINT64?c+=`
  result.value[0] = ${s("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${s("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${s("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,n,r,s,o){const l=n.subchunkGridSize;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);const c=hg,u=o.length;c.fill(0);for(let f=0;f<3;++f){c[f]=r[f];const g=s[f];g!==-1&&(c[4*(f+1)+g]=1)}for(let f=0;f<u;++f){const g=o[f];g!==-1&&(c[4*(4+f)+g]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(u+4)*4)}setTextureData(e,t,n){dy(e,pH,n)}getTextureLayout(e,t){return s0.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);const n=this.subchunkSize;e.uniform3i(t.uniform("uSubchunkSize"),n[0],n[1],n[2])}}class fH extends aD{setTextureData(e){let t=this.data,n=this.chunkFormat,r=this.textureLayout=n.getTextureLayout(e,this.chunkDataSize);n.setTextureData(e,r,t)}getValueAt(e){let t=this.chunkDataSize,n=this.chunkFormat,r=this.data,s=r[e[3]||0];if(n.dataType===J.UINT64){let o=new re;return hH(o,r,s,t,n.subchunkSize,e),o}else return uH(r,s,t,n.subchunkSize,e)}}class gH extends K{constructor(e,t){super();let n=t.dataType;if(n!==J.UINT64&&n!==J.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${J[n]}`);this.chunkFormat=this.registerDisposer(a0.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new fH(e,t)}}tI((i,e)=>e.compressedSegmentationBlockSize!=null?new gH(i,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mH(i,e=document.getElementById("neuroglancer-container")){try{let t=new pO(e);return new X4(t,i)}catch(t){throw tt.showMessage(`Error: ${t.message}`),t}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vH(i=document){return Bn(i,"contextmenu",e=>{e.preventDefault()})}const o0="DVID";function cD(i){return i.text()}function yH(i,e=qt){const t=`${i.url}`,n={method:i.method,body:i.payload};return i.responseType===""?or(t,n,cD,e):i.responseType==="arraybuffer"?or(t,n,kI,e):or(t,n,jn,e)}function bH(i,e,t=qt){return SH(i,e.url,{method:e.method,body:e.payload},jn,t)}function SH(i,e,t,n,r=qt){return Ty(i,e,t,n,(s,o)=>{const l=j({},o);return s.token&&(l.headers=j(j({},l.headers),{Authorization:`Bearer ${s}`})),l},s=>{if(s.status===504)return"retry";throw s},r)}async function wH(i,e=qt){return{token:await or(i,{method:"GET",credentials:"include"},cD,e)}}class CH extends nc{constructor(e){super(),this.authServer=e,this.get=tp(t=>{if(!this.authServer)return Ot.resolve({token:""});const n=new tt(!0);let r;return new Ot((s,o)=>{const l=()=>{r=void 0,n.dispose()};t.add(()=>{r!==void 0&&(r.cancel(),r=void 0,n.dispose(),o(Es))});function c(f,g="DVID authorization required.",v="Request authorization."){n.setText(g+" ");let y=document.createElement("button");y.textContent=v,n.element.appendChild(y),y.addEventListener("click",()=>{let C=f.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(C){const w=`https://flyemlogin.${C[1]}/login`;window.alert(`Please log into ${w} and then refresh the neurogalncer page to try again.
If you are unable to log into ${w}, please check your authorization server ${f} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${f} to make sure it is correct.`)}),n.setVisible(!0)}function u(f){r!==void 0&&r.cancel(),r=new Ps,c(f,"Waiting for DVID authorization...","Retry"),wH(f,r).then(g=>{r!==void 0&&(l(),s(g))},g=>{r!==void 0&&(r=void 0,c(f,`DVID authorization failed: ${g}.`,"Retry"))})}u(this.authServer)})})}}class xH extends yz{constructor(e,t){super(new CH(t),{})}}/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */nl.register(o0,i=>new xH(i.dvidServer,i.authServer));/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const EH="CredentialsProvider",LH="CredentialsProvider.get";/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var kH=globalThis&&globalThis.__decorate||function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=Wn(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(o=i[l])&&(s=(r<3?o(s):r>3?o(e,t,s):o(e,t))||s);return r>3&&s&&Gn(e,t,s),s};let Xm=class extends ur{constructor(i,e){super(),this.provider=i,this.registerDisposer(i),this.initializeCounterpart(e)}get(i,e){return this.provider.get(i,e)}};Xm=kH([Ln(EH)],Xm);hL(LH,function(i,e){return this.get(i.providerId).get(i.invalidCredentials,e).then(t=>({value:t}))});/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function IH(i,e){if(e===void 0)return;const t=i.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:Ci(e)},()=>new Xm(e.addRef(),i.rpc)),n=t.addCounterpartRef();return t.dispose(),n}function $t(){return function(i){class e extends i{constructor(...n){var r;super(...n);const s=n[1];this.credentialsProvider=(r=s.credentialsProvider)===null||r===void 0?void 0:r.addRef()}initializeCounterpart(n,r){const s=this.credentialsProvider;r.credentialsProvider=IH(this.chunkManager,s),super.initializeCounterpart(n,r)}static encodeOptions(n){const r=super.encodeOptions(n),s=n.credentialsProvider;return r.credentialsProvider=s===void 0?void 0:Ci(s),r}}return e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const TH=bt(128,128,128);var vn;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(vn||(vn={}));class cp{}let uD=class extends cp{};uD.RPC_ID="dvid/VolumeChunkSource";let hD=class extends cp{};hD.RPC_ID="dvid/SkeletonSource";let pD=class extends cp{};pD.RPC_ID="dvid/MeshSource";let fD=class extends cp{constructor(){super(...arguments),this.chunkDataSize=TH}},l0=class extends fD{};l0.RPC_ID="dvid/AnnotationSource";let gD=class extends fD{};gD.RPC_ID="dvid/AnnotationChunkSource";let mD=class{constructor(i,e){this.numLevels=1;try{if(ge(i),e==="dvid"){let t=Y(i,"Extended",ge);if(t.MaxDownresLevel){let n=Y(t,"MaxDownresLevel",li);this.numLevels=n+1}this.voxelSize=Y(t,"VoxelSize",n=>Xs(Ne(),n)),this.upperVoxelBound=Y(t,"MaxPoint",n=>Xs(Ne(),n.map(r=>++r))),this.lowerVoxelBound=Y(t,"MinPoint",n=>Xs(Ne(),n)),this.blockSize=Y(t,"BlockSize",n=>Xs(Ne(),n))}else if(e==="gs"){ge(i);const t=Y(i,"scales",s=>s);if(t.length===0)throw new Error("Expected at least one scale");const n=t[0];this.voxelSize=Y(n,"resolution",s=>go(Ne(),s)),this.lowerVoxelBound=we(n,"offset",s=>Xs(Ne(),s))||bt(0,0,0);const r=Y(n,"size",s=>Xs(Ne(),s));this.upperVoxelBound=U1(Ne(),r,this.lowerVoxelBound),this.blockSize=bt(64,64,64)}else throw new Error("unrecognized volume info")}catch(t){throw new Error(`Failed to parse volume geometry: ${t.message}`)}}},DH=class{constructor(i){try{this.scales=[],this.scales.push(i);let e=i.voxelSize,t=i.lowerVoxelBound,n=i.upperVoxelBound;for(let r=1;r<i.numLevels;++r){let s=j({},i);s.voxelSize=G1(Ne(),e,bt(2,2,2)),e=s.voxelSize,s.upperVoxelBound=RS(Ne(),Eg(Ne(),n,bt(2,2,2))),n=s.upperVoxelBound,s.lowerVoxelBound=RS(Ne(),Eg(Ne(),t,bt(2,2,2))),t=s.lowerVoxelBound,this.scales.push(s)}}catch(e){throw new Error(`Failed to parse multiscale volume specification: ${e.message}`)}}get numChannels(){return this.scales.length===0?0:this.scales[0].numChannels}},up=new ue;up.set("uint8",J.UINT8);up.set("uint32",J.UINT32);up.set("uint64",J.UINT64);class vD{constructor(e){this.obj=e,ge(e),Y(e,"TypeName",Ie)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}get tags(){return this.obj.Tags}}class yD{constructor(e,t,n){this.name=t,this.base=n,this.volumeInfo=new mD(RH(n.tags,e),"dvid")}get lowerVoxelBound(){return this.volumeInfo.lowerVoxelBound}get upperVoxelBound(){return this.volumeInfo.upperVoxelBound}get blockSize(){return this.volumeInfo.blockSize}get voxelSize(){return this.volumeInfo.voxelSize}get numLevels(){return this.volumeInfo.numLevels}}class PH extends Wt($t()(tc),uD){}class AH extends Wt($t()(Qh),hD){}class MH extends Wt($t()(Kd),pD){}class Su extends yD{constructor(e,t,n,r,s){super(e,t,n),this.encoding=r;let o=Y(e,"Extended",ge),l=Y(o,"Values",u=>He(u,ge));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");let c=new je(s);if(r!==vn.COMPRESSED_SEGMENTATIONARRAY)for(;c.has(t+"_"+this.volumeInfo.numLevels.toString());)this.volumeInfo.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=Y(l[0],"DataType",u=>wv(u,up))}get volumeType(){return this.encoding===vn.COMPRESSED_SEGMENTATION||this.encoding===vn.COMPRESSED_SEGMENTATIONARRAY?Ii.SEGMENTATION:Ii.IMAGE}getSources(e,t,n,r){const s=this.encoding,o=[],l=64;for(let c=0;c<this.numLevels;++c){const u=Math.pow(2,c),f=Math.pow(2,-c),g=Ne(),v=Ne();for(let L=0;L<3;++L){const I=Math.floor(this.lowerVoxelBound[L]*f);g[L]=I-I%l;const M=Math.ceil(this.upperVoxelBound[L]*f);v[L]=M,M%l!==0&&(v[L]+=l-M%l)}let y=t.dataInstanceKey;s!==vn.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(y+="_"+c.toString());const C=j(j({},t),{dataInstanceKey:y,dataScale:c.toString(),encoding:s}),w=Qe();for(let L=0;L<3;++L)w[5*L]=u,w[12+L]=g[L]*u;const S=rc({rank:3,chunkToMultiscaleTransform:w,dataType:this.dataType,baseVoxelOffset:g,upperVoxelBound:z1(Ne(),v,g),volumeType:this.volumeType,volumeSourceOptions:n,compressedSegmentationBlockSize:s===vn.COMPRESSED_SEGMENTATION||s===vn.COMPRESSED_SEGMENTATIONARRAY?bt(8,8,8):void 0}).map(L=>({chunkSource:e.getChunkSource(PH,{spec:L,parameters:C,credentialsProvider:r}),chunkToMultiscaleTransform:w}));o.push(S)}return Md(o)}}function bD(i){let e=Y(i,"Base",ge),t=Y(e,"Syncs",Sn);return t.length===1?t[0]:""}function RH(i,e){if(!i)return e;const t=e&&e.Extended||{};let n=t.MaxDownresLevel,r=t.MaxPoint,s=t.MinPoint,o=t.VoxelSize,l=t.BlockSize;try{i.MaxDownresLevel&&typeof i.MaxDownresLevel=="string"?(n=parseInt(Y(i,"MaxDownresLevel",Ie)),n<0&&(n=t.MaxDownresLevel)):typeof i.MaxDownresLevel=="number"&&(n=Y(i,"MaxDownresLevel",hE))}catch{}try{i.MaxPoint&&typeof i.MaxPoint=="string"?r=JSON.parse(Y(i,"MaxPoint",Ie)):Array.isArray(i.MaxPoint)&&i.MaxPoint.length===3&&(r=i.MaxPoint)}catch{}try{i.MinPoint&&typeof i.MinPoint=="string"?s=JSON.parse(Y(i,"MinPoint",Ie)):Array.isArray(i.MinPoint)&&i.MinPoint.length===3&&(s=i.MinPoint)}catch{}try{i.VoxelSize&&typeof i.VoxelSize=="string"?o=JSON.parse(Y(i,"VoxelSize",Ie)):Array.isArray(i.VoxelSize)&&i.VoxelSize.length===3&&(o=i.VoxelSize)}catch{}try{i.BlockSize&&typeof i.BlockSize=="string"?l=JSON.parse(Y(i,"BlockSize",Ie)):Array.isArray(i.BlockSize)&&i.BlockSize.length===3&&(l=i.BlockSize)}catch{}return{Base:e&&e.Base||{},Extended:j(j({},t),{VoxelSize:o,MinPoint:s,MaxPoint:r,MaxDownresLevel:n,BlockSize:l})}}class SD extends yD{get tags(){return Y(this.base.obj,"Tags",ge)}constructor(e,t,n){super(e,t,n)}}function NH(i,e,t){ge(i);let n=i[e],r=Y(n,"Base",s=>new vD(s));if(r.typeName==="annotation"){let s=bD(n);return s&&(n=i[s]),new SD(n,e,r)}return VH(n,e,t)}function VH(i,e,t){ge(i);let n=Y(i,"Base",r=>new vD(r));switch(n.typeName){case"uint8blk":case"grayscale8":let r=n.compressionName.indexOf("jpeg")!==-1;return new Su(i,e,n,r?vn.JPEG:vn.RAW,t);case"labels64":case"labelblk":return new Su(i,e,n,vn.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new Su(i,e,n,vn.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${se(n.typeName)} is not supported.`)}}class dh{constructor(e){if(this.errors=[],this.dataInstances=new ue,this.vnodes=new je,e instanceof dh){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}ge(e),this.alias=Y(e,"Alias",Ie),this.description=Y(e,"Description",Ie);let t=Y(e,"DataInstances",ge),n=di(t);for(let o of n)try{this.dataInstances.set(o,NH(t,o,n))}catch(l){let c=`Failed to parse data instance ${se(o)}: ${l.message}`;console.log(c),this.errors.push(c)}let r=Y(e,"DAG",ge),s=Y(r,"Nodes",ge);for(let o of di(s))this.vnodes.add(o)}}function OH(i){try{let n=Th(i,s=>new dh(s)),r=new ue;for(let s of n){var e=oe(s,2);let o=e[0],l=e[1];r.set(o,l);for(let c of l.vnodes)if(c!==o){let u=new dh(l);r.set(c,u)}}for(let s of r){var t=oe(s,2);let o=t[0],l=t[1];l.uuid=o}return r}catch(n){throw new Error(`Failed to parse DVID repositories info: ${n.message}`)}}class BH{constructor(e){this.repositories=OH(e)}getNode(e){let t=[];for(let n of this.repositories.keys())n.startsWith(e)&&t.push(n);if(t.length!==1)throw new Error(`Node key ${se(e)} matches ${se(t)} nodes.`);return this.repositories.get(t[0])}}function wD(i,e,t){return i.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{const n=bH(t,{url:`${e}/api/repos/info`,method:"GET"}).then(s=>new BH(s)),r=`repository info for DVID server ${e}`;return tt.forPromise(n,{initialMessage:`Retrieving ${r}.`,delay:!0,errorPrefix:`Error retrieving ${r}: `}),n})}class _H extends Ns{constructor(e,t,n,r){super(e),this.sourceParameters=t,this.info=n,this.credentialsProvider=r}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}get baseUrl(){return this.sourceParameters.baseUrl}get nodeKey(){return this.sourceParameters.nodeKey}get dataInstanceKey(){return this.sourceParameters.dataInstanceKey}get supervoxels(){return this.sourceParameters.supervoxels||!1}getSegmentPosition(e){const t=this.sourceParameters.dvidService;return t?fetch(`${t}/locate-body?dvid=${this.baseUrl}&uuid=${this.nodeKey}&segmentation=${this.dataInstanceKey}&body=${e.toString()}${this.supervoxels?"&supervoxels=true":""}`,{method:"GET"}).then(n=>n.json()).then(n=>new Float32Array(n)):Ot.reject("No locate service is available")}getSources(e){return this.info.getSources(this.chunkManager,this.sourceParameters,e,this.credentialsProvider)}}const FH=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function CD(i){if(i.startsWith("https"))return i+"/api/server/token"}function UH(i){let e=i.match(FH);if(e===null)throw new Error(`Invalid DVID URL: ${se(i)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]};const n=e[4];if(n){const r=Zo(n);r.usertag==="true"&&(t.usertag=!0),r.user&&(t.user=r.user);const s=r.dvidService||r.dvidservice||r["dvid-service"];s&&(t.dvidService=s),(r.forceDvidService||r.forcedividservice||r["force-dvid-service"])&&(t.forceDvidService=!0),t.supervoxels=r.supervoxels==="true"}return t.authServer=CD(t.baseUrl),t}function zH(i,e,t){return i.usertag?sN(Ne(),t,e):i.chunkDataSize}function GH(i,e){let t=n=>{const r=n.lowerVoxelBound,s=n.upperVoxelBound,o=zH(e,r,s);return{spec:Gd({rank:3,chunkDataSize:Uint32Array.from(o),lowerVoxelBound:r,upperVoxelBound:s}),chunkToMultiscaleTransform:Qe()}};if(e.usertag){if(e.user)return[[t(i.scales[0])]];throw"Expecting a valid user"}else return[i.scales.map(n=>t(n))]}const WH=Wt($t()(Un),l0);class $H extends Wt($t()(No),gD){}class jH extends WH{constructor(e,t){super(e,j({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.multiscaleVolumeInfo=t.multiscaleVolumeInfo,this.childAdded=this.childAdded||new at,this.childUpdated=this.childUpdated||new at,this.childDeleted=this.childDeleted||new at,this.childRefreshed=this.childRefreshed||new xe,this.parameters.readonly!==void 0&&(this.readonly=this.parameters.readonly),this.parameters.user||(this.readonly=!0)}getSources(e){let t=GH(this.multiscaleVolumeInfo,this.parameters),n=0;return t[0].length>1&&(n=3),this.chunkSources=t.map(r=>r.map(({spec:s,chunkToMultiscaleTransform:o})=>({chunkSource:this.chunkManager.getChunkSource($H,{spec:j({limit:n,chunkToMultiscaleTransform:o},s),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:o}))),this.chunkSources}invalidateCache(){this.metadataChunkSource.invalidateCache();for(let e of this.chunkSources)for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache();this.childRefreshed.dispatch()}}async function HH(i,e,t,n){let r=(o,l)=>i.chunkManager.getChunkSource(jH,{parameters:l,credentialsProvider:n,multiscaleVolumeInfo:o}),s=new DH(t.volumeInfo);return r(s,e)}async function JH(i,e,t,n){const r={lowerBounds:new Float64Array(t.lowerVoxelBound),upperBounds:Float64Array.from(t.upperVoxelBound)},s=mt({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(t.voxelSize,l=>l/1e9),boundingBoxes:[ya(r)]}),o=await HH(i,e,t,n);return{modelTransform:Xi(s),subsources:[{id:"default",subsource:{annotation:o},default:!0}]}}function ZH(i,e,t,n){const r=t,s={lowerBounds:new Float64Array(r.lowerVoxelBound),upperBounds:Float64Array.from(r.upperVoxelBound)},o=mt({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(r.voxelSize,u=>u/1e9),boundingBoxes:[ya(s)]}),l=new _H(i.chunkManager,e,r,n),c={modelTransform:Xi(o),subsources:[{id:"default",subsource:{volume:l},default:!0}]};if(r.meshSrc){const u=Qe();for(let f=0;f<3;++f)u[5*f]=1/r.voxelSize[f];c.subsources.push({id:"meshes",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(MH,{parameters:j(j({},e),{segmentationName:r.name,dataInstanceKey:r.meshSrc}),credentialsProvider:n})},subsourceToModelSubspaceTransform:u})}return r.skeletonSrc&&c.subsources.push({id:"skeletons",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(AH,{parameters:j(j({},e),{dataInstanceKey:r.skeletonSrc}),credentialsProvider:n})}}),c.subsources.push({id:"bounds",subsource:{staticAnnotations:_d(s)},default:!0}),c}function qH(i){return i.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",sourceUrl:i.providerUrl},async()=>{const e=UH(i.providerUrl),t=e.baseUrl,n=e.nodeKey,r=e.dataInstanceKey,s=n.indexOf(":"),o=s!==-1?n.slice(0,s):n,l=i.credentialsManager.getCredentialsProvider(o0,{dvidServer:e.baseUrl,authServer:e.authServer}),c=(await wD(i.chunkManager,t,l)).getNode(o);if(c===void 0)throw new Error(`Invalid node: ${se(n)}.`);const u=c.dataInstances.get(r);if(!u)throw new Error(`Invalid data instance ${r}.`);if(u.base.typeName==="annotation"){if(!(u instanceof SD))throw new Error(`Invalid data instance ${r}.`);let f=j(j({},new l0),e);return u.blockSize&&(f.chunkDataSize=u.blockSize),f.syncedLabel=bD({Base:u.base.obj}),f.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1},{identifier:"confidence",description:"confidence",type:"float32",default:0,min:0,max:1,step:.01}],JH(i,f,u,l)}else{if(!(u instanceof Su))throw new Error(`Invalid data instance ${r}.`);return ZH(i,e,u,l)}})}function YH(i,e){return{offset:0,completions:Qo(e,i.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function KH(i,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:Qo(e,i.repositories.values(),s=>s.uuid+"/",s=>`${s.alias}: ${s.description}`)};let n=t[1],r=i.getNode(n);return Xo(n.length+1,YH(r,t[2]))}async function XH(i){const e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/;let t=i.providerUrl.match(e);if(t===null)throw null;let n=t[1],r=t[2],s=CD(n);const o=await wD(i.chunkManager,n,i.credentialsManager.getCredentialsProvider(o0,{dvidServer:n,authServer:s}));return Xo(n.length+1,KH(o,r))}class QH extends ba{constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return qH(e)}completeUrl(e){return XH(e)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ca("dvid",i=>new QH(i.credentialsManager));function Xx(i){return i.text()}function e6(i,e,t,n=qt){const r={method:t.method,body:t.payload};return r.method==="POST"&&(r.headers={"Content-Type":"application/json"}),i6(i,e,t.url,r,jn,n)}function t6(i){return(e,t)=>{let n=j({},t);return e?n.headers=j(j({},n.headers),{Authorization:`Bearer ${e}`}):i.startsWith("https:")&&(n.credentials="include"),n}}function i6(i,e,t,n,r,s=qt){return Ty(i,t,n,r,t6(t),o=>{const l=o.status;if((l===403||l===401)&&e)return"refresh";if(l===504)return"retry";throw o},s)}function n6(i){return"neurohub"in i?Ot.resolve(i.neurohub.clio.auth.getAuthResponse().id_token):Ot.resolve("")}class r6 extends nc{constructor(e,t){super(),this.authServer=e,this.retry=t,this.get=tp(n=>{const r=new tt(!0);let s;return new Ot((o,l)=>{const c=()=>{s=void 0,r.dispose()};n.add(()=>{s!==void 0&&(s.cancel(),s=void 0,r.dispose(),l(Es))});const u=(g="Authorization required.",v="Request authorization.")=>{if(r.setText(g+" "),this.retry){let y=document.createElement("button");y.textContent=v,r.element.appendChild(y),y.addEventListener("click",this.retry)}r.setVisible(!0)};let f=this.authServer;s!==void 0&&s.cancel(),s=new Ps,u("Waiting for authorization...","Retry"),this.getAuthToken(f,s).then(g=>{s!==void 0&&(c(),o(g))},g=>{s!==void 0&&(s=void 0,u(`Authorization failed: ${g}.`,"Retry"))})})})}getAuthToken(e,t=qt){if(e){if(e.startsWith("token:"))return Ot.resolve(e.substring(6));if(e=="neurohub")return n6(window);{const n=new Headers;return or(e,{method:"GET",headers:n},Xx,t).catch(()=>or(e,{method:"GET"},Xx,t))}}else return Ot.resolve("")}}const xD="Clio",s6=/^([^\/]+:\/\/[^\/]+)\/([^\/]+)\/([^\/\?]+)(\?.*)?$/;function a6(i){let e=i.match(s6);if(e===null)throw new Error(`Invalid DVID URL: ${se(i)}.`);return{baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]}}function ED(i){let e=Wo(i);return e.protocol==="precomputed"&&(e=Wo(e.host+e.path)),e}function LD(i){let e=i.protocol,t=i.host,n=i.path;switch(e){case"gs":return`https://storage.googleapis.com/${t}${n}/info`;case"dvid":const r=a6(t+n);return`${r.baseUrl}/api/node/${r.nodeKey}/${r.dataInstanceKey}/info`;case"https":return`${e}://${t}${n}/info`;default:throw Error("Unrecognized volume information")}}class o6{constructor(e){this.parameters=e}getTopLevelUrl(){var e=this.parameters;const t=e.baseUrl,n=e.api;return`${t}/${n||"clio_toplevel"}`}getDatasetsUrl(){return`${this.getTopLevelUrl()}/datasets`}getGrayscaleInfoUrl(){let e=ED(this.parameters.grayscale);return LD(e)}getAnnotationEndpoint(){return this.parameters.kind==="Atlas"?"atlas":"annotations"}getAnnotationEntryUrl(){return`${this.getTopLevelUrl()}/${this.getAnnotationEndpoint()}/${this.parameters.dataset}`}getAllAnnotationsUrl(){return this.getAnnotationEntryUrl()+(this.parameters.groups?`?groups=${this.parameters.groups}`:"")}hasPointQueryApi(){return this.parameters.api==="clio_toplevel"||this.parameters.kind==="Atlas"}getPostAnnotationUrl(e){return this.hasPointQueryApi()?`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`:this.getAnnotationEntryUrl()}getDeleteAnnotationUrl(e){if(this.hasPointQueryApi()){const t=e.match(/(-?\d+)_(-?\d+)_(-?\d+)/);if(t)return this.getAnnotationUrl(t==null?void 0:t.slice(1,4))}return`${this.getAnnotationEntryUrl()}/${e}`}getAnnotationUrl(e){return`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`}}/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class l6 extends r6{constructor(e){super(e),this.authServer=e}}nl.register(xD,i=>new l6(i));const d6="annotation.add.signal";_t(d6,function(i){const e=this.get(i.id),t=Lv(i.newAnnotation);t&&(e.parent.updateReference(t),e.parent.childAdded.dispatch(t))});class c6{constructor(e){this.annotation=e}get renderingAttribute(){if(this.kind==="Atlas")if(this.title){if(this.checked)return 1}else return-1;else{if(this.bookmarkType==="False Split")return 2;if(this.bookmarkType==="False Merge")return 3}return 0}get confidence(){return 0}updateProperties(){this.annotation.properties=[this.renderingAttribute,this.confidence]}get ext(){return this.annotation.ext===void 0&&(this.annotation.ext={}),this.annotation.ext}get prop(){return this.annotation.prop}set prop(e){this.annotation.prop=e}get bookmarkType(){if(this.prop)switch(this.prop.type){case"Split":return"False Merge";case"Merge":return"False Split"}return"Other"}get type(){return this.annotation.type}get kind(){return this.annotation.kind}set kind(e){this.annotation.kind=e,this.update()}roundPos(){this.annotation.type===Me.POINT?this.annotation.point=this.annotation.point.map(e=>Math.round(e)):(this.annotation.type===Me.LINE||this.annotation.type===Me.SPHERE)&&(this.annotation.pointA=this.annotation.pointA.map(e=>Math.round(e)),this.annotation.pointB=this.annotation.pointB.map(e=>Math.round(e)))}setProp(e){this.prop=j(j({},this.prop),e)}get user(){return this.prop&&this.prop.user}set user(e){this.setProp({user:e})}get comment(){return this.prop&&this.prop.comment}get description(){return this.comment}updatePresentation(){this.title?this.annotation.description=this.title+": ":this.annotation.description="",this.description&&(this.annotation.description+=this.description)}update(){this.updatePresentation(),this.updateProperties()}set comment(e){this.setProp({comment:e}),this.updatePresentation()}updateComment(){this.comment=this.annotation.description||"",this.annotation.description=void 0}get title(){return this.prop&&this.prop.title}set title(e){this.setProp({title:e}),this.updatePresentation()}get timestamp(){return this.prop&&this.prop.timestamp?Number(this.prop.timestamp):0}addTimeStamp(){this.setProp({timestamp:String(Date.now())})}get checked(){return this.ext&&this.ext.verified||this.prop&&this.prop.checked||!1}set checked(e){this.setProp({checked:e})}get presentation(){return this.updatePresentation(),this.annotation.description||""}set presentation(e){this.annotation.description=e}}function u6(i){const e=i.split(".")[1];if(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(t).split("").map(function(r){return"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}}function kD(i,e){let t;const n=u6(i);return n&&("user"in n?t=n.user:"email"in n&&(t=n.email)),t||(t=e),t}const h6={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["comment"],properties:{comment:{$id:"#/properties/Prop/properties/comment",type:"string",title:"Comment",default:""}}}}};class au extends c6{get title(){return this.annotation.ext&&this.annotation.ext.title}set title(e){this.ext.title=e}get description(){return this.annotation.ext&&this.annotation.ext.description}set description(e){this.ext.description=e}get user(){return this.annotation.ext&&this.annotation.ext.user}set user(e){this.ext.user=e}get checked(){return this.ext&&this.ext.verified}set checked(e){this.ext.verified=e}}function p6(i){let e=i.match(/^\${(.*):JSON}$/);return e?JSON.parse(e[1]):null}const f6={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["description"],properties:{description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}},g6={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["title","description"],properties:{title:{$id:"#/properties/Prop/properties/title",type:"string",title:"Title",default:""},description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}};function ID(i){return Array.isArray(i)}function m6(i){return ID(i)||i===null?!1:typeof i=="object"}class TD{constructor(e){this.name=e,this.childNodeList=new Array,this.parentNode=null}isRoot(){return this.parentNode===null}isLeaf(){return this.childNodeList.length===0}*[Wi](){function*e(t){yield t;for(let n of t.childNodeList)yield*e(n)}yield*e(this)}*leafNodes(){for(let e of this)e.childNodeList.length===0&&(yield e)}get fullName(){let e=this.name,t=this.parentNode;for(;t;)e=t.name+"/"+e,t=t.parentNode;return e}get nameArray(){let e=new Array;if(!this.isRoot()){e.push(this.name);let t=this.parentNode;for(;t&&!t.isRoot();)e.push(t.name),t=t.parentNode}return e}getPropertyValue(e){if(!this.isRoot()&&e){let t=this.nameArray,n=e;for(let r=t.length-1;r>=0;--r)if(m6(n)){let s=t[r];n=n[s]}else return n;return n}}}function DD(i,e){if(i.type=="object"){e.properties==null&&(e.properties={}),e.properties.title=i.title;let t=i.required;ID(t)&&t.forEach(n=>{let r=new TD(n);r.parentNode=e,e.childNodeList.push(r);let s=i.properties[n];DD(s,r)})}else e.properties=i}function v6(i,e){let t=new TD(e);return DD(i,t),t}const y6="annotation";function b6(i,e,t,n=!1){let r=document.createElement("div"),s=i.title;s&&r.appendChild(document.createTextNode(s));let o;switch(i.type){case"number":o=document.createElement("input"),typeof t=="number"&&(o.text=t);break;case"string":let l=i.enum;Array.isArray(l)?(o=document.createElement("select"),r.appendChild(o),l.forEach(c=>{let u=document.createElement("option");u.text=c,u.value=c,u.disabled=n,o.appendChild(u)}),t!==void 0&&(o.value=t)):(o=document.createElement("input"),o.setAttribute("autocomplete","off"),typeof t=="string"&&(o.value=t,o.setAttribute("value",t)));break;case"boolean":o=document.createElement("input"),o.type="checkbox",typeof t=="boolean"?o.checked=t:o.checked=t==1;break}return o&&(o.id=e,o.readOnly=n,r.appendChild(o)),r}function S6(i,e){return i+"/"+e}function w6(i,e,t,n=!1){let r=document.createElement("div"),s=v6(i,t);s.record=r;for(let o of s)if(!o.isRoot())if(o.isLeaf()){let l=o.getPropertyValue(e),c=b6(o.properties,o.fullName,l,n);o.parentNode.record.appendChild(c)}else{let l=document.createElement("fieldset"),c=document.createElement("legend");c.textContent=o.properties.title,l.appendChild(c),o.record=l,o.parentNode.record.appendChild(l)}return r}function C6(i,e,t=!1){return w6(i,e,y6,t)}function x6(i){let e=document.getElementById(i);if(e)return e.type==="checkbox"?e.checked:e.value}function PD(i,e,t,n){i.type==="object"?i.required.forEach(r=>{let s=t;e&&(typeof t[e]>"u"&&(t[e]={}),s=t[e]),PD(i.properties[r],r,s,S6(n,r))}):t[e]=x6(n)}function E6(i,e,t,n,r,s){const o=j({},i.value);if(o.type!==Me.POINT&&o.type!==Me.LINE&&o.type!==Me.SPHERE)return null;e||(e=h6);const l=n(o),c=r?r(o):l.prop;let u=C6(e,c?{Prop:c}:{},t.readonly),f=document.createElement("button");return f.textContent="update",f.onclick=()=>{let g={};PD(e,"",g,"annotation");const v=g.Prop;s?s(o,v):l.setProp(v),l.update(),t.update(i,o),t.commit(i)},u.appendChild(f),u}let L6=`
{
  "definitions": {},
  "type": "object",
  "required": [
    "Prop"
  ],
  "properties": {
    "Prop": {
      "$id": "#/properties/Prop",
      "type": "object",
      "title": "Properties",
      "required": [
        "comment",
        "type",
        "checked"
      ],
      "properties": {
        "comment": {
          "$id": "#/properties/Prop/properties/comment",
          "type": "string",
          "title": "Comment",
          "default": ""
        },
        "type": {
          "$id": "#/properties/Prop/properties/type",
          "type": "string",
          "title": "Type",
          "enum": ["Merge", "Split", "Other"]
        },
        "checked": {
          "$id": "#/properties/Prop/properties/checked",
          "type": "boolean",
          "title": "Checked"
        }
      }
    }
  }
}
`;JSON.parse(L6);/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const k6=bt(64,64,64);class I6{}function T6(i){return i.authServer?i.authServer==="neurohub"||i.authServer.startsWith("http"):!1}class AD extends I6{constructor(){super(...arguments),this.chunkDataSize=k6}}let d0=class extends AD{};d0.RPC_ID="clio/Annotation";class MD extends AD{}MD.RPC_ID="clio/AnnotationChunkSource";class D6 extends Wt($t()(No),MD){}async function P6(i){const e=i.grayscale;if(e){let t=ED(e);return yH({method:"GET",url:LD(t),responseType:"json"}).then(n=>new mD(n,t.protocol==="https"?"gs":t.protocol))}else return Ot.resolve({numChannels:1,voxelSize:bt(8,8,8),lowerVoxelBound:bt(0,0,0),upperVoxelBound:bt(5e4,5e4,5e4),blockSize:bt(64,64,64),numLevels:1})}function A6(i){return[[(e=>{const t=e.upperVoxelBound;return{spec:Gd({rank:3,chunkDataSize:Uint32Array.from(t),lowerVoxelBound:e.lowerVoxelBound,upperVoxelBound:e.upperVoxelBound}),chunkToMultiscaleTransform:Qe()}})(i)]]}const M6=Wt($t()(Un),d0);class R6 extends M6{constructor(e,t){super(e,j({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.dataInfo=t.dataInfo,this.childAdded=this.childAdded||new at,this.childUpdated=this.childUpdated||new at,this.childDeleted=this.childDeleted||new at,this.makeEditWidget=n=>{const r=l=>new au(l),s=l=>j(j({},l.prop),l.ext),o=(l,c)=>{const u=new au(l);c.title&&(u.title=c.title),c.description&&(u.description=c.description)};return E6(n,this.parameters.schema,this,r,s,o)},this.getUser=()=>this.parameters.user}getSources(e){let t=A6(this.dataInfo),n=0;return t[0].length>1&&(n=10),t.map(r=>r.map(({spec:s,chunkToMultiscaleTransform:o})=>({chunkSource:this.chunkManager.getChunkSource(D6,{spec:j({limit:n,chunkToMultiscaleTransform:o},s),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:o})))}*[Wi](){for(let e of this.references)e[1].value&&(yield e[1].value)}commit(e){e.value&&(e.value.type===Me.LINE||e.value.type===Me.SPHERE)&&(e.value.pointA=e.value.pointA.map(t=>Math.round(t)),e.value.pointB=e.value.pointB.map(t=>Math.round(t))),super.commit(e)}add(e,t=!0){if(this.readonly){let r="Permission denied for changing annotations.";throw tt.showTemporaryMessage(r),Error(r)}const n=new au(e);if(n.addTimeStamp(),this.parameters.user&&(n.user=this.parameters.user),e.type===Me.POINT&&(n.kind=this.parameters.kind||"Note",e.description)){let r=p6(e.description);r&&n.setProp(r)}return n.roundPos(),n.update(),super.add(e,t)}update(e,t){const n=new au(t);n.roundPos(),n.update(),super.update(e,t)}invalidateCache(){this.references.forEach(e=>{e.dispose()}),this.references.clear(),this.childRefreshed.dispatch(),this.metadataChunkSource.invalidateCache();for(let e of this.getSources({multiscaleToViewTransform:new Float32Array,displayRank:1,modelChannelDimensionIndices:[]}))for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache()}}async function N6(i,e,t,n){return((r,s)=>i.chunkManager.getChunkSource(R6,{parameters:s,credentialsProvider:n,dataInfo:r}))(t,e)}async function V6(i,e,t){const n=await P6(e),r={lowerBounds:new Float64Array(n.lowerVoxelBound),upperBounds:Float64Array.from(n.upperVoxelBound)},s=mt({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(n.voxelSize,l=>l/1e9),boundingBoxes:[ya(r)]}),o=await N6(i,e,n,t);return{modelTransform:Xi(s),subsources:[{id:"default",subsource:{annotation:o},default:!0}]}}const O6=/^([^\/]+:\/\/[^\/]+)\/(?:([^\/\?#]+)\/)?([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function B6(i){let e=i.match(O6);if(e===null)throw new Error(`Invalid Clio URL: ${se(i)}.`);let t={baseUrl:e[1],api:e[2],dataset:e[3]},n=e[4];if(n){let r=Zo(n);r.token?(t.authToken=r.token,t.authServer="token:"+r.token):r.auth&&(t.authServer=r.auth),r.user?t.user=r.user:t.authToken&&(t.user=kD(t.authToken)),r.kind?r.kind==="atlas"?t.kind="Atlas":t.kind=r.kind:t.kind="Normal",r.groups&&(t.groups=r.groups)}return t}async function _6(i,e){const t=new o6(i);return e6(e(i.authServer),T6(i),{url:t.getDatasetsUrl(),method:"GET"}).then(n=>{const r=Y(n,i.dataset,ge);if("location"in r)i.grayscale=Y(r,"location",Ie);else if("mainLayer"in r){const s=Y(r,"mainLayer",Ie),o=Y(r,"neuroglancer",ge).layers.find(l=>l.name===s);o.source&&o.source.url?i.grayscale=Y(o.source,"url",Ie):i.grayscale=Y(o,"source",Ie)}return i})}async function F6(i,e){let t=B6(i.providerUrl);if(!t.user&&t.authServer){let n=e(t.authServer).get();t.authToken=(await n).credentials,t.user=kD(t.authToken)}return i.chunkManager.memoize.getUncounted(j({type:"clio:MultiscaleVolumeChunkSource"},t),async()=>{t=await _6(t,e);let n=j(j({},new d0),t);t.kind==="Atlas"?n.schema=g6:n.schema=f6,n.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1}];const r=e(t.authServer);return V6(i,n,r)})}async function U6(i){return Ot.resolve({offset:0,completions:[{value:""}]})}class z6 extends ba{constructor(e){super(),this.credentialsManager=e,this.description="Clio"}getCredentialsProvider(e){let t="";return e&&(t=e),this.credentialsManager.getCredentialsProvider(xD,t)}get(e){return F6(e,this.getCredentialsProvider.bind(this))}completeUrl(e){return U6(e.providerUrl)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ca("clio",i=>new z6(i.credentialsManager));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hp="google-brainmaps";function so(i,e,t,n=qt){return ta(e,`${i.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?jn:kI,n)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Dr;(function(i){i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(Dr||(Dr={}));class RD{}RD.RPC_ID="brainmaps/VolumeChunkSource";let ND=class{};ND.RPC_ID="brainmaps/MultiscaleMeshSource";let VD=class{};VD.RPC_ID="brainmaps/MeshSource";let OD=class{};OD.RPC_ID="brainmaps/SkeletonSource";let BD=class{};BD.RPC_ID="brainmaps/Annotation";let _D=class{};_D.RPC_ID="brainmaps/AnnotationSpatialIndex";class G6 extends Wt($t()(tc),RD){}class W6 extends Wt($t()(Xh),ND){}class $6 extends Wt($t()(Kd),VD){}class j6 extends Wt($t()(Qh),OD){}class H6 extends Wt($t()(No),_D){}const sc=new ue;sc.set("UINT8",J.UINT8);sc.set("FLOAT",J.FLOAT32);sc.set("UINT32",J.UINT32);sc.set("UINT64",J.UINT64);function J6(i){ge(i);try{return{corner:Y(i,"corner",e=>hd(Ne(),e,Tt)),size:Y(i,"size",e=>hd(Ne(),e,gi)),metadata:Y(i,"metadata",Cn)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}class Z6{constructor(e){try{ge(e),this.numChannels=Y(e,"channelCount",li),this.dataType=Y(e,"channelType",t=>wv(t,sc)),this.voxelSize=Y(e,"pixelSize",t=>hd(Ne(),t,gi)),this.upperVoxelBound=Y(e,"volumeSize",t=>hd(Ne(),t,li)),this.boundingBoxes=Y(e,"boundingBox",t=>t===void 0?[]:He(t,J6))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}}function q6(i){return ge(i),{name:Y(i,"name",Ie),type:Y(i,"type",Ie)}}function Y6(i){try{return ge(i),Y(i,"meshes",e=>e===void 0?[]:He(e,q6))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}const K6="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",pg="([0-9]+)",FD=new RegExp(`^(.*)_${pg}x${pg}x${pg}_lod([0-9]+)_${K6}$`);function X6(i,e){const t=new ue,n=i.scales[0],r=new je;for(const o of e){if(o.type!=="TRIANGLES")continue;const l=o.name.match(FD);if(l===null)continue;const c=l[1];let u=t.get(c);u===void 0&&(u={key:c,chunkShape:Ne(),lods:[]},t.set(c,u));const f=parseInt(l[5]);if(u.lods[f]!==void 0){r.add(c);continue}const g=bt(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),v=new Uint32Array(3);for(let y=0;y<3;++y)v[y]=Math.ceil(n.upperVoxelBound[y]/g[y]);u.lods[f]={info:o,scale:parseFloat(l[6]),relativeBlockShape:g,gridShape:v}}const s=[];e:for(const o of t.values()){if(r.has(o.key))continue e;const l=o.lods[0];if(l===void 0)continue e;const c=l.relativeBlockShape;G1(o.chunkShape,c,n.voxelSize);for(let u=1;u<o.lods.length;++u){const f=o.lods[u];if(f===void 0)continue e;const g=f.relativeBlockShape;for(let v=0;v<3;++v){const y=g[v],C=c[v];if(y<C||y%C!==0)continue e;g[v]=y/C}}c.fill(1),s.push(o)}return s}function Q6(i,e){const t=X6(i,e),n=[],r=o=>{n.some(l=>l.name===o.name)||n.push(o)},s=new je;for(const o of t){r({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(const l of o.lods)s.add(l.info)}for(const o of e)r({single:o,multi:void 0,name:o.name,partOfMultiscale:s.has(o)});return n}class e5{constructor(e){try{ge(e);let t=this.scales=Y(e,"geometry",o=>He(o,l=>new Z6(l)));if(t.length===0)throw new Error("Expected at least one scale.");let n=t[0],r=this.numChannels=n.numChannels,s=this.dataType=n.dataType;for(let o=1,l=t.length;o<l;++o){let c=t[o];if(c.dataType!==s)throw new Error(`Scale ${o} has data type ${J[c.dataType]} but scale 0 has data type ${J[s]}.`);if(c.numChannels!==r)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${r} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(n.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){const t=this.scales[0],n=["x","y","z"],r=["m","m","m"],s=Te(t.voxelSize,l=>l/1e9),o=Te(t.upperVoxelBound);return e&&(n.push("c^"),r.push(""),s.push(1),o.push(this.numChannels)),mt({names:n,units:r,scales:Float64Array.from(s),boundingBoxes:[ya({lowerBounds:new Float64Array(n.length),upperBounds:Float64Array.from(o)})]})}}let t5=class extends Ns{constructor(i,e,t,n,r,s,o){super(i),this.instance=e,this.credentialsProvider=t,this.volumeId=n,this.changeSpec=r,this.multiscaleVolumeInfo=s,this.encoding=o.encoding,this.jpegQuality=o.jpegQuality,this.chunkLayoutPreference=o.chunkLayoutPreference;let l=Ii.IMAGE;this.dataType===J.UINT64&&(l=Ii.SEGMENTATION),this.volumeType=l}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(i){let e=Dr.RAW;(this.dataType===J.UINT64||this.dataType===J.UINT32)&&this.volumeType===Ii.SEGMENTATION&&this.encoding!==Dr.RAW?e=Dr.COMPRESSED_SEGMENTATION:this.volumeType===Ii.IMAGE&&this.dataType===J.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==Dr.RAW&&i.discreteValues!==!0&&(e=Dr.JPEG);const t=e===Dr.JPEG?this.jpegQuality:void 0,n=this.scales[0],r=n.upperVoxelBound,s=Ne(),o=this.rank;return Md(this.scales.map((l,c)=>{Eg(s,l.voxelSize,n.voxelSize);let u=l.upperVoxelBound,f,g=l.numChannels;const v=new Float32Array((o+1)**2);v[(o+1)*o+o]=1;const y=new Float32Array(o);g!==1&&(u=Float32Array.of(...u,g),f=Uint32Array.of(1,1,1,g),v[(o+1)*3+3]=1,y[3]=g);for(let C=0;C<3;++C)v[(o+1)*C+C]=s[C],y[C]=r[C]/s[C];return rc({rank:o,minBlockSize:f,chunkToMultiscaleTransform:v,dataType:l.dataType,upperVoxelBound:u,volumeType:this.volumeType,volumeSourceOptions:i,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:bt(64,64,64)}).map(C=>({chunkSource:this.chunkManager.getChunkSource(G6,{credentialsProvider:this.credentialsProvider,spec:C,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:c,encoding:e,jpegQuality:t,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:y}))}))}};function i5(i){const e=Qe(),t=i.scales[0].voxelSize;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}function n5(i){const e=i.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${se(i)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});const n=Zo(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:n}}function r5(i){try{return ge(i),{id:Y(i,"id",Ie),label:Y(i,"label",Ie),description:Y(i,"description",Cn)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function s5(i){try{return ge(i),Y(i,"project",e=>e===void 0?[]:He(e,r5))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function Qx(i,e){try{return ge(i),Y(i,e,t=>t===void 0?[]:He(t,Ie))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function a5(i){return Y(i,"changeStackId",e=>e===void 0?void 0:He(e,Ie))}const o5=Wt($t()(Un),BD);class l5 extends o5{constructor(e,t){super(e,j({rank:3,relationships:["segments"],properties:[]},t)),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){const e=this.parameters.upperVoxelBound,t=Gd({rank:3,chunkDataSize:e,upperVoxelBound:e}),n=Qe();return[[{chunkSource:this.chunkManager.getChunkSource(H6,{parent:this,spec:j({limit:0,chunkToMultiscaleTransform:n},t),parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:n}]]}}const d5=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class UD extends ba{constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:Ci(this.credentialsProvider)},()=>so(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(n=>new e5(n)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:Ci(this.credentialsProvider)},()=>so(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(n=>Y6(n)))}get(e){var t=n5(e.providerUrl);const n=t.volumeId,r=t.changeSpec,s=t.meshName,o=t.parameters;ge(o);const l=we(o,"encoding",g=>Ti(g,Dr)),c=we(o,"jpegQuality",g=>{const v=hi(g);if(v<1||v>100)throw new Error(`Expected integer in range [1, 100], but received: ${g}`);return v},70),u=we(o,"chunkLayout",g=>Ti(g,vo)),f={encoding:l,chunkLayoutPreference:u,jpegQuality:c};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:n,changeSpec:r,brainmapsOptions:f},async()=>{var g=await Ot.all([this.getMultiscaleInfo(e.chunkManager,n),this.getMeshesInfo(e.chunkManager,n)]),v=oe(g,2);const y=v[0],C=v[1],w=new t5(e.chunkManager,this.instance,this.credentialsProvider,n,r,y,f),S={modelTransform:Xi(y.getModelSpace(y.numChannels!==1)),subsources:[{id:s===void 0?"default":"volume",subsource:{volume:w},default:s===void 0}]},L=_d(y.box);y.scales[0].boundingBoxes.forEach((R,D)=>{L.add({type:Me.AXIS_ALIGNED_BOUNDING_BOX,description:R.metadata,pointA:R.corner,pointB:U1(Ne(),R.corner,R.size),id:`boundingBox${D}`,properties:[]})}),S.subsources.push({id:"bounds",subsource:{staticAnnotations:L},default:!0});const I=Q6(y,C),M=(R,D)=>{let T;const A=R.single;if(A!==void 0)A.type==="TRIANGLES"?T=e.chunkManager.getChunkSource($6,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:n,meshName:A.name,changeSpec:r}}):T=e.chunkManager.getChunkSource(j6,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:n,meshName:R.name,changeSpec:r}});else{const V=R.multi;T=e.chunkManager.getChunkSource(W6,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:_r.float32},parameters:{instance:this.instance,volumeId:n,info:V,changeSpec:r}})}S.subsources.push({id:s===void 0?`/${R.name}`:"default",subsource:{mesh:T},subsourceToModelSubspaceTransform:i5(y),modelSubspaceDimensionIndices:[0,1,2],default:D})};if(s!==void 0){const R=I.find(D=>D.name===s);if(R===void 0)throw new Error(`Mesh/skeleton source not found: ${se(R)}`);M(R,!0)}else{let R=!0;for(const D of I)D.partOfMultiscale||(M(D,R),R=!1)}return r!==void 0&&S.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(l5,{parameters:{volumeId:n,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:y.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),S})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=so(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(r=>s5(r));const n=`${this.instance.description} project list`;return tt.forPromise(t,{delay:!0,initialMessage:`Retrieving ${n}.`,errorPrefix:`Error retrieving ${n}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let n=so(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(s=>Qx(s,"datasetIds"));const r=`${this.instance.description} dataset list`;return tt.forPromise(n,{delay:!0,initialMessage:`Retrieving ${r}`,errorPrefix:`Error retrieving ${r}`}),n})}getVolumeList(e,t,n){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${n}:getVolumeList`},()=>{let r=so(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${n}`,responseType:"json"}).then(o=>{const l=Qx(o,"volumeId"),c=t.length+n.length+2,u=[];for(const f of l)u.push(f.substring(c));return u});const s=`${this.instance.description} volume list`;return tt.forPromise(r,{delay:!0,initialMessage:`Retrieving ${s}`,errorPrefix:`Error retrieving ${s}`}),r})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let n=so(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(s=>a5(s));const r=`change stacks for ${t}`;return tt.forPromise(n,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),n})}async completeUrl(e){const t=e.providerUrl,n=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(n===null)throw null;var r=oe(n,7);const s=r[1],o=r[2],l=r[3],c=r[4],u=r[5],f=r[6];if(f!==void 0)return Xo(t.length-f.length,await tk(f,d5));if(u!==void 0){const v=`${s}:${o}:${l}`,y=await this.getMeshesInfo(e.chunkManager,v),C=[],w=new je;for(const S of y)if(S.name.startsWith(u))switch(S.type){case"LINE_SEGMENTS":C.push({value:S.name,description:"Skeletons"});break;case"TRIANGLES":{C.push({value:S.name,description:"Mesh (single-resolution)"});const L=S.name.match(FD);if(L!==null){const I=L[1];if(w.has(I))break;w.add(I),C.push({value:I,description:"Mesh (multi-resolution)"})}break}}return C.sort((S,L)=>Hd(S.value,L.value)),{offset:t.length-u.length,completions:C}}if(c!==void 0){const v=`${s}:${o}:${l}`,y=await this.getChangeStackList(e.chunkManager,v);if(y===void 0)throw null;return{offset:t.length-c.length,completions:_f(c,y)}}if(l!==void 0)return{offset:t.length-l.length,completions:_f(l,await this.getVolumeList(e.chunkManager,s,o))};if(o!==void 0){const v=await this.getDatasetList(e.chunkManager,s);return{offset:t.length-o.length,completions:_f(o,v.map(y=>`${y}:`))}}const g=await this.getProjectList(e.chunkManager);return{offset:0,completions:Qo(s,g,v=>`${v.id}:`,v=>v.label)}}}const c5={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};Ca("brainmaps",i=>new UD(c5,i.credentialsManager.getCredentialsProvider(hp)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS<"u")for(const i of Jd(NEUROGLANCER_BRAINMAPS_SERVERS)){var e1=oe(i,2);const e=e1[0],t=e1[1];Ca(`brainmaps-${e}`,n=>new UD(t,n.credentialsManager.getCredentialsProvider(hp)))}const u5="https://accounts.google.com/o/oauth2/auth",t1="https://accounts.google.com";function h5(i,e){let t=document.createElement("iframe");t.style.display="none",t.id=i,t.name=i;const n=location.origin;t.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(n)}#rpctoken=${e}`,document.body.appendChild(t)}class p5{constructor(){this.finished=new at}}class f5{constructor(){this.proxyName=`postmessageRelay${Au()}`,this.rpcToken=`${Au()}`,this.relayReadyService=`oauth2relayReady:${this.rpcToken}`,this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`,this.pendingRequests=new ue,h5(this.proxyName,this.rpcToken),this.relayReadyPromise=new Ot(e=>{addEventListener("message",t=>{if(t.origin===t1)try{let n=ge(JSON.parse(t.data)),r=Ie(n.s);if(r===this.relayReadyService&&e(),r===this.oauth2CallbackService){let s=He(n.a,L=>L),o=Ie(s[0]),l=location.origin;if(!o.startsWith(l+"#")&&!o.startsWith(l+"?"))throw new Error(`oauth2callback: URL ${se(o)} does not match current origin ${l}.`);let c=o.substring(l.length+1).split("&"),u=new ue;for(let L of c){let I=L.match("^([a-z_]+)=(.*)$");if(I===null)throw new Error(`oauth2callback: URL part ${se(I)} does not match expected pattern.`);u.set(I[1],I[2])}let f=u.get("state");if(f===void 0)throw new Error("oauth2callback: State argument is missing.");let g=this.pendingRequests.get(f);if(g===void 0)return;let v=u.get("error");if(v!==void 0){let L=u.get("error_subtype"),I=v;L!==void 0&&(I+=": "+L),g.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${I}`));return}let y=u.get("access_token"),C=u.get("token_type"),w=u.get("expires_in"),S=u.get("scope");if(y===void 0||C===void 0||w===void 0||S===void 0)throw new Error("oauth2callback: URL lacks expected parameters.");g.finished.dispatch({accessToken:y,tokenType:C,expiresIn:w,scope:S});return}}catch(n){throw new Error(`Invalid message received from ${t1}: ${se(t.data)}: ${n.message}.`)}})})}addPendingRequest(e){let t=new p5;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${u5}?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage",t+="&response_type=token";var n=e.origin;let r=n===void 0?location.origin:n;return t+=`&origin=${encodeURIComponent(r)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(e.scopes.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),e.authUser!==void 0&&(t+=`&authuser=${e.authUser}`),t}}let fg;function g5(){return fg===void 0&&(fg=new f5),fg}function m5(i,e=qt){const t=Au(),n=g5(),r=n.makeAuthRequestUrl({state:t,clientId:i.clientId,scopes:i.scopes,approvalPrompt:i.approvalPrompt,loginHint:i.loginHint,immediate:i.immediate,authUser:i.authUser}),s=n.addPendingRequest(t),o=new Ot((l,c)=>{s.finished.add((u,f)=>{u!==void 0?l(u):c(f)})});if(s.finished.add(e.add(()=>{s.finished.dispatch(void 0,Es)})),i.immediate)n.relayReadyPromise.then(()=>{if(e.isCanceled)return;const l=document.createElement("iframe");l.src=r,l.style.display="none",document.body.appendChild(l),s.finished.add(()=>{Bt(l)})});else if(!e.isCanceled){const l=open(r);l!==null&&s.finished.add(()=>{l.close()})}return o}class v5 extends nc{constructor(e){super(),this.options=e,this.get=tp(t=>{const n=this.options,r=new tt(!0);let s;return new Ot((o,l)=>{const c=()=>{s=void 0,r.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,r.dispose(),l(Es))});function u(g=`${n.description} authorization required.`,v="Request authorization."){r.setText(g+"  ");let y=document.createElement("button");y.textContent=v,r.element.appendChild(y),y.addEventListener("click",()=>{f(!1)}),r.setVisible(!0)}function f(g){s!==void 0&&s.cancel(),s=new Ps,u(`Waiting for ${n.description} authorization...`,"Retry"),m5({clientId:n.clientId,scopes:n.scopes,immediate:g,authUser:0},s).then(v=>{s!==void 0&&(c(),o(v))},v=>{s!==void 0&&(s=void 0,g?u():u(`${n.description} authorization failed: ${v}.`,"Retry"))})}f(!0)})})}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const y5="https://www.googleapis.com/auth/brainmaps";class zD extends v5{constructor(e){super({clientId:e,scopes:[y5],description:"Brain Maps"})}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */nl.register(hp,()=>new zD(BRAINMAPS_CLIENT_ID));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ch;(function(i){i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSO=3]="COMPRESSO",i[i.PNG=4]="PNG"})(ch||(ch={}));let GD=class{};GD.RPC_ID="precomputed/VolumeChunkSource";class WD{}WD.RPC_ID="precomputed/MeshSource";var uh;(function(i){i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP"})(uh||(uh={}));var Qm;(function(i){i[i.IDENTITY=0]="IDENTITY",i[i.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(Qm||(Qm={}));class $D{}$D.RPC_ID="precomputed/MultiscaleMeshSource";class jD{}jD.RPC_ID="precomputed/SkeletonSource";class HD{}HD.RPC_ID="precomputed/AnnotationSpatialIndexSource";class JD{}JD.RPC_ID="precomputed/AnnotationSource";class ZD{}ZD.RPC_ID="precomputed/IndexedSegmentPropertySource";/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function b5(i,e,t,n,r){const s=await ta(i,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(n)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},jn,r);ge(s);const o=we(s,"prefixes",Sn,[]),l=we(s,"items",c=>He(c,u=>(ge(u),Y(u,"name",Ie))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function S5(i,e,t,n,r){if(!n.startsWith("/"))throw null;const s=await b5(i,t,n.substring(1),"/",r);let o=n.lastIndexOf("/");return{offset:o+e.length+1,completions:s.map(l=>({value:l.substring(o)}))}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function w5(i,e,t){var n=await xa(t,i,{headers:{accept:"text/html"}},async u=>({text:await u.text(),contentType:u.headers.get("content-type")}),e);const r=n.text,s=n.contentType;if(s===null||/\btext\/html\b/i.exec(s)===null)return[];const o=new DOMParser().parseFromString(r,"text/html"),l=o.evaluate("//a/@href",o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let u=0,f=l.snapshotLength;u<f;++u){const g=l.snapshotItem(u).textContent;g&&c.push(new URL(g,i).toString())}return c}async function C5(i,e,t){console.log("getHtmlPathCompletions");const n=i.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(n===null)throw null;const r=await w5(n[1],e,t),s=n[1].length,o=[];for(const l of r)l.startsWith(i)&&o.push({value:l.substring(s)});return{offset:s,completions:o}}const x5=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+json://",description:"Google Cloud Storage (storage JSON API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function c0(i,e,t){if(!e.includes("://"))return{offset:0,completions:Qo(e,x5,y=>y.value,y=>y.description)};var n=rl(e,i);const r=n.url,s=n.credentialsProvider,o=e.length-r.length;let l;try{l=Wo(r)}catch{throw null}var c=l;const u=c.protocol,f=c.host,g=c.path,v=await(async()=>{if(u==="gs+xml"&&g.length>0)return await fm(s,`${u}://${f}`,`https://storage.googleapis.com/${f}`,g,t);if((u==="gs"||u==="gs+json")&&g.length>0)return await S5(s,`${u}://${f}`,f,g,t);if(u==="s3"&&g.length>0)return await LG(f,g,t);const y=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(y!==null)return await fm(s,y[1],y[1],y[2],t);if((u==="http"||u==="https")&&g.length>0)return await C5(r,t,s);throw null})();return{offset:o+v.offset,completions:v.completions}}class E5 extends Wt($t()(tc),GD){}class L5 extends Wt($t()(Kd),WD){}class k5 extends Wt($t()(Xh),$D){}class I5 extends Wt($t()(Qh),jD){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function sa(i,e){const t=i.split("/");for(const n of e.split("/")){if(n===".."&&t.length!==0){t.length=t.length-1;continue}t.push(n)}return t.join("/")}class T5{constructor(e,t){ge(e);const n=t===1?3:4,r=this.resolution=new Float64Array(n),s=this.voxelOffset=new Float32Array(n),o=this.size=new Float32Array(n);if(n===4&&(r[3]=1,o[3]=t),Y(e,"resolution",l=>st(r.subarray(0,3),l,gi)),we(e,"voxel_offset",l=>st(s.subarray(0,3),l,hi)),Y(e,"size",l=>st(o.subarray(0,3),l,li)),this.chunkSizes=Y(e,"chunk_sizes",l=>He(l,c=>{const u=new Uint32Array(n);return n===4&&(u[3]=t),st(u.subarray(0,3),c,li),u})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=Y(e,"sharding",pp),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=Y(e,"encoding",l=>Ti(l,ch)))===ch.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=Y(e,"compressed_segmentation_block_size",l=>st(Ne(),l,li))),this.key=Y(e,"key",Ie)}}function D5(i){ge(i);const e=Y(i,"data_type",S=>Ti(S,J)),t=Y(i,"num_channels",li),n=Y(i,"type",S=>Ti(S,Ii)),r=Y(i,"mesh",Cn),s=Y(i,"skeletons",Cn),o=Y(i,"segment_properties",Cn),l=Y(i,"scales",S=>He(S,L=>new T5(L,t)));if(l.length===0)throw new Error("Expected at least one scale");const c=l[0],u=t===1?3:4,f=new Float64Array(u),g=new Float64Array(u),v=new Float64Array(u),y=["x","y","z"],C=["m","m","m"];for(let S=0;S<3;++S)f[S]=c.resolution[S]/1e9,g[S]=c.voxelOffset[S],v[S]=g[S]+c.size[S];u===4&&(f[3]=1,v[3]=t,y[3]="c^",C[3]="");const w=mt({rank:u,names:y,units:C,scales:f,boundingBoxes:[ya({lowerBounds:g,upperBounds:v})]});return{dataType:e,volumeType:n,mesh:r,skeletons:s,segmentPropertyMap:o,scales:l,modelSpace:w}}class P5 extends Ns{constructor(e,t,n,r){super(e),this.credentialsProvider=t,this.url=n,this.info=r}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){const t=this.info.scales[0].resolution,n=this.rank;return Md(this.info.scales.map(r=>{const s=r.resolution,o=n+1,l=new Float32Array(o*o);l[l.length-1]=1;var c=this.info.modelSpace.boundingBoxes[0].box;const u=c.lowerBounds,f=c.upperBounds,g=new Float32Array(n),v=new Float32Array(n);for(let y=0;y<3;++y){const C=s[y]/t[y];l[o*y+y]=C;const w=r.voxelOffset[y];l[o*n+y]=w*C,g[y]=u[y]/C-w,v[y]=f[y]/C-w}return n===4&&(l[o*3+3]=1,g[3]=u[3],v[3]=f[3]),rc({rank:n,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:r.chunkSizes,baseVoxelOffset:r.voxelOffset,compressedSegmentationBlockSize:r.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(y=>({chunkSource:this.chunkManager.getChunkSource(E5,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:sa(this.url,r.key),encoding:r.encoding,sharding:r.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:g,upperClipBound:v}))}))}}const A5=Wt($t()(Un),JD);class M5 extends Wt($t()(No),HD){}class R5 extends A5{constructor(e,t){const n=t.parameters;super(e,{rank:n.rank,relationships:n.relationships.map(r=>r.name),properties:n.properties,parameters:n}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{const t=e.spec;return{chunkSource:this.chunkManager.getChunkSource(M5,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function N5(i,e,t){return i.getChunkSource(L5,{parameters:t,credentialsProvider:e})}function qD(i){return Y(i,"transform",e=>{const t=Qe();return e!==void 0&&st(t.subarray(0,12),e,Tt),mv(t,t),t})}function V5(i){ge(i);const e=Y(i,"@type",Ie);let t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${se(e)}`);{const r=Y(i,"lod_scale_multiplier",gi),s=Y(i,"vertex_quantization_bits",li),o=qD(i),l=Y(i,"sharding",pp);t={lodScaleMultiplier:r,transform:o,sharding:l,vertexQuantizationBits:s}}}const n=Y(i,"segment_properties",Cn);return{metadata:t,segmentPropertyMap:n}}async function O5(i,e,t){let n;try{n=await dl(i,e,t)}catch(r){if(sp(r))return{metadata:void 0};throw r}return V5(n)}function i1(i){return i===void 0?uh.RAW:Ti(i,uh)}function pp(i){if(i===void 0)return;ge(i);const e=Y(i,"@type",Ie);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${se(e)}`);const t=Y(i,"hash",c=>Ti(c,Qm)),n=Y(i,"preshift_bits",hi),r=Y(i,"shard_bits",hi),s=Y(i,"minishard_bits",hi),o=Y(i,"minishard_index_encoding",i1),l=Y(i,"data_encoding",i1);return{hash:t,preshiftBits:n,shardBits:r,minishardBits:s,minishardIndexEncoding:o,dataEncoding:l}}function B5(i){ge(i);const e=Y(i,"@type",Ie);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${se(e)}`);const t=qD(i),n=new ue;Y(i,"vertex_attributes",o=>{o!==void 0&&He(o,l=>{ge(l);const c=Y(l,"id",Ie);if(c==="")throw new Error("vertex attribute id must not be empty");if(n.has(c))throw new Error(`duplicate vertex attribute id ${se(c)}`);const u=Y(l,"data_type",g=>Ti(g,J)),f=Y(l,"num_components",li);n.set(c,{dataType:u,numComponents:f})})});const r=Y(i,"sharding",pp),s=Y(i,"segment_properties",Cn);return{metadata:{transform:t,vertexAttributes:n,sharding:r},segmentPropertyMap:s}}async function _5(i,e,t){const n=await dl(i,e,t);return B5(n)}function YD(){return mt({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function KD(i,e,t){var n=await O5(i,e,t);const r=n.metadata,s=n.segmentPropertyMap;if(r===void 0)return{source:N5(i,e,{url:t,lod:0}),transform:Qe(),segmentPropertyMap:s};let o;const l=r.vertexQuantizationBits;if(l===10)o=_r.uint10;else if(l===16)o=_r.uint16;else throw new Error(`Invalid vertex quantization bits: ${l}`);return{source:i.getChunkSource(k5,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:o}}),transform:r.transform,segmentPropertyMap:s}}async function XD(i,e,t){var n=await _5(i,e,t);const r=n.metadata,s=n.segmentPropertyMap;return{source:i.getChunkSource(I5,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:s}}function dl(i,e,t){return i.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:Ci(e)},async()=>await xa(e,`${t}/info`,{},jn))}function n1(i){const e=Qe(),t=i.scales[0].resolution;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}async function F5(i,e,t,n){const r=D5(n),s=new P5(i.chunkManager,e,t,r),o=r.modelSpace,l=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:_d(o.bounds)}}];if(r.segmentPropertyMap!==void 0){const f=sa(t,r.segmentPropertyMap),g=await dl(i.chunkManager,e,f),v=fp(i.chunkManager,e,g);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:v}})}if(r.mesh!==void 0){const f=sa(t,r.mesh);var c=await KD(i.chunkManager,e,f);const g=c.source,v=c.transform,y=n1(r);fi(y,y,v),l.push({id:"mesh",default:!0,subsource:{mesh:g},subsourceToModelSubspaceTransform:y})}if(r.skeletons!==void 0){const f=sa(t,r.skeletons);var u=await XD(i.chunkManager,e,f);const g=u.source,v=u.transform,y=n1(r);fi(y,y,v),l.push({id:"skeletons",default:!0,subsource:{mesh:g},subsourceToModelSubspaceTransform:y})}return{modelTransform:Xi(o),subsources:l}}async function U5(i,e,t){var n=await XD(i.chunkManager,e,t);const r=n.source,s=n.transform,o=n.segmentPropertyMap,l=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:s}];if(o!==void 0){const c=sa(t,o),u=await dl(i.chunkManager,e,c),f=fp(i.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:f}})}return{modelTransform:Xi(YD()),subsources:l}}function gg(i,e){return ge(e),{url:sa(i,Y(e,"key",Ie)),sharding:Y(e,"sharding",pp)}}class z5{constructor(e,t){this.url=e,ge(t);const n=Y(t,"dimensions",Ru),r=n.rank,s=Y(t,"lower_bound",l=>st(new Float64Array(r),l,Tt)),o=Y(t,"upper_bound",l=>st(new Float64Array(r),l,Tt));this.coordinateSpace=mt({rank:r,names:n.names,units:n.units,scales:n.scales,boundingBoxes:[ya({lowerBounds:s,upperBounds:o})]}),this.parameters={type:Y(t,"annotation_type",l=>Ti(l,Me)),rank:r,relationships:Y(t,"relationships",l=>He(l,c=>{const u=gg(e,c),f=Y(c,"id",Ie);return j(j({},u),{name:f})})),properties:Y(t,"properties",SE),byId:Y(t,"by_id",l=>gg(e,l))},this.spatialIndices=Y(t,"spatial",l=>He(l,c=>{const u=gg(e,c),f=Y(c,"grid_shape",S=>st(new Float32Array(r),S,li)),g=Y(c,"chunk_size",S=>st(new Float32Array(r),S,gi)),v=Y(c,"limit",li),y=new Float32Array(r);for(let S=0;S<r;++S)y[S]=f[S]*g[S];const C=Ts(Float32Array,r+1);for(let S=0;S<r;++S)C[(r+1)*r+S]=s[S];const w=j({limit:v,chunkToMultiscaleTransform:C},Gd({rank:r,chunkDataSize:g,upperVoxelBound:y}));return w.upperChunkBound=f,{parameters:u,spec:w,limit:v}})),this.spatialIndices.reverse()}}async function G5(i,e,t,n){const r=new z5(t,n);return{modelTransform:Xi(r.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:i.chunkManager.getChunkSource(R5,{credentialsProvider:e,metadata:r,parameters:r.parameters})}}]}}async function r1(i,e,t){var n=await KD(i.chunkManager,e,t);const r=n.source,s=n.transform,o=n.segmentPropertyMap,l=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:s}];if(o!==void 0){const c=sa(t,o),u=await dl(i.chunkManager,e,c),f=fp(i.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:f}})}return{modelTransform:Xi(YD()),subsources:l}}function W5(i){ge(i);const e=new re,t=Y(i,"ids",s=>{s=Sn(s);const o=s.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(s[c]))throw new Error(`Invalid uint64 id: ${se(s[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),n=t.length/2,r=Y(i,"properties",s=>He(s,o=>{ge(o);const l=Y(o,"id",Ie),c=we(o,"description",Ie),u=Y(o,"type",g=>{if(g!=="label"&&g!=="description"&&g!=="string"&&g!=="tags"&&g!=="number")throw new Error(`Invalid property type: ${se(g)}`);return g});if(u==="tags"){const g=Y(o,"tags",Sn);let v=we(o,"tag_descriptions",Sn);if(v===void 0)v=new Array(g.length),v.fill("");else if(v.length!==g.length)throw new Error(`Expected tag_descriptions to have length: ${g.length}`);const y=Y(o,"values",C=>{if(!Array.isArray(C)||C.length!==n)throw new Error(`Expected ${n} values, but received: ${C.length}`);return C.map(w=>String.fromCharCode(...w))});return{id:l,description:c,type:u,tags:g,tagDescriptions:v,values:y}}if(u==="number"){const g=Y(o,"data_type",w=>Ti(w,J));if(g===J.UINT64)throw new Error("uint64 properties not supported");const v=Y(o,"values",w=>{if(!Array.isArray(w)||w.length!==n)throw new Error(`Expected ${n} values, but received: ${w.length}`);return LN[g].from(w)});let y=1/0,C=-1/0;for(let w=v.length-1;w>=0;--w){const S=v[w];S<y&&(y=S),S>C&&(C=S)}return{id:l,description:c,type:u,dataType:g,values:v,bounds:[y,C]}}const f=Y(o,"values",g=>{if(Sn(g),g.length!==n)throw new Error(`Expected ${n} values, but received: ${g.length}`);return g});return{id:l,description:c,type:u,values:f}}));return wW({ids:t,properties:r})}Wt($t()(gW),ZD);function fp(i,e,t,n){try{const r=Y(t,"@type",Ie);if(r!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${se(r)}`);const s=we(t,"inline",W5);return new sT({inlineProperties:s})}catch(r){throw new Error(`Error parsing segment property map: ${r.message}`)}}async function $5(i,e,t,n){return{modelTransform:Xi(Lo),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:fp(i.chunkManager,e,n)}}]}}const j5=/^([^#]*)(?:#(.*))?$/;function mg(i){var e=i.match(j5),t=oe(e,3);let n=t[1],r=t[2];n.endsWith("/")&&(n=n.substring(0,n.length-1));const s=Zo(r||"");return{url:n,parameters:s}}function s1(i,e){const t=pE(e);return t&&(i+=`#${t}`),i}class H5 extends ba{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){var t=mg(e.providerUrl);const n=t.url,r=t.parameters;return e.providerProtocol+"://"+s1(n,r)}convertLegacyUrl(e){var t=mg(e.providerUrl);const n=t.url,r=t.parameters;return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+s1(n,r)}get(e){var t=mg(e.providerUrl);const n=t.url,r=t.parameters;return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:n,parameters:r},async()=>{var s=rl(n,e.credentialsManager);const o=s.url,l=s.credentialsProvider;let c;try{c=await dl(e.chunkManager,l,o)}catch(g){if(sp(g)&&r.type==="mesh")return await r1(e,l,o);throw g}ge(c);const u=we(c,"redirect",Ie);if(u!==void 0)throw new ik(u);const f=we(c,"@type",Ie);switch(f){case"neuroglancer_skeletons":return await U5(e,l,o);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await r1(e,l,o);case"neuroglancer_annotations_v1":return await G5(e,l,o,c);case"neuroglancer_segment_properties":return await $5(e,l,o,c);case"neuroglancer_multiscale_volume":case void 0:return await F5(e,l,o,c);default:throw new Error(`Invalid type: ${se(f)}`)}})}completeUrl(e){return c0(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ca("precomputed",()=>new H5);var QD=function(i){if(i==null)throw new TypeError("Cannot destructure undefined")};/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var hh;(function(i){i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP",i[i.BLOSC=2]="BLOSC"})(hh||(hh={}));let eP=class{};eP.RPC_ID="n5/VolumeChunkSource";class J5 extends Wt($t()(tc),eP){}let Z5=class extends Ns{constructor(i,e,t,n){super(i),this.credentialsProvider=e,this.multiscaleMetadata=t,this.scales=n;let r,s;if(n.forEach((f,g)=>{if(f!==void 0){if(s===void 0&&(s=g),r!==void 0&&f.dataType!==r)throw new Error(`Scale s${g} has data type ${J[f.dataType]} but expected ${J[r]}.`);r=f.dataType}}),r===void 0)throw new Error("At least one scale must be specified.");const o=t.scales[s],l=n[s];this.dataType=r,this.volumeType=Ii.IMAGE,this.baseScaleIndex=s;const c=t.modelSpace,u=c.rank;this.modelSpace=mt({names:c.names,scales:c.scales,units:c.units,boundingBoxes:[{transform:HS(Float64Array,o.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(u),upperBounds:new Float64Array(l.size)}}],coordinateArrays:c.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(i){QD(this);const e=this.scales,t=this.rank,n=this.multiscaleMetadata.scales;return Md(e.filter(r=>r!==void 0).map((r,s)=>{const o=n[s],l=HS(Float32Array,o.downsamplingFactor);return rc({rank:t,chunkToMultiscaleTransform:l,dataType:r.dataType,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:[r.chunkSize],volumeSourceOptions:i}).map(c=>({chunkSource:this.chunkManager.getChunkSource(J5,{credentialsProvider:this.credentialsProvider,spec:c,parameters:{url:o.url,encoding:r.encoding}}),chunkToMultiscaleTransform:l}))}))}};class q5{constructor(e){ge(e),this.dataType=Y(e,"dataType",n=>Ti(n,J)),this.size=Float32Array.from(Y(e,"dimensions",n=>He(n,li))),this.chunkSize=Y(e,"blockSize",n=>st(new Uint32Array(this.size.length),n,li));let t;we(e,"compression",n=>{t=Y(n,"type",r=>Ti(r,hh))}),t===void 0&&(t=Y(e,"compressionType",n=>Ti(n,hh))),this.encoding=t}}function Y5(i,e,t){return Ot.all(t.scales.map(async n=>{const r=await tP(i,e,n.url,!0);if(r!==void 0)return new q5(r)}))}function K5(i){var e=Wo(i);let t=e.protocol,n=e.host,r=e.path;r.endsWith("/")&&(r=r.substring(0,r.length-1));const s=[];for(;;){s.push(`${t}://${n}${r}/attributes.json`);const o=r.lastIndexOf("/");if(o===-1)break;r=r.substring(0,o)}return s}function X5(i,e,t,n){return i.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:Ci(e)},()=>xa(e,t,{},jn).then(r=>{try{return ge(r)}catch(s){throw new Error(`Error reading attributes from ${t}: ${s.message}`)}}).catch(r=>{if(sp(r))return n?void 0:{};throw r}))}async function tP(i,e,t,n){const r=K5(t),s=await Ot.all(r.map((o,l)=>X5(i,e,o,n&&l===r.length-1)));if(s.indexOf(void 0)===-1)return s.reverse(),j({},...s)}function fs(i,e){if(i!==-1&&e!==i)throw new Error(`Rank mismatch, received ${e} but expected ${i}`);return e}function iP(i){return Float64Array.from(He(i,gi))}function nP(i){const e=_n(i);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:He(e,n=>{const r=iP(n);return t=fs(t,r.length),r}),single:void 0,rank:t}}function Q5(i){const e=_n(i);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return nP(e);const t=iP(i);return{all:void 0,single:t,rank:t.length}}const eJ=["x","y","z","t","c"];function tJ(i){const e=eJ.slice(0,i);for(;e.length<i;)e.push(`d${e.length+1}`);return e}function iJ(i,e){ge(e);let t=-1,n=we(e,"resolution",v=>{const y=Float64Array.from(He(v,gi));return t=fs(t,y.length),y}),r=we(e,"axes",v=>{const y=He(v,Ie);return t=fs(t,y.length),y}),s=we(e,"units",v=>{const y=He(v,ZS);return t=fs(t,y.length),y}),o={unit:"m",exponent:-9},l,c;we(e,"downsamplingFactors",v=>{var y=Q5(v);const C=y.single,w=y.all,S=y.rank;t=fs(t,S),C!==void 0&&(l=C),w!==void 0&&(c=w)}),we(e,"pixelResolution",v=>{o=Y(v,"unit",ZS),we(v,"dimensions",y=>{n=Float64Array.from(He(y,gi)),t=fs(t,n.length)})}),we(e,"scales",v=>{var y=nP(v);const C=y.all,w=y.rank;t=fs(t,w),c=C});const u=we(e,"dimensions",v=>{const y=He(v,li);return t=fs(t,y.length),y});if(t===-1)throw new Error("Unable to determine rank of dataset");s===void 0&&(s=new Array(t),s.fill(o)),n===void 0&&(n=new Float64Array(t),n.fill(1));for(let v=0;v<t;++v)n[v]=Dv(n[v],s[v].exponent);const f=new Array(t);r!==void 0&&we(e,"coordinateArrays",v=>{ge(v);for(let y=0;y<t;++y){const C=r[y];if(Object.prototype.hasOwnProperty.call(v,C)){const w=Sn(v[C]);f[y]={explicit:!1,labels:w,coordinates:Te(w,(S,L)=>L)},s[y]={unit:"",exponent:0},n[y]=1}}}),r===void 0&&(r=tJ(t));const g=mt({rank:t,valid:!0,names:r,scales:n,units:s.map(v=>v.unit),coordinateArrays:f});if(u===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:g,url:i,attributes:e,scales:c.map((v,y)=>({url:`${i}/s${y}`,downsamplingFactor:v}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:g,url:i,attributes:e,scales:[{url:i,downsamplingFactor:l}]}}class nJ extends ba{get description(){return"N5 data source"}get(e){let t=e.providerUrl;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{var n=rl(t,e.credentialsManager);const r=n.url,s=n.credentialsProvider,o=await tP(e.chunkManager,s,r,!1),l=iJ(r,o),c=await Y5(e.chunkManager,s,l),u=new Z5(e.chunkManager,s,l,c);return{modelTransform:Xi(u.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:u}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:_d(u.modelSpace.bounds)}}]}})}completeUrl(e){return c0(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ca("n5",()=>new nJ);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var po;(function(i){i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP",i[i.BLOSC=2]="BLOSC"})(po||(po={}));class rP{}rP.RPC_ID="zarr/VolumeChunkSource";const Pr=new ue;Pr.set("|u1",{endianness:an.LITTLE,dataType:J.UINT8});Pr.set("|i1",{endianness:an.LITTLE,dataType:J.INT8});for(let i of[["<",an.LITTLE],[">",an.BIG]]){var a1=oe(i,2);let e=a1[0],t=a1[1];for(let n of["u","i"])Pr.set(`${e}${n}8`,{endianness:t,dataType:J.UINT64});Pr.set(`${e}u2`,{endianness:t,dataType:J.UINT16}),Pr.set(`${e}i2`,{endianness:t,dataType:J.INT16}),Pr.set(`${e}u4`,{endianness:t,dataType:J.UINT32}),Pr.set(`${e}i4`,{endianness:t,dataType:J.INT32}),Pr.set(`${e}f4`,{endianness:t,dataType:J.FLOAT32})}function rJ(i){const e=Pr.get(i);if(e===void 0)throw new Error(`Unsupported numpy data type: ${se(i)}`);return e}class sJ extends Wt($t()(tc),rP){}function sP(i){return we(i,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${se(e)}`);return e})}function aJ(i){try{ge(i),Y(i,"zarr_format",l=>{if(l!==2)throw new Error(`Expected 2 but received: ${se(l)}`)});const e=Y(i,"shape",l=>He(l,c=>{if(typeof c!="number"||!$i(c)||c<0)throw new Error(`Expected non-negative integer, but received: ${se(c)}`);return c})),t=Y(i,"chunks",l=>st(new Array(e.length),l,c=>{if(typeof c!="number"||!$i(c)||c<=0)throw new Error(`Expected positive integer, but received: ${se(c)}`);return c})),n=Y(i,"order",l=>{if(l!=="C"&&l!=="F")throw new Error(`Expected "C" or "F", but received: ${se(l)}`);return l}),r=sP(i),s=Y(i,"dtype",l=>rJ(Ie(l))),o=Y(i,"compressor",l=>{if(l===null)return po.RAW;ge(l);const c=Y(l,"id",Ie);switch(c){case"blosc":return po.BLOSC;case"gzip":return po.GZIP;case"zlib":return po.GZIP;default:throw new Error(`Unsupported compressor: ${se(c)}`)}});return{rank:e.length,shape:e,chunks:t,order:n,dataType:s.dataType,encoding:{compressor:o,endianness:s.endianness},dimensionSeparator:r}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}class oJ extends Ns{constructor(e,t,n,r,s,o){super(e),this.credentialsProvider=t,this.url=n,this.separator=r,this.metadata=s,this.attrs=o,this.dataType=s.dataType,this.volumeType=Ii.IMAGE;let l=we(o,"_ARRAY_DIMENSIONS",c=>st(new Array(s.rank),c,Ie));l===void 0&&(l=Te(s.shape,(c,u)=>`d${u}`)),this.modelSpace=mt({names:l,scales:Float64Array.from(s.shape,()=>1),units:Te(s.shape,()=>""),boundingBoxes:[ya({lowerBounds:new Float64Array(s.rank),upperBounds:Float64Array.from(s.shape)})]})}get rank(){return this.metadata.rank}getSources(e){const t=this.metadata,n=t.rank,r=t.chunks,s=t.shape;let o,l,c;if(t.order==="F")o=Uint32Array.from(r),l=Float32Array.from(s),c=Ts(Float32Array,n+1);else{o=new Uint32Array(n),l=new Float32Array(n),c=new Float32Array((n+1)**2),c[(n+1)**2-1]=1;for(let u=0;u<n;++u)o[u]=r[n-1-u],l[u]=s[n-1-u],c[u+(n-1-u)*(n+1)]=1}return Md([rc({rank:n,chunkToMultiscaleTransform:c,dataType:t.dataType,upperVoxelBound:l,volumeType:this.volumeType,chunkDataSizes:[o],volumeSourceOptions:e}).map(u=>({chunkSource:this.chunkManager.getChunkSource(sJ,{credentialsProvider:this.credentialsProvider,spec:u,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:c}))])}}function lJ(i,e,t){return i.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:Ci(e)},async()=>{try{const n=await xa(e,t+"/.zattrs",{},jn);return ge(n),n}catch(n){if(sp(n))return{};throw n}})}function dJ(i,e,t){return i.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:Ci(e)},async()=>{const n=await xa(e,t+"/.zarray",{},jn);return aJ(n)})}const cJ=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];class uJ extends ba{get description(){return"Zarr data source"}get(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),n=oe(t,3);let r=n[1],s=n[2];const o=Zo(s||"");ge(o);const l=sP(o);return r.endsWith("/")&&(r=r.substring(0,r.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:r,dimensionSeparator:l},async()=>{var c=rl(r,e.credentialsManager);const u=c.url,f=c.credentialsProvider;var g=await Ot.all([dJ(e.chunkManager,f,u),lJ(e.chunkManager,f,u)]),v=oe(g,2);const y=v[0],C=v[1];if(y.dimensionSeparator!==void 0&&l!==void 0&&y.dimensionSeparator!==l)throw new Error(`Explicitly specified dimension separator ${se(l)} does not match value in .zarray ${se(y.dimensionSeparator)}`);const w=new oJ(e.chunkManager,f,u,l||y.dimensionSeparator||".",y,C);return{modelTransform:Xi(w.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:w}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:_d(w.modelSpace.bounds)}}]}})}async completeUrl(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),n=oe(t,3);let r=n[2];return r!==void 0?Xo(e.providerUrl.length-r.length,await tk(r,cJ)):await c0(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ca("zarr",()=>new uJ);var pa;(function(i){i[i.DEFAULT=0]="DEFAULT",i[i.ADDITIVE=1]="ADDITIVE"})(pa||(pa={}));const hJ=new ue([[pa.DEFAULT,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA)}],[pa.ADDITIVE,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE)}]]);function pJ(i=pa.DEFAULT){return new $h(pa,i)}const aP=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function fJ(i=aP){return zv(i)}function oP(i,e){i.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),i.addFragmentCode(xd),Cd(e,i),i.setFragmentMainFunction(bd(e.parseResult.code))}class gJ extends fT{constructor(e,t){var n,r,s;const o=t.opacity,l=t.blendMode,c=t.shaderControlState;super(e,j(j({},t),{fallbackShaderParameters:new gt(qv(_h(aP,{imageData:{dataType:e.dataType,channelRank:(s=(r=(n=t.channelCoordinateSpace)===null||n===void 0?void 0:n.value)===null||r===void 0?void 0:r.rank)!==null&&s!==void 0?s:0}}))),encodeShaderParameters:u=>u.key,shaderParameters:c.builderState,dataHistogramSpecifications:c.histogramSpecifications})),this.shaderControlState=c,this.opacity=o,this.blendMode=l,this.registerDisposer(o.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(l.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(c.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),oP(e,t)}initializeShader(e,t,n){const r=this.gl;r.uniform1f(t.uniform("uOpacity"),this.opacity.value),Ao(r,t,this.shaderControlState,n.parseResult.controls)}setGLBlendMode(e,t){const n=this.blendMode.value;n===pa.ADDITIVE||t>0?(e.enable(e.BLEND),hJ.get(n)(e)):e.disable(WebGL2RenderingContext.BLEND)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mJ="volume_rendering/VolumeRenderingRenderLayer",vJ="volume_rendering/VolumeRenderingRenderLayer/update",ev=64,yJ=Rd();function bJ(i,e,t){let n=0,r=0;for(let u=0;u<3;++u){const f=i[16+u],g=f*e[u],v=f*t[u];n+=Math.min(g,v),r+=Math.max(g,v)}const s=-i[19],o=Math.max(s,n),l=i[23],c=Math.min(l,r);return{near:s,far:l,adjustedNear:o,adjustedFar:c}}function o1(i,e,t,n,r,s){if(n.length===0)return;const o=i.viewMatrix,l=i.projectionMat,c=i.displayDimensionRenderInfo.voxelPhysicalScales,u=Tg(c),f=(K1(l)/ev)**3,g=gv(Lh(yJ,o)),v=M=>{const R=n[M];return Math.abs(R.chunkLayout.detTransform*g)};let y=n.length-1,C=v(y);for(let M=y-1;M>=0;--M){const R=v(M);if(Math.abs(R-f)<Math.abs(C-f))C=R,y=M;else break}const w=Math.pow(C*u/g,1/3),S=Math.pow(C,1/3)*i.width/(2*l[0]);let L=!0;const I=n[y];UL(i,e,I,(M,R)=>{L&&(r(I,y,w,S,R),L=!1),s(I,y,M)})}const SJ=Qe(),wJ=new Float32Array(24);class CJ extends el{constructor(e){super(),this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));const t=this.registerDisposer(wn(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=Gv(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l})=>`${Ci(o)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c},u,f)=>{if(u.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Wr(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addVarying("highp vec4","vNormalizedPosition"),o.addVertexCode(a$),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),Qk(o,c,f,"curChunkPosition"),o.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),o.addFragmentCode(xd),Cd(u,o),o.addFragmentCode(`
#define main userMain
`+bd(u.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(gr.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));const n=this.multiscaleSource.chunkManager,r=this.registerDisposer(new jd(this.layerChunkProgressInfo)),s=n.rpc;r.RPC_TYPE_ID=mJ,r.initializeCounterpart(s,{chunkManager:n.rpcId,localPosition:this.registerDisposer(Di.makeFromExisting(s,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Di.makeFromExisting(s,this.renderScaleTarget)).rpcId}),this.backend=r}get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Fr((t,n,r)=>{const s=ry(r,n,o=>this.multiscaleSource.getSources(o),e.messages,this);for(const o of s)for(const l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(vJ,{layer:this.backend.rpcId,view:e.view.rpcId,sources:ny(s)}),this.redrawNeeded.dispatch(),s},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;const n=t.state.sources.value;if(n.length===0)return;let r=0,s=0,o=null,l,c;const u=Ne(),f=this.gl;this.vertexIdHelper.enable();const g=this.renderScaleHistogram;g.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const v=()=>{o!==null&&(l!==null&&l.endDrawing(f,o),(S!==0||L!==0)&&g.add(r,s,S,L))};let y=!0;const C=e.projectionParameters;let w,S=0,L=0,I;const M=this.multiscaleSource.rank,R=Ne();f.enable(WebGL2RenderingContext.CULL_FACE),f.cullFace(WebGL2RenderingContext.FRONT),o1(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,n[0],(D,T,A,V)=>{r=A,s=V;const O=Qv(C,D.chunkLayout),_=D.source,H=D.fixedPositionWithinChunk,U=D.chunkDisplayDimensionIndices;for(const it of U)H[it]=0;const B=_.chunkFormat;if(B!==l&&(l=B,v(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:B}),o=c.shader,o!==null&&(o.bind(),B!==null&&(Ao(f,o,this.shaderControlState,c.parameters.parseResult.controls),B.beginDrawing(f,o),B.beginSource(f,o)))),I=void 0,o===null)return;w=_.chunks,u.fill(1);const W=fi(SJ,C.viewProjectionMat,O.transform);f.uniformMatrix4fv(o.uniform("uModelViewProjectionMatrix"),!1,W);const F=wJ;Eu(F,W),Cs(W,W),f.uniformMatrix4fv(o.uniform("uInvModelViewProjectionMatrix"),!1,W);var le=bJ(F,D.lowerClipDisplayBound,D.upperClipDisplayBound);const de=le.near,Re=le.far,ce=le.adjustedNear,Le=le.adjustedFar,Be=(Le-ce)/(ev-1)/(Re-de);f.uniform1f(o.uniform("uBrightnessFactor"),Be);const qe=(ce-de)/(Re-de),Ze=(Le-de)/(Re-de);f.uniform1f(o.uniform("uNearLimitFraction"),qe),f.uniform1f(o.uniform("uFarLimitFraction"),Ze),f.uniform1i(o.uniform("uMaxSteps"),ev),f.uniform3fv(o.uniform("uLowerClipBound"),D.lowerClipDisplayBound),f.uniform3fv(o.uniform("uUpperClipBound"),D.upperClipDisplayBound)},D=>{if(o===null)return;const T=D.curPositionInChunks.join(),A=w.get(T);if(A!==void 0&&A.state===Et.GPU_MEMORY){const V=D.chunkLayout.size;let O=A.chunkDataSize;const _=D.chunkDisplayDimensionIndices,H=D.fixedPositionWithinChunk,U=D.chunkTransform.channelToChunkDimensionIndices;if(QD(D),O!==I){I=O;for(let W=0;W<3;++W){const F=_[W];u[W]=F===-1||F>=M?1:I[F]}f.uniform3fv(o.uniform("uChunkDataSize"),u)}const B=A.chunkGridPosition;for(let W=0;W<3;++W){const F=_[W];R[W]=F===-1||F>=M?0:V[W]*B[F]}l==null||l.bindChunk(f,o,A,H,_,U,y),y=!1,f.uniform3fv(o.uniform("uTranslation"),R),o$(f,1,1),++S}else++L}),f.disable(WebGL2RenderingContext.CULL_FACE),v(),this.vertexIdHelper.disable()}isReady(e,t){const n=t.state.sources.value;if(n.length===0)return!0;let r=!1;return o1(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,n[0],()=>{},s=>{const o=s.source.chunks.get(s.curPositionInChunks.join());(o===void 0||o.state!==Et.GPU_MEMORY)&&(r=!0)}),r}}const xJ=vt.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class EJ{constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");const t=this.element,n=this.nameContainer,r=this.nameElement,s=this.lowerElement,o=this.upperElement;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),n.classList.add("neuroglancer-channel-dimensions-widget-name-container"),r.classList.add("neuroglancer-channel-dimensions-widget-name"),n.appendChild(r),s.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(n),t.appendChild(s),t.appendChild(o),n.draggable=!0,r.disabled=!0,r.spellcheck=!1,r.autocomplete="off",r.required=!0,r.placeholder=" ",n.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",n.addEventListener("dblclick",()=>{r.disabled=!1,r.focus(),r.select()}),r.addEventListener("focus",()=>{r.select()})}}class LJ extends K{constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=this.combiner.combined;const t=this.element;t.classList.add("neuroglancer-channel-dimensions-widget");const n=this.registerCancellable(wt(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(n));const r=this.registerDisposer(new $n(t,xJ));r.allShortcutsAreGlobal=!0,this.registerDisposer(Se(t,"cancel",s=>{this.forceUpdateView();const o=s.target;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;const n=this.coordinateSpace;n.value=_E(n.value,e,t)}makeNewDimensionWidget(e){const t=new EJ(e);return t.nameContainer.addEventListener("dragstart",n=>{this.dragSource=t,n.stopPropagation(),n.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",n=>{const r=this.dragSource;if(r===void 0||r===t)return;const s=this.dimensionWidgets,o=s.indexOf(r),l=s.indexOf(t);o===-1||l===-1||(n.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",n=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",n=>{t.nameElement.disabled=!0;const r=n.relatedTarget;this.dimensionWidgets.some(s=>s.nameElement===r)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{const n=t.nameElement;qi(n),this.updateNameValidity()}),Se(t.nameElement,"commit",()=>{this.updateNames()}),Se(t.nameElement,"tab-forward",n=>this.selectAdjacentField(n,t,1)),Se(t.nameElement,"tab-backward",n=>this.selectAdjacentField(n,t,-1)),t}selectAdjacentField(e,t,n){e.stopPropagation();const r=this.dimensionWidgets,s=r.indexOf(t);if(s===-1)return;const o=s+n;if(o<0||o>=r.length)return;const l=r[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){const e=this.dimensionWidgets,t=this.coordinateSpace,n=t.value,r=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(r).includes(!1))return!1;const s=n.names;if(_e(s,r))return!1;const o=n.timestamps.map((c,u)=>s[u]===r[u]?c:Date.now()),l=j(j({},n),{names:r,timestamps:o});return t.value=l,!0}updateNameValidity(){const e=this.dimensionWidgets,t=e.map(s=>s.nameElement.value),n=t.length,r=this.combiner.getRenameValidity(t);for(let s=0;s<n;++s)e[s].nameElement.dataset.isValid=r[s]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){const e=this.coordinateSpace.value;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;const t=this.element,n=this.dimensionWidgets,r=this.dimensionWidgets=e.ids.map(o=>n.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*s(){const o=e.names,l=e.rank;var c=e.bounds;const u=c.lowerBounds,f=c.upperBounds;for(let g=0;g<l;++g){const v=r[g];v.nameElement.value=o[g],delete v.nameElement.dataset.isValid,qi(v.nameElement),v.lowerElement.textContent=u[g].toString(),v.upperElement.textContent=f[g].toString(),yield v.element}}sr(t,s.call(this))}}const tv="opacity",iv="blend",l1="shader",d1="shaderControls",nv="crossSectionRenderScale",c1="channelDimensions",rv="volumeRendering",kJ="volumeRenderScale",IJ=Jy(al);class Ea extends IJ{constructor(e){super(e),this.opacity=td(.5),this.blendMode=pJ(),this.fragmentMain=fJ(),this.shaderError=Oh(),this.dataType=new gt(void 0),this.sliceViewRenderScaleHistogram=new Mo,this.sliceViewRenderScaleTarget=ca(1),this.volumeRenderingRenderScaleHistogram=new Mo,this.volumeRenderingRenderScaleTarget=ca(1),this.channelCoordinateSpace=new Av,this.channelCoordinateSpaceCombiner=new Vv(this.channelCoordinateSpace,FV),this.channelSpace=this.registerDisposer(nr(t=>yL(()=>JV(t)),this.channelCoordinateSpace)),this.volumeRendering=new Qt(!1,!1),this.shaderControlState=this.registerDisposer(new Yv(this.fragmentMain,this.registerDisposer(wn((t,n)=>t===void 0?null:{imageData:{dataType:t,channelRank:n.rank}},[this.dataType,this.channelCoordinateSpace],(t,n)=>se(t)===se(n))),this.channelCoordinateSpaceCombiner)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=nd,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new TJ(this)}),this.tabs.default="rendering"}markLoading(){const e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){const t=super.addCoordinateSpace(e),n=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}activateDataSubsources(e){let t;for(const n of e){if(this.addStaticAnnotations(n))continue;const r=n.subsourceEntry.subsource.volume;if(!(r instanceof Ns)){n.deactivate("Not compatible with image layer");continue}if(t&&r.dataType!==t){n.deactivate(`Data type must be ${J[r.dataType].toLowerCase()}`);continue}t=r.dataType,n.activate(s=>{n.addRenderLayer(new gJ(r,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));const o=s.registerDisposer(new CJ({multiscaleSource:r,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));s.registerDisposer(n.messages.addChild(o.messages)),s.registerDisposer(Fr((l,c)=>{c&&l.registerDisposer(this.addRenderLayer(o.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[tv]),we(e,iv,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[l1]),this.shaderControlState.restoreState(e[d1]),this.sliceViewRenderScaleTarget.restoreState(e[nv]),this.channelCoordinateSpace.restoreState(e[c1]),this.volumeRendering.restoreState(e[rv])}toJSON(){const e=super.toJSON();return e[tv]=this.opacity.toJSON(),e[iv]=this.blendMode.toJSON(),e[l1]=this.fragmentMain.toJSON(),e[d1]=this.shaderControlState.toJSON(),e[nv]=this.sliceViewRenderScaleTarget.toJSON(),e[c1]=this.channelCoordinateSpace.toJSON(),e[rv]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){const n=e.value;if(n==null)return!1;const r=this.channelSpace.value;if(r.error!==void 0)return!1;const s=r.numChannels,o=r.coordinates;var l=r.channelCoordinateSpace;const c=l.names,u=l.rank,f=document.createElement("div");f.classList.add("neuroglancer-selection-details-value-grid");let g="[copy] 0fr ";u!==0&&(g+=`repeat(${u}, [dim] 0fr [coord] 0fr) `),g+="[value] 1fr",f.style.gridTemplateColumns=g;for(let v=0;v<s;++v){const y=u===0?n:n[v],C=y==null?"":y.toString(),w=dr({title:"Copy value",onClick:()=>{on(C)}});f.appendChild(w);for(let L=0;L<u;++L){const I=document.createElement("div");I.classList.add("neuroglancer-selection-details-value-grid-dim"),I.textContent=c[L],f.appendChild(I);const M=document.createElement("div");M.classList.add("neuroglancer-selection-details-value-grid-coord"),M.textContent=o[v*u+L].toString(),f.appendChild(M)}const S=document.createElement("div");S.classList.add("neuroglancer-selection-details-value-grid-value"),S.textContent=C,f.appendChild(S)}return t.appendChild(f),!0}displaySelectionState(e,t,n){let r=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,n)&&(r=!0),r}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),oP(e,t)},initializeShader:e=>{const t=e.shader;Ao(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}}Ea.type="image";Ea.typeAbbreviation="img";function lP(i){return new e0({shaderError:i.shaderError,fragmentMain:i.fragmentMain,shaderControlState:i.shaderControlState})}const dP=[j({label:"Resolution (slice)",toolJson:nv},sh(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))),j({label:"Blending",toolJson:iv},tD(i=>i.blendMode)),j({label:"Volume rendering (experimental)",toolJson:rv},dd(i=>i.volumeRendering)),j({label:"Resolution (3d)",toolJson:kJ,isValid:i=>i.volumeRendering},sh(i=>({histogram:i.volumeRenderingRenderScaleHistogram,target:i.volumeRenderingRenderScaleTarget}))),j({label:"Opacity",toolJson:tv},ms(i=>({value:i.opacity})))];for(const i of dP)qT(Ea,i);class TJ extends qr{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(lP(this.layer));const t=this.element;t.classList.add("neuroglancer-image-dropdown");for(const s of dP)t.appendChild(Xy(this,e,this.visibility,s));let n=document.createElement("div");n.style.flex="1";let r=document.createElement("div");r.className="neuroglancer-image-dropdown-top-row",r.appendChild(document.createTextNode("Shader")),r.appendChild(n),r.appendChild(Qy({title:"Show larger editor view",onClick:()=>{new DJ(this.layer)}})),r.appendChild(Ky({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.registerDisposer(new LJ(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new t0(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class DJ extends dp{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(lP(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}ol(Ea);eT(Ii.IMAGE,Ea);Vy(i=>{const e=i.volume;if(e!==void 0&&e.volumeType===Ii.UNKNOWN)return{layerConstructor:Ea,priority:-100}});i0(Ea,i=>({shaderControlState:i.shaderControlState,legendShaderOptions:i.getLegendShaderOptions()}));function PJ(i){if(i.brainMapsClientId){const t=i.brainMapsClientId;nl.register(hp,()=>new zD(t))}let e=mH({bundleRoot:i.bundleRoot},i.target);return _F(e.inputEventBindings),rH(e),aH(e),vH(i.target),e}class AJ{version(){return"0.0.1"}}const MJ=Object.freeze(Object.defineProperty({__proto__:null,default:AJ,setupDefaultViewer:PJ},Symbol.toStringTag,{value:"Module"})),RJ=Is(MJ),NJ=Is(KN),VJ=Is($N),OJ=Is(H4);(function(i){function e(X){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?e=function(ee){return typeof ee}:e=function(ee){return ee&&typeof Symbol=="function"&&ee.constructor===Symbol&&ee!==Symbol.prototype?"symbol":typeof ee},e(X)}Object.defineProperty(i,"__esModule",{value:!0}),i.parseUrlHash=F,i.getNeuroglancerViewerState=le,i.getNeuroglancerColor=de,i.closeSelectionTab=Re,i.getLayerManager=ce,i.getManagedLayer=Le,i.getAnnotationLayer=Be,i.getAnnotationSource=qe,i.addLayerSignalRemover=Ze,i.unsubscribeLayersChangedSignals=it,i.configureLayersChangedSignals=ot,i.configureAnnotationLayer=Ge,i.configureAnnotationLayerChanged=De,i.getAnnotationSelectionHost=St,i.getSelectedAnnotationId=dn,i.default=void 0;var t=v(SM),n=v(wM),r=eH,s=tH,o=iH,l=nH,c=RJ,u=NJ,f=VJ,g=OJ;function v(X){return X&&X.__esModule?X:{default:X}}function y(X,ee){var ie=Object.keys(X);if(Object.getOwnPropertySymbols){var fe=Object.getOwnPropertySymbols(X);ee&&(fe=fe.filter(function(Ee){return Object.getOwnPropertyDescriptor(X,Ee).enumerable})),ie.push.apply(ie,fe)}return ie}function C(X){for(var ee=1;ee<arguments.length;ee++){var ie=arguments[ee]!=null?arguments[ee]:{};ee%2?y(Object(ie),!0).forEach(function(fe){O(X,fe,ie[fe])}):Object.getOwnPropertyDescriptors?Object.defineProperties(X,Object.getOwnPropertyDescriptors(ie)):y(Object(ie)).forEach(function(fe){Object.defineProperty(X,fe,Object.getOwnPropertyDescriptor(ie,fe))})}return X}function w(X,ee){if(!(X instanceof ee))throw new TypeError("Cannot call a class as a function")}function S(X,ee){for(var ie=0;ie<ee.length;ie++){var fe=ee[ie];fe.enumerable=fe.enumerable||!1,fe.configurable=!0,"value"in fe&&(fe.writable=!0),Object.defineProperty(X,fe.key,fe)}}function L(X,ee,ie){return ee&&S(X.prototype,ee),X}function I(X,ee){if(typeof ee!="function"&&ee!==null)throw new TypeError("Super expression must either be null or a function");X.prototype=Object.create(ee&&ee.prototype,{constructor:{value:X,writable:!0,configurable:!0}}),ee&&M(X,ee)}function M(X,ee){return M=Object.setPrototypeOf||function(ie,fe){return ie.__proto__=fe,ie},M(X,ee)}function R(X){var ee=A();return function(){var ie=V(X),fe;if(ee){var Ee=V(this).constructor;fe=Reflect.construct(ie,arguments,Ee)}else fe=ie.apply(this,arguments);return D(this,fe)}}function D(X,ee){return ee&&(e(ee)==="object"||typeof ee=="function")?ee:T(X)}function T(X){if(X===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return X}function A(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch{return!1}}function V(X){return V=Object.setPrototypeOf?Object.getPrototypeOf:function(ee){return ee.__proto__||Object.getPrototypeOf(ee)},V(X)}function O(X,ee,ie){return ee in X?Object.defineProperty(X,ee,{value:ie,enumerable:!0,configurable:!0,writable:!0}):X[ee]=ie,X}function _(X,ee){var ie;if(typeof Symbol>"u"||X[Symbol.iterator]==null){if(Array.isArray(X)||(ie=H(X))||ee){ie&&(X=ie);var fe=0,Ee=function(){};return{s:Ee,n:function(){return fe>=X.length?{done:!0}:{done:!1,value:X[fe++]}},e:function(lt){throw lt},f:Ee}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var ye=!0,Je=!1,rt;return{s:function(){ie=X[Symbol.iterator]()},n:function(){var lt=ie.next();return ye=lt.done,lt},e:function(lt){Je=!0,rt=lt},f:function(){try{!ye&&ie.return!=null&&ie.return()}finally{if(Je)throw rt}}}}function H(X,ee){if(X){if(typeof X=="string")return U(X,ee);var ie=Object.prototype.toString.call(X).slice(8,-1);if(ie==="Object"&&X.constructor&&(ie=X.constructor.name),ie==="Map"||ie==="Set")return Array.from(X);if(ie==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ie))return U(X,ee)}}function U(X,ee){(ee==null||ee>X.length)&&(ee=X.length);for(var ie=0,fe=new Array(ee);ie<ee;ie++)fe[ie]=X[ie];return fe}var B={},W;function F(X){var ee=null,ie=X.replace(/^[^#]+/,"");if((ie===""||ie==="#"||ie==="#!")&&(ie="#!{}"),ie.startsWith("#!+"))ie=ie.slice(3),ie=decodeURIComponent(ie),ee=(0,f.urlSafeParse)(ie);else if(ie.startsWith("#!"))ie=ie.slice(2),ie=decodeURIComponent(ie),ee=(0,f.urlSafeParse)(ie);else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');return ee}function le(X){var ee=X?B[X]:W;return ee?ee.state.toJSON():{}}function de(X,ee){try{var ie=u.Uint64.parseString(X),fe=ee?B[ee]:W;if(fe){var Ee=_(fe.layerManager.managedLayers),ye;try{for(Ee.s();!(ye=Ee.n()).done;){var Je=ye.value;if(Je.layer instanceof o.SegmentationUserLayer){var rt=Je.layer.displayState,lt=(0,s.getObjectColor)(rt,ie);if(rt.segmentSelectionState.isSelected(ie))for(var dt=0;dt<3;dt+=1)lt[dt]=(lt[dt]-.5)/.5;var Pt=(0,l.serializeColor)(lt);return Pt}}}catch(jt){Ee.e(jt)}finally{Ee.f()}}}catch{}return""}function Re(X){var ee=X?B[X]:W;ee&&ee.closeSelectionTab&&ee.closeSelectionTab()}function ce(X){var ee=X?B[X]:W;if(ee)return ee.layerManager}function Le(X,ee){var ie=ce(X);if(ie)return ie.managedLayers.filter(function(fe){return fe.name===ee})[0]}function Be(X,ee){var ie=Le(X,ee);if(ie&&ie.layer instanceof r.AnnotationUserLayer)return ie.layer}function qe(X,ee){var ie=Be(X,ee);if(ie&&ie.dataSources&&ie.dataSources[0].loadState_){var fe=ie.dataSources[0].loadState_.dataSource;if(fe)return fe.subsources[0].subsource.annotation}}function Ze(X,ee,ie){var fe=ce(X);fe&&ee&&ie&&(fe.customSignalHandlerRemovers||(fe.customSignalHandlerRemovers={}),fe.customSignalHandlerRemovers[ee]||(fe.customSignalHandlerRemovers[ee]=[]),fe.customSignalHandlerRemovers[ee].push(ie))}function it(X,ee){X&&X.customSignalHandlerRemovers&&X.customSignalHandlerRemovers[ee]&&(X.customSignalHandlerRemovers[ee].forEach(function(ie){ie()}),delete X.customSignalHandlerRemovers[ee])}function ot(X,ee){var ie=ce(X);if(ie){var fe=ee.layerName;if(it(ie,fe),ee.process){var Ee=function(Je){return Ze(void 0,fe,Je)};Ee(ie.layersChanged.add(function(){var Je=Le(void 0,fe);Je&&ee.process(Je)}));var ye=Le(void 0,fe);return ye&&ee.process(ye),function(){ee.cancel&&ee.cancel(),it(ie,fe)}}}return ee.cancel}function ze(X,ee,ie){X&&!X.signalReady&&(ee.onAnnotationAdded&&ie(X.childAdded.add(function(fe){ee.onAnnotationAdded(fe)})),ee.onAnnotationDeleted&&ie(X.childDeleted.add(function(fe){ee.onAnnotationDeleted(fe)})),ee.onAnnotationUpdated&&ie(X.childUpdated.add(function(fe){ee.onAnnotationUpdated(fe)})),ee.onAnnotationChanged&&X.referencesChanged&&ie(X.referencesChanged.add(ee.onAnnotationChanged)),X.signalReady=!0,ie(function(){X.signalReady=!1}))}function Pe(X){if(X.dataSources&&X.dataSources.length>0&&X.dataSources[0].loadState_&&X.dataSources[0].loadState_.dataSource)return X.dataSources[0].loadState_.dataSource}function Ue(X){var ee=Pe(X);if(ee)return ee.subsources[0].subsource.annotation}function We(X,ee,ie){var fe=function(){var ye=Ue(X);ye&&ze(ye,ee,ie)},Ee=X.dataSourcesChanged;Ee&&!Ee.signalReady&&(ie(Ee.add(fe)),Ee.signalReady=!0,ie(function(){Ee.signalReady=!1}),fe())}function Ge(X,ee,ie){X&&(X.expectingExternalTable=!0,X.selectedAnnotation&&!X.selectedAnnotation.changed.signalReady&&ee.onAnnotationSelectionChanged&&(ie(X.selectedAnnotation.changed.add(function(){ee.onAnnotationSelectionChanged(X.selectedAnnotation.value)})),ie(function(){X.selectedAnnotation.changed.signalReady=!1}),X.selectedAnnotation.changed.signalReady=!0),We(X,ee,ie))}function De(X,ee,ie){if(!X.layerChanged.signalReady){var fe=X.layerChanged.add(function(){Ge(X.layer,ee,ie)});X.layerChanged.signalReady=!0,ie(fe),ie(function(){X.layerChanged.signalReady=!1}),Ge(X.layer,ee,ie)}}function St(X){var ee=X?B[X]:W;return ee?ee.selectionDetailsState?"viewer":"layer":null}function dn(X,ee){var ie=X?B[X]:W;if(ie)if(ie.selectionDetailsState){if(ie.selectionDetailsState.value){var fe=ie.selectionDetailsState.value.layers;if(fe){var Ee=fe.find(function(Je){return Je.layer.managedLayer.name===ee});if(Ee&&Ee.state)return Ee.state.annotationId}}}else{var ye=Be(void 0,ee);if(ye&&ye.selectedAnnotation&&ye.selectedAnnotation.value)return ye.selectedAnnotation.value.id}return null}var ei=function(X){I(ie,X);var ee=R(ie);function ie(fe){var Ee;return w(this,ie),Ee=ee.call(this,fe),O(T(Ee),"updateEventBindings",function(ye){var Je=Ee.viewer.inputEventBindings,rt=function lt(dt){var Pt=function(Ke,mi,ft){var et=Ke.get(mi);et&&(Ke.delete(mi),ft&&Ke.set(ft,et))},jt=dt.bindings;ye.forEach(function(Ke){var mi=Array.isArray(Ke)?Ke[0]:Ke,ft="at:".concat(mi),et=Ke[1]?"at:".concat(Ke[1]):void 0;Pt(jt,ft,et);var Ft="bubble:".concat(mi),Kt=Ke[1]?"bubble:".concat(Ke[1]):void 0;Pt(jt,Ft,Kt)}),dt.parents.forEach(function(Ke){lt(Ke)})};rt(Je.global),rt(Je.perspectiveView),rt(Je.sliceView)}),O(T(Ee),"selectionDetailsStateChanged",function(){if(Ee.viewer){var ye=Ee.props.onSelectionDetailsStateChanged;ye&&ye()}}),O(T(Ee),"layersChanged",function(){if(Ee.handlerRemovers&&Ee.handlerRemovers.forEach(function(Kt){return Kt()}),Ee.viewer){var ye=Ee.props,Je=ye.onSelectedChanged,rt=ye.onVisibleChanged;if(Je||rt){Ee.handlerRemovers=[];var lt=_(Ee.viewer.layerManager.managedLayers),dt;try{for(lt.s();!(dt=lt.n()).done;){var Pt=dt.value;if(Pt.layer instanceof o.SegmentationUserLayer){var jt=Pt.layer.displayState.segmentSelectionState,Ke=Pt.layer.displayState.segmentationGroupState.value.visibleSegments;if(jt&&Je){var mi=Ee.selectedChanged.bind(void 0,Pt),ft=jt.changed.add(mi);Ee.handlerRemovers.push(ft),Pt.registerDisposer(ft)}if(Ke&&rt){var et=Ee.visibleChanged.bind(void 0,Pt),Ft=Ke.changed.add(et);Ee.handlerRemovers.push(Ft),Pt.registerDisposer(Ft)}}}}catch(Kt){lt.e(Kt)}finally{lt.f()}}}}),O(T(Ee),"selectedChanged",function(ye){if(Ee.viewer){var Je=Ee.props.onSelectedChanged;if(Je){var rt=ye.layer.displayState.segmentSelectionState;if(rt){var lt=rt.hasSelectedSegment?rt.selectedSegment:null;Je(lt,ye)}}}}),O(T(Ee),"visibleChanged",function(ye){if(Ee.viewer){var Je=Ee.props.onVisibleChanged;if(Je){var rt=ye.layer.displayState.segmentationGroupState.value.visibleSegments;rt&&Je(rt,ye)}}}),Ee.ngContainer=t.default.createRef(),Ee.viewer=null,Ee}return L(ie,[{key:"componentDidMount",value:function(){var fe=this,Ee=this.props,ye=Ee.perspectiveZoom,Je=Ee.viewerState,rt=Ee.brainMapsClientId,lt=Ee.eventBindingsToUpdate,dt=Ee.onViewerStateChanged,Pt=Ee.callbacks,jt=Ee.ngServer,Ke=Ee.key,mi=Ee.bundleRoot;if(this.viewer=(0,c.setupDefaultViewer)({brainMapsClientId:rt,target:this.ngContainer.current,bundleRoot:mi||"/"}),this.setCallbacks(Pt),lt&&this.updateEventBindings(lt),this.viewer.expectingExternalUI=!0,jt&&(this.viewer.makeUrlFromState=function(et){var Ft=C({},et);return et.layers&&(Ft.layers=et.layers.filter(function(Kt){if(Kt.source){var kn=Kt.source.url||Kt.source;if(typeof kn=="string")return!kn.startsWith("clio://")}return!0})),"".concat(jt,"/#!").concat((0,g.encodeFragment)(JSON.stringify(Ft)))}),this.viewer.selectionDetailsState&&this.viewer.selectionDetailsState.changed.add(this.selectionDetailsStateChanged),this.viewer.layerManager.layersChanged.add(this.layersChanged),Je){var ft=Je;ft.projectionScale===null&&delete ft.projectionScale,ft.crossSectionScale===null&&delete ft.crossSectionScale,ft.projectionOrientation===null&&delete ft.projectionOrientation,ft.crossSectionOrientation===null&&delete ft.crossSectionOrientation,this.viewer.state.restoreState(ft)}else this.viewer.state.restoreState({layers:{grayscale:{type:"image",source:"dvid://https://flyem.dvid.io/ab6e610d4fe140aba0e030645a1d7229/grayscalejpeg"},segmentation:{type:"segmentation",source:"dvid://https://flyem.dvid.io/d925633ed0974da78e2bb5cf38d01f4d/segmentation"}},perspectiveZoom:ye,navigation:{zoomFactor:8}});this.viewer.state.changed.add(function(){if(dt)try{fe.viewer.state.viewer.position&&dt(fe.viewer.state.toJSON())}catch(et){console.debug(et)}}),Ke?B[Ke]=this.viewer:W=this.viewer,window.viewer=this.viewer}},{key:"componentDidUpdate",value:function(){var fe=this,Ee={},ye=_(this.viewer.layerManager.managedLayers),Je;try{for(ye.s();!(Je=ye.n()).done;){var rt=Je.value;if(rt.layer instanceof o.SegmentationUserLayer){var lt=rt.layer.displayState.segmentSelectionState;Ee[rt.name]=lt.selectedSegment}}}catch(Ft){ye.e(Ft)}finally{ye.f()}var dt=this.props.viewerState;if(dt){var Pt=C({},dt),jt=[function(){fe.viewer.state.restoreState(Pt)}];dt.projectionScale===null&&(delete Pt.projectionScale,jt.push(function(){fe.viewer.projectionScale.reset()})),dt.crossSectionScale===null&&delete Pt.crossSectionScale,jt.forEach(function(Ft){return Ft()})}var Ke=_(this.viewer.layerManager.managedLayers),mi;try{for(Ke.s();!(mi=Ke.n()).done;){var ft=mi.value;if(ft.layer instanceof o.SegmentationUserLayer){var et=ft.layer.displayState.segmentSelectionState;et.set(Ee[ft.name])}}}catch(Ft){Ke.e(Ft)}finally{Ke.f()}"position"in dt&&Array.isArray(dt.position)&&dt.position.length===0&&this.viewer.position.reset()}},{key:"componentWillUnmount",value:function(){var fe=this.props.key;fe?delete B[fe]:W=void 0}},{key:"setCallbacks",value:function(fe){var Ee=this;fe.forEach(function(ye){Ee.viewer.bindCallback(ye.name,ye.function),Ee.viewer.inputEventBindings.sliceView.set(ye.event,ye.name)})}},{key:"render",value:function(){var fe=this.props.perspectiveZoom;return t.default.createElement("div",{className:"neuroglancer-container",ref:this.ngContainer},t.default.createElement("p",null,"Neuroglancer here with zoom ",fe))}}]),ie}(t.default.Component);i.default=ei,ei.propTypes={perspectiveZoom:n.default.number,viewerState:n.default.object,brainMapsClientId:n.default.string,key:n.default.string,eventBindingsToUpdate:n.default.array,onSelectedChanged:n.default.func,onVisibleChanged:n.default.func,onSelectionDetailsStateChanged:n.default.func,onViewerStateChanged:n.default.func,callbacks:n.default.arrayOf(n.default.object),ngServer:n.default.string},ei.defaultProps={perspectiveZoom:20,eventBindingsToUpdate:null,brainMapsClientId:"NOT_A_VALID_ID",viewerState:null,onSelectedChanged:null,onVisibleChanged:null,onSelectionDetailsStateChanged:null,onViewerStateChanged:null,key:null,callbacks:[],ngServer:"https://neuroglancer-demo.appspot.com/"}})(uv);const BJ=It(uv),FJ=DM({__proto__:null,default:BJ},[uv]);export{FJ as i};
